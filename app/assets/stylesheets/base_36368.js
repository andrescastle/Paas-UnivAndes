SG=SG||{};SG.Widget={};SG.Widget.Canvas={};SG.Widget.EntityPane={};SG.Widget.EntityQuery={};SG.Data={};SG.util={};SG.ConfigureField={};var JSON=JSON||{};(function(){function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+
partial.join(',\n'+gap)+'\n'+
mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+
mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value});};}
if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());SG.Schema=function(schema){Ext.apply(this,schema);this.events={reloaded:true,column_changed:true,column_removed:true};};Ext.extend(SG.Schema,Ext.util.Observable,{grouping_options:{currency:"number",checkbox:[],date:[["day","By day"],["week","By week"],["month","By month"],['quarter','By quarter'],["year","By year"],['clustered_date','Clustered']],date_time:"date",duration:[["oneday","By one day"],["fivedays","By five days"]],entity:[["entitytype","By link type"],["firstletter","By first letter"]],entity_type:[],'float':"number",list:"text",multi_entity:"entity",number:[["tens","By tens"],["hundreds","By hundreds"],["thousands","By thousands"],["millions","By millions"],["tensofthousands","By tens of thousands"],["hundredsofthousands","By hundreds of thousands"]],percent:"number",status_list:[],system_task_type:[],text:[["firstletter","By first letter"]],timecode:"number",url:"text",footage:[["tens","By tens"],["hundreds","By hundreds"],["thousands","By thousands"],["millions","By millions"],["tensofthousands","By tens of thousands"],["hundredsofthousands","By hundreds of thousands"]]},summary_defaults:{date:"none",duration:"none",list:"none",number:"none",currency:"none",'float':"none",timecode:"none",percent:"none",password:"none",checkbox:"none",text:"none",entity:"none",multi_entity:"none",url:"none",status_list:"none",system_task_type:"none",entity_type:"none",footage:"none"},summary_options:{date:["none","record_count","count","earliest","latest"],date_time:["none","record_count","count","earliest","latest"],duration:["none","record_count","count","sum","minimum","maximum","average"],list:["none","record_count","count","percentage"],number:["none","record_count","count","sum","minimum","maximum","average"],currency:["none","record_count","count","sum","minimum","maximum","average"],'float':["none","record_count","count","sum","minimum","maximum","average"],timecode:["none","record_count","count","sum","minimum","maximum","average"],percent:["none","record_count","count","minimum","maximum","average"],password:["none","record_count","count"],checkbox:["none","record_count","checked","unchecked"],text:["none","record_count","count"],entity:["none","record_count"],multi_entity:["none","record_count"],url:["none","record_count"],status_list:["none","record_count","status_list","status_percentage"],system_task_type:["none","record_count"],entity_type:["none","record_count"],footage:["none","record_count","count","sum","minimum","maximum","average"]},summary_display_names:{none:"None",count:"Count",earliest:"Earliest",latest:"Latest",sum:"Sum",minimum:"Minimum",maximum:"Maximum",average:"Average",checked:"Checked",unchecked:"Unchecked",status_list:"Status",percentage:"Percentage",status_percentage:"Percentage",record_count:"Entity Count",single_record:"Single Record"},non_importable_entity_types:["DisplayColumn","Attachment","Status","Page"],set_schema:function(schema){Ext.apply(this,schema);this.fireEvent("reloaded");},reload_schema:function(callback){var options={url:'/page/reload_schema',callback:function(options,success,response)
{if(success)
{var stuff=Ext.decode(response.responseText);SG.schema.projects=stuff.projects;SG.schema.archived_projects=stuff.archived_projects;SG.schema.set_schema(stuff.schema);if(callback)
callback.fn.call(callback.scope);}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},column_changed:function(entity_class,column_name){this.fireEvent("column_changed",entity_class,column_name);},column_removed:function(entity_class,column_name){this.fireEvent("column_removed",entity_class,column_name);},allowed_entity_types:function(column_info){if(!column_info.hasOwnProperty('allowed_entity_types')||column_info.allowed_entity_types===null)
return SG.schema.valid_field_entity_types;else
return column_info.allowed_entity_types;},allowed_entity_types_for_autocomplete:function(column_info){var all_types,valid_types=[];if(column_info.autocomplete_entity_types)
all_types=column_info.autocomplete_entity_types;else
all_types=this.allowed_entity_types(column_info);for(var i=0;i<all_types.length;i++){if(SG.schema.entity_types[all_types[i]].enabled)
valid_types.push(all_types[i]);}
return valid_types;},convert_entity_types_for_autocomplete:function(entity_types_array,schema_field){var entity_types_hash={};var filters={};if(schema_field&&schema_field.autocomplete_entity_filters)
filters=sg_deep_copy(schema_field.autocomplete_entity_filters);for(var i=0;i<entity_types_array.length;++i){if(entity_types_array[i]in filters)
entity_types_hash[entity_types_array[i]]=filters[entity_types_array[i]];else
entity_types_hash[entity_types_array[i]]={};}
return entity_types_hash;},sorted_valid_field_entity_types:function(){return this.sort_entity_types_by_display_name(this.valid_field_entity_types);},generate_field_reference_name:function(info_hash){if(info_hash.type=="simple")
return info_hash.base_field;else
return info_hash.base_field+"."+info_hash.bubble_source_entity_type+"."+info_hash.bubbled_up_field;},parse_field_name:function(entity_type,field_name){var field_path;if(field_name.indexOf("$")>-1){var parts=field_name.split('$');if(parts.length!=2)
return null;var base_field=parts[0];var summary_field=parts[1];if(base_field.indexOf(".")>-1){field_path=base_field.split(".");if(field_path.length!=3)
return null;return{type:"summary",base_field:field_path[0],bubble_source_entity_type:field_path[1],bubbled_up_field:field_path[2],summary_field:summary_field};}else{return{type:"summary",base_field:base_field,bubble_source_entity_type:entity_type,bubbled_up_field:base_field,summary_field:summary_field};}}else if(field_name.indexOf(".")>-1){field_path=field_name.split(".");if(field_path.length!=3)
return{type:"bubbledeep"};var type;if(!this.entity_fields[entity_type][field_path[0]])
type="invalid";else if(field_path[1]==this.entity_fields[entity_type][field_path[0]].through_join_entity_type)
type="join";else if(this.allowed_entity_types(this.entity_fields[entity_type][field_path[0]]).length>1)
type="bubblepoly";else
type="bubble";var ret={type:type,base_field:field_path[0],bubble_source_entity_type:field_path[1],bubbled_up_field:field_path[2]};if(type!=="invalid"&&this.entity_fields[entity_type][field_path[0]].data_type==='multi_entity')
ret.multi_entity=true;return ret;}else{return{type:"simple",base_field:field_name};}},is_simple_field:function(entity_type,field_name){var parsed=this.parse_field_name(entity_type,field_name);return(parsed&&parsed.type=='simple');},is_bubbled_field:function(entity_type,field_name){var parsed=this.parse_field_name(entity_type,field_name);return(parsed&&["join","bubblepoly","bubble"].indexOf(parsed.type)!=-1);},is_join_field:function(entity_type,field_name){var parsed=this.parse_field_name(entity_type,field_name);return(parsed&&parsed.type=='join');},parse_path:function(path){var class_name,field_name;path=path.split(".");if(path.length==1){class_name=this.entity_type;field_name=path[0];}else{class_name=path[path.length-2];field_name=path[path.length-1];}
return[class_name,field_name];},get_field:function(entity_type,field_name){if(field_name===null)return null;var entity_fields;var parsed=this.parse_field_name(entity_type,field_name);if(parsed.type=="bubbledeep"){var class_and_field=this.parse_path(field_name);return this.get_field(class_and_field[0],class_and_field[1]);}else if(parsed.type=="simple"){entity_fields=this.entity_fields[entity_type];if(entity_fields)
return entity_fields[field_name];}else if(parsed.type=="summary"){entity_fields=this.entity_fields[parsed.bubble_source_entity_type];if(entity_fields&&entity_fields[parsed.bubbled_up_field]){var display_name='';if(entity_type!=parsed.bubble_source_entity_type)
display_name=this.entity_fields[entity_type][parsed.base_field].display_name+' ';var schema={name:field_name,display_name:display_name+entity_fields[parsed.bubbled_up_field].display_name,entity_type:parsed.bubble_source_entity_type,data_type:'summary',summary_field:parsed.summary_field,summary_default:'none',configurable:false,no_filtering:true,no_sorting:true,no_grouping:true};var inverse_association=this.entity_fields[entity_type][parsed.base_field].inverse_association;if(inverse_association&&inverse_association.constructor==Array){schema.inverse_association=null;for(var ii=0;ii<inverse_association.length;ii++){if(inverse_association[ii].indexOf(schema.entity_type)===0){schema.inverse_association=inverse_association[ii];break;}}}else{schema.inverse_association=inverse_association;}
var base_field_schema=entity_fields[parsed.bubbled_up_field];if(base_field_schema.data_type=='pivot_column'){schema.pivot_column=parsed.bubbled_up_field;schema.query=base_field_schema.query;var summary_field_schema=this.get_field(schema.query.entity_type,schema.summary_field);if(!summary_field_schema)return null;schema.summary_default=summary_field_schema.summary_default;schema.display_name+=' '+summary_field_schema.display_name+' Summary';}
return schema;}}else if(parsed.type!="invalid"){var base=this.get_field(entity_type,parsed.base_field);if(!base)return null;if(parsed.type!="join"&&base.allowed_entity_types&&base.allowed_entity_types.indexOf(parsed.bubble_source_entity_type)===-1){return null;}
var schema_field=this.get_field(parsed.bubble_source_entity_type,parsed.bubbled_up_field);if(!schema_field)return null;if(schema_field.data_type=='summary')
schema_field.name=field_name;return schema_field;}
return null;},get_field_display_name:function(entity_type,field_path,optional_schema_field){var field_info=SG.schema.parse_field_name(entity_type,field_path);var name;if(field_info.type=="simple"||field_info.type=='summary'){optional_schema_field=optional_schema_field||this.get_field(entity_type,field_path);name=optional_schema_field.display_name;}else if(field_path.indexOf('step_')===0){var bubble_entity_schema=SG.schema.entity_types[field_info.bubble_source_entity_type];var bubble_field_schema=SG.schema.entity_fields[field_info.bubble_source_entity_type];var step_field=this.get_field(entity_type,field_info.base_field);name=step_field.display_name+" -> ";name+=bubble_field_schema[field_info.bubbled_up_field].display_name;}else{var bubble_entity_schema=SG.schema.entity_types[field_info.bubble_source_entity_type];var bubble_field_schema=SG.schema.entity_fields[field_info.bubble_source_entity_type];name=bubble_entity_schema.display_name+" -> ";name+=bubble_field_schema[field_info.bubbled_up_field].display_name;}
return name;},get_entity_types_for_site_config:function(){return SG.schema.entity_classes_for_display_name_cache.concat(['DisplayColumn','TimeLog']);},get_entity_types_for_permissions:function(){return sg_deep_copy(SG.schema.leftnav_page_entity_types);},can_save_page:function(page_user_id,page_project_id,page_type,ui_category){if(SG.globals.current_user.id==page_user_id){return true;}else if(page_type=='home'){if(SG.globals.current_user.can_save_home_page)
return true;else
return false;}else if(SG.globals.current_user.admin){return true;}
return false;},can_see_entity_type:function(entity_type){return SG.allow("see_entity",{entity_type:entity_type});},can_create_entity:function(entity_type){return SG.allow("create_entity",{entity_type:entity_type});},can_retire_entity:function(entity_type){return SG.allow("retire_entity",{entity_type:entity_type});},can_retire_record:function(record){if(!this.can_retire_entity(record.get_type()))
return false;if(record.get_type()=='Page'&&this.__page_update_denied(record))
return false;var condition=SG.permission_retrieve('retire_entity_condition',{entity_type:record.get_type()});if(condition)
return SG.evaluate_condition(record,condition);else
return true;},__page_update_denied:function(record){if(record.get_type()=='Page'){var page_type=record.get('page_type');if(page_type=='home'&&!SG.globals.current_user.can_save_home_page)
return true;if(record.get('admin')&&!SG.globals.current_user.admin_ui_access)
return true;}
return false;},can_edit_field_on_record:function(record,schema_field,value,field_path){if(!schema_field||schema_field.read_only)
return false;if(record.get_state&&record.get_state()=='new'){return this.can_create_entity(record.get_type());}else if(schema_field.create_only){return false;}
if(SG.globals.custom_for=="bluesky"){if(record.get_type()=='Task'&&schema_field.name=='sg_status_list'){var task_entity=record.get('entity');if(task_entity&&task_entity.type=='CustomThreadedEntity01')
return true;}}
if(!this.__check_update_field_permission(schema_field))
return false;if(record.get_type()=='Page'&&this.__page_update_denied(record))
return false;if(typeof value=='undefined')
value="__ALL_VALUES__";var condition=SG.permission_retrieve('update_field_condition',{entity_type:schema_field.entity_type,field_name:schema_field.name,field_value:value});if(condition){if(field_path&&field_path.indexOf('.')>-1){condition=sg_deep_copy(condition);var prefix=field_path.substring(0,field_path.lastIndexOf('.'));sg_add_prefix_to_condition_paths(prefix,condition);}
return SG.evaluate_condition(record,condition);}else{return true;}},can_edit_field:function(entity_type,field_name){var field=this.get_field(entity_type,field_name);if(!field||field.read_only||field.create_only)
return false;return this.__check_update_field_permission(field);},__check_update_field_permission:function(field){return SG.allow("update_field",{entity_type:field.entity_type,field_name:field.name,field_value:"__ALL_VALUES__"})||SG.allow("update_field",{entity_type:field.entity_type,field_name:field.name,field_value:'asdlfkasdlfjsdfkjri'});},sort_entity_types_by_display_name:function(entity_types){return entity_types.sort(function(a,b){var da=SG.schema.entity_types[a].display_name;var db=SG.schema.entity_types[b].display_name;if(da>db)return 1;if(da<db)return-1;return 0;});},local_display_name:function(local_display_names,field_info,field_path){if(local_display_names&&local_display_names[field_path]&&local_display_names[field_path]!=field_info.display_name)
{return local_display_names[field_path]+" ("+field_info.display_name+")";}
return field_info.display_name;},locally_sorted_fields:function(local_display_names,fields,field_path_prefix){if(local_display_names){var modified_display_names=false;for(var i=0;i<fields.length;i++){if(local_display_names[field_path_prefix+fields[i].name]){modified_display_names=true;break;}}
if(modified_display_names){var da,db;fields=fields.sort(function(a,b){da=local_display_names[field_path_prefix+a.name]||a.display_name;db=local_display_names[field_path_prefix+b.name]||b.display_name;da=da.toLowerCase();db=db.toLowerCase();if(da>db)return 1;if(da<db)return-1;return 0;});}}
return fields;},get_bubble_fields:function(field,return_categorized_fields){if(typeof return_categorized_fields=="undefined")
return_categorized_fields=false;if(field.data_type=="entity"){var type_array=[];var sorted_allowed_types=this.sort_entity_types_by_display_name(this.allowed_entity_types(field));for(var i=0;i<sorted_allowed_types.length;i++){var type=sorted_allowed_types[i];if(!this.entity_types[type]){continue;}
var fields;if(return_categorized_fields){fields=this.get_categorized_fields(type,false,true);}else{var field_names=this.entity_types[type].fields_sorted_by_display_name;fields=[];for(var j=0;j<field_names.length;j++)
fields.push(this.get_field(type,field_names[j]));}
type_array.push({entity_type:type,fields:fields});}
return type_array;}
else
return null;},get_categorized_fields:function(entity_type,omit_identifier_field,omit_no_column_fields){var field_names=this.entity_types[entity_type].fields_sorted_by_display_name;var schema=this.entity_fields[entity_type];var ordinary_fields=[];var pivot_column_fields=[];var audit_fields=[];var smart_cut_fields=[],smartFieldRegex=/^smart_/;var association_fields=[];var dependency_fields=[];var include_pivot_columns=false;var aet=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(aet.indexOf(entity_type)!=-1)
include_pivot_columns=true;for(var i=0;i<field_names.length;i++){var field_name=field_names[i];var field=schema[field_name];var data_type=field.data_type;if(omit_no_column_fields&&!field.grid_column){continue;}else if(omit_identifier_field&&field.identifier_column){continue;}else if(data_type=='pivot_column'){if(include_pivot_columns)
pivot_column_fields.push(field);}else if(field_name=='created_at'||field_name=='updated_at'||field_name=='created_by'||field_name=='updated_by'){audit_fields.push(field);}else if(field_name=='sg_smart_sync_linked_shots'||field_name=='sg_handle_duration'||field_name.match(smartFieldRegex)){smart_cut_fields.push(field);}else if(entity_type=='Task'&&(field_name=='upstream_tasks'||field_name=='downstream_tasks'||field_name=='pinned'||field_name=='dependency_violation')){if(field.name=='upstream_tasks')
field.absolute_sort_order=0;else if(field.name=='downstream_tasks')
field.absolute_sort_order=1;else if(field.name=='dependency_violation')
field.absolute_sort_order=2;else
field.absolute_sort_order=3;dependency_fields.push(field);}else{ordinary_fields.push(field);}
if(data_type=="entity"||data_type=="multi_entity"){if(entity_type!='Status'||field_name!='icon')
association_fields.push(field);}}
return{ordinary:ordinary_fields,pivot_column_fields:pivot_column_fields,audit:audit_fields,smart_cut:smart_cut_fields,association:association_fields,dependency:dependency_fields};},get_identifier_field:function(entity_type){var fields=this.entity_fields[entity_type];for(var f in fields){if(fields.hasOwnProperty(f)&&fields[f].identifier_column)
return f;}
return null;},is_identifier_field:function(entity_type,field){var schema_field=this.get_field(entity_type,field);if(!schema_field)return false;if(this.is_bubbled_field(entity_type,field))
return false;else
return schema_field.identifier_column;},project_by_id:function(project_id){for(var i=0;i<this.projects.length;i++)
if(this.projects[i].id==project_id)
return this.projects[i];for(var i=0;i<this.archived_projects.length;i++)
if(this.archived_projects[i].id==project_id)
return this.archived_projects[i];return null;},get_grouping_options:function(entity_type,field){var schema_field=this.get_field(entity_type,field);var grouping_options=this.grouping_options[schema_field.data_type];var options=[];options.push({name:"exact",display_name:"By exact value"});if(typeof grouping_options=="string")
grouping_options=this.grouping_options[grouping_options];if(grouping_options){for(var i=0;i<grouping_options.length;i++){var method=grouping_options[i][0];if(method=="entitytype"&&(SG.schema.allowed_entity_types(schema_field).length==1))
continue;options.push({name:method,display_name:grouping_options[i][1]});}}
return options;},filters_for_grouping:function(entity_type,groups,template_values){var filters=[];for(var i=0;i<groups.length;i++)
{filters=filters.concat(this.filters_for_one_group_hash(entity_type,groups[i],template_values[i]));}
return{logical_operator:'and',conditions:filters};},filters_for_one_group_hash:function(entity_type,grouping,value){var schema_field=this.get_field(entity_type,grouping.column);var filters,relation;if(value===null||(Ext.type(value)==='array'&&value.length===0)){return[{path:grouping.column,relation:'is',values:[null],active:true}];}
if(grouping.method=='exact'&&schema_field.data_type=='url'){return[{path:grouping.column,relation:'name_is',values:[value.display_name],active:true}];}
var incr={'tens':10,'hundreds':100,'thousands':1000,'tensofthousands':10000,'hundredsofthousands':100000,'millions':1000000,'oneday':60*SG.globals.preferences.hours_per_day,'fivedays':5*60*SG.globals.preferences.hours_per_day};if(grouping.method=='exact'&&schema_field.data_type=='date_time'){value=Date.sgParseDateTime(value);value=SG.GridEditor.DateTimeParser.data_store_format(value);}
if(Ext.type(value)!=='array')
value=[value];switch(grouping.method){case'exact':case'day':filters=[{path:grouping.column,relation:'is',values:value,active:true}];break;case'week':case'month':case'quarter':case'year':var date=SG.GridEditor.DateParser.parse(value[0]);if(grouping.method=='week')
SG.GridEditor.DateParser.shift_date(date,7);else if(grouping.method=='month')
SG.GridEditor.DateParser.shift_month(date,1);else if(grouping.method=='quarter')
SG.GridEditor.DateParser.shift_month(date,3);else
SG.GridEditor.DateParser.shift_year(date,1);date=SG.GridEditor.DateParser.data_store_format(date);filters=[{path:grouping.column,relation:'greater_than_or_equal',values:value,active:true},{path:grouping.column,relation:'less_than',values:[date],active:true}];break;case'clustered_date':filters=this.clustered_date_filters(grouping.column,value[0]);break;case'entitytype':filters=[{path:grouping.column,relation:'type_is',values:value,active:true}];break;case'firstletter':if(['entity','multi_entity'].indexOf(schema_field.data_type)!==-1)
relation='name_starts_with';else
relation='starts_with';filters=[{path:grouping.column,relation:relation,values:value,active:true}];break;case'tens':case'hundreds':case'thousands':case'tensofthousands':case'hundredsofthousands':case'millions':case'oneday':case'fivedays':var low=Number(value[0]);var high=Number(value[0])+incr[grouping.method];filters=[{path:grouping.column,relation:'greater_than_or_equal',values:[low],active:true},{path:grouping.column,relation:'less_than',values:[high],active:true}];break;default:filters=[];break;}
return filters;},clustered_date_filters:function(field_name,value){if(['yesterday','today','tomorrow'].indexOf(value)>-1)
return[{path:field_name,relation:'is',values:[SG.GridEditor.DateParser.date_for_token({relative_day:value})],active:true}];var yesterday=SG.GridEditor.DateParser.data_store_format(SG.GridEditor.DateParser.get_normalized_yesterday());var tomorrow=SG.GridEditor.DateParser.data_store_format(SG.GridEditor.DateParser.get_normalized_tomorrow());if(value==='earlier_this_week')
return[{path:field_name,relation:'less_than',values:[yesterday],active:true},{path:field_name,relation:'in_calendar_week',values:[0],active:true}];if(value==='later_this_week')
return[{path:field_name,relation:'greater_than',values:[tomorrow],active:true},{path:field_name,relation:'in_calendar_week',values:[0],active:true}];if(value==='this_week')
return[{path:field_name,relation:'in_calendar_week',values:[0],active:true}];if(value==='last_week')
return[{path:field_name,relation:'less_than',values:[yesterday],active:true},{path:field_name,relation:'in_calendar_week',values:[-1],active:true}];if(value==='inclusive_last_week')
return[{path:field_name,relation:'in_calendar_week',values:[-1],active:true}];if(value==='next_week')
return[{path:field_name,relation:'greater_than',values:[tomorrow],active:true},{path:field_name,relation:'in_calendar_week',values:[1],active:true}];if(value==='inclusive_next_week')
return[{path:field_name,relation:'in_calendar_week',values:[1],active:true}];if(value==='last_few_weeks')
return[{path:field_name,relation:'in_last',values:[4,'WEEK'],active:true},{logical_operator:'or',negate:true,conditions:[{path:field_name,relation:'in_calendar_week',values:[0],active:true},{path:field_name,relation:'in_calendar_week',values:[-1],active:true}]}];if(value==='next_few_weeks')
return[{path:field_name,relation:'in_next',values:[4,'WEEK'],active:true},{logical_operator:'or',negate:true,conditions:[{path:field_name,relation:'in_calendar_week',values:[0],active:true},{path:field_name,relation:'in_calendar_week',values:[1],active:true}]}];if(value==='last_few_months')
return[{path:field_name,relation:'in_last',values:[120,'DAY'],active:true},{path:field_name,relation:'not_in_last',values:[4,'WEEK'],active:true},];if(value==='next_few_months')
return[{path:field_name,relation:'in_next',values:[120,'DAY'],active:true},{path:field_name,relation:'not_in_next',values:[4,'WEEK'],active:true},];if(value==='long_ago')
return[{path:field_name,relation:'less_than',values:[yesterday],active:true},{path:field_name,relation:'not_in_last',values:[120,'DAY'],active:true}];if(value==='far_future')
return[{path:field_name,relation:'greater_than',values:[tomorrow],active:true},{path:field_name,relation:'not_in_next',values:[120,'DAY'],active:true}];return[{path:field_name,relation:'is',values:[null],active:true}];},get_step_entity:function(entity_type,field_name){if(field_name=='step_0'){return{code:'ALL TASKS',color:'255,255,255',id:0,list_order:0,short_name:'ALL'};}
var step_id=Number(field_name.split('_')[1]);var steps=SG.globals.steps[entity_type];for(var i=0;i<steps.length;i++){if(steps[i].id==step_id)
return steps[i];}
return null;},get_step_schema:function(step_entity_hash){var i,entity_type,steps;for(entity_type in SG.globals.steps){if(SG.globals.steps.hasOwnProperty(entity_type)){steps=SG.globals.steps[entity_type];for(i=0;i<steps.length;i++){if(steps[i].id===step_entity_hash.id)
return steps[i];}}}
return null;},entity_type_has_steps:function(entity_type){var schema_field=SG.schema.get_field(entity_type,'tasks');return schema_field!=null;},get_pipeline_order_steps:function(entity_type){var steps=[SG.schema.get_step_entity(entity_type,'step_0')];if(SG.globals.steps[entity_type])
steps=steps.concat(SG.globals.steps[entity_type]);steps.sort(function(a,b){var a_order=a.list_order;var b_order=b.list_order;return a_order<b_order?-1:(a_order>b_order?1:0);});return steps;},get_pipeline_order_fields:function(entity_type){var steps=this.get_pipeline_order_steps(entity_type);var fields=[];var field;for(var i=0;i<steps.length;i++){field=this.entity_fields[entity_type]["step_"+steps[i].id];if(field&&field.data_type=='pivot_column')
fields.push(field);}
return fields;},get_summary_default:function(schema_field){var summary_column=schema_field.data_type=='summary'?schema_field.summary_field:schema_field.name;var summary_type=schema_field.summary_default?schema_field.summary_default:'none';var summary_value=null;if(schema_field.summary_value!==undefined)
summary_value=schema_field.summary_value;if(summary_value===null&&summary_type=='status_percentage'){var sum_schema_field=schema_field;if(schema_field.data_type=='summary')
sum_schema_field=SG.schema.get_field(schema_field.query.entity_type,summary_column);if(sum_schema_field.status_list_subset&&sum_schema_field.status_list_subset.indexOf('fin')!=-1)
summary_value='fin';else if(sum_schema_field.status_list_default)
summary_value=sum_schema_field.status_list_default;}
return{column:summary_column,type:summary_type,value:summary_value};},get_linked_pipeline_steps:function(entity_type)
{var linked_pipelines=[];var i,schema_field;var inverse_association_field_schemas=[];var all_fields=SG.schema.entity_types[entity_type].fields_sorted_by_display_name;for(i=0;i<all_fields.length;i++){var field_name=all_fields[i];schema_field=SG.schema.get_field(entity_type,field_name);if(schema_field&&schema_field.inverse_association)
inverse_association_field_schemas.push(schema_field);}
for(i=0;i<inverse_association_field_schemas.length;i++){schema_field=inverse_association_field_schemas[i];var linked_steps_hash={schema_field:schema_field,entity_types:[]};var inverse_associations=(schema_field.inverse_association.constructor==Array)?schema_field.inverse_association:[schema_field.inverse_association];for(var j=0;j<inverse_associations.length;j++){var association_entity_type=inverse_associations[j].split('.')[0];if(!SG.schema.entity_type_has_steps(association_entity_type))
continue;var steps=SG.schema.get_pipeline_order_steps(association_entity_type);if(steps&&steps.length>0)
linked_steps_hash.entity_types.push({entity_type:association_entity_type,steps:steps});}
if(linked_steps_hash.entity_types.length>0)
linked_pipelines.push(linked_steps_hash);}
return linked_pipelines;},entity_icon_name:function(entity_type){if(!entity_type)
return'';if(entity_type.match(/Connection$/))
return'icon_GenericConnection';else
return'icon_'+entity_type;}});SG.allow=function(rule_type,args_hash)
{var rules=SG.globals.current_user.permission_rule_set.rules;for(var i=0;i<rules.length;i++)
{var rule=rules[i];var response=SG.__apply_rule(rule_type,args_hash,rule);if(response=="allowed")
return true;else if(response=="disallowed")
return false;}
return false;}
SG.permission_retrieve=function(rule_type,args_hash)
{var rules=SG.globals.current_user.permission_rule_set.rules;for(var i=0;i<rules.length;i++)
{var rule=rules[i];if(SG.__match(rule_type,args_hash,rule))
return rule.retrieve_value;}
return null;}
SG.permission_rule_fields=function(entity_type)
{var rules=SG.globals.current_user.permission_rule_set.rules;var paths=[];for(var i=0;i<rules.length;i++)
{var rule=rules[i];if(rule.rule_type=='update_field_condition'&&rule.parameters.entity_type==entity_type&&rule.retrieve_value)
SG.extract_field_paths(rule.retrieve_value,paths);if(rule.rule_type=='retire_entity_condition'&&rule.parameters.entity_type==entity_type&&rule.retrieve_value)
SG.extract_field_paths(rule.retrieve_value,paths);}
return paths;}
SG.extract_field_paths=function(condition,paths)
{if(condition.path)
{if(paths.indexOf(condition.path)==-1)
paths.push(condition.path);}
else
{for(var i=0;i<condition.conditions.length;i++)
this.extract_field_paths(condition.conditions[i],paths);}}
SG.__apply_rule=function(rule_type,args_hash,rule)
{if(SG.__match(rule_type,args_hash,rule))
return rule.allow?"allowed":"disallowed";else
return"not_applicable";}
SG.__match=function(rule_type,args_hash,rule)
{if(rule_type!=rule.rule_type)
return false;var parameters=SG.globals.permission_rule_type_parameters[rule_type];for(var i=0;i<parameters.length;i++)
{var parm=parameters[i];var rule_parm_value=rule.parameters[parm];if(!(args_hash.hasOwnProperty(parm)&&(rule_parm_value==null||args_hash[parm]=="__ALL_VALUES__"||rule_parm_value==args_hash[parm]||(rule_parm_value=='$BLANK$'&&['',null].indexOf(args_hash[parm])>-1))))
return false;}
return true;}
SG.evaluate_condition=function(record,condition,__internal_use_only_top_condition)
{if(typeof __internal_use_only_top_condition=='undefined')
__internal_use_only_top_condition=true;var entity_type=record.get_type();if(condition.path)
{if(__internal_use_only_top_condition&&(condition.active=='false'||!SG.valid_condition_path(entity_type,condition['path'])))
return true;return SG.__evaluate_simple_condition(record,condition['path'],condition['relation'],condition['values']);}
else
{var subconditions=[];for(var i=0;i<condition.conditions.length;i++)
{if(condition.conditions[i].active=='false')
continue;if(condition.conditions[i].path&&!SG.valid_condition_path(entity_type,condition.conditions[i].path))
continue;subconditions.push(condition.conditions[i]);}
if(subconditions.length==0)
{return true;}
var ret_vals=[];for(var i=0;i<subconditions.length;i++)
{ret_vals[i]=SG.evaluate_condition(record,subconditions[i],false);}
var ret_val=(condition.logical_operator=='and')?(ret_vals.join('').indexOf('false')==-1):(ret_vals.join('').indexOf('true')>-1);return ret_val;}}
SG.valid_condition_path=function(entity_type,path)
{path=path.split('.');while(path.length>0)
{if(!SG.schema.get_field(entity_type,path[0]))
return false;if(path.length>1)
{entity_type=path[1];path=path.slice(2);}
else
path=[];}
return true;}
SG.__evaluate_simple_condition=function(record,path,relation,values)
{var error=record.get_error(path);var actual_value;if(error&&(error.type=='invalid_entry'||error.type=='server_error'))
actual_value=record.get_revert_value(path);else
actual_value=record.get(path);if(actual_value==null&&path.indexOf('.')>-1){var parsed=SG.schema.parse_field_name(record.get_type(),path);if(["bubbledeep","invalid"].indexOf(parsed.type)>-1||parsed.multi_entity)
return true;}
return SG.__evaluate_condition_value(record.get_type(),actual_value,relation,values);}
SG.__evaluate_condition_value=function(entity_type,actual_value,relation,values)
{for(var i=0;i<values.length;i++)
{if(values[i]&&values[i].date_token)
values[i]=Date.sg_date_for_token(values[i]);if(values[i]&&values[i].valid&&values[i].valid=="logged_in_user_token")
values[i]=SG.globals.current_user.entity_hash;}
var value=values.length>0?values[0]:null;if(relation=='is')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{if((value==null||value=='')&&actual_value.length==0)
return true;else if(value&&value.type&&value.id&&actual_value.length>0)
{for(var i=0;i<actual_value.length;i++)
if(value.type==actual_value[i].type&&value.id==actual_value[i].id)
return true;return false;}
else
return false;}
else if(actual_value&&actual_value.type&&actual_value.id)
{if(value===null)
return false;return(value&&value.type&&value.id&&value.type==actual_value.type&&value.id==actual_value.id);}
else if(value&&value.type&&value.id)
{return false;}
else if(typeof value=='number')
{if(typeof actual_value=='string')
actual_value=Number(actual_value);if(actual_value&&typeof actual_value!='number')
throw"Unsupported condition type ("+relation+") for value of type ("+
(typeof actual_value)+"), value = ("+actual_value+").";if(value==null)
throw"Null condition value for condition of type ("+relation+").";return(actual_value==value);}
else if((actual_value&&actual_value.toLowerCase)&&(value&&value.toLowerCase))
return(actual_value.toLowerCase()===value.toLowerCase());else
{return(actual_value===value)||((actual_value===null||actual_value==='')&&(value===null||value===''));}}
else if(relation=='is_not')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{if((value==null||value=='')&&actual_value.length>0)
return true;else if(value&&value.type&&value.id)
{for(var i=0;i<actual_value.length;i++)
if(value.type==actual_value[i].type&&value.id==actual_value[i].id)
return false;return true;}
else
return false;}
else if(actual_value&&actual_value.type&&actual_value.id)
{return!(value&&value.type&&value.id&&value.type==actual_value.type&&value.id==actual_value.id);}
else if((actual_value&&actual_value.toLowerCase)&&(value&&value.toLowerCase))
return(actual_value.toLowerCase()!==value.toLowerCase());else
{return(actual_value!==value)&&!((actual_value===null||actual_value==='')&&(value===null||value===''));}}
else if(relation=='id_of_entity')
{return(value!=null&&entity_type==value.type&&actual_value==value.id);}
else if(relation=='contains')
{return((typeof actual_value=='string')&&!actual_value=='')&&((value==null||value=='')||actual_value.toLowerCase().indexOf(value.toLowerCase())>-1);}
else if(relation=='not_contains')
{return!((typeof actual_value=='string')&&!actual_value=='')||!((value==null||value=='')||actual_value.toLowerCase().indexOf(value.toLowerCase())>-1);}
else if(relation=='starts_with')
{return((typeof actual_value=='string')&&!actual_value=='')&&((value==null||value=='')||actual_value.toLowerCase().indexOf(value.toLowerCase())===0);}
else if(relation=='ends_with')
{if((typeof actual_value!='string')||actual_value=='')
return false;if(value==null||value=='')
return true;var str_value=(value===null?'':value);if(str_value.length>actual_value.length)
return false;actual_value=actual_value.substring(actual_value.length-str_value.length);return(actual_value.toLowerCase().indexOf(str_value.toLowerCase())===0);}
else if(relation=='name_contains')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{for(var i=0;i<actual_value.length;i++)
{if((actual_value[i].type&&actual_value[i].id&&actual_value[i].name)&&((typeof value=='string'&&actual_value[i].name.toLowerCase().indexOf(value.toLowerCase())>-1)||(value==null||value=='')))
{return true;}}
return false;}
else if(actual_value==null)
return false;else
{return(actual_value.type&&actual_value.id&&actual_value.name)&&((typeof value=='string'&&actual_value.name.toLowerCase().indexOf(value.toLowerCase())>-1)||(value==null||value==''));}}
else if(relation=='name_not_contains')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{for(var i=0;i<actual_value.length;i++)
{if((actual_value[i].type&&actual_value[i].id&&actual_value[i].name)&&((typeof value=='string'&&actual_value[i].name.toLowerCase().indexOf(value.toLowerCase())>-1)||(value==null||value=='')))
{return false;}}
return true;}
else if(actual_value==null)
return true;else
{return!(actual_value.type&&actual_value.id&&actual_value.name)||!((typeof value=='string'&&actual_value.name.toLowerCase().indexOf(value.toLowerCase())>-1)||(value==null||value==''));}}
else if(relation=='type_is')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{if(actual_value.length==0)
return(value==null||value=='');for(var i=0;i<actual_value.length;i++)
{if((actual_value[i].type&&actual_value[i].id)&&(typeof value=='string'&&actual_value[i].type==value))
{return true;}}
return false;}
else if(actual_value==null)
return(value==null||value=='');else
{return((actual_value.type&&actual_value.id)&&(typeof value=='string'&&actual_value.type==value));}}
else if(relation=='type_is_not')
{if(typeof actual_value=='object'&&actual_value&&actual_value.hasOwnProperty('length'))
{if(actual_value.length==0)
return!(value==null||value=='');for(var i=0;i<actual_value.length;i++)
{if((actual_value[i].type&&actual_value[i].id)&&(typeof value=='string'&&actual_value[i].type==value))
{return false;}}
return true;}
else if(actual_value==null)
return!(value==null||value=='');else
{return!((actual_value.type&&actual_value.id)&&(typeof value=='string'&&actual_value.type==value));}}
else if(relation=='between')
{var values_as_date=[];if(typeof values[0]=='string'&&values[0].match(/^\d\d\d\d-\d\d-\d\d$/)&&typeof values[1]=='string'&&values[0].match(/^\d\d\d\d-\d\d-\d\d$/))
{if(actual_value==null)
return false;else
return(actual_value>=values[0]&&actual_value<=values[1]);}
else if(typeof values[0]=='string'&&(values_as_date[0]=Date.sgParseDateTime(values[0]))&&typeof values[1]=='string'&&(values_as_date[1]=Date.sgParseDateTime(values[1])))
{if(actual_value==null)
return false;var actual_as_date=Date.sgParseDateTime(actual_value);if(actual_as_date)
{actual_as_date=actual_as_date.getTime();return(actual_as_date>=values_as_date[0].getTime()&&actual_as_date<=values_as_date[1].getTime());}}
else if(typeof values[0]=='number'&&typeof values[1]=='number')
{if(typeof actual_value=='string')
actual_value=Number(actual_value);if(actual_value&&typeof actual_value!='number')
throw"Unsupported condition type ("+relation+") for value of type ("+
(typeof actual_value)+"), value = ("+actual_value+").";if(values[0]==null||values[1]==null)
throw"Null condition value for condition of type ("+relation+").";return(actual_value>=values[0]&&actual_value<=values[1]);}
throw"Unsupported condition type ("+relation+") for "+(typeof values[0])+" value ("+values[0]+") or "+(typeof values[1])+" value ("+values[1]+").";}
else if(relation=='greater_than'||relation=='less_than')
{var value_as_date;if(typeof value=='string'&&value.match(/^\d\d\d\d-\d\d-\d\d$/))
{if(actual_value==null)
return false;else if(relation=='greater_than')
return(actual_value>value);else if(relation=='less_than')
return(actual_value<value);}
else if(typeof value=='string'&&(value_as_date=Date.sgParseDateTime(value)))
{if(actual_value==null)
return false;actual_as_date=Date.sgParseDateTime(actual_value);if(actual_as_date)
{if(relation=='greater_than')
return(actual_as_date.getTime()>value_as_date.getTime());else if(relation=='less_than')
return(actual_as_date.getTime()<value_as_date.getTime());}}
else if(typeof value=='number')
{if(typeof actual_value=='string')
actual_value=Number(actual_value);if(actual_value&&typeof actual_value!='number')
throw"Unsupported condition type ("+relation+") for value of type ("+
(typeof actual_value)+"), value = ("+actual_value+").";if(value==null)
throw"Null condition value for condition of type ("+relation+").";if(relation=='greater_than')
return(actual_value>value);else if(relation=='less_than')
return(actual_value<value);}
throw"Unsupported condition type ("+relation+") for "+(typeof value)+" value ("+value+").";}
else if(['in_next','not_in_next','in_last','not_in_last'].indexOf(relation)>-1)
{if(actual_value==null||actual_value=='')
return false;var sign=(relation=='in_next'||relation=='not_in_next')?1:-1;var actual_value_as_date,base_date,interval_date;if(typeof actual_value=='string'&&actual_value.match(/^\d\d\d\d-\d\d-\d\d$/))
{parser=SG.GridEditor.DateParser;actual_value_as_date=parser.parse(actual_value);base_date=parser.get_normalized_today();interval_date=parser.get_normalized_today();}
else if(typeof actual_value=='string'&&Date.sgParseDateTime(actual_value))
{parser=SG.GridEditor.DateTimeParser;actual_value_as_date=Date.sgParseDateTime(actual_value);base_date=new Date();interval_date=new Date();}
switch(values[1])
{case'HOUR':parser.shift_hour(interval_date,sign*values[0]);break;case'DAY':parser.shift_date(interval_date,sign*values[0]);break;case'WEEK':parser.shift_date(interval_date,sign*7*values[0]);break;case'MONTH':parser.shift_month_same_date(interval_date,sign*values[0]);break;case'YEAR':parser.shift_year(interval_date,sign*values[0]);break;default:throw("Invalid '"+relation+"' range type: "+values[1]);break;}
var bounds=(sign==-1)?[interval_date,base_date]:[base_date,interval_date];if(relation.indexOf('not')==0)
return!(bounds[0].getTime()<=actual_value_as_date.getTime()&&actual_value_as_date.getTime()<=bounds[1]);else
return(bounds[0].getTime()<=actual_value_as_date.getTime()&&actual_value_as_date.getTime()<=bounds[1]);}
else if(relation=='in_calendar_day'||relation=='in_calendar_week'||relation=='in_calendar_year'||relation=='in_calendar_month')
{if(actual_value==null||actual_value=='')
return false;var actual_value_as_date;if(typeof actual_value=='string'&&actual_value.match(/^\d\d\d\d-\d\d-\d\d$/))
{parser=SG.GridEditor.DateParser;actual_value_as_date=parser.parse(actual_value);}
else if(typeof actual_value=='string'&&Date.sgParseDateTime(actual_value))
{parser=SG.GridEditor.DateTimeParser;actual_value_as_date=Date.sgParseDateTime(actual_value);}
if(parser)
{var actual_time=actual_value_as_date.getTime();var start_of_period,end_of_period;if(relation=='in_calendar_day')
{var shifted_date=parser.get_normalized_today();parser.shift_date(shifted_date,value);if(value<0)
{start_of_period=shifted_date;end_of_period=parser.get_normalized_today();}
else if(value>0)
{start_of_period=parser.get_normalized_today();parser.shift_date(start_of_period,1);end_of_period=shifted_date;parser.shift_date(end_of_period,1);}
else if(value==0)
{start_of_period=parser.get_normalized_today();end_of_period=parser.get_normalized_today();parser.shift_date(end_of_period,1);}}
else if(relation=='in_calendar_week')
{if(value<0)
{start_of_period=parser.get_normalized_start_of_calendar_week();parser.shift_date(start_of_period,(7*value));end_of_period=parser.get_normalized_start_of_calendar_week();}
else if(value>0)
{start_of_period=parser.get_normalized_start_of_calendar_week();parser.shift_date(start_of_period,7);end_of_period=parser.get_normalized_start_of_calendar_week();parser.shift_date(end_of_period,(7*value)+7);}
else if(value==0)
{start_of_period=parser.get_normalized_start_of_calendar_week();end_of_period=parser.get_normalized_start_of_calendar_week();parser.shift_date(end_of_period,7);}}
else if(relation=='in_calendar_month')
{var shifted_month=parser.get_normalized_today();parser.shift_month(shifted_month,value);if(value<0)
{start_of_period=shifted_month;end_of_period=parser.get_normalized_today();parser.shift_month(end_of_period,0);}
else if(value>0)
{start_of_period=parser.get_normalized_today();parser.shift_month(start_of_period,1);end_of_period=shifted_month;parser.shift_month(end_of_period,1);}
else if(value==0)
{start_of_period=shifted_month;end_of_period=parser.get_normalized_today();parser.shift_month(end_of_period,1);}}
else if(relation=='in_calendar_year')
{var shifted_year=parser.get_normalized_today();parser.shift_year(shifted_year,value);if(value<0)
{start_of_period=shifted_year;end_of_period=parser.get_normalized_today();parser.shift_year(end_of_period,-1);}
else if(value>0)
{start_of_period=parser.get_normalized_today();parser.shift_year(start_of_period,1);end_of_period=shifted_year;}
else if(value==0)
{start_of_period=parser.get_normalized_today();end_of_period=parser.get_normalized_today();}
return(parser.get_year(start_of_period)<=parser.get_year(actual_value_as_date)&&parser.get_year(end_of_period)>=parser.get_year(actual_value_as_date));}
if(start_of_period)
{start_of_period=start_of_period.getTime();end_of_period=end_of_period.getTime();return(actual_time>=start_of_period&&actual_time<end_of_period);}}
throw"Unsupported condition type ("+relation+") for condition field value ("+actual_value+").";}else if(relation=='name_is'){if(actual_value.constructor==Array){if(actual_value.length==0&&(value==null||value=='')){return true;}else{for(var i=0;i<actual_value.length;i++){var an_actual_value=actual_value[i];if((an_actual_value.type&&an_actual_value.id&&an_actual_value.name)&&(typeof value=='string'&&value.toLowerCase()==an_actual_value.name.toLowerCase())){return true;}}
return false;}}else if(actual_value==null){return(value==null||value=='');}else{return((actual_value.type&&actual_value.id&&actual_value.name)&&(typeof value=='string'&&value.toLowerCase()==actual_value.name.toLowerCase()));}}else{throw"Unsupported relation type in evaluated CRUD condition: "+relation}}
NodeList.prototype.toArray=function(){var ary=[];for(var i=0,len=this.length;i<len;i++){ary.push(this[i]);}
return ary;};function $(id){return document.getElementById(id);}
if(typeof console=='undefined'){console={};console.trace=function(){};console.log=function(){};console.debug=function(){};console.info=function(){};console.warn=function(){};console.error=function(){};console.time=function(){};console.timeEnd=function(){};console.count=function(){};}
function puts(string){console.log(string);}
function pputs(object){puts(JSON.stringify(object));}
function __sg_cookie_name(name){return name+"_u"+SG.globals.current_user.id;}
function setCookie(name,value,expires,path,domain,secure){name=__sg_cookie_name(name);var today=new Date();today.setTime(today.getTime());if(expires&&expires<60000){expires=expires*1000*60*60*24;}
if(path===undefined)path='/';var expires_date=new Date(today.getTime()+(expires));document.cookie=name+'='+escape(value)+
((expires)?';expires='+expires_date.toGMTString():'')+
((path)?';path='+path:'')+
((domain)?';domain='+domain:'')+
((secure)?';secure':'');}
function getCookie(name){name=__sg_cookie_name(name);var start=document.cookie.indexOf(name+"=");var len=start+name.length+1;if((!start)&&(name!=document.cookie.substring(0,name.length))){return null;}
if(start==-1)return null;var end=document.cookie.indexOf(';',len);if(end==-1)end=document.cookie.length;return unescape(document.cookie.substring(len,end));}
get_filename=function(path){var i=path.lastIndexOf("/");if(i==-1)
i=path.lastIndexOf("\\");if(i>-1)
return path.substring(i+1);else
return"";};remove_filename=function(path){var i=path.lastIndexOf("/");if(i==-1)
i=path.lastIndexOf("\\");if(i>-1)
return path.substring(0,i+1);else
return path;};String.prototype.pluralize=function(count){var word=this.toString();if(!count)
count=0;if(count==1)
return word;var plural=word;var exceptions=[["Ends in -y but not vowel+y: change y to -i and add -es",/([b-df-hj-np-tv-z])(y)$/,"$1ies"],["Ends in sibilant consonant s, ss, sh, ch, x: add -es.",/(s|ss|sh|ch|x)$/,"$1es"],["person => people",/([Pp])(erson)$/,"$1eople"],["Words that don't change.",/([Ss]heep|[Dd]eer)$/,"$1"]];var matched=-1;for(var i=0;i<exceptions.length&&matched<0;i++){matched=word.search(exceptions[i][1]);if(matched>-1){plural=word.replace(exceptions[i][1],exceptions[i][2]);}}
if(matched<0)
plural=word+'s';return plural;};String.prototype.tableize=function(){var str=this.toString();var underscored=str.underscore().split('_');underscored[underscored.length-1]=underscored[underscored.length-1].pluralize();return underscored.join('_');};String.prototype.underscore=function(){var str=this.toString();str=str.replace(/([A-Z])/g,"_$1").toLowerCase();if(str.substring(0,1)=='_')
str=str.substring(1);return str;};String.prototype.to_class_name=function(){var words=this.split('_');for(var i=0;i<words.length;i++)
words[i]=words[i].charAt(0).toUpperCase()+words[i].slice(1);return words.join('');};String.prototype.strip=function(){return this.replace(/^\s+/,'').replace(/\s+$/,'');};function image_button(up_url,down_url){var image=document.createElement('img');image.src=up_url;image.onmousedown=function(){this.src=down_url;};image.onmouseup=function(){this.src=up_url;};new Image().src=down_url;return image;}
function add_extra_params(params){if(params){var paramstr="";for(var key in params){if(params.hasOwnProperty(key))
paramstr+="&"+key+"="+params[key];}
return paramstr;}
return"";}
sg_html_node=function(type,id,className){var d=document.createElement(type);if(id!=null)
d.id=id;if(className!=null)
d.className=className;return d;};sg_text_node=function(str){return document.createTextNode(str);};sg_image_node=function(src_url){var img=sg_html_node("img",null,null);img.setAttribute("src",src_url);return img;};sg_project_name=function(project_id){var projects=SG.schema.projects;var project=null;for(var i=0;i<projects.length;++i){if(projects[i].id===project_id){project=projects[i];break;}}
return project&&project.name;};function sg_deep_copy(my_obj){if(my_obj===undefined)
return my_obj;else
return JSON.parse(JSON.stringify(my_obj));}
function sg_get_template(widget,template_name){if(!sg_template_cache[widget])
sg_template_cache[widget]={};return sg_template_cache[widget][template_name];}
function sg_set_template(widget,template_name,template_string){if(!sg_template_cache[widget])
sg_template_cache[widget]={};var tmp=sg_template_cache[widget][template_name]=new Ext.Template(template_string);tmp.disableFormats=true;tmp.compile();return tmp;}
function really_absolute_position(element){if(element.tagName=="INPUT"){var parent=element.parentNode;if(parent.tagName=="TD"&&parent.hasAttribute("sg_type")){element=parent;}}
var obj={};obj.height=element.offsetHeight;obj.width=element.offsetWidth;obj.top=0;obj.left=0;obj.scrollXcount=0;obj.scrollYcount=0;var origin=document.body;while(element!=origin){if(element.offsetWidth-element.clientWidth>10)
obj.scrollYcount++;if(element.offsetHeight-element.clientHeight>10)
obj.scrollXcount++;obj.top+=element.offsetTop-element.scrollTop;obj.left+=element.offsetLeft-element.scrollLeft;element=element.offsetParent;}
obj.total_height=origin.offsetHeight;obj.total_width=origin.offsetWidth;return obj;}
function sg_get_url_hash_part(){var url=window.location.href;var pos=url.indexOf("#");if(pos>-1)
return url.substring(pos);else
return"";}
function sg_pivot_condition_hash_OLD(pivot_from_type,pivot_field,condition_hash){if(condition_hash.path){condition_hash.path=pivot_field+"."+pivot_from_type+"."+condition_hash.path;}else{var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
sg_pivot_condition_hash(pivot_from_type,pivot_field,conditions[i]);}
return condition_hash;}
function sg_pivot_condition_hash(pivot_from_type,pivot_field,condition_hash){if(condition_hash.path){condition_hash.path=pivot_field+"."+pivot_from_type+"."+condition_hash.path;return condition_hash;}
return{'base_path':pivot_field,'subquery':{'type':pivot_from_type,'filters':condition_hash}};}
function sg_add_prefix_to_condition_paths(prefix,condition_hash){if(condition_hash.path){condition_hash.path=prefix+"."+condition_hash.path;}else{var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
sg_add_prefix_to_condition_paths(prefix,conditions[i]);}
return condition_hash;}
function sg_count_active_filters(condition_hash){if(condition_hash.path){if(condition_hash.active!='false')
return 1;else
return 0;}else{var count=0;var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
count+=sg_count_active_filters(conditions[i]);return count;}}
function sg_field_filtered_to_one_value(schema_field,field_path,filter_group){if(schema_field.data_type==='multi_entity')
return false;var i,condition;if(filter_group.logical_operator==='and'||sg_non_recursive_count_active_filters(filter_group)===1)
{for(i=0;i<filter_group.conditions.length;i++){condition=filter_group.conditions[i];if(condition.path){if(condition.active!=='false'&&condition.path===field_path&&condition.relation==='is')
{return true;}}else{if(sg_field_filtered_to_one_value(schema_field,field_path,condition))
return true;}}}else{return false;}
return false;}
function sg_non_recursive_count_active_filters(filter_group){var count=0
for(var i=0;i<filter_group.conditions.length;i++){if(filter_group.conditions[i].active!=='false')
count++;}
return count;}
function sg_missing_image(img){img.src="/images/missing_image.png";}
function sg_missing_user_thumb(img){img.src="/images/default_user_thumb.png";}
function sg_missing_project_thumb(img){img.src="/images/missing_thumbnail_project.png";}
function sg_constrain_and_unhide_image(img){sg_constrain_image(img);var img_elem=Ext.get(img);if(img_elem.hasClass('invisible'))
img_elem.replaceClass('invisible','visible');}
function sg_constrain_image(img){var imgObj=Ext.get(img);var style;if(img.naturalWidth>img.naturalHeight){style='height: auto;';if(imgObj.getStyle('max-width')==='none')
style+='max-width: 100%;';img.setAttribute('style',style);}else{style='width: auto;';if(imgObj.getStyle('max-height')==='none')
style+='max-height: 100%';}
img.setAttribute('style',style);}
function sg_limit_thumbnail_cell_size(img){img.parentNode.setAttribute('style','max-width: '+img.naturalWidth+'px; max-height: '+img.naturalHeight+'px;');}
function sg_comma_format_number(num){var snum=String(num);var r=/(\d+)(\d{3})/;var spl=snum.split('.');while(r.test(spl[0])){spl[0]=spl[0].replace(r,'$1'+','+'$2');}
if(spl.length==2)
return spl.join('.');else
return spl[0];}
function simulate_click(obj){var evt=document.createEvent("MouseEvents");evt.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);obj.dispatchEvent(evt);}
function sg_find(selector,parent){if(!parent)
parent=document.body;return parent.querySelector(selector);}
function sg_find_all(selector,parent){if(!parent)
parent=document.body;var ret=parent.querySelectorAll(selector);return ret.toArray();}
function mod(argument,base){if(argument<0)
return(argument%base)+base;else
return(argument%base);}
function sg_css_color(database_color_format){return'rgb('+database_color_format+')';}
function sg_close_all_floating_windows(){SG.globals.floating_components=SG.globals.floating_components||[];var floaters=SG.globals.floating_components.concat([]);for(var i=0;i<floaters.length;i++){var floater=floaters[i];floater.hide();}}
function sg_has_multi_upload(){if(!SG.globals.hasOwnProperty('has_multi_upload')){var el=Ext.get('check_multiple_support');SG.globals.has_multi_upload=("multiple"in el.dom);}
return SG.globals.has_multi_upload;}
function sg_platform(){if(!SG.globals.hasOwnProperty('platform')){var agent=navigator.userAgent;if(agent.match(/Windows/))
SG.globals.platform="Windows";else if(agent.match(/Mac/))
SG.globals.platform="Mac";else if(agent.match(/(Linux)|(X11)/))
SG.globals.platform="Linux";else
alert("Couldn't determine platform, email Matt!");}
return SG.globals.platform;}
function sg_is_in_rv(){return navigator.userAgent.match(/ RV /)?true:false;}
function sg_has_localfile_applet(){if(!SG.globals.hasOwnProperty('has_localfile_applet')){if(window.sgLocalFile){SG.globals.has_localfile_applet=true;}else{try{var a=Ext.get('sg_java_localfile');a.dom.checkSupport();SG.globals.has_localfile_applet=true;}catch(e){SG.globals.has_localfile_applet=false;}}}
return SG.globals.has_localfile_applet;}
function sg_open_localfile(path){if(window.sgLocalFile){window.sgLocalFile.open("file://"+path);return;}
var applet=Ext.get('sg_java_localfile').dom;if(applet){applet.open(path);if(applet.errorResult=="SGOPENERROR"){var msg='The file you selected is a local file that has either moved or '+'is on a file system you do not have access to.  '+'Please contact your friendly admin to discuss the issue.';alert(msg);}}}
function sg_new_entity_dialog(config){var dialog;var i;if(SG.globals.custom_for=="drd"){for(i=0;i<SG.schema.projects.length;i++){if((SG.schema.projects[i].id==2)&&(SG.schema.projects[i].name=="Happy Feet 2")){config.single_project=SG.schema.projects[i];}}}
if(SG.globals.custom_for=="halon"){if(config.entity_type=='Ticket'){for(i=0;i<SG.schema.projects.length;i++){if(SG.schema.projects[i].id==50){config.single_project=SG.schema.projects[i];}}}
else if(config.entity_type=='CustomThreadedEntity05'){for(i=0;i<SG.schema.projects.length;i++){if(SG.schema.projects[i].id==60){config.single_project=SG.schema.projects[i];}}}}
var entity_type;if(config&&config.entity_type)
entity_type=config.entity_type;if(entity_type==='Note')
dialog=new SG.NewNoteDialog(config);else if(entity_type==='Version'&&SG.NewVersionDialog.is_supported())
dialog=new SG.NewVersionDialog(config);else
dialog=new SG.NewEntityDialog(config);return dialog;}
function elapsed_time_phrase(before_date,optional_after_date){var after_date=optional_after_date||new Date();var minutes=Math.floor((after_date.getTime()-before_date.getTime())/60000);if(minutes<=55)
return minutes+" "+"minute".pluralize(minutes)+" ago";var hours=Math.round(minutes/60);if(hours<=18)
return hours+" "+"hour".pluralize(hours)+" ago";var days=Math.round(hours/24);if(days<28)
return days+" "+"day".pluralize(days)+" ago";var months=Math.round(days/30);if(months<=11)
return months+" "+"month".pluralize(months)+" ago";var years=Math.round(days/365);return years+" "+"year".pluralize(years)+" ago";}
function array_contains_entity(array,entity_hash){if(entity_hash==null){return(array.indexOf(null)>-1);}
for(var i=0;i<array.length;i++){if(array[i]==null)
continue;if(array[i].type==entity_hash.type&&array[i].id==entity_hash.id)
return true;}
return false;}
function sg_sort_case_insensitive(arr){arr.sort(function(a,b){if(b===null||typeof b==='undefined')return-1;if(a===null||typeof a==='undefined')return 1;a=a.toLowerCase();b=b.toLowerCase();if(a>b)return 1;if(a<b)return-1;return 0;});return arr;}
function escapeHTML(str){var div=document.createElement('div');var text=document.createTextNode(str);div.appendChild(text);return div.innerHTML;}
function sg_load_entity_field_pref_set(){var set_row_fn=function(pref,pref_type,entity_type){var arow=SG.Repo.get_row("EntityFieldPref",pref.id);arow.set("pref_type",pref_type);arow.set("entity_type",entity_type);arow.set("settings_serialized",pref.settings);if(pref.project_id){var proj=null;for(var ii=0;ii<SG.schema.projects.length;ii++){var schema_project=SG.schema.projects[ii];if(schema_project.id==pref.project_id){proj=schema_project;break;}}
arow.set("project",proj);}
return arow;};var prefs=SG.globals.entity_field_prefs;var rows=[],recs=[];var pref_type,entity_type,cur,row,rec,i;for(pref_type in prefs){if(prefs.hasOwnProperty(pref_type)){for(entity_type in prefs[pref_type]){if(prefs[pref_type].hasOwnProperty(entity_type)){cur=prefs[pref_type][entity_type];if(cur instanceof(Array)){for(i=0;i<cur.length;i++){var val=cur[i];row=set_row_fn(val,pref_type,entity_type);rows.push(row);}}
else{row=set_row_fn(cur,pref_type,entity_type);rows.push(row);}}}}}
for(i=0;i<rows.length;i++){row=rows[i];rec=new SG.Data.Record("EntityFieldPref");rec.load(row);recs.push(rec);}
SG.globals.entity_field_pref_set.load(recs);}
function sg_get_entity_field_pref(pref_type,entity_type,project){var rec,rec_project;for(var i=0;i<SG.globals.entity_field_pref_set.count();i++){rec=SG.globals.entity_field_pref_set.get_record(i);rec_project=project?rec.get("project"):null;if(project){if(rec_project&&rec_project.id==project.id&&rec.get("pref_type")==pref_type&&rec.get("entity_type")==entity_type){return rec;}}else if(rec.get("pref_type")==pref_type&&rec.get("entity_type")==entity_type&&!rec.get('project')){return rec;}}
return null;}
function sg_decrement_duration(duration_value){if(SG.globals.preferences.duration_units==="hours"){return(duration_value-60);}else{return(duration_value-SG.globals.preferences.hours_per_day*60);}}
function sg_increment_duration(duration_value){if(SG.globals.preferences.duration_units==="hours"){return(duration_value+60);}else{return(duration_value+SG.globals.preferences.hours_per_day*60);}}
function sg_duration_floor(duration_value){if(SG.globals.preferences.duration_units==="hours"){return Math.floor(duration_value/60)*60;}else{var day_length=SG.globals.preferences.hours_per_day*60;return Math.floor(duration_value/day_length)*60;}}
function sg_duration_ceil(duration_value){if(SG.globals.preferences.duration_units==="hours"){return Math.ceil(duration_value/60)*60;}else{var day_length=SG.globals.preferences.hours_per_day*60;return Math.ceil(duration_value/day_length)*day_length;}}
function sg_load_set(data_set,response){var handler=new SG.ReadResponseHandler.LoadSet(data_set);handler.handle_response(response);}
function is_ctrl_click(e){var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;return ctrl_click;}
function is_shift_click(e){var dom_event=e.browserEvent;return dom_event.shiftKey;}
function is_alt_click(e){var dom_event=e.browserEvent;return dom_event.altKey;}
function sg_tank_enabled(){return(SG.globals.preferences.enable_tank_integration&&SG.globals.current_user.enable_tank_integration);}
SG.entity_in_hash=function()
{var hash=window.location.hash;var m;if(m=hash.match(/#([A-Za-z0-9]+)_(\d+)_(.*)/))
return{type:m[1],id:m[2],name:decodeURIComponent(m[3])}
else
return null;};SG.create_temp_password=function(){var letters='abcdefghijklmnopqrstuvwxyz';var numbers='0123456789';var symbols='!@#$%^&*?_~-()';var pass='';for(var i=0;i<8;i++){var index=Math.floor(Math.random()*letters.length);pass+=letters.charAt(index);}
var cap_index=Math.floor(Math.random()*8);var num_index=Math.floor(Math.random()*8);while(num_index==cap_index){num_index=Math.floor(Math.random()*8);}
var sym_index=Math.floor(Math.random()*8);while(sym_index==cap_index||sym_index==num_index){sym_index=Math.floor(Math.random()*8);}
var num=numbers.charAt(Math.floor(Math.random()*numbers.length));var sym=symbols.charAt(Math.floor(Math.random()*symbols.length));var fin_pass='';for(var i=0;i<8;i++){if(i==cap_index)
fin_pass+=pass.charAt(i).toUpperCase();else if(i==num_index)
fin_pass+=num;else if(i==sym_index)
fin_pass+=sym;else
fin_pass+=pass.charAt(i)}
return fin_pass;};SG.send_welcome_email=function(user_id,temp_password,password_change,success_callback){var url_prefix=window.location.protocol+'//'+window.location.host;var options={url:'/user/send_welcome_email',params:{user_id:user_id,temp_password:temp_password,url_prefix:url_prefix,password_change:password_change},callback:function(options,success,response){if(success){success_callback.fn.call(success_callback.scope);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);};SG.Component=function(){this.init();};Ext.extend(SG.Component,Ext.util.Observable,{__inheritable_property_object_names__:["templates"],init:function(){this.__subcomponents__=[];this.__data_sets__=[];this.before_init();this.__prepare_inheritable_object_properties__();this.init_templates();this.init_component();this.__SG_CLASS_NAME__=this.__sg_class_name__(this);},before_init:function(){},init_component:function(){},add_event:function(event_source_object,event_name,handler,scope,extra_data){var the_scope=this;if(scope)
the_scope=scope;if(event_source_object&&!event_source_object.on&&event_source_object.nodeType)
event_source_object=Ext.get(event_source_object);event_source_object.on(event_name,handler,the_scope,extra_data);if(!this.events_to_destroy)
this.events_to_destroy=[];this.events_to_destroy.push({source:event_source_object,name:event_name,handler:handler,scope:the_scope});},remove_event:function(event_source_object,event_name,handler,scope){var the_scope=this;if(scope)
the_scope=scope;if(event_source_object&&!event_source_object.un&&event_source_object.nodeType)
event_source_object=Ext.get(event_source_object);event_source_object.un(event_name,handler,the_scope);if(this.events_to_destroy){var new_events_to_destroy=[];var e;for(var i=0;i<this.events_to_destroy.length;i++){e=this.events_to_destroy[i];if(!(e.source==event_source_object&&e.name==event_name&&e.handler==handler)){new_events_to_destroy.push(e);}}
this.events_to_destroy=new_events_to_destroy;}},new_component:function(component_class,config){var MyConstructor=component_class;var cmp=new MyConstructor(config);this.__subcomponents__.push(cmp);cmp.parent_component=this;return cmp;},new_data_set:function(type,load_handler,change_handler){var ds=new SG.Data.Set(type);if(typeof load_handler==="function")
this.add_event(ds,'load',load_handler);if(typeof change_handler==="function")
this.add_event(ds,'change',change_handler);this.__data_sets__.push(ds);return ds;},get_parent_widget:function(){if(this.widget)
return this.widget;else if(this.parent_component)
return this.parent_component.get_parent_widget();else
return null;},get_parent_component:function(){if(this.parent_component)
return this.parent_component;else
return null;},get_page:function(){if(this.page)
return this.page;var widget=this.get_parent_widget();if(widget)
return widget.get_page();return null;},destroy:function(){if(!this.__destroyed__){this.destroy_events();this.destroy_data_sets();this.destroy_subcomponents();this.destroy_component();this.__destroyed__=true;}},destroy_component:function(){},destroy_events:function(){if(this.events_to_destroy){var i;for(i=0;i<this.events_to_destroy.length;i++){var an_event=this.events_to_destroy[i];if(an_event.source){an_event.source.un(an_event.name,an_event.handler,an_event.scope);}}
this.events_to_destroy=null;}},destroy_data_sets:function(){var i,ds;for(i=0;i<this.__data_sets__.length;i++){ds=this.__data_sets__[i];if(ds)ds.destroy();}},destroy_subcomponents:function(){var i,sub;for(i=0;i<this.__subcomponents__.length;i++){sub=this.__subcomponents__[i];if(sub)sub.destroy();}},init_templates:function(){var wtype=this.__strip_name_from_constructor__();var template_string;for(var template_name in this.templates){if(this.templates.hasOwnProperty(template_name)){template_string=this.templates[template_name];this.templates[template_name]=sg_get_template(wtype,template_name);if(!this.templates[template_name]){this.templates[template_name]=sg_set_template(wtype,template_name,template_string);}}}},__strip_name_from_constructor__:function(){var ctor_string=this.constructor.toString();var ctor_regex=/SG\.[\w|\.]*?\.superclass/;var res=ctor_string.match(ctor_regex);if(res){var end=res[0].indexOf('.superclass');return res[0].substr(0,end);}else{return"SG.Component";}},__prepare_inheritable_object_properties__:function(){for(var i=0;i<this.__inheritable_property_object_names__.length;i++)
{this.__inherit_object_properties__(this.__inheritable_property_object_names__[i]);}},__inherit_object_properties__:function(property_name){var prototypes=[];var current=this.constructor;do{prototypes.push((current.prototype[property_name]||{}));current=current.superclass.constructor;}while(current.superclass);var obj={};for(var i=prototypes.length-1;i>=0;i--){var proto=prototypes[i];for(var key in proto){if(proto.hasOwnProperty(key))
obj[key]=proto[key];}}
this[property_name]=obj;},__sg_class_name__:function(obj){var str=obj.constructor.toString();var matches=str.match(/SG.*superclass\.constructor/);if(!matches||matches.length!=1)return"Unknown";var parts=matches[0].split('.');var front=parts.slice(0,parts.length-2);return front.join('.');},});SG.FloatingComponent=function(config){Ext.apply(this,config);SG.FloatingComponent.superclass.constructor.call(this);};Ext.extend(SG.FloatingComponent,SG.Component,{init_component:function(){SG.globals.floating_components=SG.globals.floating_components||[];SG.globals.floating_components.push(this);},destroy_component:function(){var index=SG.globals.floating_components.indexOf(this);SG.globals.floating_components.splice(index,1);},hide:function(){alert('Your floater has not implemented hide()');}});SG.util.GlobalNav=function(config){Ext.apply(this,config);SG.util.GlobalNav.superclass.constructor.call(this,config);};Ext.extend(SG.util.GlobalNav,SG.Component,{templates:{main:'<div class="top_bar">{logo}{sg_version}{home}{projects}{pages}{people}{apps}'+'<div class="nav_item spacer"></div>{user}{plus}{gear}{search}'+'</div>{project_nav}',main_restricted:'<div class="top_bar">{logo}{home}{logout}<div style="clear: both;"></div></div>',nav_item:'<div class="nav_item {extra}">{content}</div>',logo:'<a href="/user/home"><div class="nav_icon_shotgun_logo"></div></a>',sg_version:'<div class="shotgun_version">{ver}</div>',button:'<div class="button {extra}">{label}</div>',menu_button:'<div class="menu button {extra}"><span class="menu_text" sg_tip="{sg_tip}">{menu_label}</span>'+'<div class="icon {arrow_icon_class}"></div></div>',user_menu_button:'<div class="menu button {extra}">'+'<div class="user_thumb">'+'<img src="{user_thumb}" class="invisible" '+'onload="sg_constrain_and_unhide_image(this)" on_error="sg_missing_user_thumb(this)"/></div>'+'<span class="menu_text">{menu_label}</span>'+'<div class="icon arrow_open_light"></div></div>',link:'<a class="button_link" href="{url}">{label}</a>',project_nav:'<div class="project_nav"><div class="project_name">{project_name}</div>'+'{buttons}<div class="nav_item spacer"></div>{gear}</div>',landing_page_href:'/page/project_default?entity_type={entity_type}&project_id={project_id}',icon:'<div class="button {extra}"><div class="global_nav_icon {icon_class} {extra_icon}"></div></div>',search:'<div class="button {extra}"><div class="global_nav_icon {icon_class} {extra_icon}"></div>'+'<div class="quick_jump_message">Quick Jump (q)</div>'+'<div class="quick_jump_wrapper"><div class="sgc_quick_jump" id="quick_jump_component"></div></div>'+'</div>',},init_component:function(){SG.NotificationCenter.add_observer({uuid:'global_nav',name:'page_constructed',callback:{fn:this.on_page_constructed,scope:this}});SG.NotificationCenter.add_observer({uuid:'global_nav',name:'page_destroyed',callback:{fn:this.on_page_destroyed,scope:this}});},setup_entity_field_pref:function(){var page_project=this.get_project();this.entity_field_pref=sg_get_entity_field_pref("nav_bar","Project",page_project);if(!this.entity_field_pref)
this.entity_field_pref=sg_get_entity_field_pref("nav_bar","Project");var i,et;var pp=sg_deep_copy(this.entity_field_pref.get("settings_serialized"));this.project_pages=[];for(i=0;i<pp.length;i++){if(pp[i].app_name){this.project_pages.push(pp[i]);}else{et=pp[i].entity_type;if(SG.schema.entity_types[et].enabled&&SG.schema.can_see_entity_type(et))
this.project_pages.push(pp[i]);}}},on_page_constructed:function(args){if(args.page.canvas_designer_page)return;this.page=args.page;this.setup_entity_field_pref();this.render();},on_page_destroyed:function(args){if(args.page.canvas_designer_page)return;this.page=args.new_page;if(this.page)
this.render();},render:function(){if(!this.__rendered__){this.__rendered__=true;this.on_first_render();}
this.render_component();},on_first_render:function(){this.container=Ext.get(this.container_id);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'contextmenu',this.on_contextmenu);var dbody=Ext.get(document.body);this.add_event(dbody,'click',this.on_click_dbody);this.add_event(SG.globals.entity_field_pref_set,'change',this.on_entity_field_pref_change);this.setup_page_level_keyboard_shortcuts();SG.LoginBanner.render();},render_component:function(){if(this.restricted_navigation){this.render_restricted_navigation();return;}
var page_project_id=this.get_page_project_id();var html=this.templates.main.apply({logo:this.render_logo(),home:this.render_home(),projects:this.render_projects(),pages:this.render_pages(),people:this.render_people(),apps:this.render_apps(),search:this.render_search(),gear:this.render_gear(),plus:this.render_plus(),user:this.render_user_menu(),project_nav:page_project_id?this.render_project_nav():''});this.container.update(html);var parent_container=Ext.get(this.container.dom.parentNode);if(page_project_id&&!parent_container.hasClass('has_project_nav'))
parent_container.addClass('has_project_nav');else if(!page_project_id&&parent_container.hasClass('has_project_nav'))
parent_container.removeClass('has_project_nav');if(this.quick_jump)
this.quick_jump.destroy();this.quick_jump=new SG.QuickJump({container_id:'quick_jump_component'});this.quick_jump.render();},render_restricted_navigation:function(){var logout_control=this.templates.nav_item.apply({extra:'logout',content:'Logout'});var html=this.templates.main_restricted.apply({home:this.render_home(),logo:this.render_logo(),logout:logout_control});this.container.update(html);},render_project_nav:function(){var project=this.get_project();var gear="";if(SG.globals.current_user.admin){gear=this.templates.nav_item.apply({content:this.templates.menu_button.apply({extra:'gear_menu',menu_label:'Nav',arrow_icon_class:'arrow_open_dark_small'}),extra:'config_project_nav'});}
return this.templates.project_nav.apply({project_name:project.name,buttons:this.render_project_nav_buttons(),gear:gear});},render_project_nav_buttons:function(){var opts=this.project_pages;var project=this.get_project();var html='';var extra;var opt;this.project_nav_entity_types=["Page"];var nothing_selected=true;for(var i=0;i<opts.length;i++){opt=opts[i];if(opt.app_name){if(opt.app_name=='resource_planning_app'&&!(SG.globals.preferences.crew_planning_app_active&&SG.allow("see_project_bar_crew_app_brick",{})))
{continue;}
var extra='';extra='';if(this.is_app_selected(opt.app_name)){extra='selected';nothing_selected=false;}
html+=this.templates.nav_item.apply({content:this.templates.button.apply({label:this.render_project_nav_app_button_label(opt)}),extra:extra});}else{if(SG.schema.leftnav_page_entity_types.indexOf(opt.entity_type)===-1)continue;this.project_nav_entity_types.push(opt.entity_type);extra='';if(this.is_selected(opt.entity_type)){extra='selected';nothing_selected=false;}
html+=this.templates.nav_item.apply({content:this.templates.button.apply({label:this.render_project_nav_button_label(opt)}),extra:extra});}}
if(!SG.allow("hide_other_in_project_nav",{}))
html+=this.render_other(nothing_selected);html+=this.render_pages(true);return html;},render_project_nav_button_label:function(button_hash){var url;var project=this.get_project();var display_name=this.get_project_nav_button_display_name(button_hash);if(button_hash.entity_type=='Project'){url='/detail/Project/'+project.id;}else{url='/page/project_default?entity_type='+button_hash.entity_type+'&'+'project_id='+project.id+'&brick_name='+display_name;}
return this.templates.link.apply({url:url,label:display_name});},apps_url_map:{resource_planning_app:'/page/crew_planning_app',notes_app:'/page/notes_app',revolver:'/page/review_app_webview'},render_project_nav_app_button_label:function(opt){var project=this.get_project();var url=this.apps_url_map[opt.app_name]+'?project_id='+project.id;return this.templates.link.apply({url:url,label:opt.display_name});},is_app_selected:function(app_name){var url=this.apps_url_map[app_name];if(!url)return false;if(window.location.href.indexOf(url)!=-1)
return true;else
return false;},get_project_nav_button_display_name:function(setting){if(setting.display_name&&setting.display_name!='')
return setting.display_name;else
return SG.schema.entity_types[setting.entity_type]['display_name_pluralized'];},is_selected:function(entity_type){if(this.page.type=="home")return false;if(["project","global_report"].indexOf(this.page.ui_category)!==-1){return this.page.entity_type==entity_type;}
if(this.page.ui_category=="reports"){return entity_type=="Page";}
if(this.page.ui_category=="admin"){return false;}
var context_entity=this.page.context.get('entity');if(context_entity)
return entity_type==context_entity.type;return false;},get_project:function(){var page_project_id=this.get_page_project_id();if(!page_project_id)return null;var i,project;for(i=0;i<SG.schema.projects.length;i++){project=SG.schema.projects[i];if(project.id==page_project_id)return project;}
for(i=0;i<SG.schema.archived_projects.length;i++){project=SG.schema.archived_projects[i];if(project.id==page_project_id)return project;}
return null;},get_page_project_id:function(){var entity_project=this.page.context.get('entity_project');if(this.page.type=='detail'&&entity_project)
return entity_project.id;if(this.page.project_id)return this.page.project_id;if(this.page.entity_type&&this.page.entity_type=='Project'){var project_entity=this.page.context.get('entity');if(project_entity&&project_entity.type=='Project')
return project_entity.id;}
return null;},is_hidden:function(){if(this.hidden)return true;var root_widget=this.get_page_root_widget();return(root_widget.get('type')=='SG.Widget.NotesApp');},get_page_root_widget:function(){return this.page.root_widget;},render_logo:function(){return this.templates.nav_item.apply({extra:'sg_logo',content:this.templates.logo.apply()});},render_home:function(){var extra='';if(this.page.type=="home")
extra='selected';return this.templates.nav_item.apply({content:this.templates.button.apply({label:this.templates.link.apply({url:'/user/home',label:'Home'}),extra:extra})});},render_projects:function(){var extra='overlay_button projects_popover';if(this.page&&this.page.entity_type=='Project'&&this.page.ui_category=='global_report')
extra+=' selected';return this.templates.nav_item.apply({content:this.templates.menu_button.apply({menu_label:'Projects',extra:extra,arrow_icon_class:'arrow_open_light'})});},render_people:function(){var extra='';if(this.is_selected("HumanUser"))
extra="selected";var label=this.templates.link.apply({url:'/page/global_page?entity_type=HumanUser',label:'People'});return this.templates.nav_item.apply({content:this.templates.button.apply({label:label,extra:extra})});},render_apps:function(){return this.templates.nav_item.apply({content:this.templates.menu_button.apply({menu_label:'Apps',extra:'app_menu',arrow_icon_class:'arrow_open_light'})});},render_search:function(){return this.templates.nav_item.apply({content:this.templates.search.apply({icon_class:'nav_icon_quickjump_light',extra:'search_menu menu',extra_icon:'nav_icon_quickjump'})});},render_gear:function(){return this.templates.nav_item.apply({content:this.templates.icon.apply({icon_class:'nav_icon_gear_light',extra:'top_gear_menu menu',extra_icon:'nav_icon_gear'})});},render_plus:function(){return this.templates.nav_item.apply({content:this.templates.icon.apply({icon_class:'nav_icon_plus_light',extra:'plus_menu menu',extra_icon:'nav_icon_plus'})});},render_pages:function(is_project_nav){var extra='overlay_button ';if(is_project_nav)
extra+='project_pages_overlay_button';else
extra+='global_pages_overlay_button';return this.templates.nav_item.apply({content:this.templates.menu_button.apply({menu_label:'Pages',extra:extra,arrow_icon_class:is_project_nav?'arrow_open_dark_small':'arrow_open_light'})});},render_other:function(selected){var extra='overlay_button other_menu_button ';return this.templates.nav_item.apply({content:this.templates.menu_button.apply({menu_label:'Other',extra:extra,arrow_icon_class:'arrow_open_dark_small'}),extra:selected&&' selected'});},render_new_entity_menu:function(){return this.templates.nav_item.apply({content:this.templates.menu_button.apply({extra:'new_entity_menu',menu_label:'New',arrow_icon_class:'arrow_open_light'})});},render_import_menu:function(){return this.templates.nav_item.apply({content:this.templates.menu_button.apply({extra:'import_menu',menu_label:'Import',arrow_icon_class:'arrow_open_light'})});},render_user_menu:function(){return this.templates.nav_item.apply({content:this.templates.user_menu_button.apply({extra:'user_menu',sg_tip:SG.globals.current_user.display_name,menu_label:SG.globals.current_user.display_name,user_thumb:SG.globals.current_user.thumb_url,})});},render_help_menu:function(){return this.templates.nav_item.apply({content:this.templates.menu_button.apply({extra:'help_menu',menu_label:'Help',arrow_icon_class:'arrow_open_light'})});},open:function(url){var root_widget=this.get_page_root_widget();root_widget.show_loading_overlay();window.location=url;},on_click_dbody:function(e){var t=Ext.get(e.getTarget());var global_nav=t.findParent('#sg_global_nav',100);if(global_nav)return;this.hide_search_menu();},on_click:function(e){var t=Ext.get(e.getTarget());var search_menu=t.findParent('div.search_menu',this.container,true);if(search_menu){var wrapper=t.findParent('div.quick_jump_wrapper',this.container);if(!wrapper){this.toggle_search_menu(search_menu);}
return;}else{this.hide_search_menu();}
var link=t.findParent('a.button_link',this.container);if(link){var click_type=this.page.handle_link_click(this.container,e,t,link);if(click_type==='click'){var project_nav_button=t.findParent('span.project_nav_button',this.container,true);if(project_nav_button)this.select_project_nav_button(project_nav_button);}
return;}
var plus_menu=t.findParent('div.plus_menu',this.container,true);if(plus_menu){this.display_new_entity_menu(e,plus_menu);return;}
var user_menu=t.findParent('div.user_menu',this.container,true);if(user_menu){this.display_user_menu(e,user_menu);return;}
var top_gear_menu=t.findParent('div.top_gear_menu',this.container,true);if(top_gear_menu){this.display_admin_menu(e,top_gear_menu);return;}
var app_menu=t.findParent('div.app_menu',this.container,true);if(app_menu){this.display_app_menu(e,app_menu);return;}
var gear_menu=t.findParent('div.gear_menu',this.container,true);if(gear_menu){this.display_gear_menu(e,gear_menu);return;}
var nav_item;var project_pages_overlay_button=t.findParent('div.project_pages_overlay_button',this.container,true);if(project_pages_overlay_button){nav_item=project_pages_overlay_button.findParent('div.nav_item',null,true);this.show_pages_overlay(true,nav_item);return;}
var global_pages_overlay_button=t.findParent('div.global_pages_overlay_button',this.container,true);if(global_pages_overlay_button){nav_item=global_pages_overlay_button.findParent('div.nav_item',null,true);this.show_pages_overlay(false,nav_item);return;}
var projects_popover_button=t.findParent('div.projects_popover',this.container,true);if(projects_popover_button){nav_item=projects_popover_button.findParent('div.nav_item',null,true);this.show_projects_popover(nav_item);return;}
var other_menu_button=t.findParent('div.other_menu_button',this.container,true);if(other_menu_button){nav_item=other_menu_button.findParent('div.nav_item',null,true);this.show_other_entity_menu(nav_item);return;}
var other_entity_menu_item=t.findParent('div.other_entity_menu_item',this.container);if(other_entity_menu_item){var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;if(ctrl_click)return;var root_widget=this.get_page_root_widget();root_widget.show_loading_overlay();return;}
var logout=t.findParent('div.nav_item.logout',this.container);if(logout){this.sign_out();return;}},toggle_search_menu:function(button_elem){var nav_item=button_elem.findParent('div.nav_item',null,true);if(nav_item.hasClass('active')){this.hide_search_menu(button_elem);}else{nav_item.addClass('active');setTimeout(function(){SG.globals.quick_jump_component.quick_key_focus();},200);}},hide_search_menu:function(button_elem){if(!button_elem)
button_elem=this.container.child('div.search_menu');var nav_item=button_elem.findParent('div.nav_item',null,true);if(!nav_item.hasClass('active'))return;nav_item.removeClass('active');},show_projects_popover:function(button){if(!this.projects_popover){this.projects_popover=new SG.ProjectsPopover({global_nav:this});}
if(this.projects_popover.is_visible())
this.hide_all_overlays();else{this.hide_all_overlays();this.projects_popover.show(button);}},hide_all_overlays:function(){var overlays=[this.global_page_tree_overlay,this.project_page_tree_overlay,this.projects_popover];for(var i=0;i<overlays.length;i++){var overlay=overlays[i];if(overlay&&overlay.is_visible())
overlay.hide();}},show_pages_overlay:function(for_project,button){if(for_project){if(!this.project_page_tree_overlay){var page_project=this.get_project();this.project_page_tree_overlay=new SG.PageTreeOverlay({page:this.page,project_id:page_project.id,global_nav:this});}
if(this.project_page_tree_overlay.is_visible())
this.project_page_tree_overlay.hide();else
this.project_page_tree_overlay.show(button);}else{if(!this.global_page_tree_overlay){this.global_page_tree_overlay=new SG.PageTreeOverlay({page:this.page,global_nav:this});}
if(this.global_page_tree_overlay.is_visible())
this.global_page_tree_overlay.hide();else
this.global_page_tree_overlay.show(button);}},on_contextmenu:function(e){var t=Ext.get(e.getTarget());var popover=t.findParent('div.popover',this.container);if(popover)
return;var project_nav=t.findParent('div.project_nav',this.container);if(project_nav){e.stopEvent();this.display_gear_menu(e,e.getTarget(),true);}},select_project_nav_button:function(button){var previous_button=sg_find('span.project_nav_button.selected',this.container.dom);previous_button=Ext.get(previous_button);previous_button.removeClass('selected');button.addClass('selected');},display_new_entity_menu:function(e,menu_elem){if(!menu_elem)
menu_elem=this.container.child('div.plus_menu');this.new_entity_menu_div=menu_elem;if(e&&e.type=='contextmenu')e.stopEvent();if(!this.new_entity_menu)
this.new_entity_menu=this.create_new_entity_menu();if(this.new_entity_menu.is_showing()){this.new_entity_menu.hide();}else{this.new_entity_menu.position={dom_elem:this.new_entity_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.new_entity_menu.show();}},create_new_entity_menu:function(){var menu=new SG.Menu({icon_width:18,before_show:{fn:this.on_before_show_new_entity_menu,scope:this},after_hide:{fn:this.on_hide_new_entity_menu,scope:this},item_selected:{fn:this.on_new_entity_menu_click,scope:this}});var entity_types=SG.schema.leftnav_page_entity_types;var hide_entities=SG.globals.preferences.hide_from_new_entity_menu;hide_entities.push("DisplayColumn","Status","Booking");var admin_entities=['HumanUser','Group','Project','TaskTemplate','ApiUser'];var normal_items=[];var admin_items=[];for(var i=0;i<entity_types.length;i++){var entity_type=entity_types[i];if(!SG.schema.can_create_entity(entity_type)||hide_entities.indexOf(entity_type)!=-1)
continue;var display_name=SG.schema.entity_types[entity_type].display_name;var items=(admin_entities.indexOf(entity_type)>-1)?admin_items:normal_items;items.push({icon_name:SG.schema.entity_icon_name(entity_type),html:display_name,value:entity_type});}
if(admin_items.length>0)
normal_items.push({heading:'ADMIN'});menu.items=normal_items.concat(admin_items);menu.items.unshift({html:'Import',submenu:{items:this.create_import_menu_items()},},{line:true});menu.render();return menu;},on_before_show_new_entity_menu:function(menu){var nav_item=this.new_entity_menu_div.findParent('div.nav_item',null,true);nav_item.addClass('active');var focus_entity_type;if(this.focus_entity_type)
focus_entity_type=this.focus_entity_type;else
focus_entity_type=this.entity_type;var menu_item;for(var i=0;i<menu.items.length;i++){menu_item=menu.items[i];if(menu_item.value==focus_entity_type){menu_item.default_item=true;break;}}
menu.render();},on_hide_new_entity_menu:function(menu){var nav_item=this.new_entity_menu_div.findParent('div.nav_item',null,true);nav_item.removeClass('active');this.focus_entity_type=null;this.new_entity_data_store=null;},on_new_entity_menu_click:function(menu,item){var entity_type=item.value;var callback;var data_record;var root_widget=this.get_page_root_widget();var is_eqp=root_widget.get("type")=="SG.Widget.EntityQuery.EntityQueryPage";var is_pane_showing=root_widget.pane_container_showing;var is_same_et=is_eqp&&root_widget.get_content_widget_entity_type()==entity_type;if(this.focus_entity_type==entity_type){callback=this.new_entity_callback;data_record=this.new_entity_record;var nef_config={entity_type:entity_type,single_project:root_widget.single_project_from_context(),all_projects:root_widget.context_projects(),source_record:data_record};var nef=sg_new_entity_dialog(nef_config);if(callback)
nef.on('entity_created',callback,this.new_entity_callback_scope);}else if(this.entity_type==entity_type&&is_eqp&&!is_pane_showing&&is_same_et){root_widget.create_new_entity();}else{callback=this.on_new_entity_created;this.new_entity_callback_scope=this;if(this.entity_type==entity_type&&root_widget.get('type')=='SG.Widget.EntityQuery.EntityQueryPage'){var content_widget=root_widget.get_content_widget();callback=content_widget.reload_all_entities;this.new_entity_callback_scope=content_widget;}
var factory_context={entity_type:entity_type,data_record:new SG.Data.Record(entity_type)};var factory=new SG.EntityFactory(factory_context);factory.on("done",function(record){var nef_config={entity_type:entity_type,single_project:root_widget.single_project_from_context(),all_projects:root_widget.context_projects(),source_record:record,allow_keep_form_open:true};var nef=sg_new_entity_dialog(nef_config);if(callback)
nef.on('entity_created',callback,this.new_entity_callback_scope);},this);factory.create();}},on_new_entity_created:function(new_entities){var new_entity;if(new_entities&&new_entities.length>0)
new_entity=new_entities[0];else
return;if(new_entity.type!='Page')
return;var root_widget=this.get_page_root_widget();setTimeout(function(){setCookie("design_page_on_load",new_entity.id,365);if(root_widget.show_loading_overlay)
root_widget.show_loading_overlay();var current_url=window.location;var new_url=current_url.protocol+'//'+current_url.host+'/page/'+new_entity.id;window.location=new_url;},0);},display_gear_menu:function(e,menu_div,position_at_cursor){if(!this.gear_menu){this.gear_menu=new SG.Menu({before_show:{fn:this.on_before_show_menu,scope:this},after_hide:{fn:this.on_hide_menu,scope:this},items:[{html:'Configure',icon_name:'icon_edit',value:'configure_project_nav'},{html:'Revert Project Configuration...',icon_name:'icon_revert',value:'revert_project_pages'},{html:'Push Project Configuration...',icon_name:'icon_sent',value:'push_project_pages'},],item_selected:{fn:this.on_gear_menu_item,scope:this}});this.gear_menu.render();}
if(this.gear_menu.is_showing()){this.gear_menu.hide();}else{if(position_at_cursor){this.gear_menu.position={xy:e.getXY()}}else{this.gear_menu.position={dom_elem:menu_div,elem_anchor:'br',menu_anchor:'tr'};}
this.gear_menu.show();}},on_gear_menu_item:function(menu,menu_item){if(menu_item.value=='configure_project_nav')
this.configure_project_nav();else if(menu_item.value=='revert_project_pages')
this.push_project_pages(true);else
this.push_project_pages(false);},push_project_pages:function(revert){var source_project_id=null;var target_project_ids=null;var project=this.get_project();if(revert)
target_project_ids=[project.id];else
source_project_id=project.id;var dialog=new SG.PushProjectPagesDialog({source_project_id:source_project_id,target_project_ids:target_project_ids,jump_to_project_landing_page_when_done:revert});},display_admin_menu:function(e,menu_div){this.help_menu_div=menu_div;if(e.type=='contextmenu')e.stopEvent();if(!this.admin_menu)
this.admin_menu=this.create_admin_menu();if(this.admin_menu.is_showing()){this.admin_menu.hide();}else{this.admin_menu.position={dom_elem:this.help_menu_div.dom,elem_anchor:'bl',menu_anchor:'tl'};this.admin_menu.show();}},create_admin_menu:function(){var i;var menu=new SG.Menu({before_show:{fn:this.on_before_show_menu,scope:this},after_hide:{fn:this.on_hide_menu,scope:this},item_selected:{fn:this.on_admin_menu_item,scope:this}});var template_project_id=-1;for(i=0;i<SG.schema.projects.length;i++){var project=SG.schema.projects[i];if(project.name=="Template Project")
template_project_id=project.id;}
var pages={root:[]};for(i=0;i<SG.schema.admin_pages.length;i++){var page=SG.schema.admin_pages[i];if(page.project_id==template_project_id){if(page.folder)
page.folder="Template Project->"+page.folder;else
page.folder="Template Project";}
if(page.folder){var parts=page.folder.split("->");var hash=pages;for(var j=0;j<parts.length;j++){var part=parts[j];if(!hash[part])
hash[part]=[];hash=hash[part];}
hash.push(page);}else{pages.root.push(page);}}
var items=[];items.push({heading:'HELP'});items.push({html:'Email us...',item_selected:{fn:this.email_shotgun,scope:this}});items.push({html:'Visit our Help Site...',item_selected:{fn:this.go_to_support,scope:this}});items.push({html:'<i>'+this.shotgun_version+'</i>',disabled:true})
if(SG.globals.current_user.admin){items.push({heading:'ADMIN'});var menu_items;for(var key in pages){if(pages.hasOwnProperty(key)){var key_items=pages[key];if(key=='root'){menu_items=this.create_admin_page_menu_items(key_items);items=items.concat(menu_items);}else{menu_items=this.create_admin_page_menu_items(key_items);items.push({html:key,submenu:{items:menu_items}});}}}}
menu.items=items;menu.render();return menu;},display_app_menu:function(e,menu_div){if(this.app_menu&&this.app_menu.is_showing()){this.app_menu.hide();return;}
if(e.type=='contextmenu')e.stopEvent();if(!this.app_menu){this.app_menu=new SG.Menu({before_show:{fn:this.on_before_show_menu,scope:this},after_hide:{fn:this.on_hide_menu,scope:this},});}
this.app_menu.items=[];this.app_menu.items.push({html:'Crew Planning<span class="beta">BETA</span>',href:'/page/crew_planning_app',href_target:'target="_blank"',icon_name:'app_crew_planning_small',disabled:!(SG.globals.preferences.crew_planning_app_active&&SG.allow("see_full_crew_app_menu_item",{}))});this.app_menu.items.push({html:'Review Notes',href:'/page/notes_app',href_target:'target="_blank"',icon_name:'app_review_notes_small',});this.app_menu.items.push({html:'Revolver',href:'/page/review_app_webview',href_target:'target="_blank"',icon_name:'app_revolver_small',disabled:!(SG.globals.preferences.enable_revolver)});if(SG.globals.current_user.admin){this.app_menu.items.push({line:true});this.app_menu.items.push({html:'Manage Apps',href:'/page/manage_apps',href_target:'target="_blank"',icon_name:'icon_gear',});}
this.app_menu.position={dom_elem:menu_div.dom,elem_anchor:'bl',menu_anchor:'tl'};this.app_menu.render();this.app_menu.show();},on_admin_menu_item:function(menu,menu_item){this.open(menu_item.url);},create_admin_page_menu_items:function(pages){var page,icon_name,items=[];for(var i in pages){if(pages.hasOwnProperty(i)){page=pages[i];if(page.page_type){items.push({html:page.display_name,icon_name:this.get_admin_page_icon(page),url:'/page/'+page.id});}else{items.push({html:i,submenu:{items:this.create_admin_page_menu_items(page)}});}}}
return items;},get_admin_page_icon:function(page){var icon_class=page.entity_type?SG.schema.entity_icon_name(page.entity_type):'';switch(page.page_type){case'dashboard':icon_class='icon_Dashboard';break;case'url':icon_class='icon_url';break;case'site_prefs':icon_class='icon_preferences';break;case'home':icon_class='icon_Home';break;case'permissions':icon_class='icon_lock';break;case'canvas':if(page.default_type&&page.default_type=='new_entity')
icon_class='filetype_icon_misc';else
icon_class='icon_Dashboard';break;case'work_schedule':icon_class='icon_WorkSchedule';break;}
return icon_class;},email_shotgun:function(){window.location.href=SG.globals.feedback_url_template.replace(/XXXURLHASHXXX/,sg_get_url_hash_part());},go_to_support:function(){window.open('https://support.shotgunsoftware.com','_blank');},display_user_menu:function(e,menu_div){this.user_menu_div=menu_div;if(e.type=='contextmenu')e.stopEvent();if(!this.user_menu)
this.user_menu=this.create_user_menu();if(this.user_menu.is_showing()){this.user_menu.hide();}else{this.user_menu.position={dom_elem:this.user_menu_div.dom,elem_anchor:'bl',menu_anchor:'tl'};this.user_menu.show();}},create_user_menu:function(){var menu=new SG.Menu({before_show:{fn:this.on_before_show_menu,scope:this},after_hide:{fn:this.on_hide_menu,scope:this}});var items=[];items.push({html:'Account Settings',item_selected:{fn:this.show_account_settings,scope:this}});items.push({line:true});items.push({html:'Sign Out',item_selected:{fn:this.sign_out,scope:this}});menu.items=items;menu.render();return menu;},show_account_settings:function(){var usd=new SG.UserSettingsDialog();},sign_out:function(){this.open('/user/logout','Logout');},on_before_show_menu:function(menu){var elem=Ext.get(menu.position.dom_elem);if(!elem)return;var nav_item=elem.findParent('div.nav_item',null,true);nav_item.addClass('active');},on_hide_menu:function(menu){var elem=Ext.get(menu.position.dom_elem);if(!elem)return;var nav_item=elem.findParent('div.nav_item',null,true);nav_item.removeClass('active');},on_import_menuitem_click:function(menu,menu_item){var config={entity_type:menu_item.value};var root_widget=this.get_page_root_widget();var single_project=root_widget.single_project_from_context();if(single_project)
config.single_project=single_project;config.column_display_names={};var importer=new SG.Importer(config);},create_import_menu_items:function(){var entity_types=SG.schema.leftnav_page_entity_types;var items=[];for(var i=0;i<entity_types.length;i++){var entity_type=entity_types[i];if(SG.schema.non_importable_entity_types.indexOf(entity_type)!=-1||!SG.schema.can_create_entity(entity_type))
continue;var display_name=SG.schema.entity_types[entity_type].display_name_pluralized;items.push({icon_name:'icon_'+entity_type,html:display_name,value:entity_type,item_selected:{fn:this.on_import_menuitem_click,scope:this}});}
return items;},setup_page_level_keyboard_shortcuts:function(){this.keyboard_shortcut_callbacks={};this.add_keyboard_shortcut(110,{fn:this.display_new_entity_menu,scope:this});this.add_keyboard_shortcut(115,{fn:this.focus_quick_jump,scope:this});this.add_keyboard_shortcut(113,{fn:this.focus_quick_jump,scope:this});this.add_keyboard_shortcut(102,{fn:this.f_key_pressed,scope:this});this.add_keyboard_shortcut(27,{fn:this.hide_search_menu,scope:this});var doc_elem=Ext.get(document);doc_elem.on('keypress',this.on_keypress,this);},has_active_modal_element:function(){if(sg_find('div.sg_dialog_mask',document.body)){return true;}else if(sg_find('div.sgc_review_app_overlay_mask',document.body)){return true;}else if(sg_find('div.progress_indicator_overlay_container[style~="visible;"]',document.body)){return true;}else if(sg_find('div.sgc_canvas_designer',document.body)){return true;}
return false;},add_keyboard_shortcut:function(key_code,callback){if(!(key_code in this.keyboard_shortcut_callbacks))
this.keyboard_shortcut_callbacks[key_code]=callback;},on_keypress:function(e){if(this.page.canvas_designer_page||!this.container.isVisible())
return;var dom_event=e.browserEvent;if(dom_event.ctrlKey||dom_event.altKey||dom_event.metaKey)
return;var key=e.getKey();if(!(key in this.keyboard_shortcut_callbacks))
return;if(this.__ignore(e))
return;if(this.has_active_modal_element()){return;}
e.stopEvent();e.shortcut_handled=true
var callback=this.keyboard_shortcut_callbacks[key];callback.fn.call(callback.scope);},__ignore:function(e){var t=Ext.get(e.getTarget());var entity_editor=t.findParent('div.entity_editor',2);if(entity_editor)
return true;var input=t.findParent('input',2);if(input)
return true;var textarea=t.findParent('textarea',2);if(textarea)
return true;var shotgun_thing=t.findParent('.sg_focusable',8);if(shotgun_thing)
return true;return false;},focus_quick_jump:function(){if(!SG.globals.quick_jump_component||SG.globals.no_top_bar)return;var me=this;window.setTimeout(function(){var search_menu_elem=me.container.child('div.search_menu');var nav_item=search_menu_elem.findParent('div.nav_item',null,true);if(!nav_item.hasClass('active'))
nav_item.addClass('active');setTimeout(function(){SG.globals.quick_jump_component.quick_key_focus();},200);},1);},f_key_pressed:function(){SG.NotificationCenter.post({uuid:'_global_nav_',name:'f_key_pressed',args:null,canvas_id:null});},on_entity_field_pref_change:function(changes){var change;var rec_id=this.entity_field_pref.get_id();for(var i=0;i<changes.length;i++){change=changes[i];if(change.type=="update"&&change.state=="pending"&&change.record.get_id()==rec_id){this.project_pages=change.record.get("settings_serialized");this.update_project_nav();return;}}},update_project_nav:function(){var pn=Ext.get(sg_find("div.project_nav",this.container.dom));Ext.DomHelper.insertAfter(pn.dom,this.render_project_nav());pn.remove();},configure_project_nav:function(){var c=new SG.ConfigureProjectNav({record:this.entity_field_pref,project:this.get_project()});},on_other_entity_menu_item:function(menu,menu_item){},show_other_entity_menu:function(other_menu_button){if(!this.other_entity_menu){this.other_entity_menu=new SG.Menu({render_container:this.container,before_show:{fn:this.on_before_show_menu,scope:this},after_hide:{fn:this.on_hide_menu,scope:this},icon_width:20});}
var project=this.get_project();var entity_bricks=this.project_pages;var items=this.get_other_entity_menu_items(entity_bricks,project.id);for(var i=0;i<items.length;i++)
items[i].item_class='other_entity_menu_item';this.other_entity_menu.items=items;this.other_entity_menu.render();this.other_entity_menu.position={dom_elem:other_menu_button,elem_anchor:'bl',menu_anchor:'tl'};this.other_entity_menu.show();},get_other_entity_menu_items:function(entity_bricks,project_id){var i;var nav_entities=[];for(i=0;i<entity_bricks.length;i++){nav_entities.push(entity_bricks[i]['entity_type']);}
var also_exclude=['Page','DisplayColumn','ApiUser','Status','TaskTemplate','Group'];nav_entities=nav_entities.concat(also_exclude);var menu_entities=[];for(i=0;i<SG.schema.leftnav_page_entity_types.length;i++){var entity_type=SG.schema.leftnav_page_entity_types[i];if(nav_entities.indexOf(entity_type)==-1&&SG.schema.can_see_entity_type(entity_type)){var edn=SG.schema.entity_types[entity_type]['display_name_pluralized'];menu_entities.push({entity_type:entity_type,display_name:edn});}}
menu_entities.sort(function(a,b){return a.display_name.localeCompare(b.display_name);});var items=[];for(i=0;i<menu_entities.length;i++){var menu_entity=menu_entities[i];items.push({html:menu_entity.display_name,icon_name:'icon_'+menu_entity.entity_type,href:this.templates.landing_page_href.apply({entity_type:menu_entity.entity_type,project_id:project_id})});}
return items;},get_sorted_project_records:function(filter_mode,filter_value){var i;var sort_by_name=true;var recs=[];var data_set=SG.globals.global_projects_last_accessed_by_current_user;if(filter_mode=='recent'){var max=data_set.count()>10?10:data_set.count();for(i=0;i<max;i++)
recs.push(data_set.get_record(i));sort_by_name=false;}else if(filter_mode=='all'){for(i=0;i<data_set.count();i++)
recs.push(data_set.get_record(i));}else if(filter_mode=='favorite'){for(i=0;i<data_set.count();i++){var rec=data_set.get_record(i);if(rec.get('current_user_favorite'))
recs.push(rec);}}else{for(i=0;i<data_set.count();i++){var rec=data_set.get_record(i);if(rec.get('sg_status')==filter_value)
recs.push(rec);}}
if(sort_by_name){recs.sort(function(a,b){a_name=a.get('name');b_name=b.get('name');return a_name.localeCompare(b.name);});}
return recs;},get_project_filter_menu_items:function(filter_mode,filter_value){var items=[]
items.push({html:'All Projects',value:'all',checked:filter_mode=='all'});items.push({html:'Favorite Projects',value:'favorite',checked:filter_mode=='favorite'});items.push({html:'Recent Projects',value:'recent',checked:filter_mode=='recent'});items.push({heading:'STATUS'});var schema_field=SG.schema.get_field('Project','sg_status');var values=schema_field.values;for(var i=0;i<values.length;i++){var checked=filter_mode=='sg_status'&&filter_value==values[i];items.push({html:values[i],value:'sg_status',status_value:values[i],checked:checked});}
items.push({html:'No Status',value:'sg_status',status_value:null,checked:filter_mode=='sg_status'&&!filter_value});return items;},get_project_filter_display_name:function(filter_mode,filter_value){if(filter_mode=='all')
return'All Projects';else if(filter_mode=='favorite')
return'Favorite Projects';else if(filter_mode=='recent')
return'Recent Projects';else{if(!filter_value)
return'No Status Projects';else{var filter_value_name=filter_value.substr(0,1).toUpperCase()+filter_value.substr(1);return filter_value_name+' Projects';}}},user_has_no_projects:function(){var data_set=SG.globals.global_projects_last_accessed_by_current_user;return(data_set.count()==0);},});SG.util.LoginBanner=function(config){Ext.apply(this,config);SG.util.LoginBanner.superclass.constructor.call(this,config);};Ext.extend(SG.util.LoginBanner,SG.Component,{templates:{main:'<div class="message">{message}</div><div class="close_button_large_brown"></div>',welcome_to_3_0:'<div class="welcome_to_3_0"><span class="welcome">Welcome to 3.0!</span>'+'You can find your pages down there <div class="icon_arrow_down"></div> in the Pages section. Watch a '+'<a href="https://support.shotgunsoftware.com/entries/20468333" target="_blank">'+'quick video tour</a> of the other new features, or check the help menu for more info.</div>',welcome_to_3_1_beta:'<div class="welcome_to_3_1_beta">Shotgun 3.1 is coming next week with enhanced navigation! '+'<a href="https://support.shotgunsoftware.com/entries/20732527-shotgun-version-3-1-release-notes" '+'target="_blank">Check out a preview</a></div>',welcome_to_3_1:'<div class="welcome_to_3_1">Welcome to Shotgun 3.1'+'<a href="https://support.shotgunsoftware.com/entries/20749103" '+'target="_blank">Check out the enhanced navigation features</a></div>',welcome_to_3_2:'<div class="welcome_to_3_1">Welcome to Shotgun 3.2!'+'<a href="https://support.shotgunsoftware.com/entries/20905776" '+'target="_blank">Check out the new features</a></div>',welcome_to_3_3:'<div class="welcome_to_3_1">Welcome to Shotgun 3.3!'+'<a href="https://support.shotgunsoftware.com/entries/21205333" '+'target="_blank">Check out the new features</a></div>',welcome_to_4_0:'<div class="welcome_to_3_1">Welcome to Shotgun 4.0!'+'<a href="https://support.shotgunsoftware.com/entries/21776588" '+'target="_blank">Check out the new apps and other exciting features</a></div>',},init_component:function(){},render:function(){if(!this.__rendered__){this.__rendered__=true;this.on_first_render();}
this.render_component();},on_first_render:function(){this.container=Ext.get(this.container_id);this.add_event(this.container,'click',this.on_click);this.current_user_data_set=this.new_data_set('HumanUser',this.on_load_current_user);this.banner_data_set=this.new_data_set('Banner',this.on_load_banner);this.fetch_banners_for_current_user();},on_click:function(e){var t=Ext.get(e.getTarget());var close_overlay=t.findParent('div.close_button_large_brown',this.container);if(close_overlay){this.current_user.set('banners',[]);this.current_user.commit(true);this.container.update('');this.make_unactive();}},render_component:function(){if(!this.banner)return;var message=this.banner.get('html');if(message===null||message==''){var code=this.banner.get('code');if(this.templates[code])
message=this.templates[code].apply();else
message='';}
this.container.update(this.templates.main.apply({message:message}));},make_active:function(){var parent_container=Ext.get(this.container.dom.parentNode);if(!parent_container.hasClass('login_banner'))
parent_container.addClass('login_banner')
if(!this.container.hasClass('active'))
this.container.addClass('active');},make_unactive:function(){var parent_container=Ext.get(this.container.dom.parentNode);parent_container.removeClass('login_banner');this.container.removeClass('active');},fetch_banners_for_current_user:function(){var spec={type:'HumanUser',id:SG.globals.current_user.id,columns:['banners'],result:this.current_user_data_set};SG.Repo.find(spec);},on_load_current_user:function(){this.current_user=this.current_user_data_set.get_record(0);var banners=this.current_user.get('banners');if(banners&&banners.length>0)
this.fetch_latest_banner(banners);},fetch_latest_banner:function(banners){var ids=[];for(var i=0;i<banners.length;i++){ids.push(banners[i].id);}
var spec={type:'Banner',filters:{logical_operator:"and",conditions:[{active:true,path:'id',relation:'in',values:ids}]},columns:['id','code','html'],sorts:[{column:'created_at',direction:'desc'}],current_page:1,records_per_page:1,result:this.banner_data_set};SG.Repo.query(spec);},on_load_banner:function(){this.banner=this.banner_data_set.get_record(0);this.make_active();this.render_component();},});SG.in_unload=false;Ext.lib.Event.on(window,'beforeunload',function(){SG.in_unload=true;});function debugPopupHtmlMessage(message_to_display,is_text_only){var consoleRef=window.open('','_blank','width=350,height=250'+',menubar=0'+',toolbar=0'+',status=no'+',scrollbars=1'+',resizable=1');var html_page_content;if(is_text_only)
html_page_content='<html><body><pre>'+message_to_display+'</pre></body></html>';else
html_page_content=message_to_display;if(consoleRef){consoleRef.document.writeln(html_page_content);consoleRef.document.close();}
return consoleRef;}
SG.ServerErrorHandler=function(){};SG.ServerErrorHandler.prototype={notify_user:function(response){var html_text,sed;if(response&&response.responseText){var bits=response.responseText.split('body>');var text=bits[0];if(bits.length>1)
text=bits[1];var idx=text.lastIndexOf('</');html_text=text;if(idx>0)
html_text=text.substring(0,idx);sed=SG.server_error({html_msg:html_text,connection_response:response});}else{var statText='';if(response)
statText=response.statusText.toUpperCase();else
statText='<i>RESPONSE UNDEFINED</i>';sed=SG.server_error({html_msg:statText,connection_response:response});}}};SG.ResponseHandler=function(){};Ext.extend(SG.ResponseHandler,Ext.util.Observable,{handle_response:function(response,request){if(!this.successful_responses){this.successful_responses=[];this.unsuccessful_responses=[];}
if(response.status=="successful")
this.successful_responses.push(response);else
this.unsuccessful_responses.push(response);}});SG.CrudRequest=function(requests,handlers,force_bkgd_crud,batch_transaction){this.is_crud_request=true;this.force_bkgd_crud=force_bkgd_crud||false;this.batch_transaction=batch_transaction||false;this.url='/crud/requests';if(requests&&typeof requests=="object"&&requests.constructor==Array)
this.requests=requests;else
this.requests=[requests];if(handlers&&typeof handlers=="object"&&handlers.constructor==Array){this.handlers=handlers;this.single_handler=false;}else{this.handler=handlers;this.single_handler=true;}
this.events={'started':true,'completed':true,'failure':true};};Ext.extend(SG.CrudRequest,Ext.util.Observable,{send:function(){if(!this.single_handler&&this.requests.length!=this.handlers.length){return false;}
var req_json=JSON.stringify(this.requests);var options={url:this.url,params:{requests:req_json},callback:this.process_responses,scope:this};Ext.Ajax.request(options);return true;},process_responses:function(options,success,server_response){if(success===null){return;}
if(!success){this.fireEvent('failure');new SG.ServerErrorHandler().notify_user(server_response);return;}
var responses=JSON.parse(server_response.responseText);this.handle_responses(responses);},handle_responses:function(responses){var response,handler;this.fireEvent('started',responses);for(var i=0;i<responses.length;i++){handler=this.single_handler?this.handler:this.handlers[i];response=responses[i];if(response&&handler&&handler.handle_response){handler.handle_response.call(handler,response,this.requests[i]);}}
this.fireEvent('completed',responses);}});SG.CrudManager=function(){this.events={};this.init();};Ext.extend(SG.CrudManager,Ext.util.Observable,{init:function(){this.debug=false;this.pi=null;this.created_jobs={};this.created_jobs_polling_interval=1000;this.poll_created_jobs.defer(this.created_jobs_polling_interval,this);Ext.Ajax.on('beforerequest',this.on_request,this);this.dt=new Ext.util.DelayedTask();this.start_delay();},start_delay:function(){this.requests=[];this.dt.delay(200,this.on_fire,this);},send_now:function(){this.dt.cancel();this.on_fire();},on_request:function(ajax,req){if(req.scope&&req.scope.is_crud_request===true){this.requests.push(req.scope);return false;}else{return true;}},on_fire:function(){var i,c,req;var combined=[];var keep_requests=this.requests;if(keep_requests.length>0){var bkgd_req=false;var batch_transaction=false;var local_timezone_offset=-(new Date().getTimezoneOffset()/60);for(i=0;i<keep_requests.length;i++){if(keep_requests[i].force_bkgd_crud===true){bkgd_req=true;}
if(keep_requests[i].batch_transaction===true){batch_transaction=true;}
req=keep_requests[i].requests;for(var j=0;j<req.length;j++)
req[j].local_timezone_offset=local_timezone_offset;combined=combined.concat(req);}
if(bkgd_req===false){var entity_schema=SG.schema.entity_fields;var fields_schema;outerloop:for(i=0;i<combined.length;++i){req=combined[i];fields_schema=entity_schema[req.type];if(fields_schema){switch(req.request_type){case'create':for(c in fields_schema){if(fields_schema.hasOwnProperty(c)){if(fields_schema[c].bkgd_crud){bkgd_req=true;break outerloop;}}}
if(req.type=='WorkDayRule')
bkgd_req=true;break;case'update':var schema_field=SG.schema.get_field(req.type,req.column);if(schema_field&&schema_field.bkgd_crud){bkgd_req=true;break outerloop;}
break;case'delete':for(c in fields_schema){if(fields_schema.hasOwnProperty(c)){if(fields_schema[c].bkgd_crud){bkgd_req=true;break outerloop;}}}
if(req.type=='WorkDayRule')
bkgd_req=true;break;}}}}
var req_json,conn,idx,options,incr=200;if(!bkgd_req&&!batch_transaction&&combined.length==keep_requests.length){for(idx=0;idx<combined.length;idx+=incr){req_json=JSON.stringify(combined.slice(idx,idx+incr));options={url:'/crud/requests',params:{requests:req_json,bkgd:bkgd_req,batch_transaction:batch_transaction,session_uuid:SG.globals.session_uuid,debug:this.debug},callback:this.on_response,crud_requests:keep_requests.slice(idx,idx+incr),scope:this};conn=new Ext.data.Connection();conn.request(options);}}else{req_json=JSON.stringify(combined);options={url:'/crud/requests',params:{requests:req_json,bkgd:bkgd_req,batch_transaction:batch_transaction,session_uuid:SG.globals.session_uuid,debug:this.debug},callback:this.on_response,crud_requests:keep_requests,scope:this};if(bkgd_req){if(!this.pi)
this.pi=new SG.ProgressIndicator(null,'det','Updating...');options.callback=this.pi.start_updates;options.scope=this.pi;this.pi.on_job_complete={fn:this.on_response,scope:this,mimic_ext_callback:true};this.pi.show();}
conn=new Ext.data.Connection();conn.request(options);}}
this.start_delay();},on_response:function(options,success,server_response){var i,j;var requests=options.crud_requests;var manufacture_error_responses=false
if(server_response&&server_response.getResponseHeader&&server_response.getResponseHeader["SG_FAILED_AUTH"]){window.location.reload(true);return;}
if(!success){if(SG.in_unload)return;new SG.ServerErrorHandler().notify_user(server_response);for(i=0;i<requests.length;i++){requests[i].fireEvent('failure');}
manufacture_error_responses=true;}
var responses;if(!manufacture_error_responses){try{responses=eval(server_response.responseText);}catch(err){manufacture_error_responses=true;}}
if(manufacture_error_responses){responses=[]
var idx=0;var request,req_count,response;for(i=0;i<requests.length;i++){request=requests[i];for(var j=0;j<request.requests.length;j++){response=sg_deep_copy(request.requests[j]);response.status='failed';response.reason_description="Unknown server error";responses.push(response);}}}
var idx=0;var request,req_count,to_handle;SG.Repo.fireEvent('capture_events','start');for(i=0;i<requests.length;i++){request=requests[i];req_count=request.requests.length;to_handle=[];for(j=idx;j<idx+req_count;j++){to_handle.push(responses[j]);}
request.handle_responses(to_handle);idx=idx+req_count;}
SG.Repo.fireEvent('capture_events','stop');this.add_created_jobs(responses);},add_created_jobs:function(responses){var resp,job_ids,widget_id;for(var i=0;i<responses.length;++i){resp=responses[i];if(resp.status==='successful'&&resp.created_job_ids){job_ids=resp.created_job_ids;this.created_jobs=this.created_jobs||{};for(var j=0;j<job_ids.length;++j){this.created_jobs[job_ids[j]]=this.created_jobs[job_ids[j]]||null;}}}},poll_created_jobs:function(){var all_jobs=[];for(var job_id in this.created_jobs){if(this.created_jobs.hasOwnProperty(job_id)){all_jobs.push({job_id:job_id,job_type:'background_job'});}}
if(all_jobs.length>0){var options={url:SG.globals.urls.progress_indicator_update,params:{jobs:JSON.stringify(all_jobs)},callback:this.update_created_jobs,scope:this};var conn=new Ext.data.Connection();conn.request(options);}else{this.poll_created_jobs.defer(this.created_jobs_polling_interval,this);}},update_created_jobs:function(options,success,response){if(success){var statuses=JSON.parse(response.responseText);for(var i=0;i<statuses.length;++i){if(this.created_jobs.hasOwnProperty(statuses[i].job_id)){this.created_jobs[statuses[i].job_id]=statuses[i].completion;}}
this.update_repository();}else{new SG.ServerErrorHandler().notify_user(response);}
this.poll_created_jobs.defer(this.created_jobs_polling_interval,this);},update_repository:function(){var completed_job_ids=[];var completed=true;for(var job_id in this.created_jobs)if(this.created_jobs.hasOwnProperty(job_id)){if(this.created_jobs[job_id]!==100){completed=false;break;}
if(completed){SG.Repo.request_news();completed_job_ids.push(job_id);}}
for(var i=0;i<completed_job_ids.length;++i){delete this.created_jobs[completed_job_ids[i]];}}});SG.CrudManagerInstance=new SG.CrudManager();SG.ReadResponseHandler={};SG.UpdateResponseHandler={};SG.DeleteResponseHandler={};SG.SummarizeResponseHandler={};SG.CreateResponseHandler={};SG.ValidateResponseHandler={};SG.ReviveResponseHandler={};SG.MarkupParser=function(){this.init();};Ext.extend(SG.MarkupParser,Ext.util.Observable,{init:function(){this.setup_phrase_mods();},setup_phrase_mods:function(){var phrase_mod_defs=[['_','em'],['\\*','strong'],['@','code']];this.phrase_mods=[];for(var pm=0;pm<phrase_mod_defs.length;++pm){var phrase_mod_def=phrase_mod_defs[pm];this.phrase_mods.push([new RegExp('(\\s|^)'+phrase_mod_def[0]+'(\\S(.|\\n)*?)'+phrase_mod_def[0]+'(?=(\\W|$))','g'),'$1<'+phrase_mod_def[1]+'>$2</'+phrase_mod_def[1]+'>']);}},parse_block:function(block,do_markup){if(do_markup){block=block.replace(/(\s|^)"((.|\n)+?)":(\S+)/g,'$1<a href="$4" target="_blank">$2</a>');block=block.replace(/(\s|^)([A-Za-z]+:\/\/(\S+))/g,'$1<a href="$2" target="_blank">$2</a>');block=block.replace(/(\s|^)\(([A-Za-z]+:\/\/(\S+))\)/g,'$1(<a href="$2" target="_blank">$2</a>)');block=block.replace(/(\s|^)\[([A-Za-z]+:\/\/(\S+))\]/g,'$1[<a href="$2" target="_blank">$2</a>]');block=block.replace(/(\s|^)((mailto:)*(\S+@[A-Za-z0-9\-\.]+\.[A-Za-z0-9\-]+))/g,'$1<a href="mailto:$4">$2</a>');block=block.replace(/(\s|^)!(.+?)(\(((.|\n)+?)\))*!:([A-Za-z]+:\/\/(\S+))(?=(\s|$))/g,'$1<a href="$6"><img src="$2" title="$4" alt="$4" /></a>');block=block.replace(/(\s|^)!(.+?)(\(((.|\n)+?)\))*!(?=(\s|$))/g,'$1<img src="$2" title="$4" alt="$4" />');for(var pm=0;pm<this.phrase_mods.length;++pm){block=block.replace(this.phrase_mods[pm][0],this.phrase_mods[pm][1]);}}
block=block.replace(/  /g,'&nbsp;&nbsp;');return block.replace(/\n/g,'<br />');},parse_extended_block:function(blocks,b,extended_block_symbol,current_block){var extended_block;if(extended_block_symbol==='.'&&b+1!==blocks.length){for(var eb_end=b+1;eb_end<blocks.length;++eb_end){if(blocks[eb_end].search(/^\n*(h[1-6]|bq|bc|pre|notextile)\.\.?\s/)!==-1){extended_block=[current_block].concat(blocks.slice(b+1,eb_end)).join('\n\n');blocks.splice(b+1,eb_end-(b+1));break;}else if(eb_end===blocks.length-1){extended_block=[current_block].concat(blocks.slice(b+1)).join('\n\n');blocks.splice(b+1);break;}}}else{extended_block=current_block;}
return extended_block;},parse:function(str){if(typeof str!=='string'){return'';}
var escape_XHTML={'"':'&quot;','\'':'&#39;','&':'&amp;','<':'&lt;','>':'&gt;'};var sanitized_xhtml=str.replace(/['&<>]/g,function(ch){return escape_XHTML[ch];});var added_block,extended_block,inter_block=null,blocks=sanitized_xhtml.split('\n\n');var parser=this;for(var b=0;b<blocks.length;++b){added_block=false;if(inter_block){blocks[b-1]=inter_block[0].replace(/\n/g,'<br />')+blocks[b-1];}
if(inter_block=blocks[b].match(/^\n+/)){blocks[b]=blocks[b].replace(/^\n+/,'');}
blocks[b]=blocks[b].replace(/^h([1-6])\.(\.)?\s((.|\n)+)/,function(){added_block=true;extended_block=parser.parse_extended_block(blocks,b,arguments[2],arguments[3]);return'<h'+arguments[1]+'>'+parser.parse_block(extended_block,true)+'</h'+arguments[1]+'>';});if(added_block)continue;blocks[b]=blocks[b].replace(/^bq\.(\.)?\s((.|\n)+)/,function(){added_block=true;extended_block=parser.parse_extended_block(blocks,b,arguments[1],arguments[2]);return'<blockquote><p>'+parser.parse_block(extended_block,true)+'</p></blockquote>';});if(added_block)continue;blocks[b]=blocks[b].replace(/^bc\.(\.)?\s((.|\n)+)/,function(){added_block=true;extended_block=parser.parse_extended_block(blocks,b,arguments[1],arguments[2]);return'<pre><code>'+parser.parse_block(extended_block,false)+'</code></pre>';});if(added_block)continue;blocks[b]=blocks[b].replace(/^pre\.(\.)?\s((.|\n)+)/,function(){added_block=true;extended_block=parser.parse_extended_block(blocks,b,arguments[1],arguments[2]);return'<pre>'+parser.parse_block(extended_block,false)+'</pre>';});if(added_block)continue;blocks[b]=blocks[b].replace(/^notextile\.(\.)?\s((.|\n)+)/,function(){added_block=true;extended_block=parser.parse_extended_block(blocks,b,arguments[1],arguments[2]);return'<p>'+parser.parse_block(extended_block,false)+'</p>';});if(added_block)continue;if(blocks[b].search(/^\s/)===-1){blocks[b]='<p>'+parser.parse_block(blocks[b],true)+'</p>';}else{blocks[b]=parser.parse_block(blocks[b],true);}}
return'<div class="sg_markup">'+blocks.join('\n\n')+'</div>';}});SG.Markup=new SG.MarkupParser();SgToolTips=function()
{var sgtt_ext_lyr=null;var sgtt_text_el=null;var sgtt_visible=false;var sgtt_hide_proc=null;var sgtt_show_proc=null;var sgtt_tip_text='';var sgtt_hide_delay=10000;var sgtt_show_delay=200;var sgtt_started=false;var sgtt_last_xy=null;var sgtt_mouse_y_offset=20;var sgtt_track_mouse=false;var sgtt_initialized=false;var sgtt_singleton=null;var sgtt_max_search_depth=5;var on_over=function(evt)
{var target=evt.target;var depth=0;while(target&&target.nodeType==1&&!target.getAttribute('sg_tip')&&depth<sgtt_max_search_depth){++depth;target=target.parentNode;}
if(!target||target.nodeType!=1||!target.getAttribute('sg_tip'))
{if(sgtt_visible)
hide();return;}
var new_tip=target.getAttribute('sg_tip');if(new_tip!=sgtt_tip_text&&sgtt_visible)
hide();if(target.getAttribute('clip_tip')&&target.getAttribute('clip_tip')=='true'){for(var i=0;i<target.childNodes.length;++i){var child=target.childNodes[i];if(child.scrollWidth<=child.offsetWidth){return;}else{break;}}}
if(target.getAttribute('clip_tip')&&target.getAttribute('clip_tip')=='this_node')
{if(target.scrollWidth<=target.offsetWidth)
return;}
var mouse_xy=evt.getXY();var tip={mouse_xy:mouse_xy,new_tip:new_tip,target:target}
sgtt_show_proc=show.defer(sgtt_show_delay,sgtt_singleton,[tip]);sgtt_started=true;};var on_move=function(evt)
{if(sgtt_visible)
{if(sgtt_track_mouse)
{var mouse_xy=evt.getXY();mouse_xy[1]+=sgtt_mouse_y_offset;sgtt_ext_lyr.setXY(mouse_xy);}}
else if(sgtt_started)
sgtt_last_xy=evt.getXY();};var on_out=function(evt)
{hide();};var on_click=function(evt)
{var target=evt.target;var depth=0;while(target&&target.nodeType==1&&!target.getAttribute('sg_tip')&&depth<sgtt_max_search_depth){++depth;target=target.parentNode;}
if(!target||target.nodeType!=1||!target.getAttribute('sg_tip'))
hide();};var show=function(sgtt)
{var tip=sgtt.new_tip;var mouse_xy=sgtt.mouse_xy;if(sgtt_last_xy)
mouse_xy=sgtt_last_xy;if(!sgtt_visible)
{if(tip)
{sgtt_tip_text=tip;sgtt_text_el.update(sgtt_tip_text.replace(/\[\[/g,"<").replace(/\]\]/g,">"));}
sgtt_ext_lyr.show();sgtt_visible=true;if(!sgtt_hide_proc)
sgtt_hide_proc=setTimeout(hide,sgtt_hide_delay);}
var db=Ext.get(document.body);var dw=db.getWidth();var dh=db.getHeight();if(sgtt.target.getAttribute('top_tip')==='true')
{var telm=Ext.get(sgtt.target);var left=telm.getLeft();var width_diff=db.getWidth()-(left+sgtt_ext_lyr.getWidth());if(width_diff<5)
left+=width_diff-15;sgtt_ext_lyr.dom.style.right='';sgtt_ext_lyr.dom.style.top='';sgtt_ext_lyr.dom.style.left=left+'px';sgtt_ext_lyr.dom.style.bottom=(dh-telm.getTop())+'px';sgtt_ext_lyr.sync();}
else
{mouse_xy[1]+=sgtt_mouse_y_offset;var width_diff=db.getWidth()-(mouse_xy[0]+sgtt_ext_lyr.getWidth());if(width_diff<5)
mouse_xy[0]+=width_diff-15;sgtt_ext_lyr.setXY(mouse_xy);}
if(sgtt_show_proc)
{clearTimeout(sgtt_show_proc);sgtt_show_proc=null;}};var hide=function()
{sgtt_ext_lyr.hide();sgtt_visible=false;sgtt_started=false;sgtt_last_xy=null;if(sgtt_hide_proc)
{clearTimeout(sgtt_hide_proc);sgtt_hide_proc=null;}
if(sgtt_show_proc)
{clearTimeout(sgtt_show_proc);sgtt_show_proc=null;}};return{init:function()
{sgtt_singleton=SgToolTips;if(!sgtt_initialized)
{if(!Ext.isReady)
{Ext.onReady(SgToolTips.init,SgToolTips);return;}
sgtt_ext_lyr=new Ext.Layer({cls:'sg_tool_tip_layer',shim:true,constrain:true});sgtt_ext_lyr.fxDefaults={stopFx:true};sgtt_ext_lyr.update('<div class="sg_tool_tip">&nbsp;</div>');sgtt_text_el=sgtt_ext_lyr.child('div.sg_tool_tip');sgtt_text_el.update('&nbsp;');var doc=Ext.get(document);doc.on('mouseover',on_over);doc.on('mouseout',on_out);doc.on('mousemove',on_move);doc.on('click',on_click);sgtt_initialized=true;}},ready:function()
{return sgtt_initialized;}};}();SG.ProgressIndicator=function(ext_container,type,title){this.doc_body=Ext.get(document.body);this.container=ext_container||this.doc_body;this.type=type||'async';this.title=title||'';this.overlay=null;this.jobs=[];this.indicator_completion=0;this.poll_count_indicator=0;this.poll_count_indicator_strings=['&middot;','&middot;&middot;','&middot;&middot;&middot;','&middot;&middot;&middot;&middot;','&middot;&middot;&middot;&middot;&middot;'];this.polling_interval=1000;this.init();};Ext.extend(SG.ProgressIndicator,Ext.util.Observable,{init:function(){this.templates={progress_indicator:'<div class="progress_indicator_overlay_container">'+'<div class="progress_indicator_overlay {extra_class}">{content}</div></div>',async:'<img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/>',det:'<div class="progress_bar"><div class="body"><div class="title">{title}</div><br/>'+'<div class="indicator">{progress_bar}</div><br/>'+'<div class="status">Please do not refresh or reload the browser until this dialog completes.'+'</div></div></div>',indet:'<div class="progress_bar"><div class="body"><div class="title">{title}</div><br/>'+'<div class="indicator"><img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/></div>'+'<br/><div class="status">Please do not refresh or reload the browser until this dialog completes.'+'</div></div></div>',};for(var template_name in this.templates)if(this.templates.hasOwnProperty(template_name)){this.templates[template_name]=new Ext.Template(this.templates[template_name]).compile();}},show:function(){if(!this.overlay){var overlay_container=this.templates.progress_indicator.append(this.container,{content:this.templates[this.type].apply({title:this.title,progress_bar:''}),extra_class:((this.type!='async')?'mask':'')});this.overlay=Ext.get(overlay_container);this.content=Ext.get(this.overlay.dom.firstChild);this.progress_bar_body=Ext.get(this.content.dom.firstChild);if(this.progress_bar_body){this.indicator=Ext.get(sg_find('.indicator',this.progress_bar_body.dom));if(this.type==='det'){this.indicator.update('Initializing...');}
this.indicator_completion=0;this.poll_count_indicator=0;this.status=Ext.get(sg_find('.status',this.progress_bar_body.dom));}}else if(this.type==='det'){this.update_progress_bar(this.indicator_completion);}
this.overlay.alignTo(this.container,"tl-tl");this.overlay.setWidth(this.container.getWidth());this.overlay.setHeight(this.container.getHeight());this.content.center(this.overlay);if(this.progress_bar_body){var pi=this;setTimeout(function(){pi.progress_bar_body.center(pi.content);},0);}
this.overlay.show();},hide:function(){this.indicator_completion=0;this.poll_count_indicator=0;if(this.overlay){this.overlay.hide();}},add_job:function(job){if(job.job_id&&job.job_type){if(this.get_job(job)===null){this.jobs.push({job_id:job.job_id,job_type:job.job_type,completion:0,retries:0});}
return true;}
return false;},get_job:function(job){var found_job=null;for(var j=0;j<this.jobs.length;++j){if(this.jobs[j].job_id===job.job_id&&this.jobs[j].job_type===job.job_type){found_job=this.jobs[j];break;}}
return found_job;},rm_job:function(job){for(var j=0;j<this.jobs.length;++j){if(this.jobs[j].job_id===job.job_id&&this.jobs[j].job_type===job.job_type){this.jobs.splice(j,1);break;}}},set_post_completion:function(job,fn){var job=this.get_job(job);if(job!==null){job.post_completion_fn=fn;}},set_post_crud_completion:function(job,fn,options){var job=this.get_job(job);if(job!==null){job.post_crud_completion_fn=fn;job.post_crud_completion_options=options;}},set_update_interval:function(interval_in_ms){this.polling_interval=interval_in_ms;},get_update_interval:function(){return this.polling_interval;},update_progress_bar:function(override_completion){var min_completion=0;if(override_completion===undefined){if(this.jobs.length!==0){min_completion=this.jobs[0].completion;for(var j=1;j<this.jobs.length;++j)if(this.jobs[j].completion<min_completion){min_completion=this.jobs[j].completion;}}}else{min_completion=override_completion;}
if(this.indicator){if(min_completion>this.indicator_completion){this.indicator_completion=min_completion;}
this.indicator.update(this.poll_count_indicator_strings[this.poll_count_indicator]+' '+this.indicator_completion+'% '+
this.poll_count_indicator_strings[this.poll_count_indicator]);this.poll_count_indicator=(this.poll_count_indicator+1)%this.poll_count_indicator_strings.length;}
return min_completion;},call_handler:function(handler_hash,pi_status,response)
{var scope=handler_hash.scope||this;var info=handler_hash.info||null;if(handler_hash.mimic_ext_callback)
handler_hash.fn.call(scope,handler_hash.req_options,response.success,response)
else
handler_hash.fn.call(scope,pi_status,info);},start_updates:function(options,success,response){if(success){options=options||{};options.response=response;var job=Ext.decode(response.responseText);this.start_updates_for_job(job,options);}else{this.hide();new SG.ServerErrorHandler().notify_user(response);}},start_updates_for_job:function(job,options){options=options||{};if(this.add_job(job)===true)
{if(job.on_job_complete&&job.on_job_complete.mimic_ext_callback)
job.on_job_complete.req_options=options
else if(this.on_job_complete&&this.on_job_complete.mimic_ext_callback)
this.on_job_complete.req_options=options
this.update.defer(this.get_update_interval(),this,[job]);}else{this.hide();if(this.on_job_failed)
{this.call_handler(this.on_job_failed,options.response);}
else
SG.server_error({html_msg:"Server couldn't start background job."});}},on_update:function(options,success,response){if(success){var status;if(options.method==='GET'&&options.params['X-Progress-ID']){status={job_id:options.params['X-Progress-ID'],job_type:'file_upload',};var resp=eval(response.responseText);if('state'in resp){switch(resp.state){case'uploading':status.completion=parseInt(100*resp.received/resp.size);break;case'done':status.completion=100;break;default:status.completion=null;}}else{status.completion=null;}}else{status=Ext.decode(response.responseText)[0];}
if(status.error){var job=this.get_job(status);this.rm_job(status);this.hide();if(job.on_job_error)
this.call_handler(job.on_job_error,status);else if(this.on_job_error)
this.call_handler(this.on_job_error,status);else
var sed=SG.server_error({html_msg:status.error,connection_response:response});}else{if(this.status){this.status.update('Please do not refresh or reload the browser until this dialog completes.');}
var job=this.get_job(status);if(job===null){this.hide();var sed=SG.server_error({html_msg:"Couldn't find client-side background job record to update progress.",connection_response:response});return;}
if(status.completion!==null){job.completion=Math.floor(Number(status.completion));}else{job.retries+=1;if(status.job_type==="file_upload"&&job.retries>5){status.completion=job.completion=100;}}
var all_jobs_completion=this.update_progress_bar();if(status.completion===100){if(status.responseText){response.responseText=status.responseText;}
if(status.reloadSchema){SG.schema.set_schema(status.reloadSchema);}
if(status.responseJS){eval(status.responseJS);}
response.success=success;if(job.on_job_complete)
this.call_handler(job.on_job_complete,status,response);else if(this.on_job_complete)
this.call_handler(this.on_job_complete,status,response);if(job.post_completion_fn){job.post_completion_fn(status);}
this.rm_job(status);if(all_jobs_completion===100){this.hide();if(this.on_all_jobs_complete)
this.call_handler(this.on_all_jobs_complete,status);if(status.redirect){document.location.href=status.redirect;}}}else{this.update.defer(this.get_update_interval(),this,[job]);}}}else{this.hide();new SG.ServerErrorHandler().notify_user(response);}},update:function(job){var job=this.get_job(job);if(job===null){return;}
var options={url:SG.globals.urls.progress_indicator_update,params:{jobs:Ext.encode([{job_id:job.job_id,job_type:job.job_type}])},callback:this.on_update,scope:this};if(job.job_type==='file_upload'){options={method:'GET',url:'/progress',params:{'X-Progress-ID':job.job_id},callback:this.on_update,scope:this}}
var conn=new Ext.data.Connection();conn.request(options);}});SG.Timecode={};SG.Timecode.pad_digits=function(num,totalDigits){num=num.toString();var pad='';if(totalDigits>num.length){for(var i=0;i<(totalDigits-num.length);i++){pad+='0';}}
return pad+num.toString();}
SG.Timecode.default_framerate=23.976;SG.Timecode.display_framerate=function(){return Number(SG.globals.preferences.timecode_framerate||SG.Timecode.default_framerate);}
SG.Timecode.seconds_to_timecode=function(time_in_seconds,frame_rate){if(typeof frame_rate=="undefined")
frame_rate=SG.Timecode.display_framerate();var wrk_seconds=Number(time_in_seconds);var hours=Math.floor(wrk_seconds/3600);wrk_seconds=wrk_seconds-(hours*3600);var minutes=Math.floor(wrk_seconds/60);wrk_seconds=wrk_seconds-(minutes*60);var seconds=Math.floor(wrk_seconds);wrk_seconds=wrk_seconds-seconds;var frames=Math.round(wrk_seconds*frame_rate);if(frames==Math.round(frame_rate))
{seconds++;frames=0;}
var timecode_string=SG.Timecode.pad_digits(hours,2)+':'+
SG.Timecode.pad_digits(minutes,2)+':'+
SG.Timecode.pad_digits(seconds,2)+':'+
SG.Timecode.pad_digits(frames,2);return timecode_string;}
SG.Timecode.timecode_to_seconds=function(timecode_str,frame_rate){if(typeof frame_rate=="undefined")
frame_rate=SG.Timecode.display_framerate();var bits=timecode_str.split(':');if(bits.length<4)
{while(bits.length<4)
bits.splice(0,0,'0');}
var hours=Number(bits[0]);var minutes=Number(bits[1]);var seconds=Number(bits[2]);var frames=Number(bits[3]);var time_in_seconds=(hours*3600)+(minutes*60)+(seconds)+
(frames/frame_rate);time_in_seconds=Math.round(time_in_seconds*1000)/1000;return time_in_seconds;}
function sg_timecode_unit_test(timecode,seconds,frame_rate){var html='<i>From time code string to seconds ...</i><br/><br/>\n';var s=SG.Timecode.timecode_to_seconds(timecode,frame_rate);html=html+'&nbsp;&nbsp;&nbsp;&nbsp;'+s+' seconds<br/><br/>';html=html+'<i>From seconds to time code string ...</i><br/><br/>\n';var tc=SG.Timecode.seconds_to_timecode(seconds,frame_rate);html=html+'&nbsp;&nbsp;&nbsp;&nbsp;"'+tc+'"<br/><br/>';document.write(html);}
SG.Footage={};SG.Footage.pad_digits=function(num,totalDigits){num=num.toString();var pad='';if(totalDigits>num.length){for(var i=0;i<(totalDigits-num.length);i++){pad+='0';}}
return pad+num.toString();}
SG.Footage.feet_and_frames=function(frames,frames_per_foot){if(typeof frames_per_foot=="undefined")
frames_per_foot=SG.globals.preferences.frames_per_foot;var value={};value.feet=parseInt(frames/frames_per_foot);value.frames=frames-(value.feet*frames_per_foot);return value;}
SG.Footage.frames_to_footage=function(frames,frames_per_foot,format){if(typeof frames_per_foot=="undefined")
frames_per_foot=SG.globals.preferences.frames_per_foot;if(typeof format=="undefined")
format=SG.globals.preferences.format_footage_fields;var footage_string=frames;if(format=='10-05'){value=SG.Footage.feet_and_frames(frames,frames_per_foot);footage_string=value.feet+"-"+SG.Footage.pad_digits(value.frames,2);}else if(format=='10-5'){value=SG.Footage.feet_and_frames(frames,frames_per_foot);footage_string=value.feet+"-"+value.frames;}else if(format=='10+05'){value=SG.Footage.feet_and_frames(frames,frames_per_foot);footage_string=value.feet+"+"+SG.Footage.pad_digits(value.frames,2);}else if(format=='10+5'){value=SG.Footage.feet_and_frames(frames,frames_per_foot);footage_string=value.feet+"+"+value.frames;}else if(format=='10\'5"'){value=SG.Footage.feet_and_frames(frames,frames_per_foot);footage_string=value.feet+"'"+value.frames+'"';}else if(format=='10.3125'){footage_string=frames/frames_per_foot;}
return footage_string;}
SG.Footage.footage_to_frames=function(footage,frames_per_foot){if(typeof frames_per_foot=="undefined")
frames_per_foot=SG.globals.preferences.frames_per_foot;var frames;if(/\d+-\d+/.test(footage)){bits=footage.match(/(\d+)-(\d+)/);feet=parseInt(bits[1]);frames=parseInt(bits[2]);frames=frames+feet*frames_per_foot;}else if(/\d+\+\d+/.test(footage)){bits=footage.match(/(\d+)\+(\d+)/);feet=parseInt(bits[1]);frames=parseInt(bits[2]);frames=frames+feet*frames_per_foot;}else if(/\d+\'\d+\"/.test(footage)){bits=footage.match(/(\d+)\'(\d+)\"/);feet=parseInt(bits[1]);frames=parseInt(bits[2]);frames=frames+feet*frames_per_foot;}else if(/\d+\.\d+/.test(footage)){feet=parseInt(footage);frames=(parseFloat(footage)-feet)*frames_per_foot;frames=frames+feet*frames_per_foot;}else{frames=parseInt(footage);}
return frames;}
SG.GridEditor={};SG.GridEditor.editor_instances={};SG.GridEditorFactory=function(data_type)
{switch(data_type)
{case"number":case"percent":case"float":editor=new SG.GridEditor.Number();break;case"currency":editor=new SG.GridEditor.Currency();break;case"timecode":editor=new SG.GridEditor.Timecode();break;case"duration":editor=new SG.GridEditor.Duration();break;case"date_time":editor=new SG.GridEditor.DateTime();break;case"date":editor=new SG.GridEditor.Date();break;case"checkbox":editor=new SG.GridEditor.Checkbox();break;case"list":editor=new SG.GridEditor.List();break;case"multi_list":editor=new SG.GridEditor.List({multiselect:true});break;case"status_list":editor=new SG.GridEditor.StatusList();break;case"multi_status_list":editor=new SG.GridEditor.StatusList({multiselect:true});break;case"url_display_name":editor=new SG.GridEditor.URLDisplayName();break;case"entity":editor=new SG.GridEditor.Entity();break;case"multi_entity":editor=new SG.GridEditor.Entity({multiselect:true});break;case"text":editor=new SG.GridEditor.TextArea();editor.modified_return_in_textarea=true;break;case"textarea":editor=new SG.GridEditor.TextArea();break;case"task_template_entity_types":editor=new SG.GridEditor.TaskTemplateEntityTypes();break;case"task_template_list":editor=new SG.GridEditor.TaskTemplateList();break;case"layout_project_list":editor=new SG.GridEditor.LayoutProjectList();break;case"permission_rule_set_list":editor=new SG.GridEditor.PermissionRuleSetList();break;case"color":editor=new SG.GridEditor.Color();break;case"icon":editor=new SG.GridEditor.Icon();break;case"image_button":editor=new SG.GridEditor.ImageButton();break;case"step_list":editor=new SG.GridEditor.StepList();break;case"entity_type":editor=new SG.GridEditor.EntityTypes();break;case"page_entity_type":editor=new SG.GridEditor.PageEntityTypes();break;case"footage":editor=new SG.GridEditor.Footage();break;case"page_folder":editor=new SG.GridEditor.PageFolder();break;default:editor=new SG.GridEditor.Text();}
return editor;}
SG.GridEditor.Text=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Text,Ext.util.Observable,{template:'<div class="entity_editor" style="z-index: 5;"><input type="text" value="{value}" /></div>',init:function()
{this.events={"specialkey":true,"blur":true};if(!this.container)
this.container=document.body;},get_schema_field:function()
{return SG.schema.get_field(this.record.get_type(),this.column_name);},set_container:function(container){var new_container=Ext.get(container);if(new_container!=Ext.get(this.container)){this.container=new_container;this.dom=null;}},edit:function(context)
{this.record=context.record;this.column_name=context.column_name;this.cell_element=Ext.get(context.cell_element);this.click_target=context.click_target;this.projects=context.projects;this.cell=context.cell;if(context.container)
this.set_container(context.container);if('group_idx'in context)
this.group_idx=context.group_idx;if('parent_entity'in context)
this.parent_entity=context.parent_entity;this.retrieve_value_from_data_store();if(!this.dom||!this.dom.parentNode)
{this.render_editor();this.set_value(this.initial_value);}
else
{this.set_value(this.initial_value);}
SG.Page.unsaved_data.add(this);this.show_editor();},render_editor:function()
{if(typeof this.template=="string")
{this.template=new Ext.Template(this.template);this.template.disableFormats=true;this.template.compile();}
this.dom=this.template.append(this.container,{value:this.initial_value});this.element_created();this.el=Ext.get(this.dom);this.el.hide();},delete_editor_html:function()
{if(!this.dom)
return;this.dom.parentNode.removeChild(this.dom);this.dom=null;this.el=null;this.input_dom=null;this.input_el=null;},element_created:function()
{this.input_dom=this.dom.firstChild;this.input_el=Ext.get(this.input_dom);},show_editor:function(cell_element)
{SG.GridEditor.showing_editor=this;if(cell_element&&cell_element!=this.cell_element)
{this.cell_element=Ext.get(cell_element);;}
this.el.position("absolute");this.el.alignTo(this.cell_element,(this.cell_element.getStyle("vertical-align")=="bottom")?"bl-bl":"tl-tl");this.set_editor_element_sizes();this.el.show();this.add_event_listeners();this.focus();},set_editor_element_sizes:function()
{var size=this.cell_element.getSize();this.width=size.width;this.height=size.height;this.el.setSize(this.width,this.height);this.input_el.setSize(this.width,this.height);},get_record:function()
{return this.record;},retrieve_value_from_data_store:function()
{var rec=this.get_record();this.revert_value=rec.get_revert_value(this.column_name);this.initial_value=rec.get(this.column_name);},put_value_in_data_store:function(value,status,reason)
{var rec=this.get_record();var error=null;if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};}
rec.set(this.column_name,value,error);},revert_data_store:function()
{var rec=this.get_record();rec.revert(this.column_name);},get_value:function()
{return this.input_dom.value.strip();},set_value:function(value)
{this.input_dom.value=value;},values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1='';if(v2===null)v2='';return(v1==v2);},validate:function(value)
{if(this.record.get_type()=='Status'&&this.column_name=='code'&&value&&value.length>6)
return"The Status code must be 6 characters or less.";return"valid";},has_unsaved_data:function()
{return(!this.values_equal(this.get_value(),this.initial_value));},update_and_hide:function()
{var value=this.get_value();if(!this.values_equal(value,this.initial_value)||this.record.get_status(this.column_name)=="server_connection_error")
{var valid=this.validate(value);if(valid=="valid")
{this.put_value_in_data_store(value);}
else
{this.put_value_in_data_store(value,"invalid_entry",valid);}}
this.cleanup();},cancel:function()
{this.cleanup()},cleanup:function()
{SG.Page.unsaved_data.remove(this);if(this.el)
this.el.hide();this.purgeListeners();this.remove_event_listeners();SG.GridEditor.showing_editor=false;this.delete_editor_html();},focus:function(no_select)
{this.input_el.focus();if(no_select)
return;try{this.input_dom.select();}catch(e){}},blur:function()
{if(this.input_el)
this.input_el.blur();},selection_manager_mouse_down:function(e)
{if(this.input_el&&this.input_el.dom!=e.getTarget())
this.blur();},add_event_listeners:function()
{this.input_el.on("blur",this.on_input_blur,this);this.input_el.on("keydown",this.ext_fire_key,this);},remove_event_listeners:function()
{if(this.input_el)
{this.input_el.un("blur",this.on_input_blur,this);this.input_el.un("keydown",this.ext_fire_key,this);}},on_input_blur:function(e)
{this.fireEvent("blur");},ext_fire_key:function(e)
{var key_id=e.getKey();if(key_id==Ext.EventObject.ESC)
e.stopEvent();if(key_id==Ext.EventObject.TAB)
e.preventDefault();var shift_key=e.shiftKey;this.fire_key(key_id,shift_key,e.ctrlKey,e.altKey,e);},fire_key:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{switch(key_id)
{case Ext.EventObject.ESC:if(this.values_equal(this.get_value(),this.revert_value))
{this.fireEvent("specialkey",this,key_id,shift_key);this.blur();}
else
{var editor=this;setTimeout(function(){editor.set_value(editor.revert_value);editor.after_revert();editor.focus();},0);}
break;case Ext.EventObject.RETURN:case Ext.EventObject.TAB:this.handle_return_or_tab(key_id,shift_key,ctrl_or_meta_key,alt_key,e);break;default:this.handle_other_key_events(key_id,shift_key,ctrl_or_meta_key,alt_key,e);break;}},after_revert:function()
{},handle_other_key_events:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{},handle_return_or_tab:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{this.fireEvent("specialkey",this,key_id,shift_key);this.blur();},calculate_editor_alignment:function(cell_elem,editor_elem)
{var cell_bottom=cell_elem.getBottom();var cell_left=cell_elem.getLeft();var editor_height=editor_elem.getHeight();var editor_width=editor_elem.getHeight();var db=Ext.get(document.body);var db_height=db.getHeight();var db_width=db.getWidth();if(cell_bottom+editor_height<db_height)
{if(cell_left+editor_width<db_width)
return"tl-bl";else
return"tr-br";}
else
{if(cell_left+editor_width<db_width)
return"bl-tl";else
return"br-tr";}},});SG.GridEditor.TextArea=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.TextArea,SG.GridEditor.Text,{template:'<div class="entity_editor" style="z-index: 5"><textarea class="sg_grid_editor_textarea"></textarea></div>',handle_return_or_tab:function(key_id,shift_key,ctrl_or_meta_key,alt_key)
{if(!this.modified_return_in_textarea&&key_id==Ext.EventObject.RETURN)
{return;}
if(key_id==Ext.EventObject.RETURN&&(ctrl_or_meta_key||alt_key))
{var start=this.input_dom.selectionStart;var end=this.input_dom.selectionEnd;var scrollTop=this.input_dom.scrollTop;this.input_dom.value=this.input_dom.value.substring(0,start)+"\n"+this.input_dom.value.substring(end);this.input_dom.selectionStart=start+1;this.input_dom.selectionEnd=end+1;this.input_dom.scrollTop=scrollTop;}
else
{this.fireEvent("specialkey",this,key_id,shift_key);this.blur();}}});SG.GridEditor.Number=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Number,SG.GridEditor.Text,{values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1='';if(v2===null)v2='';if(v1===""||v2==="")
return(v1===v2);else
return(Number(v1)==Number(v2));},get_value:function(){var user_input=SG.GridEditor.Number.superclass.get_value.call(this);if(!this.allow_comma_separated_list)
user_input=user_input.replace(/,/g,'')
return user_input;},number_regex:/^\s*\-*\d+\.?\d*\s*$|^\s*\-*\d*\.\d+\s*$/,comma_separated_list_regex:'',validate:function(value)
{if(!this.allow_comma_separated_list||value.indexOf(',')==-1)
return this.__validate(value);else
{if(value==='')
return'valid';var values=value.split(',');for(var i=0;i<values.length;i++)
{var val=values[i].strip();var valid=this.__validate(val);if(!valid=='valid')
return valid;}
return'valid';}},__validate:function(value)
{if(value==='')
return"valid";if(this.number_regex.test(value))
return"valid";else
return"Invalid number format.  Valid format is: 5, 1004, 2.3, .5"},put_value_in_data_store:function(value,status,reason)
{var rec=this.get_record();var error=null;if(this.validate(value)=='valid'){if(!this.allow_comma_separated_list)
rec.set(this.column_name,value===''?value:Number(value));else
rec.set(this.column_name,value);}else{if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};}
rec.set(this.column_name,value,error);}},});SG.GridEditor.Currency=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Currency,SG.GridEditor.Number,{get_value:function(){var user_input=SG.GridEditor.Currency.superclass.get_value.call(this);if(!this.allow_comma_separated_list){return this.__to_fixed(user_input);}else{var values=user_input.split(',');for(var i=0;i<values.length;i++)
{values[i]=this.__to_fixed(values[i]);}
return values.join(',');}},__to_fixed:function(value){if(value===""||isNaN(value))
return value;else
return Number(value).toFixed(2);}});SG.GridEditor.Duration=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Duration,SG.GridEditor.Number,{duration_regex:/^ *(\d+\.?\d*|\d*\.\d+) *(([wdhm])[a-z]*)? *$/i,validate:function(value)
{if(value==='')
return"valid";if(this.duration_regex.test(String(value).toLowerCase()))
return"valid";else
return"Invalid duration format.  Valid format is: 6, 6 h, 2d, 30 min, 4 days, 1 week"},values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1='';if(v2===null)v2='';if(v1===""||v2==="")
return(v1===v2);else
return(Math.floor(Number(v1))==Math.floor(Number(v2)));},get_value:function()
{var raw_value=this.input_dom.value;var parsed=this.parse_duration_string_into_minutes(raw_value);return parsed;},parse_duration_string_into_minutes:function(str)
{if(str==='')
return'';str=str.toString().toLowerCase();var captures=str.match(this.duration_regex);if(!captures)
return str;var number=captures[1];var units=SG.globals.preferences.duration_units.substring(0,1);if(captures[3])
units=captures[3];var hours_per_day=SG.globals.preferences.hours_per_day
if(units=='w')
number*=5*hours_per_day*60;else if(units=='d')
number*=hours_per_day*60;else if(units=='h')
number*=60;return number;},set_value:function(value)
{var input_value=value;if(SG.globals.preferences.duration_units=="hours"||isNaN(Number(value))){input_value=SG.Renderers.duration.render(value);}else{if(value===''||value===null||value===undefined){input_value="";}else{value=Number(value);var rounded=Math.round((value/(60*SG.globals.preferences.hours_per_day))*10000)/10000;var is_one=(rounded===1);if(SG.globals.preferences.format_float_fields_commas)
rounded=sg_comma_format_number(rounded);input_value=is_one?(rounded+" day"):(rounded+" days");}}
this.input_dom.value=input_value;}});SG.GridEditor.Checkbox=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Checkbox,SG.GridEditor.Text,{render_editor:function()
{this.input_dom=this.cell_element.child('input',true);this.input_el=Ext.get(this.input_dom);if(this.click_target&&this.click_target==this.input_el)
{var editor=this;setTimeout(function(){editor.input_el.blur();},0);}},delete_editor_html:function()
{},add_event_listeners:function()
{SG.GridEditor.Checkbox.superclass.add_event_listeners.call(this);this.input_el.on("change",this.checkbox_change_handler,this);},remove_event_listeners:function()
{SG.GridEditor.Checkbox.superclass.remove_event_listeners.call(this);if(this.input_el)
this.input_el.un("change",this.checkbox_change_handler);},checkbox_change_handler:function(e)
{this.fireEvent("blur",e);},show_editor:function(cell_element)
{if(cell_element&&cell_element!=this.cell_element)
{this.cell_element=Ext.get(cell_element);;}
this.add_event_listeners();this.focus();},cleanup:function()
{SG.Page.unsaved_data.remove(this);this.purgeListeners();this.remove_event_listeners();},get_value:function()
{var value=this.input_el.dom.checked?true:false;return value;},set_value:function(value)
{}});SG.GridEditor.ImageButton=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.ImageButton,SG.GridEditor.Text,{render_editor:function()
{this.input_dom=this.cell_element.child('div[sg_image_button]',true);this.input_el=Ext.get(this.input_dom);if(this.click_target)
{SG.ImageButton.toggle(this.input_dom);var editor=this;setTimeout(function(){editor.fireEvent('blur');},0);}},delete_editor_html:function()
{},show_editor:function(cell_element)
{if(cell_element&&cell_element!=this.cell_element)
{this.cell_element=Ext.get(cell_element);;}
this.add_event_listeners();this.focus();},cleanup:function()
{SG.Page.unsaved_data.remove(this);this.purgeListeners();this.remove_event_listeners();},get_value:function()
{return SG.ImageButton.is_selected(this.input_dom);},set_value:function(value)
{}});SG.GridEditor.URLDisplayName=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.URLDisplayName,SG.GridEditor.Text,{retrieve_value_from_data_store:function()
{var rec=this.get_record();this.revert_value=rec.get_revert_value(this.column_name).display_name;this.initial_value=rec.get(this.column_name).display_name;},put_value_in_data_store:function(value,status,reason)
{var rec=this.get_record();var value_hash=rec.get(this.column_name);value_hash.display_name=value;var error=null;if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};}
rec.set(this.column_name,value_hash,error);},});Date.sgMessyDateTimeRe=/^[a-z][a-z][a-z] ([a-z][a-z][a-z]) (\d\d) (\d\d):(\d\d):(\d\d) UTC (\d\d\d\d)$/i;Date.sgSummaryDateTimeRe=/^(\d\d\d\d)-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d)$/;Date.sgSummaryDateTimeFractionalRe=/^(\d\d\d\d)-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d)\.\d*?$/;Date.sgGoodDateTimeRe=/^(\d\d\d\d)-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d) UTC$/;Date.sgParseDateTime=function(date_str)
{if(date_str==null||date_str=="")
return null;var month_index;var match=date_str.match(this.sgMessyDateTimeRe);if(match)
{month_index=SG.GridEditor.DateParser.cap_months.indexOf(match[1]);return new Date(Date.UTC(match[6],month_index,match[2],match[3],match[4],match[5]));}
match=date_str.match(this.sgSummaryDateTimeRe);if(match)
{month_index=Number(match[2])-1;return new Date(Date.UTC(match[1],month_index,match[3],match[4],match[5],match[6]));}
match=date_str.match(this.sgSummaryDateTimeFractionalRe);if(match)
{month_index=Number(match[2])-1;return new Date(Date.UTC(match[1],month_index,match[3],match[4],match[5],match[6]));}
match=date_str.match(this.sgGoodDateTimeRe);if(match)
{month_index=Number(match[2])-1;return new Date(Date.UTC(match[1],month_index,match[3],match[4],match[5],match[6]));}
return null;};Date.sg_date_for_token=function(date_token)
{var parser;if(date_token.parser=='DateParser')
parser=SG.GridEditor.DateParser;else if(date_token.parser=='DateTimeParser')
parser=SG.GridEditor.DateTimeParser;else
throw"Token date parser not found for "+date_token.parser;return parser.date_for_token(date_token);};SG.GridEditor.DateParser={regexes:[],extractors:[],cap_months:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],cap_day_of_week:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],relative_display_values:{today:'Today',tomorrow:'Tomorrow',yesterday:'Yesterday'},get_token:function(relative_day)
{if(['today','tomorrow','yesterday'].indexOf(relative_day.toLowerCase())==-1)
throw"Invalid relative_day value for date token.  Must be 'today', 'tomorrow', or 'yesterday'.";return{date_token:true,relative_day:relative_day.toLowerCase(),parser:'DateParser'};},date_for_token:function(date_token)
{var actual_date;switch(date_token.relative_day)
{case'today':actual_date=this.get_normalized_today();break;case'tomorrow':actual_date=this.get_normalized_tomorrow();break;case'yesterday':actual_date=this.get_normalized_yesterday();break;}
return this.data_store_format(actual_date);},get_year:function(date)
{return date.getUTCFullYear();},get_month:function(date)
{return date.getUTCMonth();},get_short_month_name:function(date)
{return this.cap_months[this.get_month(date)];},get_date:function(date)
{return date.getUTCDate();},get_day:function(date)
{return date.getUTCDay();},get_short_day_name:function(date)
{return this.cap_day_of_week[this.get_day(date)];},set_date:function(date,value)
{date.setUTCDate(value);},same_date:function(date1,date2)
{if(!date1.getUTCFullYear||!date2.getUTCFullYear)
return(date1==date2);return(date1.getUTCFullYear()==date2.getUTCFullYear()&&date1.getUTCMonth()==date2.getUTCMonth()&&date1.getUTCDate()==date2.getUTCDate());},shift_date:function(date,n)
{date.setUTCDate(date.getUTCDate()+n);},shift_month:function(date,n)
{date.setUTCDate(1);date.setUTCMonth(date.getUTCMonth()+n);},shift_month_same_date:function(date,n)
{date.setUTCMonth(date.getUTCMonth()+n);},shift_year:function(date,n)
{date.setUTCFullYear(date.getUTCFullYear()+n);},shift_second:function(date,n)
{date.setUTCSeconds(date.getUTCSeconds()+n);},get_normalized_today:function()
{var now=new Date();return new Date(Date.UTC(now.getFullYear(),now.getMonth(),now.getDate()));},get_normalized_yesterday:function()
{var date=this.get_normalized_today();date.setUTCDate(date.getUTCDate()-1);return date;},get_normalized_tomorrow:function()
{var date=this.get_normalized_today();date.setUTCDate(date.getUTCDate()+1);return date;},get_normalized_start_of_calendar_week:function()
{var date=this.get_normalized_today();var end_of_week_day_num=this.cap_day_of_week.indexOf(SG.globals.preferences.week_end_day.substring(0,3));this.shift_date(date,-1);while(date.getUTCDay()!=end_of_week_day_num)
this.shift_date(date,-1);this.shift_date(date,1);return date;},get_normalized_end_of_calendar_week:function()
{var date=this.get_normalized_today();var end_of_week_day_num=this.cap_day_of_week.indexOf(SG.globals.preferences.week_end_day.substring(0,3));while(date.getUTCDay()!=end_of_week_day_num)
this.shift_date(date,1);return date;},data_store_format:function(date)
{if(date==null||date=="")
return"";if(!date.getDate)
return date;return date.getUTCFullYear()+'-'+
String.leftPad(date.getUTCMonth()+1,2,'0')+'-'+
String.leftPad(date.getUTCDate(),2,'0');},friendly:function(date,no_friendly_words)
{if(!no_friendly_words)
{if(this.same_date(this.get_normalized_today(),date))
return'Today';if(this.same_date(this.get_normalized_tomorrow(),date))
return'Tomorrow';if(this.same_date(this.get_normalized_yesterday(),date))
return'Yesterday';}
var format_str=SG.globals.preferences.format_date_fields||'D, M j y';if(SG.globals.preferences.format_date_fields_year_required&&this.get_year(new Date())!=this.get_year(date))
format_str=SG.globals.preferences.format_date_fields_year_required;return this.format(date,format_str);},month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],day_names:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],format:function(date,format_string)
{var str='';for(var i=0;i<format_string.length;i++)
{var c=format_string[i];switch(c)
{case'D':var day_of_the_week=date.getUTCDay();str+=this.day_names[day_of_the_week].substring(0,3);break;case'M':var month=date.getUTCMonth();str+=this.month_names[month].substring(0,3);break;case'j':str+=date.getUTCDate();break;case's':var date_str=new String(date.getUTCDate());if(date_str!='11'&&date_str.match(/1$/))
date_str+='st';else if(date_str!='12'&&date_str.match(/2$/))
date_str+='nd';else if(date_str!='13'&&date_str.match(/3$/))
date_str+='rd';else
date_str+='th';str+=date_str;break;case'y':var full_year=String(date.getUTCFullYear());str+=full_year.substring(2,4);break;case'Y':var full_year=String(date.getUTCFullYear());str+=full_year;break;case'm':var month=Number(date.getUTCMonth());str+=this.pad2(month+1);break;case'd':var day_of_month=date.getUTCDate();str+=this.pad2(day_of_month);break;case'w':var day_of_the_week=date.getUTCDay();str+=day_of_the_week;break;case'F':var month=date.getUTCMonth();str+=this.month_names[month];break;case'n':var month=Number(date.getUTCMonth());str+=String(month+1);break;case'l':var day_of_the_week=date.getUTCDay();str+=this.day_names[day_of_the_week];break;default:str+=c;}}
return str;},pad2:function(num)
{if(num<10)
return'0'+String(num);else
return String(num);},parse_time:function(time_string)
{return[];},parse:function(date_string)
{if(!date_string)
return null;if(this.regexes.length==0)
this.init_parser();var captures=null;for(var i=0;i<this.regexes.length;i++)
{captures=date_string.match(this.regexes[i]);if(captures)
{var bits=this.extractors[i](captures);if(bits==null)
continue;return this.date_constructor(bits);}}
return null;},date_constructor:function(date_parts)
{var date_millis=Date.UTC(date_parts[0],date_parts[1],date_parts[2]);if(!isNaN(date_millis)){return new Date(date_millis);}
return null;},init_parser:function()
{var months=['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];var days=['sun','mon','tue','wed','thu','fri','sat'];var expand_year=function(high_digits_str,low_digits_str)
{if(high_digits_str)
low_digits_str=high_digits_str+low_digits_str;var year=Number(low_digits_str);if(year<70)
year+=2000;else if(year<100)
year+=1900;return year;};var month_num=function(month_3_chars)
{return months.indexOf(month_3_chars.toLowerCase());};var day_num=function(day_3_chars)
{return days.indexOf(day_3_chars.toLowerCase());};var parser=this;this.regexes=[];this.extractors=[];this.regexes.push(/^ *([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d?)[ \/,-\.]+(\d\d)?(\d\d)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[1]);if(month<0)
return null;var time=[];if(match[5])
time=parser.parse_time(match[5]);return[expand_year(match[3],match[4]),month,match[2]].concat(time);});this.regexes.push(/^ *([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d?)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[1]);if(month<0)
return null;var time=[];if(match[3])
time=parser.parse_time(match[3]);return[new Date().getFullYear(),month,match[2]].concat(time);});this.regexes.push(/^[a-z][a-z][a-z], ([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d?)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[1]);if(month<0)
return null;var time=[];if(match[3])
time=parser.parse_time(match[3]);return[new Date().getFullYear(),month,match[2]].concat(time);});this.regexes.push(/^[a-z][a-z][a-z]+[ \/,-\.]*  *([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d?)[ \/,-\.]+(\d\d)?(\d\d)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[1]);if(month<0)
return null;var time=[];if(match[5])
time=parser.parse_time(match[5]);return[expand_year(match[3],match[4]),month,match[2]].concat(time);});this.regexes.push(/^ *(\d\d?)[ \/,-\.]+([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d)?(\d\d)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[2]);if(month<0)
return null;var time=[];if(match[5])
time=parser.parse_time(match[5]);return[expand_year(match[3],match[4]),month,match[1]].concat(time);});this.regexes.push(/^ *(\d\d?)[ \/,-\.]+([a-z][a-z][a-z])[a-z]*( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[2]);if(month<0)
return null;var time=[];if(match[3])
time=parser.parse_time(match[3]);return[new Date().getFullYear(),month,match[1]].concat(time);});this.regexes.push(/^ *(\d\d?)[ \/,-\.]+(\d\d?)[ \/,-\.]+(\d{1,4})( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var day_month=(SG.globals.preferences.date_component_order=="day_month");var d=day_month?match[1]:match[2];var m=day_month?match[2]:match[1];var time=[];if(match[4])
time=parser.parse_time(match[4]);return[expand_year(null,match[3]),Number(m)-1,d].concat(time);});this.regexes.push(/^ *(\d\d?)[ \/,-\.]+(\d\d?)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var day_month=(SG.globals.preferences.date_component_order=="day_month");var d=day_month?match[1]:match[2];var m=day_month?match[2]:match[1];var time=[];if(match[3])
time=parser.parse_time(match[3]);return[new Date().getFullYear(),Number(m)-1,d].concat(time);});this.regexes.push(/^ *(\d\d\d\d)[ \/,-\.]+(\d\d?)[ \/,-\.]+(\d\d?)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var time=[];if(match[4])
time=parser.parse_time(match[4]);return[match[1],Number(match[2])-1,match[3]].concat(time);});this.regexes.push(/^ *(\d\d\d\d)[ \/,-\.]*([a-z][a-z][a-z])[a-z]*[ \/,-\.]*(\d\d?)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[2]);if(month<0)
return null;var time=[];if(match[4])
time=parser.parse_time(match[4]);return[match[1],month,match[3]].concat(time);});this.regexes.push(/^ *(\d\d\d\d)[ \/,-\.]+(\d\d?)[ \/,-\.]+([a-z][a-z][a-z])[a-z]*( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var month=month_num(match[3]);if(month<0)
return null;var time=[];if(match[4])
time=parser.parse_time(match[4]);return[match[1],month,match[2]].concat(time);});this.regexes.push(/^ *(today|tomorrow|yesterday)( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var time=[];if(match[2])
time=parser.parse_time(match[2]);var date=null;if("today"==match[1].toLowerCase())
date=parser.get_normalized_today();else if("tomorrow"==match[1].toLowerCase())
date=parser.get_normalized_tomorrow();else if("yesterday"==match[1].toLowerCase())
date=parser.get_normalized_yesterday();if(date)
return[parser.get_year(date),parser.get_month(date),parser.get_date(date)].concat(time);});this.regexes.push(/^ *(mon|tue|wed|thu|fri|sat|sun)[a-z]*( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var day_number=day_num(match[1]);if(day_number<0)
return null;var now=new Date();var now_day_number=now.getDay();var advance=(day_number-now_day_number+7)%7;var time=[];if(match[2])
time=parser.parse_time(match[2]);return[now.getFullYear(),now.getMonth(),now.getDate()+advance].concat(time);});this.regexes.push(/^ *next +(mon|tue|wed|thu|fri|sat|sun)[a-z]*( +\d?\d((:\d\d(:\d\d)? ?(am|pm)?)| ?(am|pm)))? *$/i);this.extractors.push(function(match)
{var day_number=day_num(match[1]);if(day_number<0)
return null;var now=new Date();var now_day_number=now.getDay();var advance=(day_number-now_day_number+7)%7;advance+=7;var time=[];if(match[2])
time=parser.parse_time(match[2]);return[now.getFullYear(),now.getMonth(),now.getDate()+advance].concat(time);});}};SG.GridEditor.Date=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Date,SG.GridEditor.Text,{parser:SG.GridEditor.DateParser,use_tokens_not_words:false,template:'<div style="z-index: 5"><input type="text" value="{value}" date_editor /></div>',calendar_div_template:'<div class="cldr_div grid_editor sg_focusable" tabindex="-1"><div></div></div>',calendar_contents_template:'{calendar}{tokens}{time}',tokens_template:'<div class="cldr_tokens"><div class="cldr_tokens_heading">Floating day:</div>'+'<div><table>{tokens}</table></div></div>',token_template:'<td class="cldr_token cldr_date {selected_class}" date="{token_label}">{display}</td>',calendar_template:'<table class="cldr_table">'+'<column class="cldr_col"></column><column class="cldr_col"></column><column class="cldr_col">'+'</column><column class="cldr_col"></column><column class="cldr_col">'+'</column><column class="cldr_col"></column><column class="cldr_col"></column>'+'<tr class="cldr_toprow">'+'<td class="cldr_arrow cldr_l_arrow"> &lt; </td>'+'<td colspan=5 class="cldr_month">{month}</td>'+'<td class="cldr_arrow cldr_r_arrow"> &gt; </td>'+'</tr>'+'<tr class="cldr_dayrow">'+'<td><div class="cldr_day_div">S</div></td>'+'<td><div class="cldr_day_div">M</div></td>'+'<td><div class="cldr_day_div">T</div></td>'+'<td><div class="cldr_day_div">W</div></td>'+'<td><div class="cldr_day_div">T</div></td>'+'<td><div class="cldr_day_div">F</div></td>'+'<td><div class="cldr_day_div">S</div></td>'+'</tr>'+'{rows}</table>',calendar_day_row_template:'<tr>{cells}</tr>',calendar_day_outofmonth_template:'<td class="cldr_date cldr_outofmonth" date="{friendly}"><div class="cldr_date_div">{date}</div></td>',calendar_day_template:'<td class="cldr_date {date_class}" date="{friendly}"><div class="cldr_date_div">{date}</div></td>',month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],init:function()
{this.superclass=SG.GridEditor.Date.superclass;this.superclass.init.call(this);},render_editor:function()
{this.superclass.render_editor.call(this);if(typeof this.calendar_contents_template=='string'){this.calendar_div_template=new Ext.Template(this.calendar_div_template);this.calendar_div_template.disableFormats=true;this.calendar_div_template.compile();}
if(typeof this.calendar_contents_template=='string'){this.calendar_contents_template=new Ext.Template(this.calendar_contents_template);this.calendar_contents_template.disableFormats=true;this.calendar_contents_template.compile();}
if(typeof this.calendar_template=='string'){this.calendar_template=new Ext.Template(this.calendar_template);this.calendar_template.disableFormats=true;this.calendar_template.compile();}
if(typeof this.calendar_day_row_template=='string'){this.calendar_day_row_template=new Ext.Template(this.calendar_day_row_template);this.calendar_day_row_template.disableFormats=true;this.calendar_day_row_template.compile();}
if(typeof this.calendar_day_outofmonth_template=='string'){this.calendar_day_outofmonth_template=new Ext.Template(this.calendar_day_outofmonth_template);this.calendar_day_outofmonth_template.disableFormats=true;this.calendar_day_outofmonth_template.compile();}
if(typeof this.calendar_day_template=='string'){this.calendar_day_template=new Ext.Template(this.calendar_day_template);this.calendar_day_template.disableFormats=true;this.calendar_day_template.compile();}
if(typeof this.tokens_template=='string'){this.tokens_template=new Ext.Template(this.tokens_template);this.tokens_template.disableFormats=true;this.tokens_template.compile();}
if(typeof this.token_template=='string'){this.token_template=new Ext.Template(this.token_template);this.token_template.disableFormats=true;this.token_template.compile();}
this.calendar_dom=this.calendar_div_template.append(this.container,{});this.calendar_el=Ext.get(this.calendar_dom);this.calendar_el.hide();this.set_value(this.initial_value);},delete_editor_html:function()
{this.superclass.delete_editor_html.call(this);if(!this.calendar_dom)
return;this.calendar_dom.parentNode.removeChild(this.calendar_dom);this.calendar_dom=null;this.calendar_el=null;},show_editor:function(cell_element)
{this.superclass.show_editor.call(this,cell_element);var alignment=this.calculate_editor_alignment(this.cell_element,this.calendar_el);this.calendar_el.alignTo(this.cell_element,alignment);var container=Ext.get(this.container);if(container.findParent('.sg_dialog')){var body=Ext.get(container.findParent('.body'));if(body&&this.calendar_el.getBottom()>body.getBottom()){this.calendar_el.alignTo(this.cell_element,"bl-tl");if(this.calendar_el.getTop()<body.getTop()){this.calendar_el.alignTo(this.cell_element,"tl-bl");}}}
this.calendar_el.show();},retrieve_value_from_data_store:function()
{var rec=this.get_record();this.revert_value=rec.get_revert_value(this.column_name);if(!this.revert_value||!this.revert_value.date_token)
this.revert_value=this.parser.parse(this.revert_value);this.initial_value=rec.get(this.column_name);if(!this.initial_value||!this.initial_value.date_token)
this.initial_value=this.parser.parse(this.initial_value);},put_value_in_data_store:function(value,status,reason)
{var value_str=(value.date_token?value:this.parser.data_store_format(value));var rec=this.get_record();var error=null;if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};}
rec.set(this.column_name,value_str,error);},set_value:function(value)
{this.selected_date=null;if(value==""||value==null)
this.date_to_show=this.parser.get_normalized_today();else
{if(value.getDate)
{this.selected_date=value;this.date_to_show=value;}
else
this.date_to_show=this.parser.get_normalized_today();}
if(this.selected_date){this.input_dom.value=this.parser.friendly(this.selected_date,this.use_tokens_not_words);}else if(value&&value.date_token){this.input_dom.value=SG.GridEditor.DateParser.relative_display_values[value.relative_day];if(value.time){var fake_date=SG.GridEditor.DateParser.get_normalized_today();fake_date.setHours(value.time[0]);fake_date.setMinutes(value.time[1]);fake_date.setSeconds(value.time[2]);this.input_dom.value+=' '+fake_date.format('h:ia');}}
else
this.input_dom.value=value;this.rerender_calendar();},get_value:function()
{var value=this.input_dom.value;if(value=="")
return"";if(this.use_tokens_not_words&&value.toLowerCase().match(/(today)|(tomorrow)|(yesterday)/))
return this.parser.get_token(value.toLowerCase());var value_date=this.parser.parse(value);if(value_date)
return value_date;else
return value;},validate:function(value)
{if(value==""||value==null||value.getDate||value.date_token)
return"valid";if(this.parser.parse(value))
return"valid";var day_month=(SG.globals.preferences.date_component_order=="day_month");day_month=(day_month?"d/m":"m/d");return"Invalid date format: valid formats include 'may 3', 'tomorrow', '2008-m-d', '"+
day_month+"/07' or '"+day_month+"'";},values_equal:function(value1,value2)
{if(value1!=null&&value2!=null)
{if(value1.date_token||value2.date_token)
return(value1.relative_day==value2.relative_day);return(this.parser.same_date(value1,value2));}
else if((value1==null&&value2=='')||(value1==''&&value2==null))
return true;else
return(value1==value2);},cleanup:function()
{this.use_tokens_not_words=false;if(this.calendar_el)
this.calendar_el.hide();this.superclass.cleanup.call(this);},add_event_listeners:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);this.input_el.on("keydown",this.ext_fire_key,this);},remove_event_listeners:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener);},all_click_listener:function(e,editor)
{var t=e.getTarget();var ext_elem=Ext.get(t);if(ext_elem==this.input_el)
return;var click_obj=(ext_elem.is('.cldr_div')?ext_elem:ext_elem.findParent(".cldr_div",this.calendar_dom.parentNode));if(click_obj)
{var arrow_dom=(ext_elem.is('.cldr_arrow')?ext_elem:ext_elem.findParent(".cldr_arrow",this.calendar_dom.parentNode));if(arrow_dom)
{if(Ext.fly(arrow_dom).hasClass("cldr_l_arrow"))
this.shift_month(-1);else
this.shift_month(1);return;}
var date_dom=(ext_elem.is('.cldr_date')?ext_elem.dom:ext_elem.findParent(".cldr_date",this.calendar_dom.parentNode));if(date_dom)
{this.handle_date_click(e,date_dom);return;}
this.handle_time_click(e,ext_elem);return;}
else
{this.handle_outside_click(e);}},blur:function()
{this.fireEvent("blur",null);},handle_outside_click:function(e)
{this.fireEvent("blur",e);},handle_date_click:function(e,date_dom)
{this.input_dom.value=date_dom.getAttribute("date");this.fireEvent("blur",e);},handle_time_click:function(e,target_ext_elem)
{},shift_month:function(n)
{var date=new Date(this.date_to_show);this.parser.shift_month(date,n);this.date_to_show=date;this.rerender_calendar();},rerender_calendar:function()
{var today=this.parser.get_normalized_today();var day=new Date(this.date_to_show);this.parser.set_date(day,1);var day_of_week=this.parser.get_day(day);this.parser.shift_date(day,-day_of_week);var row_html="";var cell_html="";var date_str="";var friendly="";var i;for(i=0;i<day_of_week;i++)
{date_str=this.parser.get_date(day);friendly=this.parser.friendly(day,this.use_tokens_not_words);cell_html+=this.calendar_day_outofmonth_template.apply({date:date_str,friendly:friendly});this.parser.shift_date(day,1);}
while(this.parser.get_month(day)==this.parser.get_month(this.date_to_show))
{var date_class="";if(this.parser.same_date(today,day))
date_class+='cldr_today';else if(today>day)
date_class+='cldr_past';else
date_class+='cldr_future';if(this.selected_date!=null&&this.parser.same_date(this.selected_date,day))
date_class+=' cldr_selected';date_str=this.parser.get_date(day).toString();friendly=this.parser.friendly(day,this.use_tokens_not_words);cell_html+=this.calendar_day_template.apply({date_class:date_class,date:date_str,friendly:friendly});this.parser.shift_date(day,1);if(this.parser.get_day(day)==0)
{row_html+=this.calendar_day_row_template.apply({cells:cell_html});cell_html="";}}
day_of_week=this.parser.get_day(day);if(day_of_week>0)
{for(i=day_of_week;i<7;i++)
{date_str=this.parser.get_date(day).toString();friendly=this.parser.friendly(day,this.use_tokens_not_words);cell_html+=this.calendar_day_outofmonth_template.apply({date:date_str,friendly:friendly});this.parser.shift_date(day,1);}}
row_html+=this.calendar_day_row_template.apply({cells:cell_html});var month_label=this.month_names[this.parser.get_month(this.date_to_show)]+" "+this.parser.get_year(this.date_to_show);var calendar_html=this.calendar_template.apply({month:month_label,rows:row_html});var tokens_html='';if(this.use_tokens_not_words)
{var value=this.get_value();var selected_token=(value.date_token?value.relative_day:'');var days=['Yesterday','Today','Tomorrow'];for(i=0;i<days.length;i++)
{var token_label=days[i];var selected_class=(token_label==selected_token)?'cldr_selected':'';tokens_html+=this.token_template.apply({selected_class:selected_class,token_label:days[i],display:days[i]});}
tokens_html=this.tokens_template.apply({tokens:tokens_html});}
var time_html=this.render_time();this.calendar_contents_template.overwrite(this.calendar_dom,{calendar:calendar_html,tokens:tokens_html,time:time_html});},render_time:function()
{}});SG.GridEditor.DateTimeParser={};Ext.apply(SG.GridEditor.DateTimeParser,SG.GridEditor.DateParser);Ext.apply(SG.GridEditor.DateTimeParser,{get_token:function(value)
{var relative_day;value=value.toLowerCase();var m=value.match(/(today)|(tomorrow)|(yesterday)/);if(m)
relative_day=m[0];else
throw"Invalid relative_day value for date token.  Must be 'today', 'tomorrow', or 'yesterday'.";var fake_date=this.get_normalized_today();var time=this.parse_time(value);if(!time)time=[0,0,0];var token={date_token:true,relative_day:relative_day,time:time,parser:'DateTimeParser'};return token;},date_for_token:function(date_token)
{var actual_date;switch(date_token.relative_day)
{case'today':actual_date=this.get_normalized_today();break;case'tomorrow':actual_date=this.get_normalized_tomorrow();break;case'yesterday':actual_date=this.get_normalized_yesterday();break;}
if(date_token.time){actual_date.setHours(date_token.time[0]);actual_date.setMinutes(date_token.time[1]);actual_date.setSeconds(date_token.time[2]);}
return this.data_store_format(actual_date);},get_year:function(date)
{return date.getFullYear();},get_month:function(date)
{return date.getMonth();},get_date:function(date)
{return date.getDate();},get_day:function(date)
{return date.getDay();},set_date:function(date,value)
{date.setDate(value);},set_hour:function(date,value)
{date.setHours(value);},set_minute:function(date,value)
{date.setMinutes(value);},set_second:function(date,value)
{date.setSeconds(value);},set_am_pm:function(date,value)
{var hour=date.getHours();if(hour<12&&value=='p')
date.setHours(hour+12);else if(hour>=12&&value=='a')
date.setHours(hour-12);},same_date:function(date1,date2)
{if(!date1.getFullYear||!date2.getFullYear)
return(date1==date2);return(date1.getFullYear()==date2.getFullYear()&&date1.getMonth()==date2.getMonth()&&date1.getDate()==date2.getDate());},shift_date:function(date,n)
{date.setDate(date.getDate()+n);},shift_month:function(date,n)
{date.setDate(1);date.setMonth(date.getMonth()+n);},shift_month_same_date:function(date,n)
{date.setMonth(date.getMonth()+n);},shift_year:function(date,n)
{date.setYear(date.getFullYear()+n);},shift_hour:function(date,n)
{date.setHours(date.getHours()+n);},shift_minute:function(date,n)
{date.setMinutes(date.getMinutes()+n);},toggle_am_pm:function(date,n)
{var hour=date.getHours();if(hour<12)
date.setHours(hour+12);else
date.setHours(hour-12);},get_normalized_today:function()
{var now=new Date();return new Date(now.getFullYear(),now.getMonth(),now.getDate());},get_normalized_yesterday:function()
{var date=this.get_normalized_today();date.setDate(date.getDate()-1);return date;},get_normalized_tomorrow:function()
{var date=this.get_normalized_today();date.setDate(date.getDate()+1);return date;},data_store_format:function(date)
{if(date==null||date=="")
return"";if(!date.getDate)
return date;return date.getUTCFullYear()+'-'+
String.leftPad(date.getUTCMonth()+1,2,'0')+'-'+
String.leftPad(date.getUTCDate(),2,'0')+' '+
String.leftPad(date.getUTCHours(),2,'0')+':'+
String.leftPad(date.getUTCMinutes(),2,'0')+':'+
String.leftPad(date.getUTCSeconds(),2,'0')+' UTC';},friendly:function(date,no_friendly_words)
{if(!no_friendly_words)
{if(this.same_date(this.get_normalized_today(),date))
return'Today'+" "+date.format('h:ia');if(this.same_date(this.get_normalized_tomorrow(),date))
return'Tomorrow'+" "+date.format('h:ia');if(this.same_date(this.get_normalized_yesterday(),date))
return'Yesterday'+" "+date.format('h:ia');}
var format_str=SG.globals.preferences.format_date_fields||'D, M j y';if(SG.globals.preferences.format_date_fields_year_required&&this.get_year(new Date())!=this.get_year(date))
format_str=SG.globals.preferences.format_date_fields_year_required;return date.format(format_str)+" "+date.format('h:ia');},date_constructor:function(date_parts)
{if(date_parts.length==3)
return new Date(date_parts[0],date_parts[1],date_parts[2]);else if(date_parts.length==4)
return new Date(date_parts[0],date_parts[1],date_parts[2],date_parts[3]);else if(date_parts.length==5)
return new Date(date_parts[0],date_parts[1],date_parts[2],date_parts[3],date_parts[4]);else if(date_parts.length==6)
return new Date(date_parts[0],date_parts[1],date_parts[2],date_parts[3],date_parts[4],date_parts[5]);},time_detail_re:/(\d?\d)(:(\d\d))?(:(\d\d))? *((a|p)[m]?)?/,parse_time:function(time_string)
{var match=time_string.match(this.time_detail_re);if(match)
{var hours=Number(match[1]);var minutes=(match[3]?Number(match[3]):0);var seconds=(match[5]?Number(match[5]):0);if(match[7])
{if(hours==12&&match[7]=="a")
hours=0;else if(hours<12&&match[7]=="p")
hours+=12;}
return[hours,minutes,seconds];}
else
return null;}});SG.GridEditor.DateTime=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.DateTime,SG.GridEditor.Date,{parser:SG.GridEditor.DateTimeParser,time_template:'<div class="cldr_time">'+'<div class="cldr_time_box_shadow_zone"><div class="cldr_time_box">'+'<div class="cldr_time_elem hours {hours_class}">{hours}</div>:'+'<div class="cldr_time_elem minutes {minutes_class}">{minutes}</div>'+'<div class="cldr_time_elem am_pm {am_pm_class}">{am_pm}</div>'+'</div></div>'+'<div class="cldr_time_up_down">'+'<div class="cldr_time_up"><img class="cldr_time_up" src="{up}"></img></div>'+'<div class="cldr_time_down"><img class="cldr_time_down" src="{down}"></img></div>'+'</div>'+'<div class="cldr_time_update_cancel">'+'<span class="cldr_time_cancel">Cancel</span>'+'<button class="cldr_time_update">Update</button>'+'</div>'+'</div>',render_time:function()
{if(typeof this.time_template=='string'){this.time_template=new Ext.Template(this.time_template);this.time_template.disableFormats=true;this.time_template.compile();}
var hours=this.date_to_show.getHours();if(!this.selected_time_component)
this.selected_time_component=null;return this.time_template.apply({hours:this.pad(this.twelve_hour_hours(hours),'&nbsp;'),hours_class:this.selected_time_component=='hour'?'selected':'',minutes:this.pad(this.date_to_show.getMinutes(),'0'),minutes_class:this.selected_time_component=='minute'?'selected':'',am_pm:(hours<12)?'am':'pm',am_pm_class:this.selected_time_component=='am_pm'?'selected':'',up:SG.globals.icons.ScrollUp,down:SG.globals.icons.ScrollDown});},twelve_hour_hours:function(hours)
{if(hours==0)
return 12;else if(hours>12)
return(hours-12);else
return hours;},pad:function(number,character)
{var str=String(number);if(str.length==1)
str=character+str;return str;},retrieve_value_from_data_store:function()
{this.revert_value=this.get_record().get_revert_value(this.column_name);if(!this.revert_value||!this.revert_value.date_token)
this.revert_value=Date.sgParseDateTime(this.revert_value);this.initial_value=this.get_record().get(this.column_name);if(!this.initial_value||!this.initial_value.date_token)
this.initial_value=Date.sgParseDateTime(this.initial_value);},validate:function(value)
{if(value==""||value==null||value.getDate||value.date_token)
return"valid";if(this.parser.parse(value))
return"valid";var day_month=(SG.globals.preferences.date_component_order=="day_month");day_month=(day_month?"d/m":"m/d");return"Invalid date-time format: valid formats include 'may 3 12pm', 'tomorrow 9:30', '2008-m-d 7:30 AM', '"+
day_month+"/07 13:00' or '"+day_month+" 7 am'";},values_equal:function(value1,value2)
{if(value1!=null&&value2!=null)
if(value1.getTime&&value2.getTime)
return(value1.getTime()==value2.getTime());else if(value1.date_token&&value2.date_token&&this.times_equal(value1,value2))
return(value1.relative_day==value2.relative_day);else if((value1==null&&value2=='')||(value1==''&&value2==null))
return true;else
return(value1==value2);},times_equal:function(value1,value2)
{if(Ext.encode(value1.time)==Ext.encode(value2.time))
return true;else
return false;},adjust_time:function(direction,component)
{var date=new Date(this.date_to_show);direction=(direction=='up'?1:-1);if(component=='hour')
this.parser.set_hour(date,mod(date.getHours()+direction,24));else if(component=='minute')
this.parser.set_minute(date,mod(date.getMinutes()+direction,60));else if(component=='am_pm')
this.parser.toggle_am_pm(date);this.update_time(date);},update_time:function(date)
{this.date_to_show=date;var friendly=this.parser.friendly(this.date_to_show,this.use_tokens_not_words);this.input_dom.value=friendly;this.rerender_calendar();},extract_time_component:function(target_dom)
{var comp=null;if(target_dom.className.indexOf('hours')>-1)
comp='hour';else if(target_dom.className.indexOf('minutes')>-1)
comp='minute';else if(target_dom.className.indexOf('am_pm')>-1)
comp='am_pm';return comp;},cleanup:function()
{this.select_time_component(null);SG.GridEditor.DateTime.superclass.cleanup.call(this);},add_event_listeners:function()
{SG.GridEditor.DateTime.superclass.add_event_listeners.call(this);Ext.EventManager.addListener(this.calendar_dom,"keypress",this.handle_time_keypress,this);},remove_event_listeners:function()
{SG.GridEditor.DateTime.superclass.remove_event_listeners.call(this);Ext.EventManager.removeListener(this.calendar_dom,"keypress",this.handle_time_keypress);},max_time_number:{'hour':12,'minute':59,'second':59},time_comp_order:['hour','minute','am_pm'],handle_time_keypress:function(e)
{var c=e.charCode;var k=e.keyCode;var s=e.shiftKey;var me=this;setTimeout(function(){me.handle_time_keypress_impl(c,k,s);},0);if([Ext.EventObject.TAB,Ext.EventObject.UP,Ext.EventObject.DOWN,Ext.EventObject.ESC].indexOf(k)>-1)
{e.stopEvent();}},handle_time_keypress_impl:function(c,key_code,shift_key)
{var date,next_comp_index;if(this.selected_time_component&&this.selected_time_component!='am_pm'&&c>=48&&c<=57)
{var new_num=String.fromCharCode(c);if(this.last_time_keystroke)
{var test_num=this.last_time_keystroke+new_num;if(Number(test_num)<=this.max_time_number[this.selected_time_component])
{new_num=test_num;this.last_time_keystroke=null;}
else
this.last_time_keystroke=new_num;}
else
this.last_time_keystroke=new_num;date=new Date(this.date_to_show);switch(this.selected_time_component)
{case'hour':var new_hour=Number(new_num);if(new_hour<12&&date.getHours()>=12)
new_hour+=12;else if(new_hour==12&&date.getHours()<12)
new_hour=0;this.parser.set_hour(date,new_hour);break;case'minute':this.parser.set_minute(date,Number(new_num));break;case'second':this.parser.set_second(date,Number(new_num));break;}
this.update_time(date);}
else if(['a','p'].indexOf(String.fromCharCode(c).toLowerCase())>-1)
{var a_or_p=String.fromCharCode(c).toLowerCase();date=new Date(this.date_to_show);this.parser.set_am_pm(date,a_or_p);this.update_time(date);}
else if(this.selected_time_component&&(key_code==Ext.EventObject.RIGHT||(key_code==Ext.EventObject.TAB&&!shift_key)))
{next_comp_index=this.time_comp_order.indexOf(this.selected_time_component)+1;this.selected_time_component=this.time_comp_order[mod(next_comp_index,this.time_comp_order.length)];this.rerender_calendar();}
else if(this.selected_time_component&&(key_code==Ext.EventObject.LEFT||(key_code==Ext.EventObject.TAB&&shift_key)))
{next_comp_index=this.time_comp_order.indexOf(this.selected_time_component)-1;this.selected_time_component=this.time_comp_order[mod(next_comp_index,this.time_comp_order.length)];this.rerender_calendar();}
else if(this.selected_time_component&&(key_code==Ext.EventObject.UP))
{this.adjust_time('up',this.selected_time_component);}
else if(this.selected_time_component&&(key_code==Ext.EventObject.DOWN))
{this.adjust_time('down',this.selected_time_component);}
else if(key_code==Ext.EventObject.RETURN)
{this.fireEvent('blur');}
else if(key_code==Ext.EventObject.ESC)
{this.cancel();}},select_time_component:function(component)
{this.selected_time_component=component;this.last_time_keystroke=null;},handle_outside_click:function(e)
{this.fireEvent('blur');},handle_date_click:function(e,date_dom)
{var friendly_date_str=date_dom.getAttribute("date");this.input_dom.value=friendly_date_str;var as_date=this.parser.parse(friendly_date_str);this.date_to_show=as_date;this.selected_date=as_date;this.rerender_calendar();},handle_time_click:function(e,target_ext_elem)
{var time_area=target_ext_elem.findParent("div.cldr_time",this.calendar_dom.parentNode);if(!time_area)
return;this.calendar_dom.focus();if(target_ext_elem.hasClass('cldr_time_up')||target_ext_elem.hasClass('cldr_time_down'))
{if(!this.selected_time_component)
{this.select_time_component('hour');}
var up_down=target_ext_elem.hasClass('cldr_time_up')?'up':'down';var me=this;this.last_time_keystroke=null;setTimeout(function(){me.adjust_time(up_down,me.selected_time_component);},0);return;}
var time_box=target_ext_elem.findParent("div.cldr_time_box",this.calendar_dom.parentNode);if(time_box)
{if(target_ext_elem.hasClass('cldr_time_elem'))
{var other_elems=sg_find_all('div.cldr_time_elem',time_box);if(other_elems)
{for(var i=0;i<other_elems.length;i++)
{Ext.get(other_elems[i]).removeClass('selected');}}
target_ext_elem.addClass('selected');this.select_time_component(this.extract_time_component(target_ext_elem.dom));}
return;}
if(target_ext_elem.hasClass('cldr_time_update'))
this.fireEvent("blur",e);if(target_ext_elem.hasClass('cldr_time_cancel'))
this.cancel();}});SG.GridEditor.Timecode=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Timecode,SG.GridEditor.Text,{retrieve_value_from_data_store:function()
{var rec=this.get_record();var tmp_revert_val=rec.get_revert_value(this.column_name);if(tmp_revert_val===null||tmp_revert_val==="")
this.revert_value="";else
this.revert_value=SG.Timecode.seconds_to_timecode(tmp_revert_val/1000.0);this.initial_status=rec.get_status(this.column_name);var tmp_initial_val=rec.get(this.column_name);if(this.initial_status=="invalid_entry")
this.initial_value=tmp_initial_val;else if(tmp_initial_val===null||tmp_initial_val==="")
this.initial_value="";else
this.initial_value=SG.Timecode.seconds_to_timecode(tmp_initial_val/1000.0);},put_value_in_data_store:function(value,status,reason)
{var ds_value;var rec=this.get_record();var error=null;if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};ds_value=value;}
else if(value==="")
ds_value="";else
ds_value=Math.round(SG.Timecode.timecode_to_seconds(value)*1000.0);rec.set(this.column_name,ds_value,error);},values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1="";if(v2===null)v2="";if(v1===v2)
return true;else if(v1!=""&&v2!=""&&this.validate(v1)=="valid"&&this.validate(v2)=="valid")
return(SG.Timecode.timecode_to_seconds(v1)==SG.Timecode.timecode_to_seconds(v2));else
return false;},timecode_char_regex:/^[\:\d]+$/,validate:function(value)
{var max_frames=Math.round(SG.Timecode.display_framerate())-1;var max_value=SG.Timecode.timecode_to_seconds("23:59:59:"+max_frames);try{if(value==="")
return"valid";if(!value.match(this.timecode_char_regex))
throw"invalid";var bits=value.split(':');if(bits.length==1)
{if(SG.Timecode.timecode_to_seconds(bits[0])>max_value)
throw"invalid";return"valid";}
else if(bits.length<4)
{while(bits.length<4)
bits.splice(0,0,'0');}
else if(bits.length>4)
throw"invalid";var hh=bits[0];var mm=bits[1];var ss=bits[2];var ff=bits[3];if(Number(hh)>23)
throw"invalid";if(Number(mm)>59)
throw"invalid";if(Number(ss)>59)
throw"invalid";if(Number(ff)>max_frames)
throw"invalid";}
catch(e)
{if(e=="invalid")
return"Invalid Timecode format. Valid format is: HH:MM:SS:FF "+"with range of 0 to 23:59:59:"+max_frames;else
throw e;}
return"valid";}});SG.GridEditor.Color=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Color,SG.GridEditor.Text,{swatches:['255,255,255','234,234,234','213,213,213','192,192,192','171,171,171','150,150,150','129,129,129','108,108,108','87,87,87','66,66,66','45,45,45','24,24,24','0,41,59','2,17,74','19,0,46','47,1,50','62,1,19','99,0,0','94,0,0','83,33,0','77,44,1','84,83,3','54,71,1','1,49,1','0,62,87','1,26,108','27,0,69','71,0,76','90,0,28','148,0,0','136,0,2','125,48,2','117,66,0','123,118,0','81,104,0','0,74,0','0,92,131','0,39,166','47,0,106','107,1,112','135,0,43','222,0,0','204,0,1','179,76,7','172,98,0','184,178,4','123,154,1','1,110,1','0,126,174','1,54,218','59,0,140','139,1,149','180,1,59','253,1,0','254,2,0','248,100,2','232,134,0','245,238,0','162,207,0','25,118,27','2,149,216','0,59,251','85,1,177','183,0,188','226,1,71','254,0,0','254,41,0','253,141,3','252,183,0','249,254,1','182,241,1','1,187,0','0,194,255','0,110,252','109,0,249','238,1,253','254,0,98','252,13,45','255,87,16','246,155,12','253,188,0','255,253,28','203,243,23','29,215,46','2,211,252','50,149,253','156,1,255','253,2,253','252,47,140','253,94,99','254,131,89','255,181,76','253,205,68','253,252,100','213,247,98','103,226,102','0,230,254','129,183,255','192,97,253','254,92,255','254,125,179','254,151,152','254,173,146','254,205,138','255,218,137','253,254,152','231,251,154','161,236,154','152,242,251','188,218,252','222,182,255','253,175,251','254,191,218','253,203,204','253,214,199','254,230,196','252,239,195','251,253,204','239,251,203','202,237,197'],num_rows:10,num_cols:12,swatch_size:12,template:'<div class="entity_editor" style="z-index: 5;"><div></div></div>',templates:{color_editor:'<div class="sge_color_editor" tabindex="-1" style="visibility: hidden;"></div>',swatch:'<td class="swatch">'+'<div class="swatch_border {selected} {dark_light}">'+'<div class="swatch" color_code="{color_code}" style="background-color:rgb({color}); '+'width:{size}px;height:{size}px;">'+'</div></div></td>',swatch_row:'<tr>{swatches}</tr>',swatch_table:'{no_color}<table>{rows}</table>{pipeline_step}',no_color:'<div id="no_color_selector_div"><span id="no_color_selector"><div class="color_none" '+'style="width:14px;height:14px;border:1px solid rgb(127,127,127);display:inline-block;"></div>'+'<span id="no_color_selector_label">None</span>'+'<span></div>',pipeline_step:'<div class="pipeline_step_selector"><input class="pipeline_step" type="checkbox" {checked} />'+'<span>Use the Pipeline Step color</span></div>',},init_templates:function()
{if(!this.templates)
return;for(var template_name in this.templates)
{if(!this.templates.hasOwnProperty(template_name))
continue;if(typeof this.templates[template_name]=="string")
{this.templates[template_name]=new Ext.Template(this.templates[template_name]);this.templates[template_name].compile();}}},init:function()
{this.superclass=SG.GridEditor.Color.superclass;this.superclass.init.call(this);this.init_templates();},render_editor:function()
{if(this.color_editor_el)
this.color_editor_el.remove();this.color_editor_el=Ext.DomHelper.append(this.container,this.templates.color_editor.apply(),true);var rows='';var c=0;for(var i=0;i<this.num_rows;i++)
{var swatches='';for(var j=0;j<this.num_cols;j++)
{var color=this.swatches[c];swatches+=this.templates.swatch.apply({color:color,color_code:this.color_code(color),selected:this.initial_value==color?'selected':'',size:this.swatch_size,dark_light:this.get_contrast_class(color)});c++;}
rows+=this.templates.swatch_row.apply({swatches:swatches});}
var null_color_option=(this.record.get_type()!='Step'&&(this.record.get_type()!='Task'&&this.column_name!='color'));var pipeline_step='';if(this.record.get_type()=='Task'&&this.column_name=='color')
{pipeline_step=this.templates.pipeline_step.apply({checked:this.initial_value=='pipeline_step'?'checked="true"':'',});}
var swatch_table=this.templates.swatch_table.apply({rows:rows,no_color:null_color_option?this.templates.no_color.apply({}):'',pipeline_step:pipeline_step});this.color_editor_el.update(swatch_table);this.color=this.initial_value;this.input_dom=this.color_editor_el.dom;this.input_el=this.color_editor_el;},delete_editor_html:function()
{if(!this.color_editor_el)
return;this.color_editor_el.dom.parentNode.removeChild(this.color_editor_el.dom);this.color_editor_el=null;this.input_dom=null;this.input_el=null;},show_editor:function(cell_element)
{var alignment=this.calculate_editor_alignment(this.cell_element,this.color_editor_el);this.color_editor_el.alignTo(this.cell_element,alignment);var container=Ext.get(this.container);var dialog=container.findParent('.sg_dialog');if(dialog){dialog=Ext.get(dialog);var body=dialog.child('.body');if(body&&this.color_editor_el.getBottom()>body.getBottom()){this.color_editor_el.alignTo(this.cell_element,"bl-tl");if(this.color_editor_el.getTop()<body.getTop()){this.color_editor_el.alignTo(this.cell_element,"tl-bl");}}}
this.color_editor_el.show();this.add_event_listeners();},set_value:function(value)
{if(value)
this.select_swatch(value);},get_value:function()
{return this.color;},blur:function()
{this.fireEvent("blur",null);},cleanup:function()
{if(this.color_editor_el)
this.color_editor_el.hide();this.superclass.cleanup.call(this);},add_event_listeners:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);},remove_event_listeners:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener);},all_click_listener:function(e)
{var t=Ext.get(e.getTarget());var td=t.findParent('td.swatch',this.color_editor_el,true);if(td)
{var div=td.child('div.swatch');var color_code=div.dom.getAttribute('color_code');this.color=this.color_from_code(color_code);this.select_swatch(this.color);this.fireEvent("blur",e);return;}
var div=t.findParent('span#no_color_selector');if(div)
{this.color=null;this.fireEvent("blur",e);return;}
var input=t.findParent('input.pipeline_step')
if(input)
{if(this.initial_value=='pipeline_step')
{this.color='2,149,216';this.select_swatch(this.color);}
else
this.color='pipeline_step';this.fireEvent("blur",e);return;}
this.fireEvent("blur",e);},select_swatch:function(color)
{var selected_div=sg_find('div.swatch.selected',this.color_editor_el.dom);if(selected_div)
{selected_div=Ext.get(selected_div);selected_div.removeClass('selected');}
var selector='div.swatch[color_code="'+this.color_code(color)+'"]';var swatch_div_to_select=sg_find(selector,this.color_editor_el.dom);if(swatch_div_to_select)
{swatch_div_to_select=Ext.get(swatch_div_to_select);swatch_div_to_select.addClass('selected');}},color_code:function(color)
{var code=color.replace(/,/g,'_');return code;},color_from_code:function(code)
{var color=code.replace(/_/g,',');return color;},get_contrast_class:function(color)
{var parts=color.split(',');if(parts.length!=3)
return'light';var gray=(Number(parts[0])+Number(parts[1])+Number(parts[2]))/3.0;return gray>127?'light':'dark';},});SG.GridEditor.List=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.List,SG.GridEditor.Text,{aggressive_list_mode:true,filter_permitted_values:true,keyboard_navigation_blocked:false,focus:function(no_select)
{this.input_el.focus();if(no_select||(this.multiselect&&this.multiselect_select_input_contents==false))
return;try{this.input_dom.select();}catch(e){}},get_list:function()
{var list=this.list||this.get_schema_field();if(this.filter_permitted_values)
return this.filtered_list(list);else
return list;},comma_list_splitter:/\s*,\s*/,filtered_list:function(list)
{if(!list.values)console.trace();var filtered_list={values:[],display_values:[]};for(var i=0;i<list.values.length;i++)
{if(SG.allow("update_field",{entity_type:this.record.get_type(),field_name:this.column_name,field_value:list.values[i]}))
{filtered_list.values.push(list.values[i]);filtered_list.display_values.push(list.display_values[i]);}}
if(this.entity_creation_mode&&list.values.length>0&&filtered_list.values.length==0)
{return list;}
return filtered_list;},get_value:function()
{var display_value=SG.GridEditor.List.superclass.get_value.call(this);if(!this.multiselect)
return this.value_for_display_value(display_value);else
{var value_strings=display_value.split(this.comma_list_splitter);if(value_strings.slice(-1)=="")
value_strings.splice(value_strings.length-1,1);var values=[];for(var i=0;i<value_strings.length;i++)
values.push(this.value_for_display_value(value_strings[i]));return values;}},set_value:function(value)
{var display_value="";if(!this.multiselect)
display_value=this.display_value_for_value(value);else if(value&&value!=null)
{display_values=[];for(var i=0;i<value.length;i++)
display_values.push(this.display_value_for_value(value[i]));display_value=display_values.join(", ");if(display_values.length>1||(display_values.length==1&&display_values[0]))
display_value+=", ";if(display_values.length==1)
this.multiselect_select_input_contents=true;else
this.multiselect_select_input_contents=false;}
SG.GridEditor.List.superclass.set_value.call(this,display_value);},value_for_display_value:function(display_value)
{var value="";var list=this.get_list();var index=list.display_values.indexOf(display_value);if(index==-1)
{for(var i=0;i<list.values.length;i++)
{if(list.display_values[i].toLowerCase()==display_value.toLowerCase())
{index=i;break;}}}
if(index>-1)
value=list.values[index];else
value=display_value;return value;},display_value_for_value:function(value)
{var display_value=value;var list=this.get_list();var index=list.values.indexOf(value);if(index>-1)
display_value=list.display_values[index];return display_value;},validate:function(value)
{var valid="valid";var invalid="Invalid entry: must be blank or in the list.";if(value instanceof Array){for(var i=0;i<value.length;i++){if(!this.valid_entry(value[i]))
return invalid;}
return valid;}else{return this.valid_entry(value)?valid:invalid;}},valid_entry:function(value)
{if(!value||this.get_list().values.indexOf(value)!==-1)
return true;else
return false;},add_event_listeners:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);this.setup_listbox();this.input_el.on("keydown",this.ext_fire_key,this);if(this.aggressive_list_mode)
this.listbox.show();},remove_event_listeners:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener);if(this.input_el)
this.input_el.un("keydown",this.ext_fire_key);},array_content_equal:function(arr1,arr2)
{if(arr1.length!=arr2.length)
return false;var equal=true;for(var i=0;i<arr1.length;i++)
{if(arr2.indexOf(arr1[i])==-1)
equal=false;}
return equal;},setup_listbox:function()
{if(this.listbox)
this.listbox.destroy();this.listbox=null;this.listbox=new SG.ListBox({menu_class:"list_editor_listbox",position:{dom_elem:this.dom,no_cover:true},matching:{input_dom:this.input_dom,multivalued_separator:this.multiselect?',':null,selection_callback:{fn:this.on_listbox_selection,scope:this}},render_container:this.container});this.set_listbox_items();this.listbox.render();},set_listbox_items:function()
{this.listbox.items=[];var list_data=this.get_list();for(var i=0;i<list_data.display_values.length;i++)
{this.listbox.items.push({html:list_data.display_values[i],value:list_data.values[i]});}},cleanup:function()
{SG.GridEditor.List.superclass.cleanup.call(this);if(this.listbox)
{this.listbox.hide();this.listbox.destroy();}
this.list=null;},all_click_listener:function(e,editor)
{var t=e.getTarget();var ext_elem=Ext.get(t);if(ext_elem==this.input_el)
{return;}
if(this.listbox&&this.multiselect)
{var click_obj=ext_elem.findParent("div.list_editor_listbox");if(click_obj)
{return;}}
this.fireEvent("blur",e);},blur:function()
{this.fireEvent("blur",null);},on_global_scroll:function()
{this.cancel();},on_listbox_selection:function(item)
{if(this.multiselect)
this.block_keyboard_navigation();this.last_selected_item=item;var me=this;if(this.multiselect)
{var parts=this.input_dom.value.split(',');parts[parts.length-1]=item.value;for(var i=0;i<parts.length;i++)
parts[i]=parts[i].strip();this.input_dom.value=parts.join(", ")+", ";setTimeout(function(){me.listbox.show();});}
else
this.input_dom.value=item.value;setTimeout(function(){me.item_selected_flag=false;},0);},block_keyboard_navigation:function()
{this.keyboard_navigation_blocked=true;var me=this;setTimeout(function(){me.keyboard_navigation_blocked=false;},0);},handle_return_or_tab:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{if(this.keyboard_navigation_blocked)
{return;}
else
SG.GridEditor.List.superclass.handle_return_or_tab.call(this,key_id,shift_key,ctrl_or_meta_key,alt_key);},});SG.GridEditor.StatusList=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.StatusList,SG.GridEditor.List,{ac_entry_template:'<table width="155" style="table-layout: fixed;"><tr>'+'<td style="text-align: center; vertical-align: middle;" width="45">{icon}</td>'+'<td width="33">{code}</td>'+'<td width="85">{name}</td>'+'</tr></table>',init:function()
{SG.GridEditor.StatusList.superclass.init.call(this);if(typeof this.ac_entry_template==="string")
{this.ac_entry_template=new Ext.Template(this.ac_entry_template);this.ac_entry_template.disableFormats=true;this.ac_entry_template.compile();}},get_list:undefined,get_status_list:function(){return SG.schema.status_list;},get_status_list_subset:function(){return SG.schema.get_field(this.record.get_type(),this.column_name).status_list_subset;},status_permitted:function(status_code)
{if(!this.filter_permitted_values)
return true;return SG.schema.can_edit_field_on_record(this.record,this.get_schema_field(),status_code.toLowerCase(),this.column_name);},format_status_html:function(status_code)
{if(status_code)
{return this.ac_entry_template.apply({icon:SG.Renderers.status_list.render(status_code),code:status_code,name:this.get_status_name(status_code)});}
else
return"";},get_status_name:function(status_code)
{var status_info=this.get_status_list()[status_code];return status_info?status_info.name:'';},set_listbox_items:function()
{this.listbox.items=[];var status_codes=this.get_status_list_subset();for(var i=0;i<status_codes.length;i++)
{this.listbox.items.push({html:this.format_status_html(status_codes[i]),value:status_codes[i],status_name:this.get_status_name(status_codes[i]),disabled:!this.status_permitted(status_codes[i])});}
this.listbox.matching.match_callback={fn:this.match_item,scope:this};this.listbox.matching.highlight_callback={fn:this.match_highlight,scope:this};},match_item:function(match_text,item)
{var rank=item.value.toLowerCase().indexOf(match_text);if(rank>-1)
return rank;rank=item.status_name.toLowerCase().indexOf(match_text);if(rank>-1)
return item.value.length+rank;else
return-1;},match_highlight:function(search_text,item)
{var highlighted_code=this.listbox.highlight_string(search_text,item.value)||item.value;var highlighted_name=this.listbox.highlight_string(search_text,item.status_name)||item.status_name;return this.ac_entry_template.apply({icon:SG.Renderers.status_list.render(item.value),code:highlighted_code,name:highlighted_name});},values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1='';if(v2===null)v2='';return(String(v1)==String(v2));},value_for_display_value:function(display_value)
{var user_input_lc=display_value.toLowerCase();var status_list_subset=this.get_status_list_subset();if(status_list_subset.indexOf(user_input_lc)!=-1){return(user_input_lc);}
var status_list=this.get_status_list();for(var i=0;i<status_list_subset.length;++i){if(status_list[status_list_subset[i]].name.toLowerCase()==user_input_lc){return(status_list_subset[i]);}}
return display_value;},display_value_for_value:function(value)
{if(this.multiselect)
return value;var display_value=value;var status_list=this.get_status_list();var status_list_subset=this.get_status_list_subset();for(var i=0;i<status_list_subset.length;++i)
{if(status_list_subset[i]==value)
{display_value=status_list[value].name;}}
return display_value;},validate:function(value){var valid="valid";var invalid="Invalid entry: must be blank or in the status list.";if(value instanceof Array){for(var i=0;i<value.length;i++){if(!this.valid_status(value[i]))
return invalid;}
return valid;}else{return this.valid_status(value)?valid:invalid;}},valid_status:function(value){var status_list_subset=this.get_status_list_subset();if(!value||(status_list_subset.indexOf(value)>-1&&(!this.filter_permitted_values||SG.allow("update_field",{entity_type:this.record.get_type(),field_name:this.column_name,field_value:value}))))
{return true;}
else
{return false;}}});SG.GridEditor.EntityTypes=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.EntityTypes,SG.GridEditor.List,{get_sorted_entity_types:function(){var entity_types;var schema_field=this.get_schema_field();if(schema_field.entity_type=='Page'&&schema_field.name=='entity_type'){entity_types=sg_deep_copy(SG.schema.leftnav_page_entity_types);var removes=["Status"];for(var i=0;i<removes.length;i++)
{var index=entity_types.indexOf(removes[i]);if(index>-1)
entity_types.splice(index,1);}}else{entity_types=sg_deep_copy(SG.schema.valid_field_entity_types);}
return SG.schema.sort_entity_types_by_display_name(entity_types);},set_listbox_items:function()
{this.listbox.items=[];entity_types=this.get_sorted_entity_types();for(var i=0;i<entity_types.length;i++)
{var entity_type=entity_types[i];var entity_type_hash=SG.schema.entity_types[entity_type];this.listbox.items.push({html:entity_type_hash.display_name,value:entity_type_hash.display_name,entity_type:entity_type});}},display_value_for_value:function(value)
{if(!value)
return'';var entity_type_hash=SG.schema.entity_types[value];if(entity_type_hash)
return entity_type_hash.display_name;else
return value;},value_for_display_value:function(value)
{if(value&&this.last_selected_item&&value==this.last_selected_item.value)
return this.last_selected_item.entity_type;else if(value)
return this.lookup_result(value);else
return null;},lookup_result:function(value)
{for(var i=0;i<this.listbox.items.length;i++)
{if(value==this.listbox.items[i].value)
return this.listbox.items[i].entity_type;}
return{name:value,valid:'invalid'};},validate:function(value)
{if(SG.schema.entity_types[value]){return'valid';}else if(this.record.get_type()=='Page'&&this.column_name=='entity_type'&&this.record.get_state()=='new'&&(value=='_canvas_'||value=='_url_'))
{return"valid";}else{return"Invalid entry.";}}});SG.GridEditor.TaskTemplateEntityTypes=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.TaskTemplateEntityTypes,SG.GridEditor.EntityTypes,{get_sorted_entity_types:function()
{var schema_field=SG.schema.get_field("Task","entity");var entity_types=SG.schema.sort_entity_types_by_display_name(schema_field.allowed_entity_types);return SG.schema.sort_entity_types_by_display_name(entity_types);}});SG.GridEditor.PageEntityTypes=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.PageEntityTypes,SG.GridEditor.EntityTypes,{set_listbox_items:function(){this.listbox.items=[];var entity_types=sg_deep_copy(SG.schema.leftnav_page_entity_types);for(var i=0;i<entity_types.length;i++){var entity_type=entity_types[i];var entity_type_hash=SG.schema.entity_types[entity_type];this.listbox.items.push({html:SG.Renderers.render_page_entity_type(entity_type),value:entity_type_hash.display_name,entity_type:entity_type});}
this.listbox.items.push({line:true});this.listbox.items.push({html:SG.Renderers.render_page_entity_type('_canvas_'),value:'Canvas',entity_type:'_canvas_'});this.listbox.items.push({html:SG.Renderers.render_page_entity_type('_url_'),value:'Url',entity_type:'_url_'});this.listbox.matching.highlight_callback={fn:this.match_highlight,scope:this};},display_value_for_value:function(value){if(!value)
return'';else if(value=='_canvas_')
return'Canvas';else
return SG.schema.entity_types[value].display_name;},match_highlight:function(search_text,item){var highlighted_value=this.listbox.highlight_string(search_text,item.value)||item.value;return SG.Renderers.render_page_entity_type(item.entity_type,highlighted_value);}});SG.GridEditor.TaskTemplateList=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.TaskTemplateList,SG.GridEditor.List,{not_found_message:"Sorry, there are no Task Templates for this type.",make_crud_request:function()
{var entity_type=this.get_schema_field().entity_type;return[{request_type:'read',read:['entities'],type:'TaskTemplate',columns:['code'],filters:{logical_operator:'and',conditions:[{path:'entity_type',relation:'is',values:[entity_type],active:"true"}]},sorts:[{column:'code',direction:'asc'}]}];},request_list:function()
{this.server_list_requested=true;var options={url:"/crud/requests",params:{requests:Ext.encode(this.make_crud_request())},callback:function(options,success,response){if(success){response=Ext.decode(response.responseText);this.on_list_returned(response[0]);}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},on_list_returned:function(response)
{this.server_list_response=response;this.set_listbox_items();this.listbox.render();this.listbox.show();},set_listbox_items:function()
{this.listbox.items=[];if(!this.server_list_response)
{if(!this.server_list_requested)
this.request_list();this.listbox.items.push({html:"Loading...",disabled:true});return;}
if(this.server_list_response.rows.length==0)
{this.listbox.items.push({html:this.not_found_message,disabled:true});return;}
for(var i=0;i<this.server_list_response.rows.length;i++)
{var row=this.server_list_response.rows[i];this.listbox.items.push({html:row[1],value:row[1],entity:{type:this.server_list_response.type,id:row[0],name:row[1],valid:'valid'}});}},display_value_for_value:function(value)
{if(value&&value.name)
return value.name;else
return value;},value_for_display_value:function(value)
{if(value&&this.last_selected_item&&value==this.last_selected_item.value)
return this.last_selected_item.entity;else if(value)
return this.lookup_result(value);else
return null;},lookup_result:function(value)
{for(var i=0;i<this.listbox.items.length;i++)
{if(value==this.listbox.items[i].value)
return this.listbox.items[i].entity;}
return{name:value,valid:'invalid'};},validate:function(value)
{if(value==null||(value.id&&value.type))
return"valid";else
return"Invalid entry.";},values_equal:function(value1,value2)
{if(value1!=null&&value2!=null)
return(value1.type==value2.type&&value1.id==value2.id);else if(value1==null&&value2==null)
return true;else
return false;}});SG.GridEditor.PermissionRuleSetList=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.PermissionRuleSetList,SG.GridEditor.TaskTemplateList,{not_found_message:"There are no permission groups for this type. Please contact you admin or Shotgun support.",make_crud_request:function()
{var entity_type=this.get_schema_field().entity_type;return crud_req=[{request_type:'read',read:['entities'],type:'PermissionRuleSet',columns:['display_name'],filters:{logical_operator:'and',conditions:[{path:'entity_type',relation:'is',values:[entity_type],active:"true"}]},sorts:[{column:'display_name',direction:'asc'}]}];},});SG.GridEditor.LayoutProjectList=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.LayoutProjectList,SG.GridEditor.TaskTemplateList,{set_listbox_items:function()
{this.listbox.items=[];for(var i=0;i<SG.schema.projects.length;i++)
{var project=SG.schema.projects[i];this.listbox.items.push({html:project.name,value:project.name,entity:project});}},make_crud_request:null,request_list:null,on_list_returned:null});SG.GridEditor.Entity=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Entity,SG.GridEditor.Text,{multiselect:false,state:'unmodified',entities:[],template:'<div class="entity_editor actual_entity_editor" style="z-index: 5;">'+'<input class="entity_editor_input" type="text" value="{value}" index="0" /></div>',templates:{matched_entity:'<div class="entity_editor_matched" index="{index}" selected="{selected}" tabindex="-1" '+'style="max-width: {max_width}px;">'+'<div style="" class="sg_entity_icon_span {icon_name}"></div>'+'<div class="name">{text}</div><div class="delete_matched">x</div></div>',unmatched_text:'<span class="entity_editor_unmatched" index="{index}">{text}</span>',input:'<input class="entity_editor_input" type="text" value="{text}" index="{index}" />',width_measurer:'<div id="width_measurer" '+'style="position: absolute; visibility: hidden; height: auto; width: auto;">{text}</div>',autocomplete_results_link:' (<div class="sg_entity_icon_span {icon_name}">'+'</div>{name})',no_matches_found:'No matches found for {text}',create_new_entity_listbox_item:'{message}<span class="fake_link">Create "{text}"</span>'},min_width:120,autocomplete_request_id:0,init_templates:function()
{if(!this.templates)
return;for(var template_name in this.templates)
{if(!this.templates.hasOwnProperty(template_name))
continue;if(typeof this.templates[template_name]=="string")
{this.templates[template_name]=new Ext.Template(this.templates[template_name]);this.templates[template_name].compile();}}},init:function()
{SG.GridEditor.Entity.superclass.init.call(this);this.init_templates();},render_into_cell:function()
{var first_unmatched=null;var now_editing=null;for(var i=0;i<this.entities.length;i++)
{if(first_unmatched==null&&this.entities[i].valid=='invalid')
first_unmatched=i;if(now_editing==null&&this.entities[i].editing)
now_editing=i;delete this.entities[i].editing;}
if(first_unmatched!=null&&now_editing==null)
{this.entities[first_unmatched].editing=true;now_editing=first_unmatched;}
if(first_unmatched==null&&now_editing==null)
{if(!this.multiselect&&this.entities.length>0)
now_editing=0;else
{this.entities.push({name:"",valid:'invalid',editing:true});now_editing=this.entities.length-1;}}
this.current_editing_index=now_editing;var entities_html=[];var width_measurer=null;for(var i=0;i<this.entities.length;i++)
{var entity=this.entities[i];var template=this.templates.matched_entity;if(entity.valid=='invalid'&&i==now_editing)
{template=this.templates.input;width_measurer=this.templates.width_measurer.apply({text:this.entities[i].name});}
else if(entity.valid=='invalid')
template=this.templates.unmatched_text;var max_width=this.cell_element.getSize().width;if(this.min_width&&max_width<this.min_width)
max_width=this.min_width;entities_html.push(template.apply({text:this.entities[i].name,index:i,selected:(i==now_editing),icon_name:this.icon_name_for_entity(this.entities[i]),max_width:max_width-7}));}
if(width_measurer)
entities_html.push(width_measurer);this.dom.innerHTML=entities_html.join('');this.element_created();var me=this;if(!this.shadow)
{this.shadow=new Ext.Shadow({mode:'frame'});}
setTimeout(function(){me.shadow.show(me.dom);},0);if(this.listbox)
{setTimeout(function(){if(me.listbox.items.length>0){me.listbox.show();}},0);}
if(this.cell&&this.cell.cell_manager.on_cell_edit_changed)
{setTimeout(function(){me.cell.cell_manager.on_cell_edit_changed.fn.call(me.cell.cell_manager.on_cell_edit_changed.scope,me.column_name,me.get_value());},0);}},element_created:function()
{this.remove_input_listener();this.input_dom=null;this.input_el=null;this.selected_brick_dom=null;this.selected_brick_el=null;this.width_measurer_dom=null;for(var i=0;i<this.dom.childNodes.length;i++)
{if(this.dom.childNodes[i].nodeName=='INPUT')
{this.input_dom=this.dom.childNodes[i];this.input_el=Ext.get(this.input_dom);}
else if(this.dom.childNodes[i].getAttribute('selected')=='true')
{this.selected_brick_dom=this.dom.childNodes[i];this.selected_brick_el=Ext.get(this.selected_brick_dom);}
else if(this.dom.childNodes[i].id=='width_measurer')
this.width_measurer_dom=this.dom.childNodes[i];}
this.add_input_listener();},set_editor_element_sizes:function()
{var size=this.cell_element.getSize();var width=size.width;if(width<this.min_width)
width=this.min_width;this.el.setWidth(width);this.dom.style.minHeight=size.height+"px";if(this.input_el)
this.update_input_size();},input_size_pad:8,update_input_size:function()
{if(this.input_dom&&this.width_measurer_dom)
{this.input_el.setSize(this.input_size_pad,19);this.width_measurer_dom.innerHTML=this.input_dom.value;var input_width=this.input_el.getWidth();var text_width=Ext.fly(this.width_measurer_dom).getWidth();var input_pos=this.input_dom.offsetLeft;var next_elem_pos=this.input_dom.nextSibling.offsetLeft;var ideal_width=text_width+this.input_size_pad;var cell_width=this.el.getWidth();var available_width=cell_width-input_pos-5;if(ideal_width<=available_width&&(this.current_editing_index==(this.entities.length-1)||next_elem_pos<=input_pos))
{if(input_width<available_width)
this.input_el.setSize(available_width);}
else
{if(ideal_width<=available_width||ideal_width<80)
this.input_el.setSize(ideal_width,19);else
this.input_el.setSize(available_width,19);}}
else if(this.input_dom)
{throw"Whaaa? input but no measurer dom!"}},show_editor:function(cell_element)
{SG.GridEditor.Entity.superclass.show_editor.call(this,cell_element);if(!this.listbox)
this.listbox=new SG.ListBox({menu_class:'entity_editor_listbox',item_selected:{fn:this.on_listbox_item_selected,scope:this},render_container:this.container});this.listbox.position={dom_elem:this.dom,minimum_height:130}
this.set_listbox_to_prompt();this.now_showing=true;},set_listbox_to_prompt:function()
{if(this.stop_prompt)
{this.listbox.items=[];this.listbox.hide();this.listbox.render();return;}
var prompt="Find something by typing its name.";if(this.entity_allowed_types.length<5)
{var type_names=[];for(var i=0;i<this.entity_allowed_types.length;i++)
type_names.push(SG.schema.entity_types[this.entity_allowed_types[i]].display_name);prompt="Find ";if(['a','e','i','o','u'].indexOf(type_names[0][0].toLowerCase())>-1)
prompt+="an ";else
prompt+="a ";if(type_names.length==1)
prompt+=type_names[0];else if(type_names.length==2)
prompt+=type_names[0]+" or "+type_names[1];else
{prompt+=type_names.slice(0,-1).join(', ');prompt+=", or "+type_names[type_names.length-1];}
prompt+=" by typing its name."}
this.listbox.items=[{html:prompt,disabled:true}];this.listbox.render();this.listbox.show();},focus:function(no_select)
{if(this.input_el)
{SG.GridEditor.Entity.superclass.focus.call(this,no_select);}
else if(this.selected_brick_dom)
{this.selected_brick_dom.focus();}},cleanup:function()
{this.now_showing=false;this.use_filter_tokens=false;this.listbox.hide();this.listbox.destroy();if(this.shadow)
this.shadow.hide();SG.GridEditor.Entity.superclass.cleanup.call(this);},add_event_listeners:function()
{this.find_allowed_entity_types();this.add_click_listener();this.add_input_listener();},remove_event_listeners:function()
{this.remove_input_listener();this.remove_click_listener();},add_click_listener:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);},remove_click_listener:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener,this);},add_input_listener:function()
{if(this.input_el)
{this.input_el.un("keydown",this.ext_fire_key,this);this.input_el.on("keydown",this.ext_fire_key,this);if(Ext.isGecko)
{this.input_el.un("keypress",this.on_keypress,this)
this.input_el.on("keypress",this.on_keypress,this)}}
else if(this.selected_brick_el)
{this.selected_brick_el.un("keydown",this.ext_fire_key,this);this.selected_brick_el.on("keydown",this.ext_fire_key,this);}},remove_input_listener:function()
{if(this.input_el)
{this.input_el.un("keydown",this.ext_fire_key,this);if(Ext.isGecko)
this.input_el.un("keypress",this.on_keypress,this);}
else if(this.selected_brick_el)
this.selected_brick_el.un("keydown",this.ext_fire_key,this);},find_allowed_entity_types:function()
{var schema_field=this.get_schema_field();this.entity_allowed_types=SG.schema.allowed_entity_types_for_autocomplete(schema_field);this.create_entity_allowed_types=[];for(var i=0;i<this.entity_allowed_types.length;i++)
{if(SG.schema.can_create_entity(this.entity_allowed_types[i]))
this.create_entity_allowed_types.push(this.entity_allowed_types[i]);}},array_content_equal:function(arr1,arr2)
{if(arr1.length!=arr2.length)
return false;var equal=true;for(var i=0;i<arr1.length;i++)
{if(arr2.indexOf(arr1[i])==-1)
equal=false;}
return equal;},get_project_ids:function()
{var i,project_ids=[];if(SG.schema.entity_types[this.record.get_type()].has_projects&&this.projects){for(i=0;i<this.projects.length;i++){project_ids.push(this.projects[i].id);}}
return project_ids;},set_value:function(value)
{var i,values_in;if(!value)
values_in=[];else if(value.name&&value.type&&value.id)
{values_in=[value];}
else if(value.name&&value.valid=="invalid")
{values_in=[];}
else if(typeof value.length!='undefined')
{values_in=[];var values_tmp=sg_deep_copy(value);for(i=0;i<values_tmp.length;i++){if(values_tmp[i].valid!=="invalid")
values_in.push(values_tmp[i]);}}
else
throw("Invalid value: "+Ext.encode(value));for(i=0;i<this.entities.length;i++)
{delete this.entities[i].editing;}
this.entities=values_in;this.render_into_cell();},get_value:function()
{var ret=sg_deep_copy(this.entities);for(var i=(ret.length-1);i>-1;i--)
{if(ret[i].valid=='invalid')
ret.splice(i,1);}
if(this.multiselect)
return ret;else
return ret[0];},values_equal:function(value1,value2)
{if(!this.multiselect)
return this.single_values_equal(value1,value2);if(value1!=null&&value2!=null)
{if(value1.length!=value2.length)
return false;for(var i=0;i<value1.length;i++)
if(!this.single_values_equal(value1[i],value2[i]))
return false;return true;}
else if(value1==null&&value2==null)
return true;else
return false;},single_values_equal:function(value1,value2)
{if(value1==null&&value2==null)
return true;else if(value1!=null&&value2!=null)
if(value1.valid=='invalid')
return(value2.valid=='invalid'&&value1.name==value2.name);else
return((typeof value1.id!="undefined"&&value1.type==value2.type&&value1.id==value2.id));else
return false;},validate:function(value)
{if(value instanceof Array)
{for(var i=0;i<value.length;i++)
{if(!value[i].hasOwnProperty("valid")||value[i].valid=="invalid")
return"Invalid Entity. Entity does not exist in shotgun.";}
return"valid";}
else if(value&&(!value.hasOwnProperty("valid")||value.valid=="invalid"))
{return"Invalid Entity. Entity does not exist in shotgun.";}
return"valid";},handle_other_key_events:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{switch(key_id)
{case Ext.EventObject.UP:if(!Ext.isGecko&&this.input_dom&&this.listbox)
{e.preventDefault();this.listbox.key_up_down(true);}
return;break;case Ext.EventObject.DOWN:if(!Ext.isGecko&&this.input_dom&&this.listbox)
{e.preventDefault();this.listbox.key_up_down(false);}
return;break;case Ext.EventObject.DELETE:if(this.selected_brick_dom)
{e.preventDefault();this.delete_matched_entity(e.getTarget().getAttribute('index'));return;}
break;case Ext.EventObject.BACKSPACE:case Ext.EventObject.LEFT:if(this.input_dom&&this.input_dom.selectionStart==0&&this.input_dom.selectionEnd==0&&this.current_editing_index>0)
{e.preventDefault();this.select_entity_brick(this.current_editing_index-1);return;}
else if(this.selected_brick_dom&&key_id==Ext.EventObject.BACKSPACE)
{e.preventDefault();this.delete_matched_entity(e.getTarget().getAttribute('index'));return;}
else if(this.selected_brick_dom)
{this.insert_cursor(this.current_editing_index,'left');return;}
break;case Ext.EventObject.RIGHT:if(this.input_dom&&this.input_dom.selectionStart==this.input_dom.value.length&&this.input_dom.selectionEnd==this.input_dom.value.length&&this.current_editing_index<(this.entities.length-1))
{this.select_entity_brick(this.current_editing_index+1);return;}
else if(this.selected_brick_dom&&this.current_editing_index<(this.entities.length-1))
{this.insert_cursor(this.current_editing_index,'right');return;}
break;case 188:if(this.multiselect&&this.input_dom)
{var currently_selected=this.listbox?this.listbox.find_selected():null;if(currently_selected&&!currently_selected.create_new_entity_option)
{var me=this;setTimeout(function(){me.on_listbox_item_selected(me.listbox,currently_selected);},0);return;}}
break;}
if(this.input_dom)
{if(key_id==Ext.EventObject.SHIFT)
return;var me=this;setTimeout(function(){me.input_changed()},0);return;}
if(this.selected_brick_dom)
{if([16,17,18,91,224].indexOf(key_id)>-1)
return;this.replace_brick_with_cursor(this.current_editing_index,"x");return;}},on_keypress:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:if(this.input_dom&&this.listbox)
{e.preventDefault();this.listbox.key_up_down(true);}
break;case Ext.EventObject.DOWN:if(this.input_dom&&this.listbox)
{e.preventDefault();this.listbox.key_up_down(false);}
break;}},handle_return_or_tab:function(key_id,shift_key,ctrl_or_meta_key,alt_key,e)
{var currently_selected=this.listbox?this.listbox.find_selected():null;if(currently_selected)
{if(currently_selected.create_new_entity_option)
{this.listbox.hide();this.create_new_entity_from_text(this.listbox,currently_selected);}
else
{this.on_listbox_item_selected(this.listbox,currently_selected,'dont_close');if(!this.multiselect)
{SG.GridEditor.Entity.superclass.handle_return_or_tab.call(this,key_id,shift_key,ctrl_or_meta_key,alt_key);}}}
else
SG.GridEditor.Entity.superclass.handle_return_or_tab.call(this,key_id,shift_key,ctrl_or_meta_key,alt_key);},after_revert:function()
{this.render_into_cell();this.set_editor_element_sizes();this.set_listbox_to_prompt();},selection_manager_mouse_down:function(e)
{if(this.dom)
this.all_click_listener(e);},all_click_listener:function(e)
{var target=Ext.get(e.getTarget());if(target==this.input_el)
{return;}
var click_obj=target.findParent("div.delete_matched",this.dom);if(click_obj)
{click_obj=click_obj.parentNode;this.delete_matched_entity(click_obj.getAttribute('index'));return;}
click_obj=target.findParent("div.entity_editor_matched",this.dom);if(click_obj)
{this.select_entity_brick(click_obj.getAttribute('index'));return;}
click_obj=target.findParent("div.actual_entity_editor",this.dom.parentNode);if(click_obj||target.hasClass('actual_entity_editor'))
{this.focus();return;}
click_obj=target.findParent("div.entity_editor_listbox");if(click_obj)
{this.focus();return;}
click_obj=target.findParent("div.entity_editor_new_entity_type_dialog");if(click_obj)
{this.focus();return;}
var currently_selected=this.listbox?this.listbox.find_selected():null;if(currently_selected&&!currently_selected.create_new_entity_option)
{this.entities.splice(this.current_editing_index,1,currently_selected.value);this.current_editing_index=null;}
this.fireEvent("blur",e);},blur:function()
{this.fireEvent("blur",null);},on_global_scroll:function()
{if(this.multiselect==false)
this.cancel();else
this.blur();},input_changed:function()
{this.update_input_size();this.entities[this.current_editing_index].name=this.input_dom.value;if(this.multiselect==false&&this.current_editing_index!=0)
{this.entities.splice(0,this.current_editing_index);this.render_into_cell();this.set_editor_element_sizes();this.focus();}
this.delayed_request_matches(this.input_dom.value);},delayed_request_matches:function(query_text){if(this.delayed_request_timeout)
clearTimeout(this.delayed_request_timeout);var delay=query_text.length===1?300:query_text.length===2?200:100;var me=this;this.delayed_request_timeout=setTimeout(function(){me.request_matches(query_text);},delay);},request_matches:function(query_text)
{this.stop_prompt=true;var request_params={query:query_text,sg_autocomplete:true};var rec=this.get_record();var types_and_filters=SG.schema.convert_entity_types_for_autocomplete(this.entity_allowed_types,this.get_schema_field());var link,new_filters,key,has_conditions;for(var t in types_and_filters)
{if(t==='Task'&&rec&&rec.get('entity')){link=rec.get('entity');new_filters={logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:link.type,id:link.id}]}]};if(types_and_filters[t]){has_conditions=false;for(key in types_and_filters[t]){if(types_and_filters[t].hasOwnProperty(key)){has_conditions=true;break;}}
if(has_conditions)
new_filters.conditions.push(types_and_filters[t]);}
types_and_filters[t]=new_filters;}
if(!types_and_filters.hasOwnProperty(t))
continue;this.substitute_filter_tokens(types_and_filters[t]);}
request_params.complete_classes=Ext.encode(types_and_filters);var rec_project=rec&&rec.get('project')&&rec.get('project')!='';if(this.entity_allowed_types.length==1&&this.entity_allowed_types[0]=="Project")
{;}
else if(this.parent_entity&&this.parent_entity.type=="TaskTemplate"&&["upstream_tasks","downstream_tasks"].indexOf(this.column_name)!==-1)
{;}
else if(SG.schema.entity_types[this.record.get_type()].has_projects&&rec_project)
{request_params.project_ids=Ext.encode([rec.get('project').id]);}
else if(this.projects)
{var project_ids=[];for(var i=0;i<this.projects.length;i++)
project_ids.push(this.projects[i].id);request_params.project_ids=Ext.encode(project_ids);}
var request_id=++this.autocomplete_request_id;var options={url:SG.globals.urls.entity_autocomplete,params:request_params,callback:function(options,success,response){if(request_id<this.autocomplete_request_id){return;}
if(success){response=Ext.decode(response.responseText);this.on_matches_returned(response.matches,response.terms);}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},substitute_filter_tokens:function(condition_hash)
{var single_project_id=this.projects.length===1?this.projects[0]:null;var i,j;if(condition_hash.path)
{for(i=0;i<condition_hash.values.length;i++)
{if(condition_hash.values[i])
{if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="logged_in_user_token")
{condition_hash.values[i]=SG.globals.current_user.entity_hash;}
else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="parent_entity_token")
{if(condition_hash.values[i].type===this.record.get_type())
condition_hash.values[i]={type:this.record.get_type(),id:this.record.get_id()};else if(this.parent_entity&&condition_hash.values[i].type===this.parent_entity.type)
condition_hash.values[i]=this.parent_entity;}
else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="project_token")
{var allp=SG.schema.projects;for(var j=0;j>allp.length;j++){if(allp[j].id===single_project_id){condition_hash.values[i]=allp[j];break;}}}
else if(condition_hash.values[i].date_token)
{condition_hash.values[i]=Date.sg_date_for_token(condition_hash.values[i]);}
else if(condition_hash.values[i].valid=="record_value_token")
{var rf=condition_hash.values[i].field;var sf=SG.schema.get_field(this.record.get_type(),rf);if(sf&&sf.data_type=="entity")
condition_hash.values[i]=this.record.get(rf);else
throw"Invalid record_value_token";}}}}
else if(condition_hash.conditions)
{var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
this.substitute_filter_tokens(conditions[i]);}},icon_name_for_entity:function(entity_hash)
{var icon_name='icon_'+entity_hash.type;if(entity_hash.type==="HumanUser"&&entity_hash.status==="dis")
icon_name="icon_HumanUserDisabled";return icon_name;},on_matches_returned:function(matches,search_terms)
{if(!this.now_showing)
return;if(editor.use_filter_tokens)
{for(var i=(editor.use_filter_tokens.length-1);i>-1;i--)
{var token=editor.use_filter_tokens[i];token.subtype="";var token_match=false;var token_name=token.name.toLowerCase();for(var j=0;j<search_terms.length&&!token_match;j++)
{if(token_name.indexOf(search_terms[j])>-1)
{matches.splice(0,0,token);token_match=true;}}}}
this.listbox.items=[];for(var i=0;i<matches.length;i++)
{var icon_name=this.icon_name_for_entity(matches[i]);var entity_html=this.highlight_search_terms(search_terms,matches[i].name);if(matches[i].subtype)
entity_html+=" - "+matches[i].subtype;if(matches[i].type!=='HumanUser'&&matches[i].status)
{entity_html+=" "+SG.Renderers.render_one_status_icon(matches[i].status);}
if(this.projects&&matches[i].project_id)
{var project=SG.schema.project_by_id(matches[i].project_id);if(project)
{if((SG.globals.custom_for!="guru_mudpit")||(["Asset","Shot","Element","Sequence"].indexOf(matches[i].type)===-1))
{entity_html+=' - '+project.name;}}}
var links_str='';linked_data_types=['HumanUser','ApiUser','Ticket','Delivery']
if(SG.globals.custom_for=="shotgun")
{linked_data_types.push('ZendeskTicket');}
if(SG.globals.custom_for=="pixomondovfx")
{linked_data_types.push.apply(linked_data_types,['CustomNonProjectEntity05','CustomNonProjectEntity03','Group','HumanUser']);}
if(matches[i].links&&linked_data_types.indexOf(matches[i].type)>-1)
{entity_html+=' ('+this.highlight_search_terms(search_terms,matches[i].links[1])+')';}
else
{if(matches[i].links&&matches[i].links[1]!=='')
{entity_html+=this.templates.autocomplete_results_link.apply({icon_name:"icon_"+matches[i].links[0],name:this.highlight_search_terms(search_terms,matches[i].links[1])});}}
this.listbox.items.push({icon_name:icon_name,html:entity_html,value:matches[i]});}
var text=this.input_dom.value;if(text.length==0)
{this.set_listbox_to_prompt();return;}
if(this.listbox.items.length==0&&this.create_entity_allowed_types.length==0)
{var message_html=this.templates.no_matches_found.apply({text:text});this.listbox.items.push({html:message_html,disabled:true});}
if(this.create_entity_allowed_types.length>0)
{var message_html=this.templates.create_new_entity_listbox_item.apply({text:text,message:this.listbox.items.length==0?'No matches found. ':'',});var default_item=(this.entity_allowed_types.length==1&&this.entity_allowed_types[0]=='Tag'&&this.listbox.items.length==0);this.listbox.items.push({html:message_html,item_selected:{fn:this.create_new_entity_from_text,scope:this},value:text,default_item:default_item,create_new_entity_option:true});}
if(this.listbox.items.length>0)
this.listbox.items[0].default_item=true;this.listbox.render();this.listbox.show();},highlight_search_terms:function(search_terms,result)
{var result_lc=result.toLowerCase();var idx,term,indices=[];for(var i=0;i<search_terms.length;++i)
{term=search_terms[i];idx=result_lc.indexOf(term);if(idx!==-1){indices.push([idx,idx+term.length-1]);}}
indices.sort(function(a,b){return a[0]-b[0];});if(indices.length>0)
{var combined_indices=[];var low=indices[0][0];var high=indices[0][1];idx=0;while(idx<indices.length)
{if(idx===indices.length-1)
{high=indices[idx][1];combined_indices.push([low,high]);}
else if(indices[idx][1]>=indices[idx+1][0])
{high=indices[idx+1][1];}
else
{combined_indices.push([low,high]);low=indices[idx+1][0];high=indices[idx+1][1];}
idx+=1;}
var ret=result.substring(0,combined_indices[0][0]);for(var i=0;i<combined_indices.length;++i)
{ret+='<match>'+result.substring(combined_indices[i][0],combined_indices[i][1]+1)+'</match>';if(i!==combined_indices.length-1&&combined_indices[i][1]+1<combined_indices[i+1][0])
{ret+=result.substring(combined_indices[i][1]+1,combined_indices[i+1][0]);}}
ret+=result.substring(combined_indices[combined_indices.length-1][1]+1,result.length);return ret;}
else
return result;},on_listbox_item_selected:function(listbox,item,thing)
{this.entities.splice(this.current_editing_index,1,item.value);if(this.multiselect)
{this.current_editing_index+=1;this.entities.splice(this.current_editing_index,0,{name:"",valid:'invalid',editing:true});}
else if(thing!='dont_close')
{this.fireEvent("blur",null);return;}
else
return;this.render_into_cell();this.set_editor_element_sizes();this.set_listbox_to_prompt();this.focus();},delete_matched_entity:function(index)
{this.entities.splice(index,1);this.render_into_cell();this.set_editor_element_sizes();this.focus();},select_entity_brick:function(index)
{this.remove_input_listener();for(var i=0;i<this.entities.length;i++)
{if(this.entities[i].editing)
delete this.entities[i].editing;}
this.entities[index].editing=true;this.current_editing_index=index;this.render_into_cell();this.set_editor_element_sizes();this.listbox.hide();this.focus();},insert_cursor:function(index,direction)
{var adjacent=direction=='left'?(index-1):(index+1);if(adjacent>-1&&this.entities[adjacent].valid=='invalid')
this.entities[adjacent].editing=true;else
{var insert_at=direction=='left'?index:(index+1);this.entities.splice(insert_at,0,{name:"",valid:'invalid',editing:true});}
this.render_into_cell();this.set_editor_element_sizes();this.listbox.hide();this.focus();},replace_brick_with_cursor:function(index)
{this.entities.splice(index,1,{name:'',valid:'invalid',editing:true});this.render_into_cell();this.set_editor_element_sizes();this.focus("no_select");var me=this;setTimeout(function(){me.delayed_request_matches(me.input_dom.value);},0);},create_new_entity_from_text:function(listbox,item)
{this.input_dom.blur();this.remove_click_listener();if(this.create_entity_allowed_types.length>1)
{var body_html='<div class="entity_editor_new_entity_type_menu_anchor"></div>';var entity_type_menu_items=[];for(var i=0;i<this.entity_allowed_types.length;i++)
{var type=this.entity_allowed_types[i];entity_type_menu_items.push({html:SG.schema.entity_types[type].display_name,icon_name:'icon_'+type,entity_type:type,disabled:(this.create_entity_allowed_types.indexOf(type)==-1)});}
this.new_entity_type_choice_menu=new SG.Menu({menu_class:"new_entity_type_choice_menu",items:entity_type_menu_items,item_selected:{fn:this.on_new_entity_type_choice_menu_click,scope:this},canceled:{fn:this.on_new_entity_type_choice_dialog_cancel,scope:this},non_volatile:true,position:"no_positioning"});var menu=this.new_entity_type_choice_menu;this.new_entity_type_choice_dialog=new SG.NewDialog({title:"What kind of thing are you going to create?",width:'400px',body:body_html,actions:[{label:"Cancel",callback:{fn:this.on_new_entity_type_choice_dialog_cancel,scope:this}}],new_entity_name:item.value,css_class:'entity_editor_new_entity_type_dialog',render_into_body:function(body_dom){menu.render_container=body_dom.firstChild;menu.render();menu.show();}});}
else if(this.create_entity_allowed_types[0]=='Tag')
{this.new_tag_set=new SG.Data.Set('Tag');var rec=this.new_tag_set.new_record();rec.set('name',item.value);this.new_tag_set.on('change',this.on_tag_created,this);this.new_tag_set.commit();}
else
this.show_new_entity_dialog(this.create_entity_allowed_types[0],item.value);},on_tag_created:function(something)
{var thing=something[0];if(thing.type!="create")
return;this.on_new_entity_created([thing.record]);this.add_click_listener();},on_new_entity_type_choice_dialog_cancel:function()
{this.new_entity_type_choice_menu.destroy();this.new_entity_type_choice_dialog.destroy();this.new_entity_type_choice_dialog=null;var me=this;setTimeout(function(){me.focus();},0);this.request_matches(this.input_dom.value);this.add_click_listener();},on_new_entity_type_choice_menu_click:function(menu,item,dialog,evt)
{this.new_entity_type_choice_menu.destroy();this.new_entity_type_choice_dialog.destroy();this.show_new_entity_dialog(item.entity_type,this.new_entity_type_choice_dialog.new_entity_name);this.new_entity_type_choice_dialog=null;},show_new_entity_dialog:function(entity_type,new_entity_name)
{var rec=new SG.Data.Record(entity_type);var identifier_field=SG.schema.get_identifier_field(entity_type);var identifier_field_info=SG.schema.get_field(entity_type,identifier_field);if(entity_type=='HumanUser'&&identifier_field=='name')
{var name_parts=new_entity_name.split(' ');if(name_parts.length>1)
{rec.set('lastname',name_parts.pop());rec.set('firstname',name_parts.join(' '));}
else
rec.set('firstname',new_entity_name);}
else if(identifier_field_info&&!identifier_field_info.read_only)
rec.set(identifier_field,new_entity_name);var default_project=null;if(SG.schema.entity_types[entity_type].has_projects&&this.projects.length==1)
default_project=this.projects[0];var factory_context={entity_type:entity_type,data_record:rec};var factory=new SG.EntityFactory(factory_context);factory.on("done",function(record)
{var nef_config={css_class:'entity_editor_new_entity_dialog',entity_type:entity_type,source_record:record,all_projects:this.projects,single_project:default_project};var nef=sg_new_entity_dialog(nef_config);nef.on('entity_created',this.on_new_entity_created,this);nef.on('form_canceled',this.on_new_entity_canceled,this);},this);factory.create();},on_new_entity_canceled:function()
{var me=this;setTimeout(function(){me.add_click_listener();me.focus();},0);this.request_matches(this.input_dom.value);},on_new_entity_created:function(new_recs)
{var entity={type:new_recs[0].get_type(),id:new_recs[0].get_id()};var options={url:"/crud/requests",params:{requests:Ext.encode([{request_type:"entity_hashes",entities:[entity]}])},callback:function(options,success,response){if(success)
{responses=Ext.decode(response.responseText);this.on_entity_hash_returned(responses[0].entities[0]);}
else
{this.add_click_listener();var me=this;setTimeout(function(){me.request_matches(me.input_dom.value);},0);}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},on_entity_hash_returned:function(entity_hash)
{this.entities.splice(this.current_editing_index,1,entity_hash);if(this.multiselect)
{this.current_editing_index+=1;this.entities.splice(this.current_editing_index,0,{name:"",valid:'invalid',editing:true});}
else
{this.fireEvent("blur",null);return;}
this.render_into_cell();this.set_editor_element_sizes();this.set_listbox_to_prompt();this.focus();this.add_click_listener();},});SG.GridEditor.StepList=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.StepList,SG.GridEditor.TaskTemplateList,{edit:function(context)
{this.auto_commit=context.auto_commit;SG.GridEditor.StepList.superclass.edit.call(this,context);},set_listbox_items:function()
{var entity=this.record.get('entity');this.link_entity_type=entity?entity.type:null;if(this.parent_entity&&this.parent_entity.type=='TaskTemplate'){this.link_entity_type=this.record.get('task_template.TaskTemplate.entity_type');}
this.listbox.items=[];var entity_dn;var last_item=null;if(this.link_entity_type)
{entity_dn=SG.schema.entity_types[this.link_entity_type].display_name;if(SG.globals.steps[this.link_entity_type]){this.listbox.items.push({heading:entity_dn+' Pipeline Steps'});}
if(this.auto_commit)
{last_item={html:'Manage '+entity_dn+' Pipeline...',value:'manage pipeline',item_selected:{fn:this.manage_pipeline_steps,scope:this},disabled:!SG.schema.can_create_entity('Step')};}}
var steps=this.get_steps();if(steps=='no_steps_yet')
{var entity_type_name=SG.schema.entity_types[this.link_entity_type].display_name.pluralize();var msg='<div style="color:#777; font-style: italic; padding-top: 8px; padding-bottom: 5px;">'+'No Task Pipeline Steps exist yet for <br>'+entity_type_name;if(last_item)
msg+='.  You can manage the Task Pipeline<br> by clicking on the link below.';else
msg+='.  You can manage the Task Pipeline<br> by clicking the Pipeline button on any '+
entity_type_name+' page.';msg+='</div>';this.listbox.items.push({no_steps_yet:true,disabled:true,html:msg,value:'no steps yet'});}
else
{for(var i=0;i<steps.length;i++)
{var step=steps[i];if(step.entity_type_heading)
{entity_dn=SG.schema.entity_types[step.entity_type_heading].display_name;this.listbox.items.push({heading:entity_dn+' Pipeline Steps'});}
else
{this.listbox.items.push({icon_name:'transparent_step_color',icon_bg_color:step.color,html:step.code,value:step.code,entity:{id:step.id,name:step.code,type:'Step',valid:'valid'},checked:this.initial_value&&this.initial_value.id==step.id});}}}
this.listbox.items.push({line:true});this.listbox.items.push({html:'None',value:'NONE__NO_STEP__',entity:null,checked:this.initial_value==null});if(last_item)
{this.listbox.items.push({line:true});this.listbox.items.push(last_item);}},get_steps:function()
{var steps=[];if(this.link_entity_type&&SG.globals.steps[this.link_entity_type])
steps=steps.concat(SG.globals.steps[this.link_entity_type]);else if(this.link_entity_type&&SG.schema.entity_type_has_steps(this.link_entity_type))
{return'no_steps_yet';}
else
{var entity_types=[];var schema_field=SG.schema.get_field("Task","entity");var valid_types=schema_field.allowed_entity_types.sort();var i,et;for(var i=0;i<valid_types.length;i++)
{et=valid_types[i];if(SG.globals.steps[et]){steps.push({entity_type_heading:et});steps=steps.concat(SG.globals.steps[et]);}}}
return steps;},lookup_result:function(value)
{if(value=="NONE__NO_STEP__")
return null;for(var i=0;i<this.listbox.items.length;i++)
{if(value==this.listbox.items[i].value)
{return this.listbox.items[i].entity;}}
return{name:value,valid:'invalid'};},manage_pipeline_steps:function()
{this.block_keyboard_navigation();this.fireEvent("blur");var me=this;var config={entity_type:me.link_entity_type,context_projects:me.projects};var msd=new SG.ManageStepsDialog(config);msd.on("dialog_submitted",this.on_manage_steps_dialog,this);},on_manage_steps_dialog:function(added,removed,changed)
{if(removed.length>0||changed.length>0)
{var pi=new SG.ProgressIndicator();pi.show();window.location.reload();}},make_crud_request:null,request_list:null,on_list_returned:null});SG.GridEditor.Icon=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Icon,SG.GridEditor.Text,{templates:{icon_editor:'<div class="sge_icon_editor" tabindex="-1" style="visibility: hidden;">'+'<div class="header"><img class="close_window" src="/images/close_overlay_x.png"></div>'+'<div class="body"></div>'+'</div>',icon_wrapper:'<div class="icon_wrapper {selected_class} {extra_class}">'+'<div class="retire">x</div>'+'<div class="icon" icon_id="{icon_id}" icon_name="{icon_name}">{icon_html}</div></div>',image_map_icon:'<div class="sg_status_list_map_icon {image_map_key}"></div>',image_icon:'<img src="{url}">',html_icon:'{html}',icon_editor_body:'<div class="controls"><span class="show_default_icons {default_link_class}">Default Icon Library</span>'+'<span>|</span><span class="show_custom_icons {custom_link_class}">Custom Icons</span>'+'<span class="upload_icon fake_link">[+] Upload New Icon</span></div>'+'<div class="icons_scroll"><div class="icons {mode_class}">{icons}</div></div>',upload_form:'<div class="sge_icon_editor_upload_form">'+'<form target="_sg_upload_iframe_" name="icon_upload_form" method="post" failure="" '+'enctype="multipart/form-data" before="" action="/crud/requests" '+'onsubmit="SG.globals.uploading_icon_editor.show_pi();">'+'<div class="prompt">Upload an icon</div>'+'<div class="upload_input">'+'<input type="file" name="image_file" size="38">'+'<input type="hidden" name="requests" value="">'+'<input type="hidden" name="icon_field_name" value="image">'+'<input type="hidden" name="respond_with_javascript_method_call" '+'value="SG.globals.uploading_icon_editor.on_crud_response">'+'</div>'+'<div class="advice">The image file must be png, jpg, or gif.</div>'+'<div class="advice">Transparency is okay.</div>'+'<div class="advice">For best results, use 16x16 or smaller images: larger ones '+'will be automatically resized to fit.</div>'+'<div class="upload_controls">'+'<span class="cancel_upload fake_link">Cancel</span>'+'<input type="submit" value="Upload" name="upload" disabled="true">'+'</div>'+'<span style="display: none;"><img src="/images/indicator_D6D6D6.gif"></span>'+'</form></div>',},init_templates:function()
{if(!this.templates)
return;for(var template_name in this.templates)
{if(!this.templates.hasOwnProperty(template_name))
continue;if(typeof this.templates[template_name]=="string")
{this.templates[template_name]=new Ext.Template(this.templates[template_name]);this.templates[template_name].compile();}}},init:function()
{this.superclass=SG.GridEditor.Icon.superclass;this.superclass.init.call(this);this.init_templates();this.data_set=new SG.Data.Set('Icon');this.data_set.on('load',this.on_icons_loaded,this);this.loaded=false;},render_editor:function()
{this.mode='permanent_status';this.dialog_mask=Ext.DomHelper.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.icon_editor_el=Ext.DomHelper.append(this.dialog_mask,this.templates.icon_editor.apply({}),true);this.icon_editor_body=this.icon_editor_el.child('div.body');if(!this.loaded)
this.fetch_icons();this.input_dom=this.icon_editor_el.dom;this.input_el=this.icon_editor_el;},delete_editor_html:function()
{if(!this.dialog_mask)
return;this.dialog_mask.dom.parentNode.removeChild(this.dialog_mask.dom);this.dialog_mask=null;this.icon_editor_el=null;this.icon_editor_body=null
this.input_dom=null;this.input_el=null;},render_body:function()
{if(!this.loaded)
{this.icon_editor_body.update("Loading...");return;}
var size=this.data_set.count();var records=[];for(var i=0;i<size;i++)
records.push(this.data_set.get_record(i));records.sort(function(a,b)
{var x=a.id;var y=b.id;return((x<y)?-1:((x>y)?1:0));});var images=[];var html_icons=[];for(var i=0;i<size;i++)
{var icon=records[i];if(icon.get('icon_type')!=this.mode)
continue;var icon_html,collection;switch(icon.get('display_type'))
{case'html':collection=html_icons
icon_html=this.templates.html_icon.apply({html:icon.get('html')});break;case'image':collection=images;icon_html=this.templates.image_icon.apply({url:icon.get('url')});break;case'image_map':collection=images;icon_html=this.templates.image_map_icon.apply({image_map_key:icon.get('image_map_key')});break;}
collection.push(this.templates.icon_wrapper.apply({icon_html:icon_html,icon_id:icon.get_id(),icon_name:icon.get('name'),selected_class:(this.selected_icon&&icon.get_id()==this.selected_icon.id)?'selected':''}));}
var mode_class='';if(this.mode=='custom_status'&&SG.schema.can_retire_entity('Icon'))
mode_class='custom_icon_mode';this.icon_editor_body.update(this.templates.icon_editor_body.apply({icons:images.join('')+html_icons.join(''),default_link_class:this.mode=='permanent_status'?'selected':'fake_link',custom_link_class:this.mode=='custom_status'?'selected':'fake_link',mode_class:mode_class}));},show_editor:function(cell_element)
{this.render_body();var w=this.dialog_mask.getWidth();var h=this.dialog_mask.getHeight();this.icon_editor_el.setLeft((w-500)/2);this.icon_editor_el.setTop((h-250)/2);this.dialog_mask.show();this.icon_editor_el.show();this.add_event_listeners();},cleanup:function()
{this.cleanup_upload_form();if(this.dialog_mask)
this.dialog_mask.hide();if(this.icon_editor_el)
this.icon_editor_el.hide();this.superclass.cleanup.call(this);},set_value:function(value)
{if(value)
this.selected_icon=value;else
this.selected_icon=null;},get_value:function()
{return this.selected_icon;},values_equal:function(value1,value2)
{if(value1!=null&&value2!=null)
return((typeof value1.id!="undefined"&&value1.type==value2.type&&value1.id==value2.id)||(value1.name==value2.name&&(value1.valid=="autocomplete"||value2.valid=="autocomplete")))
else if(value1==null&&value2==null)
return true;else
return false;},validate:function(value)
{if(value&&(!value.hasOwnProperty("valid")||value.valid=="invalid")){return"Invalid Entity. Entity does not exist in shotgun.";}
return"valid";},add_event_listeners:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);this.input_el.on("keydown",this.ext_fire_key,this);},remove_event_listeners:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener);if(this.input_el)
this.input_el.un("keydown",this.ext_fire_key);},all_click_listener:function(e)
{var t=e.getTarget();var ext_elem=Ext.get(t);if(ext_elem==this.input_el)
{return;}
var dialog_ok_button=ext_elem.findParent('input.sgd_submit_button',document.body);if(dialog_ok_button)return;var retire_icon=ext_elem.findParent('div.retire',this.icon_editor_body,true);if(retire_icon)
{var wrapper_div=retire_icon.findParent('div.icon_wrapper',this.icon_editor_body,true);var icon_div=wrapper_div.child('div.icon');this.retire_icon(Number(icon_div.dom.getAttribute('icon_id')));return;}
var icon=ext_elem.findParent('div.icon',this.icon_editor_body);if(icon)
{this.selected_icon={type:'Icon',id:Number(icon.getAttribute('icon_id')),valid:'valid',name:icon.getAttribute('icon_name')};this.fireEvent("blur",e);return;}
var close_window_x=ext_elem.findParent('img.close_window',this.icon_editor_el);if(close_window_x)
{this.cancel();return;}
if(ext_elem.hasClass('upload_icon'))
{this.show_upload_form();return;}
if(ext_elem.hasClass('show_default_icons'))
{if(this.mode!='permanent_status')
{this.mode='permanent_status';this.render_body();}
return;}
if(ext_elem.hasClass('show_custom_icons'))
{if(this.mode!='custom_status')
{this.mode='custom_status';this.render_body();}
return;}
var in_dialog=ext_elem.findParent('div.sge_icon_editor');if(in_dialog)
{return;}
var in_upload_dialog=ext_elem.findParent('div.sge_icon_editor_upload_form');if(in_upload_dialog)
{return;}
var in_upload_warning_dialog=ext_elem.findParent('div.sge_icon_editor_upload_form_warning_dialog');if(in_upload_warning_dialog)
{return;}},fetch_icons:function()
{var spec={type:'Icon',columns:['name','image','icon_type','display_type','image_map_key','html','url'],result:this.data_set};SG.Repo.query(spec);},on_icons_loaded:function()
{this.loaded=true;this.render_body();},show_upload_form:function()
{SG.globals.uploading_icon_editor=this;this.dh=Ext.DomHelper;this.upload_dialog_mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.upload_form_container=this.dh.append(this.upload_dialog_mask,this.templates.upload_form.apply({}),true);var w=this.upload_dialog_mask.getWidth();var h=this.upload_dialog_mask.getHeight();this.upload_form_container.setLeft((w-350)/2);this.upload_form_container.setTop((h-200)/2);this.upload_form_container.on("click",this.on_upload_form_click,this);this.upload_form_container.on("change",this.on_upload_form_change,this);SG.globals.uploading_icon_editor=this;var requests_input=this.upload_form_container.child("input[name=requests]");requests_input.dom.value=Ext.encode([{request_type:"create",type:'Icon',columns:['id','name','url'],field_values:[{column:"icon_type",value:"custom_status"},{column:"display_type",value:"image"}],upload_value_form_parameter:"image_file",entity_data_field_parameter:"uploaded_image_data"}]);},on_upload_form_click:function(e)
{var t=Ext.get(e.getTarget());var cancel=t.findParent('span.cancel_upload',this.container);if(cancel)
this.cleanup_upload_form();},on_upload_form_change:function(e)
{var t=Ext.get(e.getTarget());if(t.dom.name=="image_file")
{if(t.dom.value&&!t.dom.value.match(/.*\.((png)|(jpg)|(gif))$/))
{new SG.NewDialog({title:"File Type Not Allowed",body:"The uploaded image file ("+t.dom.value+") must be one of the following types: .png .jpg .gif ",actions:[{label:'OK'}],css_class:'sge_icon_editor_upload_form_warning_dialog'});t.dom.value='';}
if(t.dom.value)
t.dom.form.upload.disabled=false;else
t.dom.form.upload.disabled=true;}},show_pi:function()
{this.pi=new SG.ProgressIndicator(this.upload_form_container);this.pi.show();},on_crud_response:function(crud_response_array)
{this.cleanup_upload_form();var response=crud_response_array[0];if(response.status=="successful")
{this.selected_icon={type:'Icon',id:response.row[0],valid:'valid',name:response.row[1]};SG.schema.icon_list[response.row[0]]={image:true,icon:response.row[2]};this.fetch_icons();this.fireEvent("blur",null);return;}
else if(response.status=="failed")
{SG.Repo.throw_crud_error(crud_response_array);}},cleanup_upload_form:function()
{if(this.pi)
{this.pi.hide();this.pi=null;}
if(this.upload_form_container)
{this.upload_form_container.un("click",this.on_upload_form_click,this);this.upload_form_container=null;}
SG.globals.uploading_icon_editor=null;if(this.upload_dialog_mask)
{this.upload_dialog_mask.dom.parentNode.removeChild(this.upload_dialog_mask.dom);this.upload_dialog_mask=null;}},retire_icon:function(icon_id)
{this.retire_icon_id=icon_id;this.pi=new SG.ProgressIndicator(this.icon_editor_el);this.pi.show();this.status_data_set=new SG.Data.Set('Status');this.status_data_set.on("load",this.on_load_status_data_set,this);var spec={type:'Status',columns:['icon','name','code'],result:this.status_data_set};SG.Repo.query(spec);},on_load_status_data_set:function()
{this.pi.hide();var problems=[];for(var i=0;i<this.status_data_set.count();i++)
{var r=this.status_data_set.get_record(i);var icon=r.get('icon');if(icon&&icon.id&&icon.id==this.retire_icon_id)
problems.push(r.get('name'));}
if(problems.length>0)
{var st=problems.length==1?'Status':'Statuses';var html="This icon can not be deleted while it is in use by an active Status. "+"It's currently in use by the following "+st+":<br><br>"+
problems.join(",")+"<br><br>Reconfigure those Statuses to use another icon so "+"that this Icon can be deleted.";new SG.MessageDialog({sg_dialog_header_text:"Can't Delete Icon",html_msg:html});return;}
else
{var record=this.data_set.get_record_by_id(this.retire_icon_id);record.retire();this.data_set.commit(true);if(this.selected_icon&&this.selected_icon.id==this.retire_icon_id)
{var icon=this.get_first_permanent_icon();this.selected_icon={type:'Icon',id:icon.id,valid:'valid',name:''};}
this.fetch_icons();this.fireEvent("blur",null);}},get_first_permanent_icon:function()
{var icon_list=SG.schema.icon_list;var perm_icons=[];for(var icon in icon_list)
{if(icon_list.hasOwnProperty(icon)&&icon_list[icon].icon_type=='permanent_status'&&icon_list[icon].icon!=null)
perm_icons.push(icon);}
perm_icons.sort(function(a,b){var x=icon_list[a].id;var y=icon_list[b].id;return((x<y)?-1:((x>y)?1:0));});var icon=icon_list[perm_icons[0]];return icon;},});SG.GridEditor.Footage=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.Footage,SG.GridEditor.Text,{retrieve_value_from_data_store:function()
{var rec=this.get_record();var tmp_revert_val=rec.get_revert_value(this.column_name);if(tmp_revert_val===null||tmp_revert_val==="")
this.revert_value="";else
this.revert_value=SG.Footage.frames_to_footage(tmp_revert_val);this.initial_status=rec.get_status(this.column_name);var tmp_initial_val=rec.get(this.column_name);if(this.initial_status=="invalid_entry")
this.initial_value=tmp_initial_val;else if(tmp_initial_val===null||tmp_initial_val==="")
this.initial_value="";else
this.initial_value=SG.Footage.frames_to_footage(tmp_initial_val);},put_value_in_data_store:function(value,status,reason)
{var ds_value;var rec=this.get_record();var error=null;if(typeof status==="string"&&status!="valid"){error={type:status||"error",description:reason};ds_value=value;}
else if(value==="")
ds_value="";else
ds_value=SG.Footage.footage_to_frames(value);rec.set(this.column_name,ds_value,error);},values_equal:function(value1,value2)
{var v1=value1;var v2=value2;if(v1===null)v1="";if(v2===null)v2="";if(v1===v2)
return true;else if(v1!=""&&v2!=""&&this.validate(v1)=="valid"&&this.validate(v2)=="valid")
return(SG.Footage.footage_to_frames(v1)==SG.Footage.footage_to_frames(v2));else
return false;},validate:function(value)
{var max_frames=Math.round(SG.globals.preferences.frames_per_foot)-1;try{if(value==="")
return"valid";if(!/\d+-\d{1,2}/.test(value)&&!/\d+\+\d{1,2}/.test(value)&&!/\d+\'\d+\"/.test(value)&&!/^\d+\.\d+$/.test(value)&&!/^\d+$/.test(value)){throw"invalid";}
if(/\d+-\d+/.test(value)){bits=value.match(/(\d+)-(\d+)/);if(bits.length!=3){throw"invalid";}
frames=parseInt(bits[2]);if(frames>max_frames){throw"invalid";}}else if(/\d+\+\d+/.test(value)){bits=value.match(/(\d+)\+(\d+)/);if(bits.length!=3){throw"invalid";}
frames=parseInt(bits[2]);if(frames>max_frames){throw"invalid";}}else if(/\d+\'\d+\"/.test(value)){bits=value.match(/(\d+)\'(\d+)\"/);if(bits.length!=3){throw"invalid";}
frames=parseInt(bits[2]);if(frames>max_frames){throw"invalid";}}}catch(e){if(e=="invalid")
return"Invalid Footage format. Valid formats are: 10-05, 10-5, 10+05, 10+5, 10'5\", 10.3125, 165 "+"with max frames of "+max_frames;else
throw e;}
return"valid";}});SG.GridEditor.PageFolder=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.GridEditor.PageFolder,SG.GridEditor.List,{get_list:function(){return{values:[],display_values:[]};},value_for_display_value:function(display_value){return display_value;},validate:function(value){return'valid';},setup_listbox:function(){if(this.listbox){this.listbox.destroy();this.listbox=null;}
this.listbox=new SG.ListBox({items:[{disabled:true,html:"Type to find or create a folder name."}],position:{dom_elem:this.dom,elem_anchor:"bl",menu_anchor:"tl"},autocomplete:{input_dom:this.input_dom,request_url:"/autocomplete/query_page_folders",parameters_callback:{fn:function(text){return{query:text};},scope:this},selection_callback:{fn:this.on_listbox_selection,scope:this},response_callback:{fn:function(response){var items=[];for(var i=0;i<response.ResultSet.length;i++){var folder=response.ResultSet[i].folder;if(folder.indexOf('Default Layouts')!=-1)continue;items.push({html:folder,value:folder});}
return items;},scope:this},close_on_blur:true}});this.listbox.render();},});SG.Dialog=function(config){Ext.apply(this,config);this.events={'dialog_submitted':true,'dialog_cancelled':true};this.init();};Ext.extend(SG.Dialog,Ext.util.Observable,{draw_dialog:null,setup:null,submit_values:null,templates:null,init_templates:function()
{if(!this.templates)
return;for(var template_name in this.templates)
{if(!this.templates.hasOwnProperty(template_name))
continue;if(typeof this.templates[template_name]=="string")
{this.templates[template_name]=new Ext.Template(this.templates[template_name]);this.templates[template_name].compile();}}},init:function(){if(this.setup){this.setup();}
this.draw_dialog();},});SG.ModalDialog=function(config){SG.ModalDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ModalDialog,SG.Dialog,{sg_dialog_header_text:'',sg_dialog_submit_button_text:'',sg_dialog_width:'400px',sg_dialog_error_text:'An unexpected error has occurred!',sg_dialog_focus:'.sgd_cancel_link',sg_dialog_class:'',draw_body:null,draw_dialog:function(){this.dh=Ext.DomHelper;this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask '+this.sg_dialog_class},true);this.dialog=this.dh.append(this.mask,{tag:'div',cls:'sg_dialog'},true);this.dialog.setWidth(this.sg_dialog_width);this.dialog.setVisible(false);this.header=this.dh.append(this.dialog,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.dialog,{tag:'div',cls:'body'},true);this.footer=this.dh.append(this.dialog,{tag:'div',cls:'footer'},true);this.draw_header();if(this.draw_body){this.draw_body();}
this.draw_footer();var me=this;setTimeout(function(){me.centre_dialog();me.dialog.setVisible(true)},0);Ext.get(document.body).on("keypress",this.keypress,this);Ext.EventManager.onWindowResize(this.centre_dialog,this,true);this.set_focus.defer(50,this);},keypress:function(event){var key_id=event.getKey();var target=event.target;if(key_id==event.RETURN&&target.nodeName!="TEXTAREA")
{if(target.nodeName=="INPUT")
target.blur();var me=this;setTimeout(function(){me.submit();},0);}},draw_header:function(){this.header_text=this.dh.append(this.header,'<div><span class="header_text">'+
this.sg_dialog_header_text+'</span></div>');this.error_text=this.dh.append(this.header,'<div class="error_text" style="display: none;">'+
this.sg_dialog_error_text+'</div>');},set_header_text:function(new_text)
{this.header_text.firstChild.innerHTML=new_text;},restore_header_text:function()
{this.set_header_text(this.sg_dialog_header_text);},draw_footer:function(){this.cancel_link=this.dh.append(this.footer,{tag:'a','class':'sgd_cancel_link',href:'#',html:'Cancel'},true);this.submit_button=this.dh.append(this.footer,{tag:'input','class':'sgd_submit_button',type:'button',style:'text-align: center; padding-left: 20px; padding-right: 20px; margin-left: 15px;',value:this.sg_dialog_submit_button_text},true);this.cancel_link.on('click',this.cancel,this);this.submit_button.on('click',this.delayed_submit,this);},set_focus:function(){var e=Ext.fly(Ext.DomQuery.selectNode(this.sg_dialog_focus,this.dialog.id));if(e)e.focus();},centre_dialog:function(){this.dialog.setXY(this.dialog.getCenterXY(true));},delayed_submit:function(event,target,options)
{var me=this;setTimeout(function(){me.submit(event,target,options)});},submit:function(event,target,options){var success=true;if(this.submit_values){success=this.submit_values(target);}
if(success){this.destroy();}else{this.error_text.show();this.centre_dialog();}},cancel:function(e){e.stopEvent();this.destroy();},destroy:function(e){Ext.get(document.body).un("keypress",this.keypress,this);if(this.submit_button)
this.submit_button.removeAllListeners();if(this.cancel_link)
this.cancel_link.removeAllListeners();this.dialog.remove();this.mask.remove();}});SG.MessageDialog=function(config){SG.MessageDialog.superclass.constructor.call(this,config);};Ext.extend(SG.MessageDialog,SG.ModalDialog,{sg_dialog_focus:'.sgd_submit_button',sg_dialog_submit_button_text:'OK',sg_dialog_html_height:'auto',html_msg:'',draw_body:function(){var html_body='<div style="padding-right: 15px; height: '+this.sg_dialog_html_height+';">'+
this.html_msg+'</div>';this.dh.append(this.body,html_body);},draw_footer:function(){SG.MessageDialog.superclass.draw_footer.call(this);this.cancel_link.removeAllListeners();this.cancel_link.remove();},submit_values:function(){return this.fireEvent('dialog_submitted');}});SG.ConfirmDialog=function(config){SG.ConfirmDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ConfirmDialog,SG.ModalDialog,{sg_dialog_header_text:'Confirm Dialog',sg_dialog_width:'500px',sg_dialog_html_height:'250px',sg_dialog_focus:'.sgd_submit_button',sg_dialog_submit_button_text:'OK',sg_dialog_html_height:'auto',html_msg:'',draw_body:function(){var html_body='<div style="padding-right: 15px; height: '+this.sg_dialog_html_height+';">'+
this.html_msg+'</div>';this.dh.append(this.body,html_body);},draw_footer:function(){SG.ConfirmDialog.superclass.draw_footer.call(this);},submit_values:function(){return this.fireEvent('dialog_submitted');},cancel:function(e){this.fireEvent('dialog_cancelled');SG.ConfirmDialog.superclass.cancel.call(this,e);}});SG.ProjectSelectionDialog=function(config){SG.ProjectSelectionDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ProjectSelectionDialog,SG.ModalDialog,{sg_dialog_header_text:'New Entity',sg_dialog_submit_button_text:'Create',sg_dialog_focus:'#sgd_project',draw_body:function(){var project_id;var dropdown_items=[];for(var i=0;i<this.projects.length;i++){dropdown_items.push({tag:'option',html:this.projects[i].name,value:this.projects[i].id});}
dropdown_items.push({tag:'option',html:'Leave unassigned',value:-1});this.dh.append(this.body,{tag:'table',children:[{tag:'tr',children:[{tag:'td',style:'padding-top: 3px; padding-right: 10px',html:'Attach new entity to project:'},{tag:'td',children:[{tag:'select',id:'sgd_project',children:dropdown_items}]}]}]});this.project_id=Ext.DomQuery.selectNode('div.sg_dialog > div.body select#sgd_project');},submit_values:function(){return this.fireEvent('dialog_submitted',Number(this.project_id.value));}});SG.ColumnRenameDialog=function(config){SG.ColumnRenameDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ColumnRenameDialog,SG.ModalDialog,{sg_dialog_submit_button_text:'Rename Column',sg_dialog_focus:'#sgd_new_column_name',setup:function(){this.sg_dialog_header_text='Rename \''+this.default_column_display_name+'\' Column for this Page Only';},draw_body:function(){this.dh.append(this.body,{tag:'table',children:[{tag:'tr',children:[{tag:'td',style:'padding-top: 3px; padding-right: 15px',html:'Column Name (clear for default):'},{tag:'td',html:'<input autocomplete="off" type="text" value="'+this.old_column_display_name+'" id="sgd_new_column_name" onFocus="this.select();">'},]}]});this.new_column_name=Ext.DomQuery.selectNode('div.sg_dialog > div.body input#sgd_new_column_name');},submit_values:function(){return this.fireEvent('dialog_submitted',this.field_name,this.new_column_name.value,this.pivot_column_field);}});SG.EntityTypeSelectionDialog=function(config){SG.EntityTypeSelectionDialog.superclass.constructor.call(this,config);};Ext.extend(SG.EntityTypeSelectionDialog,SG.ModalDialog,{sg_dialog_submit_button_text:'Create',sg_dialog_focus:'#sgd_entity_type',setup:function(){this.entity_type_display_name=SG.schema.entity_types[this.current_entity_type].display_name;this.sg_dialog_header_text='New '+this.entity_type_display_name},draw_body:function(){var entity_types=this.get_entity_types_with_steps();var dropdown_items=[];for(var i=0;i<entity_types.length;i++){dropdown_items.push({tag:'option',html:entity_types[i].first(),value:entity_types[i].last()});}
this.dh.append(this.body,{tag:'table',children:[{tag:'tr',children:[{tag:'td',style:'padding-top: 3px; padding-right: 10px',html:'Create new '+
this.entity_type_display_name+' for entity type:'},{tag:'td',children:[{tag:'select',id:'sgd_entity_type',children:dropdown_items}]}]}]});this.new_entity_type=Ext.DomQuery.selectNode('div.sg_dialog > div.body select#sgd_entity_type');},get_entity_types_with_steps:function(){var ets_with_steps=[];var et_hash=SG.schema.entity_types;var entry;for(var i=0;i<this.valid_entity_types.length;i++){entry=et_hash[this.valid_entity_types[i]];if(entry.has_steps){ets_with_steps.push([entry.display_name,entry.name]);}}
return ets_with_steps.sort();},submit_values:function(){return this.fireEvent('dialog_submitted',this.new_entity_type.value);}});SG.AdvancedSortingDialog=function(config){SG.AdvancedSortingDialog.superclass.constructor.call(this,config);};Ext.extend(SG.AdvancedSortingDialog,SG.ModalDialog,{templates:{main:'<table>{sorts}</table>',sort_heading:'<tr><td colspan=2 align="left"><b>{label}</b></td></tr>',sort_row:'<tr><td id="{dropdown_id}"></td><td>{directions}</td></tr>',direction:'<label><input type="radio" name="direction_{index}" id="{id}" index="{index}" '+'direction="{direction}" {checked}/>{label}</label><br>'},sg_dialog_header_text:'Advanced Sorting',sg_dialog_submit_button_text:'Sort',num_sorts:3,draw_direction:function(direction,index)
{var actual_direction=this.get_direction(index,false);return this.templates['direction'].apply({id:'asd_'+direction+index,index:''+index,direction:direction,label:(direction=='asc'?'Ascending':'Descending'),checked:(direction==actual_direction)?'checked':''});},draw_body:function()
{this.init_templates();var html='';for(var i=0;i<this.num_sorts;i++)
{html+=this.templates['sort_heading'].apply({label:(i==0?'Sort first by...':'Then by:')});html+=this.templates['sort_row'].apply({dropdown_id:'asd_dropdown_'+i,directions:this.draw_direction('asc',i)+this.draw_direction('desc',i)});}
this.templates['main'].append(this.body,{sorts:html});this.menu_items.splice(0,0,{html:'(None)'},{line:true});this.menu=new SG.Menu({items:this.menu_items,item_selected:{fn:this.field_selected,scope:this}});this.menu_dropdowns=[];for(var i=0;i<this.num_sorts;i++)
{this.set_up_stuff(i);}
this.menu.render();},set_up_stuff:function(index)
{this.menu_dropdowns[index]=new SG.Menu.DropDown({menu:this.menu,container:Ext.get(this.body).child('#asd_dropdown_'+index),content:(this.sorts[index]?this.display_name(this.sorts[index].column):'(None)'),extra_class:'sgd_sort_dropdown',extra_onclick:{fn:function(dropdown,menu){menu.sort_index=index;},scope:this}});this.menu_dropdowns[index].render();Ext.get(this.body).child('#asd_asc'+index).on('change',this.direction_changed,this);Ext.get(this.body).child('#asd_desc'+index).on('change',this.direction_changed,this);},display_name:function(field_name)
{var display_name=SG.schema.get_field(this.entity_type,field_name).display_name;if(this.column_display_name_fn){display_name=this.column_display_name_fn.fn.call(this.column_display_name_fn.scope,field_name);}
return display_name;},field_selected:function(menu,item)
{if(item.html=='(None)')
{this.sorts[menu.sort_index]=null;this.menu_dropdowns[menu.sort_index].set_content(item.html);}
else
{this.sorts[menu.sort_index]={column:item.value,direction:this.get_direction(menu.sort_index,true)};this.menu_dropdowns[menu.sort_index].set_content(this.display_name(item.value));}},direction_changed:function(e)
{var target=e.getTarget();var index=Number(target.getAttribute('index'));var direction=target.getAttribute('direction');if(this.sorts[index])
this.sorts[index].direction=direction;},get_direction:function(index,check_buttons)
{if(this.sorts[index])
return(this.sorts[index].direction=='desc')?'desc':'asc';if(check_buttons)
{return Ext.get(this.body).child('#asd_desc'+index).dom.checked?'desc':'asc';}
else
return'asc';},submit_values:function()
{var sorts=[];for(var i=0;i<this.sorts.length;i++)
if(this.sorts[i])
sorts.push(this.sorts[i]);return this.fireEvent('dialog_submitted',sorts);}});SG.NewTabDialog=function(config){SG.NewTabDialog.superclass.constructor.call(this,config);};Ext.extend(SG.NewTabDialog,SG.ModalDialog,{sg_dialog_header_text:'Create New Tab',sg_dialog_submit_button_text:'Create tab',sg_dialog_focus:'#sgd_tab_name',sg_dialog_width:'500px',templates:{input_row:'<tr><td class="save_as_label">{label}</td><td>{input}</td></tr>',input_table:'<table style="margin-left: 42px;"><tbody>{rows}</tbody></table>',text_input:'<input id="{id}" type="text" value="{value}" name="name" class="save_as_input" />',option:'<option value="{value}">{label}</option>',option_icon:'<option value="{value}" style="background: url({icon}) no-repeat left center; padding-left:20px">'+'{label}</option>',option_noicon:'<option value="{value}" style="padding-left:20px">{label}</option>',option_selected:'<option selected="selected" value="{value}">{label}</option>',option_disabled:'<option disabled="disabled" value="{value}">{label}</option>',select:'<select id="{id}" name="widget_type">{options}</select>',},draw_body:function(){this.available_widgets=[{type:'SG.Widget.Fields',display:'Fields',embedded_type:null},{type:'SG.Widget.TextFields',display:'Text Fields',embedded_type:null},{type:'SG.Widget.Fields',display:'All Fields',embedded_type:null,variation:'all_fields'},{type:'SG.Widget.Text',display:'Text',embedded_type:null},{type:'SG.Widget.Iframe',display:'URL',embedded_type:null},];var types=SG.schema.leftnav_page_entity_types;for(var i=0;i<types.length;i++)
{this.available_widgets.push({type:'SG.Widget.EntityQuery.EntityQueryPage',display:SG.schema.entity_types[types[i]].display_name.pluralize(2),embedded_type:types[i]});}
this.init_templates();var h='';var rows='';var input='';var options='';var i;input=this.templates.text_input.apply({value:'New tab',id:'sgd_tab_name'});rows+=this.templates.input_row.apply({label:'Name:',input:input});input=this.templates.text_input.apply({value:'',id:'sgd_tab_description'});rows+=this.templates.input_row.apply({label:'Description:',input:input});var option_data=[];for(i=0;i<this.available_widgets.length;i++)
{var w=this.available_widgets[i];var str='';if(w.embedded_type)
{options=this.templates.option_icon.apply({value:i,label:w.display,icon:SG.globals.icons.entities[w.embedded_type]});option_data.push({label:w.display,html:options});}
else
{var non_entity_icon="";switch(w.type)
{case"SG.Widget.Fields":case"SG.Widget.TextFields":w.non_entity_icon='/images/icon_DisplayColumn.png';break;case"SG.Widget.Iframe":w.non_entity_icon='/images/icon_url.png';break;}
options=this.templates.option_icon.apply({value:i,label:w.display,icon:w.non_entity_icon});option_data.push({label:w.display,html:options});}}
options='';for(i=0;i<option_data.length;i++)
options+=option_data[i].html;input=this.templates.select.apply({options:options,id:'sgd_widget_type'});rows+=this.templates.input_row.apply({label:'Type:',input:input});h=this.templates.input_table.apply({rows:rows});this.dh.append(this.body,{tag:'div',html:h});this.body.update(h);this.tab_name_elem=this.body.child('#sgd_tab_name');this.tab_description_elem=this.body.child('#sgd_tab_description');this.widet_type_elem=this.body.child('#sgd_widget_type');this.widet_type_elem.on('change',this.on_widget_type_change,this);this.tab_name_elem.on('focus',this.on_focus_tab_name,this);this.tab_name_elem.on('keyup',this.on_keyup_tab_name,this);this.on_widget_type_change();},on_widget_type_change:function(e)
{var index=this.widet_type_elem.dom.value;var w=this.available_widgets[index];if(!Ext.isSafari)
{var background_url="";if(w.embedded_type)
background_url='url('+SG.globals.icons.entities[w.embedded_type]+')';else if(w.non_entity_icon)
background_url='url('+w.non_entity_icon+')';this.widet_type_elem.set({style:'background: '+background_url+' no-repeat left center; background-color: white; padding-left: 20px;'});}},on_focus_tab_name:function(e)
{this.tab_name_elem.dom.select();},on_keyup_tab_name:function(e)
{if(e.browserEvent.keyCode==e.ENTER)
this.submit();},submit_values:function()
{var config={};config.tab_name=this.tab_name_elem.dom.value;config.tab_description=this.tab_description_elem.dom.value;var i=this.widet_type_elem.dom.value;var w=this.available_widgets[i];config.widget_type=w.type;config.embedded_entity_type=w.embedded_type;if(w.variation)
config.widget_variation=w.variation
return this.fireEvent('dialog_submitted',config);}});SG.RenameTabDialog=function(config){SG.RenameTabDialog.superclass.constructor.call(this,config);};Ext.extend(SG.RenameTabDialog,SG.ModalDialog,{sg_dialog_header_text:'Rename tab',sg_dialog_submit_button_text:'Rename tab',sg_dialog_focus:'#sgd_tab_name',input_label:'New Tab Name:',templates:{input_row:'<tr><td class="save_as_label">{label}</td><td>{input}</td></tr>',input_table:'<table style="margin-left: 42px;"><tbody>{rows}</tbody></table>',text_input:'<input id="{id}" type="text" value="{value}" name="name" class="save_as_input" />'},draw_body:function(){this.init_templates();var h='';var rows='';var input='';input=this.templates.text_input.apply({value:this.old_tab_name,id:'sgd_tab_name'});rows+=this.templates.input_row.apply({label:this.input_label,input:input});h=this.templates.input_table.apply({rows:rows});this.dh.append(this.body,{tag:'div',html:h});this.body.update(h);this.tab_name_elem=this.body.child('#sgd_tab_name');this.tab_name_elem.on('focus',this.on_focus_tab_name,this);this.tab_name_elem.on('keyup',this.on_keyup_tab_name,this);},on_focus_tab_name:function(e)
{this.tab_name_elem.dom.select();},on_keyup_tab_name:function(e)
{if(e.browserEvent.keyCode==e.ENTER)
this.submit();},submit_values:function(){this.callback.fn.call(this.callback.scope,this.tab_name_elem.dom.value);return true;}});SG.PrintOptionsDialog=function(config){SG.PrintOptionsDialog.superclass.constructor.call(this,config);};Ext.extend(SG.PrintOptionsDialog,SG.ModalDialog,{sg_dialog_header_text:'Shotgun Page Printing Options',sg_dialog_submit_button_text:'Print',sg_dialog_focus:'',templates:{orientation:'<div><span class="sg_dialog_print_orientation_label">*Page Orientation</span>'+'<select class="sg_dialog_print_orientation_select"><option value="Portrait">Portrait</option>'+'<option value="Landscape">Landscape</option></select></div>',disclaimer:'<div class="sg_dialog_print_disclaimer">*Note: If you are printing on a OSX you need to set the '+'page orientation in Firefox first, by selecting the File->Page Setup... dialog and then choose the '+'matching orientaion here.</div>'},draw_body:function(){this.init_templates();var html=this.templates.orientation.apply();html+=this.templates.disclaimer.apply();Ext.DomHelper.append(this.body,html);this.orientation_select=this.body.child('select.sg_dialog_print_orientation_select');},submit_values:function(){return this.fireEvent('dialog_submitted',this.orientation_select.dom.value);}});SG.ColumnHeaderColorDialog=function(config){SG.ColumnHeaderColorDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ColumnHeaderColorDialog,SG.ModalDialog,{sg_dialog_header_text:'Column Header Color',sg_dialog_submit_button_text:'Ok',sg_dialog_focus:'',templates:{color_toggle:'<table><tr>'+'<td class="radio"><div class="wrapper">'+'<input class="radio" type="radio" name="color_types" value="{value}" id="{id}"></td></div>'+'<td class="icon"><img src="{color_example}" /></td>'+'</tr></table>',default_toggle:'<table><tr>'+'<td class="radio"><div class="wrapper">'+'<input class="radio" type="radio" name="color_types" value="{value}" id="{id}"></td></div>'+'<td class="icon">Shotgun color scheme</td>'+'</tr></table>',},draw_body:function(){this.init_templates();var html=this.templates.default_toggle.apply({value:i,id:'sg_column_header_color0'});for(var i=1;i<=8;i++)
{html+=this.templates.color_toggle.apply({value:i,id:'sg_column_header_color'+i,color_example:'/images/column_header_color'+i+'.png'});}
Ext.DomHelper.append(this.body,html);this.body.addClass('sg_dialog_column_header_color');var sel=0;if(this.color)
sel=Number(this.color);var toggle=this.body.child('#sg_column_header_color'+sel);toggle.dom.setAttribute('checked',true);},submit_values:function(){var sel=0;for(var i=0;i<=8;i++)
{var toggle=this.body.child('#sg_column_header_color'+i);if(toggle.dom.checked)
sel=i;}
return this.fireEvent('dialog_submitted',this.column,sel,this.pivot_column_field);}});SG.IframeConfigDialog=function(config){SG.IframeConfigDialog.superclass.constructor.call(this,config);};Ext.extend(SG.IframeConfigDialog,SG.ModalDialog,{sg_dialog_header_text:'Configure URL Widget',sg_dialog_submit_button_text:'Save',sg_dialog_focus:'.url_input',sg_dialog_width:'600px',templates:{text_input:'<table class="sgd_iframe_config_dialog"><tr><td style="width: 55px;">'+'<div style="height: 20px;line-height: 20px;">{label}</div>'+'</td><td><input type="text" value="{value}" name="name" class="{klass}" style="width: 450px;"/>'+'</td></tr><tr><td colspan="2"><div class="sg_iframe_config_dialog_message">'+'Add a url in the field above.  Read more about what you can do with URL page and tab types '+'<a href="'+SG.globals.help_urls.url_page+'" target="_blank">here</a> '+'(including url text replacement and substitution).'+'</div></td></tr></table>'},draw_body:function()
{this.init_templates();var html=this.templates.text_input.apply({label:'URL:',value:this.url,klass:'url_input',code:'{code}'});Ext.DomHelper.append(this.body,html);this.url_input_elem=this.body.child('input.url_input');},submit_values:function()
{return this.fireEvent('dialog_submitted',this.url_input_elem.dom.value);}});render_nbsp=function(value,schema_field,record)
{var rendered=this.render(value,schema_field,record);if(!rendered||rendered=="")
return"&nbsp;";else
return rendered;};SG.Renderers={renderer_defaults:{multi_entity:"multi_entity",entity:"entity",date:"date",date_time:"friendly_date_time",checkbox:"checkbox_disabled",password:"password",timecode:"timecode",currency:"currency",'float':"float",number:"number",percent:"percent",duration:"duration",status_list:"status_list",multi_status_list:"multi_status_list",system_task_type:"list",multi_system_task_type:"multi_list",list:"list",multi_list:"multi_list",image:"image",url:"url",textarea:"textarea",serializable:"json",color:'color',entity_type:'entity_type',none:"none",text:"text",footage:"footage",},text:{render:function(value){if(!value||value=="")
return"";return value;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?this.render(Ext.util.Format.stripTags(value)):"";}},text_detail_link:{render:function(value,schema_field,record)
{if(!value)
return'';if(!record)
return value;var detail_entity={type:record.get_type(),id:record.get_id(),name:value};var detail=SG.Renderers.render_one_detail_link(detail_entity);return(detail.replace('sg_detail_link','sg_detail_link sg_ticket_title'));},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value):"";}},textarea:{render:function(value){if(!value)
value="";return'<textarea readonly class="sg_grid_renderer_textarea">'+value+'</textarea>';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value):"";}},date:{render:function(value){if(!value||value=="")
return"";if(value.date_token)
return SG.GridEditor.DateParser.relative_display_values[value.relative_day];var date=SG.GridEditor.DateParser.parse(value);if(date)
return SG.GridEditor.DateParser.friendly(date);else
return value;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},friendly_date_time:{render:function(value){if(!value||value=="")
{return"";}
if(value.date_token)
return SG.GridEditor.DateParser.relative_display_values[value.relative_day];var date_time=Date.sgParseDateTime(value);if(!date_time)
return value;return SG.GridEditor.DateTimeParser.friendly(date_time);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},short_date_time:{render:function(value){if(!value||value==""){return"";}
if(value.date_token)
return SG.GridEditor.DateParser.relative_display_values[value.relative_day];var date_time=Date.sgParseDateTime(value);if(!date_time)
return value;var today=new Date();var format;if(today.getDay()==date_time.getDay()&&today.getMonth()==date_time.getMonth()&&today.getYear()==date_time.getYear()){format='h:ia';}else if(today.getYear()==date_time.getYear()){format='M d';}else{format='M d y';}
return date_time.format(format);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},long_date_time:{render:function(value){if(!value||value==""){return"";}
if(value.date_token)
return SG.GridEditor.DateParser.relative_display_values[value.relative_day];var date_time=Date.sgParseDateTime(value);if(!date_time)
return value;var today=new Date();var format;if(today.getYear()==date_time.getYear()){format='M d h:ia';}else{format='M d y h:ia';}
return date_time.format(format);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},social_date_time:{render:function(value){if(!value)
return'';var date_time=Date.sgParseDateTime(value);if(!date_time)
return value;var today=new Date();var t_delta=today-date_time;var use_tooltip=true;var text;if(t_delta<60*1000)
text='Just now';else if(t_delta<60*60*1000){var n_mins=Math.floor(t_delta/(60*1000));text=n_mins+' '+'minute'.pluralize(n_mins)+' ago';}else if(t_delta<24*60*60*1000){var n_hours=Math.floor(t_delta/(60*60*1000));text=n_hours+' '+'hour'.pluralize(n_hours)+' ago';}else{var day;if(t_delta<7*24*60*60*1000){var yesterday=today.clone();yesterday.setDate(today.getDate()-1);if(yesterday.getDate()===date_time.getDate())
text='Yesterday';else
text=date_time.format('l');}else{var format_str='j F';if(SG.globals.preferences.date_component_order==='month_day')
format_str='F j';if(today.getYear()!==date_time.getYear())
format_str+=' Y';text=date_time.format(format_str);use_tooltip=false;}
if(!value.skip_time)
text+=' at '+date_time.format('g:ia');}
if(!use_tooltip)
return'<span>'+text+'</span>';var long_date;if(SG.globals.preferences.date_component_order==='month_day')
long_date=date_time.format('F j Y');else
long_date=date_time.format('j F Y');long_date+=' at '+date_time.format('g:ia');return'<span sg_tip="'+long_date+'">'+text+'</span>';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},render_one_detail_link:function(value,include_host_and_protocol)
{if(!value)
return"";var hp='';if(include_host_and_protocol)
hp=window.location.protocol+'//'+window.location.host;var class_string="sg_detail_link";if(SG.schema.entity_types[value.type]&&SG.schema.entity_types[value.type]["has_detail_page"])
{if(value.type=='Page')
{var ret='<a href="'+hp+'/page/'+value.id+'">'+value.name+'</a>';return ret;}
else
{var ret='<a class="'+class_string+'" href="'+hp+'/detail/'+value.type+'/'+
value.id+'" sg_entity_type="'+value.type+'" sg_entity_id="'+value.id+'" ';if(value.name_override){ret+='sg_entity_name="'+value.name_override+'" ';}
ret+='>'+value.name+'</a>';return ret;}}else{return value.name;}},render_one_entity:function(value)
{var class_string="entity_valid";if('valid'in value&&value.valid=="invalid"){class_string="entity_invalid";}
var icon_class=SG.schema.entity_icon_name(value.type);if(value.type==='HumanUser'&&value.status=='dis')
icon_class='icon_HumanUserDisabled';if(value.type&&SG.schema.entity_types[value.type]&&SG.schema.entity_types[value.type]["has_detail_page"])
{class_string=class_string+" sg_detail_link";var status_icon='';if('status'in value&&value.type!=='HumanUser')
status_icon=this.render_one_status_icon(value.status);var href='<a class="'+class_string+'" href="'+'/detail/'+value.type+'/'+value.id+'" sg_entity_type="'+value.type+'" sg_entity_id="'+value.id+'" target="_blank">'+
value.name+'</a> ';return'<span><div class="sg_entity_icon_span '+icon_class+'"></div>'+
href+status_icon+'</span>';}
else
{return'<span class="'+class_string+'"><div class="sg_entity_icon_span '+icon_class+'"></div>'+
value.name+'</span>';}},render_page_entity_type:function(value,override_display_name)
{var icon_class='';var display_name='';if(value=='_canvas_'){icon_class='icon_Dashboard';display_name='Canvas';}else if(value=='_url_'){icon_class='icon_url';display_name='Url';}else{icon_class=SG.schema.entity_icon_name(value);display_name=SG.schema.entity_types[value].display_name;}
if(override_display_name)
display_name=override_display_name;return'<div class="sg_entity_icon_span '+icon_class+'"></div>&nbsp;<span>'+display_name+'</span>';},render_one_nodetail_entity:function(value)
{var class_string='class="entity_'+value.valid+'"';var icon_class=SG.schema.entity_icon_name(value.type);return'<div class="sg_entity_icon_span '+icon_class+'"></div>'+'<span '+class_string+'>'+value.name+'</span>';},render_one_basic_entity:function(value)
{return value.name;},entity:{render:function(value){return value?SG.Renderers.render_one_entity(value):"";},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.name):"";}},multi_entity:{render:function(value){if(value==null||value.length==0)
{return"";}
else
{values=[];for(var i=0;i<value.length;i++)
values.push(SG.Renderers.render_one_entity(value[i]));return values.join(',\n');}},render_nbsp:render_nbsp,render_for_attribute:function(value){if(value==null||value.length==0)
return"";else
{values=[];for(var i=0;i<value.length;i++)
values.push(SG.Renderers.entity.render_for_attribute(value[i]));return values.join(', ');}}},basic_entity:{render:function(value){return value?SG.Renderers.render_one_basic_entity(value):"";},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.entity.render_for_attribute(value);}},basic_multi_entity:{render:function(value){if(value==null||value.length==0)
{return"";}
else
{values=[];for(var i=0;i<value.length;i++)
values.push(SG.Renderers.render_one_basic_entity(value[i]));return values.join(', ');}},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.multi_entity.render_for_attribute(value);}},nodetail_entity:{render:function(value){return value?SG.Renderers.render_one_nodetail_entity(value):"";},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.entity.render_for_attribute(value);}},nodetail_multi_entity:{render:function(value){if(value==null||value.length==0)
{return"";}
else
{values=[];for(var i=0;i<value.length;i++)
values.push(SG.Renderers.render_one_nodetail_entity(value[i]));return values.join(', ');}},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.multi_entity.render_for_attribute(value);}},status_list_table:{render:function(value){var status=SG.schema.status_list[value];var html='<table><tr><td style="width: 16px; text-align:center; vertical-align: middle">'+
SG.Renderers.render_one_status_icon(value)+'</td><td>';if(!status.html)
html+=status.name;html+='&nbsp;<span style="color:#999">('+value+')</span></td></tr></table>';return html;},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.status_list_text.render(value);}},status_list:{render:function(value){return SG.Renderers.render_one_status_icon(value);},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.status_list_text.render(value);}},status_list_no_tooltip:{render:function(value){return SG.Renderers.render_one_status_icon(value,true);},render_nbsp:render_nbsp,render_for_attribute:function(value){return SG.Renderers.status_list_text.render(value);}},render_one_status_icon:function(value,no_tooltip)
{if(!value||value=="")
return"";var status_icon_hash=SG.schema.status_list[value];if(!status_icon_hash)
return value;var sg_tip;if(no_tooltip)
sg_tip="";else
sg_tip=SG.Renderers.status_list_text.render(value);return this.render_status_icon_hash(status_icon_hash,sg_tip);},render_status_icon_hash:function(status_icon_hash,tool_tip)
{if(!status_icon_hash){alert("A status icon has been changed, please reload your page to see the new icon.")
return'<i>Error</i>';}
if(status_icon_hash.image)
{return'<span class="sg_status_icon" sg_tip="'+tool_tip+'">'+
(status_icon_hash.icon?('<img src="'+status_icon_hash.icon+'">'):status_icon_hash.html)+'</span>';}
else
{var icon_html=status_icon_hash.icon?'<div class="sg_status_list_map_icon '+
status_icon_hash.icon+'"></div>':status_icon_hash.html;return'<span class="sg_status_icon" sg_tip="'+tool_tip+'">'+icon_html+'</span>';}},status_list_text:{render:function(value){if(!value||value===''){return'';}
var status=SG.schema.status_list[value];if(!status)
return value;return status.name+' ('+value+')';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},multi_status_list:{render:function(value){if(value==null||value.length==0)
{return"";}
else
{var icons=[];for(var i=0;i<value.length;i++)
icons.push(SG.Renderers.render_one_status_icon(value[i]));return icons.join(', ');}},render_nbsp:render_nbsp,render_for_attribute:function(value){return Ext.util.Format.stripTags(this.render(value));}},multi_status_list_text:{render:function(value){if(value==null||value.length==0)
{return"";}
else
{return value.join(', ');}},render_nbsp:render_nbsp,render_for_attribute:function(value){return Ext.util.Format.stripTags(this.render(value));}},icon:{render:function(value){if(!value)
return"";else
return SG.Renderers.render_status_icon_hash(SG.schema.icon_list[value.id],'');},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.name):"";}},checkbox:{render:function(value){if(!value||value==="false"){value=0;}
if(value==0){return'<input type="checkbox" />';}else{return'<input type="checkbox" checked="checked" />';}},render_nbsp:render_nbsp,render_for_attribute:function(value){return(value===true)?true:false;}},checkbox_disabled:{render:function(value){if(!value||value==="false"){value=0;}
if(value==0){return'<input type="checkbox" disabled="disabled" />';}else{return'<input type="checkbox" checked="checked" disabled="disabled" />';}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},checkbox_as_words:{render:function(value){if(!value||value==="false"){value=0;}
if(value==0){return'Unchecked';}else{return'Checked';}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},password:{render:function(value){return"******";},render_nbsp:render_nbsp,render_for_attribute:function(value){return"";}},image_url:{render:function(value){if(value){return'/thumbnail/image/'+value;}else{return"";}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value):"";}},image:{render:function(value){if(value){return'<a href="/file_serve/'+value+'" target="_blank">'+'<img class="thumbnail" src="/thumbnail/image/'+value+'"/>'+'</a>';}else{return"";}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value):"";}},entity_thumbnail:{render:function(value,schema_field,record){var detail_link_start_tag="";var detail_link_end_tag="";var entity_type=record.get_type();var entity_id=record.get_id();if(entity_id&&SG.schema.entity_types[entity_type]["has_detail_page"])
{var ident_col=SG.schema.get_identifier_field(entity_type);detail_link_start_tag='<a class="sg_detail_link" href="'+'/detail/'+entity_type+'/'+entity_id+'" sg_entity_type="'+entity_type+'" sg_entity_id="'+entity_id+'"'+' sg_entity_name="'+record.get(ident_col)+'" target="_blank">';detail_link_end_tag='</a>';}
if(value){return'<div class="thumb_fullsize_button_image" onclick="event.stopPropagation()">'+'<a href="/file_serve/'+value+'" target="_blank">'+'<img src="'+SG.globals.icons.GetFullsizeThumb+'"/>'+'</a>'+'</div>'+
detail_link_start_tag+'<img src="/thumbnail/image/'+value+'"/>'+
detail_link_end_tag;}else{return"";}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value):"";}},duration:{render:function(value){if(isNaN(Number(value)))
return value;else if(SG.globals.preferences.duration_units=="hours")
return this.duration_in_hours(value);else if(SG.globals.preferences.duration_units=="days")
return this.duration_in_days(value);else
return val;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;},duration_in_hours:function(value){if(value===''||value===null||value===undefined)
return"";value=Number(value);var rounded=Math.round((value/60)*100)/100;var is_one=(rounded===1);if(SG.globals.preferences.format_float_fields_commas)
rounded=sg_comma_format_number(rounded);return is_one?(rounded+" hr"):(rounded+" hrs");},duration_in_days:function(value){if(value===''||value===null||value===undefined)
return"";value=Number(value);var rounded=Math.round((value/(60*SG.globals.preferences.hours_per_day))*100)/100;var is_one=(rounded===1);if(SG.globals.preferences.format_float_fields_commas)
rounded=sg_comma_format_number(rounded);return is_one?(rounded+" day"):(rounded+" days");}},percent:{render:function(value){if(value!==0&&!value)
return"";if(isNaN(value))
return value;if(SG.globals.preferences.format_float_fields_commas)
value=sg_comma_format_number(value);return value+"%";},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},currency:{render:function(value){if(value===0){return"-";}else if(!value){return'';}
var number=Number(value);if(isNaN(number))
return value;var components;if(SG.globals.preferences.format_currency_fields_round)
components=[Math.round(number).toString()];else
components=number.toFixed(2).split('.');components[0]=sg_comma_format_number(components[0]);var value_str=components.join('.');if(SG.globals.preferences.format_currency_fields_dollar_sign)
value_str=value_str.replace(/^(-)*/,'$1$');if(number<0){if(SG.globals.preferences.format_currency_fields_negative_bracketed)
value_str='('+value_str.replace(/^-/,'')+')';else
value_str='-&nbsp;'+value_str.replace(/^-/,'')+'&nbsp;';}else{value_str="&nbsp;"+value_str+"&nbsp;";}
return value_str;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},'float':{render:function(value){if(value!==0&&!value)
return"";if(isNaN(value))
return value;var num=Number(value);if(SG.globals.preferences.format_float_fields_round)
num=num.toFixed();else
num=num.toFixed(SG.globals.preferences.format_float_fields_rounding);if(SG.globals.preferences.format_float_fields_commas)
return sg_comma_format_number(num);else
return String(num);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},number:{render:function(value){if(value!=0&&!value)
return"";if(isNaN(value))
return value;if(SG.globals.preferences.format_number_fields_commas)
return sg_comma_format_number(value);else
return String(value);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},timecode:{render:function(value){if(value===null||value==="")
return"";var milliseconds=Number(value);if(!milliseconds&&milliseconds!=0)
return value;var tc=SG.Timecode.seconds_to_timecode(milliseconds/1000.0);if(/^(0)/.test(tc))
{tc="<span class=\"timecode_leading_zeros\">"+tc.replace(/(^[^1-9]+)/,"$1</span>");}
return tc;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},footage:{render:function(value){if(value!=0&&!value)
return"";if(isNaN(value))
return value;var disp=parseInt(value)
if(disp){return SG.Footage.frames_to_footage(disp);}
return disp;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},password_strength:{render:function(value){var val=0;if(value)
val=value;var rating=[0,"",10,"Weak",20,"Fair",50,"Better",60,"Medium",70,"Good",90,"Strong"];var level='';for(var i=rating.length-2;i>=0;i-=2){if(val>=rating[i]){level=rating[i+1];break;}}
var helper_text='Short';if(level=="Fair")
helper_text='Weak';else if(level=="Better"||level=="Medium")
helper_text="Medium";else if(level=="Good")
helper_text="Good";else if(level=="Strong")
helper_text="Strong";return'<div class="sg_password_strength"><div class="bar '+level+'" style="width:'+val+'%"></div><div class="helper_text '+helper_text+'">'+helper_text+'</div></div>';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value;}},none:{render:function(value){return"";},render_nbsp:render_nbsp,render_for_attribute:function(value){return this.render(value);}},entity_type:{render:function(value){if(value===null||value==="")
return"";if(SG.schema.entity_types[value])
return SG.schema.entity_types[value].display_name;else
return value;},render_nbsp:render_nbsp,render_for_attribute:function(value){return this.render(value);}},page_entity_type:{render:function(value,schema_field,record){if(value===null||value==="")
{if(record){var page_type=record.get('page_type');if(page_type&&page_type=='canvas')
return SG.Renderers.render_page_entity_type('_canvas_');else if(page_type&&page_type=='url')
return SG.Renderers.render_page_entity_type('_url_');}
return"";}
return SG.Renderers.render_page_entity_type(value);},render_nbsp:render_nbsp,render_for_attribute:function(value){return this.render(value);}},list:{render:function(value,schema_field){if(schema_field.data_type=='system_task_type'){return value;}else{var list=schema_field.override_list||schema_field;if(!list)
return value;var index=list.values.indexOf(value);if(index>-1)
return list.display_values[index];else
return value;}},render_nbsp:render_nbsp,render_for_attribute:function(value,schema_field){return Ext.util.Format.stripTags(this.render(value,schema_field));}},multi_list:{render:function(value,schema_field){if(value==null||value.length==0)
{return"";}
else
{values=[];for(var i=0;i<value.length;i++)
values.push(SG.Renderers.list.render(value[i],schema_field));return values.join(', ');}},render_nbsp:render_nbsp,render_for_attribute:function(value,schema_field){return Ext.util.Format.stripTags(this.render(value,schema_field));}},url:{template_string:'<div class="sg_entity_icon_span {icon_class}"></div>{link}',render:function(value,schema_field){if(value==null)
{return"";}
else
{if(!this.template)
{this.template=new Ext.Template(this.template_string);this.template.disableFormats=true;this.template.compile();}
var template_parms=sg_deep_copy(value);template_parms.link=SG.Renderers.url_no_icon.render(value,schema_field);return this.template.apply(template_parms);}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.display_name):"";}},url_no_icon:{template_string:'<a href="{url}" {target}>{display_name}</a>',render:function(value,col){if(value==null)
{return"";}
else
{if(value.attachment_type=="local_storage")
return SG.Renderers.local_storage.render(value);if(!this.template)
{this.template=new Ext.Template(this.template_string);this.template.disableFormats=true;this.template.compile();}
var template_parms=sg_deep_copy(value);template_parms.target='target="_blank"';if(value.url&&typeof value.url=='string')
{var protocol_re=/^(\w+):\/\/\w/;var match=value.url.match(protocol_re);if(match&&(['http','https'].indexOf(match[1])==-1))
{template_parms.target='';}}
if(col.hasOwnProperty('open_in_new_window')&&col.open_in_new_window==false)
{template_parms.target='';}
return this.template.apply(template_parms);if(!this.template)
{this.template=new Ext.Template(this.template_string);this.template.disableFormats=true;this.template.compile();}
return this.template.apply(value);}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.display_name):"";}},url_icon_only:{template_string:'<img src="{icon_url}">',render:function(value){if(value==null){return"";}else{return'<img src="'+value.icon_url+'">';}},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.display_name):"";}},url_large_icon:{template_string:'<img src="{large_icon}"/><br/>{link}',render:function(value,schema_field){if(value==null)
return"";if(!this.template)
{this.template=new Ext.Template(this.template_string);this.template.disableFormats=true;this.template.compile();}
var large_icon=value.icon_url.replace('.png','_large.png');return this.template.apply({large_icon:large_icon,link:SG.Renderers.url_no_icon.render(value,schema_field)});},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.display_name):"";}},local_storage:{render:function(value){if(!value||value=="")
return"";var name=this.name(value);var local_path=this.local_path(value);if(local_path===null){return'<span class="sg_local_storage_invalid" '+'sg_tip="Local file access is not configured for your platform.">'+
name+'</span>';}
var can_do=sg_has_localfile_applet();if(!can_do){return'<span class="sg_local_storage_invalid" '+'sg_tip="Local file access is not available for your browser.">'+
name+'</span>';}
return'<span class="sg_local_storage" sg_tip="'+local_path+'">'+name+'</span>';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?this.render(Ext.util.Format.stripTags(value)):"";},name:function(value){if(value.display_name!=value.file_path)
return value.display_name;var path=sg_deep_copy(value.file_path);return this.strip_path(path);},strip_path:function(path){var platform=sg_platform();if(platform=="Windows")
path=path.replace("\\","/");var stripped=path.replace(/\/$/,'');var arr=stripped.split('/');return arr.pop()||"/";},local_path:function(value){var prefix="";var separator="/";var local_path=value.file_path;var local_storage=SG.globals.local_storages[value.local_storage_id];if(!local_storage)
return null;var platform=sg_platform();if(platform=="Mac"){if(!local_storage["mac_path"])
return null;prefix=local_storage["mac_path"].replace(/\/$/,'');}else if(platform=="Windows"){if(!local_storage["windows_path"])
return null;prefix=local_storage["windows_path"].replace(/\\$/,'');separator="\\";local_path=local_path.replace(/\//g,'\\');}else if(platform=="Linux"){if(!local_storage["linux_path"])
return null;prefix=local_storage["linux_path"].replace(/\/$/,'');}
return prefix+separator+local_path;}},json:{render:function(value){if(!value||value=="")
return"";return Ext.encode(value);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?this.render(Ext.util.Format.stripTags(value)):"";}},file_size:{render:function(value){if(!value||value=="")
return"";var file_size=Number(value);var s,size_str='';if(file_size>1048576)
{var s=Math.floor(file_size*100.0/1048576.0);size_str=(s/100.0)+' MB';}
else
{var s=Math.floor(file_size*100.0/1024.0);size_str=(s/100.0)+' KB';}
return size_str;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?this.render(Ext.util.Format.stripTags(value)):"";}},date_for_query_builder:{render:function(value){if(!value||value=="")
return"";if(value.date_token)
return SG.GridEditor.DateParser.relative_display_values[value.relative_day];var date=SG.GridEditor.DateParser.parse(value);if(date)
return SG.GridEditor.DateParser.friendly(date,true);else
return value;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},datetime_for_query_builder:{render:function(value){if(!value||value=="")
return"";if(value.date_token){var relative_day=SG.GridEditor.DateParser.relative_display_values[value.relative_day];if(value.time){var fake_date=SG.GridEditor.DateParser.get_normalized_today();fake_date.setHours(value.time[0]);fake_date.setMinutes(value.time[1]);fake_date.setSeconds(value.time[2]);return relative_day+' '+fake_date.format('h:ia');}else{return relative_day;}}
var date_time=Date.sgParseDateTime(value);if(!date_time)
return value;return SG.GridEditor.DateTimeParser.friendly(date_time);},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(this.render(value)):"";}},color:{render:function(value){if(!value||value=="")
return'<div class="color_none" '+'style="width:14px;height:14px;border:1px solid rgb(127,127,127)"></div>';if(value=='pipeline_step')
return'Pipeline Step Color';var s=value.split(',');if(!s||s.length!=3)
return"";var div_style='width:14px;height:14px;border:1px solid rgb(127,127,127);background-color: rgb('+
value+');';return'<div style="'+div_style+'" ></div>';},render_nbsp:render_nbsp,render_for_attribute:function(value){if(value)
return value;else
return'';}},image_button:{render:function(value,schema_field,record)
{if(!value||value==="false")
value=0;if(schema_field.image_button_icon_root)
{return SG.ImageButton.render({up:schema_field.image_button_icon_root+'_up',pressed:schema_field.image_button_icon_root+'_pressed',selected:schema_field.image_button_icon_root+'_selected',state:(value!=0?'selected':'up')});}
else
{return SG.ImageButton.render({up:schema_field.image_button_icons.up,pressed:schema_field.image_button_icons.pressed,selected:schema_field.image_button_icons.selected,state:(value!=0?'selected':'up')});}},render_nbsp:render_nbsp,render_for_attribute:function(value){return(value===true)?true:false;}},step_entity:{render:function(value,schema_field,record){if(!value||value=="")
return"";var entity_mismatch=false;if(record){var entity=record.get('entity');var entity_type=entity?entity.type:null;var tpl_type=record.get('task_template.TaskTemplate.entity_type');if(tpl_type)
entity_type=tpl_type;var i,steps,step=null;if(entity_type&&SG.globals.steps[entity_type])
{steps=SG.globals.steps[entity_type];step=null;for(i=0;i<steps.length;i++)
{if(steps[i].id==value.id)
{step=steps[i];break;}}}
else if(!record.render_for_query_builder)
entity_mismatch=true;}
if(step==null)
{if(entity)
entity_mismatch=true;step=SG.schema.get_step_schema(value);}
var color_swatch='';if(step)
{color_swatch='<div style="width:9px;height:9px;border:1px solid rgb(127,127,127);'+'background-color: rgb('+step.color+');display:inline-block;'+'vertical-align:bottom;margin-left:2px;margin-bottom:2px"></div>';}
var display_name=value.name;if(value.show_entity_type)
display_name+=' <span style="color: #999;">('+
SG.schema.entity_types[step.entity_type].display_name+')</span>';var h=color_swatch+'<span style="padding-left: 4px;vertical-align:bottom;">'+display_name+'</span>';if(entity_mismatch&&value.valid=='valid')
{var sg_tip="Warning: The Link entity is either missing or not the same type as this pipeline step.";var he='<div style="background-color: red" sg_tip="'+sg_tip+'">'+h+'</div>';return he;}
else
return h;},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?Ext.util.Format.stripTags(value.name):"";}},email:{render:function(value){if(!value||value=="")
return"";return'<a href="mailto:'+value+'">'+value+'</a>';},render_nbsp:render_nbsp,render_for_attribute:function(value){return value?this.render(Ext.util.Format.stripTags(value)):"";}},};SG.SummaryRenderers={status_list:function(value,extra,schema_field,value_renderer){value=value?value:'';var vals=value.split(',');var status;var index;var na_statuses=['na','',null];if(SG.globals.custom_for=='dneg'){na_statuses=['',null];}
for(var i=0;i<na_statuses.length;++i){index=vals.indexOf(na_statuses[i]);if(index!=-1){vals.splice(index,1);}}
if(SG.globals.custom_for=="framestorevfx"){var wtg_statuses=['wtg','rdy'];var fin_statuses=['cbb','cmpt','fin','apr'];var hld_statuses=['hld','omt'];for(var i=0;i<hld_statuses.length;++i){index=vals.indexOf(hld_statuses[i]);if(index!=-1){if(status===undefined){status=hld_statuses[i];}
vals.splice(index,1);}}
if(vals.length>0){status=undefined;}
if((vals.length==0)&&(status===undefined)){status='na'}else if(vals.length==1){status=vals[0];}else{if(vals.indexOf('ip')!=-1){status='ip';}else{has_wtg=false;for(var i=0;i<wtg_statuses.length;++i){index=vals.indexOf(wtg_statuses[i]);if(index!=-1){if(status===undefined){has_wtg=true;status=wtg_statuses[i];}
vals.splice(index,1);}}
if(vals.length>0){status=undefined;for(var i=0;i<fin_statuses.length;++i){index=vals.indexOf(fin_statuses[i]);if(index!=-1){if(status===undefined){if(has_wtg){status='ip';break;}else{status=fin_statuses[i];}}
vals.splice(index,1);}}
if(vals.length>0){status='ip';}}}}}else if(SG.globals.custom_for=="drd"){if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else{var vals=vals.filter(function ignoreit(e){return(['omt','clsd'].indexOf(e)==-1)});if(vals.length==1){status=vals[0];}else{if(vals.every(function checkit(ele){return this.indexOf(ele)>-1},['inv','rdy','wtg'])){status='inv';}else if(vals.every(function checkit(ele){return this.indexOf(ele)>-1},['wtg','hld'])){status='hld';}else if(vals.every(function checkit(ele){return this.indexOf(ele)>-1},['conapr','dap'])){status='conapr';}else{status='ip';}}}
if(vals.length==1){if(vals[0]=='rdy'){status='inv';}}}else if(SG.globals.custom_for=="reliance_dmil"){if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else{index=vals.indexOf('omt');if(index!=-1){vals.splice(index,1);}
if(vals.length==1){status=vals[0];}else{if(vals.every(function checkit(ele){return this.indexOf(ele)>-1},['done','fin'])){status='done';}else{status='ip';}}}}else if(SG.globals.custom_for=="blizzard"){if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else if(vals.indexOf('hld')>-1){status='hld';}else{index=vals.indexOf('omt');if(index!=-1){vals.splice(index,1);}
if(vals.length==1){status=vals[0];}else{if(vals.every(function checkit(ele){return this.indexOf(ele)>-1},['cbb','cmpt'])){status='cmpt';}else{status='ip';}}}
if(vals.length==1){if(vals[0]=='cbb'){status='cmpt';}}}else if(SG.globals.custom_for=='dneg'){if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else{ip_statuses=['ip','fbk','cmpt','apr'];intersection=vals.filter(function(ele){return ip_statuses.indexOf(ele)>-1});if(intersection.length!=0){status='ip';}else if(vals.indexOf('sch')!=-1){status='sch';}else if(vals.indexOf('asd')!=-1){status='asd';}else if(vals.indexOf('asm')!=-1){status='asm';}else if(vals.indexOf('hld')!=-1){status='hld';}else if(vals.indexOf('omt')!=-1){status='omt';}else{status='ip'}}}else if(SG.globals.custom_for=='d2'){if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else{status_order=['wtg','recd','inv','kbk','ip','rev','pin','iapr','cmpt','tfix','cbb','apr'];for(var i=0;i<status_order.length;++i){if(vals.indexOf(status_order[i])!=-1){status=status_order[i];break;}}}}else{if(vals.length==0){status='na';}else if(vals.length==1){status=vals[0];}else{index=vals.indexOf('omt');if(index!=-1){vals.splice(index,1);}
if(vals.length==1){status=vals[0];}else if(SG.globals.custom_for=="rainmaker"){var imd_fin_statuses=['kick','rev','cmpt','arm','apr','fptr','fpr','fpt','fin'];if(vals.length>imd_fin_statuses.length){status='ip';}else{for(var i=0;i<imd_fin_statuses.length;++i){index=vals.indexOf(imd_fin_statuses[i]);if(index!=-1){if(status===undefined){status=imd_fin_statuses[i];}
vals.splice(index,1);}}
if(vals.length>0){status='ip';}}}else{status='ip';}}}
return value_renderer.render(status,schema_field);},percentage:function(value,extra,schema_field,value_renderer){return(value+"% "+value_renderer.render(extra,schema_field));},status_percentage:function(value,extra,schema_field,value_renderer){if(value==-1&&schema_field.data_type=='status_list')
return value_renderer.render('na',schema_field);return(value+"% "+value_renderer.render(extra,schema_field));},record_count:function(value,extra,schema_field,value_renderer){var entity_type=SG.schema.entity_types[schema_field.entity_type];if(value==1){return"1 "+entity_type.display_name;}
else
{if(SG.globals.preferences.format_float_fields_commas)
value=sg_comma_format_number(value);return value+" "+entity_type.display_name_pluralized;}},checked:function(value,extra,schema_field,value_renderer){return value+" "+SG.Renderers.checkbox_disabled.render(1,schema_field);},unchecked:function(value,extra,schema_field,value_renderer){return value+" "+SG.Renderers.checkbox_disabled.render(0,schema_field);},none:function(value,extra,schema_field,value_renderer){return"";},count:function(value,extra,schema_field,value_renderer)
{if(SG.globals.preferences.format_float_fields_commas)
value=sg_comma_format_number(value);return value;}};SG.GroupHeadingRenderers={get_renderer:function(data_type){if(['currency','percent','duration','number','float','footage'].indexOf(data_type)>-1)
return this[data_type]||this.number;if(['date','date_time'].indexOf(data_type)>-1)
return this.date;return this.default_renderer;},default_renderer:{render:function(group,depth,grouping,schema_field,display_name){var value=group.display_values[depth];if(value==='')
value="No "+display_name;return value;}},number_group_sizes:[1,10,100,1000,10000,100000,1000000],number_groups:['ones','tens','hundreds','thousands','tensofthousands','hundredsofthousands','millions'],render_number:function(group,depth,grouping,schema_field,display_name,format_fn){var value=group.values[depth];if(value==='')
return"No "+display_name;var group_method_index=this.number_groups.indexOf(grouping[depth].method);if(group_method_index>-1){range_size=this.number_group_sizes[group_method_index];value=value*range_size;if(range_size>1){range_end=value+range_size-1;value=format_fn(String(value))+" - "+format_fn(String(range_end));}else{value=format_fn(value);}}
return value},number:{render:function(group,depth,grouping,schema_field,display_name){return SG.GroupHeadingRenderers.render_number(group,depth,grouping,schema_field,display_name,this.format)},format:function(value){return value;}},currency:{render:function(group,depth,grouping,schema_field,display_name){return SG.GroupHeadingRenderers.render_number(group,depth,grouping,schema_field,display_name,this.format)},format:function(value){return SG.Renderers.currency.render(value);},},percent:{render:function(group,depth,grouping,schema_field,display_name){return SG.GroupHeadingRenderers.render_number(group,depth,grouping,schema_field,display_name,this.format)},format:function(value){return value+'%';},},duration:{render:function(group,depth,grouping,schema_field,display_name){var value=group.template_values[depth];if(value===null)
return"No "+display_name;value=Number(value);var day_length=SG.globals.preferences.hours_per_day*60;if(grouping[depth].method==='fivedays'){var range_end=value+5*day_length;value=SG.Renderers.duration.render(String(value))+" - "+
SG.Renderers.duration.render(String(sg_decrement_duration(range_end)));}else if(grouping[depth].method==='oneday'){var range_end=value+day_length;if(value!==sg_decrement_duration(range_end)){value=SG.Renderers.duration.render(String(value))+" - "+
SG.Renderers.duration.render(String(sg_decrement_duration(range_end)));}else{value=SG.Renderers.duration.render(value);}}else{value=SG.Renderers.duration.render(value);}
return value;},},date:{render:function(group,depth,grouping,schema_field,display_name){if(grouping[depth].method==='clustered_date'){var value=group.display_values[depth];value=this.labels[value]||"No "+display_name;return value;}else{return SG.GroupHeadingRenderers.default_renderer.render(group,depth,grouping,schema_field,display_name);}},labels:{long_ago:"Long Ago",last_few_months:"Last Few Months",last_few_weeks:"Last Few Weeks",last_week:"Last Week",inclusive_last_week:"Last Week",earlier_this_week:"Earlier This Week",yesterday:"Yesterday",today:"Today",tomorrow:"Tomorrow",later_this_week:"Later This Week",this_week:"This Week",next_week:"Next Week",inclusive_next_week:"Next Week",next_few_weeks:"Next Few Weeks",next_few_months:"Next Few Months",far_future:"Far Future"}},render_footage:function(group,depth,grouping,schema_field,display_name,format_fn){var footage_per_foot=SG.globals.preferences.frames_per_foot;var value=group.values[depth];if(value===''){return"No "+display_name;}
var group_method_index=this.number_groups.indexOf(grouping[depth].method);if(group_method_index>-1){range_size=this.number_group_sizes[group_method_index];value=value*range_size;if(range_size>1){range_end=value+(range_size*footage_per_foot)-1;value=format_fn(value)+" - "+format_fn(range_end);}else{value=format_fn(value);}}
return value;},footage:{render:function(group,depth,grouping,schema_field,display_name){return SG.GroupHeadingRenderers.render_footage(group,depth,grouping,schema_field,display_name,this.format);},format:function(value){return SG.Footage.frames_to_footage(value);}},};SG.Page=function(config,context,settings){Ext.apply(this,config);this.events={'settings_changed':true,'dirty_changed':true,'show_entity_detail':true};this.init(context,settings);};SG.Page.unique_id=0;Ext.extend(SG.Page,Ext.util.Observable,{init:function(context,settings)
{var temp_page_container=sg_find('#sg_page_'+this.id);this.page_unique_container_id='sg_page_'+this.id+'_'+(++SG.Page.unique_id);temp_page_container.id=this.page_unique_container_id;this.page_container=Ext.get(temp_page_container);this.context=new SG.Widget.Context(context);if(this.project_id)
this.context.set('page_project',SG.schema.project_by_id(this.project_id));this.set_spec(new SG.Widget.Spec(this,settings));var value,spec_path,setting,key,value,valid,settings_diffs;var invalid_spec_paths=[];if(settings.user_settings){this.user_settings=settings.user_settings;for(var i=0;i<this.user_settings.length;i++){spec_path=this.user_settings[i].spec_path.split('|');if(spec_path.length===1&&spec_path[0]==="")spec_path=[];settings_diffs=this.user_settings[i].settings;if(settings_diffs.hasOwnProperty('__CHILD__')){valid=this.spec.override_child(spec_path,settings_diffs['__CHILD__']);if(!valid){invalid_spec_paths.push(this.user_settings[i].spec_path);}}
for(key in settings_diffs){if(settings_diffs.hasOwnProperty(key)&&key!='__CHILD__'){valid=this.spec.override_setting(spec_path,key,settings_diffs[key]);if(!valid){invalid_spec_paths.push(this.user_settings[i].spec_path)}}}}}else{this.user_settings=[];}
var me=this;if(invalid_spec_paths.length>0){var me=this;setTimeout(function(){me.clean_up_invalid_spec_paths(invalid_spec_paths);},500);}
if(settings.system_settings_changed){setTimeout(function(){me.system_settings_changed(settings.system_settings_changed)},1000);}
this.construct_root_widget();if(!this.parent_page)
this.setup_focus_window();SG.schema.on('reloaded',this.schema_reloaded,this);if(SG.globals.current_user.password_change_required)
this.show_change_password_dialog();},set_spec:function(spec){this.spec=spec;this.spec.is_root=true;},system_settings_changed:function(when){SG.Message.show({html:"This page's default settings have been changed. "+"<span id='settings_changed_banner' class='fake_link'>Revert to the new defaults.</span>",close_x:true,click_fn:{fn:this.on_settings_changed_banner_click,scope:this}});},on_settings_changed_banner_click:function(e){if(e.target.id=='settings_changed_banner'){SG.Message.hide();this.settings_revert();}},schema_reloaded:function()
{if(this.import_menu)
{this.import_menu.destroy();this.import_menu=null;}
if(this.new_entity_menu)
{this.new_entity_menu.destroy();this.new_entity_menu=null;}},set_dirty:function(dirty)
{if(dirty!=this.dirty)
{this.dirty=dirty;this.fireEvent("dirty_changed",dirty);}},revertable_now:function()
{return(this.dirty&&this.clean_ps_id);},settings_revert:function(done_callback){if(this.revertable_now()){var options={url:SG.globals.urls.page_revert,params:{clean_ps_id:this.clean_ps_id,user_ps_id:this.user_ps_id,},callback:function(options,success,response){if(success){this.set_spec(new SG.Widget.Spec(this,Ext.decode(response.responseText).settings));this.user_ps_id=null;this.set_dirty(false);this.user_settings=[];this.destroy_root_widget();this.construct_root_widget();if(done_callback)
done_callback.fn.call(done_callback.scope);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}},user_can_save:function()
{return SG.schema.can_save_page(this.owner_user_id,this.project_id,this.type);},user_can_save_or_revert_to_default:function()
{var ret=(SG.globals.current_user.admin&&['detail','entity_query','focus'].indexOf(this.type)!=-1);return ret;},exact_page_type:function()
{var ret={};if(this.type=='detail')
ret.page_type='detail';else if(this.type=='url')
ret.page_type='url';else if(this.type=='canvas')
ret.page_type='canvas';else
ret.page_type='entity_query';if(this.project_id)
{ret.usage='project_page';if(SG.globals.template_project&&SG.globals.template_project.id==this.project_id)
ret.usage='project_page_template';if(this.admin)
ret.usage+='_admin';}
else if(this.admin)
ret.usage='admin';else if(this.shared)
ret.usage='shared';else if(this.owner_user_id)
{if(SG.globals.template_user&&SG.globals.template_user.id==this.owner_user_id)
ret.usage='my_page_template';else
ret.usage='personal';}
else
ret.usage='global';return ret;},saveable_now:function()
{if(this.id&&this.dirty)
return this.user_can_save();else
return false;},settings_save:function(successful_save_message){if(this.check_for_filter_panels_with_active_custom_filters())return;if(this.saveable_now())
{var options={url:SG.globals.urls.page_save,params:{clean_ps_id:this.clean_ps_id,user_ps_id:this.user_ps_id,id:this.id,settings:Ext.encode(this.spec.to_hash())},callback:function(options,success,response){if(success){var resp=Ext.decode(response.responseText);this.clean_ps_id=resp.clean_ps_id;this.updated_at=resp.updated_at;this.user_ps_id=null;this.set_dirty(false);this.user_settings=[];if(successful_save_message)
SG.Message.show({html:successful_save_message,close_x:true});}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}},check_for_filter_panels_with_active_custom_filters:function(){var widgets=[];this.find_all_entity_query_page_widgets(this.root_widget,widgets);for(var i=0;i<widgets.length;i++){var filter_panel=widgets[i].get_filter_panel_component();if(filter_panel&&filter_panel.has_saved_filters()){var msg='Page can not yet be saved with a "Personal Custom" filter.\n\n'+'Please disable the custom filter in the filter panel and try saving again.';alert(msg);return true;}}
return false;},find_all_entity_query_page_widgets:function(widget,entity_query_page_widgets){if(widget.get('type')=='SG.Widget.EntityQuery.EntityQueryPage'){entity_query_page_widgets.push(widget);}
var children=widget.get_child_widgets();for(var i=0;i<children.length;i++)
this.find_all_entity_query_page_widgets(children[i],entity_query_page_widgets);},settings_save_as_global_default:function()
{var options={url:SG.globals.urls.page_save_as_default,params:{id:this.id,clean_ps_id:this.clean_ps_id,user_ps_id:this.user_ps_id,dirty:this.dirty},callback:function(options,success,response){if(success){this.user_ps_id=null;this.set_dirty(false);this.user_settings=[];}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},settings_revert_to_global_default:function(dirty_on_response)
{if(!dirty_on_response)dirty_on_response=false;var options={url:SG.globals.urls.page_revert_to_default,params:{id:this.id,clean_ps_id:this.clean_ps_id,user_ps_id:this.user_ps_id,},callback:function(options,success,response){if(success){var response=Ext.decode(response.responseText);this.set_spec(new SG.Widget.Spec(this,response.settings));this.user_ps_id=null;this.set_dirty(dirty_on_response);this.user_settings=[];this.destroy_root_widget();this.construct_root_widget();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},settings_save_as_show_dialog:function()
{if(this.check_for_filter_panels_with_active_custom_filters())return;var spad=new SG.SavePageAsDialog({page:this,on_create_page:{fn:this.settings_save_as,scope:this}});},show_rename_page_dialog:function()
{var config={sg_dialog_header_text:'Rename Page',sg_dialog_submit_button_text:'Rename Page',input_label:'New Page Name:',old_tab_name:this.name,callback:{fn:this.rename_page,scope:this}}
var rtp=new SG.RenameTabDialog(config);},rename_page:function(new_name)
{var new_page_name=new_name.strip();if(new_page_name!='')
{var options={url:'/page/rename',params:{id:this.id,name:new_page_name},callback:function(options,success,response){if(success)
eval(response.responseText);else
var sed=SG.server_error({connection_response:response});},scope:this};var conn=new Ext.data.Connection();conn.request(options);}
else
{alert('Page name cannot be empty');}},clean_folder:function(folder)
{folder=folder.split('->');var clean_folder=[];for(var i=0;i<folder.length;i++)
{if(folder[i].strip())
clean_folder.push(folder[i].strip());}
return clean_folder.join('->');},settings_save_as:function(new_record,no_design_on_load){var new_page_name=new_record.get('name').strip();var project=new_record.get('project');var project_id=(SG.globals.current_user.can_save_as_project_page&&project)?project.id:null;var tag_list=new_record.get('tag_list')||[];if(!SG.globals.current_user.can_save_as_project_page&&this.project_id)
context_project_id=this.project_id
else
context_project_id=null;var local_no_design_on_load=no_design_on_load;if(new_page_name){var options={url:SG.globals.urls.page_save_as,params:{id:this.id,user_ps_id:this.user_ps_id,name:new_page_name,description:new_record.get('description'),project_id:project_id,context_project_id:context_project_id,tag_list:Ext.encode(tag_list),folder:new_record.get('folder'),settings:Ext.encode(this.spec.to_hash())},callback:function(options,success,response){if(success){if(!local_no_design_on_load){var regex=/\d+/;var page_id=Number(regex.exec(response.responseText)[0]);setCookie("design_page_on_load",page_id,365);}
eval(response.responseText);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}},settings_batch_interval:200,on_settings_changed:function(change_hash,source_widget,source_spec){if(this.page_has_no_temp_settings)
{this.set_dirty(true);this.settings_save();return;}
if(change_hash){var spec_path=source_spec.spec_path().join('|');var copied=false,key;for(var i=0;!copied&&i<this.user_settings.length;i++){if(this.user_settings[i].spec_path==spec_path){for(key in change_hash){if(change_hash.hasOwnProperty(key)){this.user_settings[i].settings[key]=change_hash[key];copied=true;}}}}
if(!copied){this.user_settings.push({spec_path:spec_path,settings:change_hash});this.user_settings.sort(function(a,b){return(a.spec_path>b.spec_path?1:a.spec_path<b.spec_path?-1:0);});}}
if(this.settings_batch_timer_id){clearTimeout(this.settings_batch_timer_id);this.settings_batch_timer_id=null;}
var me=this;this.settings_batch_timer_id=setTimeout(function(){me.save_user_settings();},this.settings_batch_interval);},save_user_settings:function(){var design_mode=this.context.get('design_mode');if(this.id&&!this.block_sending_settings&&!design_mode)
{var options={url:SG.globals.urls.page_save_user_temporary_settings,params:{user_ps_id:this.user_ps_id,id:this.id,settings:Ext.encode(this.user_settings)},callback:function(options,success,response)
{if(success)
{this.user_ps_id=Ext.decode(response.responseText).user_ps_id;this.set_dirty(true);}
else
{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}},clean_up_invalid_spec_paths:function(invalid_spec_paths){var i,j;for(i=0;i<invalid_spec_paths.length;i++){for(j=0;j<this.user_settings.length;j++){if(invalid_spec_paths[i]==this.user_settings[j].spec_path){this.user_settings.splice(j,1);break;}}}
this.save_user_settings();},get_widget_id:function()
{return 0;},get_container:function()
{return this.page_container;},rerender:function()
{this.destroy_root_widget();this.construct_root_widget();},construct_root_widget:function()
{this.spec.parent_object=this;this.root_widget=SG.Widget.Factory.construct_widget(this,this.context,this.spec);if(this.root_widget)
{if(this.context.get('inside_window')===true)
this.page_container.addClass(this.root_widget.get_css_class_name());else
{SG.NotificationCenter.post({uuid:'global_nav',name:'page_constructed',args:{page:this},canvas_id:null});}
this.root_widget.container_id=this.page_unique_container_id;this.root_widget.render();this.root_widget_container=this.root_widget.get_container();this.root_widget_container.on('click',this.on_bubbled_click,this);}},destroy_root_widget:function(){if(this.root_widget){this.root_widget_container.un('click',this.on_bubbled_click);this.root_widget.destroy();this.root_widget=null;SG.NotificationCenter.post({uuid:'global_nav',name:'page_destroyed',args:{page:this,new_page:this.parent_page},canvas_id:null});}},on_bubbled_click:function(e){var target=Ext.get(e.getTarget());var parent=target.findParent('.sg_detail_link',document.body,true);if(parent&&e.ctrlKey==false){var entity_type=parent.dom.getAttribute('sg_entity_type');var entity_id=parent.dom.getAttribute('sg_entity_id');var entity_name=parent.dom.text;var override_name=parent.dom.getAttribute('sg_entity_name');if(override_name)entity_name=override_name;if(this.context.get('block_navigation')){e.stopEvent();SG.Menu.cancel_current();alert("Navigation is not supported in design mode.");}
else if(entity_type=="Project"){}
else if(this.enable_detail_links){}
else if(this.parent_page){e.stopEvent();SG.Menu.cancel_current();if(SG.Page.unsaved_data.confirm_proceed())
{this.fireEvent('show_entity_detail',entity_type,entity_id,entity_name);}}
else if(this.root_widget.show_entity_detail){e.stopEvent();SG.Menu.cancel_current();this.get_focus_window().close();if(SG.Page.unsaved_data.confirm_proceed())
{this.root_widget.show_entity_detail(entity_type,entity_id,entity_name);}}}
var local_storage=target.findParent('span.sg_local_storage',document.body);if(local_storage){sg_open_localfile(local_storage.getAttribute('sg_tip'));e.stopEvent();}},handle_link_click:function(container,ext_event,opt_target_ext_elem,opt_link_dom_elem){var t=opt_target_ext_elem||Ext.get(ext_event.getTarget());var link=opt_link_dom_elem||t.findParent('a',container);if(link){var dom_event=ext_event.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;if(ctrl_click)
return'context_click';this.root_widget.show_loading_overlay();return'click';}
return false;},setup_focus_window:function()
{this.focus_window=new SG.FocusWindow({parent_page:this});},get_focus_window:function()
{if(this.parent_page){return this.parent_page.get_focus_window();}else{return this.focus_window;}},get_page_url:function()
{var entity=this.context.get('entity');if(entity)
return"/detail/"+entity.type+"/"+entity.id;else
return"/page/"+this.id;},get_favorite:function()
{return this.is_favorite;},toggle_favorite:function(is_favorite)
{this.is_favorite=!this.is_favorite;SG.Repo.update({type:"Page",id:this.id,column:'current_user_favorite',value:this.is_favorite,no_undo:true});},show_change_password_dialog:function(){var dialog=new SG.ChangePasswordDialog({user_id:SG.globals.current_user.id,opaque_dialog_mask:true});},});SG.Page.unsaved_data={__unsaved_data:[],add:function(item){if(this.__unsaved_data.indexOf(item)==-1)
this.__unsaved_data.push(item);},remove:function(item){var index=this.__unsaved_data.indexOf(item);if(index>-1)
this.__unsaved_data.splice(index,1);},has_unsaved_data:function(){if(this.__unsaved_data.length==0)
return false;var unsaved=false;for(var i=0;i<this.__unsaved_data.length;i++){if(typeof this.__unsaved_data[i].has_unsaved_data!='function'||this.__unsaved_data[i].has_unsaved_data())
unsaved=true;}
return unsaved;},unsaved_data_containers:function(){if(this.__unsaved_data.length==0)
return[];var unsaved=[];for(var i=0;i<this.__unsaved_data.length;i++){if(typeof this.__unsaved_data[i].has_unsaved_data!='function'||this.__unsaved_data[i].has_unsaved_data()){unsaved.push(this.__unsaved_data[i]);}}
return unsaved;},confirm_proceed:function(alternate_dialog_text){if(this.has_unsaved_data()){var dialog_text=alternate_dialog_text?alternate_dialog_text:"You have entered text on "+"this page. If you choose to continue, you may lose unsaved changes.";return confirm(dialog_text);}
return true;}};Ext.lib.Event.on(window,'beforeunload',function(e){if(SG.Page.unsaved_data.has_unsaved_data()){SG.globals.page.root_widget.hide_loading_overlay();setTimeout(function(){SG.Message.hide();});SG.in_unload=false;var message="You have entered some text on this page. If you choose to proceed you will lose your changes.";if(e)
e.returnValue=message;return message;}});SG.Toolbar=function(config)
{Ext.apply(this,config);SG.Toolbar.superclass.constructor.call(this);};Ext.extend(SG.Toolbar,SG.Component,{templates:{toolbar:'<div class="main">{items}<div style="clear: both;"></div></div>',item:'<div item_index="{index}" style="float: {position}" class="toolbar_item {toggle} {extra}" '+'sg_tip="{sg_tip}">{html}</div>',toolbar_spacer:'<div class="toolbar_divider"></div>'},init_component:function()
{this.toolbar_items=[];this.add_event(this.container,'click',this.on_toolbar_event);this.add_event(this.container,'change',this.on_toolbar_event);this.add_event(this.container,'contextmenu',this.on_toolbar_event);},render:function()
{var left_html='';var right_html='';var it=this.templates.item;var spacer=this.templates.toolbar_spacer.apply();var container_width=this.container.getWidth();for(var i=0;i<this.toolbar_items.length;i++)
{var item=this.toolbar_items[i];if(this.size_threshold!=undefined&&container_width<this.size_threshold&&!item.visible_when_small)
continue;var html;if(item.html=='_SPACER_')
html=spacer;else if(item.render_callback!=undefined)
{var entities=this.selected_entities?this.selected_entities:[];html=item.render_callback.fn.call(item.render_callback.scope,entities,item);}
else if(item.disabled)
html=item.html_disabled
else
html=item.html
var toggle=item.toggle_on_entity_selection?'toggle_on_selection':'';var extra=item.cls?item.cls:'';var sg_tip=item.sg_tip?item.sg_tip:'';if(this.size_threshold!=undefined&&container_width<this.size_threshold&&item.visible_when_small)
extra+=' small';if(!item.position||item.position=='left')
{left_html+=it.apply({index:i,html:html,position:'left',extra:extra,toggle:toggle,sg_tip:sg_tip});}
else
{right_html+=it.apply({index:i,html:html,position:'right',extra:extra,toggle:toggle,sg_tip:sg_tip});}}
this.container.update(this.templates.toolbar.apply({items:left_html+right_html}));},entity_selection_changed:function(selected_entities)
{this.selected_entities=selected_entities;var nothing_selected=selected_entities.length==0;var toolbar_item_divs=Ext.DomQuery.select('div.toggle_on_selection',this.container.dom);for(var i=0;i<toolbar_item_divs.length;i++)
{var div=Ext.get(toolbar_item_divs[i]);var index=Number(div.dom.getAttribute('item_index'));var item=this.toolbar_items[index];var html;if(item.render_callback!=undefined)
html=item.render_callback.fn.call(item.render_callback.scope,selected_entities);else
{item.disabled=nothing_selected||(item.enable_on_single_selection_only&&selected_entities.length>1);if(item.disabled)
html=item.html_disabled;else
html=item.html;}
div.update(html);}},add_item:function(toolbar_item_hash)
{this.toolbar_items.push(toolbar_item_hash);},add_items:function(items)
{for(var i=0;i<items.length;i++)
this.add_item(items[i]);},on_toolbar_event:function(e)
{if(e.type==='click'&&e.ctrlKey){puts('ignoring ctrl click event');return;}
var t=Ext.get(e.getTarget());var toolbar_item_div=t.findParent('div.toolbar_item',this.container,true);if(toolbar_item_div)
{var item_index=Number(toolbar_item_div.dom.getAttribute('item_index'));var item=this.toolbar_items[item_index];var callback=item['on'+e.type];var disabled=false;if(item.disabled&&item.disabled===true)
disabled=true;if(callback&&!disabled)
{callback.fn.call(callback.scope,e,toolbar_item_div);if(e.type=='contextmenu')
e.stopEvent();}}},scroll_left:function()
{var scroll_wrap=this.container.child('div.scroll_wrap');scroll_wrap.scroll('right',100,true);var me=this;setTimeout(function(){me.update_scroll_buttons();},500);},scroll_right:function()
{var scroll_wrap=this.container.child('div.scroll_wrap');scroll_wrap.scroll('left',100,true);var me=this;setTimeout(function(){me.update_scroll_buttons();},500);},update_scroll_buttons:function()
{var scroll_wrap=this.container.child('div.scroll_wrap');if(!scroll_wrap)return;var tab_edge=this.container.child('td.tab_edge');var left_scroll_button=this.container.child('div.left_scroll');var right_scroll_button=this.container.child('div.right_scroll');var pos_w=Ext.lib.Dom.getXY(scroll_wrap.dom);var pos_e=Ext.lib.Dom.getXY(tab_edge.dom);var width=scroll_wrap.getWidth();var o=parseInt(scroll_wrap.dom.scrollLeft,10)||0;if(o==0)
left_scroll_button.replaceClass('enabled','disabled');else
left_scroll_button.replaceClass('disabled','enabled');if(pos_e[0]<(pos_w[0]+width))
right_scroll_button.replaceClass('enabled','disabled');else
right_scroll_button.replaceClass('disabled','enabled');},});SG.Footer=function(config)
{Ext.apply(this,config);SG.Footer.superclass.constructor.call(this);};Ext.extend(SG.Footer,SG.Component,{templates:{center_record_count:'<center>{contents}</center>',left_record_count:'<div class="record_count" style="float: left;">{contents}</div>',paging_controls:'<img src="/images/left_arrow_{prev_enabled}.png" class="arrow {prev_enabled}" page="{prev_page}"/>'+'{page_span}'+'<input type="text" name="paging_input" class="entity_list_paging_input {input_enabled}" '+' value="{current_page}" page_count="{page_count}" onFocus="this.select();" '+'style="width:{width}px;"/>'+'<span class="page_count"> / {page_count}</span>'+'<img src="/images/right_arrow_{next_enabled}.png" page="{next_page}" class="arrow {next_enabled}"/>',page_span:'<span class="page">Page</span>',records_control:'<span class="records_control"><img src="/images/vert_divider.png" class="divider"/><span class="target">'+'{label}<img src="/images/dropdown_arrow_small.png" class="dropdown"/></span>'+'{right_divider}</span>',divider:'<img src="/images/vert_divider.png" class="divider"/>',right_controls:'<div class="paging_controls fixed">{records_control}{paging_controls}</div>',page_fader:'<div style="opacity:0.8" class="sg_pagination_fader"><span class="message">{message}</div>',left_control:'<div class="left_control {extra_cls}">'+'<div class="filter_panel_footer {open_close}">'+'<div class="filter_panel_more_fields" style="width: {filter_panel_footer_width}px;">'+'<span>More Filters</span><div class="dropdown_arrow_small"></div></div>'+'<div class="filter_panel_open_close_wrapper">'+'<div class="filter_panel_open_close {icon_class}"></div></div>'+'</div>'+'<div class="content_left_controls"></div>'+'</div>',float_right_control:'<div class="float_right {extra_cls}">{contents}</div>',end_controls:'<div style="clear: both;"></div>',},init_component:function()
{if(this.data_store)
{this.add_event(this.data_store,'load',this.render);this.add_event(this.data_store,'add',this.render);this.add_event(this.data_store,'add_to_group',this.render);this.add_event(this.data_store,'prune',this.render);}
this.add_event(this.container,'click',this.on_footer_click);this.add_event(this.container,'contextmenu',this.on_footer_click);this.add_event(this.container,'change',this.on_footer_change);Ext.EventManager.onWindowResize(this.on_window_resize,this);var widget_wrapper=this.container.findParent('div.sgw_canvas_wrapper');this.on_canvas=!(widget_wrapper==null);if(!this.size_threshold)this.size_threshold=500;},on_window_resize:function()
{this.render(true);},render:function(no_page_fader)
{var container_width=this.container.getWidth();this.render_small=container_width<this.size_threshold;this.extra_left_controls_callback=this.entity_query_page.get_left_footer_render_callback();var h=this.render_left_control();if(this.data_store)
{h+=this.render_record_count();h+=this.render_paging_controls();if(this.on_canvas)
h+=this.templates.end_controls.apply();this.container.update(h);if(!no_page_fader)
this.render_page_fader();}
else
this.container.update(h);this.update_left_control();},render_page_fader:function()
{var paging_info=this.data_store.get_paging_info();var page_count=paging_info.page_count;if(page_count>1)
{var cur_page=paging_info.current_page;var dh=Ext.DomHelper;var message='Page '+this.format_number(cur_page)+' of '+this.format_number(page_count);var parent_container=Ext.get(this.container.dom.parentNode);var widget_width=parent_container.getWidth();var widget_height=parent_container.getHeight();var left=((widget_width-150)/2);var top=((widget_height-85)/2);var fader=dh.append(parent_container,this.templates.page_fader.apply({message:message}),true);fader.setTop(top);fader.setLeft(left);setTimeout(function(){fader.fadeOut({remove:true,duration:1.5,easing:'easeOut'});},1000);}},render_left_control:function()
{return this.templates.left_control.apply({extra_cls:this.on_canvas?'float':'fixed',icon_class:this.entity_query_page.filter_panel_is_open()?'leftnav_close':'leftnav_open_button',open_close:this.entity_query_page.filter_panel_is_open()?'':'filter_panel_footer_closed',filter_panel_footer_width:this.entity_query_page.filter_panel_width});},update_left_control:function()
{var filter_panel_footer_elem=Ext.get(sg_find('div.filter_panel_footer',this.container.dom));var open_close=Ext.get(filter_panel_footer_elem.dom.firstChild.nextSibling.firstChild);if(this.entity_query_page.filter_panel_is_open()){filter_panel_footer_elem.removeClass('filter_panel_footer_closed');open_close.addClass('leftnav_close');open_close.removeClass('leftnav_open_button');}else{filter_panel_footer_elem.addClass('filter_panel_footer_closed');open_close.addClass('leftnav_open_button');open_close.removeClass('leftnav_close');}
if(this.extra_left_controls_callback){elem=this.container.child('div.content_left_controls');this.extra_left_controls_callback.fn.call(this.extra_left_controls_callback.scope,elem,this.render_small);}},format_number:function(num)
{return sg_comma_format_number(num);},on_footer_click:function(e)
{var t=Ext.get(e.getTarget());var prev_next=t.findParent('img.arrow',this.container,true);if(prev_next&&prev_next.hasClass('enabled'))
{var page=Number(prev_next.dom.getAttribute('page'));this.entity_query_page.set_data_store_page(page);return;}
var records_span=t.findParent('span.records_control',this.container);if(records_span)
{if(e.type=='contextmenu')e.stopEvent();this.show_records_menu(records_span);return;}
if(t.hasClass('filter_panel_open_close')){if(this.entity_query_page.filter_panel_is_open())
this.entity_query_page.close_filter_panel();else
this.entity_query_page.open_filter_panel();return;}
var filter_panel_more_fields=t.findParent('div.filter_panel_more_fields',this.container);if(filter_panel_more_fields){this.entity_query_page.show_filter_panel_more_fields_menu(filter_panel_more_fields);}},show_records_menu:function(records_span)
{if(!this.records_menu)
{this.records_menu=this.new_component(SG.Menu,{item_selected:{fn:this.on_records_menu_click,scope:this}});}
var records_per_page=this.data_store.get_paging_info().records_per_page;this.records_menu.items=[{html:'25 - Fastest',value:25,checked:(records_per_page==25)},{html:'50 - Fast',value:50,checked:(records_per_page==50)},{html:'75 - Medium',value:75,checked:(records_per_page==75)},{html:'100 - Slow',value:100,checked:(records_per_page==100)},{html:'200 - Slowest',value:200,checked:(records_per_page==200)},{html:'All Results',value:5000,checked:(records_per_page==5000)},];this.records_menu.render();this.records_menu.position={dom_elem:records_span,elem_anchor:'t',menu_anchor:'b'};this.records_menu.show();},on_records_menu_click:function(menu,item)
{this.entity_query_page.set_data_store_max_records(item.value);},on_footer_change:function(e)
{var t=Ext.get(e.getTarget());var page_input=t.findParent('input.entity_list_paging_input',this.container);if(page_input)
{var page_count=page_input.getAttribute('page_count');var page=Number(page_input.value);if(page>page_count||page<1)
{alert("Page "+page+" is out of range.");return;}
else
this.entity_query_page.set_data_store_page(page);}},render_record_count:function()
{var html='';var ds=this.data_store;var records_on_page=ds.count();if(records_on_page==0)
return"&nbsp;";if(this.data_store.footer_wait_for_grouped_summaries&&!this.data_store.group_summaries)
return"&nbsp;";var entity_type_schema=SG.schema.entity_types[ds.entity_type];var paging_info=ds.get_paging_info();if(paging_info.current_page&&records_on_page>1)
{var total_records=paging_info.record_count;if(this.data_store.group_summaries)
{total_records=0;for(var i=0;i<this.data_store.group_summaries.length;i++)
total_records+=Number(this.data_store.group_summaries[i].summaries[0].value);}
var entity_type_name=this.render_small?'':(total_records==1?entity_type_schema.display_name:entity_type_schema.display_name_pluralized);var start_record=((paging_info.current_page-1)*paging_info.records_per_page)+1;var end_record=(paging_info.current_page*paging_info.records_per_page);if(records_on_page==total_records)
end_record=total_records;if(end_record>total_records)
end_record=total_records;if(!this.data_store.group_summaries)
html=this.format_number(start_record)+' - '+this.format_number(end_record)+' of '+this.format_number(total_records)+' '+entity_type_name;else
{var group_word="Group";group_word=group_word.pluralize(this.data_store.group_summaries.length);html=paging_info.record_count+" "+entity_type_name+", "+
this.data_store.group_summaries.length+" "+group_word+", "+
this.format_number(start_record)+' - '+this.format_number(end_record)+' of '+this.format_number(total_records)+' Records'}}
else
html=this.format_number(records_on_page)+' of '+this.format_number(records_on_page)+' '+
(records_on_page==1?entity_type_schema.display_name:entity_type_schema.display_name_pluralized);if(this.on_canvas)
return this.templates.left_record_count.apply({contents:html});else
return this.templates.center_record_count.apply({contents:html});},render_paging_controls:function()
{var paging_info=this.data_store.get_paging_info();var cur_page=paging_info.current_page;var page_count=paging_info.page_count;if(this.data_store.group_summaries)
{var total_records=0;for(var i=0;i<this.data_store.group_summaries.length;i++)
total_records+=Number(this.data_store.group_summaries[i].summaries[0].value);if(total_records>paging_info.record_count)
{page_count=Math.round((total_records/paging_info.records_per_page)+0.5);}}
var paging_controls='';var records_control='';if(paging_info.records_per_page)
{var records_label;if(paging_info.records_per_page==5000)
records_label=this.render_small?'All':'All Results';else
records_label=this.render_small?paging_info.records_per_page:paging_info.records_per_page+' per page';records_control=this.templates.records_control.apply({label:records_label,right_divider:paging_info.current_page&&page_count>1?this.templates.divider.apply():''});}
if(paging_info.current_page&&page_count>1)
{var prev_enabled=(cur_page>1)?'enabled':'disabled';var next_enabled=(cur_page!=page_count)?'enabled':'disabled';var input_enabled=(page_count>1)?'enabled':'disabled';paging_controls=this.templates.paging_controls.apply({prev_enabled:prev_enabled,input_enabled:input_enabled,next_enabled:next_enabled,current_page:cur_page,page_count:this.format_number(page_count),prev_page:(cur_page-1),next_page:(cur_page+1),records_control:records_control,width:Math.floor(10*((Math.log(page_count)/Math.log(10))+1)),page_span:this.render_small?'':this.templates.page_span.apply()});}
if(this.on_canvas)
{var h=this.templates.float_right_control.apply({contents:paging_controls,extra_cls:'paging_controls'});h+=this.templates.float_right_control.apply({contents:records_control,extra_cls:'paging_controls'});return h;}
else
{return this.templates.right_controls.apply({records_control:records_control,paging_controls:paging_controls,});}},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.on_window_resize,this);},});SG.FocusWindow=function(config){Ext.apply(this,config);SG.FocusWindow.superclass.constructor.call(this);};Ext.extend(SG.FocusWindow,SG.FloatingComponent,{init_component:function(config)
{SG.FloatingComponent.prototype.init_component.call(this);this.callback=null;this.stack=[];this.setup_and_render();},destroy_component:function()
{SG.FloatingComponent.prototype.destroy_component.call(this);},setup_and_render:function(){var dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.container=dh.append(this.dbody,{tag:'div',cls:'sg_focus_window'},true);this.container.setVisibilityMode(Ext.Element.DISPLAY);this.container.hide();this.header=dh.append(this.container,{tag:'div',cls:'header'},true);this.title=dh.append(this.header,{tag:'span',cls:'title'},true);dh.append(this.header,"<img class='gear_menu' src='/images/gear_menu_nobg.png'>");dh.append(this.header,"<img class='close_window' src='/images/close_overlay_x.png'>");dh.append(this.header,{tag:'div',cls:'refresh'});this.header.on('click',this.on_header_click,this);this.body=dh.append(this.container,{tag:'div',cls:'body'},true);this.shadow_offset=5;this.setup_drag_and_resize();},setup_drag_and_resize:function(){this.shadow=new Ext.Shadow({offset:this.shadow_offset,mode:'frame'});var resizer=new Ext.Resizable(this.container,{handles:'se',minWidth:100,minHeight:100,pinned:true});resizer.on('resize',this.on_resize,this);resizer.on('beforeresize',this.on_before_resize,this);var dd=new Ext.dd.DDProxy(this.container,"focus_win",{scroll:false});dd.setHandleElId(this.header);dd.focus_window=this;dd.startDrag=function(){this.constrainTo(this.focus_window.dbody);this.getDragEl().style.border="2px solid #666666";};dd.onMouseDown=function(e){SG.Menu.cancel_current();var t=Ext.get(e.getTarget());var hide_shadow=true;var close_button=t.findParent('img.close_window',this.header,true);if(close_button)hide_shadow=false;var gear_button=t.findParent('img.gear_menu',this.header,true);if(gear_button)hide_shadow=false;var plus_button=t.findParent('span.plus_button',this.header,true);if(plus_button)hide_shadow=false;if(hide_shadow)
this.focus_window.shadow.hide();};dd.onMouseUp=function(){this.focus_window.shadow.show(this.focus_window.container);};dd.afterDrag=function(){this.getDragEl().style.border="2px solid #aaa";this.focus_window.save_position();this.focus_window.sync_shadow();};},post_resized:function()
{SG.NotificationCenter.post({uuid:'_sg_focus_window_resized_',name:'focus_window_resized',args:null,canvas_id:null});},add_single_entity:function(context,focus_window_open){if(SG.schema.can_create_entity(context.entity_type)){context.add_single_entity=true;if(focus_window_open){this.open(context);}else{this.get_page(context);}}},open:function(context){if(this.callback){this.callback.fn.call(this.callback.scope||this);this.callback=null;}
if(context.callback&&context.callback.hasOwnProperty('fn')){this.callback=context.callback;}
if(context.reset_stack){this.stack=[];}
var t="";if(this.stack.length>0)
t+="<img src='/images/pageArrow_left_LG_default.png' class='back_button'>";t+="<img src='"+SG.globals.icons.entities[context.entity_type]+"'> "+context.title;this.title.update(t);if(!this.container.isVisible()){this.container.show();this.load_position();this.shadow.show(this.container);}
if(this.page){this.page.destroy_root_widget();this.page_container.remove();}
this.get_page(context);this.stack.push(context);},hide:function(){this.close();},close:function(){if(this.container.isVisible()){this.container.hide();this.shadow.hide();}
if(this.callback){this.callback.fn.call(this.callback.scope||this);this.callback=null;}},load_position:function(){var cookie=getCookie("focus_window_position");var box;if(cookie){box=Ext.decode(cookie);}else{box={x:200,y:200,width:500,height:300};}
this.container.setBox(box);this.constrain_to_viewport();},save_position:function(){var box=Ext.encode(this.container.getBox());setCookie("focus_window_position",box,365);},constrain_to_viewport:function(){var vw=Ext.lib.Dom.getViewWidth(),vh=Ext.lib.Dom.getViewHeight();var s=Ext.get(document).getScroll();var xy=this.container.getXY();var x=xy[0],y=xy[1];var w=this.container.dom.offsetWidth+this.shadow_offset;var h=this.container.dom.offsetHeight+this.shadow_offset;var moved=false;if((x+w)>vw+s.left){x=vw-w-this.shadow_offset;moved=true;}
if((y+h)>vh+s.top){y=vh-h-this.shadow_offset;moved=true;}
if(x<s.left){x=s.left;moved=true;}
if(y<s.top){y=s.top;moved=true;}
if(moved){this.container.setXY([x,y]);}},get_page:function(context)
{var url='/page/focus?entity_type='+context.entity_type;if(context.task_chain)
url=url+'&task_chain=true';var options={url:url,params:{json:true},callback:function(options,success,response){if(success){var page;eval("page = "+response.responseText);page.config.parent_page=this.parent_page;page.context.inside_window=true;page.context.entity=context.entity;page.context.entity_type=context.entity_type;page.context.entity_project=context.entity_project;page.context.filters=context.filters;page.context.server_side_filters=context.server_side_filters;page.context.server_side_filters_params=context.server_side_filters_params;page.context.add_single_entity=context.add_single_entity;page.context.link_to=context.link_to;page.context.link_fields=context.link_fields;page.context.page_has_on_linked_callback=(typeof context.on_linked_callback!='undefined');page.context.select_entities_on_first_load=context.select_entities_on_first_load;page.context.scroll_selection_into_view_on_load=context.scroll_selection_into_view_on_load;if(context.grouping)
page.settings.settings.grouping=sg_deep_copy(context.grouping);if(context.on_link_no_undo)
page.context.on_link_no_undo=true;var grid_widget=page.settings.children.list_content;if(grid_widget.type=='SG.Widget.EntityQuery.GanttWrapper')
grid_widget=grid_widget.children.grid;if(context.extra_columns)
{if(!grid_widget.settings.columns)
grid_widget.settings.columns=[];for(var i=0;i<context.extra_columns.length;i++)
if(grid_widget.settings.columns.indexOf(context.extra_columns[i])==-1)
grid_widget.settings.columns.push(context.extra_columns[i]);}
if(context.summaries)
{if(!grid_widget.settings.summaries)
grid_widget.settings.summaries={};for(var i=0;i<context.summaries.length;i++)
grid_widget.settings.summaries[context.summaries[i].column]=context.summaries[i];grid_widget.settings.summary_state='visible';}
this.init_page(page);if(context.on_linked_callback)
this.page.on_linked_callback=context.on_linked_callback;}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},init_page:function(page_config){var dh=Ext.DomHelper;this.page_container=dh.append(this.body,{tag:'div',cls:'sg_page inside_window',id:'sg_page_'+page_config.config.id},true);this.page=new SG.Page(page_config.config,page_config.context,page_config.settings);this.page.on('show_entity_detail',this.on_show_entity_detail,this);if(this.page.context.get('add_single_entity')){this.page.root_widget.create_new_entity();}},on_show_entity_detail:function(entity_type,entity_id,entity_name){this.close();this.parent_page.root_widget.show_entity_detail(entity_type,entity_id,entity_name);},on_header_click:function(e){var t=Ext.get(e.getTarget());var close_button=t.findParent('img.close_window',this.header,true);if(close_button)this.close();var gear_button=t.findParent('img.gear_menu',this.header,true);if(gear_button)
this.show_gear_menu(e.getXY());var back_link=t.findParent('img.back_button',this.header,true);if(back_link){this.stack.pop();var context=this.stack.pop();this.open(context);}
var refresh_button=t.findParent('div.refresh',this.header);if(refresh_button)
{var entity_query_mode_div=this.container.child('div.sgw_entity_query_mode');var id_string=entity_query_mode_div.dom.getAttribute('id');var widget=this.get_widget_from_id_string(id_string);widget.reload_all_entities();}},get_widget_from_id_string:function(id_string)
{var id=Number(id_string.split('_')[1]);var widget=SG.Widget.get_instance_by_id(id);return widget;},on_before_resize:function()
{SG.Menu.cancel_current();},on_resize:function(){this.save_position();this.sync_shadow();this.post_resized();},sync_shadow:function(){var l=this.container.getLeft(true);var t=this.container.getTop(true);var h=this.container.getHeight();var w=this.container.getWidth();this.shadow.realign(l,t,w,h);},show_gear_menu:function(xy)
{if(!this.gear_menu)
{this.gear_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_gear_menu,scope:this},items:[{html:'Save Layout',item_selected:{fn:this.save_page,scope:this}},{html:'Revert Layout',item_selected:{fn:this.revert_page,scope:this}},{html:'Revert Layout To Global Default',item_selected:{fn:this.revert_to_default,scope:this}},]});this.gear_menu.render();}
this.gear_menu.position={xy:xy};this.gear_menu.show();},on_before_show_gear_menu:function(menu)
{menu.items[0].disabled=!this.page.saveable_now();menu.items[1].disabled=!this.page.revertable_now();menu.items[2].disabled=!this.page.user_can_save_or_revert_to_default();menu.render();},save_page:function(menu,item)
{this.page.settings_save();},revert_page:function(menu,item)
{this.page.settings_revert();},revert_to_default:function(menu,item)
{this.page.settings_revert_to_global_default(true);}});SG.EntityFactory=function(context){Ext.apply(this,context);this.events={done:true};};Ext.extend(SG.EntityFactory,Ext.util.Observable,{handlers:{Note:'handle_note',TimeLog:'handle_timelog',HumanUser:'handle_user',ApiUser:'handle_user',Playlist:'handle_playlist',Project:'handle_project',Status:'handle_status',Page:'handle_page'},create:function(){this.handle_default_status_list_values();if(this.handlers[this.entity_type])
this[this.handlers[this.entity_type]]();else
this.done();},done:function(){if(this.callback_extra_parameter){this.fireEvent('done',this.data_record,this.callback_extra_parameter);}else{this.fireEvent('done',this.data_record);}},handle_default_status_list_values:function(){var fields=SG.schema.entity_fields[this.entity_type];var rec=this.data_record;var sf;for(var f in fields){if(fields.hasOwnProperty(f)){sf=fields[f];if(sf.data_type=="status_list"&&sf.status_list_default&&!rec.get(sf.name)){rec.set(sf.name,sf.status_list_default);}}}},handle_user:function(){var default_role=this.entity_type=='HumanUser'?SG.globals.default_user_role:SG.globals.default_script_role;this.data_record.set('permission_rule_set',default_role);this.done();},handle_page:function(){this.data_record.set('page_type','entity_query');this.done();},handle_timelog:function(){this.data_record.set('user',SG.globals.current_user.entity_hash);var today=SG.GridEditor.DateParser.get_normalized_today();this.data_record.set('date',SG.GridEditor.DateParser.data_store_format(today));this.done();},handle_status:function(){var icon_list=SG.schema.icon_list;var perm_icons=[];for(var icon in icon_list){if(icon_list.hasOwnProperty(icon)&&icon_list[icon].icon_type=='permanent_status'&&icon_list[icon].icon!=null)
perm_icons.push(icon);}
perm_icons.sort(function(a,b){var x=icon_list[a].id;var y=icon_list[b].id;return((x<y)?-1:((x>y)?1:0));});icon=icon_list[perm_icons[0]];this.data_record.set('icon',{type:'Icon',id:icon.id,name:'',valid:'valid'});this.done();},handle_note:function(){var value;if(this.parent_entity){if(['HumanUser','Group'].indexOf(this.parent_entity.type)!=-1){this.handle_note_on_user();return;}else if(this.parent_entity.type=="Task"){this.handle_note_on_task();return;}else if(this.parent_entity.type=="Version"){this.handle_note_on_version();return;}else{this.handle_note_on_generic_entity(this.parent_entity);return;}}else if(typeof(this.data_record.get('note_links'))=="undefined"){this.data_record.set('note_links',[]);}
this.done();},note_done:function(){var note_links=this.data_record.get('note_links');if(note_links&&note_links.length>0)
this.set_note_subject(note_links);this.done();},set_note_subject:function(note_links){var subject;if(this.grandparent_entity&&this.grandparent_entity.type=='Playlist'&&this.parent_entity&&this.parent_entity.type=='Version'){var parser=SG.GridEditor.DateParser;var today_string=parser.format(parser.get_normalized_today(),' - F s');this.data_record.set('subject',this.grandparent_entity.name+today_string);return;}
var names=SG.globals.current_user.entity_hash.name.split(' ');subject=names[0]+"'s Note on";if(SG.globals.custom_for=="drd"||SG.globals.custom_for=="brownbag"){subject="";}else{for(var i=0;i<note_links.length;i++){if(i==(note_links.length-1)&&note_links.length>1)
subject+=' and '+note_links[i].name;else
subject+=' '+note_links[i].name;if((i+2)<note_links.length)
subject+=',';}}
this.data_record.set('subject',subject);},handle_note_on_user:function(){this.data_record.set('addressings_cc',[this.parent_entity]);this.note_done();},handle_note_on_generic_entity:function(entity){this.generic_ds=new SG.Data.Set(entity.type);this.generic_ds.on("load",this.on_generic_entity_load,this);var spec={type:entity.type,id:entity.id,columns:[SG.schema.get_identifier_field(entity.type)],result:this.generic_ds};SG.Repo.find(spec);},on_generic_entity_load:function(){var rec=this.generic_ds.get_record(0);var ident_field=SG.schema.get_identifier_field(this.generic_ds.type);var schema_field=SG.schema.get_field(this.generic_ds.type,ident_field);var ren_name=schema_field.renderer||SG.Renderers.renderer_defaults[schema_field.data_type]||"text";var name=SG.Renderers[ren_name].render_for_attribute(rec.get(ident_field),schema_field);var entity={type:this.generic_ds.type,id:rec.id,name:name};var proj=rec.get('project');if(proj)
entity.project_id=proj.id;this.data_record.set('note_links',[entity]);this.note_done();},handle_note_on_task:function(){var task_row=SG.Repo.get_row('Task',this.parent_entity.id);var row_entity=task_row.get('entity');if(row_entity){var proj=task_row.get('project');if(proj){row_entity.project_id=proj.id;this.parent_entity.project_id=proj.id;}
this.data_record.set('note_links',[row_entity]);this.data_record.set('tasks',[this.parent_entity]);this.note_done();return;}
this.task_ds=new SG.Data.Set('Task');this.task_ds.on("load",this.on_task_load,this);var spec={type:'Task',id:this.parent_entity.id,columns:['entity'],result:this.task_ds};SG.Repo.find(spec);},on_task_load:function(){var rec=this.task_ds.get_record(0);var task=this.record_to_entity(rec);var entity=rec.get('entity');var links=[];var proj=rec.get('project');if(proj){if(entity){entity.project_id=proj.id;}
task.project_id=proj.id;}
if(entity)
links.push(entity);links.push(this.parent_entity);this.data_record.set('note_links',links);this.data_record.set('tasks',[task]);this.note_done();},handle_note_on_version:function(){this.note_links=[];this.tasks=[];this.addressings_cc=[];this.version_ds=new SG.Data.Set('Version');this.version_ds.on("load",this.on_version_load,this);var columns=["entity","user","sg_task"];if(SG.globals.custom_for=="drd")
columns.push("sg_tasks");var spec={type:'Version',id:this.parent_entity.id,columns:columns,result:this.version_ds};SG.Repo.find(spec);},on_playlist_load_custom:function(){var rec=this.playlist_ds.get_record(0);var addressings_cc=[];var leads=[];if(rec){leads=rec.get("sg_leads");}
if(leads){for(var i=0;i<leads.length;i++){addressings_cc.push(leads[i]);}}
if(addressings_cc.length>0){this.data_record.set('addressings_cc',addressings_cc);}
if(!this.task_ds||(this.task_ds&&this.task_ds.is_loaded()))
this.note_done();},on_version_load:function(){var rec=this.version_ds.get_record(0);var tasks=[];var links=[];var ready=true;var spec;var proj=rec.get('project');var entity=rec.get('entity');var user=rec.get("user");var v=sg_deep_copy(this.parent_entity);if(proj)
v.project_id=proj.id;v.valid='valid';links.push(v);if(entity){if(proj)
entity.project_id=proj.id;links.push(entity);}
if(this.grandparent_entity){var parser=SG.GridEditor.DateParser;var today_string=parser.format(parser.get_normalized_today(),' - F s');var subject_str=this.grandparent_entity.name+today_string;this.data_record.set('subject',subject_str);if(proj)
this.grandparent_entity.project_id=proj.id;links.push(this.grandparent_entity);if(SG.globals.custom_for=="drd"){this.playlist_ds=new SG.Data.Set('Playlist');this.playlist_ds.on("load",this.on_playlist_load_custom,this);var columns=["sg_leads"];spec={type:'Playlist',id:this.grandparent_entity.id,columns:columns,result:this.playlist_ds};SG.Repo.find(spec);}}
var task=rec.get('sg_task');if(task){if(proj)
task.project_id=proj.id;tasks.push(task);}
if(SG.globals.custom_for=="drd"){var drd_tasks=rec.get('sg_tasks');if(drd_tasks!=null){for(var i=0;i<drd_tasks.length;i++){var drd_task=drd_tasks[i];if(proj)
drd_task.project_id=proj.id;tasks.push(drd_task);}}}
this.data_record.set('note_links',links);var addressings_cc=[];if(tasks.length>0){this.data_record.set('tasks',tasks);}else if(entity&&user){this.task_ds=new SG.Data.Set('Task');this.task_ds.on("load",this.on_tasks_for_version_load,this);var filters={logical_operator:'and',conditions:[{path:"entity",relation:"is",values:[entity]},{path:"task_assignees",relation:"is",values:[user]}]};spec={type:'Task',filters:filters,columns:['entity','project'],result:this.task_ds};SG.Repo.query(spec);this.version_user=user;}else if(user){addressings_cc.push(user);}
var dept=rec.get("sg_department_link");if(dept){addressings_cc.push(dept);}
if(SG.globals.custom_for=="mrx"){this.data_record.set('sg_note_type','Internal');}
if(SG.globals.custom_for=="dneg"){this.data_record.set('sg_note_type','Review');}
if(addressings_cc.length>0){this.data_record.set('addressings_cc',addressings_cc);}
if(!this.playlist_ds&&!this.task_ds)
this.note_done();},on_tasks_for_version_load:function(ds){var tasks=[];for(var i=0;i<this.task_ds.count();i++){var rec=this.task_ds.get_record(i);tasks.push(this.record_to_entity(rec));}
this.data_record.set('tasks',tasks);if(tasks.length===0&&this.version_user){var addressings_cc=this.data_record.get('addressings_cc')||[];addressings_cc.push(this.version_user);this.data_record.set('addressings_cc',addressings_cc);}
if(!this.playlist_ds||(this.playlist_ds&&this.playlist_ds.is_loaded()))
this.note_done();},handle_playlist:function(){var versions=this.data_record.get('versions');if(versions&&versions.length>0){this.versions_ds=new SG.Data.Set('Version');this.versions_ds.on("load",this.on_playlist_version_load,this);var version_ids=[];for(var i=0;i<versions.length;i++)
version_ids.push(versions[i].id);var spec={type:'Version',ids:version_ids,columns:['code'],result:this.versions_ds};SG.Repo.find(spec);}else{this.done();}},on_playlist_version_load:function(){var count=this.versions_ds.count();var versions=[];for(var i=0;i<count;i++){var version=this.versions_ds.get_record(i);versions.push({type:'Version',id:version.id,name:version.get('code')});}
this.data_record.set('versions',versions);this.done();},handle_project:function(){var template_project=null;for(var i=0;i<SG.schema.projects.length;i++){var project=SG.schema.projects[i];if(i===0)
template_project=project;if(project.name=="Template Project"){template_project=project;break;}}
this.data_record.set('layout_project',template_project);var users=this.data_record.get('users')||[];var me=SG.globals.current_user.entity_hash;var i_am_in_users=false;for(i=0;i<users.length;i++)
if(users[i].type=='HumanUser'&&users[i].id==me.id)
i_am_in_users=true;if(!i_am_in_users)
users.push(sg_deep_copy(me));this.data_record.set('users',users);this.done();},record_to_entity:function(record){var ident_field=SG.schema.get_identifier_field(record.type);var name=record.get(ident_field);if(!name)name='';var ret={type:record.type,id:record.id,valid:'valid',name:name};var proj=record.get('project');if(proj)
ret.project_id=proj.id;return ret;}});SG.MultiEntityFactory=function(context){Ext.apply(this,context);this.events={done:true};};Ext.extend(SG.MultiEntityFactory,Ext.util.Observable,{create:function()
{this.records=[];for(var i=0;i<this.parent_entities.length;i++)
{var context={entity_type:this.entity_type,parent_entity:this.parent_entities[i],data_record:this.data_records[i]};if(this.grandparent_entities)
context.grandparent_entity=this.grandparent_entities[i];var factory=new SG.EntityFactory(context);factory.on('done',this.on_create_entity,this);factory.create();}},done:function()
{this.fireEvent('done',this.records);},on_create_entity:function(data_record)
{this.records.push(data_record);if(this.records.length==this.parent_entities.length)
this.done();},});SG.Data.Repository=function(){this.init();this.events={'capture_events':true,'create':true};};Ext.extend(SG.Data.Repository,Ext.util.Observable,{init:function(){this.batch_count=0;this.identity_map={};this.batched_requests=null;this.news_last_id=null;this.news_init_time=new Date();this.news_poll_interval=0;this.undo_stack=[];},find:function(spec){var req={type:'find',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},query:function(spec){var req={type:'query',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},update:function(spec){var req={type:'update',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},retire:function(spec){var req={type:'retire',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},revive:function(spec){var req={type:'revive',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},create:function(spec){var req={type:'create',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},summarize:function(spec){var req={type:'summarize',spec:spec};if(this.batch_active()){this.add_requests_to_batch([req]);}else{this.send_requests([req]);}},query_csv:function(spec){var crud=this.make_query_req(spec,true);crud.local_timezone_offset=-(new Date().getTimezoneOffset()/60);var form=document.getElementById("csv_download_target");form.elements[0].value=Ext.encode(crud);form.submit();},start_batch:function(){this.batch_count++;if(!this.batch_active()){this.batched_requests=[];SG.CrudManagerInstance.send_now();}},end_batch:function(){this.batch_count--;if(this.batch_count<=0){this.batch_count=0;this.send_requests(this.batched_requests);this.batched_requests=null;SG.CrudManagerInstance.send_now();}},get_row:function(entity_type,entity_id){if(!this.identity_map[entity_type]){this.identity_map[entity_type]={};}
var row=this.identity_map[entity_type][entity_id];if(!row){row=new SG.Data.Row(entity_type,entity_id);this.identity_map[entity_type][entity_id]=row;}
return row;},batch_active:function(){return(this.batched_requests!==null);},add_requests_to_batch:function(request_hashes){this.batched_requests=this.batched_requests.concat(request_hashes);},send_requests:function(requests){if(!requests||requests.length===0)return;var optimized_requests=this.optimize_requests(requests);var req;var has_update=false;var crud_requests=[];var crud_handlers=[];for(var i=0;i<optimized_requests.length;i++){req=optimized_requests[i];var crud_config,crud_handler;switch(req.type){case'find':crud_config=this.make_find_req(req.spec);crud_handler=new SG.ReadResponseHandler.LoadSet(req.spec.result);break;case'query':crud_config=this.make_query_req(req.spec);crud_handler=new SG.ReadResponseHandler.LoadSet(req.spec.result);break;case'update':crud_config=this.make_update_req(req.spec);crud_handler=new SG.UpdateResponseHandler.UpdateRow(req.spec);has_update=true;break;case'retire':crud_config=this.make_retire_req(req.spec);crud_handler=new SG.DeleteResponseHandler.DeleteRow(req.spec);has_update=true;break;case'revive':crud_config=this.make_revive_req(req.spec);crud_handler=new SG.ReviveResponseHandler.ReviveRow(req.spec);has_update=true;break;case'create':crud_config=this.make_create_req(req.spec);crud_handler=new SG.CreateResponseHandler.CreateRow(req.spec);has_update=true;break;case'summarize':crud_config=this.make_summarize_req(req.spec);crud_handler=new SG.SummarizeResponseHandler.LoadSummary(req.spec.result,req.spec.result_key);break;}
if(req.spec.drafts||(req.spec.result&&req.spec.result.drafts))
crud_config.drafts=true;if(this.field_to_recalculate_on_task_schedule_changes&&crud_config.type&&crud_config.type=='WorkDayRule')
{crud_config.field_to_recalculate_on_task_schedule_changes=this.field_to_recalculate_on_task_schedule_changes;}
if(req.spec.use_loading_banner)
{crud_config.use_loading_banner=true;SG.Message.show_loading();}
crud_requests.push(crud_config);crud_handlers.push(crud_handler);}
if(has_update){this.news_poll_interval=0;crud_config=this.make_news_req();crud_handler=new SG.ReadResponseHandler.LoadNews();crud_requests.push(crud_config);crud_handlers.push(crud_handler);}
var crud=new SG.CrudRequest(crud_requests,crud_handlers);crud.on('started',this.reset_undo,this);crud.on('completed',this.on_crud_completed,this);crud.send();},on_crud_completed:function(responses){this.throw_crud_error(responses);this.ready_to_undo();},throw_crud_error:function(responses){var r,sf,match,html='';var regex=/Update\sfailed\sfor\s\[(.*?)\.(.*?)\]/;var local_regex=/Create\sfailed\sfor\s\[Attachment\]:\sPath\s(.*)\sdoesn\'t\smatch\sany\sdefined\sLocal\sStorage\.$/;var local_errs=[];for(var i=0;i<responses.length;i++){r=responses[i];if(r.status==='successful')continue;if(r.request_type==='update')continue;if(match=r.reason_description.match(local_regex)){local_errs.push(match[1]);continue;}
if(r.request_type=="read"&&r.type=="EventLogEntry"&&r.reason_code==1)
continue;if(match=r.reason_description.match(regex)){sf=SG.schema.get_field(match[1],match[2]);if(sf&&["entity","multi_entity"].indexOf(sf.data_type)!==-1){r.raw_error=r.reason_description;r.reason_description='The value you entered in the "'+sf.display_name+'" field doesn\'t have a match.';}}
if(r.type&&r.id){html+=r.request_type+" "+r.status+" on "+
r.type+" "+r.id+" "+"(reason_code "+r.reason_code+"): "+
r.reason_description+"<br><br>";}else if(match&&sf&&["entity","multi_entity"].indexOf(sf.data_type)!==-1){html+='<span style="font-size:14px"> '+r.reason_description+' Please go back and edit before saving.</span><br><br>';}else{html+=r.request_type+" "+r.status+" "+"(reason_code "+r.reason_code+"): "+
r.reason_description+"<br><br>";}}
if(local_errs.length>0){html+='<div style="font-size:14px">'+"The files below can not be added as linked files because their "+"location has not been blessed by an admin. "+"Maybe you're trying to link to files on your local machine that aren't accessible by others? "+"You can either upload the files, or ask an admin to add this "+"location to the list of supported storages. "+'<a target="_blank" href="'+SG.globals.help_urls.local_files+'">Learn more about how '+'linking to local files work.</a>'+"<br><br>Here are the offenders:</div><div>"+
local_errs.join("<br>")+"</div><br>";}
if(html){var sed=SG.server_error({title:"Oops!",html_msg:html,dialog_submitted:{fn:this.on_error_ok_pressed,scope:this},connection_response:r});return true;}
return false;},on_error_ok_pressed:function()
{var overlays=sg_find_all('div.progress_indicator_overlay_container');for(var i=0;i<overlays.length;i++){Ext.get(overlays[i]).remove();}},on_create:function(entity){if(entity.type=='TimeLog')
this.request_news();this.fireEvent('create',entity);},request_news:function(){var crud=new SG.CrudRequest(this.make_news_req(),new SG.ReadResponseHandler.LoadNews());crud.send();},optimize_requests:function(requests){var req,i,j,k,optimized=[];var finds={};for(i=0;i<requests.length;i++){req=requests[i];if(req.type=='find'&&req.spec.hasOwnProperty('id')){k=req.spec.type+"_"+req.spec.id;if(req.spec.parent_entity){k=k+req.spec.parent_entity.type+"_"+req.spec.parent_entity.id;}
if(finds.hasOwnProperty(k)){finds[k].result.push(req.spec.result);for(j=0;j<req.spec.columns.length;j++){if(finds[k].columns.indexOf(req.spec.columns[j])===-1)
finds[k].columns.push(req.spec.columns[j]);}}else{finds[k]={type:req.spec.type,id:req.spec.id,columns:req.spec.columns,result:[req.spec.result]}
if(req.spec.parent_entity){finds[k].parent_entity=req.spec.parent_entity;}}}else{optimized.push(req);}}
for(k in finds){if(!finds.hasOwnProperty(k))continue;req={type:'find',spec:finds[k]};optimized.push(req);}
return optimized;},get_required_columns:function(entity_type,columns,parent_entity)
{var cols=[];for(var i=0;i<columns.length;i++){if(columns[i].indexOf('$')==-1)cols.push(columns[i]);}
var field_info;for(i=0;i<columns.length;i++)
{if(SG.schema.is_bubbled_field(entity_type,columns[i]))
continue;field_info=SG.schema.get_field(entity_type,columns[i]);if(field_info&&field_info.formatting_rules)
SG.CellFormatting.extract_required_fields(field_info.formatting_rules,cols)}
if(SG.schema.entity_types[entity_type].global_row_formatting_rules)
{var rules=SG.schema.entity_types[entity_type].global_row_formatting_rules;SG.CellFormatting.extract_required_fields(rules,cols)}
var has_projects=SG.schema.entity_types[entity_type].has_projects;if(has_projects&&cols.indexOf('project')===-1){cols.push('project');}
var permission_rule_fields=SG.permission_rule_fields(entity_type);for(var i=0;i<permission_rule_fields.length;i++){if(cols.indexOf(permission_rule_fields[i])===-1)
cols.push(permission_rule_fields[i]);}
if(entity_type=='TaskTemplate'){if(cols.indexOf('code')===-1)cols.push('code');if(cols.indexOf('entity_type')===-1)cols.push('entity_type');}
if(entity_type=='DisplayColumn'){if(cols.indexOf('name')===-1)cols.push('name');if(cols.indexOf('entity_type')===-1)cols.push('entity_type');}
if(entity_type=='HumanUser'){if(cols.indexOf('sg_status_list')===-1)cols.push('sg_status_list');}
var ident_field=SG.schema.get_identifier_field(entity_type);if(ident_field&&cols.indexOf(ident_field)===-1)
cols.push(ident_field);if(SG.schema.get_field(entity_type,'read_by_current_user')&&cols.indexOf('read_by_current_user')===-1)
cols.push('read_by_current_user');if(entity_type=='Task'||entity_type=='Version'){if(cols.indexOf('entity')===-1)cols.push('entity');if(SG.schema.entity_fields.Version.sg_task!=undefined&&cols.indexOf('sg_task')===-1&&entity_type=='Version')cols.push('sg_task');}
if(entity_type=='Version'){if(cols.indexOf('created_by')===-1)cols.push('created_by');if(sg_tank_enabled()&&cols.indexOf('tank_published_file')===-1)
cols.push('tank_published_file');if(SG.globals.preferences.enable_revolver&&cols.indexOf('image')>-1){if(SG.schema.entity_fields.Version.sg_uploaded_movie_mp4&&cols.indexOf('sg_uploaded_movie_mp4')===-1)
cols.push('sg_uploaded_movie_mp4');if(SG.schema.entity_fields.Version.sg_uploaded_movie_webm&&cols.indexOf('sg_uploaded_movie_webm')===-1)
cols.push('sg_uploaded_movie_webm');if(SG.schema.entity_fields.Version.sg_uploaded_movie_transcoding_status&&cols.indexOf('sg_uploaded_movie_transcoding_status')===-1)
cols.push('sg_uploaded_movie_transcoding_status');}}
if(entity_type=='Task'&&parent_entity&&parent_entity.type=='TaskTemplate')
cols.push('task_template.TaskTemplate.entity_type');if(entity_type=='Task'&&cols.indexOf('task_assignees')==-1)
cols.push('task_assignees');if(entity_type=='Task'&&cols.indexOf('pinned')==-1)
cols.push('pinned');if(entity_type=='Task'&&cols.indexOf('dependency_violation')==-1)
cols.push('dependency_violation');if(entity_type=='Task'&&cols.indexOf('upstream_tasks')==-1)
cols.push('upstream_tasks');if(entity_type=='Task'&&cols.indexOf('downstream_tasks')==-1)
cols.push('downstream_tasks');if(entity_type=='Task'&&cols.indexOf('inventory_date')==-1)
cols.push('inventory_date');if(entity_type=='Task'&&cols.indexOf('step')==-1)
cols.push('step');if(entity_type=='Page')
{if(cols.indexOf('user')==-1)
cols.push('user');if(cols.indexOf('admin')==-1)
cols.push('admin');if(cols.indexOf('page_type')==-1)
cols.push('page_type');if(cols.indexOf('entity_type')==-1)
cols.push('entity_type');}
if(entity_type=='Status'&&cols.indexOf('icon')==-1)
cols.push('icon');if(entity_type=='Status'&&cols.indexOf('bg_color')==-1)
cols.push('bg_color');if(entity_type=='Status'&&cols.indexOf('name')==-1)
cols.push('name');if(entity_type=='Reply'&&cols.indexOf('entity')==-1)
cols.push('entity');if(SG.globals.custom_for=="walt_disney_animation"){if(['CustomEntity04','CustomEntity05'].indexOf(entity_type)!==-1&&cols.indexOf('sg_asset')==-1)
{cols.push('sg_asset');}}
if(cols.indexOf('image')>-1&&cols.indexOf('filmstrip_image')===-1&&SG.schema.get_field(entity_type,'filmstrip_image'))
{cols.push('filmstrip_image');}
return cols;},make_find_req:function(spec){var ids=[];if(spec.hasOwnProperty('id')){ids.push(spec.id);}else if(spec.hasOwnProperty('ids')){ids=spec.ids;}
if(ids.length==0)
throw"SG.Repository: find request can't have no ids. "+"Request must specify the id or ids parameters with at least 1 id.";var filters={logical_operator:"and",conditions:[{active:"true",path:"id",relation:"in",values:ids}]};var read_config={request_type:"read",type:spec["type"],read:["entities"],filters:filters,columns:this.get_required_columns(spec["type"],spec["columns"],spec["parent_entity"])};if(spec.current_page&&spec.records_per_page){read_config.read.push("paging_info");read_config.paging={current_page:spec.current_page,records_per_page:spec.records_per_page}}
if(spec.grouping){read_config.read.push("groups");read_config.grouping=spec.grouping;}
if(spec.parent_entity){read_config.bubble_source_entity=spec.parent_entity;}
return read_config;},make_query_req:function(spec,no_required_columns){var columns;if(no_required_columns===true){columns=spec["columns"];}else{columns=this.get_required_columns(spec["type"],spec["columns"],spec["parent_entity"]);}
var read_config={request_type:"read",type:spec["type"],read:["entities"],filters:spec["filters"],columns:columns,sorts:spec["sorts"]};if(spec.current_page&&spec.records_per_page){if(spec.no_paging_info!==true)
read_config.read.push("paging_info");read_config.paging={current_page:spec.current_page,records_per_page:spec.records_per_page}}
if(spec.grouping){read_config.read.push("groups");read_config.grouping=spec.grouping;}
if(spec.parent_entity){read_config.bubble_source_entity=spec.parent_entity;}
if(spec.server_side_filters)
read_config.server_side_filters=spec.server_side_filters;if(spec.server_side_filters_params)
read_config.server_side_filters_params=spec.server_side_filters_params;if(spec.column_display_names){read_config.column_display_names=spec.column_display_names;}
if(spec.pivot_columns_hash){read_config.pivot_columns_hash=spec.pivot_columns_hash;}
if(spec.summary_columns_hash){read_config.summary_columns_hash=spec.summary_columns_hash;}
if(spec.drafts)
read_config.drafts=true;if(spec.request_id){read_config.request_id=spec.request_id;}
return read_config;},make_update_req:function(spec){var update_config={request_type:"update",type:spec["type"],id:spec["id"],column:spec["column"],value:spec["value"]};if(spec.parent_entity){update_config.bubble_source_entity=spec.parent_entity;}
if(spec.multi_entity_update_mode){update_config.multi_entity_update_mode=spec.multi_entity_update_mode;}
return update_config;},make_retire_req:function(spec){var delete_config={request_type:"delete",type:spec["type"],id:spec["id"],};return delete_config;},make_revive_req:function(spec){var revive_config={request_type:"revive",type:spec["type"],id:spec["id"],};return revive_config;},make_create_req:function(spec){var col,cols=sg_deep_copy(spec.columns)||[];for(var i=0;i<spec.values.length;i++){col=spec.values[i].column;if(cols.indexOf(col)===-1)
cols.push(col);}
var create_config={request_type:"create",type:spec.type,field_values:spec.values,columns:this.get_required_columns(spec.type,cols)};return create_config;},make_summarize_req:function(spec){var summarize_req={request_type:'summarize',type:spec.type,filters:spec.filters,summaries:spec.summaries};if(spec.grouping)
{summarize_req.request_type='group_summarize';summarize_req.grouping=spec.grouping;summarize_req.paging=spec.paging;}
if(spec.parent_entity){summarize_req.bubble_source_entity=spec.parent_entity;}
if(spec.server_side_filters){summarize_req.server_side_filters=spec.server_side_filters;}
return summarize_req;},make_news_req:function(){var read_config={request_type:"read",type:'EventLogEntry',read:["entities"],columns:["entity","meta","created_at"],sorts:[{column:'id',direction:'asc'}],paging:{current_page:1,records_per_page:50}};var filters={logical_operator:'and',conditions:[{path:'session_uuid',relation:'is',values:[SG.globals.session_uuid]},{path:'event_type',relation:'ends_with',values:['_Change'],active:'true'},{path:'entity',relation:'is_not',values:[null],active:'true'},{path:'attribute_name',relation:'is_not',values:['tag_list'],active:'true'}]}
if(this.news_last_id===null){var first=SG.GridEditor.DateTimeParser.data_store_format(this.news_init_time);filters.conditions.push({path:'created_at',relation:'greater_than',values:[first],active:"true"});}else{filters.conditions.push({path:'id',relation:'greater_than',values:[this.news_last_id],active:"true"});}
read_config.filters=filters;return read_config;},reset_undo:function(responses){var only_reads=true;for(var i=0;i<responses.length;i++){if(['summarize','group_summarize','read'].indexOf(responses[i].request_type)===-1){only_reads=false;break;}}
if(only_reads)return;if(SG.Message.message_type==='undo')
SG.Message.hide();this.undo_stack=[];},register_undo:function(spec){this.undo_stack.push(spec);},ready_to_undo:function(){var undo_size=this.undo_stack.length;if(undo_size===0)return;var msg='';msg+=this.undo_message_for_retires();msg+=this.undo_message_for_creates();msg+=this.undo_message_for_updates();msg+='. <a href="javascript:" class="undo">Undo</a>';var config={};config.html=msg;config.click_fn={fn:this.click_undo,scope:this};config.message_type='undo';config.close_x=true;SG.Message.show(config);},undo_message_name:function(row)
{var entity_type=row.get_type();var ident_field=SG.schema.get_identifier_field(entity_type);if(this.entity_type=='Note')
ident_field='subject';var name=row.get(ident_field);if(entity_type=='Attachment')
name=name.display_name;if(!name)
name=row.get_id();else if(name.length>20)
name=name.substring(0,19)+'...';return name;},undo_message_for_creates:function()
{var entity_id,entity_type,count=0;for(i=0;i<this.undo_stack.length;i++){if(this.undo_stack[i].type!=="retire")continue;count++;entity_type=this.undo_stack[i].spec.type;entity_id=this.undo_stack[i].spec.id;}
if(count===0){return"";}else if(count===1){var row=this.get_row(entity_type,entity_id);var dn=SG.schema.entity_types[entity_type]['display_name'];var name,detail;if(entity_type=="Attachment"){var sf=SG.schema.get_field("Attachment","this_file");detail=SG.Renderers.url_no_icon.render(row.get("this_file"),sf);}else if(entity_type=="Booking"){return"Booking created";}else{name=this.undo_message_name(row);detail=SG.Renderers.render_one_detail_link({type:entity_type,id:row.get_id(),name:name});}
return dn+" "+detail+" has been created";}else{var dn=SG.schema.entity_types[entity_type]['display_name_pluralized'];return count+" "+dn+" have been created";}},undo_message_for_retires:function()
{var entity_id,entity_type,count=0;for(i=0;i<this.undo_stack.length;i++){if(this.undo_stack[i].type!=="revive")continue;count++;entity_type=this.undo_stack[i].spec.type;entity_id=this.undo_stack[i].spec.id;}
if(count===0){return"";}else if(count===1){if(entity_type=='Booking'){return"Booking retired";}else{var row=this.get_row(entity_type,entity_id);return"Retired "+this.undo_message_name(row);}}else{var dn=SG.schema.entity_types[entity_type]['display_name_pluralized'];return"Retired "+count+" "+dn;}},undo_message_for_updates:function()
{var i,id_hash={},field_hash={};var id_array=[],field_array=[];var spec,entity_type;var count=0;for(i=0;i<this.undo_stack.length;i++){if(this.undo_stack[i].type!=="update")continue;spec=this.undo_stack[i].spec;count++;entity_type=spec.type;id_hash[spec.id]=true;if(spec.column=="upstream_tasks")
field_hash["downstream_tasks"]=true;else
field_hash[spec.column]=true;}
if(count===0)return"";for(i in id_hash){if(!id_hash.hasOwnProperty(i))continue;id_array.push(i);}
for(i in field_hash){if(!field_hash.hasOwnProperty(i))continue;field_array.push(i);}
var schema_field,field_display_names=[];for(i=0;i<field_array.length;i++){schema_field=SG.schema.get_field(entity_type,field_array[i]);if(schema_field){if(schema_field.name=="downstream_tasks")
field_display_names.push("Dependencies");else
field_display_names.push(schema_field.display_name);}}
var message=field_display_names.join(', ');message+=' updated';if(id_array.length==1){if(entity_type=='TaskDependency'){}else{var row=this.get_row(entity_type,id_array[0]);message+=' on '+this.undo_message_name(row);}}else{message+=' on '+id_array.length+' ';message+=SG.schema.entity_types[entity_type]['display_name_pluralized'];}
return message;},click_undo:function(e){var target=e.getTarget();if(target&&target.tagName==='A'&&target.getAttribute('class')=='undo')
this.do_undo();},do_undo:function(){SG.Message.hide();this.send_requests(this.undo_stack);}});SG.Repo=new SG.Data.Repository();SG.ReadResponseHandler.LoadSet=function(sets){if(sets instanceof Array)
this.sets=sets;else
this.sets=[sets];};Ext.extend(SG.ReadResponseHandler.LoadSet,SG.ResponseHandler,{handle_response:function(response,request)
{if(request&&request.use_loading_banner)
SG.Message.hide_loading();if(response.status!="successful"){for(var i=0;i<this.sets.length;++i){this.sets[i].fireEvent('error',response);}
return;}
var i,j,row,response_row,status,set;var entity_type=response.type;var entity_id;var rec,recs,rows=[];for(i=0;i<this.sets.length;i++){this.sets[i].destroy();}
for(i=0;i<response.rows.length;i++){response_row=response.rows[i];entity_id=response_row[0];row=SG.Repo.get_row(entity_type,entity_id);for(j=0;j<response_row.length;j++){status=(response.statuses?response.statuses[i+","+j]:null);if(typeof status==='string'&&status!=='valid')
row.set(response.columns[j],response_row[j],{type:status});else
row.set(response.columns[j],response_row[j]);}
rows.push(row);}
for(i=0;i<this.sets.length;i++){set=this.sets[i];recs=[];for(j=0;j<rows.length;j++){row=rows[j];rec=new SG.Data.Record(entity_type);rec.load(row);recs.push(rec);}
if(response.paging_info){set.set_paging_info(response.paging_info);}
if(response.bubble_source_entity){set.parent_entity=response.bubble_source_entity;}else{set.parent_entity=null;}
if(response.groups)
set.load(recs,response.groups,response.grouping,request);else
set.load(recs,null,null,request);}}});SG.ReadResponseHandler.LoadNews=function(){};Ext.extend(SG.ReadResponseHandler.LoadNews,SG.ResponseHandler,{handle_response:function(response,request)
{var i,j,k,response_row,row,entity,type,id,meta,found;if(response.status!="successful"){return;}
for(i=0;i<response.rows.length;i++){response_row=response.rows[i];SG.Repo.news_last_id=response_row[0];entity=response_row[1];if(!entity)continue;type=entity.type;id=entity.id;meta=response_row[2];row=SG.Repo.get_row(type,id);if(meta&&'attribute_name'in meta){if(meta.attribute_name=='retirement_date')
continue;if('new_value'in meta)
row.set(meta.attribute_name,meta.new_value);if('added'in meta){val=sg_deep_copy(row.get(meta.attribute_name))||[];for(j=0;j<meta.added.length;j++){found=false;for(k=0;k<val.length;k++){if(meta.added[j].type==val[k].type&&meta.added[j].id==val[k].id){found=true;break;}}
if(!found)
val.push(meta.added[j]);}
row.set(meta.attribute_name,val);}
if('removed'in meta){val=sg_deep_copy(row.get(meta.attribute_name))||[];for(j=0;j<meta.removed.length;j++){found=false;for(k=0;k<val.length;k++){if(meta.removed[j].type==val[k].type&&meta.removed[j].id==val[k].id){found=true;break;}}
if(found)
val.splice(k,1);}
row.set(meta.attribute_name,val);}}}
if(response.rows.length>0){SG.Repo.news_poll_interval==0;}else{if(SG.Repo.news_poll_interval==0)
SG.Repo.news_poll_interval=250;else if(SG.Repo.news_poll_interval<30*1000)
SG.Repo.news_poll_interval=SG.Repo.news_poll_interval*4;else
return;}
window.setTimeout(function(){var req=new SG.CrudRequest(SG.Repo.make_news_req(),new SG.ReadResponseHandler.LoadNews());req.send();},SG.Repo.news_poll_interval);}});SG.UpdateResponseHandler.UpdateRow=function(spec){this.update_spec=spec;};Ext.extend(SG.UpdateResponseHandler.UpdateRow,SG.ResponseHandler,{handle_response:function(response,request){if(request.use_loading_banner)
SG.Message.hide_loading();var row=SG.Repo.get_row(response.type,response.id);if(response.status=="successful"){var undo_spec=null;if(this.update_spec.multi_entity_update_mode==='add'){undo_spec=sg_deep_copy(this.update_spec);undo_spec.multi_entity_update_mode='remove';}else if(this.update_spec.multi_entity_update_mode==='remove'){undo_spec=sg_deep_copy(this.update_spec);undo_spec.multi_entity_update_mode='add';}else if(row.exists(response.column)){undo_spec=sg_deep_copy(this.update_spec);undo_spec.value=row.get(response.column);}
if(undo_spec!==null&&!this.update_spec.no_undo){undo_spec.no_undo=true;SG.Repo.register_undo({type:'update',spec:undo_spec});}
if(response.undo_queue){var uq;for(var i=0;i<response.undo_queue.length;i++){uq=sg_deep_copy(response.undo_queue[i]);uq.no_undo=true;SG.Repo.register_undo({type:uq.request_type?uq.request_type:'update',spec:uq});}}
row.set(response.column,response.value);}else if(response.status=="failed"){var error={type:'server_error',description:response.reason_description};row.set(response.column,response.value,error);}}});SG.DeleteResponseHandler.DeleteRow=function(spec){this.spec=spec;this.record=spec.record;};Ext.extend(SG.DeleteResponseHandler.DeleteRow,SG.ResponseHandler,{handle_response:function(response,request){if(request.use_loading_banner)
SG.Message.hide_loading();if(response.status=="successful"){var row=SG.Repo.get_row(response.type,response.id);row.retire();if(!this.spec.no_undo){SG.Repo.register_undo({type:'revive',spec:{type:response.type,id:response.id,record:this.record,no_undo:true}});}}else{this.record.on_data_change([{type:'retire_failed'}]);}}});SG.ReviveResponseHandler.ReviveRow=function(spec){this.spec=spec;this.record=spec.record;};Ext.extend(SG.ReviveResponseHandler.ReviveRow,SG.ResponseHandler,{handle_response:function(response,request){if(request.use_loading_banner)
SG.Message.hide_loading();if(response.status=="successful"){var row=SG.Repo.get_row(response.type,response.id);row.revive();if(!this.spec.no_undo){SG.Repo.register_undo({type:'retire',spec:{type:response.type,id:response.id,record:this.record,no_undo:true}});}}else{this.record.on_data_change([{type:'revive_failed'}]);}}});SG.CreateResponseHandler.CreateRow=function(spec){this.spec=spec;this.record=spec.record;};Ext.extend(SG.CreateResponseHandler.CreateRow,SG.ResponseHandler,{handle_response:function(response,request){if(request.use_loading_banner)
SG.Message.hide_loading();if(response.status=="successful")
{var row=SG.Repo.get_row(response.type,response.row[0]);var status;for(var i=0;i<response.row.length;i++){status=(response.statuses?response.statuses[0+","+i]:null);if(typeof status==='string'&&status!="valid")
row.set(response.columns[i],response.row[i],{type:status});else
row.set(response.columns[i],response.row[i]);}
this.record.load(row);row.create();if(!this.spec.no_undo){SG.Repo.register_undo({type:'retire',spec:{type:response.type,id:row.get_id(),record:this.record,no_undo:true}});}
SG.Repo.on_create({type:row.get_type(),id:row.get_id()});}else{this.record.on_data_change([{type:'create_failed'}]);}}});SG.SummarizeResponseHandler.LoadSummary=function(summary_set,key){this.summary_set=summary_set;this.key=key;};Ext.extend(SG.SummarizeResponseHandler.LoadSummary,SG.ResponseHandler,{handle_response:function(response,request){if(request.use_loading_banner)
SG.Message.hide_loading();if(response.status=="successful")
{if(response.request_type=="group_summarize")
{if(!this.summary_set.load_group_summaries){this.summary_set.group_summaries=response.group_summaries;this.summary_set.fireEvent('load',[this.key],this);}else{this.summary_set.load_group_summaries(this.key,response.group_summaries);}
return;}
var summaries=response.summaries;var data={};var sum;for(var i=0;i<summaries.length;i++){sum=summaries[i];data[sum['column']]=sum['value'];}
this.summary_set.load(this.key,data);}}});SG.Data.Row=function(type,id){this.type=type;this.id=id;this.data={};this.errors={};this.owners=[];};SG.Data.Row.prototype={get_type:function(){return this.type;},get_id:function(){return this.id;},get:function(key){return(this.data.hasOwnProperty(key))?this.data[key]:null;},set:function(key,value,error){var prev=this.get(key);this.errors[key]=error||null;this.data[key]=value;var change={type:"update",column:key,value:value,value_unchanged:(Ext.encode(value)==Ext.encode(prev)),state:"server"};this.notify_owners([change]);},get_error:function(key){return(this.errors[key]||null);},clear_error:function(key){this.errors[key]=null;},fill:function(keys,values){for(var i=0;i<keys.length;i++){this.data[keys[i]]=this.values[i];}},create:function(){this.notify_owners([{type:"create"}]);},retire:function(){this.notify_owners([{type:"retire"}]);},revive:function(){this.notify_owners([{type:"revive"}]);},notify_owners:function(changes){var owner;for(var i=0;i<this.owners.length;i++){owner=this.owners[i];if(owner&&typeof(owner.on_data_change)==="function"){owner.on_data_change.call(owner,changes);}}},exists:function(key){return this.data.hasOwnProperty(key);},keys:function(){var keys=[];for(var k in this.data){if(this.data.hasOwnProperty(k)){keys.push(k);}}
return keys;},clear:function(){this.data={};},add_owner:function(owner){this.owners.push(owner);},remove_owner:function(owner){var idx=this.owners.indexOf(owner);if(idx!==-1){this.owners.splice(idx,1);}}};SG.Data.Record=function(type){this.type=type;this.id=null;this.row=null;this.owner=null;this.state="new";this.local_data={};this.local_errors={};this.multi_entity_update_mode={};this.multi_entity_data={};};SG.Data.Record.prototype={get_type:function(){return this.type;},get_id:function(){return this.id;},get_state:function(){return this.state;},get:function(key){if(this.local_data.hasOwnProperty(key)){return this.local_data[key];}else if(this.row){return this.row.get(key);}else{return null;}},set:function(key,value,error){this.local_errors[key]=error||null;var match=(Ext.encode(this.get(key))===Ext.encode(value));if(this.local_errors[key]===null&&match)
return;if(this.state!=="new"&&this.state!=="retired")
this.state="dirty";this.local_data[key]=value;var change={type:"update",column:key,value:value,record:this,state:"pending"};this.notify_owner([change]);},multi_entity_set:function(key,value,mode,error){if(this.state!=="new"&&this.state!=="retired")
this.state="dirty";value=value||[];this.local_errors[key]=error||null;this.multi_entity_update_mode[key]=mode;this.multi_entity_data[key]=value;var i,j,idx,found,ident,ident_key,current,cur,new_value=[];switch(mode){case"set":new_value=value;break;case"add":current=this.get(key)||[];ident={};for(i=0;i<current.length;i++){cur=current[i];if(cur&&cur.type&&cur.id)
ident[cur.type+"_"+cur.id]=cur;}
for(i=0;i<value.length;i++){cur=value[i];if(cur&&cur.type&&cur.id){ident_key=cur.type+"_"+cur.id;if(!ident.hasOwnProperty(ident_key))
ident[ident_key]=cur;}}
for(ident_key in ident){if(ident.hasOwnProperty(ident_key))
new_value.push(ident[ident_key]);}
break;case"remove":current=this.get(key)||[];ident={};for(i=0;i<current.length;i++){cur=current[i];if(cur&&cur.type&&cur.id)
ident[cur.type+"_"+cur.id]=cur;}
for(i=0;i<value.length;i++){cur=value[i];if(cur&&cur.type&&cur.id){ident_key=cur.type+"_"+cur.id;if(ident.hasOwnProperty(ident_key))
delete ident[ident_key];}}
for(ident_key in ident){if(ident.hasOwnProperty(ident_key))
new_value.push(ident[ident_key]);}
break;}
this.local_data[key]=new_value;var change={type:"update",column:key,value:new_value,record:this,multi_entity_update_mode:mode,multi_entity_data:value,state:"pending"};this.notify_owner([change]);},get_error:function(key){if(this.local_errors.hasOwnProperty(key)){return this.local_errors[key];}else if(this.row){return this.row.get_error(key);}else{return null;}},get_fields:function(){var i,k,f={};var fields=[];if(this.row){var row_keys=this.row.keys();for(i=0;i<row_keys.length;i++){f[row_keys[i]]=true;}}
for(k in this.local_data){if(!this.local_data.hasOwnProperty(k))continue;f[k]=true;}
for(k in f){if(!f.hasOwnProperty(k))continue;fields.push(k);}
return fields;},retire:function(){this.state="retired";},copy_onto:function(target_rec){var fields=this.get_fields();for(var i=0;i<fields.length;i++)
{if(fields[i]!='id')
target_rec.set(fields[i],this.get(fields[i]));}},commit:function(no_undo){var spec={};var columns=[];var key;var committed_something=false;if(no_undo)
spec.no_undo=true;if(this.state=="new"){var values=[];for(key in this.local_data){if(!this.local_data.hasOwnProperty(key))continue;values.push({column:key,value:this.local_data[key]});}
var schema_fields=SG.schema.entity_fields[this.type];for(var f in schema_fields)
{if(!schema_fields.hasOwnProperty(f))continue;if(schema_fields[f].grid_column)
columns.push(schema_fields[f].name);}
spec={type:this.type,columns:columns,values:values,record:this,no_undo:no_undo===true};if(this.owner&&this.owner.drafts)
spec.drafts=true;if(this.id<0)
this.pre_commit_id=this.id;committed_something=true;SG.Repo.create(spec);}else if(this.state=="clean"){return false;}else if(this.state=="retired"){if(this.id>0)
{spec={type:this.type,id:this.id,record:this,no_undo:no_undo===true};if(this.owner&&this.owner.drafts)
spec.drafts=true;committed_something=true;SG.Repo.retire(spec);}}else if(this.state=="dirty"){var sf;for(key in this.local_data){if(!this.local_data.hasOwnProperty(key))continue;if(this.local_errors[key]&&this.local_errors[key].content&&this.local_errors[key].content.type!='server_error')
{continue;}
sf=SG.schema.get_field(this.type,key);spec={type:this.type,id:this.id,column:key,value:this.local_data[key],no_undo:sf['no_undo']===true||no_undo===true};if(this.owner&&this.owner.drafts)
spec.drafts=true;if(this.owner&&this.owner.parent_entity){spec.parent_entity=this.owner.parent_entity;}
if(key in this.multi_entity_update_mode){spec.multi_entity_update_mode=this.multi_entity_update_mode[key];if(key in this.multi_entity_data)
spec.value=this.multi_entity_data[key];}
committed_something=true;SG.Repo.update(spec);}}
return committed_something;},make_like_new:function(){var row=new SG.Data.Row(this.type,this.id);for(key in this.local_data){if(!this.local_data.hasOwnProperty(key))
continue;row.data[key]=this.local_data[key];}
this.load(row);},set_owner:function(owner){this.owner=owner;},destroy:function(){this.owner=null;this.state="destroyed";if(this.row){this.row.remove_owner(this);}},load:function(row){this.row=row;this.row.add_owner(this);this.id=row.get_id();this.local_data={};this.state="clean";},notify_owner:function(changes){if(this.owner&&typeof(this.owner.on_record_change)==="function"){this.owner.on_record_change.call(this.owner,changes);}},on_data_change:function(changes){var change;var bubble_changes=[];for(var i=0;i<changes.length;i++){change=changes[i];change.record=this;if(change.type=='retire_failed'){change.record.state='clean';bubble_changes.push(change);continue;}
if(change.type=="revive"){change.record.state='clean';bubble_changes.push(change);continue;}
if(change.type!='update'){bubble_changes.push(change);continue;}
if(this.row&&this.row.get_error(change.column)){this.local_errors[change.column]=this.row.get_error(change.column);bubble_changes.push(change);continue;}
if(change.value_unchanged&&!this.local_data.hasOwnProperty(change.column)){continue;}
if(change.column in this.local_data)delete this.local_data[change.column];if(change.column in this.local_errors)delete this.local_errors[change.column];if(change.column in this.multi_entity_update_mode)delete this.multi_entity_update_mode[change.column];if(change.column in this.multi_entity_data)delete this.multi_entity_data[change.column];bubble_changes.push(change);this.update_state();}
this.notify_owner(bubble_changes);},blank:function(str){return(str===null||str==='');},update_state:function(){var count=0;for(var col in this.local_data){if(this.local_data.hasOwnProperty(col))count+=1;}
if(this.state=='dirty'&&count==0){this.state='clean';}},is_dirty:function(key){if(this.local_data.hasOwnProperty(key)){return true;}else{return false;}},get_status:function(key){var error=this.get_error(key);if(error&&error.type){return error.type;}else{return"valid";}},revert:function(key){if(this.row)this.row.clear_error(key);delete this.local_data[key];delete this.local_errors[key];delete this.multi_entity_update_mode[key];delete this.multi_entity_data[key];this.update_state();},get_revert_value:function(key){if(this.row){return this.row.get(key)}else{return null;}}};SG.Data.Set=function(type){this.type=type;this.records=[];this.id_map={};this.paging_info={};this.loaded=false;this.grouped=false;this.batch_count=0;this.entity_type=type;SG.Repo.on('capture_events',this.on_capture_events,this);this.events={'load':true,'change':true,'error':true};};Ext.extend(SG.Data.Set,Ext.util.Observable,{get_type:function(){return this.type;},get_record:function(idx){return this.records[idx];},get_index:function(record){return this.records.indexOf(record);},get_record_by_id:function(id){return this.id_map[id];},get_record_by_pre_commit_id:function(id){var rec=this.get_record_by_id(id);if(rec)
return rec;for(var i=0;i<this.records.length;i++)
if(this.records[i].pre_commit_id==id)
return this.records[i];return null;},get_ids:function(){var ids=[];for(var i=0;i<this.records.length;i++){ids.push(this.records[i].get_id());}
return ids;},count:function(){return this.records.length;},count_status:function(status,complement)
{var count=0;if(complement)
{for(var i=0;i<this.records.length;i++)
{if(this.records[i].get_state()!=status)
count++;}}
else
{for(var i=0;i<this.records.length;i++)
{if(this.records[i].get_state()==status)
count++;}}
return count;},get_group:function(idx){return this.groups_with_idx[idx];},group_count:function(){return this.groups_with_idx.length;},get_synthetic_group:function(idx){return this.synthetic_group_map[idx];},load:function(records,groups,grouping,request){var i,rec,request_id;if(request&&request.request_id)
request_id=request.request_id;if(this.loaded)this.destroy();for(i=0;i<records.length;i++){rec=records[i];rec.set_owner(this);this.id_map[rec.get_id()]=rec;}
if(groups&&grouping){this.__load_groups__(groups,grouping);this.grouped=true;}else{this.groups=null;this.grouped=false;}
this.loaded=true;this.records=records;this.fireEvent('load',this,request_id);},__load_groups__:function(groups,grouping)
{this.grouping=grouping;this.groups_with_idx=[];for(var i=0;i<groups.length;i++)
{var group=groups[i];group.idx=i;this.groups_with_idx.push(group);}
if(this.grouping.length==1)
{this.groups=this.groups_with_idx;return;}
SG.Data.Set.__group_count__=0;this.synthetic_group_map={};this.groups=this.__create_synthetic_groups__(this.groups_with_idx,0);},__create_synthetic_groups__:function(groups,depth)
{if(groups.length==0||depth==(this.grouping.length-1))
{SG.Data.Set.__group_count__+=groups.length;return groups;}
var i;var ret=[];var last_group=groups[0];var groups_to_process=[];groups_to_process.push(last_group);var synthetic_group={};var group_count;for(i=1;i<groups.length;i++)
{var group=groups[i];if(last_group.values[depth]!=group.values[depth])
{group_count=SG.Data.Set.__group_count__;synthetic_group={synthetic:true,depth:depth,values:last_group.values.concat([]),display_values:last_group.display_values.concat([]),template_values:last_group.template_values.concat([]),groups:this.__create_synthetic_groups__(groups_to_process,depth+1)};synthetic_group.idx=group_count+'_'+(SG.Data.Set.__group_count__-1)+'_'+depth;ret.push(synthetic_group);this.synthetic_group_map[synthetic_group.idx]=synthetic_group;last_group=group;groups_to_process=[];}
groups_to_process.push(group);}
group_count=SG.Data.Set.__group_count__;synthetic_group={synthetic:true,depth:depth,values:last_group.values.concat([]),display_values:last_group.display_values.concat([]),template_values:last_group.template_values.concat([]),groups:this.__create_synthetic_groups__(groups_to_process,depth+1)};synthetic_group.idx=group_count+'_'+(SG.Data.Set.__group_count__-1)+'_'+depth;ret.push(synthetic_group);this.synthetic_group_map[synthetic_group.idx]=synthetic_group;return ret;},remove:function(records)
{if(records.multi_entity_set)
records=[records];var i;for(i=0;i<records.length;i++)
{var record=records[i];var idx=this.records.indexOf(record);var id=record.get_id();if(idx!==-1){this.records.splice(idx,1);delete this.id_map[id];}}
if(this.grouped)
this.remove_from_groups(records);},remove_from_groups:function(records){var new_groups=[];var i,j;for(i=0;i<this.groups_with_idx.length;i++)
{var group=this.groups_with_idx[i];for(j=0;j<records.length;j++)
{var record=records[j];var id=record.get_id();var idx=group.ids.indexOf(id);if(idx!==-1)
group.ids.splice(idx,1);}
if(group.ids.length!=0)
new_groups.push(group);}
this.__load_groups__(new_groups,this.grouping);},new_record:function(new_id){var rec=new SG.Data.Record(this.type);if(typeof new_id==='undefined')
rec.temp_id=this.generate_unused_id();else
rec.temp_id=new_id;rec.id=rec.temp_id;rec.set_owner(this);this.records.push(rec);this.id_map[rec.get_id()]=rec;return rec;},insert_new_record:function(index,new_id)
{var rec=new SG.Data.Record(this.type);if(typeof new_id==='undefined')
rec.temp_id=this.generate_unused_id();else
rec.temp_id=new_id;rec.id=rec.temp_id;rec.set_owner(this);this.records.splice(index,0,rec);this.id_map[rec.get_id()]=rec;return rec;},generate_unused_id:function()
{do{id=-Math.floor(Math.random()*1000000);}while(this.id_map[id])
return id;},new_temp_record:function(){var rec=this.new_record();rec.state="temp";return rec;},copy_record:function(record,new_id)
{var new_rec=this.new_record(new_id);record.copy_onto(new_rec);return new_rec;},commit:function(no_undo){SG.Repo.start_batch();for(var i=0;i<this.records.length;i++){this.records[i].commit(no_undo);}
if(this.field_to_recalculate_on_task_schedule_changes)
SG.Repo.field_to_recalculate_on_task_schedule_changes=this.field_to_recalculate_on_task_schedule_changes;SG.Repo.end_batch();if(this.field_to_recalculate_on_task_schedule_changes)
SG.Repo.field_to_recalculate_on_task_schedule_changes=null;},destroy:function(){for(var i=0;i<this.records.length;i++){this.records[i].destroy();}
this.records=[];this.groups=[];this.id_map={};this.grouped=false;this.loaded=false;SG.Repo.un('collect_events',this.on_collect_events,this);},is_loaded:function(){return this.loaded;},is_grouped:function(){return this.grouped;},get_paging_info:function(){return this.paging_info;},set_paging_info:function(info){this.paging_info=info;},start_batch:function(){if(this.batch_count==0)this.collected_events=[];this.batch_count+=1;},end_batch:function(){this.batch_count-=1;if(this.batch_count==0){this.notify(this.collected_events);this.collected_events=[];}},in_batch:function(){return(this.batch_count>0);},notify:function(changes){if(this.in_batch()){this.collected_events=this.collected_events.concat(changes);}else if(changes.length>0){this.fireEvent('change',changes);}},on_capture_events:function(state){if(state=="start"){this.start_batch();}else if(state=="stop"){this.end_batch();}},on_record_change:function(changes){var change;var records_to_retire=[];for(var i=0;i<changes.length;i++){change=changes[i];if(change.type=="retire"){records_to_retire.push(change.record);}else if(change.type=="create"){if(change.record.temp_id){delete this.id_map[change.record.temp_id];delete change.record.temp_id;}
this.id_map[change.record.get_id()]=change.record;}}
if(records_to_retire.length>0)
this.remove(records_to_retire);this.notify(changes);},append_record:function(rec){if(this.type!=rec.type)
return;rec.set_owner(this);this.records.push(rec);this.id_map[rec.get_id()]=rec;this.notify([{type:"append",record:rec}]);},prepend_record:function(rec){if(this.type!=rec.type)
return;rec.set_owner(this);this.records.splice(0,0,rec);this.id_map[rec.get_id()]=rec;this.notify([{type:"prepend",record:rec}]);},insert_record:function(rec,index)
{if(this.type!=rec.type)
return;rec.set_owner(this);this.records.splice(index,0,rec);this.id_map[rec.get_id()]=rec;this.notify([{type:"insert",record:rec}]);},get_duplicates_data_set:function()
{var new_set=new SG.Data.Set(this.type);var new_rec;for(var i=0;i<this.records.length;i++)
{if(this.records[i].state!='retired')
{new_rec=new_set.new_record();this.records[i].copy_onto(new_rec);}}
return new_set;}});SG.Data.SummarySet=function(type){this.type=type;this.loaded=false;this.in_batch=false;this.data={};SG.Repo.on('capture_events',this.on_capture_events,this);this.events={load:true};};Ext.extend(SG.Data.SummarySet,Ext.util.Observable,{get:function(key,field_name){if(key in this.data){return this.data[key][field_name];}else{return null;}},load:function(key,values){this.data[key]=values;if(this.in_batch){this.collected_loads.push(key);}else{this.loaded=true;this.fireEvent('load',[key],this);}},load_group_summaries:function(key,group_summaries){this.group_summaries=group_summaries;this.fireEvent('load',[key],this);},is_loaded:function(){return this.loaded;},reset:function(){this.loaded=false;this.in_batch=false;this.data={};this.group_summaries=null;},destroy:function(){this.loaded=false;this.in_batch=false;this.data={};this.group_summaries=null;SG.Repo.un('capture_events',this.on_capture_events,this);},start_batch:function(){this.in_batch=true;this.collected_loads=[];},end_batch:function(){this.in_batch=false;if(this.collected_loads&&this.collected_loads.length>0){this.loaded=true;this.fireEvent('load',this.collected_loads,this);}},on_capture_events:function(state){if(state=="start"){this.start_batch();}else if(state=="stop"){this.end_batch();}},});SG.Cell=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.Cell,SG.Component,{templates:{wrapped_noedit:'<div class="sg_cell_content {extra}">'+'<div class="sg_cell_edit_link">'+'<div class="{edit_icon}"></div></div>{value}</div>'},init_component:function(){this.schema_field=SG.schema.get_field(this.entity_type,this.field);this.init_cell();},init_cell:function(){},is_editable:function(record){if(this.read_only){return false;}
if(typeof this.override_editable!='undefined')
return this.override_editable;if(record){var error=record.get_error(this.field);if(error&&error.type==='no_bubble_source')
return false;else if(error&&error.type=='blocked_entity')
return false;return SG.schema.can_edit_field_on_record(record,this.schema_field,undefined,this.field);}else{return SG.schema.can_edit_field(this.entity_type,this.field);}},get_renderer:function(record)
{var def=this.schema_field.renderer||SG.Renderers.renderer_defaults[this.schema_field.data_type]||"text";if(this.field=='tag_list'){def="basic_multi_entity";}else if(this.field=='step'&&this.entity_type=='Task'){def="step_entity";}else if(this.field=='this_file'&&this.entity_type=='Attachment'){def="url_no_icon";}
return SG.Renderers[def];},get_styles:function(record)
{var styles={color:null,'background-color':null,'text-decoration':null,'font-style':null,'font-weight':null,padding:null};var value=record.get(this.field);if(this.schema_field.data_type=="status_list"){var status_list=SG.schema.status_list[value];if(status_list){styles['background-color']=SG.schema.status_list[value].bg_color;}}
else if(this.schema_field.entity_type=='Status'&&this.schema_field.name=='icon')
{var color=record.get('bg_color');if(color!=null)
styles['background-color']='rgb('+color+')';}
var formatting_rules;if(record.override_formatting_rules&&record.override_formatting_rules[this.field])
formatting_rules=record.override_formatting_rules[this.field];else
formatting_rules=this.cell_manager.get_formatting_rules(this.field,this.schema_field);if(formatting_rules)
{this.inspect_formatting_rules(formatting_rules);for(var i=0;i<formatting_rules.length;i++)
{var rule=formatting_rules[i];if(rule.enabled===false)
continue;if(!rule.condition||SG.evaluate_condition(record,sg_deep_copy(rule.condition)))
{if(rule.text_color)
styles['color']=sg_css_color(rule.text_color);if(rule.background_color)
styles['background-color']=sg_css_color(rule.background_color);if(rule.bold)
styles['font-weight']='bold';if(rule.italic)
styles['font-style']='italic';if(rule.strike_through)
styles['text-decoration']='line-through';}}}
return styles;},inspect_formatting_rules:function(formatting_rules)
{},get_html_styles:function(record){var styles=this.get_styles(record);var html='';for(var s in styles){if(!styles.hasOwnProperty(s))continue;html+=s+": "+styles[s]+";";}
return html;},get_classes:function(record){var classes=['sg_cell'];var type_class=this.get_type_formatting_class();if(type_class)
classes.push(type_class);return classes;},get_type_formatting_class:function()
{if(this.schema_field.entity_type=='HumanUser'&&this.schema_field.name=='password_strength')
return'sg_password_strength';else if(!this.detail_link&&['currency','number','float'].indexOf(this.schema_field.data_type)>-1)
return'sg_number';else if(this.schema_field.data_type=='status_list'||(this.schema_field.entity_type=='Status'&&this.schema_field.name=='icon'))
return'sg_cell_status_list';else
return null;},get_html_classes:function(record){var classes=this.get_classes(record);return classes.join(' ');},get_attributes:function(record,group_idx){var attributes={};var rec_status=record.get_status(this.field);attributes['cm_id']=this.cell_manager.cell_manager_id;attributes['field']=this.field;attributes['record_type']=record.get_type();attributes['record_id']=record.get_id();attributes['status']=rec_status;attributes['data_type']=this.schema_field.data_type;if(typeof group_idx!=='undefined')
attributes['group_idx']=group_idx;var error=record.get_error(this.field);if(error&&error.description){if(error.description.indexOf('The field is not editable for this user')==0&&!SG.globals.current_user.admin)
{attributes['sg_tip']="You don't have permission to edit this field.";}else{attributes['sg_tip']=error.description;}}else if(error&&error.type=='no_bubble_source'){attributes['sg_tip']="No valid source for this linked field - parent missing or wrong type.";}else if(error&&error.type=='blocked_entity'){attributes['sg_tip']="Some values were removed because you don't have permission to see them.";}else{var tip=this.get_tooltip_content(record);if(tip)
attributes['sg_tip']=tip;}
attributes['clip_tip']=this.should_clip_tip(record,rec_status);return attributes;},should_clip_tip:function(record,rec_status)
{if(this.schema_field.entity_type=='Status'&&this.schema_field.name=='system')
{var val=record.get(this.field);return!val;}
else if(this.schema_field.tooltip)
return false;else if(this.schema_field.data_type=='status_list')
return false;else if(this.use_tip||rec_status!="valid")
return false;else
return true;},get_html_attributes:function(record,group_idx){var attributes=this.get_attributes(record,group_idx);var html='';for(var a in attributes){if(!attributes.hasOwnProperty(a))continue;html+=a+'="'+attributes[a]+'" ';}
return html;},get_content:function(record){var value=record.get(this.field);var value_html=this.render_no_value_label(value);if(!value_html){var renderer=this.get_renderer(record);value_html=renderer.render_nbsp.call(renderer,value,this.schema_field,record);var data_type=this.schema_field.data_type;if(this.detail_link===true&&(data_type==="text"||data_type==="number")){value_html=this.get_detail_link(record,value_html);}}
var edit_icon;if(this.schema_field.query)
edit_icon='icon_info_dark';else
edit_icon='icon_edit_disabled';return this.templates.wrapped_noedit.apply({value:value_html,edit_icon:edit_icon});},render_no_value_label:function(value){if(!this.cell_manager.field_property_callback)
return null;var no_value=false;if(value===null||value===undefined)
no_value=true;if((!no_value&&value.constructor==Array&&value.length==0)||(!no_value&&this.schema_field.data_type=='text'&&value=='')){no_value=true;}
if(!no_value)
return null;var callback=this.cell_manager.field_property_callback;var field_property=callback.fn.call(callback.scope,this.schema_field);if(field_property&&field_property.show_label===false){if(field_property.field_label_override&&field_property.field_label_override!='')
return'<span class="empty_cell">'+field_property.field_label_override+'</span>';else
return'<span class="empty_cell">'+this.schema_field.display_name+'</span>';}else{return null;}},get_tooltip_content:function(record){if(this.use_tip===false||this.tip_template===null||this.tip_template==='')
return null;if(this.schema_field.tooltip)
return this.schema_field.tooltip;var value=record.get(this.field);var tip_template=this.tip_template?this.tip_template:'{value}';var tip=tip_template;var value_index=tip_template.indexOf('{value}');if(value_index>-1)
{var renderer=this.get_renderer(record);var value_attr=renderer.render_for_attribute.call(renderer,value,this.schema_field,record);value_attr=Ext.util.Format.htmlEncode(value_attr);tip=tip_template.substring(0,value_index)+value_attr+tip_template.substring(value_index+7);}
return tip;},get_field_display_name:function(){return SG.schema.get_field_display_name(this.entity_type,this.field,this.schema_field);},get_detail_link:function(record,name){var detail={type:record.get_type(),id:record.get_id(),name:name};return SG.Renderers.render_one_detail_link(detail);},render:function(record,group_idx){return{cell_content:this.get_content(record),cell_styles:this.get_html_styles(record),cell_classes:this.get_html_classes(record),cell_attributes:this.get_html_attributes(record,group_idx)};},update_cell:function(record,no_green_flash,use_widget_dom_cache){if(typeof no_green_flash=='undefined')
no_green_flash=false;if(this.autocommit!==true)
no_green_flash=true;var status=record.get_status(this.field);var is_dirty=record.is_dirty(this.field);var cell_elems=null;var widget=this.get_parent_widget();if(use_widget_dom_cache&&widget&&typeof widget.get_dom_elements_for_cell==='function')
{cell_elems=widget.get_dom_elements_for_cell(this.field,record.get_id(),record.get_type());}
if(!cell_elems)
{var sel='.sg_cell[field="'+this.field+'"][record_id="'+record.get_id()+'"][record_type="'+record.get_type()+'"]';cell_elems=sg_find_all(sel,this.container.dom);}
var cell_elem;var cell_styles;var cell_bg;var reset_bg;var i;for(i=0;i<cell_elems.length;i++){cell_elem=Ext.get(cell_elems[i]);if(cell_elem.dom.firstChild&&cell_elem.dom.firstChild.hasAttribute('sg_cell_content_wrapper')){Ext.get(cell_elem.dom.firstChild).update(this.get_content(record));}else{cell_elem.update(this.get_content(record));}
this.update_attributes(record,cell_elem);cell_styles=this.get_styles(record);cell_bg=cell_styles['background-color']||this.cell_manager.background_color||'#DDDDDD';reset_bg=cell_styles['background-color']||'';var row=cell_elem.findParent('div.row');if(row&&row.className.indexOf('selected')>-1)
cell_bg='rgb(184,184,213)';cell_elem.applyStyles(cell_styles);if(!no_green_flash&&status==='valid'&&!is_dirty)
{var elem_to_flash=cell_elem;var fake_input_div=cell_elem.child('div.fake_input');if(fake_input_div)
elem_to_flash=fake_input_div;var cm_id=elem_to_flash.dom.getAttribute('cm_id');if(cm_id)
elem_to_flash.dom.removeAttribute('cm_id');elem_to_flash.animate({backgroundColor:{from:'#00FF00',to:cell_bg}},0.7,function(){this.dom.style.backgroundColor=reset_bg;if(cm_id)
this.dom.setAttribute('cm_id',cm_id);},'easeOut','color');}}},update_attributes:function(record,cell_elem){var attribs=this.get_attributes(record);for(var k in attribs){if(!attribs.hasOwnProperty(k))continue;cell_elem.dom.setAttribute(k,attribs[k]);}},render_summary:function(type,value,extra){var sr=SG.SummaryRenderers[type];var r=this.get_renderer();var content='';if(sr){var sv=sr(value,extra,this.schema_field,r);if(sv==='')sv="&nbsp;";content=sv;}else{content=r.render_nbsp(value,this.schema_field);}
var cls=this.get_type_formatting_class()||'';if(type=='status_percentage')
cls='sg_cell_align_right';else if(type=='record_count')
cls='sg_record_count';return{summary_content:content,summary_classes:cls};},on_click:function(context){},on_dblclick:function(context){this.select_text(context.cell_elem);},on_keydown:function(context,e){},on_scroll:function(context){},on_focus:function(context){},on_blur:function(context){},get_context_menu_items:function(context){return[];},validate:function(record)
{var editor=SG.GridEditorFactory(this.schema_field.data_type);editor.column_name=this.field;editor.record=record;var value;if(this.schema_field.data_type=='date_time')
{var stored_value=record.get(this.field);var date_time_value=Date.sgParseDateTime(stored_value);if(date_time_value&&date_time_value.getDate)
return'valid';else
return editor.validate(stored_value);}
else if(this.schema_field.data_type=='timecode')
{var num_value=record.get(this.field);if(num_value===null||num_value==='')
value='';else
value=SG.Timecode.seconds_to_timecode(num_value/1000.0);return editor.validate(value);}
else
{value=record.get(this.field);return editor.validate(value);}},select_text:function(el){var sel=window.getSelection();if(sel.rangeCount>0)
sel.removeAllRanges();var range=document.createRange();range.selectNode(el.firstChild);sel.addRange(range);}});SG.EditableCell=function(config){Ext.apply(this,config);SG.EditableCell.superclass.constructor.call(this);};Ext.extend(SG.EditableCell,SG.Cell,{templates:{checkbox:'<div class="sg_cell_content sg_cell_single_click_edit sg_cell_edit_trigger">{value}</div>',wrapped_editor:'<div class="sg_cell_content {extra}">'+'<div class="sg_cell_edit_link sg_cell_single_click_edit sg_cell_edit_trigger">'+'<div class="{edit_icon}"></div></div>{value}</div>',color_editor:'<div class="sg_cell_content sg_cell_single_click_edit sg_cell_edit_trigger {extra}">'+'<div style="width:16px;">{value}</div></div>',},init_cell:function(){if(this.schema_field.data_type==='color'){this.no_keyboard_navigation=true;}},get_renderer:function(record)
{var r=SG.EditableCell.superclass.get_renderer.call(this,record);if(this.schema_field.data_type==='checkbox'&&r==SG.Renderers['checkbox_disabled']&&record&&this.is_editable(record))
{r=SG.Renderers['checkbox'];}
return r;},get_classes:function(record){var classes=SG.EditableCell.superclass.get_classes.call(this,record);if(this.is_editable(record))
classes.push('sg_cell_editable');return classes;},get_content:function(record){if(!this.is_editable(record)){return SG.EditableCell.superclass.get_content.call(this,record);}
var value=record.get(this.field);var value_html=this.render_no_value_label(value);if(!value_html){var renderer=this.get_renderer(record);value_html=renderer.render_nbsp.call(renderer,value,this.schema_field,record);var data_type=this.schema_field.data_type;if(this.detail_link===true&&(data_type==="text"||data_type==='number')){value_html=this.get_detail_link(record,value_html);}}
var extra='';if(this.schema_field.data_type==='checkbox')
html=this.templates.checkbox.apply({value:value_html});else if(this.schema_field.data_type==='color'&&this.schema_field.entity_type=='FormattingRule')
html=this.templates.color_editor.apply({value:value_html});else
{var edit_icon;switch(this.schema_field.data_type)
{case'date':edit_icon='icon_calendar_edit';break;case'date_time':edit_icon='icon_calendar_edit';break;case'list':edit_icon='project_nav_menu_up';break;case'status_list':edit_icon='project_nav_menu_up';extra='sg_cell_status_list';break;case'url':edit_icon='project_nav_menu_up';break;default:edit_icon='icon_edit';break;}
html=this.templates.wrapped_editor.apply({value:value_html,edit_icon:edit_icon,extra:extra});}
return html;},edit_cell:function(context){var editor=SG.GridEditorFactory(this.schema_field.editor||this.schema_field.data_type);var edit_context={container:this.edit_container,cell_element:context.cell_elem,record:context.record,column_name:this.field,projects:this.projects,parent_entity:this.data_set.parent_entity,click_target:context.elem,auto_commit:this.autocommit,cell:this};if('group_idx'in context){edit_context.group_idx=context.group_idx;}
var cell=this;setTimeout(function(){cell.cell_manager.active_editor=editor;SG.globals.active_editor=editor;cell.active_editor=editor;cell.active_editor.on('blur',cell.on_editor_blur,cell);cell.active_editor.on('specialkey',cell.on_editor_special_key,cell);cell.active_editor.edit(edit_context);if(cell.cell_manager.on_cell_edit)
cell.cell_manager.on_cell_edit.fn.call(cell.cell_manager.on_cell_edit.scope,context);},0);},on_click:function(context){var target=context.elem;if(target.dom.tagName=='A')return;if(this.double_click_for_edit){var single_click_edit_trigger=target.findParent('.sg_cell_single_click_edit',this.container);if(!single_click_edit_trigger)return;}else{var edit_trigger=target.findParent('.sg_cell_edit_trigger',this.container);if(!edit_trigger)return;}
this.edit_cell(context);},on_dblclick:function(context){if(!this.is_editable(context.record))
SG.EditableCell.superclass.on_dblclick.call(this,context);if(!this.double_click_for_edit)return;var target=context.elem;var edit_trigger=target.findParent('.sg_cell_editable',this.container,true);if(!edit_trigger)return;this.edit_cell(context);},on_editor_special_key:function(editor,key_id,shift_key_down)
{var direction;if(key_id==Ext.EventObject.RETURN){direction=shift_key_down?'up':'down';}else if(key_id==Ext.EventObject.TAB){direction=shift_key_down?'left':'right';}else if(key_id==Ext.EventObject.ESC){this.cancel_edit();return;}else{return;}
var context={field:this.field,record:this.active_editor.record,cell_elem:this.active_editor.cell_elem,direction:direction};if('group_idx'in this.active_editor)
context.group_idx=this.active_editor.group_idx;var rec=this.active_editor.get_record();this.apply_edit();if(this.cell_manager.require_project&&this.schema_field.name=='project')
{var proj=rec.get('project');if(proj)
this.cell_manager.navigate_cells(context);}
else
this.cell_manager.navigate_cells(context);},on_editor_blur:function()
{this.apply_edit();},apply_edit:function()
{if(this.active_editor)
{var rec=this.active_editor.get_record();this.active_editor.update_and_hide();this.active_editor.un('blur',this.on_editor_blur);this.active_editor.un('specialkey',this.on_editor_special_key);if(this.cell_manager.active_editor==this.active_editor)
this.cell_manager.active_editor=null;if(SG.globals.active_editor==this.active_editor)
SG.globals.active_editor=null;this.active_editor=null;if(this.autocommit!==false)
rec.commit();this.cell_manager.cell_edit_applied(this.field,rec,this);}},cancel_edit:function()
{if(this.active_editor)
{var rec=this.active_editor.get_record();this.active_editor.cancel();if(this.cell_manager.active_editor==this.active_editor)
this.cell_manager.active_editor=null;if(SG.globals.active_editor==this.active_editor)
SG.globals.active_editor=null;this.active_editor=null;rec.revert(this.field);this.update_cell(rec,true);}}});SG.FakeInputCell=function(config){Ext.apply(this,config);SG.FakeInputCell.superclass.constructor.call(this);this.autocommit=false;};Ext.extend(SG.FakeInputCell,SG.EditableCell,{get_renderer:function(record){var ren=this.schema_field.renderer||SG.Renderers.renderer_defaults[this.schema_field.data_type]||"text";if(this.field=='step'&&this.entity_type=='Task')
ren="step_entity";else if(this.field=='entity_type'&&this.entity_type=='TaskTemplate')
ren="entity_type";else if(ren==="entity")
ren="basic_entity";else if(ren==="multi_entity")
ren="basic_multi_entity";else if(this.schema_field.data_type==='checkbox'&&ren=='checkbox_disabled'&&this.is_editable(record))
ren="checkbox";else if(this.entity_type=='HumanUser'&&this.field=='email')
ren='text';return SG.Renderers[ren];},get_classes:function(record){var classes=SG.FakeInputCell.superclass.get_classes.call(this,record);var idx=classes.indexOf('sg_cell_editable');if(idx!==-1)classes.splice(idx,1);classes.push('sg_cell_fake_input');return classes;},get_styles:function(record){return{};},get_content:function(record){var value=record.get(this.field);var renderer=this.get_renderer(record);var value_html=renderer.render_nbsp.call(renderer,value,this.schema_field,record);var classes="sg_cell_content";if((this.schema_field.entity_type=='Status'&&this.schema_field.name=='bg_color')||(this.schema_field.entity_type=='Status'&&this.schema_field.name=='icon'))
classes+=' fake_input_plain_style';else
classes+=' fake_input';if(this.is_editable(record))
classes+=' sg_cell_edit_trigger';return'<div class="'+classes+'">'+value_html+'</div>';}});SG.AttachmentsCell=function(config){Ext.apply(this,config);SG.AttachmentsCell.superclass.constructor.call(this);};Ext.extend(SG.AttachmentsCell,SG.Cell,{templates:{cell:'<div class="sg_cell_content">{rows}</div>',row:'<span sg_tip="{sg_tip}">{file_name}&nbsp;<span class="attachment_size">{file_size}</span></span>',deletable_row:'<span sg_tip="{sg_tip}">{file_name}&nbsp;<span class="attachment_size">{file_size}</span>'+'<div record_id="{record_id}" class="trash attachment_delete"></div></span>',},init_cell:function(){this.attachment_set=this.new_data_set('Attachment',this.on_attachment_load,this.on_attachment_change);},on_data_load:function(){var ids=[];var rec,attach;var i,j;for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);attach=rec.get('attachments');for(j=0;j<attach.length;j++){if(attach[j].id)ids.push(attach[j].id);}}
if(ids.length===0)return;var spec={type:'Attachment',ids:ids,columns:['this_file','file_size','created_by','created_at'],result:this.attachment_set};SG.Repo.find(spec);},on_data_change:function(change)
{if(change.type=="update"&&change.state=="server"){this.on_data_load();}},on_attachment_load:function(){var rec;for(var i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);this.update_cell(rec);}},on_attachment_change:function(changes){var i,change;for(var i=0;i<changes.length;i++){var change=changes[i];if(["retire","revive"].indexOf(change.type)!==-1){this.on_data_load();break;}}},get_content:function(record){if(this.attachment_set.is_loaded()){var attachments=record.get('attachments');var attach,attach_id,value,this_file,created_by;var rows=[],row,tooltip;var this_file_sf=SG.schema.get_field("Attachment","this_file");for(var i=0;i<attachments.length;i++){attach_id=attachments[i].id;attach=this.attachment_set.get_record_by_id(attach_id);if(!attach)continue;this_file=attach.get('this_file');created_by=attach.get('created_by');tooltip=this_file.display_name+'[[br]]';if(created_by)
tooltip+='Created by: '+attach.get('created_by').name+'[[br]]';tooltip+='Date Created: '+SG.Renderers.friendly_date_time.render(attach.get('created_at'));if(this_file.display_name&&this_file.display_name.length>20)
{this_file.display_name=this_file.display_name.substr(0,19)+'...';}
var template=SG.schema.can_retire_entity('Attachment')?this.templates.deletable_row:this.templates.row;row=template.apply({sg_tip:tooltip,file_name:SG.Renderers.url_no_icon.render_nbsp(this_file,this_file_sf),file_size:SG.Renderers.file_size.render_nbsp(attach.get('file_size')),record_id:attach_id});rows.push(row);}
return this.templates.cell.apply({rows:rows.join(', ')});}else{return"";}},on_click:function(context)
{var trash=context.elem.findParent('div.attachment_delete');if(trash)
{var trash_id=trash.getAttribute('record_id');var dd=new SG.util.DeleteAttachment({entity_ds:this.data_set,entity_id:context.record.get_id(),attachment_id:trash_id});}},});SG.TextAreaCell=function(config){Ext.apply(this,config);SG.TextAreaCell.superclass.constructor.call(this);this.autocommit=false;};Ext.extend(SG.TextAreaCell,SG.Cell,{templates:{content:'<textarea {disabled} {placeholder}>{value}</textarea>'},get_classes:function(record){var classes=SG.TextAreaCell.superclass.get_classes.call(this,record);classes.push('sg_cell_textarea');return classes;},is_textarea_cell:true,get_styles:function(record){return{};},get_value:function(record){var value=record.get(this.field);var renderer=this.get_renderer();var value_html=renderer.render.call(renderer,value,this.schema_field,record);return value_html;},get_content:function(record){var value=this.get_value(record);var placeholder;if(this.placeholder_text)
placeholder='placeholder="'+this.placeholder_text+'"';return this.templates.content.apply({disabled:this.read_only?' disabled="disabled"':'',placeholder:placeholder,value:value});},update_cell:function(record,no_green_flash){if(!this.autocommit)
no_green_flash=false;var status=record.get_status(this.field);var sel='.sg_cell[field='+this.field+'][record_id="'+record.get_id()+'"]';var cell_elem=sg_find(sel,this.container.dom);cell_elem=Ext.get(cell_elem);if(!cell_elem)return;var textarea=cell_elem.child('textarea');if(!textarea)return;var value=this.get_value(record);textarea.dom.value=value;this.update_attributes(record,cell_elem);if(!no_green_flash){var status=record.get_status(this.field);if(status=='server_error'){textarea.dom.style.backgroundColor=null;return;}
if(status=='valid'&&!record.is_dirty(this.field))
{textarea.animate({backgroundColor:{from:'#00FF00',to:'#F0F0F0'}},0.7,function(){this.dom.style.backgroundColor=null;},'easeOut','color');}}},edit_cell:function(context){var me=this;var textarea=context.cell_elem.child('textarea');window.setTimeout(function(){textarea.focus();if(me.cell_manager.on_cell_edit)
me.cell_manager.on_cell_edit.fn.call(me.cell_manager.on_cell_edit.scope,context);},0);},on_keydown:function(context,e){var key_id=e.getKey();SG.Page.unsaved_data.add(this);this.currently_editing_textarea=context.elem.dom;this.currently_editing_rec=context.record;if(key_id!==Ext.EventObject.TAB)return;e.preventDefault();var nav_context={field:this.field,record:context.record,cell_elem:context.cell_elem,direction:e.shiftKey?'left':'right'}
if('group_idx'in context)
context.group_idx=context.group_idx;this.cell_manager.navigate_cells(nav_context);},on_scroll:function(context){var target=context.elem;var present_height=target.getHeight();if(!this.max_height||present_height<this.max_height)
target.setHeight(target.dom.scrollHeight+11);},has_unsaved_data:function()
{var rec_value=this.currently_editing_rec.get(this.field);if(rec_value===null)
rec_value='';return(this.currently_editing_textarea.value.strip()!=rec_value);},store_unsaved_data:function()
{this.currently_editing_rec.set(this.field,this.currently_editing_textarea.value.strip());},on_blur:function(context){SG.Page.unsaved_data.remove(this);var target=context.elem;var rec=context.record;var value=target.dom.value.trim();var old_value=rec.get(this.field);if(!old_value)old_value='';var value_changed=old_value!==value;if(value_changed)
rec.set(this.field,value);if(this.autocommit!==false&&value_changed)
rec.commit();},on_dblclick:function()
{},});SG.LargeTextAreaCell=function(config){Ext.apply(this,config);SG.LargeTextAreaCell.superclass.constructor.call(this);this.autocommit=false;};Ext.extend(SG.LargeTextAreaCell,SG.TextAreaCell,{get_classes:function(record){var classes=SG.LargeTextAreaCell.superclass.get_classes.call(this,record);classes.push('sg_cell_textarea_large');return classes;}});SG.FocusGridCell=function(config){Ext.apply(this,config);SG.FocusGridCell.superclass.constructor.call(this);};Ext.extend(SG.FocusGridCell,SG.Cell,{templates:{time_log_cell:'<div class="sg_cell_content"><div class="new_timelog_button" sg_tip="Click to log time"></div>'+'<div class="timelog_info_button" sg_tip="Click to see time log entries"></div>'+'{value}</div>'},get_classes:function(record){var classes=SG.FocusGridCell.superclass.get_classes.call(this,record);classes.push('focus_window_button');return classes;},get_content:function(record)
{if(this.schema_field.data_type=='duration'&&this.schema_field.name=='time_logs_sum')
{var value=record.get(this.field);var renderer=this.get_renderer(record);var value_html=renderer.render_nbsp.call(renderer,value,this.schema_field,record);return this.templates.time_log_cell.apply({value:value_html});}
else
return SG.FocusGridCell.superclass.get_content.call(this,record);},on_click:function(context){var new_timelog_button=context.elem.findParent('div.new_timelog_button',this.container);if(new_timelog_button)
{this.new_timelog(context);return;}
var active_focus_button=context.elem.findParent('.focus_window_button',this.container.dom,true);active_focus_button.addClass('active');var rec=context.record;var ident_field=SG.schema.get_identifier_field(this.entity_type);var field_info=SG.schema.parse_field_name(this.entity_type,this.field);var ident_val=(ident_field=='this_file')?rec.get(ident_field).display_name:rec.get(ident_field);var title=ident_val+" - "+this.schema_field.display_name;var focus_context={entity:{type:rec.get_type(),id:rec.get_id(),name:ident_val},entity_type:this.schema_field.query.entity_type,filters:this.schema_field.query.filters,title:title,reset_stack:(this.page.context.get('inside_window')!==true),callback:{fn:function(){active_focus_button.removeClass('active');},scope:this}};if(field_info.type!=='simple'){focus_context.entity=rec.get(field_info.base_field);focus_context.title=focus_context.entity.name+" - "+this.schema_field.display_name;}
if(SG.schema.entity_types[this.entity_type].has_projects===true){focus_context.entity_project=rec.get('project');}
this.page.get_focus_window().open(focus_context);},new_timelog:function(context)
{var widget=this.cell_manager.get_parent_widget();var record=new SG.Data.Record('TimeLog');var ident_field=SG.schema.get_identifier_field(context.record.get_type());var name=context.record.get(ident_field);record.set('entity',{type:context.record.get_type(),id:context.record.get_id(),name:name});var today=SG.GridEditor.DateParser.get_normalized_today();record.set('date',SG.GridEditor.DateParser.data_store_format(today));record.set('project',context.record.get('project'));var context={entity_type:'TimeLog',parent_entity:widget.context.get('parent_entity'),data_record:record,};if(!context.parent_entity){context.parent_entity=widget.context.get('entity');}
var factory=new SG.EntityFactory(context);this.add_event(factory,"done",this.display_new_entity_form);factory.create();},display_new_entity_form:function(data_record)
{var widget=this.cell_manager.get_parent_widget();var single_project=widget.single_project_from_context();if(!single_project)
single_project=data_record.get('project');var nef_config={entity_type:'TimeLog',single_project:single_project,all_projects:widget.context_projects(),source_record:data_record};var nef=sg_new_entity_dialog(nef_config);},});SG.CellFactory=function(config){var entity_type=config.entity_type;var field=config.field;var schema_field=SG.schema.get_field(entity_type,field);var in_form=config.in_form||false;var is_bubbled_field=SG.schema.is_bubbled_field(entity_type,field);var editable;if(config.force_editable)
editable=true;else
editable=SG.schema.can_edit_field(entity_type,field);if(schema_field.data_type=="summary")
return SG.SummaryCell;if(field=="attachments"){return SG.AttachmentsCell;}
if(field=="image"){return SG.ThumbnailCell;}
if(schema_field.data_type=="url"){return SG.UrlCell;}
if(schema_field.entity_type=='HumanUser'&&schema_field.name=='password_strength'){return SG.Cell;}
if(schema_field.entity_type=='HumanUser'&&schema_field.data_type=='password'){return SG.PasswordCell;}
if(editable){if(field=="data_type"){return SG.ConfigureDCCell;}
if(in_form)
return SG.FakeInputCell;else if(schema_field.name=='image'&&is_bubbled_field)
return SG.ThumbnailCell;else
return SG.EditableCell;}else{if(schema_field.query)
return SG.FocusGridCell;else
return SG.Cell;}};SG.CellManager=function(config)
{Ext.apply(this,config);SG.CellManager.superclass.constructor.call(this);};Ext.extend(SG.CellManager,SG.Component,{init_component:function()
{SG.CellManager.__instance_count__++;this.cell_manager_id=SG.CellManager.__instance_count__;SG.CellManager.__store_instance_by_id__(this.cell_manager_id,this);this.entity_type=this.data_set.entity_type;this.cells={};this.add_event(this.container,'click',function(e){this.on_click(e)});this.add_event(this.container,'dblclick',function(e){this.on_dblclick(e)});this.add_event(this.container,'keydown',function(e){this.on_keydown(e)});this.add_event(this.data_set,'load',this.on_data_load);this.add_event(this.data_set,'change',this.on_data_change);var cm=this;this.focus_proxy=function(e){cm.on_focus.call(cm,e)};this.blur_proxy=function(e){cm.on_blur.call(cm,e)};this.scroll_proxy=function(e){cm.on_scroll.call(cm,e);};this.container.dom.addEventListener('focus',this.focus_proxy,true);this.container.dom.addEventListener('blur',this.blur_proxy,true);this.container.dom.addEventListener('scroll',this.scroll_proxy,true);this.global_scroll_proxy=function(e){cm.on_global_scroll(e);};document.body.addEventListener('scroll',this.global_scroll_proxy,true);},destroy_component:function(){this.container.dom.removeEventListener('focus',this.focus_proxy,true);this.container.dom.removeEventListener('blur',this.blur_proxy,true);this.container.dom.removeEventListener('scroll',this.scroll_proxy,true);document.body.removeEventListener('scroll',this.global_scroll_proxy,true);SG.CellManager.__remove_instance_by_id__(this.cell_manager_id);},set_page_formatting_rules:function(page_formatting_rules)
{this.page_formatting_rules=page_formatting_rules;this.page_formatting_rules_index=null;},empty_cell_cache:function(field){if(field)
delete this.cells[field];else
this.cells={};},get_cell:function(field,config){config=config||{};if(!(this.cells[field]instanceof SG.Cell)){var schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field)return null;if(schema_field.name==='image'&!this.added_thumbnail_events&&SG.globals.preferences.filmstrip_thumbnails)
{this.add_event(this.container,'mousemove',function(e){this.on_mousemove(e)});this.add_event(this.container,'mouseout',function(e){this.on_mouseout(e)});this.added_thumbnail_events=true;}
if(!config.hasOwnProperty('type')){var factory_config={entity_type:this.entity_type,field:field,in_form:this.in_form};if(this.force_editable)
factory_config.force_editable=this.force_editable;config.type=SG.CellFactory(factory_config);}
if(!config.hasOwnProperty('double_click_for_edit'))
{config.double_click_for_edit=this.in_form==true?false:true;}
if(!this.edit_container)
this.edit_container=this.container.findParent('div.sg_page',50,true)||document.body;var cell_config={entity_type:this.entity_type,field:field,data_set:this.data_set,container:this.container,edit_container:this.edit_container,projects:this.projects,page:this.get_page(),cell_manager:this,detail_link:config.detail_link||false,double_click_for_edit:config.double_click_for_edit,autocommit:this.autocommit===false?false:true,read_only:(config.read_only===undefined?this.read_only:config.read_only)};if(typeof config.use_tip!='undefined')
cell_config.use_tip=config.use_tip;if(typeof config.tip_template!='undefined')
cell_config.tip_template=config.tip_template;if(typeof config.render_condensed!='undefined')
cell_config.render_condensed=config.render_condensed;this.cells[field]=this.new_component(config.type,cell_config);}
return this.cells[field];},navigate_cells:function(context){var rec_id=context.record.get_id();var rec=this.data_set.get_record_by_id(rec_id);var single_record_navigation=(this.data_set.count()==1)||this.use_single_record_navigation;if(typeof rec==='undefined')return;if(!this.get_fields_callback||typeof this.get_fields_callback.fn!=='function')return;var fields=this.get_fields_callback.fn.call(this.get_fields_callback.scope);var idx=fields.indexOf(context.field);var next_idx,next_field,next_cell=null;var direction=context.direction;if(single_record_navigation)
{if(direction=='up')
direction='left';else if(direction=='down')
direction='right';}
do{switch(direction){case'left':if(idx-1<0){this.navigate_cells_previous_record(context);if(rec_id===context.record.get_id()&&!single_record_navigation)
next_idx=idx;else
{if(this.before_first_cell)
{next_idx=idx;this.before_first_cell.fn.call(this.before_first_cell.scope,this);}
else
next_idx=fields.length-1;}}else{next_idx=idx-1;}
break;case'right':if(idx+1>=fields.length){this.navigate_cells_next_record(context);if(rec_id===context.record.get_id()&&!single_record_navigation)
next_idx=idx;else
{if(this.after_last_cell)
{next_idx=idx;this.after_last_cell.fn.call(this.after_last_cell.scope,this);}
else
next_idx=0;}}else{next_idx=idx+1;}
break;case'up':next_idx=idx;this.navigate_cells_previous_record(context);break;case'down':next_idx=idx;this.navigate_cells_next_record(context);break;}
if(idx===next_idx&&rec_id===context.record.get_id())
return;rec_id=context.record.get_id();next_field=fields[next_idx];next_cell=this.get_cell(next_field);if(!next_cell.is_editable(context.record)||next_cell.no_keyboard_navigation||typeof next_cell.edit_cell!=='function'||next_cell.schema_field.editor=='image_button')
{next_cell=null;idx=next_idx;}}while(next_cell===null);var cell_sel='.sg_cell[field='+next_field+'][record_id='+context.record.get_id()+']';if(this.data_set.is_grouped())cell_sel+='[group_idx='+context.group_idx+']';var cell_elem=this.container.child(cell_sel);if(cell_elem){context.cell_elem=cell_elem;next_cell.edit_cell(context);}},navigate_cells_next_record:function(context){if(this.data_set.count()===1){return;}
if(this.record_tab_order)
{var index=this.record_tab_order.indexOf(context.record.id)+1;while(index<this.record_tab_order.length&&this.record_tab_order_skip[index])
index++;if(index<this.record_tab_order.length&&!this.record_tab_order_skip[index])
context.record=this.data_set.get_record_by_id(this.record_tab_order[index]);return;}
var rec=context.record;var group_idx=context.group_idx;var next_rec,next_group,next_group_idx;if(this.data_set.is_grouped()){var cur_group=this.data_set.get_group(group_idx);var rec_idx_in_group=cur_group.ids.indexOf(rec.get_id());if(rec_idx_in_group+1<cur_group.ids.length){next_rec=this.data_set.get_record_by_id(cur_group.ids[rec_idx_in_group+1]);next_group_idx=group_idx;}
else if(group_idx+1<this.data_set.group_count()){next_group_idx=group_idx+1;next_group=this.data_set.get_group(next_group_idx);next_rec=this.data_set.get_record_by_id(next_group.ids[0]);}
else{next_rec=rec;next_group_idx=group_idx;}
context.record=next_rec;context.group_idx=next_group_idx;}else{var rec_ids=this.data_set.get_ids();var rec_idx=rec_ids.indexOf(rec.get_id());if(rec_idx+1<this.data_set.count()){context.record=this.data_set.get_record(rec_idx+1);}else{}}},navigate_cells_previous_record:function(context){if(this.data_set.count()===1){return;}
if(this.record_tab_order)
{var index=this.record_tab_order.indexOf(context.record.id)-1;while(index>=0&&this.record_tab_order_skip[index])
index--;if(index>=0&&!this.record_tab_order_skip[index])
context.record=this.data_set.get_record_by_id(this.record_tab_order[index]);return;}
var rec=context.record;var group_idx=context.group_idx;var next_rec,next_group,next_group_idx;if(this.data_set.is_grouped()){var cur_group=this.data_set.get_group(group_idx);var rec_idx_in_group=cur_group.ids.indexOf(rec.get_id());if(rec_idx_in_group-1>=0){next_rec=this.data_set.get_record_by_id(cur_group.ids[rec_idx_in_group-1]);next_group_idx=group_idx;}
else if(group_idx-1>=0){next_group_idx=group_idx-1;next_group=this.data_set.get_group(next_group_idx);next_rec=this.data_set.get_record_by_id(next_group.ids[next_group.ids.length-1]);}
else{next_rec=rec;next_group_idx=group_idx;}
context.record=next_rec;context.group_idx=next_group_idx;}else{var rec_ids=this.data_set.get_ids();var rec_idx=rec_ids.indexOf(rec.get_id());if(rec_idx-1>=0){context.record=this.data_set.get_record(rec_idx-1);}else{}}},find_target:function(el)
{var cell_elem=el.findParent('.sg_cell');if(!cell_elem)return;if(cell_elem.getAttribute('cm_id')!=this.cell_manager_id)
return;var field=cell_elem.getAttribute('field');if(!field)return;var record_id=parseInt(cell_elem.getAttribute('record_id'));if(!record_id)return;var record=this.data_set.get_record_by_id(record_id);if(!record)return;var target={elem:el,cell_elem:cell_elem,cell:this.get_cell(field),record:record};var group_idx=cell_elem.getAttribute('group_idx');if(group_idx)target.group_idx=parseInt(group_idx);return target;},trigger_editing:function(target_ext_elem,optional_event)
{var edit_config=this.find_target(target_ext_elem);if(edit_config)
{edit_config.cell.on_click(edit_config,optional_event);}},on_click:function(e){var target_elem=Ext.get(e.getTarget());this.trigger_editing(target_elem,e);},on_dblclick:function(e){var target_elem=Ext.get(e.getTarget());var target=this.find_target(target_elem);if(target)
target.cell.on_dblclick(target);},on_keydown:function(e){var target_elem=Ext.get(e.getTarget());var target=this.find_target(target_elem);if(target)
target.cell.on_keydown(target,e);},on_scroll:function(e){var target_elem=Ext.get(e.target);var target=this.find_target(target_elem);if(target)
target.cell.on_scroll(target);},on_global_scroll:function(e)
{var t=e.target;if(t.className.indexOf('sg_menu_body')==-1&&t.className.indexOf('sg_grid_editor_textarea')==-1&&t.nodeName!='INPUT'&&this.active_editor)
{if(this.active_editor.on_global_scroll)
this.active_editor.on_global_scroll();else
this.active_editor.blur();}},on_focus:function(e){var target_elem=Ext.get(e.target);var target=this.find_target(target_elem);if(target)
target.cell.on_focus(target);},on_blur:function(e){var target_elem=Ext.get(e.target);var target=this.find_target(target_elem);if(target)
target.cell.on_blur(target);},on_mousemove:function(e){var target_elem=Ext.get(e.target);var target=this.find_target(target_elem);if(target&&target.cell.on_mousemove)
target.cell.on_mousemove(e,target);},on_mouseout:function(e){var target_elem=Ext.get(e.target);var target=this.find_target(target_elem);if(target&&target.cell.on_mouseout)
target.cell.on_mouseout(e,target);},get_context_menu_items:function(target_elem)
{var target=this.find_target(target_elem);if(target)
return target.cell.get_context_menu_items(target);else
return[];},on_data_load:function(){var cell;for(var field in this.cells){if(!this.cells.hasOwnProperty(field))continue;cell=this.cells[field];if(cell&&cell.on_data_load){cell.on_data_load.call(cell);}}},apply_all_edits:function(){var cell;for(var field in this.cells){if(!this.cells.hasOwnProperty(field))continue;cell=this.cells[field];if(cell.apply_edit!=undefined&&typeof cell.apply_edit=='function')
cell.apply_edit();}},on_data_change:function(changes){var is_multi,change,cell,rec;var no_green_flash=changes.length>50;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type!=="update")continue;if(this.ignore_pending_changes&&change.state!="server")continue;cell=this.cells[change.column];if(cell&&change.record){if(cell.on_data_change){cell.on_data_change.call(cell,change);}
cell.update_cell(change.record,no_green_flash);if(this.entity_type=='Task'&&change.column=='entity')
{var step_cell=this.cells['step'];if(step_cell)
step_cell.update_cell(change.record,no_green_flash);}
if(this.entity_type=='Status'&&change.column=='bg_color')
{var icon_cell=this.cells['icon'];if(icon_cell)
icon_cell.update_cell(change.record,no_green_flash);}
if(SG.globals.custom_for=="walt_disney_animation"){if(['CustomEntity04','CustomEntity05'].indexOf(this.entity_type)!==-1&&change.column=='sg_asset')
{var curVal=change.record.get('sg_variant');if(curVal)
change.record.set('sg_variant',null);}}}
if(change.state=='server')
{var other_cell,rules,condition_paths;for(var field in this.cells)
{if(!this.cells.hasOwnProperty(field))
continue;other_cell=this.cells[field];if(other_cell==cell)
continue;rules=this.get_formatting_rules(other_cell.field,other_cell.schema_field);if(rules)
{for(var j=0;j<rules.length;j++)
{if(rules[j].condition)
{condition_paths=[];SG.extract_field_paths(rules[j].condition,condition_paths);if(condition_paths.indexOf(change.column)>-1)
{other_cell.update_cell(change.record,true);break;}}}}}}}},cell_edit_applied:function(field,record,cell)
{if(this.edit_applied_callback)
this.edit_applied_callback.fn.call(this.edit_applied_callback.scope,field,record,cell);},dynamic_join_field_rule:{rule_type:'dynamic',condition:null,enabled:true,bold:false,italic:false,strike_through:false,text_color:null,background_color:'192,192,192'},has_conditional_field_rule:function(field_path,schema_field)
{if(schema_field.formatting_rules&&!SG.schema.is_bubbled_field(this.cells[field_path].entity_type,field_path))
{for(var i=0;i<schema_field.formatting_rules.length;i++)
{if(schema_field.formatting_rules[i].condition)
return true;}}
if(this.page_formatting_rules&&!this.page_formatting_rules_index)
this.construct_formatting_rules_index();if(this.page_formatting_rules_index&&this.page_formatting_rules_index[schema_field.id])
{for(var i=0;i<this.page_formatting_rules_index[schema_field.id].length;i++)
{if(this.page_formatting_rules_index[schema_field.id][i].condition)
return true;}}
return false;},has_static_field_rule:function(field_path,schema_field)
{if(schema_field.formatting_rules&&!SG.schema.is_bubbled_field(this.cells[field_path].entity_type,field_path))
{for(var i=0;i<schema_field.formatting_rules.length;i++)
{if(!schema_field.formatting_rules[i].condition)
return true;}}
if(this.page_formatting_rules&&!this.page_formatting_rules_index)
this.construct_formatting_rules_index();if(this.page_formatting_rules_index&&this.page_formatting_rules_index[schema_field.id])
{for(var i=0;i<this.page_formatting_rules_index[schema_field.id].length;i++)
{if(!this.page_formatting_rules_index[schema_field.id][i].condition)
return true;}}
return false;},has_conditional_row_rule:function()
{var entity_type_schema=SG.schema.entity_types[this.entity_type];if(entity_type_schema.global_row_formatting_rules)
{for(var i=0;i<entity_type_schema.global_row_formatting_rules.length;i++)
{if(entity_type_schema.global_row_formatting_rules[i].condition)
return true;}}
if(this.page_formatting_rules&&!this.page_formatting_rules_index)
this.construct_formatting_rules_index();if(this.page_formatting_rules_index)
{if(this.page_formatting_rules_index.conditional_row.length>0)
return true;}
return false;},has_static_row_rule:function()
{var entity_type_schema=SG.schema.entity_types[this.entity_type];if(entity_type_schema.global_row_formatting_rules)
{for(var i=0;i<entity_type_schema.global_row_formatting_rules.length;i++)
{if(!entity_type_schema.global_row_formatting_rules[i].condition)
return true;}}
if(this.page_formatting_rules&&!this.page_formatting_rules_index)
this.construct_formatting_rules_index();if(this.page_formatting_rules_index)
{if(this.page_formatting_rules_index.static_row.length>0)
return true;}
return false;},construct_formatting_rules_index:function()
{if(!this.page_formatting_rules)
return;this.page_formatting_rules_index={static_row:[],conditional_row:[]};for(var i=0;i<this.page_formatting_rules.length;i++)
{rule=this.page_formatting_rules[i];if(rule.rule_type=='row')
{if(this.entity_type!==rule.row_entity_type)
continue;if(rule.condition)
this.page_formatting_rules_index.conditional_row.push(rule);else
this.page_formatting_rules_index.static_row.push(rule);}
else if(rule.rule_type=='display_column')
{if(!this.page_formatting_rules_index[rule.display_column_id])
this.page_formatting_rules_index[rule.display_column_id]=[];this.page_formatting_rules_index[rule.display_column_id].push(rule);}}},get_formatting_rules:function(field_path,schema_field,row_rules_only)
{var rules=[];var rule;if(!row_rules_only&&SG.schema.is_join_field(this.entity_type,field_path))
{rules.push(this.dynamic_join_field_rule);}
if(!row_rules_only&&schema_field.data_type=='currency'&&SG.globals.preferences.format_currency_fields_negative_red)
{rules.push({rule_type:'dynamic',enabled:true,bold:false,italic:false,strike_through:false,text_color:'255,0,0',background_color:null,condition:{path:field_path,relation:'less_than',values:[0]}});}
var static_row_rules=[];var conditional_row_rules=[];var entity_type_schema=SG.schema.entity_types[this.entity_type];if(entity_type_schema.global_row_formatting_rules)
{for(var i=0;i<entity_type_schema.global_row_formatting_rules.length;i++)
{if(entity_type_schema.global_row_formatting_rules[i].condition)
conditional_row_rules.push(entity_type_schema.global_row_formatting_rules[i]);else
static_row_rules.push(entity_type_schema.global_row_formatting_rules[i]);}}
if(this.page_formatting_rules&&!this.page_formatting_rules_index)
this.construct_formatting_rules_index();if(this.apply_row_rules)
{if(this.page_formatting_rules_index)
{static_row_rules=static_row_rules.concat(this.page_formatting_rules_index.static_row);conditional_row_rules=conditional_row_rules.concat(this.page_formatting_rules_index.conditional_row);}
rules=rules.concat(static_row_rules);rules=rules.concat(conditional_row_rules);}
var static_field_rules=[];var conditional_field_rules=[];if(!row_rules_only&&schema_field.formatting_rules&&!SG.schema.is_bubbled_field(this.cells[field_path].entity_type,field_path))
{for(var i=0;i<schema_field.formatting_rules.length;i++)
{if(schema_field.formatting_rules[i].condition)
conditional_field_rules.push(schema_field.formatting_rules[i]);else
static_field_rules.push(schema_field.formatting_rules[i]);}}
if(!row_rules_only&&this.page_formatting_rules_index&&this.page_formatting_rules_index[schema_field.id])
{for(var i=0;i<this.page_formatting_rules_index[schema_field.id].length;i++)
{if(this.page_formatting_rules_index[schema_field.id][i].condition)
conditional_field_rules.push(this.page_formatting_rules_index[schema_field.id][i]);else
static_field_rules.push(this.page_formatting_rules_index[schema_field.id][i]);}}
rules=rules.concat(static_field_rules);rules=rules.concat(conditional_field_rules);if(rules.length>0)
return rules;else
return null;},evaluate_row_rule_styles:function(record)
{var styles={color:null,'background-color':null,'text-decoration':null,'font-style':null,padding:null};var formatting_rules=this.get_formatting_rules(null,null,true);if(formatting_rules)
{for(var i=0;i<formatting_rules.length;i++)
{var rule=formatting_rules[i];if(rule.rule_type=='row'&&(!rule.condition||SG.evaluate_condition(record,sg_deep_copy(rule.condition))))
{if(rule.text_color)
styles['color']=sg_css_color(rule.text_color);if(rule.background_color)
styles['background-color']=sg_css_color(rule.background_color);if(rule.bold=='t')
styles['font-weight']='bold';if(rule.italic=='t')
styles['font-style']='italic';if(rule.strike_through=='t')
styles['text-decoration']='line-through';}}}
return styles;},});if(typeof SG.CellManager.__instance_count__=="undefined")
SG.CellManager.__instance_count__=0;if(typeof SG.CellManager.__instances__=="undefined")
SG.CellManager.__instances__={};SG.CellManager.find_target=function(ext_elem)
{for(var id in SG.CellManager.__instances__)
{if(!SG.CellManager.__instances__.hasOwnProperty(id))
continue;var instance=SG.CellManager.__instances__[id];var target_hash=instance.find_target(ext_elem);if(target_hash)
return target_hash;}
return null;};SG.CellManager.get_instance_by_id=function(cell_manager_id)
{return SG.CellManager.__instances__[cell_manager_id];};SG.CellManager.__store_instance_by_id__=function(cell_manager_id,instance)
{SG.CellManager.__instances__[cell_manager_id]=instance;};SG.CellManager.__remove_instance_by_id__=function(cell_manager_id)
{delete SG.CellManager.__instances__[cell_manager_id];};SG.CellManager.resubmit_all_error_cells=function(){SG.Repo.start_batch();for(var id in SG.CellManager.__instances__){if(!SG.CellManager.__instances__.hasOwnProperty(id))
continue;var instance=SG.CellManager.__instances__[id];for(var i=0;i<instance.data_set.count();i++){var record=instance.data_set.get_record(i);var fields=record.get_fields();for(var j=0;j<fields.length;j++){var error=record.get_error(fields[j]);if(error)
record.commit(true);}}}
SG.Repo.end_batch();};SG.CellManager.globally_any_error_cells=function(){for(var id in SG.CellManager.__instances__){if(!SG.CellManager.__instances__.hasOwnProperty(id))
continue;var instance=SG.CellManager.__instances__[id];for(var i=0;i<instance.data_set.count();i++){var record=instance.data_set.get_record(i);var fields=record.get_fields();for(var j=0;j<fields.length;j++){var error=record.get_error(fields[j]);if(error&&(!error.type||error.type!='no_bubble_source')){return true;}}}}
return false;};SG.ThumbnailCell=function(config){Ext.apply(this,config);SG.ThumbnailCell.superclass.constructor.call(this);};SG.ThumbnailCell.preserve_aspect_ratio=function(img_dom){img_ext=Ext.get(img_dom);if(img_dom.naturalWidth*img_dom.offsetHeight-img_dom.naturalHeight*img_dom.offsetWidth<-img_dom.naturalWidth)
{img_ext.addClass('vertical');}
img_ext.removeClass('prehide');}
Ext.extend(SG.ThumbnailCell,SG.Cell,{templates:{thumb:'{image}{menu}',menu:'<div class="thumb_menu"><div class="project_nav_menu_up"></div></div>',small_img:'<img class="thumb prehide" src="/thumbnail/image/{image_src}" onError="sg_missing_image(this)" '+'onLoad="SG.ThumbnailCell.preserve_aspect_ratio(this)" />',fullsize_img:'<img class="thumb prehide" src="/file_serve/{image_src}" onError="sg_missing_image(this)" '+'onLoad="SG.ThumbnailCell.preserve_aspect_ratio(this)" />',canvas:'<canvas class="filmstrip_thumb_canvas" width="{width}" height="{height}"></canvas>',editable:'<div class="sg_cell_content thumb {empty}">{thumb}</div>',empty_thumb:'<div class="empty_thumb"><div class="upload">Upload Thumbnail</div></div>{menu}',read_only:'<div class="sg_cell_content thumb empty">{thumb}</div>',empty_thumb_read_only:'<div class="empty_thumb"><div class="upload read_only">No Thumbnail</div></div>',launch_movie_overlay:'<div class="launch_movie_overlay {displayed}">'+'<div class="ghost"></div>'+'<img class="play_button" src="/images/review_app_play_overlay_button.png">'+'</div>'},init_cell:function()
{this.editable=this.is_editable();this.render_contextmenu_overlay=true;this.accept_dblclick_event=true;this.playable_records={};if(this.revolver_overlay_enabled()){var vid=document.createElement('video');if(!vid.canPlayType){this.skip_revolver_thumb_overlay=true;Ext.fly(vid).remove();return;}
if(vid.canPlayType('video/mp4'))
this.can_play_mp4=true;if(vid.canPlayType('video/webm'))
this.can_play_webm=true;Ext.fly(vid).remove();if(this.entity_type==='Version')
this.add_event(this.cell_manager.data_set,'change',this.on_data_change);if(this.cell_manager.data_set.loaded)
this.on_data_load();}},on_data_load:function(){if(!this.revolver_overlay_enabled())
return;var i;if(this.entity_type==='Version'){for(i=0;i<this.data_set.count();i++)
this.check_uploaded_movie(this.data_set.get_record(i));}else if(['Asset','Shot','Sequence','Task'].indexOf(this.entity_type)>-1){var conditions=[];if(this.can_play_mp4)
conditions.push({path:'sg_uploaded_movie_mp4',relation:'is_not',values:[null]});if(this.can_play_webm)
conditions.push({path:'sg_uploaded_movie_webm',relation:'is_not',values:[null]});var filters={logical_operator:'and',conditions:[{logical_operator:'or',conditions:conditions}]};var path='entity';if(this.entity_type==='Sequence')
path='entity.Shot.sg_sequence';var entities=[];var entity_record_map={};var rec,entity,key;for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);if(this.entity_type==='Task')
entity=rec.get('entity');else
entity={type:rec.type,id:rec.id};if(!entity)
continue;key=entity.type+'_'+entity.id;if(entity_record_map.hasOwnProperty(key)){entity_record_map[key].push(rec);}else{entity_record_map[key]=[rec];entities.push(entity);}}
if(!entities.length)
return;filters.conditions.push({path:path,relation:'in',values:entities});var version_summary_set=this.new_data_set('Version',function(){this.on_version_summaries_load(version_summary_set,entity_record_map);});var spec={type:'Version',columns:[],filters:filters,grouping:[{column:path}],summaries:[{column:'id',type:'maximum'}],result:version_summary_set,result_key:'group_summaries'};SG.Repo.summarize(spec);}},revolver_overlay_enabled:function(){return SG.globals.preferences.enable_revolver&&!this.skip_revolver_thumb_overlay&&this.field==='image';},on_data_change:function(changes){var i,change;for(i=0;i<changes.length;i++){change=changes[i];if(change.state!=='server'||change.type!=='update'||['sg_uploaded_movie_mp4','sg_uploaded_movie_webm','sg_uploaded_movie_transcoding_status'].indexOf(change.column)<0)
continue;this.check_uploaded_movie(change.record);}},on_version_summaries_load:function(summary_set,entity_record_map){var summary=summary_set.group_summaries;var make_load_callback=function(data_set,records,version_id){return function(){var entity=data_set.get_record(0).get('entity');if(!entity)return;var i;for(i=0;i<records.length;i++)
this.enable_movie_viewing(records[i],true,version_id,entity);};};var i,j,records,entity,key,version_id,spec,data_set;for(i=0;i<summary.length;i++){entity=summary[i].template_values[0];if(summary[i].template_values&&entity&&summary[i].summaries){key=entity.type+'_'+entity.id;records=entity_record_map[key];if(!records)
continue;version_id=Number(summary[i].summaries[0].value);if(this.entity_type==='Sequence'){data_set=new SG.Data.Set('Version');data_set.on('load',make_load_callback(data_set,records,version_id),this);spec={type:'Version',ids:[version_id],columns:['entity'],result:data_set};SG.Repo.find(spec);continue;}
for(j=0;j<records.length;j++)
this.enable_movie_viewing(records[j],true,version_id,entity);}}},check_uploaded_movie:function(record){if(!record||(!record.get('sg_uploaded_movie_mp4')&&!record.get('sg_uploaded_movie_webm')&&record.get('sg_uploaded_movie_transcoding_status')!==0)){this.enable_movie_viewing(record,false);return;}
var enabled=false;if(this.can_play_mp4){var mp4=record.get('sg_uploaded_movie_mp4');if(mp4&&mp4.url.match(/mp4$/))
enabled=true;}
if(!enabled&&this.can_play_webm){var webm=record.get('sg_uploaded_movie_webm');if(webm&&webm.url.match(/webm$/))
enabled=true;}
if(!enabled&&record.get('sg_uploaded_movie_transcoding_status')===0){console.log("transcoding in progress",record.get_id());}
if(!enabled){this.enable_movie_viewing(record,false);return;}
this.enable_movie_viewing(record,true,record.get_id(),record.get('entity'));},enable_movie_viewing:function(record,enabled,version_id,entity){this.playable_records[record.get_id()]={enabled:enabled,version_id:version_id,entity:entity};var sel='.sg_cell[field="'+this.field+'"][record_id="'+record.get_id()+'"][record_type="'+record.get_type()+'"]';var cell=this.container.child(sel);if(!cell)return;var overlay_div=cell.child('div.launch_movie_overlay');if(!overlay_div)return;var thumb=cell.child('img.thumb');var after_load_fn=function(){overlay_div.dom.style.display='none';overlay_div.dom.offsetHeight;overlay_div.dom.style.display='block';if(enabled)
overlay_div.addClass('displayed');else
overlay_div.removeClass('displayed');setTimeout(function(){var play_button=overlay_div.child('img.play_button');play_button.dom.style.display='none';play_button.dom.offsetHeight;play_button.dom.style.display='inline';},0);thumb.dom.removeEventListener('load',after_load_fn,false);};if(thumb.dom.complete){after_load_fn();return;}
thumb.dom.addEventListener('load',after_load_fn,false);},get_content:function(record)
{var t=this.templates;if(this.editable)
return t.editable.apply(this.get_thumb_config(record));else
return t.read_only.apply(this.get_thumb_config(record,true));},render:function(record,group_idx)
{var config=SG.ThumbnailCell.superclass.render.call(this,record,group_idx);if(record.get(this.field))
config.cell_classes+=" thumbnail_cell_has_content";if(config.cell_styles.indexOf('background-color')>-1)
config.cell_classes+=" thumbnail_cell_has_background_color";return config;},get_thumb_config:function(record,read_only)
{var image=record.get(this.field);var config={empty:''};if(!image)
{var empty_template=read_only?this.templates.empty_thumb_read_only:this.templates.empty_thumb;config.thumb=empty_template.apply({menu:this.render_contextmenu_overlay?this.templates.menu.apply():''});config.empty='empty';}
else
{var fullsize=false;var widget=this.get_parent_widget();if(widget&&widget.get('type')=='SG.Widget.Thumbnail')
{var parent_widget=widget.get_parent();if(parent_widget.get('type')=='SG.Widget.Canvas.Wrapper'&&parent_widget.zoomed)
fullsize=true;}
var template=fullsize?this.templates.fullsize_img:this.templates.small_img;var image_html=template.apply({image_src:image});if(this.revolver_overlay_enabled()){var displayed=this.playable_records&&this.playable_records[record.get_id()]&&this.playable_records[record.get_id()].enabled;image_html+=this.templates.launch_movie_overlay.apply({displayed:displayed?'displayed':''});}
config.thumb=this.templates.thumb.apply({image:image_html,menu:this.render_contextmenu_overlay?this.templates.menu.apply():''});}
return config;},get_context_menu_items:function(target,selection_count)
{var items=[];var image=target.record.get(this.field);if(!image)
{if(this.editable){items.push({html:'Upload Thumbnail',record:target.record,value:'upload',item_selected:{fn:this.upload_thumbnail,scope:this},disabled:(selection_count>1),grp:-100,order:1});}else{items.push({html:'<i>No Actions Available</i>',grp:-100,order:1});}}
else
{if(this.editable)
{items.push({html:'Clear Thumbnail',record:target.record,item_selected:{fn:this.clear_thumbnail,scope:this},disabled:(selection_count>1),grp:-100,order:1});items.push({html:'Replace Thumbnail',record:target.record,value:'replace',item_selected:{fn:this.upload_thumbnail,scope:this},disabled:(selection_count>1),grp:-100,order:2});}
items.push({html:'<a class="sg_no_underline" href="/file_serve/'+image+'" target="_blank" >View Image</a>',disabled:(selection_count>1),grp:-100,order:3});}
return items;},upload_thumbnail:function(menu,menu_item)
{var config={mode:menu_item.value,record:menu_item.record,field:this.field};var utd=new SG.UploadThumbDialog(config);},clear_thumbnail:function(menu,menu_item)
{var record=menu_item.record;var spec={type:record.get_type(),id:record.get_id(),column:this.field,value:null};SG.Repo.update(spec);},launch_revolver_overlay_for_record:function(record,elem)
{if(!this.revolver_overlay_enabled())return false;if(Ext.fly(elem).findParent('.no_overlay'))return false;var record_id=record.get_id();var playable=this.playable_records&&this.playable_records[record_id]&&this.playable_records[record_id].enabled;if(!playable)return false;var play_hash=this.playable_records[record_id];if(!play_hash)return false;var player=this.new_component(SG.ReviewAppOverlay,{data_set:this.cell_manager.data_set,});player.render();player.set_entity(record,play_hash.version_id,play_hash.entity);return true;},on_dblclick:function(target)
{if(!this.accept_dblclick_event)return;if(target.elem.findParent('div.thumb_menu'))return;if(this.launch_revolver_overlay_for_record(target.record,target.elem))return;var empty=target.elem.findParent('div.sg_cell_content.empty');if(empty)return;this.view_thumbnail(target.record.get(this.field));},on_click:function(context,optional_event)
{var upload=context.elem.findParent('div.upload');if(upload&&this.editable)
{var utd=new SG.UploadThumbDialog({mode:'upload',record:context.record,field:this.field});if(optional_event)
optional_event.stopEvent();}
var menu=context.elem.findParent('div.thumb_menu');if(menu)
{if(!this.edit_menu)
this.thumb_menu=new SG.Menu({render_container:this.edit_container});this.thumb_menu.items=this.get_context_menu_items(context);this.thumb_menu.position={dom_elem:menu,elem_anchor:'bl',menu_anchor:'tl'};this.thumb_menu.render();this.thumb_menu.show();if(optional_event)
optional_event.stopEvent();return;}
var play=context.elem.findParent('img.play_button');if(play){this.launch_revolver_overlay_for_record(context.record,context.elem);return;}},view_thumbnail:function(image)
{var url='/file_serve/'+image;window.open(url,'_blank');},on_mousemove:function(event,target){var filmstrip_image_id=null;if(this.schema_field.name==='image'&&(filmstrip_image_id=target.record.get('filmstrip_image'))){var mouse_x=event.getXY()[0];var thumb_img=Ext.fly(target.cell_elem).child('img.thumb');var canvas=Ext.fly(target.cell_elem).child('canvas');if(thumb_img&&!thumb_img.hasClass('hidden_by_filmstrip')){mouse_x-=thumb_img.getX();this.replace_image_with_filmstrip_canvas(thumb_img.dom,filmstrip_image_id,mouse_x);}else if(canvas&&!canvas.hasClass('cleared')){mouse_x-=canvas.getX();this.draw_filmstrip_canvas(canvas.dom,mouse_x);}}},on_mouseout:function(event,target){var old_target=Ext.get(event.browserEvent.relatedTarget);var new_target=Ext.get(event.browserEvent.target);if(old_target&&new_target){var old_cell=old_target.findParent('.sg_cell');var new_cell=new_target.findParent('.sg_cell');if(old_cell===new_cell)
return;}
var filmstrip_image_id=null;if(this.schema_field.name==='image'&&(filmstrip_image_id=target.record.get('filmstrip_image'))){this.hide_canvas(target.cell_elem);return;}},replace_image_with_filmstrip_canvas:function(img_dom,filmstrip_image_id,mouse_x){var filmstrip_dom,filmstrip_img_dom;if(img_dom.nextSibling&&img_dom.nextSibling.nodeName==='CANVAS'){filmstrip_dom=img_dom.nextSibling;if(Ext.get(filmstrip_dom).hasClass('loading'))return;filmstrip_dom.setAttribute('width',img_dom.parentNode.offsetWidth);filmstrip_dom.setAttribute('height',img_dom.parentNode.offsetHeight);Ext.get(filmstrip_dom).removeClass('cleared');Ext.get(img_dom).addClass('hidden_by_filmstrip');filmstrip_img_dom=filmstrip_dom.nextSibling;this.draw_filmstrip_canvas(filmstrip_dom,mouse_x);}else{filmstrip_dom=this.templates.canvas.insertAfter(img_dom,{width:img_dom.parentNode.offsetWidth,height:img_dom.parentNode.offsetHeight});Ext.get(filmstrip_dom).addClass('loading');filmstrip_img_dom=new Image();filmstrip_img_dom.style.display='none';filmstrip_dom.parentNode.insertBefore(filmstrip_img_dom,filmstrip_dom.nextSibling);var me=this;filmstrip_img_dom.onload=function(){filmstrip_img_dom.className="filmstrip_loaded";Ext.get(filmstrip_dom).removeClass('loading');if(Ext.fly(filmstrip_dom).hasClass('cleared'))return;Ext.get(img_dom).addClass('hidden_by_filmstrip');me.draw_filmstrip_canvas(filmstrip_dom,mouse_x);};filmstrip_img_dom.src='/file_serve/'+filmstrip_image_id;}},draw_filmstrip_canvas:function(canvas_dom,mouse_x){var filmstrip_img_dom=canvas_dom.nextSibling;if(filmstrip_img_dom.className==="filmstrip_loaded")
{var canvas_width=canvas_dom.offsetWidth;var canvas_height=canvas_dom.offsetHeight;var prop_x=mouse_x/canvas_width;var filmstrip_height=filmstrip_img_dom.naturalHeight;var filmstrip_x=Math.round((prop_x*filmstrip_img_dom.naturalWidth)/240)*240;if(filmstrip_x>filmstrip_img_dom.naturalWidth-240)
filmstrip_x=filmstrip_img_dom.naturalWidth-240;var canvas_ratio=canvas_width/canvas_height;var frame_ratio=240/filmstrip_height;var display_width,display_height,display_x,display_y;if(canvas_ratio===frame_ratio){display_height=canvas_height;display_width=canvas_width;display_x=0;display_y=0;}
if(canvas_ratio>frame_ratio){display_height=canvas_height;display_width=Math.round(frame_ratio*display_height);display_x=Math.round((canvas_width-display_width)/2);display_y=0;}else{display_width=canvas_width;display_height=Math.round(display_width/frame_ratio);display_x=0;display_y=Math.round((canvas_height-display_height)/2);}
var ctx=canvas_dom.getContext('2d');ctx.drawImage(filmstrip_img_dom,filmstrip_x,0,240,filmstrip_height,display_x,display_y,display_width,display_height);}},hide_canvas:function(cell_elem){var thumb_img=Ext.fly(cell_elem).child('img.thumb');var canvas=Ext.fly(cell_elem).child('canvas');if(canvas&&thumb_img){thumb_img.removeClass('hidden_by_filmstrip');canvas.addClass('cleared');}}});SG.UploadThumbDialog=function(config)
{Ext.apply(this,config);SG.UploadThumbDialog.superclass.constructor.call(this);};Ext.extend(SG.UploadThumbDialog,SG.Component,{templates:{upload_form:'<form target="_sg_upload_iframe_" name="thumb_upload_form" method="post" failure="" '+'enctype="multipart/form-data" before="" action="/crud/requests" '+'onsubmit="SG.globals._upload_thumb_dialog_.show_pi();">'+'<div class="inputs">'+'<input type="file" name="uploaded_data" onchange="this.form.upload.disabled = false" '+'size="36"></div>'+'<div class="footer"><input type="submit" value="{upload_button_text}" name="upload" disabled="false">'+'<span class="or_for_cancel">or</span>'+'<a class="cancel" href="javascript: void(0)">Cancel</a></div>'+'<input type="hidden" name="requests" value="">'+'<input type="hidden" name="respond_with_javascript_method_call" value="">'+'<span style="display: none;"><img src="/images/indicator_D6D6D6.gif"></span>'+'</form>'},init_component:function(){this.setup_and_render();},setup_and_render:function(){this.dh=Ext.DomHelper;this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=this.dh.append(this.mask,{tag:'div',cls:'sgc_upload_thumb_dialog'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'body'},true);var w=this.mask.getWidth();var h=this.mask.getHeight();this.container.setLeft((w-400)/2);this.container.setTop((h-150)/2);this.add_event(this.container,'click',this.on_click);Ext.EventManager.onWindowResize(this.center_form,this,true);this.render();},render:function(){this.render_header();this.render_body();this.set_form_requests_parameters();SG.globals._upload_thumb_dialog_=this;},show_pi:function()
{this.pi=new SG.ProgressIndicator(this.container);this.pi.show();},render_header:function()
{if(this.mode=='upload')
this.header.update('Upload Thumbnail');else
this.header.update('Replace Thumbnail');},render_body:function()
{this.body.update(this.templates.upload_form.apply({this_widget_id:17,upload_button_text:this.mode=='upload'?'Upload':'Replace'}));},on_click:function(e)
{var t=Ext.get(e.getTarget());var cancel=t.findParent('a.cancel',this.container);if(cancel)
this.destroy();},center_form:function(){this.container.setXY(this.container.getCenterXY(true));},destroy_component:function(){Ext.EventManager.removeResizeListener(this.center_form,this);this.container.remove();this.mask.remove();},set_form_requests_parameters:function()
{var requests_input=this.container.child("input[name=requests]");requests_input.dom.value=Ext.encode([{request_type:"update",type:this.record.type,id:this.record.id,column:this.field,upload_value_form_parameter:"uploaded_data"}]);var respond_input=this.container.child("input[name=respond_with_javascript_method_call]");respond_input.dom.value="SG.globals._upload_thumb_dialog_.on_crud_response";},on_crud_response:function(crud_response_array)
{var response=crud_response_array[0];if(response.status=="successful"){this.record.row.set(response.column,response.value);}else if(response.status=="failed"){var error={type:'server_error',description:response.reason_description};this.record.row.set(response.column,response.value,error);}
this.pi.hide();this.destroy();}});SG.UrlCell=function(config){Ext.apply(this,config);SG.UrlCell.superclass.constructor.call(this);};Ext.extend(SG.UrlCell,SG.EditableCell,{no_keyboard_navigation:true,templates:{},init_cell:function()
{SG.UrlCell.superclass.init_cell.call(this);this.editable=this.is_editable();},get_context_menu_items:function(target)
{var value=target.record.get(this.field);var items=[];if(!this.editable)
return items;if(value)
{items.push({html:'Replace with Uploaded File',record:target.record,item_selected:{fn:this.upload_file,scope:this},grp:-100,order:1});var text;if(!value.url||(value.url&&value.url.indexOf('/file_serve/')==0))
text='Replace with Web Page Link';else
text='Edit Web Page Link';items.push({html:text,record:target.record,item_selected:{fn:this.link_to_url,scope:this},grp:-100,order:2,});if(SG.globals.preferences.support_local_storage){items.push({html:"Replace with Local File or Directory",record:target.record,item_selected:{fn:this.link_to_local_file,scope:this},disabled:!sg_has_localfile_applet(),grp:-100,order:3});}
items.push({html:'Remove File/Link',record:target.record,item_selected:{fn:this.clear_field,scope:this},grp:-100,order:4});}
else
{items.push({html:'Upload File',record:target.record,item_selected:{fn:this.upload_file,scope:this},grp:-100,order:1});items.push({html:'Link to Web Page',record:target.record,item_selected:{fn:this.link_to_url,scope:this},grp:-100,order:2});if(SG.globals.preferences.support_local_storage){items.push({html:"Link to Local File or Directory",record:target.record,item_selected:{fn:this.link_to_local_file,scope:this},disabled:!sg_has_localfile_applet(),grp:-100,order:3});}}
return items;},edit_cell:function(context){if(!this.edit_menu)
this.edit_menu=new SG.Menu({render_container:this.edit_container});var parent_elem=context.elem.findParent('.sg_cell_content',4);if(!parent_elem)
parent_elem=context.elem;this.edit_menu.items=this.get_context_menu_items(context);this.edit_menu.position={dom_elem:parent_elem,elem_anchor:'bl',menu_anchor:'tl'};this.edit_menu.render();this.edit_menu.show();if(this.cell_manager.on_cell_edit)
this.cell_manager.on_cell_edit.fn.call(this.cell_manager.on_cell_edit.scope,context);},upload_file:function(menu,menu_item)
{var config={mode:'upload_file',record:menu_item.record,field:this.field};var ufd=new SG.UrlFieldDialog(config);},link_to_url:function(menu,menu_item)
{var config={mode:'link_to_url',record:menu_item.record,field:this.field};var ufd=new SG.UrlFieldDialog(config);},link_to_local_file:function(menu,menu_item)
{var config={mode:'local_storage',record:menu_item.record,field:this.field};var ufd=new SG.UrlFieldDialog(config);},clear_field:function(menu,menu_item)
{var record=menu_item.record;record.set(this.field,null);this.data_set.commit();}});SG.UrlFieldDialog=function(config)
{Ext.apply(this,config);SG.UrlFieldDialog.superclass.constructor.call(this);};Ext.extend(SG.UrlFieldDialog,SG.Component,{templates:{dialog:'<div class="sg_dialog_mask">'+'<div class="sgc_url_field_dialog sg_dialog">'+'<div class="header"><span class="header_text">{title}</span></div>'+'<div class="body"></div>'+'<div class="footer">'+'<span class="cancel">Cancel</span>'+'<input class="submit" type="button" value="{button_text}">'+'</div>'+'</div></div>',link_to_url_body:'<div class="url">Web page address</div>'+'<input type="text" class="url" size="50" value="{url_value}">'+'<div class="display_name">Optional display name</div>'+'<input type="text" class="display_name" size="50" value="{display_name_value}">',link_to_local_file_body:'<table><tr>'+'<td><input type="text" class="path" size="35" value="{path}"></td>'+'<td style="width:50px; padding-left: 4px">'+'<input type="button" class="browse" value="Browse"></td>'+'</table>'},init_component:function(){this.new_attach_ds=this.new_data_set('Attachment',null,this.attachment_created);this.setup_and_render();},setup_and_render:function(){this.dh=Ext.DomHelper;var title="";switch(this.mode){case"upload_file":title='Choose a File to Upload';break;case"link_to_url":title='Link to Web Page';break;case"local_storage":title='Link to Local File or Directory';break;}
this.mask=this.templates.dialog.append(document.body,{title:title,button_text:(this.mode=='upload_file')?'Upload':'Add Link'});this.mask=Ext.get(this.mask);this.dialog=Ext.get(this.mask.dom.firstChild);var w=this.mask.getWidth();var h=this.mask.getHeight();this.dialog.setLeft((w-400)/2);this.dialog.setTop((h-150)/2);this.add_event(this.dialog,'click',this.on_click);Ext.EventManager.onWindowResize(this.center_form,this,true);this.body=this.dialog.child('div.body');this.render_body();},render_body:function()
{if(this.mode=='upload_file')
{var attach_files_config={container:this.body,done_callback:{fn:this.file_uploaded,scope:this},no_trash:true,no_multi_upload:true};this.attach_files_component=new SG.AttachFiles(attach_files_config);this.attach_files_component.render();this.attach_files_component.add_attachment_input();}
else if(this.mode=='local_storage')
{this.body.update(this.templates.link_to_local_file_body.apply({}));}
else
{var value=this.record.get(this.field);var url_value='';var display_name='';if(value!=null)
{url_value=value.url;display_name=value.display_name;}
this.body.update(this.templates.link_to_url_body.apply({url_value:url_value,display_name_value:display_name}));}},set_focus:function()
{var selector;if(this.mode=='upload_file')
selector='input.attachment';else
selector='input.url';var e=this.dialog.child(selector);if(e)e.focus();},file_uploaded:function(attachments)
{this.record.set(this.field,attachments[0]);this.record.commit();this.pi.hide();this.destroy();},show_pi:function()
{this.pi=new SG.ProgressIndicator(this.dialog);this.pi.show();},hide_pi:function()
{if(this.pi)
this.pi.hide();},on_click:function(e)
{var t=Ext.get(e.getTarget());var cancel=t.findParent('span.cancel',this.dialog);if(cancel)
this.destroy();var browse_local=t.findParent('input.browse',this.dialog);if(!browse_local)
browse_local=t.findParent('input.path',this.dialog);if(browse_local){if(window.sgLocalFile){var path_input=this.dialog.child('input.path');path_input.dom.value=window.sgLocalFile.pickFileOrDirectory();return;}
var a=Ext.get('sg_java_localfile');if(a){a=a.dom;a.pickFileOrDirectory();var path=String(a.singleResult);var path_input=this.dialog.child('input.path');path_input.dom.value=path;}}
var has_projects=SG.schema.entity_types[this.record.type].has_projects;var project=this.record.get('project');var submit=t.findParent('input.submit',this.dialog);if(submit)
{if(this.mode=='upload_file')
{var fv=[];fv.push({column:"attachment_links",value:[{type:this.record.type,id:this.record.get_id()}]});if(has_projects&&project){fv.push({column:'project',value:project});}
this.show_pi();this.attach_files_component.upload(fv);}
else if(this.mode=='link_to_url')
{var url_input=this.body.child('input.url');var url_val=url_input.dom.value;var display_name=this.body.child('input.display_name');if(url_val.indexOf('://')==-1){alert("Please enter a valid URL.");return;}
this.show_pi();this.new_record=this.new_attach_ds.new_record();this.new_record.set('attachment_links',[{type:this.record.type,id:this.record.get_id()}]);this.new_record.set('attachment_type','http_url');this.new_record.set('source',url_input.dom.value);if(has_projects&&project){this.new_record.set('project',project);}
if(display_name.dom.value){this.new_record.set('display_name',display_name.dom.value);}
this.new_record.commit();}
else if(this.mode=='local_storage')
{var url_input=this.body.child('input.path');var url_val=url_input.dom.value;if(url_val.strip()==''){alert("Please enter a valid file path.");return;}
this.new_record=this.new_attach_ds.new_record();this.new_record.set('attachment_links',[{type:this.record.type,id:this.record.get_id()}]);this.new_record.set('attachment_type','local_storage');this.new_record.set('source',url_val);if(has_projects&&project){this.new_record.set('project',project);}
this.new_record.commit();}}},attachment_created:function(changes)
{for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.type=='create')
{var record=change.record;this.record.set(this.field,record.get('this_file'));this.record.commit();this.hide_pi();this.destroy();return;}}},center_form:function(){this.dialog.setXY(this.dialog.getCenterXY(true));},destroy_component:function(){Ext.EventManager.removeResizeListener(this.center_form,this);this.dialog.remove();this.mask.remove();},});SG.ConfigureDCCell=function(config){Ext.apply(this,config);SG.ConfigureDCCell.superclass.constructor.call(this);};Ext.extend(SG.ConfigureDCCell,SG.EditableCell,{is_editable:function(record)
{var dc_schema=SG.schema.get_field(record.get('entity_type'),record.get('name'));return(dc_schema&&dc_schema.configurable);},get_classes:function(record){var classes=SG.EditableCell.superclass.get_classes.call(this,record);if(this.is_editable(record))
{classes.push('configure_dc_cell');classes.push('sg_cell_editable');}
return classes;},edit_cell:function(context){var dc_entity_type=context.record.get('entity_type');var dc_name=context.record.get('name');var dc_schema=SG.schema.get_field(dc_entity_type,dc_name);new SG.util.CreateUpdateDC({entity_type:dc_entity_type,schema_field:dc_schema,widget:this.get_parent_widget()});if(this.cell_manager.on_cell_edit)
this.cell_manager.on_cell_edit.fn.call(this.cell_manager.on_cell_edit.scope,context);},});SG.SummaryCell=function(config){Ext.apply(this,config);SG.SummaryCell.superclass.constructor.call(this);};Ext.extend(SG.SummaryCell,SG.Cell,{templates:{loading:'<div class="summary_loading"><span>Calculating...</span></div>',summary_value_cell:'<div class="sg_cell_content has_button {extra}" sg_tip="Click to view details">'+'<div class="timelog_info_button"></div>'+'{value}</div>',summary_single_record_cell:'<div class="sg_cell_content {extra}">{value}</div>',summary_summary_cell:'<div class="content {summary_classes}" sg_tip="{sg_tip}">'+'{summary_content}</div>',},init_cell:function(){this.summary_set=new SG.Data.SummarySet();this.add_event(this.summary_set,'load',this.on_summary_load);this.summary_request_sent={};this.single_record_sets={};var parts=this.schema_field.name.split('.');if(parts.length==3&&this.schema_field.name.indexOf('$')==-1)
{this.is_bubbled=true;this.bubbled_entity_sets={};this.bubbled_field=parts[0];this.bubbled_entities={};this.bubble_entity_loaded={};}},init_summary:function(){var widget=this.get_parent_widget();if(widget&&widget.get_summary)
this.summary=sg_deep_copy(widget.get_summary(this.field));else
this.summary=sg_deep_copy(SG.schema.get_summary_default(this.schema_field));if(!this.summary||this.summary.type=='none')
this.no_summary=true;if(this.summary&&this.summary.type=='single_record'){this.summary.value=JSON.parse(this.summary.value);}},request_summary:function(record_id)
{var spec={type:this.schema_field.query.entity_type,filters:this.get_filters(record_id,true),summaries:[this.summary],result:this.summary_set,result_key:record_id,use_loading_banner:true};SG.Repo.summarize(spec);this.summary_request_sent[record_id]=true;},request_single_record:function(record_id)
{var entity_type=this.schema_field.query.entity_type;var field=this.schema_field.summary_field;if(!this.single_record_sets[record_id]){this.single_record_sets[record_id]=this.new_data_set(entity_type,this.on_single_record_load);this.single_record_sets[record_id].temp_cell_record_id=record_id;}
var spec={type:entity_type,filters:this.get_filters(record_id,true),columns:[field],sorts:[{column:this.summary.value.column,direction:this.summary.value.direction}],current_page:1,records_per_page:1,no_paging_info:true,result:this.single_record_sets[record_id]};SG.Repo.query(spec);this.summary_request_sent[record_id]=true;},get_filters:function(record_id,substitute_filter_tokens,include_parent_entity_token_in_inverse_association)
{var filters=sg_deep_copy(this.schema_field.query.filters);if(this.schema_field.inverse_association)
{var old_condition=filters.conditions[0];var value={type:this.entity_type,id:record_id};value.valid="parent_entity_token";var inverse_condition={path:old_condition.path+"."+this.schema_field.inverse_association,relation:old_condition.relation,values:[value]};filters.conditions[0]=inverse_condition;}
if(substitute_filter_tokens)
{var parent_widget=this.get_parent_widget();if(this.is_bubbled)
parent_widget.substitute_filter_tokens(filters,this.bubbled_entities[record_id]);else
parent_widget.substitute_filter_tokens(filters,{type:this.entity_type,id:record_id});}
return filters;},on_summary_load:function(keys){var cell=this;for(var i=0;i<keys.length;i++){var key=keys[i];(function(key){var func=function(){var rec;if(key=='page'){cell.update_page_summary();}else if(String(key).indexOf('group')==0){cell.update_group_summary(key);}else{rec=cell.data_set.get_record_by_id(key);if(rec){cell.update_cell(rec,true,false);}}}
SG.TimeoutQueue.add(func);})(key);}},on_single_record_load:function(ds){var cell=this;var render_fn=function(){var rec_id=ds.temp_cell_record_id;var rec=cell.data_set.get_record_by_id(rec_id);if(rec)
cell.update_cell(rec,true,false)};SG.TimeoutQueue.add(render_fn);},get_classes:function(record)
{var classes=SG.SummaryCell.superclass.get_classes.call(this,record);classes.push('sg_summary_cell');var type_class=this.get_type_formatting_class();if(type_class)
classes.push(type_class);return classes;},get_type_formatting_class:function()
{var summary_schema_field=SG.schema.get_field(this.schema_field.query.entity_type,this.schema_field.summary_field);if(!this.summary)
this.init_summary();var summary_type=this.summary.type;var classes=null;if(['currency','number','float'].indexOf(summary_schema_field.data_type)!==-1)
classes='sg_number';if(summary_schema_field.data_type=='status_list')
{if(summary_type=='status_list')
classes='sg_cell_status_list';else
classes='sg_cell_align_right';}
if(summary_type=='record_count'||summary_type=='count')
classes='sg_record_count';return classes;},get_content:function(record){if(!this.summary)
this.init_summary();var record_id=record.get_id();if(this.no_summary)
{return this.templates.summary_value_cell.apply({summary_classes:'no_summary',summary_content:''});}
else if(this.is_bubbled&&!this.bubble_entity_loaded[record_id])
{this.request_bubble_entity(record);return this.templates.loading.apply();}
else if(!this.summary_request_sent[record_id]){if(this.summary.type=="single_record")
this.request_single_record(record_id);else
{if(this.is_bubbled&&!this.bubbled_entities[record_id])
return this.templates.summary_value_cell.apply({summary_classes:'no_summary',summary_content:''});else
this.request_summary(record_id);}
return this.templates.loading.apply();}else if(this.summary.type=="single_record"){if(this.single_record_sets[record.get_id()].loaded)
return this.render_single_record_summary(record);else
return this.templates.loading.apply();}else if(!this.summary_set.loaded){return this.templates.loading.apply();}
var id=record.get_id();var val=this.summary_set.get(id,this.schema_field.summary_field);var summary=this.render_summary(this.summary.type,val,this.summary.value);var tpl=this.templates.summary_value_cell;if(this.schema_field.query.entity_type=="Reply"){var detail={type:record.get_type(),id:record.get_id(),name:summary.summary_content,name_override:record.get("title")||record.get("subject")};summary.summary_content=SG.Renderers.render_one_detail_link(detail);tpl=this.templates.summary_single_record_cell;}
return tpl.apply({extra:summary.summary_classes,value:summary.summary_content});},on_click:function(context){var has_button=context.elem.findParent('div.has_button',this.container.dom,true);if(!has_button)
return;var summary_cell_button=context.elem.findParent('.sg_summary_cell',this.container.dom,true);summary_cell_button.addClass('active');var ident_field=SG.schema.get_identifier_field(this.entity_type);var rec=context.record;var record_id=rec.get_id();var focus_context={entity:{type:rec.get_type(),id:record_id,name:rec.get(ident_field)},entity_type:this.schema_field.query.entity_type,filters:this.get_focus_filters(record_id),title:this.get_focus_window_title(ident_field,rec),reset_stack:(this.page.context.get('inside_window')!==true),callback:{fn:function(){summary_cell_button.removeClass('active');},scope:this}};if(SG.schema.entity_types[this.entity_type].has_projects===true){focus_context.entity_project=rec.get('project');}
this.page.get_focus_window().open(focus_context);},get_focus_filters:function(record_id)
{var filters=this.get_filters(record_id,this.is_bubbled);if(this.summary.type=="status_percentage"){var status_filters={logical_operator:"and",conditions:[{path:this.summary.column,relation:"is_not",values:["na"]}]};if(SG.globals.custom_for=="laika"){status_filters.conditions.push({path:this.summary.column,relation:"is_not",values:["omt"]});}
filters={logical_operator:"and",conditions:[filters,status_filters]}}
return filters;},get_focus_window_title:function(ident_field,record)
{if(this.schema_field.inverse_association)
{var parts=this.field.split('.');var linked_field_name=parts[0];var linked_entity_type=parts[1];var pivot_schema_field=SG.schema.get_field(linked_entity_type,this.schema_field.pivot_column);var linked_schema_field=SG.schema.get_field(this.entity_type,linked_field_name);var dnp=SG.schema.entity_types[this.schema_field.query.entity_type];dnp=dnp.display_name_pluralized;title=record.get(ident_field)+' - '+linked_schema_field.display_name+" "+
pivot_schema_field.display_name+" "+dnp;return title;}
else if(this.schema_field.name.indexOf('$')!=-1)
{var pivot_schema_field=SG.schema.get_field(this.entity_type,this.schema_field.pivot_column);var dnp=SG.schema.entity_types[this.schema_field.query.entity_type];dnp=dnp.display_name_pluralized;var title=record.get(ident_field)+' - '+pivot_schema_field.display_name+" "+dnp;return title;}
else
{var ident_field=SG.schema.get_identifier_field(record.type);var entity={type:record.type,valid:'valid',name:record.get(ident_field)}
return this.schema_field.display_name+" for "+SG.Renderers.render_one_nodetail_entity(entity);}},render_summary:function(type,value,extra){var summary_schema_field=SG.schema.get_field(this.schema_field.query.entity_type,this.schema_field.summary_field);var sr=SG.SummaryRenderers[type];var def=SG.Renderers.renderer_defaults[summary_schema_field.data_type];if(!def)
def='text';var r=SG.Renderers[def];var cls='';var content='';if(sr){var sv=sr(value,extra,summary_schema_field,r)
if(sv==='')sv="&nbsp;"
content=sv;}else{content=r.render_nbsp(value,summary_schema_field);}
var cls=this.get_type_formatting_class()||'';if(type=='record_count'||type=='count')
content=value;return{summary_content:content,summary_classes:cls};},render_page_or_group_summary:function(key)
{if(!this.summary)
this.init_summary();if(this.no_summary||this.is_bubbled)
{var content=this.is_bubbled?'&nbsp;':'';var sg_tip=this.is_bubbled?'Not Currently Supported':'';var html=this.templates.summary_summary_cell.apply({summary_classes:'no_summary',summary_content:content,sg_tip:sg_tip});return{summary_classes:'',summary_content:html};}
else if(key=='page')
{if(!this.summary_request_sent[key]){this.request_page_summary();return{summary_classes:'',summary_content:''};}}
else if(!this.summary_request_sent['group_'+key])
{this.request_group_summary(key);return{summary_classes:'',summary_content:''};}
else if(!this.summary_set.loaded)
{return{summary_classes:'',summary_content:''};}
var html='';var summary_key=key=='page'?'page':'group_'+key;var val=this.summary_set.get(summary_key,this.schema_field.summary_field);if(val!==null)
{var summary=this.render_summary(this.summary.type,val,this.summary.value);html=this.templates.summary_summary_cell.apply(summary);}
return{summary_content:html,summary_classes:''};},render_group_summary:function(group_idx)
{return this.render_page_or_group_summary(group_idx);},request_group_summary:function(group_idx)
{if(this.summary.type=="single_record"||this.is_bubbled)
return;var query_field_filters=sg_deep_copy(this.schema_field.query.filters);var grouping=this.get_parent_widget().get_grouping();var group,group_filters,synth_grouping;var i;var record_ids=[];if(String(group_idx).indexOf('_')!=-1)
{group=this.data_set.synthetic_group_map[group_idx];synth_grouping=grouping.slice(0,group.depth+1);group_filters=SG.schema.filters_for_grouping(this.entity_type,synth_grouping,group.template_values);}
else
{group=this.data_set.get_group(group_idx);group_filters=SG.schema.filters_for_grouping(this.entity_type,grouping,group.template_values);}
var key='group_'+group_idx;var widget_filters=sg_deep_copy(this.get_parent_widget().context.get('filters'));var combined_filters={logical_operator:'and',conditions:[widget_filters,group_filters]}
var extra_pivot=null;if(this.schema_field.inverse_association)
{var extra_pivot=this.schema_field.inverse_association;}
combined_filters=this.apply_widget_filters_to_query_filters(query_field_filters,combined_filters,extra_pivot);if(combined_filters=='negative_parent_entity_token')
return;this.get_parent_widget().substitute_filter_tokens(combined_filters);var spec={type:this.schema_field.query.entity_type,filters:combined_filters,summaries:[this.summary],result:this.summary_set,result_key:key,use_loading_banner:true};SG.Repo.summarize(spec);this.summary_request_sent[key]=true;},render_single_record_summary:function(record)
{var entity_type=this.schema_field.query.entity_type;var field=this.schema_field.summary_field;var schema_field=SG.schema.get_field(entity_type,field);var ds=this.single_record_sets[record.get_id()];var rec=ds.get_record(0);var h='';if(rec){var val=rec.get(field);var def=schema_field.renderer||SG.Renderers.renderer_defaults[schema_field.data_type]||"text";var ren=SG.Renderers[def];val=ren.render_nbsp.call(ren,val,schema_field,rec);var detail_compat=(["text","number"].indexOf(schema_field.data_type)!==-1);if(val!="&nbsp;"&&this.summary.value.detail_link&&detail_compat)
val=this.get_detail_link(rec,val);h=this.templates.summary_single_record_cell.apply({extra:"",value:val});}else{h=this.templates.summary_single_record_cell.apply({extra:"",value:""});}
return h;},get_tooltip_content:function(record)
{if(!this.is_bubbled&&this.summary.type=="single_record"&&this.single_record_sets[record.get_id()].loaded)
{var entity_type=this.schema_field.query.entity_type;var field=this.schema_field.summary_field;var schema_field=SG.schema.get_field(entity_type,field);var ds=this.single_record_sets[record.get_id()];var rec=ds.get_record(0);var h='';if(rec){var val=rec.get(field);var def=schema_field.renderer||SG.Renderers.renderer_defaults[schema_field.data_type]||"text";var ren=SG.Renderers[def];h=ren.render_for_attribute.call(ren,val,schema_field,rec);return Ext.util.Format.htmlEncode(h);}}
return null;},update_group_summary:function(group_summary_key)
{if(this.is_bubbled)
return;var val=this.summary_set.get(group_summary_key,this.schema_field.summary_field);if(val!==null)
{var summary=this.render_summary(this.summary.type,val,this.summary.value);var html=this.templates.summary_summary_cell.apply(summary);var field_sel='[field="'+this.schema_field.name+'"]';var group_idx=group_summary_key.substr(6);var grp_sel='[group_idx="'+group_idx+'"]';var sel='td.group_summary_cell'+field_sel+grp_sel;var td=sg_find(sel,this.container.dom);if(td)
Ext.get(td).update(html);}},render_page_summary:function()
{return this.render_page_or_group_summary('page');},apply_widget_filters_to_query_filters:function(condition,widget_filters,extra_pivot)
{var active_filters=sg_count_active_filters(widget_filters);if(active_filters==0)
{widget_filters={path:'id',relation:'is_not',values:[null]};}
if(condition.path)
{if(condition.active!='false'&&condition.values.length==1&&condition.values[0]&&condition.values[0].valid&&condition.values[0].valid=='parent_entity_token')
{if(condition.relation=='is_not')
return"negative_parent_entity_token";var pivoted_filters=sg_deep_copy(widget_filters);var path=condition.path;if(extra_pivot)
path+="."+extra_pivot;return sg_pivot_condition_hash(this.entity_type,path,pivoted_filters);}
else
return condition;}
else
{var conditions=condition.conditions;var new_conditions=[]
for(var i=0;i<conditions.length;i++)
{var cond=this.apply_widget_filters_to_query_filters(conditions[i],widget_filters,extra_pivot);if(cond=='negative_parent_entity_token')
return'negative_parent_entity_token';new_conditions.push(cond);}
condition.conditions=new_conditions;return condition;}},request_page_summary:function()
{if(this.summary.type=="single_record"||this.is_bubbled)
return;var query_field_filters=sg_deep_copy(this.schema_field.query.filters);var widget=this.get_parent_widget();var widget_filters=sg_deep_copy(widget.context.get('filters'));var extra_pivot=null;if(this.schema_field.inverse_association)
{var extra_pivot=this.schema_field.inverse_association;}
query_field_filters=this.apply_widget_filters_to_query_filters(query_field_filters,widget_filters,extra_pivot);if(query_field_filters=='negative_parent_entity_token')
return;this.get_parent_widget().substitute_filter_tokens(query_field_filters);var spec={type:this.schema_field.query.entity_type,filters:query_field_filters,summaries:[this.summary],result:this.summary_set,result_key:'page',use_loading_banner:true};SG.Repo.summarize(spec);this.summary_request_sent['page']=true;},update_page_summary:function()
{if(this.is_bubbled)return;var val=this.summary_set.get('page',this.schema_field.summary_field);if(val!=null)
{var summary=this.render_summary(this.summary.type,val,this.summary.value);var html=this.templates.summary_summary_cell.apply(summary);var sel='div.sgw_new_grid_header td.summary[field="'+this.schema_field.name+'"]';var td=sg_find(sel,this.container.dom);if(td)
Ext.get(td).update(html);}},get_csv_export_hash:function()
{var ret_hash;if(this.summary.type=="single_record"){ret_hash={request_type:'read',type:this.schema_field.query.entity_type,columns:[this.schema_field.summary_field],filters:this.get_filters(-1,false,true),sorts:[this.summary.value],paging:{current_page:1,records_per_page:1},read:["entities"]}}else{var filters=this.get_filters(-1,false,true);this.substitute_any_date_filter_tokens(filters);ret_hash={request_type:'summarize',type:this.schema_field.query.entity_type,summaries:[this.summary],filters:filters};}
return ret_hash;},substitute_any_date_filter_tokens:function(condition_hash)
{if(condition_hash.path)
{for(var i=0;i<condition_hash.values.length;i++)
{if(condition_hash.values[i])
{if(condition_hash.values[i].date_token)
condition_hash.values[i]=Date.sg_date_for_token(condition_hash.values[i]);}}}
else
{var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
this.substitute_any_date_filter_tokens(conditions[i]);}},request_bubble_entity:function(record)
{if(!this.bubbled_entity_sets[record.id])
{this.bubbled_entity_sets[record.id]=this.new_data_set(record.type,this.on_bubbled_entity_load);this.bubbled_entity_sets[record.id].temp_cell_record_id=record.id;}
var bubbled_entity=record.get(this.bubbled_field)
if(bubbled_entity)
{this.bubble_entity_loaded[record.id]=true;this.bubbled_entities[record.id]=bubbled_entity;if(this.summary.type=="single_record")
this.request_single_record(record.id);else
this.request_summary(record.id);return;}
var spec={type:record.type,id:record.id,columns:[this.bubbled_field],result:this.bubbled_entity_sets[record.id]}
SG.Repo.find(spec);},on_bubbled_entity_load:function(data_set)
{var record=data_set.get_record(0);this.bubble_entity_loaded[record.id]=true;var bubbled_entity=record.get(this.bubbled_field);var cell_record_id=data_set.temp_cell_record_id;this.bubbled_entities[cell_record_id]=bubbled_entity;if(bubbled_entity)
{if(this.summary.type=="single_record")
this.request_single_record(cell_record_id);else
this.request_summary(cell_record_id);}
else
{var rec=this.data_set.get_record_by_id(cell_record_id);this.update_cell(rec,true,true);}},});SG.TasksMiniGridSelector=function(config)
{Ext.apply(this,config);SG.TasksMiniGridSelector.superclass.constructor.call(this,config);};Ext.extend(SG.TasksMiniGridSelector,SG.Cell,{templates:{entity_type_section:'<div class="entity_type_section" entity_type="{entity_type}">'+'<table><tr>{entity_type_label}'+'<td class="pipeline_checks">{pipeline_checks}</td></tr></table>'+'<div class="task_mini_grid" entity_type="{entity_type}"></div></div>',pipeline_step:'<div class="{step_class}" sg_tip="{sg_tip}">'+'<div class="pipeline_check">{checkbox}<label step_id="{id}" for="{checkbox_id}">'+'{step_name}</label><span class="pipeline_summary" entity_type="{entity_type}" '+'step_id="{id}">{summary}</span></div></div>',all_tasks_label:'<span class="all">All</span><div class="entity_icon {entity_icon_class}"></div>'+'<span class="tasks">Tasks</span>',task_grid_button:'<div class="pipeline_step">'+'<span class="{button_type} task_grid_toggle " entity_type="{entity_type}">{label}</span></div>',all_tasks_td:'<td class="all_tasks"><div class="pipeline_check">'+'<div class="entity_icon {entity_icon_class}"></div><span class="tasks">Tasks</span></div></td>',pipeline_steps_loading:'<div class="steps_loading"><center>'+'<img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/></center></div>',note_addressing:'<div class="sgc_note_addressings"></div>',condensed:'<div class="condensed"><table><tr><td class="tasks_label"><span class="label">Tasks :</span></td>'+'<td><div class="sgc_note_addressings"></div></td></tr></table><div class="icon_edit"></div>',},init_cell:function()
{this.cell_manager.on_cell_edit_changed={fn:this.on_cell_edit_change,scope:this};this.add_event(SG.Checkbox,'change',this.on_checkbox_change);var ds=this.cell_manager.data_set;this.autocommit=!this.cell_manager.in_form;this.entities=[];this.selected_step_count={};this.note_addressings=new SG.NoteAdressings({owner:this,owner_data_set:ds});},on_cell_edit_change:function(field,value)
{if(field!='note_links'||!this.record)return;this.record.set('note_links',value);this.set_entities(value);},on_data_change:function(change){if(!this.record||change.state=='pending'||change.record.id!=this.record.id)return;if(this.ignore_tasks_change){this.ignore_tasks_change=false;}else{this.initial_selected_tasks_changed();}},set_entities_if_different:function(note_links)
{if(this.entities.length!=note_links.length)
{this.set_entities(note_links);return;}
var ids=[];for(var i=0;i<this.entities.length;i++)
ids.push(this.entities[i].type+'_'+this.entities[i].id);for(var i=0;i<note_links.length;i++)
{var key=note_links[i].type+'_'+note_links[i].id;if(ids.indexOf(key)==-1)
{this.set_entities(note_links);return;}}},initial_selected_tasks_changed:function()
{this.setup_initial_selected_tasks();var container=this.get_container();var cell_container=container.child('.sg_cell');if(!cell_container)return;var html=this.render_html();cell_container.update(html);},get_content:function(record)
{if(!this.rendered)
{this.setup_initial_state(record);this.rendered=true;}
return this.render_html();},get_classes:function(record){var classes=SG.EditableCell.superclass.get_classes.call(this,record);classes.push('sg_note_tasks_cell');return classes;},all_summary_sets_loaded:function(){if(this.summary_sets===false)return false;for(var entity_type in this.summary_sets){if(!this.summary_sets.hasOwnProperty(entity_type))continue;var summary_set=this.summary_sets[entity_type];if(!summary_set.is_loaded())return false;}
return true;},edit_cell:function(context)
{if(this.render_condensed||!this.all_summary_sets_loaded())return;var container=this.get_container();var t=context.elem;var entity_div;if(t)
entity_div=t.findParent('div.entity_type_section',container.dom,true);if(!entity_div)
{entity_div=container.child('div.entity_type_section');if(!entity_div)
{var new_context={field:'tasks',record:this.record,cell_elem:container.child('div.sg_cell'),direction:context.direction};this.cell_manager.navigate_cells(new_context);return;}}
if(!entity_div)return;var entity_type=entity_div.dom.getAttribute('entity_type');if(this.edit_in_progress)
this.clear_checkbox_focus();this.focus_checkbox(entity_type,0);if(!this.edit_in_progress)
{var me=this;setTimeout(function(){me.add_edit_listeners();},0);}
this.create_keyboard_navigation_grid(entity_type);this.edit_in_progress=true;},clear_checkbox_focus:function()
{var container=this.get_container();var div=sg_find('div.pipeline_check.focused',container.dom);if(!div)return;Ext.get(div).removeClass('focused');},focus_checkbox:function(entity_type,step_id)
{var container=this.get_container();var checkbox_id=this.checkbox_id(entity_type,step_id);var check_elem=container.child('#'+checkbox_id);if(!check_elem)return;var div=Ext.get(check_elem.dom.parentNode);div.addClass('focused');},add_edit_listeners:function()
{var doc=Ext.get(document);this.add_event(doc,'keydown',this.on_key_down);this.add_event(doc,'click',this.on_blur_click);},remove_edit_listeners:function()
{var doc=Ext.get(document);this.remove_event(doc,'keydown',this.on_key_down);this.remove_event(doc,'click',this.on_blur_click);},on_key_down:function(e)
{var key_id=e.getKey();var row=this.check_grid_index.row;var col=this.check_grid_index.col;if(key_id==Ext.EventObject.TAB||key_id==Ext.EventObject.RETURN)
{var direction='down';if(key_id==Ext.EventObject.TAB&&e.browserEvent.shiftKey)
direction='up';var container=this.get_container();var context={field:'tasks',record:this.record,cell_elem:container.child('div.sg_cell'),direction:direction};this.cell_manager.cell_edit_applied(this.field,this.record,this);this.cleanup_cell_edit();this.cell_manager.navigate_cells(context);e.stopEvent();}
else if(key_id==Ext.EventObject.ESC)
{this.cleanup_cell_edit();if(this.render_condensed===false)
{this.render_condensed=true;var container=this.get_container();var html=this.render_html();var cell_container=container.child('.sg_cell');cell_container.update(html);this.setup_initial_selected_tasks();}}
else if(key_id==Ext.EventObject.RIGHT)
{if(col<4)
this.set_check_grid_focus(row,col+1);else
this.set_check_grid_focus(row+1,0);}
else if(key_id==Ext.EventObject.LEFT)
{if(col>0)
this.set_check_grid_focus(row,col-1);else
this.set_check_grid_focus(row-1,4);}
else if(key_id==Ext.EventObject.DOWN)
this.set_check_grid_focus(row+1,col);else if(key_id==Ext.EventObject.UP)
this.set_check_grid_focus(row-1,col);else if(key_id==Ext.EventObject.SPACE)
{var container=this.get_container();var div=Ext.get(sg_find('div.pipeline_check.focused',container.dom));if(!div)return;var check=div.child('div.sg_checkbox');var disabled=check.dom.getAttribute('disabled');if(disabled=='true')return;SG.Checkbox.toggle(check.dom);this.on_checkbox_change(check.dom);}},set_check_grid_focus:function(row,col)
{if(row==this.check_grid_index.row&&col==this.check_grid_index.col)
return;if(row>this.check_grid.length-1||col>4||row<0||col<0)
return;var next=this.check_grid[row][col];if(next==null)
{for(var i=0;i<5;i++)
{var val=this.check_grid[row][i];if(val==null)
{col=i-1;next=this.check_grid[row][col];break;}}}
this.clear_checkbox_focus();this.focus_checkbox(next.entity_type,next.step_id);this.check_grid_index={row:row,col:col};},create_keyboard_navigation_grid:function(focused_entity_type)
{this.check_grid=[];var total_rows=0;for(var entity_type in this.entity_map)
{if(!this.entity_map.hasOwnProperty(entity_type))continue;var entity_steps=this.get_all_applicable_steps(entity_type);var row_count=Math.ceil(entity_steps.length/5);var i,j;var c=0;var step;for(i=0;i<row_count;i++)
{this.check_grid[total_rows]=[];for(j=0;j<5;j++)
{if(c<entity_steps.length)
{step=entity_steps[c];this.check_grid[total_rows][j]={entity_type:entity_type,step_id:step.id};}
else
this.check_grid[total_rows][j]=null;if(focused_entity_type==entity_type&&step.id==0)
this.check_grid_index={row:total_rows,col:j}
c++;}
total_rows++;}}},on_blur_click:function(e)
{var t=Ext.get(e.getTarget());var div=t.findParent('div.sg_cell[field="tasks"]>div',20);if(!div)
{this.cell_manager.cell_edit_applied(this.field,this.record,this);this.cleanup_cell_edit();}},cleanup_cell_edit:function()
{var me=this;setTimeout(function(){me.edit_in_progress=false;me.clear_checkbox_focus();me.remove_edit_listeners();},0);},get_container:function()
{var manager_dom=this.cell_manager.container.dom;var container=Ext.get(sg_find('div.sgc_tasks_mini_grid_selector',manager_dom));return container;},setup_initial_state:function(record)
{this.record=record;this.entities=sg_deep_copy(record.get('note_links'));if(!this.entities)this.entities=[];this.task_grids={};this.selection_history={};this.summary_sets=false;this.set_id();this.build_entity_map();this.setup_initial_selected_tasks();},set_id:function()
{if(!SG.globals.TasksMiniGridSelector_count)
SG.globals.TasksMiniGridSelector_count=0;SG.globals.TasksMiniGridSelector_count=SG.globals.TasksMiniGridSelector_count+1;this.id=SG.globals.TasksMiniGridSelector_count;},destroy_component:function()
{this.container.update('');},build_entity_map:function()
{this.entity_map={};var allowed_types=SG.schema.entity_fields.Task.entity.allowed_entity_types;for(var i=0;i<this.entities.length;i++)
{var entity=this.entities[i];if(allowed_types.indexOf(entity.type)==-1)continue;if(!this.entity_map[entity.type])
this.entity_map[entity.type]=[entity];else
this.entity_map[entity.type].push(entity);}},set_entities:function(entities)
{if(this.are_entities_same(entities))
return;var container=this.get_container();this.entities=sg_deep_copy(entities);if(!this.entities)this.entities=[];this.build_entity_map();var cell_container=container.child('.sg_cell');if(!cell_container)return;var html=this.render_html();cell_container.update(html);},are_entities_same:function(entities)
{if((!entities&&this.entities.length==0)||(entities&&entities.length==0&&this.entities.length==0))
return true;if((!entities&&this.entities.length>0)||(entities&&entities.length!=this.entities.length))
return false;var entity,key;var ids=[];for(var i=0;i<this.entities.length;i++)
{entity=this.entities[i];key=entity.type+'_'+entity.id;ids.push(key);}
for(var i=0;i<entities.length;i++)
{entity=entities[i];key=entity.type+'_'+entity.id;if(ids.indexOf(key)==-1)
return false;}
return true;},setup_initial_selected_tasks:function()
{this.selected_tasks=sg_deep_copy(this.record.get('tasks'));if(!this.selected_tasks)this.selected_tasks=[];this.orphaned_tasks=[];this.initial_selected_task_ids=[];this.initial_selected_tasks=[];for(var i=0;i<this.selected_tasks.length;i++)
{var task=this.selected_tasks[i];this.initial_selected_task_ids.push(task.id);}
if(this.selected_tasks.length>0)
this.request_steps_for_selected_tasks();if(this.selected_tasks.length>0)
this.note_addressings.set_tasks(this.selected_tasks);},update_cell:function(record,no_green_flash){var error=record.get_error(this.field);if(error&&error.description){var sg_tip='';if(error.description.indexOf('The field is not editable for this user')==0&&!SG.globals.current_user.admin)
{sg_tip="You don't have permission to edit this field.";}else{sg_tip=error.description;}
var container=this.get_container();this.previous_sg_tip=container.dom.getAttribute('sg_tip');container.dom.setAttribute('sg_tip',sg_tip);container.dom.setAttribute('status','server_error');}else{var container=this.get_container();container.dom.setAttribute('status','');if(this.previous_sg_tip)
container.dom.setAttribute('sg_tip',this.previous_sg_tip);}},render_html:function(){var html;if(this.render_condensed)
html=this.render_as_condensed();else
html=this.render_full_interface();return html;},render_as_condensed:function(){return this.templates.condensed.apply()},render_full_interface:function()
{this.destroy_all_task_grids();SG.Repo.start_batch();var html='';for(var entity_type in this.entity_map)
{if(!this.entity_map.hasOwnProperty(entity_type))continue;html+=this.render_entity_type_section(entity_type,this.entity_map[entity_type]);}
SG.Repo.end_batch();html+=this.templates.note_addressing.apply();return html;},render_entity_type_section:function(entity_type,entities)
{var step_count=this.request_all_pipeline_step_summaries(entity_type);var h=this.templates.entity_type_section.apply({entity_type:entity_type,entity_type_label:this.render_entity_type_label(entity_type),pipeline_checks:step_count===1?'':this.templates.pipeline_steps_loading.apply(),});return h;},checkbox_id:function(entity_type,step_id)
{return entity_type+'_step_'+step_id+'_'+this.id;},render_entity_type_label:function(entity_type)
{return this.templates.all_tasks_td.apply({entity_icon_class:SG.schema.entity_icon_name(entity_type),});},request_all_pipeline_step_summaries:function(entity_type){var all_steps=[{id:0,short_name:'All',code:'All'}];var steps=SG.globals.steps[entity_type];if(steps)all_steps=all_steps.concat(steps);for(var i=0;i<all_steps.length;i++){this.request_pipeline_step_summary(entity_type,all_steps[i]);}
return all_steps.length;},get_all_applicable_steps:function(entity_type){var steps=[{id:0,short_name:'All',code:'All'}];var global_steps=SG.globals.steps[entity_type];if(!global_steps)return steps;var summary_set=this.summary_sets[entity_type];for(var i=0;i<global_steps.length;i++){var step=global_steps[i];var key=this.record_count_summary_key(entity_type,step.id);var total=summary_set.get(key,'id');if(total>0)
steps.push(step);}
return steps;},render_pipeline_selectors:function(entity_type)
{var steps=this.get_all_applicable_steps(entity_type);var summary_set=this.summary_sets[entity_type];var row_count=Math.floor(steps.length/5)+1;var schema_field=SG.schema.get_field("Task","sg_status_list");var ren=SG.Renderers.status_list_no_tooltip;var h='';var j,checkbox_id,val,summary;for(i=0;i<steps.length;i++)
{step=steps[i];key=entity_type+'_status_'+step.id;val=summary_set.get(key,'sg_status_list');summary=SG.SummaryRenderers.status_list(val,null,schema_field,ren);checkbox_id=this.checkbox_id(entity_type,step.id);h+=this.templates.pipeline_step.apply({step_class:'pipeline_step',id:step.id,step_name:step.short_name,checkbox_id:checkbox_id,checkbox:SG.Checkbox.render(checkbox_id,entity_type,"unchecked",false),entity_type:entity_type,sg_tip:step.code,summary:summary});}
if(this.task_grids[entity_type])
{h+=this.templates.task_grid_button.apply({button_type:'hide_tasks',label:'Hide Tasks',entity_type:entity_type});}
else
{h+=this.templates.task_grid_button.apply({button_type:'show_tasks',label:'Show Tasks',entity_type:entity_type});}
var container=this.get_container();var div=container.child('div.entity_type_section[entity_type="'+entity_type+'"] td.pipeline_checks');div.update(h);},context_projects:function()
{return[];},construct_task_grid:function(grid_container,entity_type)
{var cfg={widget:this,container:grid_container,entity_type:'Task',filters:this.get_mini_grid_filters(entity_type),field_properties:[{field:'content',width:'90'},{field:'step',width:'80'},{field:'sg_status_list',width:'40'},{field:'task_assignees',width:'100'},{field:'start_date',width:'75'},{field:'due_date',width:'75'},],read_only:true,is_record_selected:{fn:this.is_mini_grid_record_selected,scope:this},record_selection_changed:{fn:this.on_mini_grid_selection,scope:this},};if(SG.globals.custom_for=="rubicon")
cfg['read_only']=false;var entities=this.entity_map[entity_type];if(entities.length>1)
cfg.grouping=[{column:'entity',direction:'asc',method:'exact'}];var task_grid=new SG.MiniGrid(cfg);this.task_grids[entity_type]=task_grid;task_grid.render();},get_mini_grid_filters:function(entity_type)
{var entities=this.entity_map[entity_type];var conds=[];for(var i=0;i<entities.length;i++)
{var entity=entities[i];conds.push({path:'entity',relation:'is',values:[entity]});}
var filters={logical_operator:"and",conditions:[{logical_operator:"or",conditions:conds}]};return filters;},is_mini_grid_record_selected:function(rec)
{var entity_type=rec.get('entity').type;var last_state=(this.initial_selected_task_ids.indexOf(rec.id)!=-1);if(!this.selection_history[entity_type])return last_state;var selection_history=this.selection_history[entity_type];for(var i=0;i<selection_history.length;i++)
{var history_event=selection_history[i];var new_state=this.test_record_against_history(last_state,history_event,rec);last_state=new_state;}
return last_state;},test_record_against_history:function(last_state,history_event,rec)
{if(history_event.type=='record')
{if(rec.id!=history_event.record_id)
return last_state;else
return history_event.selected;}
else
{var step=rec.get('step');if(step&&step.id==history_event.step_id)
return history_event.selected;else
{if(history_event.step_id==0)
return history_event.selected;else
return last_state;}}},on_mini_grid_selection:function(rec,selected)
{var entity_type=rec.get('entity').type;var step=rec.get('step');if(!this.selection_history[entity_type])
this.selection_history[entity_type]=[];this.selection_history[entity_type].push({selected:selected,type:'record',step_id:step?step.id:null,record_id:rec.id});this.update_pipeline_step_checkboxes(entity_type);this.fire_task_selection_changed();},update_all_pipeline_step_checkboxes:function()
{if(this.render_condensed)
{this.countup_steps_in_selected_tasks();return;}
if(!this.rendered||!this.all_summary_sets_loaded())return;for(var entity_type in this.entity_map)
{if(!this.entity_map.hasOwnProperty(entity_type))continue;this.update_pipeline_step_checkboxes(entity_type);}},update_pipeline_step_checkboxes:function(entity_type)
{var entity_steps=this.get_all_applicable_steps(entity_type);var checkbox_states=[];var container=this.get_container();for(var i=0;i<entity_steps.length;i++)
{var step=entity_steps[i];if(step.id==0)continue;var checkbox_id=this.checkbox_id(entity_type,step.id);var checkbox=sg_find('#'+checkbox_id,container.dom);if(!checkbox)continue;var state=this.get_pipeline_checkbox_state(entity_type,step.id);checkbox_states.push({step_id:step.id,state:state});this.set_checkbox_state(checkbox,state);var parent_div=Ext.get(checkbox.parentNode);if(state=='disabled')
{if(!parent_div.hasClass('disabled'))
parent_div.addClass('disabled');}
else if(parent_div.hasClass('disabled'))
parent_div.removeClass('disabled');}
this.update_the_all_pipeline_step_checkbox(entity_type,checkbox_states);},get_checkbox_state:function(checkbox)
{if(SG.Checkbox.is_disabled(checkbox))
return'disabled';else
return SG.Checkbox.get_state(checkbox);},set_checkbox_state:function(checkbox,state)
{if(state=='disabled'){SG.Checkbox.disable(checkbox);}else{SG.Checkbox.undisable(checkbox);SG.Checkbox.set_state(checkbox,state);}},update_the_all_pipeline_step_checkbox:function(entity_type,checkbox_states)
{var container=this.get_container();if(!checkbox_states)
{var entity_steps=this.get_all_applicable_steps(entity_type);checkbox_states=[];for(var i=0;i<entity_steps.length;i++)
{var step=entity_steps[i];if(step.id==0)continue;var checkbox_id=this.checkbox_id(entity_type,step.id);var state=this.get_checkbox_state(checkbox_id);checkbox_states.push({step_id:step.id,state:state});}}
var checkbox_id=this.checkbox_id(entity_type,0);var checkbox=sg_find('#'+checkbox_id,container.dom);if(!checkbox)return;var state=this.get_the_all_checkbox_state(entity_type,checkbox_states);this.set_checkbox_state(checkbox,state);var parent_div=Ext.get(checkbox.parentNode);if(state=='disabled')
{if(!parent_div.hasClass('disabled'))
parent_div.addClass('disabled');}
else if(parent_div.hasClass('disabled'))
parent_div.removeClass('disabled');},get_the_all_checkbox_state:function(entity_type,checkbox_states)
{if(this.initial_selected_task_ids.length>0&&!this.selected_tasks_data_set.is_loaded)
return'disabled';var checked=0;var unchecked=0;var dashed=0;var disabled=0;for(var i=0;i<checkbox_states.length;i++)
{var state=checkbox_states[i]['state'];if(state=='checked')
checked++;else if(state=='unchecked')
unchecked++;else if(state=='dashed')
dashed++;else if(state=='disabled')
disabled++;}
if((dashed+checked)>0&&unchecked>0)
return'dashed';else if(checked>0&&checked==(checkbox_states.length-disabled))
{var sum=0;var summary_set=this.summary_sets[entity_type];var summary_key=this.record_count_summary_key(entity_type,0);var total=Number(summary_set.get(summary_key,'id'));for(var i=0;i<checkbox_states.length;i++)
{summary_key=this.record_count_summary_key(entity_type,checkbox_states[i].step_id);sum+=Number(summary_set.get(summary_key,'id'));}
sum+=this.count_selected_tasks_without_steps(entity_type);if(total!=sum)
return'dashed';else
return'checked';}
else if(disabled==checkbox_states.length)
{var summary_set=this.summary_sets[entity_type];var summary_key=this.record_count_summary_key(entity_type,0);var total=Number(summary_set.get(summary_key,'id'));if(total==0)
return'disabled';var tasks_without_steps_count=this.count_selected_tasks_without_steps(entity_type);if(tasks_without_steps_count==0)
return'unchecked';if(total==tasks_without_steps_count)
return'checked';else
return'dashed';}
else
{var sum=this.count_selected_tasks_without_steps(entity_type);if(sum>0)
return'dashed';else
return'unchecked';}},count_selected_tasks_without_steps:function(entity_type)
{var ids=[];if(this.initial_selected_tasks)
{for(var i=0;i<this.initial_selected_tasks.length;i++)
{var rec=this.initial_selected_tasks[i];var entity=rec.get('entity');var step=rec.get('step');if(!step&&entity.type==entity_type)
ids.push(rec.id);}}
var selection_history=this.selection_history[entity_type];if(!selection_history)
return ids.length;for(var i=0;i<selection_history.length;i++)
{var history_event=selection_history[i];if(history_event.type=='record'&&history_event.step_id==null)
{if(history_event.selected&&ids.indexOf(history_event.record_id)==-1)
ids.push(history_event.record_id);else if(!history_event.selected&&ids.indexOf(history_event.record_id)!=-1)
{var index=ids.indexOf(history_event.record_id);ids.splice(index,1);}}}
return ids.length;},get_pipeline_checkbox_state:function(entity_type,step_id)
{var init_sel_count=0;if(this.initial_selected_tasks&&this.initial_selected_tasks.length>0&&this.selected_tasks_data_set.is_loaded)
{for(var i=0;i<this.initial_selected_tasks.length;i++)
{var rec=this.initial_selected_tasks[i];var step=rec.get('step');if(step&&step.id==step_id)
init_sel_count++;}}
var sel_count=0;var unsel_count=0;var selection_history=this.selection_history[entity_type];if(!selection_history)selection_history=[];var summary_key=this.record_count_summary_key(entity_type,step_id);var summary_set=this.summary_sets[entity_type];var step_total=Number(summary_set.get(summary_key,'id'));if(step_total==null||step_total==undefined)
return'unchecked';if(step_total==0)
return'disabled';for(var i=0;i<selection_history.length;i++)
{var history_event=selection_history[i];if(history_event.type=='record'){if(history_event.step_id!=null&&history_event.step_id==step_id){if(history_event.selected)
sel_count++;else
unsel_count++;}}else{if(history_event.step_id==step_id){sel_count=0;unsel_count=0;if(history_event.selected)
init_sel_count=step_total;else
init_sel_count=0;}}}
var total_sel=init_sel_count+sel_count-unsel_count;if(total_sel==step_total)
return'checked';else if(total_sel==0)
return'unchecked';else
return'dashed';},on_checkbox_change:function(checkbox)
{var container=this.get_container();if(!container.contains(checkbox))return;var id=checkbox.getAttribute('id');if(id.indexOf('_step_')==-1)return;var parts=id.split('_');var entity_type=parts[0];var step_id=parts[2];var state=checkbox.getAttribute('checkbox_state');if(!this.selection_history[entity_type])
this.selection_history[entity_type]=[];if(step_id==0)
{var entity_steps=SG.globals.steps[entity_type];if(entity_steps)
{for(var i=0;i<entity_steps.length;i++)
{this.selection_history[entity_type].push({selected:state=='checked',type:'step',step_id:entity_steps[i].id,record_id:null});}
this.selection_history[entity_type].push({selected:state=='checked',type:'step',step_id:0,record_id:null});this.set_state_for_all_pipeline_checkboxes(entity_type,state);this.fire_task_selection_changed();}
else
{this.selection_history[entity_type].push({selected:state=='checked',type:'step',step_id:step_id,record_id:null});this.fire_task_selection_changed();}}
else
{this.selection_history[entity_type].push({selected:state=='checked',type:'step',step_id:step_id,record_id:null});if(state=='unchecked')
this.uncheck_the_all_tasks_checkbox(entity_type);this.update_the_all_pipeline_step_checkbox(entity_type);this.fire_task_selection_changed();}
var task_grid=this.task_grids[entity_type];if(task_grid)task_grid.render();},uncheck_the_all_tasks_checkbox:function(entity_type)
{var container=this.get_container();var checkbox_id=this.checkbox_id(entity_type,0);var all_checkbox=sg_find('#'+checkbox_id,container.dom);this.set_checkbox_state(all_checkbox,'unchecked');},destroy_all_task_grids:function()
{for(var entity_type in this.task_grids)
{if(!this.task_grids.hasOwnProperty(entity_type))continue;var task_grid=this.task_grids[entity_type];task_grid.destroy();}
this.task_grids={};this.selection_history={};},on_click:function(context)
{var t=context.elem;var container=this.get_container();var task_grid_toggle=t.findParent('span.task_grid_toggle',container,true);if(task_grid_toggle)
{if(task_grid_toggle.hasClass('show_tasks'))
{task_grid_toggle.replaceClass('show_tasks','hide_tasks');task_grid_toggle.update('Hide Tasks');var entity_type=task_grid_toggle.dom.getAttribute('entity_type');var task_mini_grid_div=container.child('div.task_mini_grid[entity_type="'+entity_type+'"]');task_mini_grid_div.addClass('showing');this.construct_task_grid(task_mini_grid_div,entity_type);}
else
{task_grid_toggle.replaceClass('hide_tasks','show_tasks');task_grid_toggle.update('Show Tasks');var entity_type=task_grid_toggle.dom.getAttribute('entity_type');var task_mini_grid_div=container.child('div.task_mini_grid[entity_type="'+entity_type+'"]');var task_grid=this.task_grids[entity_type];task_grid.destroy();delete this.task_grids[entity_type];task_mini_grid_div.update('');task_mini_grid_div.removeClass('showing');}
return;}
var mini_grid=t.findParent('div.task_mini_grid',container);if(mini_grid)return;this.edit_cell(context);},set_state_for_all_pipeline_checkboxes:function(entity_type,new_state)
{var container=this.get_container();var checkboxes=sg_find_all('div.sg_checkbox.'+entity_type,container.dom);for(var i=0;i<checkboxes.length;i++)
{var checkbox=checkboxes[i];if(!checkbox.hasAttribute('disabled'))
this.set_checkbox_state(checkbox,new_state);}},record_count_summary_key:function(entity_type,step_id)
{return entity_type+'_count_'+step_id;},request_pipeline_step_summary:function(entity_type,step)
{if(this.summary_sets===false)this.summary_sets={};if(!this.summary_sets[entity_type]){var summary_set=new SG.Data.SummarySet(entity_type);this.add_event(summary_set,'load',this.on_summary_load);this.summary_sets[entity_type]=summary_set;}else{var summary_set=this.summary_sets[entity_type];summary_set.reset();}
var filters=this.get_mini_grid_filters(entity_type);var key;if(step.id!=0)
{var step_cond={path:'step',relation:'is',values:[{name:step.code,id:step.id,type:'Step'}]};filters.conditions.push(step_cond);}
var spec={type:'Task',filters:filters,summaries:[{column:'id',type:'record_count'}],result:this.summary_sets[entity_type],result_key:this.record_count_summary_key(entity_type,step.id)};SG.Repo.summarize(spec);spec={type:'Task',filters:filters,summaries:[{column:"sg_status_list",type:"status_list"}],result:this.summary_sets[entity_type],result_key:entity_type+'_status_'+step.id};SG.Repo.summarize(spec);},on_summary_load:function(keys)
{if(!this.rendered)return;var entity_types_to_render=[];var container=this.get_container();for(var i=0;i<keys.length;i++)
{var key=keys[i];var parts=key.split('_');var entity_type=parts[0];var summary_type=parts[1];var step_id=Number(parts[2]);var summary_set=this.summary_sets[entity_type];if(summary_type=='status'&&!this.render_condensed){if(entity_types_to_render.indexOf(entity_type)==-1)
entity_types_to_render.push(entity_type);}}
for(i=0;i<entity_types_to_render.length;i++){this.render_pipeline_selectors(entity_types_to_render[i]);this.update_pipeline_step_checkboxes(entity_types_to_render[i]);}},countup_steps_in_selected_tasks:function()
{this.selected_step_count={};if(!this.selected_tasks_data_set||!this.selected_tasks_data_set.is_loaded())return;for(var i=0;i<this.selected_tasks_data_set.count();i++)
{var rec=this.selected_tasks_data_set.get_record(i);var step=rec.get('step');if(!step)continue;if(this.selected_step_count[step.id]==undefined)
this.selected_step_count[step.id]=1;else
this.selected_step_count[step.id]=this.selected_step_count[step.id]+1;}},get_selected_tasks:function(callback)
{if(!this.entity_map)
{if(!this.autocommit)
this.note_addressings.set_tasks([]);setTimeout(function(){callback.fn.call(callback.scope,null);},0);return;}
this.task_callback=callback;this.data_sets_loaded=0;this.data_sets_to_load=0;this.selected_tasks=[];for(var entity_type in this.entity_map)
{if(!this.entity_map.hasOwnProperty(entity_type))continue;this.data_sets_to_load++;var data_set=this.new_data_set('Task',this.on_load_data_set);this.fetch_tasks(entity_type,data_set);}
if(this.data_sets_to_load==0)
this.add_any_orphaned_tasks_and_fire_callback([]);},fetch_tasks:function(entity_type,data_set)
{var spec={type:'Task',filters:this.get_mini_grid_filters(entity_type),columns:['content','id','entity'],result:data_set,records_per_page:500};SG.Repo.query(spec);},on_load_data_set:function(data_set)
{for(var i=0;i<data_set.count();i++)
{var rec=data_set.get_record(i);if(this.is_mini_grid_record_selected(rec))
{this.selected_tasks.push({type:'Task',id:rec.id,name:rec.get('content'),link:rec.get('entity')});}}
this.data_sets_loaded++;if(this.data_sets_loaded==this.data_sets_to_load)
this.add_any_orphaned_tasks_and_fire_callback(this.selected_tasks);},add_any_orphaned_tasks_and_fire_callback:function(tasks)
{if(this.orphaned_tasks)
{for(var i=0;i<this.orphaned_tasks.length;i++)
{var rec=this.orphaned_tasks[i];tasks.push({type:'Task',id:rec.id,name:rec.get('content'),link:rec.get('entity')});}}
if(!this.autocommit)
this.note_addressings.set_tasks(tasks);if(this.task_callback)
this.task_callback.fn.call(this.task_callback.scope,tasks)},request_steps_for_selected_tasks:function()
{this.selected_tasks_data_set=this.new_data_set('Task',this.on_load_selected_tasks);var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:this.initial_selected_task_ids},]};var spec={type:'Task',filters:filters,columns:['id','step','entity','content'],result:this.selected_tasks_data_set,};SG.Repo.query(spec);},on_load_selected_tasks:function()
{this.orphaned_tasks=[];this.initial_selected_tasks=[];for(var i=0;i<this.initial_selected_task_ids.length;i++)
{var task_id=this.initial_selected_task_ids[i];var rec=this.selected_tasks_data_set.get_record_by_id(task_id);if(!rec)continue;var entity=rec.get('entity');if(!entity)
this.orphaned_tasks.push(rec);else
this.initial_selected_tasks.push(rec);}
if(this.rendered)
this.update_all_pipeline_step_checkboxes();},render_note_addressings:function(){var tasks=[];for(var i=0;i<this.initial_selected_task_ids.length;i++){var task_id=this.initial_selected_task_ids[i];tasks.push({type:'Task',id:task_id});}
if(!this.autocommit)
this.note_addressings.set_tasks(tasks);},fire_task_selection_changed:function(){if(this.autocommit)
this.get_selected_tasks({fn:this.commit_tasks,scope:this});else
this.get_selected_tasks();},commit_tasks:function(tasks)
{this.ignore_tasks_change=true;this.record.set('tasks',tasks);this.record.commit();},});SG.PasswordCell=function(config){Ext.apply(this,config);SG.PasswordCell.superclass.constructor.call(this);};Ext.extend(SG.PasswordCell,SG.EditableCell,{get_classes:function(record){var classes=SG.EditableCell.superclass.get_classes.call(this,record);if(this.is_editable(record))
{classes.push('change_password_cell');classes.push('sg_cell_editable');}
return classes;},is_editable:function(record){if(SG.globals.preferences.user_authentication_method==='ldap')
return false;else
return SG.PasswordCell.superclass.is_editable.call(this,record);},get_content:function(record)
{var html='';if(this.is_editable(record)){html=this.templates.wrapped_editor.apply({value:'Change Password',edit_icon:'icon_edit'});}else{html='<div class="sg_cell_content">******</div>';}
return html;},edit_cell:function(context){this.show_change_dialog(context.record);},on_click:function(context,optional_event){if(this.is_editable(context.record))
this.show_change_dialog(context.record);},show_change_dialog:function(record){var dialog=new SG.ChangePasswordDialog({require_current_password:record.id==SG.globals.current_user.id,user_id:record.id,show_email_and_temp_password_controls:true,allow_cancel:true,start_with_temp_password:record.id!=SG.globals.current_user.id});},});SG.Menu=function(config)
{Ext.apply(this,config);SG.Menu.superclass.constructor.call(this);};SG.Menu.last_id=0;SG.Menu.now_showing=null;SG.Menu.cancel_current=function()
{if(SG.Menu.now_showing)
SG.Menu.now_showing.cancel();}
SG.Menu.menus={};SG.Menu.get_menu=function(menu_id)
{return SG.Menu.menus[menu_id];}
Ext.extend(SG.Menu,SG.Component,{templates:{menu:'<div class="sg_menu sg_menu_hidden sg_menu_no_scroll sg_focusable {extra_classes} {custom_menu_class}"'+'id="{menu_id}" tabindex="-1">'+'<div class="sg_menu_top_scroll scrolled_all_the_way"><div class="scroll_up">&nbsp;</div></div>'+'<div class="sg_menu_body">{items}<div class="sg_menu_item_bottom_spacer"></div></div>'+'<div class="sg_menu_bottom_scroll"><div class="scroll_down">&nbsp;</div></div>'+'</div>',section_heading:'<div class="sg_menu_heading">{heading_content}</div>',item:'<div class="sg_menu_item sg_menu_all_items {extra_class} {custom_item_class}" '+'sg_menu_item_id="{item_id}">'+'{checkmark}'+'{icon_html}'+'<span class="sg_menu_item_content">{item_content}</span>'+'</div>',anchor_item:'<a class="sg_menu_item" href="{href}" {href_target} >'+'<div class="sg_menu_item sg_menu_all_items {extra_class} {custom_item_class}" '+'sg_menu_item_id="{item_id}">'+'{checkmark}'+'{icon_html}'+'<span class="sg_menu_item_content">{item_content}</span>'+'</div></a>',submenu_item:'<div class="sg_menu_all_items sg_menu_submenu_item {extra_class}" sg_menu_item_id="{item_id}">'+'{checkmark}'+'{icon_html}'+'<span class="sg_menu_item_content">{item_content}</span>'+'<div class="sg_menu_submenu_arrow submenu_arrow">&nbsp;</div>'+'</div>',divider:'<hr/>',no_items:'<div class="sg_menu_no_items">No menu items</div>',icon:'<div class="sg_menu_icon {container_class}" {container_style}>'+'<div class="sg_menu_icon_image_div {image_class}" {img_style}>&nbsp;</div></div>'},SUBMENU_MOUSEOVER_ALLOWANCE_TIME:350,MENU_SCROLL_TIME_INTERVAL:10,MENU_SCROLL_PIXEL_JUMP:5,VIEWPORT_MARGIN:10,BODY_SCROLL_MARGIN:17,match_buffer:'',init_component:function(config)
{if(!this.id)
this.id="sg_menu_"+(++SG.Menu.last_id);if(!this.items)
this.items=[];if(!this.render_container)
this.render_container=document.body;if(!this.display_container)
this.display_container=this.render_container;if(!this.icon_width)
this.icon_width=15;this.submenu_attached_left=false;this.root_menu=this;this.submenu_instances=[];this.events={before_first_render:true,before_render:true,before_show:true,keydown:true,item_selected:true,canceled:true,after_hide:true}
if(this.item_selected)
this.own_item_selected_handler=true;for(var event_name in this.events)
{if(!this.events.hasOwnProperty(event_name))
continue;if(this[event_name])
{this.on(event_name,this[event_name].fn,this[event_name].scope);delete this[event_name];}}
SG.Menu.menus[this.id]=this;this.last_hovered=null;},add_item:function(item_config)
{this.items.push(item_config);},is_rendered:function()
{return(this.menu_ext_elem!=null&&typeof this.menu_ext_elem!='undefined');},is_showing:function()
{return(SG.Menu.now_showing&&SG.Menu.now_showing==this);},contains_elem:function(ext_or_dom)
{if(!this.menu_ext_elem)
return false;var ext_elem=Ext.get(ext_or_dom);if(ext_elem==this.menu_ext_elem||ext_elem.up(this.menu_ext_elem,7))
return true;return false;},render:function()
{var old_menu=null;if(!this.menu_ext_elem)
this.fireEvent("before_first_render",this);else
old_menu=this.menu_ext_elem.dom;this.fireEvent("before_render",this);this.item_hash={};var items=this.render_menu_items();var extra_classes=(this.checked_count==0?'no_checked ':'')+(this.icon_count==0?'no_icons':'');this.menu_ext_elem=this.templates['menu'].append(this.render_container,{menu_id:this.id,items:items,extra_classes:extra_classes,custom_menu_class:this.menu_class?this.menu_class:''},true);if(this.keyboard_item_focus)
this.menu_ext_elem.addClass('no_mouseover_highlight');if(old_menu)
old_menu.parentNode.removeChild(old_menu);},render_menu_items:function()
{var menu_items=[];var item;var template;this.checked_count=0;this.icon_count=0;for(var i=0;i<this.items.length;i++)
{item=this.items[i];if(item.line||(item.heading&&i!=0))
menu_items.push(this.templates['divider'].apply({}));if(item.heading)
{menu_items.push(this.templates['section_heading'].apply({heading_content:item.heading}));this.checked_count++;}
if(item.html)
{if(item.checked)
this.checked_count++;if(item.icon_name||item.icon_bg_color)
this.icon_count++;var extra_classes='';if(item.disabled)
extra_classes+='sg_menu_item_disabled ';if(item.default_item)
{extra_classes+='sg_menu_item_focus ';this.keyboard_item_focus=true;}
if(this.allow_submenu_click_events)
{extra_classes+='sg_menu_item ';}
template=item.submenu?this.templates['submenu_item']:this.templates['item'];if(item.href&&!item.disabled)
template=this.templates['anchor_item'];menu_items.push(template.apply({item_content:item.html,item_id:i,extra_class:extra_classes,checkmark:this.render_icon('sg_menu_item_checkmark',(item.checked?'checkmark':'blank')),custom_item_class:item.item_class?item.item_class:'',icon_html:this.render_icon('',(item.icon_name?item.icon_name:'blank'),true,item.icon_bg_color),href:item.href?item.href:'',href_target:item.href_target?item.href_target:'',}));this.item_hash[""+i]=item;}}
if(menu_items.length>0)
return menu_items.join("");else
return this.templates.no_items.apply({});},render_icon:function(container_class,icon_name,limit_size,icon_background_color)
{if(limit_size)
{var container_style='width:'+this.icon_width+'px;';var img_style='max-width:'+this.icon_width+'px;';if(this.icon_height)
{container_style+='height:'+this.icon_height+'px;';img_style+='max-height:'+this.icon_height+'px;';}
if(icon_background_color)
img_style+='background-color: rgb('+icon_background_color+');';container_style='style="'+container_style+'"';img_style='style="'+img_style+'"';}
return this.templates['icon'].apply({container_class:container_class,image_class:(icon_name?icon_name:'blank'),container_style:limit_size?container_style:'',img_style:limit_size?img_style:''});},show:function()
{this.fireEvent("before_show",this);if(!this.menu_ext_elem)
throw("SG.Menu: No menu html element for menu. Call render() before show()!");if(this.root_menu==this&&!this.non_volatile)
{if(SG.Menu.now_showing)
SG.Menu.now_showing.cancel();SG.Menu.now_showing=this;}
if(this.position=="no_positioning")
{this.menu_ext_elem.removeClass("sg_menu_hidden");}
else
{this.menu_ext_elem.setTop(-10000);this.menu_ext_elem.addClass("sg_menu_invisible");this.menu_ext_elem.removeClass("sg_menu_hidden");this.size_for_viewport();if(this.root_menu==this)
if(this.position.xy)
{var db=Ext.get(document.body);var dw=db.getWidth();var menu_width=this.menu_ext_elem.getWidth();var xy=sg_deep_copy(this.position.xy);if(xy[0]+menu_width>dw)
xy[0]=dw-menu_width+5;this.menu_ext_elem.setXY(xy);this.menu_ext_elem.alignTo(this.menu_ext_elem.dom,"tl-tl?");}
else if(this.position.minimum_height)
{this.apply_minimum_height_positioning();}
else if(this.position.no_cover)
{this.apply_no_cover_positioning();}
else
{var elem_anchor=this.position.elem_anchor||'bl';var menu_anchor=this.position.menu_anchor||'tl';this.menu_ext_elem.alignTo(this.position.dom_elem,menu_anchor+"-"+elem_anchor+"?");}
else
{if(this.submenu_attached_left)
this.menu_ext_elem.alignTo(this.position.dom_elem,"tr-tl?");else
this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-tr?");}
this.apply_cover_rule();this.menu_ext_elem.removeClass("sg_menu_invisible");}
if(this.parent_menu)
{var position_dom_left=Ext.lib.Dom.getX(this.position.dom_elem);var menu_dom_left=Ext.lib.Dom.getX(this.menu_ext_elem.dom);if(this.submenu_attached_left)
{if(position_dom_left<menu_dom_left)
{this.submenu_attached_left=false;}}
else
{if(position_dom_left>menu_dom_left)
{this.submenu_attached_left=true;}}}
if(!this.shadow&&!this.non_volatile)
this.shadow=new Ext.Shadow({mode:'sides'});if(this.shadow)
this.shadow.show(this.menu_ext_elem);this.add_event(this.menu_ext_elem.dom,"click",this.on_menu_click);this.add_event(this.menu_ext_elem.dom,"contextmenu",this.on_menu_click);this.skip_handle_item_selected=true;var menu=this;setTimeout(function(){menu.skip_handle_item_selected=false;},0);this.add_event(this.menu_ext_elem.dom,"mousemove",this.on_menu_mousemove);this.add_event(this.menu_ext_elem,'keydown',this.on_keydown);if(Ext.isGecko)
this.add_event(this.menu_ext_elem,'keypress',this.on_keypress);if(this.root_menu==this&&!this.non_volatile)
{var menu=this;setTimeout(function(){menu.add_event(document.body,"click",menu.on_page_click);},0);}
this.add_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseover,this,"up");this.add_event(this.menu_ext_elem.dom.childNodes[0],"mouseout",this.on_scroll_mouseout,this,"up");this.add_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseover,this,"down");this.add_event(this.menu_ext_elem.dom.childNodes[2],"mouseout",this.on_scroll_mouseout,this,"down");this.focus();},hide:function()
{this.cancel();},cancel:function()
{this.fireEvent('canceled',this);if(this.root_menu==this)
{this.__hide();}
else
this.root_menu.cancel();},__hide:function()
{if(this.menu_ext_elem)
{this.stop_scroll();this.blur();this.remove_event(this.menu_ext_elem.dom,"click",this.on_menu_click);this.remove_event(this.menu_ext_elem.dom,"contextmenu",this.on_menu_click);if(this.root_menu==this&&!this.non_volatile)
this.remove_event(document.body,"click",this.on_page_click);this.remove_event(this.menu_ext_elem.dom,"mousemove",this.on_menu_mousemove);this.remove_event(this.menu_ext_elem,'keydown',this.on_keydown);this.remove_event(this.menu_ext_elem,'keypress',this.on_keypress)
this.remove_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseover);this.remove_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseout);this.remove_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseover);this.remove_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseout);this.menu_ext_elem.addClass("sg_menu_hidden");this.menu_ext_elem.setStyle({"left":"","right":"","top":"","bottom":""});}
if(this.shadow)
this.shadow.hide();if(SG.Menu.now_showing==this)
SG.Menu.now_showing=null;this.hide_current_submenu();this.fireEvent('after_hide',this);},focus:function()
{if(this.menu_ext_elem)
this.menu_ext_elem.dom.focus();},blur:function()
{if(this.menu_ext_elem)
this.menu_ext_elem.dom.blur();},hide_current_submenu:function()
{if(this.current_submenu_item_showing)
{this.remove_event(this.current_submenu_item_showing.submenu_instance.menu_ext_elem.dom,"mouseover",this.on_submenu_mouseover);this.menu_ext_elem.child('div[sg_menu_item_id='+this.current_submenu_item_id+']').removeClass('open');this.current_submenu_item_showing.submenu_instance.__hide();this.current_submenu_item_showing=null;this.current_submenu_item_id=null;}
this.focus();},size_for_viewport:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var max_height=viewport_height-(2*this.VIEWPORT_MARGIN);this.apply_height_and_scroll_rules(max_height);},apply_cover_rule:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var xy=this.menu_ext_elem.getXY();if(xy[1]<this.VIEWPORT_MARGIN)
{}
else
{if(xy[1]+this.menu_ext_elem.getHeight()>viewport_height-this.VIEWPORT_MARGIN)
{xy[1]=viewport_height-this.VIEWPORT_MARGIN-this.menu_ext_elem.getHeight();this.menu_ext_elem.setXY(xy);}}},apply_no_cover_positioning:function()
{this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");var viewport_height=Ext.lib.Dom.getViewHeight();var position_ext_elem=Ext.get(this.position.dom_elem);var position_elem_pos=position_ext_elem.getXY();var position_elem_height=position_ext_elem.getHeight();var elem_pos=this.menu_ext_elem.getXY();var elem_height=this.menu_ext_elem.getHeight();if(elem_pos[1]+elem_height>viewport_height-this.VIEWPORT_MARGIN)
{var space_below=(viewport_height-(2*this.VIEWPORT_MARGIN))-
(position_elem_pos[1]+position_elem_height);var space_above=position_elem_pos[1]-(2*this.VIEWPORT_MARGIN);if(space_below>=space_above)
{this.apply_height_and_scroll_rules(space_below);}
else
{this.apply_height_and_scroll_rules(space_above);}
this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");}},apply_minimum_height_positioning:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var position_ext_elem=Ext.get(this.position.dom_elem);var position_elem_pos=position_ext_elem.getXY();var position_elem_height=position_ext_elem.getHeight();var position='below';var space_below=(viewport_height-(2*this.VIEWPORT_MARGIN))-
(position_elem_pos[1]+position_elem_height);var space_above=position_elem_pos[1]-(2*this.VIEWPORT_MARGIN);if(space_below<this.position.minimum_height&&space_above>this.position.minimum_height)
position='above';else if(space_below<this.position.minimum_height)
position='not_enough_space';if(position=='below')
{this.apply_height_and_scroll_rules(space_below);this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");}
else if(position=='above')
{this.apply_height_and_scroll_rules(space_above);this.menu_ext_elem.alignTo(this.position.dom_elem,"bl-tl?");}
else
{this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");var pos=this.menu_ext_elem.getXY();pos[1]=position_elem_pos[1]+position_elem_height;}},apply_height_and_scroll_rules:function(max_height)
{var menu_height=this.menu_ext_elem.getHeight();var menu_body=this.menu_ext_elem.dom.childNodes[1];var menu_body_height=menu_body.offsetHeight;if(this.max_height&&this.max_height<max_height)
max_height=this.max_height;if(this.menu_ext_elem.hasClass('sg_menu_scroll'))
{if(menu_height<(max_height-50)||menu_height>max_height)
{this.menu_ext_elem.addClass('sg_menu_no_scroll');this.menu_ext_elem.removeClass('sg_menu_scroll');menu_body.style.height=null}}
if(this.menu_ext_elem.hasClass('sg_menu_no_scroll'))
{if(menu_height>max_height)
{this.menu_ext_elem.removeClass('sg_menu_no_scroll');this.menu_ext_elem.addClass('sg_menu_scroll');menu_body.style.height=(max_height-(2*this.BODY_SCROLL_MARGIN))+'px';}}},destroy_component:function()
{if(this.is_showing())
this.cancel();this.submenu_instances=this.submenu_instances||[];for(var i=0;i<this.submenu_instances.length;i++)
{this.submenu_instances[i].destroy();}
if(this.menu_ext_elem)
this.menu_ext_elem.remove();delete SG.Menu.menus[this.id];delete this.current_submenu_item_showing
delete this.items;delete this.submenu_instances;delete this.render_container;delete this.display_container;delete this.menu_ext_elem;delete this.shadow;this.purgeListeners();},display_submenu:function(item_dom,submenu_item)
{this.hide_current_submenu();if(!submenu_item.submenu_instance)
{if(!submenu_item.submenu.id)
submenu_item.submenu.id=this.id+"_submenu_"+(++SG.Menu.last_id);submenu_item.submenu_instance=new SG.Menu(submenu_item.submenu);submenu_item.submenu_instance.render();this.submenu_instances.push(submenu_item.submenu_instance);}
var submenu=submenu_item.submenu_instance;submenu.parent_menu=this;submenu.root_menu=this.root_menu;if(this.parent_menu&&this.submenu_attached_left)
{submenu.position={dom_elem:item_dom,elem_anchor:"tr",menu_anchor:"tl"};submenu.submenu_attached_left=true;}
else
{submenu.position={dom_elem:item_dom,elem_anchor:"tl",menu_anchor:"tr"};submenu.submenu_attached_left=false;}
Ext.get(item_dom).addClass('open');submenu_item.submenu_instance.show();this.current_submenu_item_showing=submenu_item;this.current_submenu_item_id=item_dom.getAttribute('sg_menu_item_id');},handle_item_selected:function(item_hash,target_dom)
{if(item_hash.item_selected)
{if(!this.non_volatile)
this.root_menu.__hide();var menu=this;setTimeout(function(){item_hash.item_selected.fn.call(item_hash.item_selected.scope,menu,item_hash,target_dom);},0);}
else if(this.parent_menu&&!this.own_item_selected_handler)
{this.parent_menu.handle_item_selected(item_hash,target_dom);}
else
{if(!this.non_volatile)
this.root_menu.__hide();this.fireEvent("item_selected",this,item_hash,target_dom);}},on_keydown:function(e)
{if(e.keyCode==0)
{}
else
{switch(e.keyCode)
{case Ext.EventObject.RETURN:e.stopEvent();this.on_return_key();break;case Ext.EventObject.ESC:e.stopEvent();this.cancel();break;case Ext.EventObject.UP:if(!Ext.isGecko)
this.key_up_down(true);break;case Ext.EventObject.DOWN:if(!Ext.isGecko)
this.key_up_down(false);break;case Ext.EventObject.LEFT:if(this.parent_menu)
{this.clear_keyboard_focus();this.parent_menu.focus();}
break;case Ext.EventObject.RIGHT:if(this.current_submenu_item_showing)
{this.current_submenu_item_showing.submenu_instance.focus();this.current_submenu_item_showing.submenu_instance.key_up_down(false);}
break;default:var matched=this.match_typing(e.keyCode);if(matched)
{e.stopEvent();return;}
this.fireEvent('keydown',this,e);return;}}
e.stopEvent();},match_typing:function(next_char_code)
{if((next_char_code>47&&next_char_code<58)||(next_char_code>64&&next_char_code<91)||(next_char_code==32))
{if(this.match_buffer_timeout)
{clearTimeout(this.match_buffer_timeout);this.match_buffer_timeout=null;}
this.match_buffer+=String.fromCharCode(next_char_code);var re=new RegExp("^"+this.match_buffer,"i");for(var i=0;i<this.items.length;i++)
{if(!this.items[i].disabled&&this.items[i].html){var item_text=this.items[i].html.replace(/<.*?>/g,'');item_text=item_text.replace(/&nbsp;/g,'');if(item_text.match(re)){this.select_item(i);break;}}}
var me=this;this.match_buffer_timeout=setTimeout(function(){me.match_buffer=''},1000);return true;}
return false;},on_keypress:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:this.key_up_down(true);break;case Ext.EventObject.DOWN:this.key_up_down(false);break;}},select_item:function(index)
{var item_doms=this.menu_ext_elem.query('.sg_menu_all_items');if(item_doms.length==0)
return;var selected;for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.hasClass('sg_menu_item_focus'))
{item_ext.removeClass('sg_menu_item_focus');}
if(item_doms[i].getAttribute('sg_menu_item_id')==index)
selected=item_doms[i];}
if(!selected)
return;this.menu_ext_elem.addClass('no_mouseover_highlight');Ext.fly(selected).addClass('sg_menu_item_focus');this.keyboard_item_focus=true;this.scroll_to_item(this.item_hash[selected.getAttribute('sg_menu_item_id')]);if(Ext.fly(selected).hasClass('sg_menu_submenu_item'))
{var item_id=selected.getAttribute("sg_menu_item_id");var item=this.item_hash[item_id];if(!item.disabled)
{this.display_submenu(selected,item);this.focus();}}
else
this.hide_current_submenu();},key_up_down:function(up)
{this.menu_ext_elem.addClass('no_mouseover_highlight');var item_doms=this.menu_ext_elem.query('.sg_menu_all_items');if(item_doms.length==0)
return;var selected_index=-1;var selected=null;if(this.last_hovered!=null)
{for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.dom.getAttribute('sg_menu_item_id')==this.last_hovered)
{selected_index=i;}}
this.last_hovered=null;}
else
{for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.hasClass('sg_menu_item_focus'))
{selected_index=i;item_ext.removeClass('sg_menu_item_focus');}}}
if(up)
{selected_index=(selected_index>0)?selected_index-1:item_doms.length-1;selected=item_doms[selected_index];while(selected&&Ext.fly(selected).hasClass('sg_menu_item_disabled'))
{selected_index-=1;if(selected_index<0)
selected=null;selected=item_doms[selected_index];}}
else
{selected_index=(selected_index+1<item_doms.length)?selected_index+1:0;selected=item_doms[selected_index];while(selected&&Ext.fly(selected).hasClass('sg_menu_item_disabled'))
{selected_index+=1;if(selected_index>=item_doms.length)
selected=null;selected=item_doms[selected_index];}}
if(selected)
{Ext.fly(selected).addClass('sg_menu_item_focus');this.keyboard_item_focus=true;this.scroll_to_item(this.item_hash[selected.getAttribute('sg_menu_item_id')]);if(Ext.fly(selected).hasClass('sg_menu_submenu_item'))
{var item_id=selected.getAttribute("sg_menu_item_id");var item=this.item_hash[item_id];if(!item.disabled)
{this.display_submenu(selected,item);this.focus();}}
else
this.hide_current_submenu();}
else
{this.clear_keyboard_focus()}},on_return_key:function()
{if(!this.keyboard_item_focus&&!this.non_volatile)
{this.__hide();return;}
var item_doms=this.menu_ext_elem.query('.sg_menu_item');if(item_doms.length==0)
return;var selected=null;for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.hasClass('sg_menu_item_focus'))
{selected=item_ext.dom;item_ext.removeClass('sg_menu_item_focus');}}
this.keyboard_item_focus=false;if(selected!=null)
{var item_id=selected.getAttribute("sg_menu_item_id");var item_hash=this.item_hash[item_id];if(!item_hash.disabled)
this.handle_item_selected(item_hash,selected);}},on_menu_mousemove:function(e)
{this.menu_ext_elem.removeClass('no_mouseover_highlight');var target=Ext.get(e.getTarget());var item_dom=target.findParent('div.sg_menu_all_items',this.menu_ext_elem);if(item_dom)
{var menu_item_id=item_dom.getAttribute('sg_menu_item_id');var item_el=Ext.get(item_dom);if(!item_el.hasClass('sg_menu_item_disabled')){this.last_hovered=menu_item_id;this.update_submenu_hide_show_timer(item_dom,menu_item_id);}}
if(!this.keyboard_item_focus)
return;this.clear_keyboard_focus();},clear_keyboard_focus:function()
{var item_doms=this.get_all_item_doms();for(var i=0;i<item_doms.length;i++)
{Ext.fly(item_doms[i]).removeClass('sg_menu_item_focus');}
this.keyboard_item_focus=false;this.hide_current_submenu();},get_all_item_doms:function()
{return this.menu_ext_elem.query('.sg_menu_all_items');},on_menu_click:function(e)
{if(e.type=='contextmenu')
e.stopEvent();if(this.skip_handle_item_selected)return;var target_dom=e.getTarget();var item_dom=Ext.get(target_dom).findParent('div.sg_menu_item',this.menu_ext_elem);if(item_dom)
{var item_id=item_dom.getAttribute("sg_menu_item_id");var item_hash=this.item_hash[item_id];if(!item_hash.disabled)
this.handle_item_selected(item_hash,target_dom);}},on_page_click:function(e)
{if(e.ctrlKey)return;var target_dom=e.getTarget();var ext_elem=Ext.get(target_dom);var click_obj=(ext_elem.is('.sg_menu')?ext_elem:ext_elem.findParent(".sg_menu",this.menu_ext_item));if(click_obj)
{}
else
{this.cancel();}},update_submenu_hide_show_timer:function(item_dom,menu_item_id){if(this.current_submenu_item_id===menu_item_id){this.remove_submenu_hide_show_timer();return;}
var item=this.item_hash[menu_item_id];if(item.submenu)
this.waiting_submenu={item:item,item_dom:item_dom,item_id:menu_item_id};else
this.waiting_submenu=null;if(this.submenu_hide_show_timer)
return;this.menu_ext_elem.addClass('dont_highlight_showing_submenu_items');var me=this;this.submenu_hide_show_timer=setTimeout(function(){me.submenu_hide_show_timer=null;me.menu_ext_elem.removeClass('dont_highlight_showing_submenu_items');if(me.waiting_submenu&&(me.current_submenu_item_id===me.waiting_submenu.item_id)){me.waiting_submenu=null;return;}
me.hide_current_submenu();if(me.waiting_submenu&&me.root_menu.is_showing()){me.display_submenu(me.waiting_submenu.item_dom,me.waiting_submenu.item);me.waiting_submenu=null;me.add_event(me.current_submenu_item_showing.submenu_instance.menu_ext_elem.dom,"mouseover",me.on_submenu_mouseover);}},this.SUBMENU_MOUSEOVER_ALLOWANCE_TIME);},remove_submenu_hide_show_timer:function(){if(this.submenu_hide_show_timer){clearTimeout(this.submenu_hide_show_timer);this.submenu_hide_show_timer=null;this.menu_ext_elem.removeClass('dont_highlight_showing_submenu_items');}},on_submenu_mouseover:function(){this.remove_submenu_hide_show_timer();},on_scroll_mouseover:function(e,thing,direction)
{if(!this.scroller_id)
this.start_scroll(direction);this.hide_current_submenu();},on_scroll_mouseout:function(e,thing,direction)
{this.scroll_slow_to_a_stop=true;},start_scroll:function(direction)
{this.counter=0;this.stop_scroll();this.scroll_direction=direction;this.scroll_slow_to_a_stop=false;this.scroll_speed=2;var menu=this;this.scroller_id=setInterval(function(){menu.scroll(menu);},this.MENU_SCROLL_TIME_INTERVAL);Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');},stop_scroll:function()
{if(this.scroller_id)
{clearInterval(this.scroller_id);this.scroller_id=null;this.scroll_direction=null;this.scroll_speed=null;}},ITEM_HEIGHT:13,scroll_to_item:function(item)
{var body=this.menu_ext_elem.dom.childNodes[1];var item_html=sg_find('div[sg_menu_item_id="'+this.items.indexOf(item)+'"]',body);var window_top=body.scrollTop+this.BODY_SCROLL_MARGIN;var item_top=item_html.offsetTop;if(item_top<window_top)
{var ideal_top=item_top-this.BODY_SCROLL_MARGIN;if(ideal_top<0||ideal_top<this.ITEM_HEIGHT)
{ideal_top=0;Ext.get(this.menu_ext_elem.dom.childNodes[0]).addClass('scrolled_all_the_way');}
else
Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');body.scrollTop=ideal_top;Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');return;}
var window_bottom=body.scrollTop+this.BODY_SCROLL_MARGIN+body.offsetHeight;var item_bottom=item_html.offsetTop+this.ITEM_HEIGHT;if(item_bottom>window_bottom)
{var ideal_top=item_html.offsetTop+this.ITEM_HEIGHT-this.BODY_SCROLL_MARGIN-body.offsetHeight;var distance_to_end=body.scrollHeight-(ideal_top+body.offsetHeight);if(ideal_top<0)
{ideal_top=0;}
else if(distance_to_end<this.ITEM_HEIGHT)
{ideal_top+=distance_to_end;Ext.get(this.menu_ext_elem.dom.childNodes[2]).addClass('scrolled_all_the_way');}
else
{Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');}
body.scrollTop=ideal_top;Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');}},scroll:function(menu)
{var body=menu.menu_ext_elem.dom.childNodes[1];var distance_to_end;if(menu.scroll_direction=='up')
{distance_to_end=body.scrollTop;if(distance_to_end>0)
body.scrollTop-=menu.scroll_speed;else
{menu.stop_scroll();Ext.get(this.menu_ext_elem.dom.childNodes[0]).addClass('scrolled_all_the_way');}}
else if(menu.scroll_direction=='down')
{distance_to_end=body.scrollHeight-(body.scrollTop+body.offsetHeight);if(distance_to_end>0)
body.scrollTop+=menu.scroll_speed;else
{menu.stop_scroll();Ext.get(this.menu_ext_elem.dom.childNodes[2]).addClass('scrolled_all_the_way');}}
else
{console.log("Scroll race condition!!!!!!!!!!!!!");menu.stop_scroll();}
if(menu.scroll_slow_to_a_stop)
{if(menu.scroll_speed<5)
menu.stop_scroll();else
menu.scroll_speed-=3;}
else if((distance_to_end<menu.MENU_SCROLL_PIXEL_JUMP*6)&&(menu.scroll_speed>4))
menu.scroll_speed--;else if(menu.scroll_speed<menu.MENU_SCROLL_PIXEL_JUMP)
menu.scroll_speed++;}});SG.Menu.DropDown=function(config)
{Ext.apply(this,config);SG.Menu.DropDown.superclass.constructor.call(this);};Ext.extend(SG.Menu.DropDown,SG.Component,{templates:{dropdown_body:'<div class="sg_menu_dropdown {extra_class}">'+'<span class="sg_menu_dropdown_content">{content}</span>{dropdown_arrow}</div>',dropdown_arrow:'<div class="sg_menu_dropdown_arrow dropdown_arrow_small">&nbsp;</div>'},init_component:function()
{if(typeof this.container=='string')
this.container=Ext.get(this.container);if(this.container.dom)
this.container=this.container.dom;this.menu_enabled=true;},render:function()
{var extra_class=this.extra_class?this.extra_class:'';var html;if(this.read_only)
html=this.templates['dropdown_body'].apply({content:this.content,extra_class:'sg_menu_dropdown_readonly '+extra_class,dropdown_arrow:''});else
html=this.templates['dropdown_body'].apply({content:this.content,extra_class:extra_class,dropdown_arrow:this.templates['dropdown_arrow'].apply({})});this.container.innerHTML=html;var body=this.container.firstChild;if(!this.read_only)
this.add_event(body,'click',this.on_dropdown_click,this);},on_dropdown_click:function(e)
{if(!this.menu_enabled)
return;var body=Ext.get(this.container.firstChild);if(body.hasClass('menu_showing'))
{body.removeClass('menu_showing');return;}
body.addClass('menu_showing');this.menu.position={dom_elem:body,elem_anchor:'bl',menu_anchor:'tl'};if(this.extra_onclick)
this.extra_onclick.fn.call(this.extra_onclick.scope,this,this.menu);this.menu.show();this.add_event(this.menu,'after_hide',this.on_menu_hide,this);},on_menu_hide:function(menu)
{this.remove_event(this.menu,'after_hide',this.on_menu_hide,this);var body=Ext.get(this.container.firstChild);body.removeClass('menu_showing');},set_content:function(content)
{this.content=content;this.container.firstChild.firstChild.innerHTML=content;}});SG.Menu.show_test_menu=function(owner_widget,anchor_dom_elem)
{if(!owner_widget.test_sg_menu)
{var items=[];items.push({html:'First Thing',value:'first_thing'});for(var i=1;i<=30;i++)
items.push({html:'Thing '+i,value:'thing_'+i});items.push({html:'Last Thing',value:'last_thing'});owner_widget.test_sg_menu=new SG.Menu({position:{dom_elem:anchor_dom_elem,elem_anchor:"bl",menu_anchor:"tl"},item_selected:{fn:function(menu,item){console.log("selected!!!!"+item.html);},scope:this},items:[{heading:"BIG FAT MENU TEST MENU!"},{html:"Okay",value:"okay"},{html:"Not Okay",value:"bad",disabled:true},{html:"Empty Submenu",submenu:{items:[]}},{line:true},{html:"Other Stuff",submenu:{items:[{html:'The <span style="color:blue">inner</span> you.',value:'deep html',icon_name:'dropdown_arrow_small'},{html:'Special',value:'special',checked:true,icon_name:'trash'},{html:'Other <span style="color:red">Special</span> Stuff',icon_name:'icon_edit',submenu:{items:[{html:"Other Stuff",submenu:{items:[{heading:"First Section"},{html:'Special',value:'special',checked:true,disabled:true},{heading:"Next Section"},{html:'The <span style="color:blue">rain'+'<span style="color:orange">bow</span><span style="color:pink"> pony</span></span>.',submenu:{icon_width:5,items:[{html:'Special',value:'special',icon_name:'trash'},{html:"Other Stuff",icon_name:'icon_edit',submenu:{items:[{heading:'First'},{html:'Special',value:'special'},{html:"Other Stuff",submenu:{items:[{html:"Other Stuff",submenu:{items:[{html:'A Somewhat Wider than Usual Menu Item',value:'special'},{html:"Other Stuff",submenu:{items:[{html:'A Really Wide Menu Item: na nananananananananannanannannanana',value:'special'},{html:"Other Stuff",submenu:{icon_width:30,items:[{html:'Wide Icon Width',value:'special',icon_name:'icon_edit'},{html:"Other Stuff",submenu:{items:[{html:"Other Stuff",submenu:{items:[{html:'Special',value:'special'},{html:"Other Stuff",submenu:{items:[{html:'Special',value:'special'},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Special',value:'special'},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Special',value:'special'},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{heading:"Next"},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Special',value:'special',checked:true},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:'Ordinary',value:'ordinary'},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]}},{html:"Long Submenu",submenu:{items:sg_deep_copy(items)}}]});owner_widget.test_sg_menu.render();}
owner_widget.test_sg_menu.show();}
SG.ListBox=function(config)
{Ext.apply(this,config);SG.ListBox.superclass.constructor.call(this);};Ext.extend(SG.ListBox,SG.Component,{templates:{menu:'<div class="sg_menu sg_menu_hidden sg_menu_no_scroll sg_focusable {extra_classes} {custom_menu_class}"'+'id="{menu_id}" tabindex="-1">'+'<div class="sg_menu_top_scroll scrolled_all_the_way"><div class="scroll_up">&nbsp;</div></div>'+'<div class="sg_menu_body">{items}<div class="sg_menu_item_bottom_spacer"></div></div>'+'<div class="sg_menu_bottom_scroll"><div class="scroll_down">&nbsp;</div></div>'+'</div>',section_heading:'<div class="sg_menu_heading">{heading_content}</div>',item:'<div class="sg_menu_item sg_menu_all_items {extra_class} {custom_item_class}" '+'sg_menu_item_id="{item_id}">'+'{checkmark}'+'{icon_html}'+'<span class="sg_menu_item_content">{item_content}</span>'+'</div>',divider:'<hr/>',no_items:'<div class="sg_menu_no_items">No menu items</div>',icon:'<div class="sg_menu_icon {container_class}" {container_style}>'+'<div class="sg_menu_icon_image_div {image_class}" {img_style}>&nbsp;</div></div>'},MENU_SCROLL_TIME_INTERVAL:10,MENU_SCROLL_PIXEL_JUMP:5,VIEWPORT_MARGIN:10,BODY_SCROLL_MARGIN:17,autocomplete_request_id:0,init_component:function(config)
{if(!this.id)
this.id="sg_menu_"+(++SG.Menu.last_id);if(!this.items)
this.items=[];if(!this.render_container)
this.render_container=document.body;if(!this.display_container)
this.display_container=this.render_container;if(!this.icon_width)
this.icon_width=15;this.events={before_first_render:true,before_render:true,before_show:true,item_selected:true,canceled:true,after_hide:true}
for(var event_name in this.events)
{if(!this.events.hasOwnProperty(event_name))
continue;if(this[event_name])
{this.on(event_name,this[event_name].fn,this[event_name].scope);delete this[event_name];}}
if(this.autocomplete)
this.setup_autocomplete();else if(this.matching)
this.setup_matching();this.last_hovered=null;},is_rendered:function()
{return(this.menu_ext_elem!=null&&typeof this.menu_ext_elem!='undefined');},contains_elem:function(ext_or_dom)
{if(!this.menu_ext_elem)
return false;var ext_elem=Ext.get(ext_or_dom);if(ext_elem==this.menu_ext_elem||ext_elem.up(this.menu_ext_elem,7))
return true;return false;},render:function()
{var old_menu=null;if(!this.menu_ext_elem)
this.fireEvent("before_first_render",this);else
old_menu=this.menu_ext_elem.dom;this.fireEvent("before_render",this);this.item_hash={};var items=this.render_menu_items();var extra_classes=(this.checked_count==0?'no_checked ':'')+(this.icon_count==0?'no_icons':'');this.menu_ext_elem=this.templates['menu'].append(this.render_container,{menu_id:this.id,items:items,extra_classes:extra_classes,custom_menu_class:this.menu_class?this.menu_class:''},true);if(this.keyboard_item_focus)
this.menu_ext_elem.addClass('no_mouseover_highlight');if(old_menu)
old_menu.parentNode.removeChild(old_menu);},render_menu_items:function()
{var menu_items=[];var item;var template;this.checked_count=0;this.icon_count=0;for(var i=0;i<this.items.length;i++)
{item=this.items[i];if(item.line||(item.heading&&i!=0))
menu_items.push(this.templates['divider'].apply({}));if(item.heading)
{menu_items.push(this.templates['section_heading'].apply({heading_content:item.heading}));this.checked_count++;}
if(item.html)
{if(item.checked)
this.checked_count++;if(item.icon_name||item.icon_bg_color)
this.icon_count++;var extra_classes='';if(item.disabled)
extra_classes+='sg_menu_item_disabled ';if(item.default_item)
{extra_classes+='sg_menu_item_focus ';this.keyboard_item_focus=true;}
menu_items.push(this.templates['item'].apply({item_content:item.highlighted_html?item.highlighted_html:item.html,item_id:i,extra_class:extra_classes,checkmark:this.render_icon('sg_menu_item_checkmark',(item.checked?'checkmark':'blank')),custom_item_class:item.item_class?item.item_class:'',icon_html:this.render_icon('',(item.icon_name?item.icon_name:'blank'),true,item.icon_bg_color)}));this.item_hash[""+i]=item;}}
if(menu_items.length>0)
return menu_items.join("");else
return this.templates.no_items.apply({});},render_icon:function(container_class,icon_name,limit_size,icon_background_color)
{if(limit_size)
{var container_style='width:'+this.icon_width+'px;';var img_style='max-width:'+this.icon_width+'px;';if(this.icon_height)
{container_style+='height:'+this.icon_height+'px;';img_style+='max-height:'+this.icon_height+'px;';}
if(icon_background_color)
img_style+='background-color: rgb('+icon_background_color+');';container_style='style="'+container_style+'"';img_style='style="'+img_style+'"';}
return this.templates['icon'].apply({container_class:container_class,image_class:(icon_name?icon_name:'blank'),container_style:limit_size?container_style:'',img_style:limit_size?img_style:''});},show:function()
{this.fireEvent("before_show",this);if(!this.menu_ext_elem)
throw("SG.ListBox: No menu html element for listbox. Call render() before show()!");this.menu_ext_elem.setTop(-10000);this.menu_ext_elem.addClass("sg_menu_invisible");this.menu_ext_elem.removeClass("sg_menu_hidden");this.size_for_viewport();if(this.position.xy)
{this.menu_ext_elem.setXY(this.position.xy);this.menu_ext_elem.alignTo(this.menu_ext_elem.dom,"tl-tl?");}
else if(this.position.minimum_height)
{this.apply_minimum_height_positioning();}
else if(this.position.no_cover)
{this.apply_no_cover_positioning();}
else
{var elem_anchor=this.position.elem_anchor||'bl';var menu_anchor=this.position.menu_anchor||'tl';this.menu_ext_elem.alignTo(this.position.dom_elem,menu_anchor+"-"+elem_anchor+"?");}
this.apply_cover_rule();this.menu_ext_elem.removeClass("sg_menu_invisible");if(!this.shadow)
this.shadow=new Ext.Shadow({mode:'sides'});this.shadow.show(this.menu_ext_elem);this.remove_listeners();this.add_listeners();},add_listeners:function()
{this.add_event(this.menu_ext_elem.dom,"click",this.on_menu_click);this.add_event(this.menu_ext_elem.dom,"mousemove",this.on_menu_mousemove);this.add_event(this.menu_ext_elem.dom,"mousedown",this.on_menu_mousedown);this.menu_mousedown=false;this.add_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseover,this,"up");this.add_event(this.menu_ext_elem.dom.childNodes[0],"mouseout",this.on_scroll_mouseout,this,"up");this.add_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseover,this,"down");this.add_event(this.menu_ext_elem.dom.childNodes[2],"mouseout",this.on_scroll_mouseout,this,"down");},remove_listeners:function()
{this.remove_event(this.menu_ext_elem.dom,"click",this.on_menu_click);this.remove_event(this.menu_ext_elem.dom,"mousemove",this.on_menu_mousemove);this.remove_event(this.menu_ext_elem.dom,"mousedown",this.on_menu_mousedown);this.remove_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseover);this.remove_event(this.menu_ext_elem.dom.childNodes[0],"mouseover",this.on_scroll_mouseout);this.remove_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseover);this.remove_event(this.menu_ext_elem.dom.childNodes[2],"mouseover",this.on_scroll_mouseout);},hide:function()
{this.cancel();},cancel:function()
{this.fireEvent('canceled',this);this.__hide();},__hide:function()
{if(this.menu_ext_elem)
{this.stop_scroll();this.blur();this.remove_listeners();this.menu_ext_elem.addClass("sg_menu_hidden");this.menu_ext_elem.setStyle({"left":"","right":"","top":"","bottom":""});}
if(this.shadow)
this.shadow.hide();this.fireEvent('after_hide',this);},blur:function()
{if(this.menu_ext_elem)
this.menu_ext_elem.dom.blur();},size_for_viewport:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var max_height=viewport_height-(2*this.VIEWPORT_MARGIN);this.apply_height_and_scroll_rules(max_height);},apply_cover_rule:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var xy=this.menu_ext_elem.getXY();if(xy[1]<this.VIEWPORT_MARGIN)
{}
else
{if(xy[1]+this.menu_ext_elem.getHeight()>viewport_height-this.VIEWPORT_MARGIN)
{xy[1]=viewport_height-this.VIEWPORT_MARGIN-this.menu_ext_elem.getHeight();this.menu_ext_elem.setXY(xy);}}},apply_no_cover_positioning:function()
{this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");var viewport_height=Ext.lib.Dom.getViewHeight();var position_ext_elem=Ext.get(this.position.dom_elem);var position_elem_pos=position_ext_elem.getXY();var position_elem_height=position_ext_elem.getHeight();var elem_pos=this.menu_ext_elem.getXY();var elem_height=this.menu_ext_elem.getHeight();if(elem_pos[1]+elem_height>viewport_height-this.VIEWPORT_MARGIN)
{var space_below=(viewport_height-(2*this.VIEWPORT_MARGIN))-
(position_elem_pos[1]+position_elem_height);var space_above=position_elem_pos[1]-(2*this.VIEWPORT_MARGIN);if(space_below>=space_above)
{this.apply_height_and_scroll_rules(space_below);}
else
{this.apply_height_and_scroll_rules(space_above);}
this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");}},apply_minimum_height_positioning:function()
{var viewport_height=Ext.lib.Dom.getViewHeight();var position_ext_elem=Ext.get(this.position.dom_elem);var position_elem_pos=position_ext_elem.getXY();var position_elem_height=position_ext_elem.getHeight();var position='below';var space_below=(viewport_height-(2*this.VIEWPORT_MARGIN))-
(position_elem_pos[1]+position_elem_height);var space_above=position_elem_pos[1]-(2*this.VIEWPORT_MARGIN);if(space_below<this.position.minimum_height&&space_above>this.position.minimum_height)
position='above';else if(space_below<this.position.minimum_height)
position='not_enough_space';if(position=='below')
{this.apply_height_and_scroll_rules(space_below);this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");}
else if(position=='above')
{this.apply_height_and_scroll_rules(space_above);this.menu_ext_elem.alignTo(this.position.dom_elem,"bl-tl?");}
else
{this.menu_ext_elem.alignTo(this.position.dom_elem,"tl-bl?");var pos=this.menu_ext_elem.getXY();pos[1]=position_elem_pos[1]+position_elem_height;}},apply_height_and_scroll_rules:function(max_height)
{var menu_height=this.menu_ext_elem.getHeight();var menu_body=this.menu_ext_elem.dom.childNodes[1];var menu_body_height=menu_body.offsetHeight;if(this.max_height&&this.max_height<max_height)
max_height=this.max_height;if(this.menu_ext_elem.hasClass('sg_menu_scroll'))
{if(menu_height<(max_height-50)||menu_height>max_height)
{this.menu_ext_elem.addClass('sg_menu_no_scroll');this.menu_ext_elem.removeClass('sg_menu_scroll');menu_body.style.height=null}}
if(this.menu_ext_elem.hasClass('sg_menu_no_scroll'))
{if(menu_height>max_height)
{this.menu_ext_elem.removeClass('sg_menu_no_scroll');this.menu_ext_elem.addClass('sg_menu_scroll');menu_body.style.height=(max_height-(2*this.BODY_SCROLL_MARGIN))+'px';}}},destroy_component:function()
{this.__hide();if(this.menu_ext_elem)
this.menu_ext_elem.remove();delete this.items;delete this.render_container;delete this.display_container;delete this.menu_ext_elem;delete this.shadow;this.purgeListeners();if(this.autocomplete)
this.teardown_autocomplete();else if(this.matching)
this.teardown_matching();},handle_item_selected:function(item_hash,target_dom)
{if(this.autocomplete)
{this.autocomplete_selected(item_hash);return;}
else if(this.matching)
{this.matching_selected(item_hash);return;}
if(item_hash.item_selected)
{this.__hide();var menu=this;setTimeout(function(){item_hash.item_selected.fn.call(item_hash.item_selected.scope,menu,item_hash,target_dom);},0);}
else
{this.__hide();this.fireEvent("item_selected",this,item_hash,target_dom);}},key_up_down:function(up)
{if(!this.menu_ext_elem)return;this.menu_ext_elem.addClass('no_mouseover_highlight');var item_doms=this.menu_ext_elem.query('.sg_menu_item');if(item_doms.length==0)
return;var selected_index=-1;var selected=null;if(this.last_hovered!=null)
{for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.dom.getAttribute('sg_menu_item_id')==this.last_hovered)
{selected_index=i;}}
this.last_hovered=null;}
else
{for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.hasClass('sg_menu_item_focus'))
{selected_index=i;item_ext.removeClass('sg_menu_item_focus');}}}
if(up)
{selected_index=(selected_index>0)?selected_index-1:item_doms.length-1;selected=item_doms[selected_index];while(selected&&Ext.fly(selected).hasClass('sg_menu_item_disabled'))
{selected_index-=1;if(selected_index<0)
selected=null;selected=item_doms[selected_index];}}
else
{selected_index=(selected_index+1<item_doms.length)?selected_index+1:0;selected=item_doms[selected_index];while(selected&&Ext.fly(selected).hasClass('sg_menu_item_disabled'))
{selected_index+=1;if(selected_index>=item_doms.length)
selected=null;selected=item_doms[selected_index];}}
if(selected)
{Ext.fly(selected).addClass('sg_menu_item_focus');this.keyboard_item_focus=true;this.scroll_to_item(this.item_hash[selected.getAttribute('sg_menu_item_id')]);}
else
this.keyboard_item_focus=false;},on_return_key:function()
{if(!this.keyboard_item_focus)
{this.__hide();return;}
var selected=this.find_selected();if(selected)
this.handle_item_selected(item_hash,selected);},find_selected:function(skip_deselection)
{var item_doms=this.menu_ext_elem.query('.sg_menu_item');if(item_doms.length==0)
return;var selected=null;for(var i=0;i<item_doms.length;i++)
{var item_ext=Ext.get(item_doms[i]);if(item_ext.hasClass('sg_menu_item_focus'))
{selected=item_ext.dom;if(!skip_deselection)
item_ext.removeClass('sg_menu_item_focus');}}
if(!skip_deselection)
this.keyboard_item_focus=false;if(selected)
{var item_id=selected.getAttribute("sg_menu_item_id");var item_hash=this.item_hash[item_id];if(!item_hash.disabled)
return item_hash;}
return null;},on_menu_mousemove:function(e)
{this.menu_ext_elem.removeClass('no_mouseover_highlight');var target=Ext.get(e.getTarget());var item_dom=target.findParent('div.sg_menu_all_items',this.menu_ext_elem);if(item_dom)
{var item_el=Ext.get(item_dom);if(!item_el.hasClass('sg_menu_item_disabled'))
this.last_hovered=item_dom.getAttribute('sg_menu_item_id');}
if(!this.keyboard_item_focus)
return;this.clear_keyboard_focus();},on_menu_mousedown:function(e)
{this.menu_mousedown=true;},clear_keyboard_focus:function()
{var item_doms=this.get_all_item_doms();for(var i=0;i<item_doms.length;i++)
{Ext.fly(item_doms[i]).removeClass('sg_menu_item_focus');}
this.keyboard_item_focus=false;},get_all_item_doms:function()
{return this.menu_ext_elem.query('.sg_menu_all_items');},on_menu_click:function(e)
{var target_dom=e.getTarget();var item_dom=Ext.get(target_dom).findParent('div.sg_menu_item',this.menu_ext_elem);if(item_dom)
{var item_id=item_dom.getAttribute("sg_menu_item_id");var item_hash=this.item_hash[item_id];if(!item_hash.disabled)
this.handle_item_selected(item_hash,target_dom);}},on_page_click:function(e)
{if(e.ctrlKey)return;var target_dom=e.getTarget();var ext_elem=Ext.get(target_dom);var click_obj=(ext_elem.is('.sg_menu')?ext_elem:ext_elem.findParent(".sg_menu",this.menu_ext_item));if(click_obj)
{}
else
{this.cancel();}},on_scroll_mouseover:function(e,thing,direction)
{if(!this.scroller_id)
this.start_scroll(direction);},on_scroll_mouseout:function(e,thing,direction)
{this.scroll_slow_to_a_stop=true;},start_scroll:function(direction)
{this.counter=0;this.stop_scroll();this.scroll_direction=direction;this.scroll_slow_to_a_stop=false;this.scroll_speed=2;var menu=this;this.scroller_id=setInterval(function(){menu.scroll(menu);},this.MENU_SCROLL_TIME_INTERVAL);Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');},stop_scroll:function()
{if(this.scroller_id)
{clearInterval(this.scroller_id);this.scroller_id=null;this.scroll_direction=null;this.scroll_speed=null;}},ITEM_HEIGHT:13,scroll_to_item:function(item)
{var body=this.menu_ext_elem.dom.childNodes[1];var item_html=sg_find('div[sg_menu_item_id="'+this.items.indexOf(item)+'"]',body);var window_top=body.scrollTop+this.BODY_SCROLL_MARGIN;var item_top=item_html.offsetTop;if(item_top<window_top)
{var ideal_top=item_top-this.BODY_SCROLL_MARGIN;if(ideal_top<0||ideal_top<this.ITEM_HEIGHT)
{ideal_top=0;Ext.get(this.menu_ext_elem.dom.childNodes[0]).addClass('scrolled_all_the_way');}
else
Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');body.scrollTop=ideal_top;Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');return;}
var window_bottom=body.scrollTop+this.BODY_SCROLL_MARGIN+body.offsetHeight;var item_bottom=item_html.offsetTop+this.ITEM_HEIGHT;if(item_bottom>window_bottom)
{var ideal_top=item_html.offsetTop+this.ITEM_HEIGHT-this.BODY_SCROLL_MARGIN-body.offsetHeight;var distance_to_end=body.scrollHeight-(ideal_top+body.offsetHeight);if(ideal_top<0)
{ideal_top=0;}
else if(distance_to_end<this.ITEM_HEIGHT)
{ideal_top+=distance_to_end;Ext.get(this.menu_ext_elem.dom.childNodes[2]).addClass('scrolled_all_the_way');}
else
{Ext.get(this.menu_ext_elem.dom.childNodes[2]).removeClass('scrolled_all_the_way');}
body.scrollTop=ideal_top;Ext.get(this.menu_ext_elem.dom.childNodes[0]).removeClass('scrolled_all_the_way');}},scroll:function(menu)
{var body=menu.menu_ext_elem.dom.childNodes[1];var distance_to_end;if(menu.scroll_direction=='up')
{distance_to_end=body.scrollTop;if(distance_to_end>0)
body.scrollTop-=menu.scroll_speed;else
{menu.stop_scroll();Ext.get(this.menu_ext_elem.dom.childNodes[0]).addClass('scrolled_all_the_way');}}
else if(menu.scroll_direction=='down')
{distance_to_end=body.scrollHeight-(body.scrollTop+body.offsetHeight);if(distance_to_end>0)
body.scrollTop+=menu.scroll_speed;else
{menu.stop_scroll();Ext.get(this.menu_ext_elem.dom.childNodes[2]).addClass('scrolled_all_the_way');}}
else
{console.log("Scroll race condition!!!!!!!!!!!!!");menu.stop_scroll();}
if(menu.scroll_slow_to_a_stop)
{if(menu.scroll_speed<5)
menu.stop_scroll();else
menu.scroll_speed-=3;}
else if((distance_to_end<menu.MENU_SCROLL_PIXEL_JUMP*6)&&(menu.scroll_speed>4))
menu.scroll_speed--;else if(menu.scroll_speed<menu.MENU_SCROLL_PIXEL_JUMP)
menu.scroll_speed++;},setup_autocomplete:function()
{var input_el=Ext.get(this.autocomplete.input_dom);input_el.on("keydown",this.autocomplete_keydown,this);if(this.autocomplete.close_on_blur)
input_el.on("blur",this.autocomplete_blur,this);input_el.on("focus",this.autocomplete_focus,this);if(typeof this.autocomplete.minimum_query_text_length=='undefined')
this.autocomplete.minimum_query_text_length=1;if(Ext.isGecko)
input_el.on("keypress",this.autocomplete_keypress,this)},teardown_autocomplete:function()
{var input_el=Ext.get(this.autocomplete.input_dom);input_el.un("keydown",this.autocomplete_keydown,this);input_el.un("blur",this.autocomplete_blur,this);input_el.un("focus",this.autocomplete_focus,this);if(Ext.isGecko)
input_el.un("keypress",this.autocomplete_keypress,this)},autocomplete_keydown:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:if(!Ext.isGecko)
this.key_up_down(true);break;case Ext.EventObject.DOWN:if(!Ext.isGecko)
this.key_up_down(false);break;case Ext.EventObject.TAB:case Ext.EventObject.RETURN:var currently_selected=this.find_selected();if(currently_selected)
{this.autocomplete_selected(currently_selected);e.preventDefault();}
break;case Ext.EventObject.ESC:this.hide();break;default:if(this.autocomplete_canceled){this.autocomplete_canceled=false;this.hide();return;}
var me=this;setTimeout(function(){me.autocomplete_delayed_request()},0);}},autocomplete_keypress:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:this.key_up_down(true);break;case Ext.EventObject.DOWN:this.key_up_down(false);break;}},autocomplete_selected:function(selected_item)
{if(selected_item.item_selected)
{var menu=this;setTimeout(function(){selected_item.item_selected.fn.call(selected_item.item_selected.scope,menu,selected_item);},0);return;}
if(this.autocomplete.selection_callback)
this.autocomplete.selection_callback.fn.call(this.autocomplete.selection_callback.scope,selected_item);else
{var me=this;setTimeout(function(){if(me.autocomplete.multivalued_separator)
{var parts=me.autocomplete.input_dom.value.split(me.autocomplete.multivalued_separator);parts[parts.length-1]=selected_item.value;me.autocomplete.input_dom.value=parts.join(me.autocomplete.multivalued_separator+" ")+
me.autocomplete.multivalued_separator+" ";}
else
me.autocomplete.input_dom.value=selected_item.value;},0);}
this.hide();},autocomplete_blur:function(e)
{if(!this.menu_mousedown)
{var me=this;setTimeout(function(){me.hide();},0);}
this.menu_mousedown=false;},autocomplete_focus:function(e)
{if(!this.disable_autocomplete_focus){var me=this;setTimeout(function(){me.show();},200);}},autocomplete_delayed_request:function(){if(this.delayed_request_timeout)
clearTimeout(this.delayed_request_timeout);if(this.autocomplete_canceled){this.autocomplete_canceled=false;this.hide();return;}
var search_value=this.autocomplete.input_dom.value;var delay=search_value.length===1?300:search_value.length===2?200:100;var me=this;this.delayed_request_timeout=setTimeout(function(){me.autocomplete_request();},delay);},autocomplete_request:function()
{if(this.autocomplete_canceled){this.autocomplete_canceled=false;this.hide();return;}
var search_value=this.autocomplete.input_dom.value;if(this.autocomplete.multivalued_separator)
search_value=search_value.split(this.autocomplete.multivalued_separator).pop().strip();if(search_value.length<this.autocomplete.minimum_query_text_length)
{if(this.autocomplete.prompt_menu_items_callback)
{var cb=this.autocomplete.prompt_menu_items_callback;this.items=cb.fn.call(cb.scope);this.render();this.show();}
else if(this.autocomplete.prompt_html)
{this.items=[{disabled:true,html:this.autocomplete.prompt_html}];this.render();this.show();}
else
this.hide();return;}
if(this.autocomplete.waiting_menu_items_callback){var cb=this.autocomplete.waiting_menu_items_callback;this.items=cb.fn.call(cb.scope);this.render();this.show();}
var request_id=++this.autocomplete_request_id;var params=this.autocomplete.parameters_callback.fn.call(this.autocomplete.parameters_callback.scope,search_value);var options={url:this.autocomplete.request_url,params:params,callback:function(options,success,response){if(this.autocomplete_canceled){this.autocomplete_canceled=false;this.hide();return;}
if(success){if(request_id<this.autocomplete_request_id){return;}
response=Ext.decode(response.responseText);this.items=this.autocomplete.response_callback.fn.call(this.autocomplete.response_callback.scope,response);if(this.items.length==0)
this.items.push({disabled:true,html:"No matches found."});else
this.items[0].default_item=true;this.render();this.show();}
else
{this.items=[{disabled:true,html:"System error - unable to find matches."}];this.render();this.show();}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},cancel_autocomplete:function(){this.autocomplete_canceled=true;this.hide();var me=this;setTimeout(function(){me.autocomplete_canceled=false;},350);},setup_matching:function()
{var input_el=Ext.get(this.matching.input_dom);input_el.on("keydown",this.matching_keydown,this);if(this.matching.close_on_blur)
input_el.on("blur",this.matching_blur,this);input_el.on("focus",this.matching_focus,this);if(Ext.isGecko)
input_el.on("keypress",this.matching_keypress,this)},teardown_matching:function()
{var input_el=Ext.get(this.matching.input_dom);input_el.un("keydown",this.matching_keydown,this);input_el.un("blur",this.matching_blur,this);input_el.un("focus",this.matching_focus,this);if(Ext.isGecko)
input_el.un("keypress",this.matching_keypress,this)},matching_keydown:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:if(!Ext.isGecko)
this.key_up_down(true);break;case Ext.EventObject.DOWN:if(!Ext.isGecko)
this.key_up_down(false);break;case Ext.EventObject.TAB:case Ext.EventObject.RETURN:var currently_selected=this.find_selected();if(currently_selected)
{this.matching_selected(currently_selected);e.preventDefault();e.stopEvent();}
break;case Ext.EventObject.ESC:break;default:var me=this;setTimeout(function(){me.match_text()},0);}},matching_keypress:function(e)
{var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:this.key_up_down(true);break;case Ext.EventObject.DOWN:this.key_up_down(false);break;}},matching_selected:function(selected_item)
{if(selected_item.item_selected)
{var menu=this;setTimeout(function(){selected_item.item_selected.fn.call(selected_item.item_selected.scope,menu,selected_item);},0);return;}
if(this.matching.selection_callback)
this.matching.selection_callback.fn.call(this.matching.selection_callback.scope,selected_item);else
{var me=this;setTimeout(function(){if(me.matching.multivalued_separator)
{var parts=me.matching.input_dom.value.split(me.matching.multivalued_separator);parts[parts.length-1]=selected_item.value;me.matching.input_dom.value=parts.join(me.matching.multivalued_separator+" ")+
me.matching.multivalued_separator+" ";}
else
me.matching.input_dom.value=selected_item.value;},0);}
this.hide();},matching_blur:function(e)
{if(!this.menu_mousedown)
{var me=this;setTimeout(function(){me.hide();},0);}
this.menu_mousedown=false;},matching_focus:function(e)
{var me=this;setTimeout(function(){me.show();},200);},match_text:function()
{var selected=null;var search_value=this.matching.input_dom.value.toLowerCase();if(this.matching.multivalued_separator)
search_value=search_value.split(this.matching.multivalued_separator).pop().strip();if(search_value.length<1)
{for(var i=0;i<this.items.length;i++)
{delete this.items[i].default_item;delete this.items[i].highlighted_html;}
this.render();this.show();return;}
var rank=-1;var best_rank=null;var best_match=null;for(var i=0;i<this.items.length;i++)
{var item=this.items[i];delete item.highlighted_html;if(item.disabled||item.heading||item.line)
continue;if(this.matching.match_callback)
rank=this.matching.match_callback.fn.call(this.matching.match_callback.scope,search_value,item);else
rank=this.match_default_strategy(search_value,item);if(rank>=0)
{if(best_rank==null||rank<best_rank)
{best_rank=rank;best_match=i;}
if(this.matching.highlight_callback)
item.highlighted_html=this.matching.highlight_callback.fn.call(this.matching.highlight_callback.scope,search_value,item);else
item.highlighted_html=this.match_highlight_default_strategy(search_value,item);}}
if(best_match!==null)
selected=best_match;for(var i=0;i<this.items.length;i++)
{if(selected!==null)
this.items[i].default_item=(selected==i);}
this.render();this.show();if(selected!==null)
this.scroll_to_item(this.items[selected]);},match_default_strategy:function(search_text,item)
{return item.value.toLowerCase().indexOf(search_text);},match_highlight_default_strategy:function(search_text,item)
{return this.highlight_string(search_text,item.html);},highlight_string:function(search_text,str)
{var first_index=str.toLowerCase().indexOf(search_text);var end_index=first_index+search_text.length;if(first_index>-1)
return str.substring(0,first_index)+'<match>'+str.substring(first_index,end_index)+'</match>'+str.substring(end_index);else
return null;},});SG.SelectionManager=function(config)
{Ext.apply(this,config);SG.SelectionManager.superclass.constructor.call(this);};Ext.extend(SG.SelectionManager,SG.Component,{init_component:function()
{if(this.unsupported_entity_query_mode())
return;this.clear_selection_cache();this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'contextmenu',this.on_right_click);this.band_selector=Ext.DomHelper.append(document.body,{tag:'div',cls:'band_selector'},true);this.band_selector.setDisplayed(false);if(this.entity_query_mode)
this.vertical_selection=['thumb','report'].indexOf(this.entity_query_mode)==-1;this.construct_drag_selectors();this.in_drag=false;},destroy_drag_selectors:function()
{if(this.drag_selector)
this.drag_selector.destroy();},unsupported_entity_query_mode:function(){var unsupported=['version_card','grouped_notes'];if(this.entity_query_mode&&unsupported.indexOf(this.entity_query_mode)>0)
return true;else
return false;},construct_drag_selectors:function()
{if(this.entity_query_mode&&this.entity_query_mode=='calendar'||this.drag_selection_disabled)
return;if(this.entity_query_mode)
this.drag_selection_container=this.container.child('div.sg_scroll_container');var config={selection_manager:this,container:this.drag_selection_container,vertical_selection:this.vertical_selection,band_selector:this.band_selector,scroll:false,blur_callback:this.drag_selector_blur_callback};this.drag_selector=new SG.SelectionManager.DragSelector(config);},set_entity_query_mode:function(mode)
{this.entity_query_mode=mode;if(this.unsupported_entity_query_mode())
return;this.vertical_selection=mode!='thumb';this.construct_drag_selectors();},clear_selection_cache:function()
{this.record_id_cache={};this.selection_cache={};this.last_click=null;},fire_selection_callback:function()
{var record_ids=this.get_selected_record_ids();this.selection_callback.fn.call(this.selection_callback.scope,record_ids,this.in_drag);},get_selected_record_ids:function()
{var record_ids=[];var id;for(id in this.record_id_cache)
{if(this.record_id_cache.hasOwnProperty(id))
record_ids.push(Number(id));}
return record_ids;},get_selected_group_indexes:function()
{var group_indexes=[];var k;for(k in this.selection_cache)
{if(!this.selection_cache.hasOwnProperty(k))
continue;if(k.indexOf('_')==-1)
group_indexes.push(Number(k));}
return group_indexes;},in_selection_cache:function(group_idx,record_id)
{var key=this.cache_key(group_idx,record_id);if(group_idx!=-1&&record_id!=undefined)
{var g_key=this.cache_key(group_idx);return((this.selection_cache[key]==true)||(this.selection_cache[g_key]==true));}
else
return this.selection_cache[key]==true;},event_inside_entity_query_mode_widget:function(target)
{if(this.entity_query_mode){var content_widget_div=target.findParent('div.sgw_entity_query_mode',20);return content_widget_div;}
return true;},on_right_click:function(e)
{var target=Ext.get(e.getTarget());var parent=target.findParent('a',this.container,true);if(parent&&!parent.hasClass('selection_manager_dont_ignore'))
return;parent=target.findParent('textarea',this.container,true);if(parent)
return;if(!this.event_inside_entity_query_mode_widget(target))
return;e.stopEvent();var sel_target=target.findParent('.seltarget',20,true);if(sel_target&&!sel_target.hasClass('selected'))
this.on_click(e);if(this.entity_query_mode=='thumb')
{var context_sel_elem=sg_find('.context_selected',this.container.dom);if(context_sel_elem)
Ext.fly(context_sel_elem).removeClass('context_selected');sel_target.addClass('context_selected');}
this.context_menu_callback.fn.call(this.context_menu_callback.scope,e);},on_click:function(e)
{if(this.end_drag_xy&&this.end_drag_xy[0]==e.xy[0]&&this.end_drag_xy[1]==e.xy[1])
return;var target=Ext.get(e.getTarget());var href=target.findParent('a',this.container,true);if(href)
return;if(!this.event_inside_entity_query_mode_widget(target))
return;var notsel_target=target.findParent('.notseltarget',this.container,true);if(notsel_target)
return;var sel_target=target.findParent('.seltarget',20,true);if(!sel_target)
return;var pivot_column_collapse=target.findParent('div.header_collapse');if(pivot_column_collapse)
return;var sel_all=target.findParent('.selectall',this.container,true);if(sel_all)
return this.toggle_select_all(sel_all);var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac||sg_is_in_rv())
ctrl_click=dom_event.ctrlKey;if(!dom_event.shiftKey||(this.last_click==null))
{if(!ctrl_click)
this.clear_selection(true);if(this.is_group_elem(sel_target))
this.select_group(sel_target,ctrl_click);else if(this.is_entity_elem(sel_target))
this.select_entity(sel_target,ctrl_click);else
this.fire_selection_callback();}
else
{if(this.vertical_selection)
this.handle_vertical_selection_shift_click(sel_target);else
this.handle_band_selection_shift_click(sel_target);}},toggle_select_all:function(sel_all_elem)
{var s=Ext.get(sel_all_elem);if(!s.hasClass('selected'))
{s.addClass('selected');this.select_all();}
else
this.clear_selection();},handle_vertical_selection_shift_click:function(sel_target)
{var select_group=false;if(this.is_group_elem(sel_target))
{if(this.is_group_elem(this.last_click))
{this.select_group_to_group(this.last_click,sel_target);return;}
else
select_group=true;}
var top=Math.min(this.last_click.getTop(),sel_target.getTop());var bottom=Math.max(this.last_click.getBottom(),sel_target.getBottom());this.in_drag=true;var elems=sg_find_all('.seltarget',this.container.dom);for(var i=0;i<elems.length;i++)
{var fly=Ext.get(elems[i]);var fly_middle=(fly.getTop()+fly.getBottom())/2.0;var fly_height=fly.getHeight();if(fly_middle>bottom||fly_middle<top)
continue;if(fly_height!=0&&!fly.hasClass('selected')&&!this.is_group_elem(fly))
this.select_entity(fly,false);}
if(select_group)
this.select_group(sel_target);this.in_drag=false;this.fire_selection_callback();},select_group_to_group:function(from_group,to_group)
{var top=Math.min(from_group.getTop(),to_group.getTop());var bottom=Math.max(from_group.getBottom(),to_group.getBottom());var elems=sg_find_all('.seltarget',this.container.dom);for(var i=0;i<elems.length;i++)
{var fly=Ext.get(elems[i]);if(fly.getTop()>bottom||fly.getBottom()<top)
continue;if(!fly.hasClass('selected')&&this.is_group_elem(fly))
this.select_group(fly,false);}},handle_band_selection_shift_click:function(sel_target)
{var sel_entity_idx=Number(sel_target.dom.getAttribute('entity_idx'));var last_entity_idx=Number(this.last_click.dom.getAttribute('entity_idx'));var sel_group_idx=Number(sel_target.dom.getAttribute('group_idx'));var last_group_idx=Number(this.last_click.dom.getAttribute('group_idx'));var low_group_idx=Math.min(sel_group_idx,last_group_idx);var high_group_idx=Math.max(sel_group_idx,last_group_idx);var low_entity_idx=Math.min(sel_entity_idx,last_entity_idx);var high_entity_idx=Math.max(sel_entity_idx,last_entity_idx);this.in_drag=true;var elems=sg_find_all('.seltarget',this.container.dom);for(var i=0;i<elems.length;i++)
{var fly=Ext.get(elems[i]);var fly_entity_idx=Number(fly.dom.getAttribute('entity_idx'));var fly_group_idx=Number(fly.dom.getAttribute('group_idx'));if(fly_group_idx<low_group_idx||(fly_group_idx==low_group_idx&&fly_entity_idx<low_entity_idx)||fly_group_idx>high_group_idx||(fly_group_idx==high_group_idx&&fly_entity_idx>high_entity_idx))
{continue;}
if(!fly.hasClass('selected'))
this.select_entity(fly,false);}
this.in_drag=false;this.fire_selection_callback();},select_entity_by_id:function(record_id,group_idx,toggle_selection,do_not_fire_selection_callback)
{var selector='.selectable[group_idx="'+group_idx+'"][record_id="'+record_id+'"]';var elem=sg_find(selector,this.container.dom);if(elem)
this.select_entity(Ext.get(elem),toggle_selection,do_not_fire_selection_callback);},select_group_by_id:function(group_idx,toggle_selection,do_not_fire_selection_callback)
{var selector='.selectable[group_idx="'+group_idx+'"]';var elem=sg_find(selector,this.container.dom);if(elem)
this.select_group(Ext.get(elem),toggle_selection,do_not_fire_selection_callback);},select_entity:function(entity_elem,toggle_selection,do_not_fire_selection_callback)
{var group_idx=entity_elem.dom.getAttribute('group_idx');var record_id=entity_elem.dom.getAttribute('record_id');if(group_idx==null&&record_id==null)
return;var selector='.selectable[group_idx="'+group_idx+'"][record_id="'+record_id+'"]';if(toggle_selection&&entity_elem.hasClass('selected'))
{this.toggle_selection(selector,false);this.remove_entity_from_selection_cache(group_idx,record_id);}
else
{this.toggle_selection(selector,true);this.add_entity_to_selection_cache(group_idx,record_id);this.cache_last_click(entity_elem);}
if(!do_not_fire_selection_callback)
this.fire_selection_callback();},select_group:function(grp_elem,toggle_selection,do_not_fire_selection_callback)
{if(grp_elem.hasClass('synthetic'))
return this.select_synthetic_group(grp_elem,toggle_selection);var group_idx=grp_elem.dom.getAttribute('group_idx');if(toggle_selection&&grp_elem.hasClass('selected'))
{this.toggle_selection('.selectable[group_idx="'+group_idx+'"]',false);this.remove_group_from_selection_cache(group_idx);}
else
{this.toggle_selection('.selectable[group_idx="'+group_idx+'"]',true);this.add_group_to_selection_cache(group_idx);this.cache_last_click(grp_elem);}
if(!do_not_fire_selection_callback)
this.fire_selection_callback();},select_synthetic_group:function(grp_elem,toggle_selection,do_not_fire_selection_callback)
{var synthetic_group_idx=grp_elem.dom.getAttribute('group_idx');var parts=synthetic_group_idx.split('_');var low_group_idx=Number(parts[0]);var high_group_idx=Number(parts[1]);if(toggle_selection&&grp_elem.hasClass('selected'))
{for(var group_idx=low_group_idx;group_idx<=high_group_idx;group_idx++)
{this.toggle_selection('.selectable[group_idx="'+group_idx+'"]',false);this.remove_group_from_selection_cache(group_idx);}
var synthetic_group_elems=sg_find_all('.selectable.synthetic',this.container.dom);for(var i=0;i<synthetic_group_elems.length;i++)
{var sythn_elem=synthetic_group_elems[i];var synth_idx=sythn_elem.getAttribute('group_idx');parts=synth_idx.split('_');var l=Number(parts[0]);var h=Number(parts[1]);if(l>=low_group_idx&&h<=high_group_idx)
{this.toggle_selection('.selectable[group_idx="'+synth_idx+'"]',false);this.remove_group_from_selection_cache(synth_idx);}}}
else
{for(var group_idx=low_group_idx;group_idx<=high_group_idx;group_idx++)
{this.toggle_selection('.selectable[group_idx="'+group_idx+'"]',true);this.add_group_to_selection_cache(group_idx);}
var synthetic_group_elems=sg_find_all('.selectable.synthetic',this.container.dom);for(var i=0;i<synthetic_group_elems.length;i++)
{var sythn_elem=synthetic_group_elems[i];var synth_idx=sythn_elem.getAttribute('group_idx');parts=synth_idx.split('_');var l=Number(parts[0]);var h=Number(parts[1]);if(l>=low_group_idx&&h<=high_group_idx)
{this.toggle_selection('.selectable[group_idx="'+synth_idx+'"]',true);this.add_group_to_selection_cache(synth_idx);}}
this.cache_last_click(grp_elem);}
if(!do_not_fire_selection_callback)
this.fire_selection_callback();},toggle_selection:function(dom_selector,make_selected)
{var elems=sg_find_all(dom_selector,this.container.dom);for(var i=0;i<elems.length;i++)
{var fly_elm=Ext.fly(elems[i]);if(make_selected)
{fly_elm.addClass('selected');if(fly_elm.dom.hasAttribute('record_id'))
this.record_id_cache[fly_elm.dom.getAttribute('record_id')]=true;}
else
{fly_elm.removeClass('selected');if(fly_elm.dom.hasAttribute('record_id'))
delete this.record_id_cache[fly_elm.dom.getAttribute('record_id')];}}},cache_last_click:function(sel_elem)
{this.last_click=sel_elem;},is_group_elem:function(elem)
{return elem.dom.hasAttribute('group_idx')&&!elem.dom.hasAttribute('record_id');},is_entity_elem:function(elem)
{return elem.dom.hasAttribute('record_id');},clear_selection:function(do_not_fire_selection_callback)
{var all_selected=sg_find_all('.selectable.selected',this.container.dom);for(var i=0;i<all_selected.length;i++)
{var fly=Ext.fly(all_selected[i]);fly.removeClass('selected');fly.removeClass('context_selected');}
this.clear_selection_cache();if(!do_not_fire_selection_callback)
this.fire_selection_callback();},select_all:function()
{var sel_targets=sg_find_all('.seltarget',this.container.dom);for(var i=0;i<sel_targets.length;i++)
{var elem=Ext.get(sel_targets[i]);if(this.is_group_elem(elem))
this.select_group(elem);else if(elem.dom.hasAttribute('record_id'))
this.select_entity(elem);}},get_selection_data_set:function()
{var mode_widget=this.entity_query_page_widget.get_content_widget();return mode_widget.get_entity_data_store();},add_group_to_selection_cache:function(group_idx)
{var key=this.cache_key(group_idx);if(key!=null)
this.selection_cache[key]=true;if(key!=null&&key.indexOf('_')==-1)
{var ds=this.get_selection_data_set();var group=ds.get_group(group_idx);for(var i=0;i<group.ids.length;i++)
{var id=group.ids[i];this.add_entity_to_selection_cache(group_idx,id);}}},remove_group_from_selection_cache:function(group_idx)
{var key=this.cache_key(group_idx);var cache_val=this.selection_cache[key];if(cache_val!=undefined)
delete this.selection_cache[key];if(key!=null)
{var ds=this.get_selection_data_set();var group=ds.get_group(group_idx);for(var i=0;i<group.ids.length;i++)
{var id=group.ids[i];this.remove_entity_from_selection_cache(group_idx,id);}}},add_entity_to_selection_cache:function(group_idx,record_id)
{var key=this.cache_key(group_idx,record_id);if(key!=null)
this.selection_cache[key]=true;if(record_id)
this.record_id_cache[record_id]=true;},remove_entity_from_selection_cache:function(group_idx,record_id)
{var key=this.cache_key(group_idx,record_id);var cache_val=this.selection_cache[key];if(cache_val!=undefined)
delete this.selection_cache[key];},cache_key:function(group_idx,record_id)
{var key=record_id==undefined?String(group_idx):(String(group_idx)+'_'+String(record_id));return key;},destroy_component:function()
{this.clear_selection_cache();this.fire_selection_callback();}});SG.SelectionManager.DragSelector=function(config)
{Ext.apply(this,config);var empty=Ext.get('sg_grid_row_drag_nothing');if(!empty)
Ext.DomHelper.append(document.body,{tag:"div",id:"sg_grid_row_drag_nothing"},true);var config={resizeFrame:false,scroll:false};SG.SelectionManager.DragSelector.superclass.constructor.call(this,this.container,"sel_manager",config);this.setDragElId("sg_grid_row_drag_nothing");};Ext.extend(SG.SelectionManager.DragSelector,Ext.dd.DDProxy,{is_scroll_click:function(e)
{if(this.container.dom.scrollHeight>this.container.dom.clientHeight)
{var r=this.container.getRight();if(e.xy[0]+20>r)
return true;}
if(this.container.dom.scrollWidth>this.container.dom.clientWidth)
{var b=this.container.getBottom();if(e.xy[1]+20>b)
return true;}
return false;},handleMouseDown:function(e)
{if(this.is_scroll_click(e))
return;this.target=Ext.get(e.getTarget());if(!this.selection_manager.event_inside_entity_query_mode_widget(this.target))
return;var notsel_target=this.target.findParent('.notseltarget',this.container,true);if(notsel_target)
return;var grid_header=this.target.findParent('.sgw_new_grid_header',this.container);if(grid_header)
return;if(['textarea','input'].indexOf(this.target.dom.tagName.toLowerCase())!==-1)
return;var me=this;var blur_func=function(){if(SG.globals.active_editor)
SG.globals.active_editor.selection_manager_mouse_down(e);if(me.blur_callback)
me.blur_callback.fn.call(me.blur_callback.scope);};window.setTimeout(blur_func,0);SG.SelectionManager.DragSelector.superclass.handleMouseDown.apply(this,arguments);this.start_x=e.xy[0];this.start_y=e.xy[1];var dom_event=e.browserEvent;this.ctrl_drag=(!Ext.isMac||sg_is_in_rv())?dom_event.ctrlKey:dom_event.metaKey;this.osx_real_ctrl_drag=(Ext.isMac&&!sg_is_in_rv())?dom_event.ctrlKey:false;this.shift_drag=dom_event.shiftKey;if(this.shift_drag&&this.last_elem&&this.vertical_selection)
{this.start_x=(this.last_elem.getLeft()+this.last_elem.getRight())/2.0;this.start_y=(this.last_elem.getTop()+this.last_elem.getBottom())/2.0;}
if(!this.vertical_selection)
{this.band_selector.setLeft(e.xy[0]);this.band_selector.setTop(e.xy[1]);this.band_selector.setWidth(0);this.band_selector.setHeight(0);}},startDrag:function(x,y)
{if(this.osx_real_ctrl_drag)
return;this.selection_manager.in_drag=true;if(!(this.ctrl_drag||this.shift_drag))
this.selection_manager.clear_selection(true);this.targets=[];var elems=sg_find_all('div.seltarget,li.seltarget',this.container.dom);var mod_key=this.ctrl_drag||this.shift_drag;for(var i=0;i<elems.length;i++)
{var elem=Ext.get(elems[i]);if(!mod_key||(mod_key&&!elem.hasClass('selected')))
{var t={top:elem.getTop(),bottom:elem.getBottom(),elem:elem,selected:false};if(!this.vertical_selection)
{t.left=elem.getLeft();t.right=elem.getRight();}
this.targets.push(t);}}
if(!this.vertical_selection)
this.band_selector.setDisplayed(true);},onDrag:function(e)
{this.selection_manager.in_drag=true;for(var i=0;i<this.targets.length;i++)
{var target=this.targets[i];if(this.test_for_overlap(e,target))
{if(target.selected)
{this.unselect(target.elem);target.selected=false;}}
else
{if(!target.selected)
{this.selection_manager.select_entity(target.elem,false,false);target.selected=true;}}}
if(!this.vertical_selection)
{var w=e.xy[0]-this.start_x;var h=e.xy[1]-this.start_y;this.band_selector.setWidth(Math.abs(w));this.band_selector.setHeight(Math.abs(h));if(w<0)
this.band_selector.setLeft(e.xy[0]);if(h<0)
this.band_selector.setTop(e.xy[1]);}},test_for_overlap:function(e,target)
{var top=Math.min(e.xy[1],this.start_y);var bottom=Math.max(e.xy[1],this.start_y);if(this.vertical_selection)
return(target.top>bottom||target.bottom<top);else
{var left=Math.min(e.xy[0],this.start_x);var right=Math.max(e.xy[0],this.start_x);return(target.top>bottom||target.bottom<top||target.right<left||target.left>right);}},unselect:function(sel_elem)
{if(!sel_elem.hasClass('selected'))
return;this.selection_manager.select_entity(sel_elem,true,true);},endDrag:function(e)
{this.selection_manager.end_drag_xy=e.xy;var elem=Ext.get(e.getTarget());this.last_elem=elem.findParent('.seltarget',this.container,true);if(!this.vertical_selection)
this.band_selector.setDisplayed(false);this.selection_manager.in_drag=false;this.selection_manager.fire_selection_callback();},});SG.EditSelectedDialog=function(config)
{Ext.apply(this,config);SG.EditSelectedDialog.superclass.constructor.call(this);};Ext.extend(SG.EditSelectedDialog,SG.Component,{templates:{header:'<div class="title">Edit {count} Selected {display_name}</div>',body:'{rows}<div class="more_fields" pivot_column="_none_">'+'<span class="more_fields">More fields...</span></div>',body_row:'<table class="body_table">'+'<tr class="{active}" field="{field_name}" pivot_column="{pivot_column}">'+'<td class="checkbox"><div>&nbsp;</div></td>'+'<td class="field_label" sg_tip="{field_display_name}">{field_display_name}</td>'+'<td class="alert_icon" sg_tip="{alert_msg}">{alert_icon}</td>'+'<td class="field_value"><div class="{cell_classes}" {cell_attributes}>{cell_content}</div></td></tr>'+'</table>',body_row_not_editable:'<table class="body_table">'+'<tr class="{active}" field="{field_name}" pivot_column="{pivot_column}">'+'<td class="checkbox"><div>&nbsp;</div></td>'+'<td class="field_label" sg_tip="{field_display_name}">{field_display_name}</td>'+'<td class="alert_icon" sg_tip="{alert_msg}">{alert_icon}</td>'+'<td class="field_value not_editable">(Not Editable in this Context)</td></tr>'+'</table>',body_row_multi_entity:'<table class="body_table">'+'<tr class="{active}" field="{field_name}" pivot_column="{pivot_column}">'+'<td class="checkbox"><div>&nbsp;</div></td>'+'<td class="field_label" sg_tip="{field_display_name}">{field_display_name}</td>'+'<td class="alert_icon" sg_tip="{alert_msg}">{alert_icon}</td>'+'<td class="field_value"><div class="field_update_mode"><select>'+'<option value="add" selected="selected">Add</option>'+'<option value="set">Overwrite</option>'+'<option value="remove">Remove</option></select></div>'+'<div class="field_multi_entity_value {cell_classes}" {cell_attributes}>{cell_content}</div></td></tr>'+'</table>',footer_controls:'<div class="controls"><span class="cancel">Cancel</span>'+'<input name="save" type="button" value="Save"></div>',pivot_column:'<div class="pivot_column {state}">'+'<div class="pivot_column_header"><div class="tip"></div>'+'<div class="swatch" style="background-color:rgb({color});"></div>'+'<span class="header_title">{pivot_column_name}</span></div>'+'<div class="contents pivot_grid">{rows}<div class="more_fields" pivot_column="{pivot_column}">'+'<span class="more_fields">More fields...</span></div></div></div>',alert_icon:'<div class="permissions_alert"></div>'},init_component:function(){this.entity_type=this.data_set.get_type();this.my_set=new SG.Data.Set(this.entity_type);this.my_record=this.my_set.new_temp_record();this.setup_pivot_column_data_sets();this.setup_my_record();this.setup_and_render();},destroy_component:function(){Ext.EventManager.removeResizeListener(this.center_form,this);this.container.remove();this.mask.remove();},setup_pivot_column_data_sets:function()
{this.pivot_column_data_sets={};this.pivot_column_records={};for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var schema_field=SG.schema.get_field(this.entity_type,pivot_column_name);var pivot_data_set=new SG.Data.Set(schema_field.query.entity_type);var record=pivot_data_set.new_temp_record();record.set('entity',{name:'',type:this.entity_type,id:-1});this.pivot_column_records[pivot_column_name]=record;this.pivot_column_data_sets[pivot_column_name]=pivot_data_set;}},setup_pivot_column_cell_managers:function()
{this.pivot_column_cell_managers={};for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var cell_config={container:this.container,edit_container:this.container,data_set:this.pivot_column_data_sets[pivot_column_name],projects:this.projects,in_form:true};var cell_manager=this.new_component(SG.CellManager,cell_config);this.pivot_column_cell_managers[pivot_column_name]=cell_manager;}},setup_my_record:function(){if(this.entity_type=='Task'&&this.fields.indexOf('step')!=-1)
{var entity_type=null;for(var i=0;i<this.selected_entity_ids.length;i++)
{var rec=this.data_set.get_record_by_id(this.selected_entity_ids[i]);var entity=rec.get('entity');if(!entity)
return;else if(entity_type!=entity.type)
{if(entity_type==null)
entity_type=entity.type;else
return;}}
if(entity_type!=null)
{entity.name='';this.my_record.set('entity',{name:'',type:entity_type,id:-1});}}},setup_and_render:function(){this.dh=Ext.DomHelper;this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=this.dh.append(this.mask,{tag:'div',cls:'sgc_edit_selected'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'body'},true);this.footer=this.dh.append(this.container,{tag:'div',cls:'footer'},true);this.add_event(this.container,'click',this.on_click);this.add_event(this.body,'scroll',this.on_body_scroll);var cell_config={container:this.container,edit_container:this.container,data_set:this.my_set,projects:this.projects,in_form:true,get_fields_callback:{fn:this.get_fields,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.setup_pivot_column_cell_managers();Ext.EventManager.onWindowResize(this.center_form,this,true);this.render();},render:function(){this.render_header();this.render_body();this.render_footer();this.center_form();},render_header:function(){var config={};var schema=SG.schema.entity_types[this.entity_type];config.count=this.selected_entity_ids.length;if(config.count>1)
config.display_name=schema.display_name_pluralized;else
config.display_name=schema.display_name;this.header.update(this.templates.header.apply(config));},render_body:function(){var field,schema_field,cell,cell_hash,i;var row_html='';for(i=0;i<this.fields.length;i++){field=this.fields[i];schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field)continue;var edit_permissions=this.edit_permissions(schema_field);if(schema_field.data_type=='pivot_column')
{row_html+=this.render_pivot_column(schema_field);continue;}
if(schema_field.data_type=='summary')
{cell_hash={};cell_hash.field_name=field;cell_hash.field_display_name=schema_field.display_name;cell_hash.pivot_column='_none_';}
else
{cell=this.cell_manager.get_cell(field);cell.override_editable=(edit_permissions!='none');cell_hash=cell.render(this.my_record);cell_hash.pivot_column='_none_';cell_hash.field_name=field;cell_hash.field_display_name=cell.get_field_display_name();if(edit_permissions=='mixed')
{var entity_type=SG.schema.entity_types[this.entity_type].display_name_pluralized;cell_hash.alert_msg="You only have permission to edit this field on some of the "+
entity_type+" you have selected, so only those "+
entity_type+" will be changed.";cell_hash.alert_icon=this.templates.alert_icon.apply({});}}
if(this.column_display_names!=undefined)
{var user_name=this.column_display_names[field];if(user_name)
cell_hash.field_display_name=user_name+' ('+cell_hash.field_display_name+')';}
cell_hash.active="inactive";if(this.is_field_disabled(schema_field,edit_permissions))
{cell_hash.active="disabled";row_html+=this.templates.body_row_not_editable.apply(cell_hash);}
else if(schema_field.data_type=='multi_entity')
{row_html+=this.templates.body_row_multi_entity.apply(cell_hash);}
else
{row_html+=this.templates.body_row.apply(cell_hash);}}
this.body.update(this.templates.body.apply({rows:row_html}));},render_footer:function(){this.footer.update(this.templates.footer_controls.apply());},update_selected:function(){var active_field_rows=this.body.query('tr.active');var active_fields=[];var multi_entity_update_modes={};var i,j,val,row,update_mode,field,rec,error,pivot_column,config;for(i=0;i<active_field_rows.length;i++){row=Ext.get(active_field_rows[i]);field=row.dom.getAttribute('field')
pivot_column=row.dom.getAttribute('pivot_column')
config={field:field,pivot_column:pivot_column};update_mode=row.child('div.field_update_mode>select',true);if(update_mode)
config.update_mode=update_mode.value;active_fields.push(config);}
for(i=0;i<active_fields.length;i++){config=active_fields[i];var record,data_set,selected_entity_ids;if(config.pivot_column=='_none_')
{record=this.my_record;data_set=this.data_set;selected_entity_ids=this.selected_entity_ids;}
else
{record=this.pivot_column_records[config.pivot_column];var pivot_column=this.pivot_columns[config.pivot_column];selected_entity_ids=pivot_column.ids;data_set=pivot_column.data_set;}
val=record.get(config.field);error=record.get_error(config.field);if(error!==null)continue;for(j=0;j<selected_entity_ids.length;j++){rec=data_set.get_record_by_id(selected_entity_ids[j]);error=rec.get_error(config.field);if(error!==null)continue;var schema_field=SG.schema.get_field(rec.type,config.field);if(!this.can_edit_field_on_record(rec,schema_field))
{continue;}
if(config.update_mode){rec.multi_entity_set(config.field,val,config.update_mode);}else{rec.set(config.field,val);}}}
this.data_set.commit();for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var pivot_column=this.pivot_columns[pivot_column_name];pivot_column.data_set.commit();}
this.destroy();},center_form:function()
{var max_for_window=this.mask.getHeight()-100;var max_container=this.header.getHeight()+this.body.dom.scrollHeight+this.footer.getHeight();if(max_container<max_for_window)
this.container.setHeight(max_container);else
this.container.setHeight(max_for_window);this.container.setXY(this.container.getCenterXY(true));},on_click:function(e){var t=Ext.get(e.getTarget());var create_button=t.findParent('input[name="save"]',this.footer,true);if(create_button){var dlog=this;window.setTimeout(function(){dlog.update_selected();},1);}
var cancel=t.findParent('span.cancel',this.footer,true);if(cancel){this.destroy();}
var body_row=t.findParent('tr',this.body,true);if(body_row){var checkbox=t.findParent('td.checkbox',body_row,true);var label=t.findParent('td.field_label',body_row,true);if(body_row.hasClass('inactive'))
{body_row.replaceClass('inactive','active');var field=body_row.dom.getAttribute('field');if(field=='entity')
{var pivot_column=body_row.dom.getAttribute('pivot_column');var rec=pivot_column=='_none_'?this.my_record:this.pivot_column_records[pivot_column];rec.set('entity',null);}}
else if(body_row.hasClass('active')&&(checkbox||label))
body_row.replaceClass('active','inactive');}
var more_fields_span=t.findParent('span.more_fields',this.body,true);if(more_fields_span){var more_fields_div=more_fields_span.findParent('div.more_fields',this.body);var entity_type,fields;var pivot_column_name=more_fields_div.getAttribute('pivot_column');if(pivot_column_name=='_none_')
{entity_type=this.entity_type,fields=this.fields;}
else
{var pivot_schema_field=SG.schema.get_field(this.entity_type,pivot_column_name);entity_type=pivot_schema_field.query.entity_type;fields=this.pivot_columns[pivot_column_name].columns;}
this.more_fields_pivot_column=pivot_column_name;var mcd=new SG.ManageColumnsDialog({entity_type:entity_type,columns:fields,join_fields:[],only_ordinary_fields:true,field_disabled_callback:{fn:this.is_more_field_disabled,scope:this},sg_dialog_header_text:'Add fields'});mcd.on('dialog_submitted',this.on_more_fields_added,this);return;}
var pivot_column_header=t.findParent('div.pivot_column_header',this.body,true);if(pivot_column_header){var pivot_column=pivot_column_header.findParent('div.pivot_column',this.body,true);if(pivot_column.hasClass('open'))
pivot_column.replaceClass('open','closed');else
pivot_column.replaceClass('closed','open');return;}},edit_permissions:function(schema_field)
{var rec;var editable_count=0;for(i=0;i<this.selected_entity_ids.length;i++)
{rec=this.data_set.get_record_by_id(this.selected_entity_ids[i]);if(this.can_edit_field_on_record(rec,schema_field))
editable_count++;}
if(editable_count==0)
return'none';else if(editable_count==this.selected_entity_ids.length)
return'all';else
return'mixed';},can_edit_field_on_record:function(rec,schema_field){if(schema_field.entity_type=='HumanUser'&&['password_strength','password_proxy'].indexOf(schema_field.name)!=-1){return false;}
return SG.schema.can_edit_field_on_record(rec,schema_field);},is_field_disabled:function(schema_field,edit_permissions)
{var editable=(schema_field.data_type!='summary'&&edit_permissions!='none');return(!editable||schema_field.data_type=="image"||schema_field.data_type=="url"||(schema_field.entity_type=='DisplayColumn'&&schema_field.name=='data_type')||(schema_field.name==='attachments'&&schema_field.data_type==='multi_entity')||(schema_field.entity_type!=this.data_set.entity_type&&schema_field.name=='project')||schema_field.data_type=="summary");},is_more_field_disabled:function(schema_field)
{var fields;if(this.more_fields_pivot_column=='_none_')
fields=this.fields;else
fields=this.pivot_columns[this.more_fields_pivot_column].columns;var index=fields.indexOf(schema_field.name);return(index!=-1||this.is_field_disabled(schema_field,this.edit_permissions(schema_field)));},on_more_fields_added:function(added,removed)
{if(added.length==0)
return;var fields;if(this.more_fields_pivot_column=='_none_')
fields=this.fields;else
fields=this.pivot_columns[this.more_fields_pivot_column].columns;var new_fields=fields.concat(added);if(this.more_fields_pivot_column=='_none_')
this.fields=new_fields;else
this.pivot_columns[this.more_fields_pivot_column].columns=new_fields;this.render();},on_body_scroll:function()
{this.cell_manager.apply_all_edits();for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var cell_manager=this.pivot_column_cell_managers[pivot_column_name];cell_manager.apply_all_edits();}},render_pivot_column:function(pivot_schema_field)
{var row_html='';var cell_manager=this.pivot_column_cell_managers[pivot_schema_field.name];var record=this.pivot_column_records[pivot_schema_field.name];var entity_type=pivot_schema_field.query.entity_type;var columns=this.pivot_columns[pivot_schema_field.name].columns;var column_display_names=this.pivot_columns[pivot_schema_field.name].column_display_names;for(var i=0;i<columns.length;i++)
{var col=columns[i];var schema_field=SG.schema.get_field(entity_type,col);if(!schema_field)continue;var cell=cell_manager.get_cell(col);var cell_hash=cell.render(record);cell_hash.pivot_column=pivot_schema_field.name;cell_hash.field_name=col;cell_hash.field_display_name=cell.get_field_display_name();if(column_display_names!=undefined)
{var user_name=column_display_names[col];if(user_name)
cell_hash.field_display_name=user_name+' ('+cell_hash.field_display_name+')';}
cell_hash.active="inactive";if(this.is_field_disabled(schema_field))
{cell_hash.active="disabled";row_html+=this.templates.body_row_not_editable.apply(cell_hash);}else if(schema_field.data_type=='multi_entity'){row_html+=this.templates.body_row_multi_entity.apply(cell_hash);}else{row_html+=this.templates.body_row.apply(cell_hash);}}
var state='closed';if(this.more_fields_pivot_column&&this.more_fields_pivot_column==pivot_schema_field.name)
state='open';var step=SG.schema.get_step_entity(this.entity_type,pivot_schema_field.name);return this.templates.pivot_column.apply({state:state,color:step.color,pivot_column_name:pivot_schema_field.display_name,rows:row_html,pivot_column:pivot_schema_field.name});},});SG.MessageBox=function(config)
{SG.MessageBox.superclass.constructor.call(this,config);};Ext.extend(SG.MessageBox,SG.Component,{templates:{main:'<div class="sgc_message_box"><span class="message">&nbsp;</span>'+'<span class="close_x">x</span></div>'},init_component:function(){this.container=Ext.DomHelper.append(document.body,this.templates.main.apply(),true);this.message=this.container.child('span.message');this.close_x=this.container.child('span.close_x');var msg=this;this.close_x.on('click',function(e){msg.hide();});this.shadow=new Ext.Shadow({mode:'drop',offset:8});this.add_event(this.container,'click',this.on_click);this.loading_count=0;},show_loading:function()
{this.loading_count++;if(this.loading_count==1)
{var message_showing=this.container.isVisible();var tmp=null;if(message_showing)
tmp=this.last_config;this.show_now({html:'Loading...'});this.last_config=tmp;}},hide_loading:function()
{this.loading_count--;if(this.loading_count==0)
{if(this.last_config)
this.show(this.last_config);else
this.hide();}},show:function(config){var msg=this;window.setTimeout(function(){msg.show_now(config)},1);},show_now:function(config){this.last_config=config;this.message.update(config.html);if(config.close_x)
this.close_x.show();else
this.close_x.hide();this.container.setLeft(this.container.getCenterXY()[0]);this.container.show();this.shadow.show(this.container);this.message_type=config.message_type;if(config.click_fn&&typeof config.click_fn.fn=='function')
this.click_fn=config.click_fn;else
this.click_fn=null;},hide:function(){this.shadow.hide();this.close_x.hide();this.container.hide();},on_click:function(e){if(this.click_fn)
this.click_fn.fn.call(this.click_fn.scope,e);}});Ext.onReady(function(){SG.Message=new SG.MessageBox();});SG.AttachFiles=function(config)
{Ext.apply(this,config);SG.AttachFiles.superclass.constructor.call(this);};Ext.extend(SG.AttachFiles,SG.Component,{templates:{form:'<form method="post" enctype="multipart/form-data" target="_sg_upload_iframe_">'+'<input type="hidden" name="respond_with_javascript_method_call" value="'+'SG.globals.attach_files_component.upload_done"/>'+'<input type="hidden" name="requests" value=""/></form>',input:'<div class="attachment_row">'+'<div class="shift_right"><input class="attachment" name="{name}" type="file" {multiple} size="36"/>'+'<img src="/images/trash.png" class="remove_button"/></div></div>',input_notrash:'<div class="attachment_row">'+'<div class="shift_right"><input class="attachment" name="{name}" type="file" {multiple} size="36"/></div></div>',},render:function()
{var dh=Ext.DomHelper;this.input_count=0;this.container.update('');this.contents=dh.append(this.container,{tag:'div',cls:'sgc_attach_files'},true);this.form=dh.append(this.contents,this.templates.form.apply(),true);this.add_event(this.contents,'click',this.on_click);},add_attachment_input:function()
{this.input_count+=1;var template=this.templates.input;if(this.no_trash)
template=this.templates.input_notrash;var name='input_'+this.input_count;var multiple='';if(this.support_multi_upload()){name+='[]';multiple='multiple="true"';}
Ext.DomHelper.append(this.form,template.apply({name:name,multiple:multiple}));},count:function()
{var inputs=this.form.query('input.attachment');var input;var c=0;for(var i=0;i<inputs.length;i++){input=inputs[i];if(input.value!=='')c+=1;}
return c;},upload:function(field_values)
{var request_input=this.form.child('input[name="requests"]');var inputs=this.form.query('input.attachment');var i,j,input;var requests=[];var req,request;for(i=0;i<inputs.length;i++){input=inputs[i];if(input.value==='')continue;request={request_type:"create",type:"Attachment",columns:["this_file"],upload_value_form_parameter:input.name.replace("[]",""),entity_data_field_parameter:"uploaded_data",field_values:field_values};if(input.files){for(j=0;j<input.files.length;j++){req=sg_deep_copy(request);req.upload_value_form_index=j;requests.push(req);}}else{requests.push(request);}}
if(requests.length===0){this.fire_done_callback();}else{SG.globals.attach_files_component=this;var upload_progress_id=Math.floor(Math.random()*1000000);this.form.dom.action="/crud/requests?X-Progress-ID="+upload_progress_id;job={job_id:upload_progress_id,job_type:'file_upload'};this.upload_pi=new SG.ProgressIndicator(null,'det','Uploading Files...');this.upload_pi.show();this.upload_pi.start_updates_for_job(job);request_input.dom.value=Ext.encode(requests);this.form.dom.submit();}},upload_done:function(responses)
{if(SG.Repo.throw_crud_error(responses)){SG.globals.attach_files_component=null;this.upload_pi.hide();return;}
var attach;try{if(responses.length>1)
{attach=[];for(var i=0;i<responses.length;i++)
attach.push(responses[i].row[1]);}
else
attach=[responses[0].row[1]];}catch(e){attach=null;}
SG.globals.attach_files_component=null;this.upload_pi.hide();this.fire_done_callback(attach);},on_click:function(e)
{var target=Ext.get(e.getTarget());var remove_button=target.findParent('img.remove_button');if(remove_button){var row=target.findParent('div.attachment_row');if(row){row.remove();this.input_count-=1;}}},fire_done_callback:function(attach){if(this.done_callback){this.done_callback.fn.call(this.done_callback.scope,attach);}},support_multi_upload:function(){return!(this.no_multi_upload||!sg_has_multi_upload());}});SG.NestedGroupingDialog=function(config)
{Ext.apply(this,config);SG.NestedGroupingDialog.superclass.constructor.call(this);};Ext.extend(SG.NestedGroupingDialog,SG.FloatingComponent,{templates:{header:'<img class="nested_grouping" src="/images/icon_nested_grouping.png">'+'<div class="title">{title}</div>'+'<img class="close_window" src="/images/close_overlay_x.png">',footer:'<div class="pad"><input class="update" update="submit" type="button" value="Update"></div>',body:'<div class="grouping_row" row_index="-1">Group:</div>'+'<div class="divider" row_index="-1"></div>{rows}'+'<div class="grouping_row last" row_index="-1"></div>',button:'<div class="button {type}" value="{value}" sg_tip="{label}"><div class="label">{label}</div>'+'<img class="drop_down_arrow" src="/images/dropdown_arrow_small.png"></div>',group_row:'<div class="grouping_row" row_index="{row_index}"><table class="row"><tr>'+'<td class="drag_handle"><div class="pad">'+'<img class="grouping_row_icon" src="/images/grouping_row_icon.png"></div></td>'+'<td class="field"><div class="pad">{field_button}</div></td>'+'<td class="by"><div class="pad by">by</div></td>'+'<td class="method" field="{field}"><div class="pad">{method_button}</div></td>'+'<td class="sort"><div class="sort_buttons">'+'<div class="sort_button up {up_selected}" field="{field}"><img class="sort_arrow" '+'src="/images/column_header_sortarrow_up.png"></div>'+'<div class="sort_button down {down_selected}" field="{field}">'+'<img class="sort_arrow" src="/images/column_header_sortarrow_down.png"></div></div></td>'+'<td class="row_removal"><img class="row_removal" src="/images/minus_button_round.png">'+'<img class="row_add" src="/images/plus_button_round.png"></td>'+'</tr></table></div><div class="divider" row_index="{row_index}"></div>',},init_component:function(){SG.FloatingComponent.prototype.init_component.call(this);this.on_first_render();this.render();},hide:function(){this.destroy();},destroy_component:function(){SG.FloatingComponent.prototype.destroy_component.call(this);this.container.remove();this.reorder_proxy.remove();this.shadow.el.remove();},on_first_render:function(){this.dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.container=this.dh.append(this.dbody,{tag:'div',cls:'sgc_nested_grouping_dialog'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'body'},true);this.footer=this.dh.append(this.container,{tag:'div',cls:'footer'},true);this.add_event(this.header,'click',this.on_header_click);this.add_event(this.body,'click',this.on_body_click);this.add_event(this.footer,'click',this.on_footer_click);this.reorder_proxy=Ext.DomHelper.append(document.body,{tag:'div',id:'sgc_nested_grouping_dialog_proxy',cls:'sgc_nested_grouping_dialog proxy'},true);this.reorder_dnd=new SG.NestedGroupingDialog.DragZone({container:this.body,nested_grouping_dialog:this});this.setup_dialog_drag();this.load_position();if(this.grouping==false)
{this.grouping=[];this.grouping.push(null);}},render:function()
{this.render_header();this.render_body();this.render_footer();this.shadow.show(this.container);},render_header:function()
{var title;if(this.grouping==false)
title='No grouping';else if(this.grouping.length==1)
title='1 group';else
title=this.grouping.length+' groups';this.header.update(this.templates.header.apply({title:title}));},render_body:function()
{var h=this.templates.body.apply({rows:this.render_grouping_rows(),});this.body.update(h);},render_grouping_rows:function()
{var h='';for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(grouping==null)
{h+=this.render_choose_field_row(i);continue;}
var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var field_display_name;if(grouping.column.indexOf(".")>-1)
{var parts=grouping.column.split(".");var class_name=parts[1];var first_schema_field=SG.schema.get_field(this.entity_type,parts[0]);var last_schema_field=SG.schema.get_field(class_name,parts[2]);var edn=SG.schema.entity_types[class_name].display_name;if(SG.schema.allowed_entity_types(first_schema_field).length==1)
{field_display_name=first_schema_field.display_name+" > "+last_schema_field.display_name;}
else
{field_display_name=first_schema_field.display_name+" > "+edn+" > "+
last_schema_field.display_name;}}
else
field_display_name=schema_field.display_name;if(this.column_display_names!=undefined)
{var user_name=this.column_display_names[grouping.column];if(user_name)
field_display_name=user_name+' ('+schema_field.display_name+')';}
var field_button=this.templates.button.apply({type:'field',label:field_display_name,value:grouping.column});var method_label;if(grouping.method=='exact')
method_label='By exact value';else
{var grouping_options=SG.schema.get_grouping_options(this.entity_type,grouping.column);for(var j=0;j<grouping_options.length;j++)
{var opt=grouping_options[j];if(opt.name==grouping.method)
{method_label=opt.display_name;break;}}}
var method_button=this.templates.button.apply({type:'method',label:method_label,value:grouping.method});h+=this.templates.group_row.apply({row_index:i,field_button:field_button,method_button:method_button,up_selected:grouping.direction=='asc'?'selected':'',down_selected:grouping.direction=='desc'?'selected':'',field:grouping.column});}
return h;},render_footer:function()
{this.footer.update(this.templates.footer.apply());},on_header_click:function(e)
{var t=Ext.get(e.getTarget());var close_window=t.findParent('img.close_window',this.header);if(close_window)
{var me=this;setTimeout(function(){me.destroy();},0);}},on_body_click:function(e)
{var t=Ext.get(e.getTarget());var row_removal=t.findParent('img.row_removal',this.body,true);if(row_removal)
{var group_row=row_removal.findParent('div.grouping_row',this.body,true);var row_index=Number(group_row.dom.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(i!=row_index)
new_grouping.push(grouping);}
if(new_grouping.length==0)
new_grouping.push(null);this.grouping=new_grouping;this.render();return;}
var row_add=t.findParent('img.row_add',this.body,true);if(row_add)
{var group_row=row_add.findParent('div.grouping_row',this.body,true);var row_index=Number(group_row.dom.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];new_grouping.push(grouping);if(i==row_index)
new_grouping.push(null);}
this.grouping=new_grouping;this.render();return;}
var select_field=t.findParent('div.button.select_field',this.body,true);if(select_field)
{this.last_field_div=select_field;this.display_field_menu();return;}
var field_button=t.findParent('div.button.field',this.body,true);if(field_button)
{this.last_field_div=field_button;this.display_field_menu();return;}
var sort_button=t.findParent('div.sort_button',this.body,true);if(sort_button&&!sort_button.hasClass('selected'))
{if(sort_button.hasClass('disabled'))return;var field=sort_button.dom.getAttribute('field');this.toggle_direction(field);return;}
var method_button=t.findParent('div.button.method',this.body,true);if(method_button)
{this.last_method_div=method_button;var method_value=method_button.dom.getAttribute('value');if(method_value=='')return;this.display_method_menu();return;}},toggle_direction:function(field)
{var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(grouping.column==field)
{new_grouping.push({column:grouping.column,method:grouping.method,direction:grouping.direction=='asc'?'desc':'asc',});}
else
new_grouping.push(grouping);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},display_field_menu:function()
{if(!this.fields_menu)
{this.fields_menu=new SG.Menu({before_show:{fn:this.on_before_show_fields_menu,scope:this},});}
this.fields_menu.show();},on_before_show_fields_menu:function(menu)
{var config={entity_type:this.entity_type,field_disabled_callback:{fn:this.fields_menu_item_disabled,scope:this},field_checked_callback:{fn:function(){return false;},scope:this},on_field:{fn:this.fields_menu_field_selected,scope:this},no_steps:true};if(this.column_display_names!=undefined)
config.column_display_names=this.column_display_names;var fields_menu_helper=new SG.util.FieldsMenuHelper(config);menu.position={dom_elem:this.last_field_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=fields_menu_helper.get_menu_items();menu.render();},fields_menu_item_disabled:function(field_schema)
{return field_schema.no_grouping==true;},fields_menu_field_selected:function(menu,menuitem)
{var group_row=this.last_field_div.findParent('div.grouping_row',this.body);var row_index=Number(group_row.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{if(i==row_index)
{new_grouping.push({column:menuitem.field,direction:'asc',method:'exact'});}
else
new_grouping.push(this.grouping[i]);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},display_method_menu:function()
{if(!this.method_menu)
{this.method_menu=new SG.Menu({before_show:{fn:this.on_before_show_method_menu,scope:this},});}
this.method_menu.show();},on_before_show_method_menu:function(menu)
{var items=[];var method=this.last_method_div.dom.getAttribute('value');var method_td=this.last_method_div.findParent('td.method',this.body);var field=method_td.getAttribute('field');var group_row=this.last_method_div.findParent('div.grouping_row',this.body);var row_index=Number(group_row.getAttribute('row_index'));var options=SG.schema.get_grouping_options(this.entity_type,field);var opt,i;for(i=0;i<options.length;i++){opt=options[i];items.push({html:opt.display_name,checked:method==opt.name,value:{column:field,method:opt.name,direction:'asc'},item_selected:{fn:this.on_method_menuitem,scope:this},row_index:row_index});}
menu.position={dom_elem:this.last_method_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items;menu.render();},on_method_menuitem:function(menu,menuitem)
{var menuitem_grouping=menuitem.value;var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(i==menuitem.row_index)
new_grouping.push(menuitem_grouping);else
new_grouping.push(grouping);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},on_footer_click:function(e)
{var t=Ext.get(e.getTarget());var update=t.findParent('input.update',this.footer);if(update)
{var me=this;setTimeout(function(){me.rebuild_grouping();me.update_callback.fn.call(me.update_callback.scope,me.grouping);},0);}},rebuild_grouping:function()
{this.grouping_fields=[];var new_grouping=[];var group_rows=sg_find_all('div.grouping_row',this.container.dom);for(var i=0;i<group_rows.length;i++)
{var group_row=Ext.get(group_rows[i]);var field_div=group_row.child('div.button.field');if(!field_div)continue;var method_div=group_row.child('div.button.method');if(!method_div)continue;var sort_dir_div=group_row.child('div.sort_button.selected');if(!sort_dir_div)continue;var field_name=field_div.dom.getAttribute('value');if(field_name=='')continue;new_grouping.push({column:field_name,direction:sort_dir_div.hasClass('up')?'asc':'desc',method:method_div.dom.getAttribute('value')});this.grouping_fields.push(field_name);}
if(new_grouping.length==0)
this.grouping=false;else
this.grouping=new_grouping;},reorder_grouping:function(new_order)
{var new_grouping=[];for(var i=0;i<new_order.length;i++)
new_grouping.push(this.grouping[new_order[i]]);this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},setup_dialog_drag:function()
{this.shadow=new Ext.Shadow({offset:5,mode:'frame'});var dd=new Ext.dd.DDProxy(this.container,"nested_grouping",{scroll:false});dd.setHandleElId(this.header);dd.nested_grouping_dialog=this;dd.startDrag=function(){this.constrainTo(this.nested_grouping_dialog.dbody);this.getDragEl().style.border="2px solid #666666";this.nested_grouping_dialog.shadow.hide();};dd.afterDrag=function(){this.nested_grouping_dialog.save_position();this.nested_grouping_dialog.shadow.show(this.nested_grouping_dialog.container);};},save_position:function(){var xy=Ext.encode(this.container.getXY());setCookie("nested_grouping_dialog_position",xy,365);},load_position:function(){var cookie=getCookie("nested_grouping_dialog_position");var xy;if(cookie){xy=Ext.decode(cookie);}else{xy=[200,300];}
this.container.setXY(xy);},render_choose_field_row:function(index)
{var field_button=this.templates.button.apply({type:'select_field',label:'Choose field...',value:''});var method_button=this.templates.button.apply({type:'method',label:'',value:''});var html=this.templates.group_row.apply({row_index:index,field_button:field_button,method_button:method_button,up_selected:'selected disabled',down_selected:'disabled',field:''});return html;},});SG.NestedGroupingDialog.DragZone=function(config)
{Ext.apply(this,config);SG.NestedGroupingDialog.DragZone.superclass.constructor.call(this,this.container,"headings",{dragElId:"sgc_nested_grouping_dialog_proxy",resizeFrame:false,scroll:false});this.setHandleElId(this.container);};Ext.extend(SG.NestedGroupingDialog.DragZone,Ext.dd.DDProxy,{handleMouseDown:function(e){var target=Ext.get(e.getTarget());var drag_td=target.findParent('td.drag_handle',this.container,true);if(!drag_td)return;this.grouping_row=drag_td.findParent('div.grouping_row',this.container,true);this.setHandleElId(this.grouping_row);Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y){this.container.addClass('dragging');var drag_el=Ext.get(this.getDragEl());var left=this.grouping_row.getX();var top=this.grouping_row.getY();this.setDelta(x-left,y-top);this.resetConstraints();this.setXConstraint(0,0);var row_index=Number(this.grouping_row.dom.getAttribute('row_index'));if(row_index==0)
{var target=this.container.child('div.divider[row_index="-1"]');target.addClass('off');}
else if(row_index==this.nested_grouping_dialog.grouping.length-1)
{var off_index=this.nested_grouping_dialog.grouping.length-1;var target=this.container.child('div.divider[row_index="'+off_index+'"]');target.addClass('off');}
drag_el.setWidth(this.grouping_row.getWidth());drag_el.update(this.grouping_row.dom.innerHTML);this.grouping_row.addClass('dragging');Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);this.set_target(drag_el);},onDrag:function(e)
{var drag_el=Ext.get(this.getDragEl());this.set_target(drag_el);},set_target:function(drag_el)
{var drag_t=drag_el.getTop()+2;var drag_b=drag_el.getBottom()-2;var targets=Ext.DomQuery.select('div.divider',this.container.dom);var first_target;var last_target;var target_found=false;for(var i=0;i<targets.length;i++)
{var target=Ext.get(targets[i]);var t=target.getTop();var target_off=target.hasClass('off');if(t<drag_b&&t>drag_t&&!target_off)
{target_found=true;target.addClass('target');}
else
target.removeClass('target');if(i==0)
first_target=target;else if(!target_off)
last_target=target;}
if(!target_found)
{var drag_m=(drag_t+drag_b)/2;var above=Math.abs(drag_b-Number(first_target.getTop()));var below=Math.abs(drag_t-Number(last_target.getBottom()));if(above<below)
first_target.addClass('target');else
last_target.addClass('target');}},endDrag:function(e)
{var drag_el=Ext.get(this.getDragEl());var end_t=drag_el.getTop();var drag_row_index=Number(this.grouping_row.dom.getAttribute('row_index'));var group_rows=Ext.DomQuery.select('div.grouping_row',this.container.dom);var new_order=[];var drop_row_added=false;for(var i=0;i<group_rows.length;i++)
{var row=Ext.get(group_rows[i]);var row_index=Number(row.dom.getAttribute('row_index'));var t=row.getTop();if(t>end_t&&!drop_row_added)
{new_order.push(drag_row_index);drop_row_added=true;}
if(row_index!=-1&&row_index!=drag_row_index)
new_order.push(row_index);}
if(!drop_row_added)
new_order.push(drag_row_index);this.nested_grouping_dialog.reorder_grouping(new_order);this.container.removeClass('dragging');},});SG.NestedGroupingDialog=function(config)
{Ext.apply(this,config);SG.NestedGroupingDialog.superclass.constructor.call(this);};Ext.extend(SG.NestedGroupingDialog,SG.FloatingComponent,{templates:{header:'<img class="nested_grouping" src="/images/icon_nested_grouping.png">'+'<div class="title">{title}</div>'+'<img class="close_window" src="/images/close_overlay_x.png">',footer:'<div class="pad"><input class="update" update="submit" type="button" value="Update"></div>',body:'<div class="grouping_row" row_index="-1">Group:</div>'+'<div class="divider" row_index="-1"></div>{rows}'+'<div class="grouping_row last" row_index="-1"></div>',button:'<div class="button {type}" value="{value}" sg_tip="{label}"><div class="label">{label}</div>'+'<img class="drop_down_arrow" src="/images/dropdown_arrow_small.png"></div>',group_row:'<div class="grouping_row" row_index="{row_index}"><table class="row"><tr>'+'<td class="drag_handle"><div class="pad">'+'<img class="grouping_row_icon" src="/images/grouping_row_icon.png"></div></td>'+'<td class="field"><div class="pad">{field_button}</div></td>'+'<td class="by"><div class="pad by">by</div></td>'+'<td class="method" field="{field}"><div class="pad">{method_button}</div></td>'+'<td class="sort"><div class="sort_buttons">'+'<div class="sort_button up {up_selected}" field="{field}"><img class="sort_arrow" '+'src="/images/column_header_sortarrow_up.png"></div>'+'<div class="sort_button down {down_selected}" field="{field}">'+'<img class="sort_arrow" src="/images/column_header_sortarrow_down.png"></div></div></td>'+'<td class="row_removal"><img class="row_removal" src="/images/minus_button_round.png">'+'<img class="row_add" src="/images/plus_button_round.png"></td>'+'</tr></table></div><div class="divider" row_index="{row_index}"></div>',},init_component:function(){SG.FloatingComponent.prototype.init_component.call(this);this.on_first_render();this.render();},hide:function(){this.destroy();},destroy_component:function(){SG.FloatingComponent.prototype.destroy_component.call(this);this.container.remove();this.reorder_proxy.remove();this.shadow.el.remove();},on_first_render:function(){this.dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.container=this.dh.append(this.dbody,{tag:'div',cls:'sgc_nested_grouping_dialog'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'body'},true);this.footer=this.dh.append(this.container,{tag:'div',cls:'footer'},true);this.add_event(this.header,'click',this.on_header_click);this.add_event(this.body,'click',this.on_body_click);this.add_event(this.footer,'click',this.on_footer_click);this.reorder_proxy=Ext.DomHelper.append(document.body,{tag:'div',id:'sgc_nested_grouping_dialog_proxy',cls:'sgc_nested_grouping_dialog proxy'},true);this.reorder_dnd=new SG.NestedGroupingDialog.DragZone({container:this.body,nested_grouping_dialog:this});this.setup_dialog_drag();this.load_position();if(this.grouping==false)
{this.grouping=[];this.grouping.push(null);}},render:function()
{this.render_header();this.render_body();this.render_footer();this.shadow.show(this.container);},render_header:function()
{var title;if(this.grouping==false)
title='No grouping';else if(this.grouping.length==1)
title='1 group';else
title=this.grouping.length+' groups';this.header.update(this.templates.header.apply({title:title}));},render_body:function()
{var h=this.templates.body.apply({rows:this.render_grouping_rows(),});this.body.update(h);},render_grouping_rows:function()
{var h='';for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(grouping==null)
{h+=this.render_choose_field_row(i);continue;}
var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var field_display_name;if(grouping.column.indexOf(".")>-1)
{var parts=grouping.column.split(".");var class_name=parts[1];var first_schema_field=SG.schema.get_field(this.entity_type,parts[0]);var last_schema_field=SG.schema.get_field(class_name,parts[2]);var edn=SG.schema.entity_types[class_name].display_name;if(SG.schema.allowed_entity_types(first_schema_field).length==1)
{field_display_name=first_schema_field.display_name+" > "+last_schema_field.display_name;}
else
{field_display_name=first_schema_field.display_name+" > "+edn+" > "+
last_schema_field.display_name;}}
else
field_display_name=schema_field.display_name;if(this.column_display_names!=undefined)
{var user_name=this.column_display_names[grouping.column];if(user_name)
field_display_name=user_name+' ('+schema_field.display_name+')';}
var field_button=this.templates.button.apply({type:'field',label:field_display_name,value:grouping.column});var method_label;if(grouping.method=='exact')
method_label='By exact value';else
{var grouping_options=SG.schema.get_grouping_options(this.entity_type,grouping.column);for(var j=0;j<grouping_options.length;j++)
{var opt=grouping_options[j];if(opt.name==grouping.method)
{method_label=opt.display_name;break;}}}
var method_button=this.templates.button.apply({type:'method',label:method_label,value:grouping.method});h+=this.templates.group_row.apply({row_index:i,field_button:field_button,method_button:method_button,up_selected:grouping.direction=='asc'?'selected':'',down_selected:grouping.direction=='desc'?'selected':'',field:grouping.column});}
return h;},render_footer:function()
{this.footer.update(this.templates.footer.apply());},on_header_click:function(e)
{var t=Ext.get(e.getTarget());var close_window=t.findParent('img.close_window',this.header);if(close_window)
{var me=this;setTimeout(function(){me.destroy();},0);}},on_body_click:function(e)
{var t=Ext.get(e.getTarget());var row_removal=t.findParent('img.row_removal',this.body,true);if(row_removal)
{var group_row=row_removal.findParent('div.grouping_row',this.body,true);var row_index=Number(group_row.dom.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(i!=row_index)
new_grouping.push(grouping);}
if(new_grouping.length==0)
new_grouping.push(null);this.grouping=new_grouping;this.render();return;}
var row_add=t.findParent('img.row_add',this.body,true);if(row_add)
{var group_row=row_add.findParent('div.grouping_row',this.body,true);var row_index=Number(group_row.dom.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];new_grouping.push(grouping);if(i==row_index)
new_grouping.push(null);}
this.grouping=new_grouping;this.render();return;}
var select_field=t.findParent('div.button.select_field',this.body,true);if(select_field)
{this.last_field_div=select_field;this.display_field_menu();return;}
var field_button=t.findParent('div.button.field',this.body,true);if(field_button)
{this.last_field_div=field_button;this.display_field_menu();return;}
var sort_button=t.findParent('div.sort_button',this.body,true);if(sort_button&&!sort_button.hasClass('selected'))
{if(sort_button.hasClass('disabled'))return;var field=sort_button.dom.getAttribute('field');this.toggle_direction(field);return;}
var method_button=t.findParent('div.button.method',this.body,true);if(method_button)
{this.last_method_div=method_button;var method_value=method_button.dom.getAttribute('value');if(method_value=='')return;this.display_method_menu();return;}},toggle_direction:function(field)
{var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(grouping.column==field)
{new_grouping.push({column:grouping.column,method:grouping.method,direction:grouping.direction=='asc'?'desc':'asc',});}
else
new_grouping.push(grouping);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},display_field_menu:function()
{if(!this.fields_menu)
{this.fields_menu=new SG.Menu({before_show:{fn:this.on_before_show_fields_menu,scope:this},});}
this.fields_menu.show();},on_before_show_fields_menu:function(menu)
{var config={entity_type:this.entity_type,field_disabled_callback:{fn:this.fields_menu_item_disabled,scope:this},field_checked_callback:{fn:function(){return false;},scope:this},on_field:{fn:this.fields_menu_field_selected,scope:this},no_steps:true};if(this.column_display_names!=undefined)
config.column_display_names=this.column_display_names;var fields_menu_helper=new SG.util.FieldsMenuHelper(config);menu.position={dom_elem:this.last_field_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=fields_menu_helper.get_menu_items();menu.render();},fields_menu_item_disabled:function(field_schema)
{return field_schema.no_grouping==true;},fields_menu_field_selected:function(menu,menuitem)
{var group_row=this.last_field_div.findParent('div.grouping_row',this.body);var row_index=Number(group_row.getAttribute('row_index'));var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{if(i==row_index)
{new_grouping.push({column:menuitem.field,direction:'asc',method:'exact'});}
else
new_grouping.push(this.grouping[i]);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},display_method_menu:function()
{if(!this.method_menu)
{this.method_menu=new SG.Menu({before_show:{fn:this.on_before_show_method_menu,scope:this},});}
this.method_menu.show();},on_before_show_method_menu:function(menu)
{var items=[];var method=this.last_method_div.dom.getAttribute('value');var method_td=this.last_method_div.findParent('td.method',this.body);var field=method_td.getAttribute('field');var group_row=this.last_method_div.findParent('div.grouping_row',this.body);var row_index=Number(group_row.getAttribute('row_index'));var options=SG.schema.get_grouping_options(this.entity_type,field);var opt,i;for(i=0;i<options.length;i++){opt=options[i];items.push({html:opt.display_name,checked:method==opt.name,value:{column:field,method:opt.name,direction:'asc'},item_selected:{fn:this.on_method_menuitem,scope:this},row_index:row_index});}
menu.position={dom_elem:this.last_method_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items;menu.render();},on_method_menuitem:function(menu,menuitem)
{var menuitem_grouping=menuitem.value;var new_grouping=[];for(var i=0;i<this.grouping.length;i++)
{var grouping=this.grouping[i];if(i==menuitem.row_index)
new_grouping.push(menuitem_grouping);else
new_grouping.push(grouping);}
this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},on_footer_click:function(e)
{var t=Ext.get(e.getTarget());var update=t.findParent('input.update',this.footer);if(update)
{var me=this;setTimeout(function(){me.rebuild_grouping();me.update_callback.fn.call(me.update_callback.scope,me.grouping);},0);}},rebuild_grouping:function()
{this.grouping_fields=[];var new_grouping=[];var group_rows=sg_find_all('div.grouping_row',this.container.dom);for(var i=0;i<group_rows.length;i++)
{var group_row=Ext.get(group_rows[i]);var field_div=group_row.child('div.button.field');if(!field_div)continue;var method_div=group_row.child('div.button.method');if(!method_div)continue;var sort_dir_div=group_row.child('div.sort_button.selected');if(!sort_dir_div)continue;var field_name=field_div.dom.getAttribute('value');if(field_name=='')continue;new_grouping.push({column:field_name,direction:sort_dir_div.hasClass('up')?'asc':'desc',method:method_div.dom.getAttribute('value')});this.grouping_fields.push(field_name);}
if(new_grouping.length==0)
this.grouping=false;else
this.grouping=new_grouping;},reorder_grouping:function(new_order)
{var new_grouping=[];for(var i=0;i<new_order.length;i++)
new_grouping.push(this.grouping[new_order[i]]);this.grouping=new_grouping;var me=this;setTimeout(function(){me.render();},1);},setup_dialog_drag:function()
{this.shadow=new Ext.Shadow({offset:5,mode:'frame'});var dd=new Ext.dd.DDProxy(this.container,"nested_grouping",{scroll:false});dd.setHandleElId(this.header);dd.nested_grouping_dialog=this;dd.startDrag=function(){this.constrainTo(this.nested_grouping_dialog.dbody);this.getDragEl().style.border="2px solid #666666";this.nested_grouping_dialog.shadow.hide();};dd.afterDrag=function(){this.nested_grouping_dialog.save_position();this.nested_grouping_dialog.shadow.show(this.nested_grouping_dialog.container);};},save_position:function(){var xy=Ext.encode(this.container.getXY());setCookie("nested_grouping_dialog_position",xy,365);},load_position:function(){var cookie=getCookie("nested_grouping_dialog_position");var xy;if(cookie){xy=Ext.decode(cookie);}else{xy=[200,300];}
this.container.setXY(xy);},render_choose_field_row:function(index)
{var field_button=this.templates.button.apply({type:'select_field',label:'Choose field...',value:''});var method_button=this.templates.button.apply({type:'method',label:'',value:''});var html=this.templates.group_row.apply({row_index:index,field_button:field_button,method_button:method_button,up_selected:'selected disabled',down_selected:'disabled',field:''});return html;},});SG.NestedGroupingDialog.DragZone=function(config)
{Ext.apply(this,config);SG.NestedGroupingDialog.DragZone.superclass.constructor.call(this,this.container,"headings",{dragElId:"sgc_nested_grouping_dialog_proxy",resizeFrame:false,scroll:false});this.setHandleElId(this.container);};Ext.extend(SG.NestedGroupingDialog.DragZone,Ext.dd.DDProxy,{handleMouseDown:function(e){var target=Ext.get(e.getTarget());var drag_td=target.findParent('td.drag_handle',this.container,true);if(!drag_td)return;this.grouping_row=drag_td.findParent('div.grouping_row',this.container,true);this.setHandleElId(this.grouping_row);Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y){this.container.addClass('dragging');var drag_el=Ext.get(this.getDragEl());var left=this.grouping_row.getX();var top=this.grouping_row.getY();this.setDelta(x-left,y-top);this.resetConstraints();this.setXConstraint(0,0);var row_index=Number(this.grouping_row.dom.getAttribute('row_index'));if(row_index==0)
{var target=this.container.child('div.divider[row_index="-1"]');target.addClass('off');}
else if(row_index==this.nested_grouping_dialog.grouping.length-1)
{var off_index=this.nested_grouping_dialog.grouping.length-1;var target=this.container.child('div.divider[row_index="'+off_index+'"]');target.addClass('off');}
drag_el.setWidth(this.grouping_row.getWidth());drag_el.update(this.grouping_row.dom.innerHTML);this.grouping_row.addClass('dragging');Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);this.set_target(drag_el);},onDrag:function(e)
{var drag_el=Ext.get(this.getDragEl());this.set_target(drag_el);},set_target:function(drag_el)
{var drag_t=drag_el.getTop()+2;var drag_b=drag_el.getBottom()-2;var targets=Ext.DomQuery.select('div.divider',this.container.dom);var first_target;var last_target;var target_found=false;for(var i=0;i<targets.length;i++)
{var target=Ext.get(targets[i]);var t=target.getTop();var target_off=target.hasClass('off');if(t<drag_b&&t>drag_t&&!target_off)
{target_found=true;target.addClass('target');}
else
target.removeClass('target');if(i==0)
first_target=target;else if(!target_off)
last_target=target;}
if(!target_found)
{var drag_m=(drag_t+drag_b)/2;var above=Math.abs(drag_b-Number(first_target.getTop()));var below=Math.abs(drag_t-Number(last_target.getBottom()));if(above<below)
first_target.addClass('target');else
last_target.addClass('target');}},endDrag:function(e)
{var drag_el=Ext.get(this.getDragEl());var end_t=drag_el.getTop();var drag_row_index=Number(this.grouping_row.dom.getAttribute('row_index'));var group_rows=Ext.DomQuery.select('div.grouping_row',this.container.dom);var new_order=[];var drop_row_added=false;for(var i=0;i<group_rows.length;i++)
{var row=Ext.get(group_rows[i]);var row_index=Number(row.dom.getAttribute('row_index'));var t=row.getTop();if(t>end_t&&!drop_row_added)
{new_order.push(drag_row_index);drop_row_added=true;}
if(row_index!=-1&&row_index!=drag_row_index)
new_order.push(row_index);}
if(!drop_row_added)
new_order.push(drag_row_index);this.nested_grouping_dialog.reorder_grouping(new_order);this.container.removeClass('dragging');},});SG.CellFormatting=function(config)
{Ext.apply(this,config);SG.CellFormatting.superclass.constructor.call(this);};SG.CellFormatting.fetch_global_formatting_rules=function(data_set,schema_field,row_entity_type)
{var spec={type:data_set.get_type(),columns:['background_color','text_color','bold','italic','strike_through','priority','description','condition','display_column','rule_type','row_entity_type','enabled'],result:data_set,filters:{'logical_operator':'and','conditions':[]},sorts:[{column:'priority',direction:'asc'}]};if(schema_field)
spec.filters.conditions.push({'path':'display_column','relation':'is','values':[{'type':'DisplayColumn','id':schema_field.id}]});else
spec.filters.conditions.push({'path':'rule_type','relation':'is','values':['row']});spec.filters.conditions.push({'path':'row_entity_type','relation':'is','values':[row_entity_type]});SG.Repo.query(spec);};SG.CellFormatting.render_rule_styles=function(formatting_rule_rec)
{var styles='';var val;if(val=formatting_rule_rec.get('background_color'))
styles+=' background-color: '+sg_css_color(val)+';';if(val=formatting_rule_rec.get('text_color'))
styles+=' color: '+sg_css_color(val)+';';if(val=formatting_rule_rec.get('bold'))
styles+=' font-weight: bold;';if(val=formatting_rule_rec.get('italic'))
styles+=' font-style: italic;';if(val=formatting_rule_rec.get('strike_through'))
styles+=' text-decoration: line-through;';return styles;};SG.CellFormatting.rule_rec_to_server_hash=function(formatting_rule_rec)
{return{background_color:formatting_rule_rec.get('background_color'),text_color:formatting_rule_rec.get('text_color'),bold:formatting_rule_rec.get('bold'),italic:formatting_rule_rec.get('italic'),strike_through:formatting_rule_rec.get('strike_through'),enabled:formatting_rule_rec.get('enabled')}};SG.CellFormatting.extract_required_fields=function(rules,columns_array)
{for(var i=0;i<rules.length;i++)
{if(rules[i].condition)
SG.extract_field_paths(rules[i].condition,columns_array);}};Ext.extend(SG.CellFormatting,SG.Component,{templates:{main:'<div class="sgc_cell_formatting">{content}</div><div class="editor_container"></div>',condition:'<div id="sgc_formatting_condition"></div>',properties:'<table class="cell_formatting_properties"><tr>{cells}</tr></table>',cell:'<td class="{cell_classes} {field}_column" style="{cell_styles} width: {width}px;"'+' {cell_attributes}>{cell_content}</td>',cell_label:'<td class="sg_cell_formatting_label {field_name}_label {extra_class}">{label}</td>',preview:'<div id="sgc_formatting_preview" style="{styles}">Preview</div>',description:'<div id="sgc_formatting_description">'+'<div id="sgc_formatting_description_label">Description for tool tip and legend: *</div>'+'<div class="{cell_classes} {field}_column" style="{cell_styles} width: {width}px;"'+' {cell_attributes}>{cell_content}</div></div>'},columns:['text_color','bold','italic','strike_through','background_color'],image_field_columns:['background_color'],init_component:function()
{this.add_event(this.data_set,'change',this.on_data_set_change);this.is_image_field=this.schema_field&&this.schema_field.data_type=='image';},render:function()
{this.record.override_formatting_rules=null;var content='';if(this.show_description)
content+=this.render_description();content+=this.render_condition()+this.render_properties()+this.render_preview();var html=this.templates.main.apply({content:content,});this.container.dom.innerHTML=html;if(this.record.get('condition'))
{if(this.condition_component)
this.condition_component.destroy();this.edit_condition=Ext.decode(this.record.get('condition'));this.condition_component=this.new_component(SG.ConditionGroup,{condition:this.edit_condition,container:'sgc_formatting_condition',entity_type:this.entity_type,context_projects:this.context_projects,default_field_path:this.schema_field?this.schema_field.name:null,no_multi_valued_fields:true,use_these_filter_tokens:this.current_user_token?[this.current_user_token]:null,short_match_prompt_only:true});this.condition_component.render();}
else
this.edit_condition=null;},focus_description:function()
{if(this.show_description)
{var description_input_trigger=Ext.get(this.container.child('div.sg_cell.description_column').dom.firstChild);this.cell_manager.trigger_editing(description_input_trigger);}},commit_edits:function()
{this.cell_manager.apply_all_edits();if(this.condition_component)
{this.condition_component.apply_edit();if(this.condition_component.invalid())
{alert("The conditions have one or more invalid values.");return'invalid';}
this.record.set('condition',Ext.encode(this.condition_component.get_condition()));}
return'valid';},get_columns:function()
{if(this.is_image_field)
return this.image_field_columns;else
return this.columns;},render_condition:function()
{if(!this.record.get('condition'))
return'';else
return this.templates.condition.apply({});},render_properties:function()
{if(this.record)
{var columns=this.get_columns();var html=[];for(var i=0;i<columns.length;i++)
{if(['text_color','background_color'].indexOf(columns[i])>-1)
{var label=(columns[i]=='text_color')?'Text:':'Background:';var left_padding=(columns[i]=='background_color'&&!this.is_image_field)?'background_label_left_padding':'';html.push(this.templates.cell_label.apply({field_name:columns[i],label:label,extra_class:left_padding}));}
var cell=this.cell_manager.get_cell(columns[i],{use_tip:false});var cell_params=cell.render(this.record,-1);cell_params.field=columns[i];html.push(this.templates.cell.apply(cell_params));}
return this.templates.properties.apply({cells:html.join('')});}
return'';},render_preview:function()
{return this.templates.preview.apply({styles:SG.CellFormatting.render_rule_styles(this.record)});},render_description:function()
{var cell=this.cell_manager.get_cell('description',{type:SG.FakeInputCell,double_click_for_edit:false});var cell_params=cell.render(this.record,-1);cell_params.field='description';return this.templates.description.apply(cell_params);},on_data_set_change:function()
{var elem=Ext.get('sgc_formatting_preview');if(elem)
elem.dom.setAttribute('style',SG.CellFormatting.render_rule_styles(this.record));elem=Ext.get('sgc_formatting_disabled_warning');if(elem)
elem.dom.innerHTML=!this.record.get('enabled')?'This rule is disabled.':'';},});SG.CellFormattingList=function(config)
{Ext.apply(this,config);SG.CellFormattingList.superclass.constructor.call(this);};SG.CellFormattingList.default_description='';Ext.extend(SG.CellFormattingList,SG.Component,{templates:{main:'<div class="sgc_cell_formatting_list">'+'<div class="add_new_rule">'+'<span id="add_new_page_rule" class="fake_link">+ Add New Page Rule</span></div>'+'{page_content}'+'{global_rules_heading}'+'{global_content}'+'<div class="formatting_rule_row_explanation">'+'Rules are evaluated from the top down, and the first matching rule '+'is used while others are ignored. Text style from one rule can be combined with '+'the cell color of another matching rule if they both match. '+'<a target="_blank" href="'+SG.globals.help_urls.custom_formatting+'">'+'Learn more about rules here.</a></div>'+'</div>'+'<div id="sgc_cell_formatting_list_proxy"></div>',global_rules_heading:'<div class="add_new_rule">'+'<span id="add_new_global_rule" class="fake_link">+ Add New Global Rule</span>'+'<span id="global_rule_prompt">Global rules show up on all pages.</span>'+'</div>',global_rules_heading_read_only:'<div class="add_new_rule">'+'<span id="add_new_global_rule" class="">Global Rules (Read Only)</span>'+'<span id="global_rule_prompt">Global rules show up on all pages.</span>'+'</div>',list:'<div class="formatting_rule_rows">{rows}</div>',no_rows:'<div class="formatting_rule_no_rows">There are no rules yet.</div>',row:'<div class="rule_row" record_id="{record_id}">'+'<table style="table-layout: fixed;"><tr>'+'<td class="drag_handle drag_column"><img src="/images/grouping_row_icon.png"></td>'+'{enabled_cell}'+'{description_cell}'+'<td><span class="rule_row_edit fake_link">Edit&nbsp;Rule</span></td>'+'<td><span class="rule_row_duplicate fake_link">Duplicate</span></td>'+'<td class="trash_column"><div class="trash trash_column" style="display: inline-block;" '+'sg_tip="Delete formatting rule"></div></td>'+'</tr></table></div>',read_only_row:'<div class="rule_row" record_id="{record_id}">'+'<table style="table-layout: fixed;"><tr>'+'<td class="drag_column_read_only">&nbsp;</td>'+'{enabled_cell}'+'{description_cell}'+'<td><span class="rule_row_disabled_edit disabled_link" sg_tip="You do not have permission '+'to edit global formatting rules.">Edit&nbsp;Rule</span></td>'+'<td><span class="rule_row_disabled_duplicate disabled_link" '+'sg_tip="You do not have permission to create global formatting rules.">Duplicate</span></td>'+'<td class="trash_column_disabled"><div class="trash" style="display: inline-block;" '+'sg_tip="You do not have permission to delete global formatting rules."></div></td>'+'</tr></table></div>',cell:'<td class="{cell_classes} {field}_column" style="{cell_styles} width: {width}px;"'+' {cell_attributes}>{cell_content}</td>'},init_component:function()
{this.new_element_counter=1;this.add_event(this.container,'click',this.on_click);var dz_cfg={container:this.container.dom,reorder_callback:{fn:this.reorder_rules,scope:this},drag_handle_selector:'td.drag_handle',row_element_selector:'div.rule_row',row_proxy_name_selector:'td.description_column>div.sg_cell_content',drag_element_proxy_id:'sgc_cell_formatting_list_proxy',b4_start_drag_callback:{fn:this.apply_edit,scope:this}};var dz=new SG.util.RowDragReorder(dz_cfg);},get_columns:function()
{return['description'];},render:function()
{var global_rules_heading;if(SG.allow("edit_global_formatting",{}))
global_rules_heading=this.templates.global_rules_heading.apply({});else
global_rules_heading=this.templates.global_rules_heading_read_only.apply({});var html=this.templates.main.apply({page_content:this.render_list('page'),global_rules_heading:global_rules_heading,global_content:this.render_list('global')});this.container.dom.innerHTML=html;},render_list:function(page_or_global)
{var html=[];for(var i=0;i<this.records.length;i++)
{if(page_or_global=='page'&&this.records[i].get('page')){if(!this.schema_field&&this.records[i].get('row_entity_type')!==this.entity_type)
continue;html.push(this.render_row(this.records[i]));}else if(page_or_global=='global'&&!this.records[i].get('page')){html.push(this.render_row(this.records[i]));}}
if(html.length==0)
html.push(this.templates.no_rows.apply({}));return this.templates.list.apply({rows:html.join('')});},render_row:function(rec)
{if(rec.get_state()=='retired')
return'';var read_only=(!rec.get('page')&&!SG.allow("edit_global_formatting",{}));var cell=this.cell_manager.get_cell('description');cell.read_only=read_only;rec.override_formatting_rules={description:[SG.CellFormatting.rule_rec_to_server_hash(rec)]};var cell_params=cell.render(rec,-1);cell_params.field='description';cell_params.width=355;var description_cell_html=this.templates.cell.apply(cell_params);if(rec.get('page'))
{cell=this.cell_manager.get_cell('enabled',{use_tip:true,tip_template:"Enable or Disable this rule"});var cell_params=cell.render(rec,-1);cell_params.field='enabled';var enabled_cell_html=this.templates.cell.apply(cell_params);}
else
var enabled_cell_html='<td style="width: 18px;">&nbsp;</td>';var template='row';if(!rec.get('page')&&!SG.allow("edit_global_formatting",{}))
template='read_only_row';return this.templates[template].apply({record_id:rec.get_id(),enable:'',description_cell:description_cell_html,enabled_cell:enabled_cell_html});},on_click:function(e)
{var target=Ext.get(e.getTarget());if(target.id=='add_new_page_rule'||target.id=='add_new_global_rule')
{var priority=1;if(this.records.length>0)
priority=this.records[this.records.length-1].get('priority')+1;record=this.data_set.new_record();record.set('description',SG.CellFormattingList.default_description);if(target.id=='add_new_page_rule')
record.set('page',{'type':'Page','id':this.page_id});if(this.schema_field)
{record.set('display_column',{'type':'DisplayColumn','id':this.schema_field.id});record.set('rule_type','display_column');}
else
{record.set('rule_type','row');record.set('row_entity_type',this.entity_type);}
record.set('priority',priority);record.set('enabled',true);var field_name=(this.schema_field&&this.schema_field.entity_type==this.entity_type)?this.schema_field.name:'';record.set('condition',Ext.encode(SG.ConditionGroup.default_condition(this.entity_type,field_name)));record.cell_formatting_new_record=true;this.records.push(record);this.edit_callback.fn.call(this.edit_callback.scope,record);}
else if(target.hasClass('rule_row_edit'))
{var rule_row=target.findParent('div.rule_row');var record_id=Number(rule_row.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(record_id);this.edit_callback.fn.call(this.edit_callback.scope,rec);}
else if(target.hasClass('trash_column'))
{var rule_row=target.findParent('div.rule_row');var record_id=Number(rule_row.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(record_id);rec.retire();this.render();}
else if(target.hasClass('rule_row_duplicate'))
{var rule_row=target.findParent('div.rule_row');var record_id=Number(rule_row.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(record_id);var new_rec=this.insert_new_rule(rec);this.edit_callback.fn.call(this.edit_callback.scope,new_rec);}},insert_new_rule:function(rule_rec_to_copy)
{record=this.data_set.copy_record(rule_rec_to_copy);record.set('description',record.get('description')+' (Copy)');this.records.splice(this.records.indexOf(rule_rec_to_copy)+1,0,record);for(var i=0;i<this.records.length;i++)
this.records[i].set('priority',i+1);return record;},reorder_rules:function()
{var record_id,rec;var new_records=[];var rule_rows=sg_find_all('div.rule_row',this.container.dom);for(i=0;i<rule_rows.length;i++)
{record_id=Number(rule_rows[i].getAttribute('record_id'));rec=this.data_set.get_record_by_id(record_id);rec.set('priority',i+1);new_records.push(rec);}
this.records=new_records;this.render();},apply_edit:function()
{this.cell_manager.apply_all_edits();}});SG.FieldProperties=function(config)
{this.checked_count=0;this.drag_div_position=0.5;this.omit_identifier_field=false;this.pivot_columns="none";this.read_only_fields=[];Ext.apply(this,config);SG.FieldProperties.superclass.constructor.call(this,config);};Ext.extend(SG.FieldProperties,SG.Component,{spacer_re:/sg_widget_fields_space/,templates:{main:'<div class="main_container"><div class="left_pane"></div>'+'<div class="right_pane"></div><div class="drag_div"></div></div>'+'<div id="sgc_field_properties_drag_proxy" class="field_properties"></div>',fields_body:'<div>{toggle_all_table}<hr/>{field_groups}</div>',toggle_all_table:'<table id="sgd_toggle_all_table"><tr>'+'<td class="manage_columns_checkbox">'+'<input id="sgd_cb_manage_columns_toggle_all" type="checkbox"></input></td>'+'<td class="manage_columns_field_name">Toggle All</td>'+'</tr></table>',field_group:'<div class="manage_columns_group"><div class="manage_columns_group_title">'+'{arrow_image}{group_title}</div>'+'<div class="manage_columns_group_{open_closed}">{contents}</div></div>',field_table:'<table class="sgd_column_table">{fields}</table>',field_row:'<tr><td class="manage_columns_checkbox">'+'<input id="sgd_cb_{field_identifier}" class="sgd_manage_columns_cb" '+'name="{field_identifier}" type="checkbox" {checked} {disabled}></input></td>'+'<td class="manage_columns_field_name">'+'<label for="sgd_cb_{field_identifier}">{field_display_name}</label>'+'<span class="manage_columns_technical_name">{field_identifier}</span>'+'</td></tr>',field_property_div:'<div class="field_properties" field="{field}">'+'<div class="field_prop_drag_handle"></div>'+'<img class="trash {read_only}" src="/images/{image}">'+'<div class="field_title"><span class="tip_target closed">'+'<img class="tip" src="/images/arrow_closed.png">'+'<span class="title">{title}</span></span></div>'+'<div class="properties" style="display: none;">{properties}</div></div>',field_property:'<table style="width: 100%"><tr>'+'<td style="width: 50%" class="label">{label}</td><td>{editor}</td></tr></table>',input_boolean_checked:'<input class="property_input" type="checkbox" name="{name}" checked="checked"/>',input_boolean:'<input class="property_input" type="checkbox" name="{name}"/>',input_string:'<input class="property_input" type="text" name="{name}" value="{value}"/>',input_list:'<select class="property_input" name="{name}">{options}</select>',input_menu:'<div class="fake_menu" name="{name}">'+'<span class="property_input" name="{name}">{display_value}</span>'+'<div class="dropdown_arrow_small" style="display:inline-block"></div></div>',},init_component:function()
{this.container.addClass('sgc_field_properties');this.container.update(this.templates.main.apply());this.left_pane=this.container.child('div.left_pane');this.right_pane=this.container.child('div.right_pane');this.drag_div=this.container.child('div.drag_div');this.add_event(this.left_pane,'click',this.on_left_pane_click);this.add_event(this.right_pane,'click',this.on_right_pane_click);this.add_event(this.left_pane,'change',this.on_left_pane_change);this.add_event(this.right_pane,'change',this.fire_change_callback);this.position_panes_and_drag_div();this.setup_fields();this.render_component();var pane_drag=new SG.GanttDragZone(this.drag_div,this);var dz_cfg={container:this.right_pane,reorder_callback:{fn:this.fire_change_callback,scope:this},drag_handle_selector:'div.field_prop_drag_handle',row_element_selector:'div.field_properties',row_proxy_name_selector:'div.field_properties',drag_element_proxy_id:'sgc_field_properties_drag_proxy',b4_start_drag_callback:{fn:this.before_row_drag_reorder,scope:this}};this.row_drag_reorder=new SG.util.RowDragReorder(dz_cfg);},before_row_drag_reorder:function(x,y)
{var width=this.row_drag_reorder.layout_elem.getWidth();this.row_drag_reorder.drag_el.setWidth(width);},render_component:function()
{this.render_fields_tree();this.render_all_field_property_editors();},position_panes_and_drag_div:function()
{var w=this.container.getWidth();var l=Math.floor(w*this.drag_div_position);this.left_pane.setRight(w-l)
this.right_pane.setLeft(l)
this.drag_div.setLeft(l)},on_splitter_changed:function()
{var w=this.container.getWidth();var l=this.drag_div.getLeft(true)
this.drag_div_position=l/w;this.position_panes_and_drag_div();},render_fields_tree:function()
{var html=this.templates.fields_body.apply({toggle_all_table:this.templates.toggle_all_table.apply(),field_groups:this.render_fields()});this.left_pane.update(html);},render_fields:function()
{var html="";var categorized_fields=SG.schema.get_categorized_fields(this.entity_type,this.omit_identifier_field,true);html+=this.render_field_group("",categorized_fields.ordinary,"open");if(this.pivot_columns=='fields')
html+=this.render_field_group("PIPELINE",categorized_fields.pivot_column_fields,"closed");else if(this.pivot_columns=='summary')
html+=this.render_pivot_column_summary_fields("PIPELINE",categorized_fields.pivot_column_fields);else if(this.pivot_columns=='filtering')
html+=this.render_pivot_column_summary_fields("PIPELINE",categorized_fields.pivot_column_fields,'.Task.');if(this.pivot_columns=='fields'||this.pivot_columns=='summary')
html+=this.render_linked_pipeline_summary_fields();if(this.entity_type=='Task')
{categorized_fields.dependency.sort(function(a,b){if(a.absolute_sort_order>b.absolute_sort_order)return 1;if(a.absolute_sort_order<b.absolute_sort_order)return-1;return 0;});html+=this.render_field_group("DEPENDENCIES",categorized_fields.dependency,"closed");}
if(!(this.only_ordinary_fields==true))
{html+=this.render_field_group("AUDIT FIELDS",categorized_fields.audit,"closed");html+=this.render_field_group("SMART FIELDS",categorized_fields.smart_cut,"closed");var multiple_through_joins=(this.join_fields.length>1);for(var i=0;i<this.join_fields.length;i++)
{var section_title="JOIN FIELDS";if(multiple_through_joins)
section_title+=" for "+this.join_fields[i].parent_entity_link_field.display_name;html+=this.render_field_group(section_title,this.join_fields[i].fields,"closed");}
html+=this.render_linked_fields(categorized_fields);}
return html;},render_field_group:function(title,fields,open_closed,field_prefix)
{if(!fields||fields.length==0)
return"";var fields_html="";var checked_count=0;if(!field_prefix)
field_prefix='';fields=SG.schema.locally_sorted_fields(this.column_display_names,fields,field_prefix);for(var i=0;i<fields.length;i++)
{var name=fields[i].name;if(field_prefix)
name=field_prefix+name;else if(fields[i].field_reference_name)
name=fields[i].field_reference_name;var checked=(this.columns.indexOf(name)!=-1);if(checked)
{checked_count++;this.checked_count++;}
var disabled=false;if(this.field_disabled_callback)
disabled=this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,fields[i]);if(this.read_only_fields&&this.read_only_fields.indexOf(name)!=-1)
disabled=true;var display_name=SG.schema.local_display_name(this.column_display_names,fields[i],name);fields_html+=this.templates['field_row'].apply({field_identifier:name,field_display_name:display_name,checked:checked?"checked":"",disabled:disabled?"disabled":""});}
var fields_table=this.templates['field_table'].apply({fields:fields_html})
if(title!=""&&checked_count>0)
title+=" ("+checked_count+")";var arrow_image=(title!=""?this.get_arrow_html(open_closed):"");return this.templates['field_group'].apply({group_title:title,contents:fields_table,open_closed:open_closed,arrow_image:arrow_image});},get_arrow_html:function(open_closed)
{return"<img src='"+this.get_arrow_url(open_closed)+"' />"},get_arrow_url:function(open_closed)
{return open_closed=="closed"?SG.globals.icons.ArrowClosedDark:SG.globals.icons.ArrowOpenDark;},render_linked_pipeline_summary_fields:function()
{var linked_pipelines=SG.schema.get_linked_pipeline_steps(this.entity_type);var task_fields=SG.schema.get_categorized_fields('Task',false,true).ordinary;if(linked_pipelines.length==0)
return'';this.checked_count=0;var html='';for(var i=0;i<linked_pipelines.length;i++)
{if(linked_pipelines[i].entity_types.length==1)
{var entity_type_info=linked_pipelines[i].entity_types[0];var inner_html='';var current_checked_count=this.checked_count;for(var j=0;j<entity_type_info.steps.length;j++)
{var field_prefix=linked_pipelines[i].schema_field.name+'.'+entity_type_info.entity_type+'.'+'step_'+entity_type_info.steps[j].id+'$';inner_html+=this.render_field_group(entity_type_info.steps[j].code,task_fields,"closed",field_prefix);}
var title=linked_pipelines[i].schema_field.display_name;if(this.checked_count-current_checked_count>0)
title+=" ("+(this.checked_count-current_checked_count)+")";if(inner_html)
{html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}
else
{var inner_html='';var inner_checked_count=this.checked_count;for(var k=0;k<linked_pipelines[i].entity_types.length;k++)
{var entity_type_info=linked_pipelines[i].entity_types[k];var inner_inner_html='';var inner_inner_checked_count=this.checked_count;for(var j=0;j<entity_type_info.steps.length;j++)
{var field_prefix=linked_pipelines[i].schema_field.name+'.'+entity_type_info.entity_type+'.'+'step_'+entity_type_info.steps[j].id+'$';inner_inner_html+=this.render_field_group(entity_type_info.steps[j].code,task_fields,"closed",field_prefix);}
if(inner_inner_html)
{var title=SG.schema.entity_types[entity_type_info.entity_type].display_name;if(this.checked_count-inner_inner_checked_count>0)
title+=" ("+(this.checked_count-inner_inner_checked_count)+")";inner_html+=this.templates['field_group'].apply({group_title:title,contents:inner_inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}
if(inner_html)
{var title=linked_pipelines[i].schema_field.display_name;if(this.checked_count-inner_checked_count>0)
title+=" ("+(this.checked_count-inner_checked_count)+")";html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}}
var title="LINKED PIPELINES";if(this.checked_count>0)
title+=' ('+this.checked_count+')';return this.templates['field_group'].apply({group_title:title,contents:html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},render_pivot_column_summary_fields:function(section_title,fields,delimiter)
{if(!fields||fields.length==0)
return"";delimiter=delimiter||'$';this.checked_count=0;var field;var i;var inner_html='';for(i=0;i<fields.length;i++)
{var field=fields[i];if(field.query)
{var summary_entity_type=field.query.entity_type;var categorized_fields=SG.schema.get_categorized_fields(summary_entity_type,false,true);var summary_fields=[];for(var j=0;j<categorized_fields.ordinary.length;j++)
{var summary_field=sg_deep_copy(categorized_fields.ordinary[j]);summary_field.field_reference_name=field.name+delimiter+summary_field.name;summary_fields.push(summary_field);}
inner_html+=this.render_field_group(field.display_name,summary_fields,"closed");}}
if(this.checked_count>0)
section_title+=' ('+this.checked_count+')';return this.templates['field_group'].apply({group_title:section_title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},render_linked_fields:function(categorized_fields)
{this.checked_count=0;var html="";var local_sorted_fields=SG.schema.locally_sorted_fields(this.column_display_names,categorized_fields.association,'');for(var i=0;i<local_sorted_fields.length;i++)
{var assoc=local_sorted_fields[i];if(assoc)
{var assoc_display_name=SG.schema.local_display_name(this.column_display_names,assoc,assoc.name);var all_bubbled_fields=SG.schema.get_bubble_fields(assoc);if(!all_bubbled_fields)
continue;if(all_bubbled_fields.length==1)
{var entity_type=all_bubbled_fields[0].entity_type;var field_prefix=assoc.name+'.'+entity_type+'.';var fields=all_bubbled_fields[0].fields
if(fields.length>0)
html+=this.render_field_group(assoc_display_name,fields,"closed",field_prefix);}
else
{var inner_html="";var current_checked_count=this.checked_count;for(var j=0;j<all_bubbled_fields.length;j++)
{var entity_type=all_bubbled_fields[j].entity_type;var field_prefix=assoc.name+'.'+entity_type+'.';var fields=all_bubbled_fields[j].fields
if(fields.length>0)
inner_html+=this.render_field_group(SG.schema.entity_types[entity_type].display_name,fields,"closed",field_prefix);}
if(inner_html!="")
{var title=assoc_display_name;if(this.checked_count-current_checked_count>0)
title+=" ("+(this.checked_count-current_checked_count)+")";html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}}}
if(html=="")
return"";else
var group_title="LINKED FIELDS";if(this.checked_count>0)
group_title+=" ("+this.checked_count+")";return this.templates['field_group'].apply({group_title:group_title,contents:html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},on_left_pane_click:function(event)
{var t=event.getTarget();var group=Ext.get(t);if(group.hasClass("manage_columns_group_title")||(group=Ext.get(t.parentNode)).hasClass("manage_columns_group_title"))
{var contents=Ext.get(group.dom.nextSibling);if(contents.hasClass("manage_columns_group_closed"))
{contents.replaceClass("manage_columns_group_closed","manage_columns_group_open");this.set_arrow(group.dom.firstChild,"open");}
else
{contents.replaceClass("manage_columns_group_open","manage_columns_group_closed");this.set_arrow(group.dom.firstChild,"closed");}}
else if(t.id=="sgd_cb_manage_columns_toggle_all")
{this.toggle_all_checkboxes(t.checked);this.fire_change_callback();}},set_arrow:function(image_node,open_closed)
{image_node.setAttribute("src",this.get_arrow_url(open_closed));},toggle_all_checkboxes:function(checked)
{var closed=this.closed_checkboxes();var open=this.open_checkboxes();for(var i=0;i<open.length;i++)
{if(closed.indexOf(open[i])==-1&&!open[i].disabled)
open[i].checked=checked;}},closed_checkboxes:function()
{return sg_find_all('div.manage_columns_group_closed input.sgd_manage_columns_cb',this.container.dom);},open_checkboxes:function()
{return sg_find_all('div.manage_columns_group_open input.sgd_manage_columns_cb',this.container.dom);},setup_fields:function()
{this.columns=[];this.my_field_settings=[];var i,schema_field,field_hash,field_info;for(i=0;i<this.field_settings.length;i++)
{field_hash=this.field_settings[i];if(this.spacer_re.exec(field_hash.field)==null)
{schema_field=SG.schema.get_field(this.entity_type,field_hash.field);if(schema_field)
{this.columns.push(field_hash.field);this.my_field_settings.push(field_hash);}}}},add_newly_created_field:function(field_name)
{var disabled=false;if(this.field_disabled_callback)
{var field_schema=SG.schema.get_field(this.entity_type,field_name);disabled=this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,field_schema);}
if(this.read_only_fields&&this.read_only_fields.indexOf(name)!=-1)
disabled=true;if(!disabled)
{this.columns.push(field_name);this.add_field_property(field_name);}},on_left_pane_change:function(e)
{var t=Ext.get(e.getTarget());var field_toggle=t.findParent('input.sgd_manage_columns_cb',this.container,true);if(field_toggle)
{if(field_toggle.dom.checked)
this.add_field_property(field_toggle.dom.getAttribute('name'));else
this.remove_field_property(field_toggle.dom.getAttribute('name'));this.fire_change_callback();return;}
var toggle_all=t.findParent('#sgd_cb_manage_columns_toggle_all',this.container,true);if(toggle_all)
{var open=this.open_checkboxes();var closed=this.closed_checkboxes();if(toggle_all.dom.checked)
{var already_checked=[];for(var i=0;i<this.my_field_settings.length;i++)
already_checked.push(this.my_field_settings[i].field);for(var i=0;i<open.length;i++)
{if(closed.indexOf(open[i])>-1)
continue;var field_name=open[i].getAttribute('name');if(open[i].disabled||already_checked.indexOf(field_name)!=-1)
continue;var child=this.right_pane.child('div.field_properties[field="'+field_name+'"]');if(!child)
this.add_field_property(field_name);}}
else
{for(var i=0;i<open.length;i++)
{if(closed.indexOf(open[i])>-1)
continue;if(open[i].disabled)
continue;var field_name=open[i].getAttribute('name');var child=this.right_pane.child('div.field_properties[field="'+field_name+'"]');if(child)
this.remove_field_property(field_name);}}
this.fire_change_callback();return;}},on_right_pane_click:function(e)
{var t=Ext.get(e.getTarget());var trash_icon=t.findParent('img.trash',this.right_pane,true);if(trash_icon)
{var field_properties_div=trash_icon.findParent('div.field_properties',this.right_pane);var field_name=field_properties_div.getAttribute('field');this.remove_field_property(field_name);var checkbox=Ext.DomQuery.selectNode('input.sgd_manage_columns_cb[name="'+field_name+'"]',this.container.dom);if(checkbox)
checkbox.checked=false;this.fire_change_callback();return;}
var field_title_div=t.findParent('div.field_title',this.right_pane,true);if(field_title_div)
{var tip_target=field_title_div.child('span.tip_target');var parent_div=field_title_div.findParent('div.field_properties',5,true);var properties_div=parent_div.child('div.properties');var img=field_title_div.child('img.tip');var dom_event=e.browserEvent;if(tip_target.hasClass('closed'))
{if(dom_event.altKey)
{var i;var prop_divs=Ext.DomQuery.select('div.properties',this.on_fields_config_div.dom);for(i=0;i<prop_divs.length;i++)
Ext.get(prop_divs[i]).setDisplayed(true);var tip_targets=Ext.DomQuery.select('span.tip_target',this.on_fields_config_div.dom);for(i=0;i<tip_targets.length;i++)
{var target=Ext.get(tip_targets[i]);target.removeClass('closed');target.addClass('open');}
var imgs=Ext.DomQuery.select('img.tip',this.on_fields_config_div.dom);for(i=0;i<imgs.length;i++)
imgs[i].src="/images/arrow_open.png";}
else
{properties_div.setDisplayed(true);tip_target.removeClass('closed');tip_target.addClass('open');img.dom.src="/images/arrow_open.png";}}
else
{if(dom_event.altKey)
{var i;var prop_divs=Ext.DomQuery.select('div.properties',this.on_fields_config_div.dom);for(i=0;i<prop_divs.length;i++)
Ext.get(prop_divs[i]).setDisplayed(false);var tip_targets=Ext.DomQuery.select('span.tip_target',this.on_fields_config_div.dom);for(i=0;i<tip_targets.length;i++)
{var target=Ext.get(tip_targets[i]);target.removeClass('open');target.addClass('closed');}
var imgs=Ext.DomQuery.select('img.tip',this.on_fields_config_div.dom);for(i=0;i<imgs.length;i++)
imgs[i].src="/images/arrow_closed.png";}
else
{properties_div.setDisplayed(false);tip_target.removeClass('open');tip_target.addClass('closed');img.dom.src="/images/arrow_closed.png";}}
return;}
var menu=t.findParent('div.fake_menu',this.right_pane,true);if(menu)
{var field_div=menu.findParent('div.field_properties',this.right_pane);var field=field_div.getAttribute('field');if(!this.summary_menu)
{this.summary_menu=new SG.Menu({item_selected:{fn:this.on_summary_menu_item_selected,scope:this}});}
this.summary_menu.field=field;this.summary_menu.items=this.get_summary_menu_items(field);this.summary_menu.position={dom_elem:menu,elem_anchor:'bl',menu_anchor:'tl'};this.summary_menu.render();this.summary_menu.show();}},get_summary_menu_items:function(field)
{var summ_schema_field=SG.schema.get_field(this.entity_type,field);var current_summary=this.get_summary(field);var edn=SG.schema.entity_types[summ_schema_field.query.entity_type]['display_name'];schema_field=SG.schema.get_field(summ_schema_field.query.entity_type,summ_schema_field.summary_field);var options=SG.schema.summary_options[schema_field.data_type]||[];var names=SG.schema.summary_display_names;var items=[];var pct_items=[];var opt;for(var i=0;i<options.length;i++){opt=options[i];var option_name=names[opt];if(opt=='record_count')
option_name=option_name.replace('Entity',edn);if(opt!=='percentage'&&opt!=='status_percentage'){var item={html:option_name,value:{column:schema_field.name,type:opt,value:null},checked:(current_summary.type===opt),};items.push(item);}else{items.push({html:names[opt],submenu:{items:this.get_percentage_summary_items(current_summary,field,schema_field)}});}}
if(summ_schema_field.summary_default=="single_record"){items.push({html:"Single Record",value:{column:schema_field.name,type:'single_record',value:summ_schema_field.summary_value},checked:(current_summary.type==="single_record")});}
return items;},get_percentage_summary_items:function(current_summary,field,schema_field)
{var items=[];var list=schema_field;var percentage_type=(schema_field.data_type==='status_list'?'status_percentage':'percentage');var i;if(schema_field.data_type==='status_list')
{list={values:[],display_values:[]};var status_list=SG.schema.status_list;var status_list_subset=schema_field.status_list_subset;for(i=0;i<status_list_subset.length;++i)
{list.values.push(status_list_subset[i]);list.display_values.push(status_list[status_list_subset[i]].name);}}
for(i=0;i<list.values.length;i++)
{var item={html:list.display_values[i],value:{column:schema_field.name,type:percentage_type,value:list.values[i]},checked:(current_summary.type==percentage_type&&current_summary.value==list.values[i]),};items.push(item);}
return items;},add_field_property:function(field_name,field_hash)
{if(!field_hash)
{field_hash={field:field_name};for(var i=0;i<this.field_properties_schema.length;i++){var field_schema=this.field_properties_schema[i];if(field_schema.default_value!=undefined)
field_hash[field_schema.property_name]=field_schema.default_value;}
var schema_field=SG.schema.get_field(this.entity_type,field_name);if(schema_field.data_type=='summary')
field_hash['summary']=this.get_summary(field_name);this.my_field_settings.push(field_hash);}
var read_only=this.read_only_fields.indexOf(field_hash.field)!=-1;var h=this.templates.field_property_div.apply({field:field_hash.field,title:this.get_field_title(field_hash.field),properties:this.render_property_editors(field_hash),image:read_only?'blank.gif':'trash.png',read_only:read_only?'read_only':'',});Ext.DomHelper.append(this.right_pane,h);},get_field_title:function(field_name)
{var parsed=SG.schema.parse_field_name(this.entity_type,field_name);if(parsed.type=='summary')
{var left=SG.schema.entity_fields[this.entity_type][parsed.base_field].display_name;var middle=SG.schema.entity_fields[parsed.bubble_source_entity_type][parsed.bubbled_up_field].display_name;var right=SG.schema.entity_fields['Task'][parsed.summary_field].display_name;if(left==middle)
return left+' -> '+right;else
return left+' -> '+middle+' -> '+right;}
else if(parsed.type=='simple')
{var schema_field=SG.schema.get_field(this.entity_type,field_name);return schema_field.display_name;}
else
{var left=SG.schema.entity_fields[this.entity_type][parsed.base_field].display_name;var right=SG.schema.entity_fields[parsed.bubble_source_entity_type][parsed.bubbled_up_field].display_name;return left+' -> '+right;}},remove_field_property:function(field_name)
{var new_settings=[];for(var i=0;i<this.my_field_settings.length;i++)
{var field_hash=this.my_field_settings[i];if(field_hash.field!=field_name)
new_settings.push(field_hash);}
this.my_field_settings=new_settings;var child=this.right_pane.child('div.field_properties[field="'+field_name+'"]');child.remove();},render_all_field_property_editors:function()
{this.right_pane.update('');for(var i=0;i<this.my_field_settings.length;i++)
{var field_hash=this.my_field_settings[i];this.add_field_property(field_hash.field,field_hash);}},get_field_properties_schema:function(property_name)
{for(var i=0;i<this.field_properties_schema.length;i++)
{var field_property=this.field_properties_schema[i];if(field_property.property_name==property_name)
return field_property;}
return null;},render_property_editors:function(field_hash)
{var schema_field=SG.schema.get_field(this.entity_type,field_hash.field);var h='';if(this.entity_type=='Project'&&field_hash.field=='layout_project')
return h;for(var i=0;i<this.field_properties_schema.length;i++)
{var field_property=this.field_properties_schema[i];if(field_property.restrict_to_field_data_types&&field_property.restrict_to_field_data_types.indexOf(schema_field.data_type)==-1)
continue;if(field_property.disable_for_field_data_types&&field_property.disable_for_field_data_types.indexOf(schema_field.data_type)!==-1)
continue;if(this.display_property_callback)
{var display=this.display_property_callback.fn.call(this.display_property_callback.scope,schema_field,field_property);if(!display)
continue;}
switch(field_property.data_type)
{case'boolean':h+=this.render_boolean_editor(field_property,field_hash);break;case'string':h+=this.render_string_editor(field_property,field_hash);break;case'list':h+=this.render_list_editor(field_property,field_hash);break;case'summary_type':if(schema_field.data_type=='summary')
h+=this.render_summary_menu_editor(field_property,field_hash);default:break;}}
return h;},render_boolean_editor:function(field_property,field_hash)
{var template=this.templates.input_boolean;if((field_property.property_name in field_hash&&field_hash[field_property.property_name])==true||(!(field_property.property_name in field_hash)&&field_property.default_value==true))
template=this.templates.input_boolean_checked;var editor=template.apply({name:field_property.property_name});return this.templates.field_property.apply({label:field_property.display_name,editor:editor});},render_string_editor:function(field_property,field_hash)
{var value=field_property.default_value;if(field_property.property_name in field_hash)
value=field_hash[field_property.property_name];var editor=this.templates.input_string.apply({name:field_property.property_name,value:value});return this.templates.field_property.apply({label:field_property.display_name,editor:editor});},render_summary_menu_editor:function(field_property,field_hash)
{var names=SG.schema.summary_display_names;var sum=this.get_summary(field_hash.field);var editor=this.templates.input_menu.apply({name:'summary',display_value:names[sum.type]});return this.templates.field_property.apply({label:field_property.display_name,editor:editor});},get_summary:function(field_name)
{for(var i=0;i<this.my_field_settings.length;i++)
{var field_hash=this.my_field_settings[i];if(field_hash.field==field_name)
{if(field_hash.summary)
return field_hash.summary;}}
var schema_field=SG.schema.get_field(this.entity_type,field_name);return SG.schema.get_summary_default(schema_field);},on_summary_menu_item_selected:function(menu,menu_item)
{var field=menu.field;var field_div=this.right_pane.child('div.field_properties[field="'+field+'"]');var menu_div=field_div.child('div.fake_menu[name="summary"]');var menu_div=Ext.get(menu_div.dom.parentNode);var editor=this.templates.input_menu.apply({name:'summary',display_value:menu_item.html,value:menu_item.value});menu_div.update(editor);var my_field_setting=this.find_my_field_setting(field);my_field_setting['summary']=menu_item.value;this.fire_change_callback();},find_my_field_setting:function(field)
{for(var i=0;i<this.my_field_settings.length;i++)
{var my_field_setting=this.my_field_settings[i];if(my_field_setting.field==field)
return my_field_setting;}
return null;},render_list_editor:function(field_property,field_hash)
{var value=field_property.default_value;if(field_property.property_name in field_hash)
value=field_hash[field_property.property_name];var list=field_property.list_data;var options='';for(var i=0;i<list.length;i++)
{if(value==list[i])
options+='<option selected="selected" value="'+list[i]+'">'+list[i]+'</option>';else
options+='<option value="'+list[i]+'">'+list[i]+'</option>';}
var editor=this.templates.input_list.apply({name:field_property.property_name,options:options});return this.templates.field_property.apply({label:field_property.display_name,editor:editor});},get_field_properties:function()
{var field_property_divs=Ext.DomQuery.select('div.field_properties',this.right_pane.dom);var new_field_settings=[];for(var i=0;i<field_property_divs.length;i++)
{var div=Ext.get(field_property_divs[i]);var field=div.dom.getAttribute('field');var field_hash={field:field};for(var j=0;j<this.field_properties_schema.length;j++)
{var field_property=this.field_properties_schema[j];if(field_property.data_type=='summary_type')
{var my_field_setting=this.find_my_field_setting(field);field_hash['summary']=my_field_setting['summary'];continue;}
var selector='.property_input[name="'+field_property.property_name+'"]';var input=div.child(selector);if(input)
{var value=input.dom.value;if(field_property.data_type=='boolean')
value=input.dom.checked;field_hash[field_property.property_name]=value;}else{field_hash[field_property.property_name]=this.my_field_settings[i][field_property.property_name];}}
new_field_settings.push(field_hash);}
return new_field_settings;},fire_change_callback:function()
{if(this.properties_changed_callback)
{var field_settings=this.get_field_properties();this.properties_changed_callback.fn.call(this.properties_changed_callback.scope,field_settings);}},});SG.MiniFieldProperties=function(config)
{Ext.apply(this,config);SG.MiniFieldProperties.superclass.constructor.call(this,config);};Ext.extend(SG.MiniFieldProperties,SG.FieldProperties,{templates:{main:'<div class="body"><div class="fields"></div><div class="footer">'+'<div class="add_fields">Add Fields</div></div></div>',},init_component:function(){this.container.addClass('sgc_field_properties');this.container.addClass('sgc_mini_field_properties');this.container.update(this.templates.main.apply());this.right_pane=this.container.child('div.fields');this.add_event(this.right_pane,'click',this.on_right_pane_click);this.add_event(this.right_pane,'change',this.fire_change_callback);this.setup_fields();this.render_all_field_property_editors();var dz_cfg={container:this.right_pane,reorder_callback:{fn:this.fire_change_callback,scope:this},drag_handle_selector:'div.field_prop_drag_handle',row_element_selector:'div.field_properties',row_proxy_name_selector:'div.field_properties',drag_element_proxy_id:'sgc_field_properties_drag_proxy',b4_start_drag_callback:{fn:this.before_row_drag_reorder,scope:this}};this.row_drag_reorder=new SG.util.RowDragReorder(dz_cfg);this.add_event(this.container,'click',this.on_click);},on_click:function(e){var t=Ext.get(e.getTarget());var add_fields=t.findParent('div.add_fields',this.container);if(add_fields){this.display_manage_columns_dialog();return;}},display_manage_columns_dialog:function(){var config={entity_type:this.entity_type,columns:this.columns,only_ordinary_fields:this.only_ordinary_fields,pivot_columns:this.pivot_columns,field_disabled_callback:this.field_disabled_callback,join_fields:this.join_fields,sg_dialog_header_text:'Add Fields',sg_dialog_submit_button_text:'Add Fields',};var dialog=new SG.ManageColumnsDialog(config);dialog.on('dialog_submitted',this.on_manage_columns_dialog,this);},on_manage_columns_dialog:function(added,removed){var i;for(i=0;i<added.length;i++){var col=added[i];this.add_field_property(col);this.columns.push(col);}
for(i=0;i<removed.length;i++){var col=removed[i];var index=this.columns.indexOf(col);this.columns.splice(index,1);this.remove_field_property(col);}
if((added.length+removed.length)>0){var field_settings=this.get_field_properties();this.properties_changed_callback.fn.call(this.properties_changed_callback.scope,field_settings);}},});SG.ColorPicker=function(config)
{Ext.apply(this,config);SG.ColorPicker.superclass.constructor.call(this,config);};Ext.extend(SG.ColorPicker,SG.Component,{swatches:['255,255,255','234,234,234','213,213,213','192,192,192','171,171,171','150,150,150','129,129,129','108,108,108','87,87,87','66,66,66','45,45,45','24,24,24','0,41,59','2,17,74','19,0,46','47,1,50','62,1,19','99,0,0','94,0,0','83,33,0','77,44,1','84,83,3','54,71,1','1,49,1','0,62,87','1,26,108','27,0,69','71,0,76','90,0,28','148,0,0','136,0,2','125,48,2','117,66,0','123,118,0','81,104,0','0,74,0','0,92,131','0,39,166','47,0,106','107,1,112','135,0,43','222,0,0','204,0,1','179,76,7','172,98,0','184,178,4','123,154,1','1,110,1','0,126,174','1,54,218','59,0,140','139,1,149','180,1,59','253,1,0','254,2,0','248,100,2','232,134,0','245,238,0','162,207,0','25,118,27','2,149,216','0,59,251','85,1,177','183,0,188','226,1,71','254,0,0','254,41,0','253,141,3','252,183,0','249,254,1','182,241,1','1,187,0','0,194,255','0,110,252','109,0,249','238,1,253','254,0,98','252,13,45','255,87,16','246,155,12','253,188,0','255,253,28','203,243,23','29,215,46','2,211,252','50,149,253','156,1,255','253,2,253','252,47,140','253,94,99','254,131,89','255,181,76','253,205,68','253,252,100','213,247,98','103,226,102','0,230,254','129,183,255','192,97,253','254,92,255','254,125,179','254,151,152','254,173,146','254,205,138','255,218,137','253,254,152','231,251,154','161,236,154','152,242,251','188,218,252','222,182,255','253,175,251','254,191,218','253,203,204','253,214,199','254,230,196','252,239,195','251,253,204','239,251,203','202,237,197'],num_rows:10,num_cols:12,swatch_size:12,templates:{editor:'<div class="entity_editor" style="z-index: 5;"><div></div></div>',color_editor:'<div class="sge_color_editor" tabindex="-1" style="visibility: hidden;"></div>',swatch:'<td class="swatch">'+'<div class="swatch_border {selected} {dark_light}">'+'<div class="swatch" color_code="{color_code}" style="background-color:rgb({color}); '+'width:{size}px;height:{size}px;">'+'</div></div></td>',swatch_row:'<tr>{swatches}</tr>',swatch_table:'{no_color}<table>{rows}</table>',no_color:'<div id="no_color_selector_div"><span id="no_color_selector"><div class="color_none" '+'style="width:14px;height:14px;border:1px solid rgb(127,127,127);display:inline-block;"></div>'+'<span id="no_color_selector_label">None</span>'+'<span></div>'},init_component:function()
{if(!this.container)
this.container=Ext.get(document.body);if(!this.initial_value)
this.initial_value=null;var me=this;setTimeout(function(){me.render_editor();me.show_editor();},0);},render_editor:function()
{this.color_editor_el=Ext.DomHelper.append(this.container,this.templates.color_editor.apply(),true);var rows='';var c=0;for(var i=0;i<this.num_rows;i++)
{var swatches='';for(var j=0;j<this.num_cols;j++)
{var color=this.swatches[c];swatches+=this.templates.swatch.apply({color:color,color_code:this.color_code(color),selected:this.initial_value==color?'selected':'',size:this.swatch_size,dark_light:this.get_contrast_class(color)});c++;}
rows+=this.templates.swatch_row.apply({swatches:swatches});}
var swatch_table=this.templates.swatch_table.apply({rows:rows,no_color:this.null_color_option?this.templates.no_color.apply({}):''});this.color_editor_el.update(swatch_table);this.color=this.initial_value;},get_contrast_class:function(color)
{var parts=color.split(',');if(parts.length!=3)
return'light';var gray=(Number(parts[0])+Number(parts[1])+Number(parts[2]))/3.0;return gray>127?'light':'dark';},add_event_listeners:function()
{Ext.EventManager.addListener(document.body,"click",this.all_click_listener,this);},all_click_listener:function(e)
{var t=Ext.get(e.getTarget());var td=t.findParent('td.swatch',this.color_editor_el,true);if(td)
{var div=td.child('div.swatch');var color_code=div.dom.getAttribute('color_code');this.color=this.color_from_code(color_code);this.select_swatch(this.color);this.fire_callback_and_close();}
else if(div=t.findParent('span#no_color_selector'))
{this.color=null;this.fire_callback_and_close();}
else
this.fire_callback_and_close();},show_editor:function()
{this.color_editor_el.alignTo(this.cell_element,"tl-bl");var container=Ext.get(this.container);var dialog=container.findParent('.sg_dialog');if(dialog){dialog=Ext.get(dialog);var body=dialog.child('.body');if(body&&this.color_editor_el.getBottom()>body.getBottom()){this.color_editor_el.alignTo(this.cell_element,"bl-tl");if(this.color_editor_el.getTop()<body.getTop()){this.color_editor_el.alignTo(this.cell_element,"tl-bl");}}}else{var doc_body=Ext.get(document.body);var menu_anchor='t';if(this.color_editor_el.getBottom()>doc_body.getBottom())
menu_anchor='b';if(this.color_editor_el.getRight()>doc_body.getRight())
menu_anchor+='r';else
menu_anchor+='l';var elem_anchor=(menu_anchor[0]==='b'?'t':'b')+menu_anchor[1];this.color_editor_el.alignTo(this.cell_element,menu_anchor+"-"+elem_anchor);}
this.color_editor_el.show();this.add_event_listeners();},fire_callback_and_close:function()
{this.color_editor_el.remove();this.destroy();this.edit_callback.fn.call(this.edit_callback.scope,this.color,this.cell_element);},destroy_component:function()
{Ext.EventManager.removeListener(document.body,"click",this.all_click_listener);},color_code:function(color)
{var code=color.replace(/,/g,'_');return code;},color_from_code:function(code)
{var color=code.replace(/_/g,',');return color;},select_swatch:function(color)
{var selected_div=sg_find('div.swatch.selected',this.color_editor_el.dom);if(selected_div)
{selected_div=Ext.get(selected_div);selected_div.removeClass('selected');}
var selector='div.swatch[color_code="'+this.color_code(color)+'"]';var swatch_div_to_select=sg_find(selector,this.color_editor_el.dom);if(swatch_div_to_select)
{swatch_div_to_select=Ext.get(swatch_div_to_select);swatch_div_to_select.addClass('selected');}},});SG.PipelineSummary=function(cfg)
{Ext.apply(this,cfg);SG.PipelineSummary.superclass.constructor.call(this);};Ext.extend(SG.PipelineSummary,SG.Component,{templates:{body:'<div class="sgc_pipeline_summary">'+'<table>'+'<colgroup span="{num_steps}" width="0*"/>'+'<colgroup span="1" width="100%"/>'+'<tr>{cells}</tr></table></div>',cell:'<td class="step_cell {extra}" step_id="{step_id}" sg_tip="{tooltip}">'+'{status}</td>',cell_edge:'<td class="edge_cell">&nbsp;</td>'},init_component:function()
{this.loaded=false;this.add_event(this.container,'click',this.on_click);this.summary_set=new SG.Data.SummarySet('Task');this.add_event(this.summary_set,'load',this.on_summary_load);},read_data:function()
{spec={type:"Task",filters:{logical_operator:"and",conditions:[{path:"entity",relation:"is",values:[this.entity]}]},grouping:[{column:"step"}],summaries:[{column:"id",type:"record_count"},{column:"sg_status_list",type:"status_list"}],result:this.summary_set,result_key:'group_summaries'}
SG.Repo.summarize(spec);},on_summary_load:function()
{this.loaded=true;this.results={};var i,s,summ=this.summary_set.group_summaries;for(var i=0;i<summ.length;i++){s=summ[i];if(s.template_values&&s.template_values[0])
{this.results[s.template_values[0].id]={count:s.summaries[0].value,status:s.summaries[1].value}}}
this.render();},render:function()
{if(!this.loaded){this.container.update("Loading...");this.read_data();return;}
var i,s,status,count,cfg,r,h;var steps=SG.schema.get_pipeline_order_steps(this.entity.type);var schema_field=SG.schema.get_field("Task","sg_status_list");var ren=SG.Renderers.status_list_no_tooltip;var h="";var singular=" "+SG.schema.entity_types["Task"].display_name;var plural=" "+SG.schema.entity_types["Task"].display_name_pluralized;for(i=1;i<steps.length;i++){s=steps[i];r=this.results[s.id];status=r?r.status:null;count=r?r.count:0;count+=count==1?singular:plural;cfg={step_id:s.id,status:SG.SummaryRenderers.status_list(status,null,schema_field,ren),extra:"",tooltip:s.code+" - "+count};if(i==1)
cfg.extra+=" first";if(s.id==this.step_id)
cfg.extra+=" selected";h+=this.templates.cell.apply(cfg);}
cfg={step_id:0,status:"All",extra:"",tooltip:"All Tasks"};if(this.step_id==0)
cfg.extra+=" selected";h+=this.templates.cell.apply(cfg);h+=this.templates.cell_edge.apply();h+="</tr></table></div>";cfg={cells:h,num_steps:steps.length}
this.container.update(this.templates.body.apply(cfg));this.position_img();},position_img:function()
{var td=this.container.child('td.step_cell[step_id='+this.step_id+']');var box=td.getBox(true,true);this.img_elem.alignTo(td,'c-c',[0,-12]);},on_click:function(e)
{var target=Ext.get(e.getTarget());var step_cell=target.findParent('td.step_cell');if(step_cell){var cur_step=this.container.child('td.step_cell[step_id="'+this.step_id+'"]');cur_step.removeClass("selected");Ext.fly(step_cell).addClass("selected");this.step_id=step_cell.getAttribute("step_id");this.callback.fn.call(this.callback.scope,this.step_id);}}});SG.MiniGrid=function(cfg)
{Ext.apply(this,cfg);SG.MiniGrid.superclass.constructor.call(this);};Ext.extend(SG.MiniGrid,SG.Component,{templates:{table:'<div class="sgc_mini_grid"><table style="width: {width}px;">'+'{header}{body}</table>{pagination}</div>',header_row:'<tr>{cells}</tr>',header_cell:'<td class="header_cell" style="width: {width}px;">{display_name}</td>',body_row:'<tr class="{selected}" >{cells}</tr>',body_cell:'<td style="{cell_styles} width: {width}px;" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</td>',selection_cell:'<td style="width:21px;" id="{id}">{checkbox}</td>',pagination:'<div class="pagination" style="width: {width}px;"><center>{control}</center></div>',paging_controls:'<img src="/images/left_arrow_{prev_enabled}.png" class="arrow {prev_enabled}" page="{prev_page}"/>'+'<span class="current_page">{current_page}</span>'+'<span class="page_count"> / {page_count}</span>'+'<img src="/images/right_arrow_{next_enabled}.png" page="{next_page}" class="arrow {next_enabled}"/>',group_header:'<tr><td colspan="{column_count}"><div class="group_display">{group_display}<div></td></tr>',},init_component:function()
{this.loaded=false;this.current_page=1;this.sorts=this.sorts||[];this.required_columns=this.required_columns||[];this.data_set=this.new_data_set(this.entity_type,this.on_data_load);this.cache_field_properties();var cell_config={container:this.container,data_set:this.data_set,projects:this.widget.context_projects(),read_only:this.read_only};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,'click',this.on_click);if(this.record_selection_changed)
this.add_event(SG.Checkbox,'change',this.on_checkbox_change);},read_data:function()
{var cols=this.required_columns.concat(this.fields);var spec={type:this.entity_type,filters:this.filters,columns:cols,current_page:this.current_page,records_per_page:50,result:this.data_set};if(this.sorts)
spec.sorts=this.sorts;if(this.grouping)
spec.grouping=this.grouping;SG.Repo.query(spec);},on_data_load:function()
{if(this.pi)
this.pi.hide();this.loaded=true;this.render();},get_data_set:function()
{return this.data_set;},cache_field_properties:function()
{var i,field_name,field_property,schema_field;this.property_cache={};this.fields=[];for(i=0;i<this.field_properties.length;i++){field_property=this.field_properties[i];field_name=field_property.field;schema_field=SG.schema.get_field(this.entity_type,field_name);if(schema_field){this.fields.push(field_name);this.property_cache[field_name]=field_property;}}},get_field_property:function(field_name,prop)
{var p=this.property_cache[field_name]||{};return p[prop];},get_field_width:function(field)
{var w=parseInt(this.get_field_property(field,'width'));if(isNaN(w))
return 100;else
return w;},get_total_width:function()
{var w=0;if(this.record_selection_changed)
w=21;for(var i=0;i<this.fields.length;i++){w+=this.get_field_width(this.fields[i]);}
return w;},get_field_display_name:function(field_name)
{var fp=this.get_field_property(field_name,'field_label_override');if(fp)
return fp;var schema_field=SG.schema.get_field(this.entity_type,field_name);return schema_field.display_name;},set_filters:function(filters)
{this.filters=filters;this.loaded=false;this.render();},render:function()
{if(!this.loaded){this.container.update("<i>Loading...</i>");this.read_data();return;}
if(this.data_set.count()===0){this.container.update("<i>No tasks</i>");return;}
if(this.fields.length===0){this.container.update("<i>No task fields configured.</i>");return;}
var width=this.get_total_width();var cfg={header:this.render_header(),body:this.render_body(),width:width,pagination:this.render_pagination(width)};this.container.update(this.templates.table.apply(cfg));},render_header:function()
{var i,cfg,field,h="";if(this.record_selection_changed)
h+=this.templates.selection_cell.apply({id:'',checkbox:''});for(i=0;i<this.fields.length;i++){field=this.fields[i];cfg={display_name:this.get_field_display_name(field),width:this.get_field_width(field)};h+=this.templates.header_cell.apply(cfg);}
return this.templates.header_row.apply({cells:h});},render_body:function()
{if(this.data_set.is_grouped())
{var h='';for(var i=0;i<this.data_set.group_count();i++)
{var group=this.data_set.get_group(i);h+=this.render_group(group);}
return h;}
else
{var h='';for(var i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);h+=this.render_row(rec);}
return h;}},render_group:function(group)
{var column_count=this.fields.length;if(this.record_selection_changed)column_count++;var grouping=this.grouping[0];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var group_display=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,0,this.grouping,schema_field,schema_field.display_name)
var h=this.templates.group_header.apply({column_count:column_count,group_display:group_display});var grp_recs=group.ids;for(var j=0;j<grp_recs.length;j++)
{var rec=this.data_set.get_record_by_id(grp_recs[j]);h+=this.render_row(rec);}
return h;},render_row:function(rec)
{var cells="";var selected=false;if(this.record_selection_changed)
{selected=this.is_record_selected.fn.call(this.is_record_selected.scope,rec);var checkbox_id=this.entity_type+'_record_'+rec.id;var checked=selected?'checked':'unchecked';cells=this.templates.selection_cell.apply({checkbox:SG.Checkbox.render(checkbox_id,null,checked,false),});}
for(j=0;j<this.fields.length;j++)
{var field=this.fields[j];var cell=this.cell_manager.get_cell(field);var cfg=cell.render(rec);cfg.width=this.get_field_width(field);cells+=this.templates.body_cell.apply(cfg);}
return this.templates.body_row.apply({cells:cells,selected:selected?'selected':'',});},render_pagination:function(width)
{var paging_info=this.data_set.get_paging_info();var cur_page=paging_info.current_page;var page_count=paging_info.page_count;if(paging_info.current_page&&page_count>1)
{var prev_enabled=(cur_page>1)?'enabled':'disabled';var next_enabled=(cur_page!=page_count)?'enabled':'disabled';var input_enabled=(page_count>1)?'enabled':'disabled';var paging_controls=this.templates.paging_controls.apply({prev_enabled:prev_enabled,next_enabled:next_enabled,current_page:cur_page,page_count:page_count,prev_page:(cur_page-1),next_page:(cur_page+1),});return this.templates.pagination.apply({width:width,control:paging_controls});}
else
return'';},on_click:function(e)
{var t=Ext.get(e.getTarget());var arrow=t.findParent('img.arrow',this.container,true);if(arrow)
{if(arrow.hasClass('disabled'))return;this.current_page=Number(arrow.dom.getAttribute('page'));this.pi=new SG.ProgressIndicator(this.container);this.pi.show();this.read_data();}},get_data_set:function()
{return this.data_set;},on_checkbox_change:function(checkbox)
{if(!this.container.contains(checkbox))return;var id=checkbox.getAttribute('id');var parts=id.split('_');var record_id=Number(parts[2]);var state=checkbox.getAttribute('checkbox_state');var is_checked=state=='checked';var rec=this.data_set.get_record_by_id(record_id);this.record_selection_changed.fn.call(this.record_selection_changed.scope,rec,is_checked);this.render();},});SG.MiniThumbnailGrid=function(cfg)
{Ext.apply(this,cfg);SG.MiniThumbnailGrid.superclass.constructor.call(this);};Ext.extend(SG.MiniThumbnailGrid,SG.Component,{templates:{main:'<div class="sgc_mini_thumbnail_grid" style="font-size:{thumb_size}em;">{body}{pagination}</div>',entity_box:'<div class="entity_box selectable" group_idx="{group_idx}" record_idx="{record_idx}" '+'record_id="{record_id}">{thumb}{bottom_fields}</div>',thumb:'<div class="thumbnail_grid cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'{cell_content}</div>',field:'<div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div>',pagination:'<div class="pagination"><center>{control}</center></div>',paging_controls:'<img src="/images/left_arrow_{prev_enabled}.png" class="arrow {prev_enabled}" page="{prev_page}"/>'+'<span class="current_page">{current_page}</span>'+'<span class="page_count"> / {page_count}</span>'+'<img src="/images/right_arrow_{next_enabled}.png" page="{next_page}" class="arrow {next_enabled}"/>',group:'<div><div class="group_header">{group_display}</div><div class="group_contents">{contents}</div></tr>',},init_component:function()
{this.loaded=false;this.current_page=1;this.sorts=this.sorts||[];this.required_columns=this.required_columns||[];if(this.required_columns.indexOf('image')==-1)
this.required_columns.push('image');this.thumb_size=this.thumb_size||4;this.data_set=this.new_data_set(this.entity_type,this.on_data_load);this.cache_field_properties();var cell_config={container:this.container,data_set:this.data_set,projects:this.widget.context_projects(),read_only:this.read_only};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,'click',this.on_click);},read_data:function()
{var cols=this.required_columns.concat(this.fields);var spec={type:this.entity_type,filters:this.filters,columns:cols,current_page:this.current_page,records_per_page:50,result:this.data_set};if(this.sorts)
spec.sorts=this.sorts;if(this.grouping)
spec.grouping=this.grouping;SG.Repo.query(spec);},on_data_load:function()
{if(this.pi)
this.pi.hide();this.loaded=true;this.render();},get_data_set:function()
{return this.data_set;},cache_field_properties:function()
{var i,field_name,field_property,schema_field;this.property_cache={};this.fields=[];for(i=0;i<this.field_properties.length;i++){field_property=this.field_properties[i];field_name=field_property.field;schema_field=SG.schema.get_field(this.entity_type,field_name);if(schema_field){this.fields.push(field_name);this.property_cache[field_name]=field_property;}}},get_field_property:function(field_name,prop)
{var p=this.property_cache[field_name]||{};return p[prop];},get_field_display_name:function(field_name)
{var fp=this.get_field_property(field_name,'field_label_override');if(fp)
return fp;var schema_field=SG.schema.get_field(this.entity_type,field_name);return schema_field.display_name;},set_filters:function(filters)
{this.filters=filters;this.loaded=false;this.render();},render:function()
{if(!this.loaded){this.container.update("<i>Loading...</i>");this.read_data();return;}
if(this.data_set.count()===0){this.container.update("<i>No Versions</i>");return;}
this.container.update(this.templates.main.apply({thumb_size:this.base_thumb_size,body:this.render_body(),pagination:this.render_pagination()}));},render_body:function()
{var h=[];if(this.data_set.is_grouped())
{for(var i=0;i<this.data_set.group_count();i++)
{var group=this.data_set.get_group(i);h.push(this.render_group(group,i));}}
else
{for(var i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);h.push(this.render_entity_box(rec,0,i));}}
return h.join('');},render_group:function(group,group_idx)
{var column_count=this.fields.length;if(this.record_selection_changed)
column_count++;var h=[];var grp_recs=group.ids;for(var j=0;j<grp_recs.length;j++)
{var rec=this.data_set.get_record_by_id(grp_recs[j]);h.push(this.render_entity_box(rec,group_idx,j));}
var grouping=this.grouping[0];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var group_display=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(grouping,0,this.grouping,schema_field,schema_field.display_name)
return this.templates.group.apply({group_display:group_display,contents:h.join('')});},render_entity_box:function(rec,group_idx,record_idx)
{var cfg=this.cell_manager.get_cell('image').render(rec);var thumb=this.templates.thumb.apply(cfg);var field_html=[];for(j=0;j<this.fields.length;j++)
{var field=this.fields[j];cfg=this.cell_manager.get_cell(field).render(rec);field_html.push(this.templates.field.apply(cfg));}
return this.templates.entity_box.apply({thumb:thumb,group_idx:group_idx,record_idx:record_idx,record_id:rec.get_id(),bottom_fields:field_html.join('')});},render_pagination:function()
{var paging_info=this.data_set.get_paging_info();var cur_page=paging_info.current_page;var page_count=paging_info.page_count;if(paging_info.current_page&&page_count>1)
{var prev_enabled=(cur_page>1)?'enabled':'disabled';var next_enabled=(cur_page!=page_count)?'enabled':'disabled';var input_enabled=(page_count>1)?'enabled':'disabled';var paging_controls=this.templates.paging_controls.apply({prev_enabled:prev_enabled,next_enabled:next_enabled,current_page:cur_page,page_count:page_count,prev_page:(cur_page-1),next_page:(cur_page+1),});return this.templates.pagination.apply({control:paging_controls});}
else
return'';},on_click:function(e)
{var t=Ext.get(e.getTarget());var arrow=t.findParent('img.arrow',this.container,true);if(arrow)
{if(arrow.hasClass('disabled'))return;this.current_page=Number(arrow.dom.getAttribute('page'));this.pi=new SG.ProgressIndicator(this.container);this.pi.show();this.read_data();return;}
if(this.selection_enabled||this.multi_select_enabled){var selectable=t.findParent('div.selectable',this.container,true);if(selectable){var target_group_idx=Number(selectable.dom.getAttribute('group_idx'));var target_rec_idx=Number(selectable.dom.getAttribute('record_idx'));if(this.multi_select_enabled&&this.is_ctrl_click(e)){if(selectable.hasClass('selected')){selectable.removeClass('selected');}else{selectable.addClass('selected');this.previous_selection={group_idx:target_group_idx,record_idx:target_rec_idx};}}else if(this.multi_select_enabled&&this.is_shift_click(e)){if(this.previous_selection&&this.previous_selection.group_idx===target_group_idx){last_idx=this.previous_selection.record_idx;}else{last_idx=0;}
var upper_limit;var lower_limit;if(target_rec_idx>last_idx){lower_limit=last_idx;upper_limit=target_rec_idx;}else{lower_limit=target_rec_idx;upper_limit=last_idx;}
var i;for(i=lower_limit;i<=upper_limit;i++){var div=this.container.child('div.selectable[group_idx="'+target_group_idx+'"][record_idx="'+i+'"]');if(div)
div.addClass('selected');}
this.previous_selection={group_idx:target_group_idx,record_idx:target_rec_idx};return;}else{var selected=this.get_selected_divs();var i;for(i=0;i<selected.length;i++)
selected[i].removeClass('selected');selectable.addClass('selected');this.previous_selection={group_idx:target_group_idx,record_idx:target_rec_idx};}
return;}}},get_data_set:function()
{return this.data_set;},is_ctrl_click:function(e)
{var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;return ctrl_click;},is_shift_click:function(e)
{var dom_event=e.browserEvent;return dom_event.shiftKey;},get_selected_divs:function(group_idx){var selected;if(group_idx>-1)
selected=sg_find_all('div.selected[group_idx="'+group_idx+'"]');else
selected=sg_find_all('div.selected',this.container.dom);var divs=[];var i;for(i=0;i<selected.length;i++)
divs.push(Ext.get(selected[i]));return divs;},get_selected_records:function(group_idx){var records=[];var divs=this.get_selected_divs(group_idx);var i,record_id;for(i=0;i<divs.length;i++){record_id=Number(divs[i].dom.getAttribute('record_id'));records.push(this.data_set.get_record_by_id(record_id));}
return records;}});SG.AttachmentControl=function(config)
{Ext.apply(this,config);SG.AttachmentControl.superclass.constructor.call(this);};Ext.extend(SG.AttachmentControl,SG.Component,{templates:{body:'<div class="sgc_attachment_control">{tabs}'+'<div class="details">{current_tab}</div>{close}</div>',form:'<form method="post" enctype="multipart/form-data" target="_sg_upload_iframe_">'+'<input type="hidden" name="respond_with_javascript_method_call" value="'+'SG.globals.attachment_control.submit_done"/>'+'<input type="hidden" name="requests" value=""/>{inputs}</form>',tabs:'<table class="tabs">'+'<colgroup span="{num_tabs}" width="0*"/>'+'<colgroup span="1" width="100%"/>'+'<tr>{tabs}<td class="edge"></td></tr></table>',tab:'<td class="tab {selected}" name="{name}">'+'<div class="sg_entity_icon_span {icon_class}"></div>'+'<div class="tab_name">{display_name}</div></td>',local:'<input type="button" class="browse_local" value="Browse...">'+'<div class="copy">{copy}</div>'+'<table class="path_list"><tbody></tbody></table>',local_unsupported:'<i>Local file access is not available for your browser.</i>',local_path:'<tr class="local_row" path="{path}">'+'<td class="local_path">{name}</td>'+'<td class="local_img">{trash}</td></tr>',local_trash:'<img src="/images/trash.png" class="remove local_remove"/>',upload_input:'<table class="upload_row"><td style="width: 225px">'+'<input type="file" class="upload" name="{name}" {multiple}></td>'+'<td>{trash}</td></tr></table>',upload_trash:'<img src="/images/trash.png" class="remove upload_remove"/>',upload_single_only:'<br><span class="browser_warning">FYI: Selecting multiple files at once '+'is available on the <a href="'+SG.globals.help_urls.multi_upload+'" target="_blank">'+'latest browsers</a>.',www:'<table class="www_table"><tr>'+'<td class="www_label"><b>URL:<b></td>'+'<td><input type="text" class="url"></td></tr>'+'</tr></table>'+'<table class="www_table"><tr>'+'<td class="www_label">Display Name:</td>'+'<td><input type="text" class="description"></td>'+'</tr></table>'},init_component:function()
{var cookie=getCookie("last_attachment_type");if(!cookie||(cookie=="local"&&!SG.globals.preferences.support_local_storage))
cookie="upload";this.current_tab=cookie;},render:function()
{this.add_event(this.container,'click',this.on_click);var cfg={tabs:this.render_tabs(),current_tab:this.render_current_tab()};if(this.close_callback){cfg.close='<img class="close" src="/images/close_overlay_x.png">';}
this.container.update(this.templates.body.apply(cfg));},render_tabs:function()
{var num_tabs=0;var h='';var cfg;cfg={name:'upload',display_name:'Upload',icon_class:'icon_uploaded_file',selected:(this.current_tab=="upload")?"selected":""};h+=this.templates.tab.apply(cfg);num_tabs++;if(SG.globals.preferences.support_local_storage){cfg={name:'local',display_name:'Link to Local',icon_class:'icon_linked_file',selected:(this.current_tab=="local")?"selected":""};h+=this.templates.tab.apply(cfg);num_tabs++;}
cfg={name:'www',display_name:'Web Link',icon_class:'icon_web',selected:(this.current_tab=="www")?"selected":""};h+=this.templates.tab.apply(cfg);num_tabs++;var cfg={num_tabs:num_tabs,tabs:h};return this.templates.tabs.apply(cfg);},render_current_tab:function()
{return this["render_"+this.current_tab].call(this);},render_upload:function()
{this.upload_count=0;var input=this.render_upload_input();var h=this.templates.form.apply({inputs:input});if(this.url_field){}else if(sg_has_multi_upload()){h+='<span class="fake_link upload_more">[+] Add more files</span>';}else{h+='<span class="fake_link upload_more">[+] Add another file</span>';h+=this.templates.upload_single_only.apply();}
return h;},render_upload_input:function()
{this.upload_count++;var multiple="";var name='upload_'+this.upload_count;var trash='&nbsp';if(!this.url_field){trash=this.templates.upload_trash.apply();}
if(!this.url_field&&sg_has_multi_upload()){name+='[]';multiple='multiple="true"';}
return this.templates.upload_input.apply({name:name,multiple:multiple,trash:trash});},render_local:function()
{if(sg_has_localfile_applet()){var copy='Select files on the studio\'s file system to create links to those files.';if(this.url_field)
copy='Select a file on the studio\'s file system to create links to that file.';return this.templates.form.apply({})+this.templates.local.apply({copy:copy});}else{return this.templates.local_unsupported.apply();}},render_www:function()
{return this.templates.form.apply({})+this.templates.www.apply();},on_click:function(e)
{var target=Ext.get(e.getTarget());var h;var tab=target.findParent('td.tab');if(tab){if(this.current_tab==tab.getAttribute("name"))return;if(this.ready()){var msg="By switching tabs you'll lose the information on the current tab. Aiight?";if(!confirm(msg))return;}
var cur_tab=this.container.child('td.tab[name="'+this.current_tab+'"]');cur_tab.removeClass("selected");Ext.fly(tab).addClass("selected");this.current_tab=tab.getAttribute("name");setCookie("last_attachment_type",this.current_tab,365);var details=this.container.child('div.details');details.update(this.render_current_tab());return;}
var browse_local=target.findParent('input.browse_local');if(browse_local){var a=Ext.get('sg_java_localfile');var pl=this.container.child('table.path_list').dom.firstChild;var paths,local_trash='&nbsp;';if(a&&pl){a=a.dom;if(this.url_field){a.pickFileOrDirectory();paths=[a.singleResult];}else{a.pickFilesAndDirectories();paths=a.multiResult;}
var path,name;if(paths.length==1&&!String(paths[0]))
return;for(var i=0;i<paths.length;i++){path=String(paths[i]);name=SG.Renderers.local_storage.strip_path(path);if(!this.url_field)
trash=this.templates.local_trash.apply();h=this.templates.local_path.apply({name:name,path:path});Ext.DomHelper.insertFirst(pl,h);}}
return;}
var local_remove=target.findParent('img.local_remove',5,true);if(local_remove){var local_row=local_remove.findParent('tr.local_row',5,true);local_row.remove();return;}
var upload_more=target.findParent('span.upload_more',5,true);if(upload_more){h=this.render_upload_input();var form=this.container.child('form',true);Ext.DomHelper.insertHtml('beforeend',form,h);return;}
var upload_remove=target.findParent('img.upload_remove',5,true);if(upload_remove){var upload_row=upload_remove.findParent('table.upload_row',5,true);upload_row.remove();return;}
var close=target.findParent('img.close');if(close){this.fire_close_callback();}},fire_done_callback:function(attachments,url_field){if(this.done_callback){this.done_callback.fn.call(this.done_callback.scope,attachments,url_field);}},fire_close_callback:function(){if(this.close_callback){this.close_callback.fn.call(this.close_callback.scope,this.container);}},fire_error_callback:function(){if(this.error_callback){this.error_callback.fn.call(this.error_callback.scope);}},ready:function(){return this["ready_"+this.current_tab].call(this);},ready_upload:function(){var els=sg_find_all('input.upload',this.container.dom);for(var i=0;i<els.length;i++){if(els[i].value!="")
return true;}
return false;},ready_local:function(){var els=sg_find_all('tr.local_row',this.container.dom);return(els.length>0);},ready_www:function(){var el=sg_find('input.url',this.container.dom);return(el&&el.value.strip()!="");},not_ready_error:function(){if(this.current_tab=="www"){return"'URL'";}else{return"'File for attachment'";}},submit:function(fv){this.upload_pi=null;return this["submit_"+this.current_tab].call(this,fv);},submit_upload:function(fv){var field_values,req,reqs=[];var els=sg_find_all('input.upload',this.container.dom);var i,j,el;var form=this.container.child('form');var requests_input=form.child('input[name="requests"]');for(var i=0;i<els.length;i++){el=els[i];if(el.value=="")
continue;req={request_type:"create",type:"Attachment",columns:["this_file"],field_values:fv,upload_value_form_parameter:el.name.replace("[]",""),entity_data_field_parameter:"uploaded_data"};if(el.files){for(j=0;j<el.files.length;j++){req=sg_deep_copy(req);req.upload_value_form_index=j;reqs.push(req);}}else{reqs.push(req);}}
if(reqs.length===0){this.fire_done_callback();}else{SG.globals.attachment_control=this;var upload_progress_id=Math.floor(Math.random()*1000000);form.dom.action="/crud/requests?X-Progress-ID="+upload_progress_id;job={job_id:upload_progress_id,job_type:'file_upload'};this.upload_pi=new SG.ProgressIndicator(null,'det','Uploading Files...');this.upload_pi.show();this.upload_pi.start_updates_for_job(job);requests_input.dom.value=Ext.encode(reqs);form.dom.submit();}},submit_local:function(fv){var field_values,req,reqs=[];var els=sg_find_all('tr.local_row',this.container.dom);var form=this.container.child('form');var requests_input=form.child('input[name="requests"]');for(var i=0;i<els.length;i++){field_values=sg_deep_copy(fv);field_values.push({column:"attachment_type",value:"local_storage"});field_values.push({column:"source",value:els[i].getAttribute("path")});req={request_type:"create",type:"Attachment",columns:["this_file"],field_values:field_values};reqs.push(req);}
if(reqs.length===0){this.fire_done_callback();}else{SG.globals.attachment_control=this;requests_input.dom.value=Ext.encode(reqs);form.dom.action="/crud/requests";form.dom.submit();}},submit_www:function(fv){var field_values,req,reqs=[];var url_el=sg_find('input.url',this.container.dom);var desc_el=sg_find('input.description',this.container.dom);var form=this.container.child('form');var requests_input=form.child('input[name="requests"]');field_values=sg_deep_copy(fv);field_values.push({column:"attachment_type",value:"http_url"});var url_val=url_el.value;if(!url_val.match("://"))
url_val="http://"+url_val;field_values.push({column:"source",value:url_val});if(desc_el&&desc_el.value.strip()!="")
field_values.push({column:"display_name",value:desc_el.value});req={request_type:"create",type:"Attachment",columns:["this_file"],field_values:field_values};reqs.push(req);if(reqs.length===0){this.fire_done_callback();}else{SG.globals.attachment_control=this;requests_input.dom.value=Ext.encode(reqs);form.dom.action="/crud/requests";form.dom.submit();}},submit_done:function(responses){if(SG.Repo.throw_crud_error(responses)){SG.globals.attachment_control=null;if(this.upload_pi)
this.upload_pi.hide();this.fire_error_callback();return;}
var attachments;try{attachments=[];for(var i=0;i<responses.length;i++)
attachments.push(responses[i].row[1]);}catch(e){attachments=null;}
SG.globals.attachment_control=null;if(this.upload_pi)
this.upload_pi.hide();this.fire_done_callback(attachments,this.url_field);}});SG.LocalStorage=function(config)
{Ext.apply(this,config);SG.LocalStorage.superclass.constructor.call(this);};Ext.extend(SG.LocalStorage,SG.Component,{templates:{body:'<div class="sgc_local_storage">{add}{storages}</div>',add:'<div><span class="add">[+] Add Local File Storage</span></div>',storages:'<div class="storages"><i>Loading...</i></div>',storage:'<div class="storage" record_id="{record_id}">'+'<div class="head">'+'<div class="code_field">{code_field}</div>'+'<div class="trash"></div></div>'+'<div class="body">{fields}</div></div>',field:'<div class="field"><table><tr><td class="field_name">'+'<img src="/images/logo_{sos}_16.png">&nbsp;&nbsp;{display_name}</td>'+'<td style="{cell_styles}" class="field_value {cell_classes}" {cell_attributes}>'+'{cell_content}</td></tr></table></div>',code_field:'<div style="{cell_styles}" class="field_value {cell_classes}" {cell_attributes}>'+'{cell_content}</div>'},init_component:function()
{this.dirty=false;this.data_set=this.new_data_set('LocalStorage',this.on_data_load,this.on_data_change);this.on_first_render();},on_first_render:function()
{this.add_event(this.container,'click',this.on_click);this.edit_container=this.container.findParent('.sg_scroll_container',50,true)||this.container;var cfg={add:this.templates.add.apply(),storages:this.templates.storages.apply()};this.container.update(this.templates.body.apply(cfg));this.storages_elem=this.container.child('div.storages');var cell_config={container:this.container,edit_container:this.edit_container,in_form:true,data_set:this.data_set,projects:[]};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.read_data();},render:function()
{var rec,h='';for(var i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);h+=this.render_storage(rec)}
this.storages_elem.update(h);},render_storage:function(rec)
{var cell,cell_hash,cf,h='';var fields=["linux_path","mac_path","windows_path"];var sos_hash={windows_path:'win',linux_path:'linux',mac_path:'mac'};cell=this.cell_manager.get_cell('code');cell_hash=cell.render(rec);cell_hash.display_name="Name";cf=this.templates.code_field.apply(cell_hash);for(var i=0;i<fields.length;i++){cell=this.cell_manager.get_cell(fields[i]);cell_hash=cell.render(rec);cell_hash.display_name=cell.get_field_display_name();cell_hash.sos=sos_hash[fields[i]];h+=this.templates.field.apply(cell_hash);}
return this.templates.storage.apply({code_field:cf,fields:h,record_id:rec.get_id()});},read_data:function()
{this.dirty=false;var spec={type:'LocalStorage',filters:{logical_operator:"and",conditions:[]},columns:['code','windows_path','mac_path','linux_path'],sorts:[{column:'created_at',direction:'desc'}],result:this.data_set};SG.Repo.query(spec);},on_data_load:function()
{this.render();},on_data_change:function(changes)
{var c=changes[0];if(c.type=="update"&&c.state=="pending"){this.set_dirty();return;}},on_click:function(e)
{var target=Ext.get(e.getTarget());var add=target.findParent('span.add');if(add){var rec=this.data_set.new_record();var shtml=this.render_storage(rec);Ext.DomHelper.insertFirst(this.storages_elem,shtml);this.set_dirty();return;}
var trash=target.findParent('div.trash');if(trash){var msg="Careful!  Any linked files on deleted storages will become unavailable.  Do you want to continue?";var storage=target.findParent('div.storage',10,true);var rec_id=storage.dom.getAttribute("record_id");var rec=this.data_set.get_record_by_id(rec_id);if(rec.get_id()<0||confirm(msg)){rec.retire();this.set_dirty();storage.remove();}}},set_dirty:function()
{this.dirty=true;this.dirty_callback.fn.call(this.dirty_callback.scope);},save:function()
{this.data_set.commit();},validate:function(success_fn,fail_fn)
{var i,code,rec;var used_names={};var deletes=[];for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);code=rec.get('code')||"";code=code.strip();if(rec.get_state()=='retired'){}else if(code==""){fail_fn.call(this,"Please supply a name for all Local File Storages, then Save again.");return;}else if(used_names.hasOwnProperty(code)){fail_fn.call(this,"The name '"+code+"' has been used multiple times. "+"Please supply a unique name for all Local File Storages, then Save again.");return;}
used_names[code]=true;}
success_fn.call(this);}});SG.ColumnBrowserColumn=function(config)
{Ext.apply(this,config);SG.ColumnBrowserColumn.superclass.constructor.call(this,config);};Ext.extend(SG.ColumnBrowserColumn,SG.Component,{templates:{main:'<div class="fields"></div><div class="entities"></div>',field:'<div index="{index}" class="field {selected} {extra_class}">{field_label}</div>',entity:'<div class="entity {selected}" entity_type="{entity_type}" entity_id="{entity_id}" '+'entity_name="{entity_name}">{entity_display_name}</div>',},init_component:function()
{this.container.update(this.templates.main.apply());this.fields_div=this.container.child('div.fields');this.entities_div=this.container.child('div.entities');this.add_event(this.fields_div,'click',this.on_fields_div_click);this.add_event(this.fields_div,'dblclick',this.on_fields_div_dblclick);this.add_event(this.entities_div,'click',this.on_entities_div_click);this.add_event(this.entities_div,'dblclick',this.on_entities_div_dblclick);this.schema_fields=this.get_schema_fields();this.selected_field_index=-1;this.render_fields();},render_fields:function()
{var html='';for(var i=0;i<this.schema_fields.length;i++)
{var schema_field=this.schema_fields[i];html+=this.templates.field.apply({field_label:this.render_field_label(schema_field),index:i,extra_class:schema_field.entity_type==this.entity_type?'':'inverse',selected:this.selected_field_index==i?'selected':'',});}
this.fields_div.update(html);},render_field_label:function(schema_field)
{if(schema_field.entity_type==this.entity_type)
return schema_field.display_name;else
{var edn=SG.schema.entity_types[schema_field.entity_type]['display_name_pluralized'];var sdn=schema_field.display_name;var re=new RegExp(this.entity_type,'gi');if(sdn.match(re))
return edn;else
return edn+" ("+schema_field.display_name+")";}},on_fields_div_click:function(e)
{var t=Ext.get(e.getTarget());var fields_div=t.findParent('div.field',this.fields_div,true);if(fields_div)
{this.select_field_div(fields_div);this.entity_selected_callback.fn.call(this.entity_selected_callback.scope,this,null);this.fetch_entities();}},select_field_div:function(div)
{if(div.hasClass('selected'))
return;if(this.selected_field_index!=-1)
{var last_field_div=this.fields_div.child('div.field[index="'+this.selected_field_index+'"]');last_field_div.removeClass('selected');}
div.addClass('selected');this.selected_field_index=Number(div.dom.getAttribute('index'));},on_fields_div_dblclick:function(e)
{var t=Ext.get(e.getTarget());var fields_div=t.findParent('div.field',this.fields_div,true);if(fields_div)
{this.select_field_div(fields_div);var schema_field=this.schema_fields[this.selected_field_index];if(schema_field.entity_type==this.entity_type)
return;var cond={path:schema_field.name,relation:schema_field.data_type=='multi_entity'?'includes':'is',values:[this.entity]};var edn=SG.schema.entity_types[schema_field.entity_type]['display_name_pluralized'];var focus_context={entity:this.entity,entity_type:schema_field.entity_type,filters:{logical_operator:"and",conditions:[cond]},title:edn+" where "+schema_field.display_name+" "+cond.relation+" "+this.entity.name,reset_stack:true,};var page=this.get_parent_widget().get_page();page.get_focus_window().open(focus_context);}},on_entities_div_click:function(e)
{var t=Ext.get(e.getTarget());var entity_div=t.findParent('div.entity',this.entities_div,true);if(entity_div)
{if(entity_div.hasClass('selected'))
return;var last_selected_div=this.entities_div.child('div.entity.selected');if(last_selected_div)last_selected_div.removeClass('selected');entity_div.addClass('selected');var entity={type:entity_div.dom.getAttribute('entity_type'),id:entity_div.dom.getAttribute('entity_id'),name:entity_div.dom.getAttribute('entity_name'),};var schema_field=this.schema_fields[this.selected_field_index];this.entity_selected_callback.fn.call(this.entity_selected_callback.scope,this,schema_field,entity);}},on_entities_div_dblclick:function(e)
{var t=Ext.get(e.getTarget());var entity_div=t.findParent('div.entity',this.entities_div);if(entity_div)
{var page=this.widget.get_page();var entity_type=entity_div.getAttribute('entity_type');var entity_id=entity_div.getAttribute('entity_id');var entity_name=entity_div.getAttribute('entity_name');page.root_widget.show_entity_detail(entity_type,entity_id,entity_name);}},fetch_entities:function()
{this.pi=new SG.ProgressIndicator(this.entities_div);this.pi.show();if(this.data_set)
this.data_set.destroy();var schema_field=this.schema_fields[this.selected_field_index];this.data_set=new SG.Data.Set(schema_field.entity_type);var is_field_on_entity=this.entity_type==schema_field.entity_type;if(is_field_on_entity)
{this.data_set.on('load',this.render_field_entities,this);var spec={type:this.entity.type,id:this.entity.id,columns:[schema_field.name],result:this.data_set};SG.Repo.find(spec);}
else
{this.data_set.on('load',this.render_data_set_entities,this);var cond={path:schema_field.name,relation:'is',values:[this.entity]};var filters={logical_operator:"and",conditions:[cond]};var spec={type:schema_field.entity_type,filters:filters,columns:SG.schema.entity_types[schema_field.entity_type]["fields_sorted_by_display_name"],result:this.data_set,current_page:1,records_per_page:50,};SG.Repo.query(spec);}},render_data_set_entities:function()
{this.pi.hide();var ident_field=SG.schema.get_identifier_field(this.data_set.type);var html='';for(i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);var value_hash={valid:'valid',type:this.data_set.type,name:rec.get(ident_field)};html+=this.templates.entity.apply({selected:'',entity_type:this.data_set.type,entity_id:rec.id,entity_name:value_hash.name,entity_display_name:SG.Renderers.render_one_nodetail_entity(value_hash)});}
this.entities_div.update(html);},render_field_entities:function()
{this.pi.hide();var record=this.data_set.get_record(0);if(!record)return;var schema_field=this.schema_fields[this.selected_field_index];var html='';if(schema_field.data_type=='entity')
{var entity=record.get(schema_field.name);if(entity)
{html+=this.templates.entity.apply({selected:'',entity_type:entity.type,entity_id:entity.id,entity_name:entity.name,entity_display_name:SG.Renderers.render_one_nodetail_entity(entity)});}}
else
{var entities=record.get(schema_field.name);if(entities)
{for(var i=0;i<entities.length;i++)
{var entity=entities[i];html+=this.templates.entity.apply({selected:'',entity_type:entity.type,entity_id:entity.id,entity_name:entity.name,entity_display_name:SG.Renderers.render_one_nodetail_entity(entity)});}}}
this.entities_div.update(html);},get_schema_fields:function()
{var ret=[];var entity_type,field_name,schema_fields,schema_field;var schema_fields=SG.schema.entity_fields[this.entity_type];var entity_types=SG.schema.leftnav_page_entity_types;for(var i=0;i<entity_types.length;i++)
{entity_type=entity_types[i];if(entity_type==this.entity_type)continue;schema_fields=SG.schema.entity_fields[entity_type];for(field_name in schema_fields)
{if(!schema_fields.hasOwnProperty(field_name))continue;schema_field=schema_fields[field_name];if(['entity','multi_entity'].indexOf(schema_field.data_type)==-1)continue;if(!schema_field.allowed_entity_types)continue;if(schema_field.allowed_entity_types.indexOf(this.entity_type)!=-1)
ret.push(schema_field);}}
return ret;},destroy_component:function()
{this.container.remove();},});SG.QuickLink=function(config)
{Ext.apply(this,config);SG.QuickLink.superclass.constructor.call(this,config);};Ext.extend(SG.QuickLink,SG.Component,{templates:{main:'<div class="sgc_quick_link">'+'<div class="input_container" style="display:block;">'+'<div class="left quick_filter_left"></div>'+'<input type="text" value="{text}"></input>'+'<div class="right quick_filter_right"></div><div class="floater clear"></div>'+'<div class="advanced"><span class="fake_link advanced">Advanced...</span></div>'+'</div></div>',autocomplete_results_link:' (<div class="sg_entity_icon_span {icon_name}">'+'</div>{name})'},show:function()
{var me=this;setTimeout(function(){me.render();},0)},render:function()
{this.container=this.templates.main.append(document.body,{text:''});this.container=Ext.get(this.container);if(this.align_to)
{this.container.alignTo(this.align_to.dom_elem,this.align_to.dialog_anchor+"-"+this.align_to.elem_anchor+"?");}
this.floater=this.container.child('div.floater');this.input=this.container.child('input');this.setup_autocomplete();this.add_event(document.body,'click',this.on_document_click);this.add_event(this.container,"click",this.on_click);this.add_event(this.input,"keydown",this.on_keydown);this.input.focus();if(!this.shadow&&!this.non_volatile)
this.shadow=new Ext.Shadow({mode:'sides'});if(this.shadow)
this.shadow.show(this.container);},setup_autocomplete:function()
{this.project=this.widget.single_project_from_context();if(this.entity_type)
this.setup_listbox([this.entity_type]);else
this.setup_listbox(this.get_all_quick_jump_entity_types());},setup_listbox:function(entity_types)
{this.current_entity_types=entity_types;if(!this.listbox)
{this.listbox=new SG.ListBox({items:[{disabled:true,html:'Jump to something by typing its name'}],position:{dom_elem:this.input.dom,elem_anchor:"bl",menu_anchor:"tl"},autocomplete:{input_dom:this.input.dom,prompt_html:'Jump to something by typing its name',request_url:SG.globals.urls.entity_autocomplete,parameters_callback:{fn:this.request_params,scope:this},response_callback:{fn:this.on_autocomplete_response,scope:this},selection_callback:{fn:this.entity_selected,scope:this},close_on_blur:true}});}
this.listbox.render();},request_params:function(search_text)
{this.show_autocomplete_spinner();var request_params={query:search_text,sg_autocomplete:true};request_params.complete_classes=Ext.encode(SG.schema.convert_entity_types_for_autocomplete(this.current_entity_types));if(this.project)
request_params.project_ids=Ext.encode([this.project.id]);return request_params;},icon_name_for_entity:function(entity_hash)
{var icon_name='icon_'+entity_hash.type;if(entity_hash.type==="HumanUser"&&entity_hash.status==="dis")
icon_name="icon_HumanUserDisabled";return icon_name;},on_autocomplete_response:function(response)
{this.hide_autocomplete_spinner();var matches=response.matches;var search_terms=response.terms;var items=[];for(var i=0;i<matches.length;i++)
{var icon_name=this.icon_name_for_entity(matches[i]);var entity_html=this.highlight_search_terms(search_terms,matches[i].name);if(matches[i].subtype)
entity_html+=" - "+matches[i].subtype;if(matches[i].type!=='HumanUser'&&matches[i].status)
{entity_html+=" "+SG.Renderers.render_one_status_icon(matches[i].status);}
if(matches[i].type!='Project'&&matches[i].project_id)
{var project=SG.schema.project_by_id(matches[i].project_id);if(project)
entity_html+=' - '+project.name;}
var links_str='';linked_data_types=['HumanUser','ApiUser','Ticket','Delivery']
if(SG.globals.custom_for=="shotgun")
linked_data_types.push('ZendeskTicket')
if(linked_data_types.indexOf(matches[i].type)>-1)
entity_html+=' ('+this.highlight_search_terms(search_terms,matches[i].links[1])+')';else
{if(matches[i].links[1]!=='')
{entity_html+=this.templates.autocomplete_results_link.apply({icon_name:"icon_"+matches[i].links[0],name:this.highlight_search_terms(search_terms,matches[i].links[1])});}}
items.push({icon_name:icon_name,html:entity_html,value:matches[i]});}
return items;},highlight_search_terms:function(search_terms,result)
{var result_lc=result.toLowerCase();var idx,term,indices=[];for(var i=0;i<search_terms.length;++i)
{term=search_terms[i];idx=result_lc.indexOf(term);if(idx!==-1){indices.push([idx,idx+term.length-1]);}}
indices.sort(function(a,b){return a[0]-b[0];});if(indices.length>0)
{var combined_indices=[];var low=indices[0][0];var high=indices[0][1];idx=0;while(idx<indices.length)
{if(idx===indices.length-1)
{high=indices[idx][1];combined_indices.push([low,high]);}
else if(indices[idx][1]>=indices[idx+1][0])
{high=indices[idx+1][1];}
else
{combined_indices.push([low,high]);low=indices[idx+1][0];high=indices[idx+1][1];}
idx+=1;}
var ret=result.substring(0,combined_indices[0][0]);for(var i=0;i<combined_indices.length;++i)
{ret+='<match>'+result.substring(combined_indices[i][0],combined_indices[i][1]+1)+'</match>';if(i!==combined_indices.length-1&&combined_indices[i][1]+1<combined_indices[i+1][0])
{ret+=result.substring(combined_indices[i][1]+1,combined_indices[i+1][0]);}}
ret+=result.substring(combined_indices[combined_indices.length-1][1]+1,result.length);return ret;}
else
return result;},on_document_click:function(e)
{var t=Ext.get(e.getTarget());var sg_menu_item=t.findParent('div.sg_menu_item',4);if(sg_menu_item)
return;var container=t.findParent('div.sgc_quick_link');if(!container)
this.cancel();},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.hasClass('floater')&&t.hasClass('clear'))
{this.clear_input();return;}
if(t.hasClass('advanced'))
{this.show_linking_focus_window();}},__hide:function()
{if(this.shadow)
this.shadow.hide();this.listbox.hide();this.container.addClass('hidden');this.listbox.cancel();this.destroy_events();},destroy_component:function()
{if(this.shadow)
this.shadow.hide();this.listbox.hide();this.container.addClass('hidden');this.listbox.cancel();},on_keydown:function(e)
{var key=e.getKey();if(key==e.ESC)
{if(this.input.dom.value=='')
{this.cancel();e.stopEvent();}
else
{this.clear_input();e.stopEvent();}}},clear_input:function()
{this.input.dom.value='';this.listbox.autocomplete_request();this.input.addClass('ready');this.input.focus();},cancel:function()
{this.destroy();if(this.on_cancel)
this.on_cancel.fn.call(this.on_cancel.scope);},get_all_quick_jump_entity_types:function()
{var types=SG.globals.preferences.quick_jump_entities.replace(/ /g,'');types=types.split(',');var all_types=SG.schema.leftnav_page_entity_types;ret=[];for(var i=0;i<all_types.length;i++)
if(types.indexOf(all_types[i])>-1)
ret.push(all_types[i]);return ret;},show_autocomplete_spinner:function()
{this.floater.removeClass('clear');this.floater.addClass('spinner');},hide_autocomplete_spinner:function()
{this.floater.removeClass('spinner');this.floater.addClass('clear');},entity_selected:function(item)
{this.link_entity({type:item.value.type,id:item.value.id,name:item.value.name,project_id:item.value.project_id});},link_entity:function(entity_hash)
{var config={request_type:"update",type:this.entity_type,id:entity_hash.id,column:this.link_field_to_parent,value:this.parent_entity};var schema_field=SG.schema.get_field(this.entity_type,this.link_field_to_parent);if(schema_field&&schema_field.data_type=='multi_entity')
{config.value=[this.parent_entity];config.multi_entity_update_mode='add';}
var me=this;var container=null;if(this.overlay_container)
container=Ext.get(this.overlay_container);var pi=new SG.ProgressIndicator(container);var resp=new SG.ResponseHandler();resp.handle_response=function(response,request)
{pi.hide();if(response.status==='successful')
{me.entity_linked(entity_hash);}
else
{var sed=SG.server_error({html_msg:"Server error - couldn't link the entity.",connection_response:response});}};pi.show();var req=new SG.CrudRequest(config,resp);req.send();if(this.reset_after_linking)
{this.clear_input();}},entity_linked:function(entity_hash)
{if(!this.reset_after_linking)
this.destroy();if(this.on_link)
this.on_link.fn.call(this.on_link.scope,entity_hash);},show_linking_focus_window:function()
{this.__hide();var filters={logical_operator:'and',conditions:[]};var project=this.widget.single_project_from_context();if(project)
{filters.conditions.push({conditions:[{active:true,path:'project',relation:'is',values:[project]}],logical_operator:'and'});}
filters.conditions.push({logical_operator:'and',conditions:[]});var context={entity:this.parent_entity,entity_type:this.entity_type,entity_project:project,link_to:[this.parent_entity],link_fields:[this.link_field_to_parent],on_linked_callback:{fn:this.entity_linked_advanced,scope:this},filters:filters,title:'Link '+SG.schema.entity_types[this.entity_type].display_name_pluralized+" to Playlist "+this.parent_entity.name,reset_stack:true,on_link_no_undo:this.on_link_no_undo};this.get_page().get_focus_window().open(context);},entity_linked_advanced:function(entity_hash)
{this.get_page().get_focus_window().close();this.destroy();if(this.on_multi_link)
this.on_multi_link.fn.call(this.on_multi_link.scope);else if(this.on_link)
this.on_link.fn.call(this.on_link.scope,null);},});SG.QuickFilter=function(config)
{Ext.apply(this,config);SG.QuickFilter.superclass.constructor.call(this,config);};Ext.extend(SG.QuickFilter,SG.Component,{templates:{button:'<div class="sgc_quick_filter_button"><div class="icon_search"></div></div>',filter_bar:'<div class="quick_filter_input_container">'+'<div class="quick_filter">{quick_filter}</div></div>',quick_filter:'<div class="quick_search_input"><div class="left quick_jump_left"></div>'+'<div class="quick_search_prompt"></div>'+'<input type="text" value="" class="quick_filter"></input>'+'<div class="right quick_filter_right"></div><div class="clear"></div></div>',},filterable_field_data_types:['text','entity','multi_entity','list','status_list','system_task_type','number'],field_properties_schema:[{property_name:'selected',data_type:'boolean',display_name:'Filter on this field by default',default_value:false}],init_component:function(){this.calculate_priority_fields();this.fields=sg_deep_copy(this.priority_fields);this.all_priority_fields_selected=true;this.current_filter=this.filter_input_value;this.retrieve_settings_from_widget();this.rendered=false;},render:function()
{if(!this.container)
this.setup_container();this.render_button();this.render_quick_filter_bar();if(!this.dont_update_widget_positions&&this.widget&&this.widget.update_dynamically_detected_positions)
this.widget.update_dynamically_detected_positions();this.rendered=true;},render_button:function()
{var html=this.templates.button.apply({});var button_container=this.get_button_container();if(button_container)button_container.update(html);},get_button_container:function()
{if(this.button_container){return this.button_container;}else{var button=sg_find('#'+this.button_id,document.body);return Ext.get(button);}},render_quick_filter_bar:function()
{if(!this.showing){this.container.update('');this.container.removeClass('visible');return;}
this.container.addClass('visible');var html=this.templates.filter_bar.apply({quick_filter:this.templates.quick_filter.apply()});this.container.update(html);var quick_filter_input=this.get_quick_filter_input();if(this.inital_filter_value){quick_filter_input.dom.value=this.inital_filter_value;this.inital_filter_value=null;}
this.set_unfocused_prompt();this.add_event(quick_filter_input,'focus',this.on_focus);this.add_event(quick_filter_input,'blur',this.on_blur);this.add_event(quick_filter_input,'keydown',this.on_keydown);},setup_container:function()
{var container=sg_find('#'+this.container_id,document.body);this.container=Ext.get(container);this.container.addClass('sgc_quick_filter');if(this.current_filter){this.showing=true;this.inital_filter_value=this.current_filter;}
if(!this.external_button_click_handler){this.button_container=this.get_button_container();this.add_event(this.button_container,'click',this.toggle_quick_filter_showing);}
this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);},destroy_component:function(){},toggle_quick_filter_showing:function()
{this.showing=!this.showing;var me=this;setTimeout(function(){me.render();if(me.after_toggle_show)
me.after_toggle_show.fn.call(me.after_toggle_show.scope,me.showing);if(me.showing)
me.focus_quick_filter();},0);},on_click:function(e)
{var t=Ext.get(e.getTarget());var clear=t.findParent('div.clear',this.container,true);if(clear)
{this.clear_filters();return;}
var menu_arrow=t.findParent('div.quick_jump_left',this.container,true);if(menu_arrow){if(this.more_fields_menu&&this.more_fields_menu.is_showing())
this.more_fields_menu.hide();else
this.show_more_fields_menu(menu_arrow);return;}},update_widget:function(filters){this.quick_filter_callback.fn.call(this.quick_filter_callback.scope,filters);if(this.set_settings_callback){this.set_settings_callback.fn.call(this.set_settings_callback.scope,'quick_filter_settings',{fields:this.fields,search_text:this.current_filter,all_priority_fields_selected:this.all_priority_fields_selected});}},retrieve_settings_from_widget:function(){if(this.get_settings_callback){var settings=this.get_settings_callback.fn.call(this.get_settings_callback.scope,'quick_filter_settings');if(settings){this.current_filter=settings.search_text;this.all_priority_fields_selected=settings.all_priority_fields_selected;this.calculate_priority_fields();if(this.all_priority_fields_selected){this.fields=sg_deep_copy(this.priority_fields);}else{var fields=settings.fields||[];this.fields=[];for(var i=0;i<fields.length;i++){schema_field=SG.schema.get_field(this.entity_type,fields[i]);if(schema_field&&!this.quick_filter_field_not_filterable(schema_field)){this.fields.push(fields[i]);}}}}}},on_change:function(e)
{var quick_filter_input=this.container.child('input.quick_filter');var filters=this.set_current_filter(quick_filter_input.dom.value);this.update_widget(filters);if(document.activeElement===quick_filter_input.dom)
quick_filter_input.dom.select();},quick_filter_field_not_filterable:function(schema_field)
{return(this.filterable_field_data_types.indexOf(schema_field.data_type)==-1||schema_field['no_filtering']||!schema_field['grid_column']);},set_filters:function()
{var filter_value;var quick_filter_input=this.get_quick_filter_input();if(quick_filter_input)
filter_value=quick_filter_input.dom.value;else
filter_value=this.current_filter;var filters=this.set_current_filter(filter_value);this.update_widget(filters);},clear_search_text:function(){if(this.container){var quick_filter_input=this.container.child('input.quick_filter');quick_filter_input.dom.value='';}
this.current_filter=null;},clear_filters:function(){this.clear_search_text();var empty={conditions:[],logical_operator:'or'};this.update_widget(empty);this.focus_quick_filter();},set_current_filter:function(filter_string){if(this.all_priority_fields_selected){this.calculate_priority_fields();this.fields=sg_deep_copy(this.priority_fields);}
this.current_filter=filter_string;if(!this.current_filter)
return{conditions:[],logical_operator:'or'}
var quick_cond=[];var filter_text_values=filter_string.split(',');for(var i=0;i<filter_text_values.length;i++)
{var search_string=filter_text_values[i];var cond=this.generate_filters_for_search_string(search_string);if(cond)
quick_cond.push(cond);}
return({conditions:quick_cond,logical_operator:'or'});},generate_filters:function()
{var quick_filter_input=this.container.child('input.quick_filter');return this.set_current_filter(quick_filter_input.dom.value);},generate_filters_for_search_string:function(search_string){var filter_operators={text:'contains',entity:'name_contains',multi_entity:'name_contains',list:'contains',status_list:'contains',system_task_type:'contains','number':'is'};var search_string_clean=search_string.replace(/^\s+|\s+$/g,'');if(search_string_clean==='')
return null;var words=search_string_clean.split(' ');var search_string_conditions=[];for(var i=0;i<words.length;i++)
{var word=words[i];if(word.length==0)
continue;var word_conditions=[];for(var j=0;j<this.fields.length;j++)
{var field_path=this.fields[j];var data_type=SG.schema.get_field(this.entity_type,field_path).data_type;if(data_type=='number'&&(isNaN(word)||word.match(/\.\d+/)||word.match(/\d\./)))
{word_conditions.push({logical_operator:'and',conditions:[{active:true,path:field_path,relation:'is',values:['1']},{active:true,path:field_path,relation:'is',values:['0']}]});continue;}
word_conditions.push({active:true,path:field_path,relation:filter_operators[data_type],values:[word]});}
if(word_conditions.length>0)
search_string_conditions.push({logical_operator:'or',conditions:word_conditions});}
return({conditions:search_string_conditions,logical_operator:'and'});},show_more_fields_menu:function(more_fields_control)
{if(!this.more_fields_menu)
this.more_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_more_fields_menu,scope:this},item_selected:{fn:this.on_more_fields_menu_click,scope:this}});this.more_fields_menu.position={dom_elem:more_fields_control,elem_anchor:'b',menu_anchor:'t'};this.more_fields_menu.show();},calculate_priority_fields:function(categorized_fields){var widget_fields;if(this.get_displayed_columns_callback){widget_fields=this.get_displayed_columns_callback.fn.call(this.get_displayed_columns_callback.scope);}else{if(!this.widget.get_content_widget){this.set_hard_coded_priority_fields(categorized_fields);return;}
widget_fields=this.widget.get_content_widget().get_custom_external_action_columns();}
this.priority_fields=[];var schema_field,i;for(i=0;i<widget_fields.length;i++){schema_field=SG.schema.get_field(this.entity_type,widget_fields[i]);if(schema_field&&!this.quick_filter_field_not_filterable(schema_field)&&['entity','multi_entity'].indexOf(schema_field.data_type)==-1)
{this.priority_fields.push(widget_fields[i]);}}
if(this.priority_fields.length===0)
this.set_hard_coded_priority_fields(categorized_fields);},hard_coded_priority_fields:['link','description','sg_description','content','subject','tag_list','tasks','note_links','step'],set_hard_coded_priority_fields:function(categorized_fields){if(!categorized_fields)
categorized_fields=SG.schema.get_categorized_fields(this.entity_type,false,false);var all_fields=categorized_fields.ordinary;this.priority_fields=[];var schema_field,i;for(i=0;i<all_fields.length;i++){schema_field=all_fields[i];if(schema_field&&!this.quick_filter_field_not_filterable(schema_field))
{if(schema_field.identifier_column||schema_field.data_type==='status_list'||this.hard_coded_priority_fields.indexOf(schema_field.name)>-1)
{this.priority_fields.push(schema_field.name);}}}},display_name:function(field_path,schema_field){if(this.column_display_names&&this.column_display_names[field_path])
return this.column_display_names[field_path];else
return SG.schema.get_field_display_name(this.entity_type,field_path,schema_field);},get_more_fields_menu_items:function(){var items=[];var schema_field,i;var categorized_fields=SG.schema.get_categorized_fields(this.entity_type,false,false);var all_fields=categorized_fields.ordinary;this.retrieve_settings_from_widget();if(this.priority_fields.length>0){items=[{html:"Keywords",value:"__all_priority_fields__",checked:this.all_priority_fields_selected},{line:true}];var text_items=[]
for(i=0;i<this.priority_fields.length;i++){schema_field=SG.schema.get_field(this.entity_type,this.priority_fields[i]);if(schema_field&&!this.quick_filter_field_not_filterable(schema_field)){text_items.push({html:this.display_name(this.priority_fields[i],schema_field),value:this.priority_fields[i],checked:this.all_priority_fields_selected||(this.fields.indexOf(schema_field.name)>-1),item_class:this.all_priority_fields_selected?'gray_checkmark':''});}}
if(text_items.length>0){this.sort_items(text_items);items=items.concat(text_items);}
items.push({line:true});}
var other_items=[];for(i=0;i<all_fields.length;i++){schema_field=all_fields[i];if(this.priority_fields.indexOf(schema_field.name)>-1)
continue;if(schema_field&&!this.quick_filter_field_not_filterable(schema_field)){other_items.push({html:this.display_name(schema_field.name,schema_field),value:schema_field.name,checked:(this.fields.indexOf(schema_field.name)>-1)});}}
if(other_items.length>0){this.sort_items(other_items);items=items.concat(other_items);}
if(categorized_fields.pivot_column_fields.length>0)
items=items.concat(this.get_pipeline_menu_items());return items;},on_before_show_more_fields_menu:function(menu)
{menu.items=this.get_more_fields_menu_items();menu.render();},sort_items:function(menu_items){menu_items.sort(function(a,b){a=a.html.toLowerCase();b=b.html.toLowerCase();return(a===b)?0:(a>b)?1:-1;});},get_pipeline_menu_items:function()
{var items=[];var fields=SG.schema.get_pipeline_order_fields(this.entity_type);var steps=SG.schema.get_pipeline_order_steps(this.entity_type);var i,step,field;var step_map={};for(i=0;i<steps.length;i++)
{var step=steps[i];var key='step_'+step.id;step_map[key]=step;}
var j,task_field,task_path,submenu_items;var task_fields=SG.schema.get_categorized_fields('Task',false,true).ordinary;items.push({heading:"PIPELINE"});for(i=0;i<fields.length;i++){field=fields[i];step=step_map[field.name];submenu_items=[];for(j=0;j<task_fields.length;j++){task_field=task_fields[j];if(task_field&&!this.quick_filter_field_not_filterable(task_field)){task_path=field.name+'.Task.'+task_field.name;submenu_items.push({html:task_field.display_name,value:task_path,checked:(this.fields.indexOf(task_path)>-1)});}}
items.push({html:field.display_name,icon_name:'transparent_step_color',icon_bg_color:step.color,submenu:{items:submenu_items}})}
return items;},on_more_fields_menu_click:function(menu,item)
{var field_path=item.value;if(field_path==='__all_priority_fields__'){if(!this.all_priority_fields_selected){this.all_priority_fields_selected=true;this.fields=sg_deep_copy(this.priority_fields);this.set_filters();this.focus_quick_filter();}
return;}
this.fields=[field_path];this.all_priority_fields_selected=false;this.set_filters();this.focus_quick_filter();},get_quick_filter_input:function()
{if(!this.container)return null;return this.container.child('input.quick_filter');},get_quick_filter_value:function()
{if(!this.showing)return null;var quick_filter_input=this.get_quick_filter_input();var value=quick_filter_input.dom.value;return value;},get_prompt_elem:function(){return this.container.child('div.quick_search_prompt');},on_focus:function(e){var me=this;setTimeout(function(){me.set_focused_prompt();me.get_quick_filter_input().dom.select();},0);},on_blur:function(e){if(!this.current_filter){var me=this;setTimeout(function(){me.set_unfocused_prompt();},0);}},on_keydown:function(e){if(e.getKey()===e.ESC){e.stopEvent();if(this.current_filter!==this.get_quick_filter_value()){this.get_quick_filter_input().dom.value=this.current_filter;return;}
var me=this;setTimeout(function(){me.blur_quick_filter();},100);return;}
if(this.prompt_showing){var me=this;setTimeout(function(){me.set_focused_prompt();});return;}},clear_prompt:function(){var prompt_elem=this.get_prompt_elem();prompt_elem.dom.innerHTML='';this.prompt_showing=false;},set_prompt_value:function(prompt_elem){var prompt='Search';if(!this.all_priority_fields_selected&&this.fields.length>0)
prompt='Search '+
this.display_name(this.fields[0],SG.schema.get_field(this.entity_type,this.fields[0]));prompt_elem.dom.innerHTML=prompt;this.prompt_showing=true;},update_prompt_value:function(){if(this.prompt_showing){var prompt_elem=this.get_prompt_elem();this.set_prompt_value(prompt_elem);}},set_unfocused_prompt:function(){var prompt_elem=this.get_prompt_elem();if(this.get_quick_filter_value()){this.clear_prompt();}else{this.set_prompt_value(prompt_elem);prompt_elem.removeClass('focused');}},set_focused_prompt:function(){var prompt_elem=this.get_prompt_elem();if(this.get_quick_filter_value()){this.clear_prompt();}else{this.set_prompt_value(prompt_elem);prompt_elem.addClass('focused');}},focus_quick_filter:function()
{var quick_filter_input=this.get_quick_filter_input();if(quick_filter_input)
quick_filter_input.focus();},blur_quick_filter:function()
{var quick_filter_input=this.get_quick_filter_input();if(quick_filter_input)
quick_filter_input.blur();},});SG.Popover=function(config){Ext.apply(this,config);SG.Popover.superclass.constructor.call(this);};SG.Popover.id_counter=0;Ext.extend(SG.Popover,SG.Component,{templates:{body:'<div class="sgc_popover {extra_class}" sgc_popover_id="{popover_id}">'+'<div class="sgc_popover_body"></div>'+'</div>'},init_component:function(){this.popover_id=String(SG.Popover.id_counter++);this.container=null;SG.PopoverObserver.add_popover(this);if(!this.mouseover_elem.dom){this.mouseover_elem=Ext.get(this.mouseover_elem);}
this.mouseover_elem.dom.setAttribute('sgc_popover_trigger',this.popover_id);},render:function(){if(!this.container)
this.on_first_render();if(this.on_render){this.on_render.fn.call(this.on_render.scope,this,this.body_dom);}else if(this.render_body){this.render_body(Ext.get(this.body_dom));}},on_first_render:function(){this.container=Ext.DomHelper.append(document.body,this.templates.body.apply({popover_id:this.popover_id,extra_class:this.extra_class}),true);this.body_dom=this.container.dom.firstChild;this.register_container_listeners();},register_container_listeners:function(){},is_visible:function(){return(this.container&&this.container.isVisible());},show:function(elem){this.mouseover_elem.addClass('popover_active');if(this.on_before_show)
this.on_before_show.fn.call(this.on_before_show.scope,this);if(!this.container)
this.render();this.container.show();this.container.alignTo(this.mouseover_elem,"t-b?");this.container.setX(this.container.getX()-5);},hide:function(){this.mouseover_elem.removeClass('popover_active');this.container.hide();},});SG.PopoverObserver={popovers:{},showing:null,initialized:false,over_states:{},delay:150,add_popover:function(popover){if(!this.initialized){this.initialized=true;var body=Ext.get(document.body);body.on('mouseover',this.on_mouseover,this);body.on('mouseout',this.on_mouseout,this);}
this.popovers[popover.popover_id]=popover;this.over_states[popover.popover_id]={button:false,overlay:false};},remove_popover:function(popover){delete this.popovers[popover.popover_id];},on_mouseover:function(e){var t=Ext.get(e.getTarget());this.update_over_states(t);for(var popover_id in this.over_states){if(!this.over_states.hasOwnProperty(popover_id))continue;var state=this.over_states[popover_id];var popover=this.popovers[popover_id];if(state.button&&!popover.is_visible()){var me=this;var pid=popover_id;setTimeout(function(){me.before_show_popover(pid)},this.delay);}}},before_show_popover:function(popover_id){var state=this.over_states[popover_id];if(!state.button)return;var popover=this.popovers[popover_id];popover.show();},on_mouseout:function(e){var t=Ext.get(e.getRelatedTarget());this.update_over_states(t);for(var popover_id in this.over_states){if(!this.over_states.hasOwnProperty(popover_id))continue;var state=this.over_states[popover_id];var popover=this.popovers[popover_id];if(popover.is_visible()&&!state.button&&!state.overlay){var me=this;var pid=popover_id;setTimeout(function(){me.before_hide_popover(pid)},this.delay);}}},before_hide_popover:function(popover_id){var state=this.over_states[popover_id];if(state.button||state.overlay)return;var popover=this.popovers[popover_id];popover.hide();},update_over_states:function(t){if(!t){this.set_all_states_to_false();return;}
for(var popover_id in this.over_states){if(!this.over_states.hasOwnProperty(popover_id))continue;var button=t.findParent('[sgc_popover_trigger="'+popover_id+'"]',50);var overlay=t.findParent('[sgc_popover_id="'+popover_id+'"]',50);this.over_states[popover_id]={button:button,overlay:overlay,};}},set_all_states_to_false:function(){for(var popover_id in this.over_states){if(!this.over_states.hasOwnProperty(popover_id))continue;this.over_states[popover_id]={button:false,overlay:false};}},}
SG.ReportsPopover=function(config){Ext.apply(this,config);SG.ReportsPopover.superclass.constructor.call(this);};Ext.extend(SG.ReportsPopover,SG.Popover,{templates:{table:'<table><tr><td class="pages">{recent}</td>'+'<td class="pages">{favorites}</td></tr></table>',section:'<div class="header">{icon}<div class="title">{title}</div></div>'+'<div class="body">{items}</div>',item:'<div class="page"><a href="{link}">'+'<div class="sg_entity_icon_span {icon_class}"></div>'+'<span class="name">{name}</span>{project}</a></div>'},init_component:function(){SG.Popover.prototype.init_component.call(this);this.extra_class='sgc_reports_popover pages_popover';this.cur_proj_id=this.project_id?this.project_id:0;},render_body:function(body_elem){var recent_set,favorite_set;if(this.cur_proj_id){recent_set=SG.globals.project_popover_recent_pages_set;favorite_set=SG.globals.project_popover_favorite_pages_set;}else{recent_set=SG.globals.global_popover_recent_pages_set;favorite_set=SG.globals.global_popover_favorite_pages_set;}
var recent=this.render_section(recent_set,"Recent");var favorite=this.render_section(favorite_set,'Favorites');var h=this.templates.table.apply({recent:recent,favorites:favorite});body_elem.update(h);},render_section:function(set,title){var i,cfg,rec,h="";var icon="";if(title=="Favorites")
icon='<div class="favorite_editor_button_selected"></div>';for(i=0;i<set.count();i++){rec=set.get_record(i);cfg={name:rec.get("name"),link:"/page/"+rec.get_id()};if(rec.get("entity_type")){cfg.icon_class=SG.schema.entity_icon_name(rec.get("entity_type"))}else if(rec.get("page_type")=="url"){cfg.icon_class="icon_url";}else{cfg.icon_class="icon_Dashboard";}
if(!this.cur_proj_id&&rec.get("project")){cfg.project='<span class="project">('+rec.get('project').name+")</span>";}
h+=this.templates.item.apply(cfg);}
return this.templates.section.apply({icon:icon,title:title,items:h});},register_container_listeners:function(){this.add_event(this.container,"click",this.on_click);},on_click:function(e){if(this.global_nav.page){var click_type=this.global_nav.page.handle_link_click(this.container,e);if(click_type==='click')
this.hide();if(click_type)
return;}}});SG.ProjectsPopover=function(config){Ext.apply(this,config);SG.ProjectsPopover.superclass.constructor.call(this);};Ext.extend(SG.ProjectsPopover,SG.Component,{templates:{overlay:'<div class="sgc_projects_popover"><div class="body"></div>'+'<div class="footer"><div class="gear_menu"><div class="gear_menu_nobg"></div></div></div></div>',table:'<table><tr><td class="projects">'+'<div class="project_filter_menu">{filter_display_name}<div class="icon_filter_menu"></div></div>'+'{items}</td>'+'<td class="pages"><div class="contents" style="opacity:0.0;"></div></td></tr></table>',item:'<div class="project" project_id="{project_id}">'+'<a href="{link}">'+'<table><tr>'+'<td class="thumb">{thumb}</td>'+'<td class="details"><span class="name">{name}</span><br>'+'<span class="type">{type}</span></td>'+'</tr></table></a>{fav_icon}</div>',fav_icon:'<div class="fav_icon" favorite="{favorite}" project_id="{project_id}"></div>',pages:'<div class="body">{items}</div>',page:'<div class="page"><a href="{link}">'+'<div class="sg_entity_icon_span {icon_class}"></div>'+'<span class="name">{name}</span></a></div>',other_menu:'<div class="other_menu" project_id="{project_id}"><span class="label">Other</span>'+'<div class="submenu_arrow"></div></div>',menu_link:'<a href="/page/project_default?entity_type={entity_type}&project_id={project_id}">{display_name}</a>',global_projects_link:'<a href="/page/global_page?entity_type=Project">{display_name}</a>',no_projects_message:'<div class="no_projects_message">You do not currently have access to any Projects.<br>'+'Contact your admin or manager for help.</div>',},init_component:function(){this.cur_proj_id=null;var data_set=SG.globals.global_projects_last_accessed_by_current_user;this.add_event(data_set,'change',this.on_projects_data_set_change);var doc=Ext.get(document);doc.on('keydown',this.on_keydown,this);this.init_modes();},init_modes:function(){var cookie=getCookie('project_popover_filter_mode');if(cookie)
this.project_filter_mode=cookie;else
this.project_filter_mode='recent';cookie=getCookie('project_popover_filter_value');if(cookie)
this.project_filter_value=cookie;else
this.project_filter_value=null;},is_visible:function(){return(this.container&&this.container.isVisible());},show:function(button_elem){this.button_elem=button_elem;this.button_elem.addClass('active');if(!this.container)
this.render();var elem=this.container.child('td.pages>div.contents');if(elem)
elem.update('');this.container.show();this.container.alignTo(button_elem,"tl-bl",[6,0]);this.container.setX(this.container.getX()-5);},hide:function(){this.button_elem.removeClass('active');this.container.hide();},render:function(){if(!this.container)
this.on_first_render();if(this.global_nav.user_has_no_projects()){if(!this.container.hasClass('no_projects'))
this.container.addClass('no_projects');this.body.update(this.templates.no_projects_message.apply());}else{this.body.update(this.render_body());}},on_first_render:function(){var dbody=Ext.get(document.body);var html=this.templates.overlay.apply();this.container=Ext.DomHelper.append(document.body,html,true);this.container.setVisibilityMode(Ext.Element.DISPLAY);this.body=this.container.child('div.body');this.add_event(this.container,"mouseover",this.on_mouseover);this.add_event(this.container,"mouseout",this.on_mouseout);this.add_event(this.container,"click",this.on_click);this.add_event(dbody,'click',this.on_dbody_click);},render_body:function(){var proj,cfg,h="";var project_records=this.global_nav.get_sorted_project_records(this.project_filter_mode,this.project_filter_value);var rec,cfg,fav,fav_icon,h="";for(var i=0;i<project_records.length;i++){rec=project_records[i];fav=rec.get('current_user_favorite');fav_icon=this.templates.fav_icon.apply({favorite:fav,project_id:rec.id});cfg={project_id:rec.get_id(),name:rec.get("name"),type:rec.get("sg_type"),thumb:this.render_thumb(rec.get('image')),link:'/detail/Project/'+rec.get_id(),fav_icon:fav_icon}
h+=this.templates.item.apply(cfg);}
return this.templates.table.apply({filter_display_name:this.global_nav.get_project_filter_display_name(this.project_filter_mode,this.project_filter_value),items:h});},on_dbody_click:function(e){if(!this.is_visible())return;var t=Ext.get(e.getTarget());var overlay_button=t.findParent('div.overlay_button.projects_popover',document.body);if(overlay_button){return;}
var container=t.findParent('div.sgc_projects_popover',40);if(!container){this.hide();}},render_thumb:function(value){if(value){return'<div class="size_constraint"><center><img src="'+SG.Renderers.image_url.render(value)+'" '+'onError="sg_missing_project_thumb(this)" /></center></div>';}else{return'<div class="size_constraint"><center><img src="/images/missing_thumbnail_project.png"/>'+'</center></div>';}},get_project_pages:function(project){var ret=[];if(!project)
project=this.get_current_project();var entity_field_pref=sg_get_entity_field_pref("nav_bar","Project",project);if(!entity_field_pref)
entity_field_pref=sg_get_entity_field_pref("nav_bar","Project");var pp=sg_deep_copy(entity_field_pref.get("settings_serialized"));for(var i=0;i<pp.length;i++){if(pp[i].app_name){ret.push(pp[i]);}else{var et=pp[i].entity_type;if(SG.schema.entity_types[et].enabled&&SG.schema.can_see_entity_type(et))
ret.push(pp[i]);}}
ret.push({entity_type:"Page"});return ret;},get_current_project:function(){for(var ii=0;ii<SG.schema.projects.length;ii++){var schema_project=SG.schema.projects[ii];if(schema_project.id==this.cur_proj_id)
return schema_project;}
return nulll},render_pages:function(proj_elem){var elem=Ext.get(sg_find('td.pages > div.contents'),this.container);var cfg,page,h="";var project_pages=this.get_project_pages();for(var i=0;i<project_pages.length;i++){page=project_pages[i];cfg={name:this.get_project_page_display_name(page)};if(page.app_name){if(page.app_name=='resource_planning_app'){cfg.link='/page/crew_planning_app?project_id='+this.cur_proj_id;cfg.icon_class='app_crew_planning_small';}}else if(page.entity_type=="Project"){cfg.link='/detail/Project/'+this.cur_proj_id;cfg.icon_class='icon_Dashboard';}else if(page.entity_type=="Page"){cfg.link='/page/project_default?entity_type='+page.entity_type+'&'+'project_id='+
this.cur_proj_id;cfg.icon_class='icon_Dashboard';}else{cfg.link='/page/project_default?entity_type='+page.entity_type+'&'+'project_id='+
this.cur_proj_id;cfg.icon_class='icon_'+page.entity_type;}
h+=this.templates.page.apply(cfg);}
if(!SG.allow("hide_other_in_project_nav",{}))
h+=this.templates.other_menu.apply({project_id:this.cur_proj_id});elem.update(this.templates.pages.apply({items:h}));var xy=elem.getAlignToXY(proj_elem,'tl-tr');var elemHeight=elem.getHeight()+32;var containerY=this.container.getY();var containerHeight=this.container.getHeight();if(xy[1]<containerY){xy[1]=containerY;}else if((xy[1]+elemHeight)>(containerY+containerHeight)){xy[1]-=(xy[1]+elemHeight)-(containerY+containerHeight);}
elem.setY(xy[1]);this.set_active_project();elem.animate({opacity:{from:0,to:1}},0.25);},get_project_page_display_name:function(setting){if(setting.display_name&&setting.display_name!='')
return setting.display_name;else
return SG.schema.entity_types[setting.entity_type]['display_name_pluralized'];},on_mouseover:function(e){var t=Ext.get(e.getTarget());var proj_elem=t.findParent('div.project',50);var proj_id;if(proj_elem){proj_id=Number(proj_elem.getAttribute('project_id'));if(this.cur_proj_id!=proj_id){if(this.other_menu)this.other_menu.hide();this.cur_proj_id=proj_id;this.render_pages(proj_elem);}
return;}
var other_menu=t.findParent('div.other_menu',this.container.dom);if(other_menu){if(this.other_menu&&this.other_menu.is_showing())
return;this.show_other_menu(other_menu);return;}
var div_page=t.findParent('div.page',this.container.dom);if(div_page&&this.other_menu&&this.other_menu.is_showing())
this.other_menu.hide();},on_mouseout:function(e){var t=Ext.get(e.getTarget());var project=t.findParent('div.sgc_projects_popover',50,true);if(project){var enter=Ext.get(e.getRelatedTarget());if(!enter||!enter.findParent('div.sgc_projects_popover',50)){this.cur_proj_id=null;this.set_active_project();if(this.other_menu&&this.other_menu.is_showing())
this.other_menu.hide();var elem=this.container.child('td.pages>div.contents');if(elem)
elem.update('');}}},set_active_project:function(){var active_div=sg_find('div.project.active',this.container.dom);if(active_div){active_div=Ext.get(active_div);active_div.removeClass('active');}
if(this.cur_proj_id!=null){var sel='div.project[project_id="'+this.cur_proj_id+'"]';var div=sg_find(sel,this.container.dom);div=Ext.get(div);div.addClass('active');}},on_click:function(e){if(this.global_nav.page){var click_type=this.global_nav.page.handle_link_click(this.container,e);if(click_type==='click')
this.hide();var t=Ext.get(e.getTarget());var gear_menu=t.findParent('div.gear_menu',this.container.dom);if(gear_menu){if(this.gear_menu&&this.gear_menu.is_showing())
this.gear_menu.hide();else
this.show_gear_menu(gear_menu);return;}
var project_filter_menu_elem=t.findParent('div.icon_filter_menu',this.container.dom);if(project_filter_menu_elem){if(this.project_filter_menu&&this.project_filter_menu.is_showing())
this.project_filter_menu.hide();else
this.show_project_filter_menu(project_filter_menu_elem);return;}
var fav_icon=t.findParent('div.fav_icon',this.container.dom,true);if(fav_icon){var project_id=Number(fav_icon.dom.getAttribute('project_id'));var favorite=fav_icon.dom.getAttribute('favorite');var new_value=favorite=='true'?'false':'true';fav_icon.dom.setAttribute('favorite',new_value);this.toggle_favorite(project_id,new_value=='true');if(this.project_filter_mode=='favorite'){var me=this;setTimeout(function(){me.render();},0);}
return;}
if(click_type)
return;}},toggle_favorite:function(project_id,value){var data_set=SG.globals.global_projects_last_accessed_by_current_user;var rec=data_set.get_record_by_id(project_id);rec.set('current_user_favorite',value);var spec={type:'Project',id:project_id,column:'current_user_favorite',value:value,};SG.Repo.update(spec);},on_before_show_other_menu:function(){this.other_menu_elem.addClass('active');},on_hide_other_menu:function(){this.other_menu_elem.removeClass('active');},show_gear_menu:function(gear_elem){if(!this.gear_menu){this.gear_menu=new SG.Menu({render_container:this.container,menu_class:'projects_popover_other_menu',});}
var items=[];items.push({html:'New Project...',item_selected:{fn:this.show_new_project_dialog,scope:this},value:'Project',icon_name:'icon_plus'});var html=this.templates.global_projects_link.apply({display_name:'Manage Projects...'});items.push({html:html});this.gear_menu.items=items;this.gear_menu.render();this.gear_menu.position={dom_elem:gear_elem,elem_anchor:'bl',menu_anchor:'tl'};this.gear_menu.show();},show_new_project_dialog:function(menu,menu_item){this.hide();this.global_nav.on_new_entity_menu_click(menu,menu_item);},show_other_menu:function(other_elem){this.other_menu_elem=Ext.get(other_elem);if(!this.other_menu){this.other_menu=new SG.Menu({render_container:this.container,menu_class:'projects_popover_other_menu',icon_width:20,before_show:{fn:this.on_before_show_other_menu,scope:this},after_hide:{fn:this.on_hide_other_menu,scope:this}});}
var project_id=other_elem.getAttribute('project_id');var project=SG.schema.project_by_id(project_id);var project_bricks=this.get_project_pages(project);var items=this.global_nav.get_other_entity_menu_items(project_bricks,project_id);this.other_menu.items=items;this.other_menu.render();this.other_menu.menu_ext_elem.setWidth(this.measure_widest_menu_item(items)+50);this.other_menu.position={dom_elem:other_elem,elem_anchor:'tr',menu_anchor:'tl'};this.other_menu.show();},measure_widest_menu_item:function(items){var max=0;for(var i=0;i<items.length;i++){var width=this.measure_text(items[i].html);if(width>max)max=width;}
return max;},measure_text:function(text){var span_html='<span style="font-size:12px;background-color:transparent;color:transparent;">'+
text+'</span>';var span=Ext.DomHelper.append(document.body,span_html,true);var width=span.getWidth();span.remove();return width;},on_projects_data_set_change:function(changes){if(this.is_visible())return;var server_update=false;for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='server'){server_update=true;break;}}
if(!server_update)return;this.render();},on_keydown:function(e){if(!this.is_visible()||(this.gear_menu&&this.gear_menu.is_showing())||(this.other_menu&&this.other_menu.is_showing())){return;}
var key_id=e.getKey();if(key_id==Ext.EventObject.ESC)
this.hide();},show_project_filter_menu:function(folder_elem){if(!this.project_filter_menu){this.project_filter_menu=new SG.Menu({render_container:this.container,item_selected:{fn:this.on_project_filter_menu_item,scope:this}});}
this.project_filter_menu.items=this.global_nav.get_project_filter_menu_items(this.project_filter_mode,this.project_filter_value);this.project_filter_menu.render();this.project_filter_menu.position={dom_elem:folder_elem,elem_anchor:'bl',menu_anchor:'tl'};this.project_filter_menu.show();},on_project_filter_menu_item:function(menu,menu_item){this.project_filter_mode=menu_item.value;this.project_filter_value=menu_item.status_value?menu_item.status_value:null;var me=this;setTimeout(function(){me.render();},0);setCookie('project_popover_filter_mode',this.project_filter_mode);setCookie('project_popover_filter_value',this.project_filter_value);},});SG.ConfigureProjectNav=function(config)
{Ext.apply(this,config);SG.ConfigureProjectNav.superclass.constructor.call(this);};Ext.extend(SG.ConfigureProjectNav,SG.Component,{templates:{content:'<div class="header">{header}</div>'+'<div class="body">{body}</div>',header:'<div class="title">Project Navigation</div>'+'<div class="controls"><span class="cancel">Cancel</span>'+'<input type="button" class="save" value="Save"></div>',body:'<div class="bar">{bar_items}</div>'+'<div class="other">'+'<div class="section_title"><div class="pages_icon"></div><div class="title_text">Pages</div></div>'+'<div class="items">{default_items}</div>'+'<div class="items">{more_items}</div>'+'<div class="section_title"><div class="pages_icon"></div><div class="title_text">Apps</div></div>'+'<div class="items">{app_items}</div>'+'</div>',bar_item:'<div class="draggable item" entity_type="{entity_type}" display_name="{display_name}" {app_name}>'+'<div class="vertical_drag_handle"></div>'+'<span class="display_name">{display_name}</span>'+'{edit_icon}'+'<div class="trash no_drag"></div></div>',edit_icon:'<div class="icon_edit no_drag"></div>',other_item:'<div class="draggable other_item {disabled}" entity_type="{entity_type}" display_name="{display_name}">'+'<div class="display_name"><div class="entity_icon icon_{entity_type}"></div>'+'<span>{display_name}</span></div>'+'<div class="alternate_name">{alternate_name}</div></div>',app_item:'<div class="draggable other_item {disabled}" app_name="{app_name}" display_name="{display_name}">'+'<div class="display_name"><div class="entity_icon {icon}"></div>'+'<span>{display_name}</span></div>'+'</div>',},base_default_pages:[{entity_type:"Project",display_name:"Overview"},{entity_type:"Asset",display_name:"Assets"},{entity_type:"Shot",display_name:"Shots"},{entity_type:"Task",display_name:"Schedule"},{entity_type:"Playlist",display_name:"Review"}],init_component:function(){var i;var cur_set=sg_deep_copy(this.record.get("settings_serialized"));this.settings=[];for(i=0;i<cur_set.length;i++){if(cur_set[i].app_name||SG.schema.entity_types[cur_set[i].entity_type].enabled)
this.settings.push(cur_set[i]);}
this.default_pages=[];for(i=0;i<this.base_default_pages.length;i++){if(SG.schema.entity_types[this.base_default_pages[i].entity_type].enabled){this.default_pages.push(this.base_default_pages[i]);}}
var et,all_types=SG.schema.get_entity_types_for_site_config();this.project_types=[];for(i=0;i<all_types.length;i++){et=all_types[i];if(et!=="Page"&&et!='Status'&&!this.entity_type_in_default_pages(et)&&SG.schema.leftnav_page_entity_types.indexOf(et)!=-1){this.project_types.push({entity_type:et,display_name:SG.schema.entity_types[et].display_name_pluralized});}}
this.render();},destroy_component:function(){this.container.remove();this.rename_input.remove();},render:function(){if(!this.container)
this.on_first_render();var h=this.templates.content.apply({header:this.render_header(),body:this.render_body()});this.container.update(h);},on_first_render:function(){var dh=Ext.DomHelper;this.container=dh.append(document.body,{tag:"div",cls:"sgc_configure_project_nav"},true);this.add_event(this.container,"click",this.on_click);this.add_event(Ext.get(document.body),"keyup",this.on_keyup);this.rename_input=dh.append(document.body,'<input type="text" class="sgc_configure_project_nav_rename"/>',true);this.add_event(this.rename_input,"blur",this.on_edit_item);this.drag_zone=new SG.CfgProjectNavDragZone(this);},render_header:function(){return this.templates.header.apply({});},render_body:function(){var i,cfg,disabled,alternate;var bar_items='<div class="item dummy"></div>';var default_items="";var more_items="";var entity_type,display_name;for(i=0;i<this.settings.length;i++){var setting=this.settings[i];bar_items+=this.templates.bar_item.apply({entity_type:setting.entity_type?setting.entity_type:'',display_name:this.get_nav_bar_item_display_name(setting),app_name:setting.app_name?'app_name="'+setting.app_name+'"':'',edit_icon:setting.app_name?'':this.templates.edit_icon.apply(),});}
for(i=0;i<this.default_pages.length;i++){disabled="";if(this.entity_type_in_settings(this.default_pages[i].entity_type))
disabled="disabled";alternate=SG.schema.entity_types[this.default_pages[i].entity_type].display_name_pluralized;if(this.default_pages[i].display_name==alternate){alternate="&nbsp;";}else if(this.default_pages[i].entity_type==="Project"){alternate="Project Home";}
var setting=this.get_setting(this.default_pages[i].entity_type)
var display_name=this.default_pages[i].display_name;if(setting&&setting.display_name&&setting.display_name!='')
display_name=setting.display_name;default_items+=this.templates.other_item.apply({entity_type:this.default_pages[i].entity_type,display_name:display_name,alternate_name:alternate,disabled:disabled});}
var me=this;this.project_types.sort(function(a,b){var aa=a['display_name'];var bb=b['display_name'];var a_setting=me.get_setting(a.entity_type);if(a_setting)aa=me.get_nav_bar_item_display_name(a_setting);var b_setting=me.get_setting(b.entity_type);if(b_setting)bb=me.get_nav_bar_item_display_name(b_setting);return aa>bb?1:(aa===bb?0:-1);});for(i=0;i<this.project_types.length;i++){disabled="";if(this.entity_type_in_settings(this.project_types[i].entity_type))
disabled="disabled";var setting=this.get_setting(this.project_types[i].entity_type);if(setting){var display_name=this.get_nav_bar_item_display_name(setting);var alternate_name='';if(display_name!=SG.schema.entity_types[setting.entity_type]['display_name_pluralized'])
alternate_name=SG.schema.entity_types[setting.entity_type]['display_name_pluralized'];more_items+=this.templates.other_item.apply({entity_type:setting.entity_type,display_name:display_name,alternate_name:alternate_name,disabled:disabled});}else{more_items+=this.templates.other_item.apply({entity_type:this.project_types[i].entity_type,display_name:this.project_types[i].display_name,disabled:disabled});}}
return this.templates.body.apply({bar_items:bar_items,default_items:default_items,more_items:more_items,app_items:this.render_app_items(),});},render_app_items:function(){var apps=[];if(SG.globals.preferences.crew_planning_app_active)
apps.push({name:'resource_planning_app',icon:'icon_Group',display_name:'Crew'});var html='';for(var i=0;i<apps.length;i++){var app=apps[i];var disabled='';if(this.app_name_in_settings(app.name))
disabled="disabled";html+=this.templates.app_item.apply({disabled:disabled,app_name:app.name,display_name:app.display_name,icon:app.icon});}
return html;},get_nav_bar_item_display_name:function(setting){if(setting.display_name&&setting.display_name!='')
return setting.display_name;else
return SG.schema.entity_types[setting.entity_type]['display_name_pluralized'];},on_keyup:function(e){if(e.getKey()!=Ext.EventObject.RETURN)return;var t=Ext.get(e.getTarget());var rename_input=t.findParent('input.sgc_configure_project_nav_rename',5);if(rename_input)
rename_input.blur();},on_click:function(e){var t=Ext.get(e.getTarget());var item;var cancel=t.findParent('span.cancel',this.container);if(cancel){this.destroy();return;}
var save=t.findParent('input.save',this.container);if(save){this.save();return;}
var trash=t.findParent('div.trash',this.container,true);if(trash){item=trash.findParent('div.item',this.container);if(item.hasAttribute('app_name')){this.remove_item(item.getAttribute('app_name'),true);}else{this.remove_item(item.getAttribute('entity_type'));}
return;}
var edit=t.findParent('div.icon_edit',this.container,true);if(edit){item=edit.findParent('div.item',this.container,true);this.edit_item(item);return;}},save:function(){this.record.set("settings_serialized",this.settings);var project=this.record.get('project');if(!project){this.create_new_pref_for_project();}else{this.record.commit(true);}
this.destroy();},create_new_pref_for_project:function(){var data_set=new SG.Data.Set('EntityFieldPref');var record=data_set.new_record();var fields=this.record.get_fields();for(var i=0;i<fields.length;i++){var field=fields[i];record.set(field,this.record.get(field));}
record.set('project',this.project);data_set.commit(true);},update_body:function(){var body=Ext.get(sg_find("div.body",this.container.dom));body.update(this.render_body());},entity_type_in_settings:function(entity_type){for(var i=0;i<this.settings.length;i++){if(this.settings[i].app_name)continue;if(entity_type==this.settings[i].entity_type)
return true;}
return false;},app_name_in_settings:function(app_name){for(var i=0;i<this.settings.length;i++){if(!this.settings[i].app_name)continue;if(app_name==this.settings[i].app_name)
return true;}
return false;},get_setting:function(entity_type){for(var i=0;i<this.settings.length;i++){if(entity_type==this.settings[i].entity_type){return this.settings[i];}}
return null;},entity_type_in_default_pages:function(entity_type){for(var i=0;i<this.default_pages.length;i++){if(entity_type==this.default_pages[i].entity_type)
return true;}
return false;},edit_item:function(item_el){var size=item_el.getSize();this.editing_item={entity_type:item_el.dom.getAttribute("entity_type"),display_name:item_el.dom.getAttribute("display_name")};this.rename_input.alignTo(item_el,"tl-tl");this.rename_input.setHeight(size.height);this.rename_input.setWidth(size.width);this.rename_input.dom.value=this.editing_item.display_name;this.rename_input.show();var self=this;window.setTimeout(function(){self.rename_input.focus();self.rename_input.dom.select();});},on_edit_item:function(){var new_name=this.rename_input.dom.value;for(var i=0;i<this.settings.length;i++){if(this.editing_item.entity_type==this.settings[i].entity_type){this.settings[i].display_name=new_name;break;}}
this.rename_input.hide();this.update_body();this.editing_item=null;},remove_item:function(entity_type,is_app_name){var idx=-1;for(var i=0;i<this.settings.length;i++){if(is_app_name){if(entity_type==this.settings[i].app_name){idx=i;break;}}else{if(entity_type==this.settings[i].entity_type){idx=i;break;}}}
if(idx!==-1){this.settings.splice(idx,1);this.update_body();}}});SG.CfgProjectNavDragZone=function(parent){this.parent=parent;this.settings=this.parent.settings;this.container=this.parent.container;this.arrow=Ext.DomHelper.append(document.body,{tag:"div",cls:"col-move-top",html:"&#160;"},true);SG.CfgProjectNavDragZone.superclass.constructor.call(this,this.container,"cfg_project_nav",{dragElId:"sg_cfg_project_nav_proxy",resizeFrame:false,scroll:false});this.setHandleElId(this.container);};Ext.extend(SG.CfgProjectNavDragZone,Ext.dd.DDProxy,{handleMouseDown:function(e){if(e.ctrlKey)return;var target=Ext.get(e.getTarget());if(target.hasClass('no_drag'))return;var item=target.findParent('div.draggable',this.container,true);if(!item||item.hasClass('disabled'))return;this.item=item;var drop_area=Ext.get(sg_find('div.bar',this.container.dom));this.minY=drop_area.getTop()-5;this.maxY=drop_area.getBottom()+5;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y){var et=this.item.dom.getAttribute("entity_type");var display_name=this.item.dom.getAttribute("display_name");var app_name=this.item.dom.getAttribute("app_name");this.start_index=-100;for(var i=0;i<this.settings.length;i++){var setting=this.settings[i];if((setting.entity_type&&setting.entity_type==et)||(setting.app_name&&setting.app_name==app_name)){this.start_index=i;break;}}
if(this.start_index===-100){this.new_item={display_name:display_name};if(et)
this.new_item.entity_type=et;if(app_name)
this.new_item.app_name=app_name;}
this.cache_regions();var drag_el=Ext.get(this.getDragEl());drag_el.setWidth(this.item.getWidth());drag_el.update(display_name);Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e){var drop_index=this.find_valid_drop_index(e);var x=e.getPageX();if(drop_index!==false){var region=this.find_item_by_idx(drop_index);if(this.start_index===-100&&drop_index===-1){region=this.find_item_by_idx(-1);this.arrow.setLeftTop(region.left-5,this.arrow_y);}else if(this.start_index<drop_index){this.arrow.setLeftTop(region.right-5,this.arrow_y);}else{this.arrow.setLeftTop(region.left-5,this.arrow_y);}
this.arrow.show();}else{this.arrow.setLeftTop(-100,-100);this.arrow.hide();}},endDrag:function(e){var drop_index=this.find_valid_drop_index(e);if(drop_index!==false){if(this.start_index===-100)
this.add_item(drop_index);else
this.move_item(this.start_index,drop_index);this.parent.update_body();}
this.arrow.setLeftTop(-100,-100);this.arrow.hide();},cache_regions:function(){this.region_cache={};var items=sg_find_all('div.bar div.item',this.container.dom);var el,entity_type,region,idx;for(var i=0;i<items.length;i++){el=items[i];entity_type=el.getAttribute("entity_type");region=Ext.fly(el).getRegion();this.region_cache[entity_type]={idx:i-1,left:region.left,right:region.right};}
if(!region){var bar=this.container.child('div.bar');this.arrow_y=bar.top-10;}
else
this.arrow_y=region.top-10;},find_item_by_position:function(x){var entry;var min_left=100000,max_right=0;var min_entry,max_entry;for(var item in this.region_cache){if(this.region_cache.hasOwnProperty(item)){entry=this.region_cache[item];if(entry.right>max_right){max_entry=entry;max_right=entry.right;}
if(entry.left<min_left){min_entry=entry;min_left=entry.left;}
if(x>entry.left&&x<=entry.right){return entry;}}}
if(x>max_right){return max_entry;}else if(x<min_left){return min_entry;}
return false;},find_item_by_idx:function(idx){var entry;for(var item in this.region_cache){if(this.region_cache.hasOwnProperty(item)){entry=this.region_cache[item];if(entry.idx===idx){return entry;}}}
return false;},find_valid_drop_index:function(e){var x=e.getPageX();var y=e.getPageY();if(y<this.minY||y>this.maxY)
return false;var item=this.find_item_by_position(x);if(item){var end_index=item.idx;if(x-item.left>=(item.right-item.left)/2){end_index++;}
if(this.start_index<end_index){end_index--;}
if(this.start_index!=end_index){return end_index;}}
return false;},add_item:function(new_index){console.log('add_item');if(this.new_item.entity_type){var edn=SG.schema.entity_types[this.new_item.entity_type]['display_name_pluralized'];if(edn==this.new_item.display_name)
this.new_item.display_name='';}
this.settings.splice(new_index+1,0,this.new_item);},move_item:function(old_index,new_index){var item=this.settings[old_index];this.settings.splice(old_index,1);this.settings.splice(new_index,0,item);},autoOffset:function(){this.setDelta(0,0);}});SG.PageTreeOverlay=function(config){Ext.apply(this,config);SG.PageTreeOverlay.superclass.constructor.call(this);};Ext.extend(SG.PageTreeOverlay,SG.Component,{templates:{overlay:'<div class="sgc_page_tree_overlay" mode="{mode}" style="width:{width}px;">'+'<div class="header"></div><div class="scroll_container"></div>'+'<div class="footer"><div class="gear_menu"><div class="gear_menu_nobg"></div></div></div></div>',header:'<div class="my_pages header_button {my_pages_selected}">My Pages</div>'+'<div class="other_pages header_button {other_pages_selected}">{other_pages_label}</div>'+'<div class="search header_button {search_selected}"></div><div style="clear: both;"></div>',folder:'<div class="folder" path="{path}" state="{state}" {project_id} >'+'<div class="folder_header {header_cls} {extra_folder_class}">'+'<div class="tip"></div><div class="folder {folder_icon_override}"></div>'+'<div class="folder_name {extra_folder_class}">{folder_name}</div>{fav_icon}</div>'+'<div class="folder_contents">{folder_contents}</div></div>',page:'<a class="page_link" href="{url}">'+'<div class="page_row {selected}" favorite="{favorite}">'+'<div class="icon {entity_icon}"></div>'+'<div class="page_link" clip_tip="this_node" sg_tip="{sg_tip}">'+'{page_name}<span class="project">{project_name}</span></div>{fav_icon}</div></a>',fav_icon:'<div class="fav_icon" favorite="{favorite}" page_id="{page_id}"></div>',fav_icon_for_project:'<div class="fav_icon" favorite="{favorite}" project_id="{project_id}"></div>',search:'<div class="search_input"><div class="quick_jump_left left"></div>'+'<input class="search" type="text"/>'+'<div class="quick_filter_right right"></div>'+'<div class="state_icon clear"></div></div>'+'<div class="search_results"><div class="search_item">'+"Find a Page by typing it's name</div></div>",search_result:'<a class="page_link" href="{url}">'+'<div class="search_item {selected} {current_page}" sg_tip="{sg_tip}" clip_tip="this_node" >'+'<div class="entity_icon {icon}"></div>{label}<span class="project">{project_name}</span></div></a>',search_message:'<div class="search_item">{html}</div>',project_filter_menu:'<div class="project_filter_menu">{display_name}<div class="icon_filter_menu"></div></div>',filter_message:'<div class="filter_message">{message}</div>',loading:'<div class="loading"><center><img class="spinner" src="/images/indicator_large_transparent.gif" />'+'</center></div>',},init_component:function(){this.init_settings();this.container=null;this.init_project_data_sets();this.init_change_listeners();this.init_modes();this.init_open_paths();this.generate_all_nodes();var doc=Ext.get(document);doc.on('keydown',this.on_keydown,this);Ext.EventManager.onWindowResize(this.on_window_resize,this);},init_change_listeners:function(){var data_sets=[SG.globals.global_popover_recent_pages_set,SG.globals.global_popover_favorite_pages_set,SG.globals.project_popover_recent_pages_set,SG.globals.project_popover_favorite_pages_set,SG.globals.current_project_pages_set,SG.globals.user_my_pages_set,SG.globals.global_projects_last_accessed_by_current_user];for(var i=0;i<data_sets.length;i++){var data_set=data_sets[i];if(!data_set)continue;this.add_event(data_set,'change',this.on_data_set_change);}},project_dependent_data_sets_ready:function(){if(this.project_id===undefined)
return true;var A=SG.globals.project_popover_recent_pages_set;var B=SG.globals.project_popover_favorite_pages_set;var C=SG.globals.current_project_pages_set;return(A&&B&&C&&A.is_loaded()&&B.is_loaded()&&C.is_loaded());},init_project_data_sets:function(){this.landing_page_recs=[];this.project_data_sets={};var data_set=SG.globals.current_project_pages_set;if(!this.project_dependent_data_sets_ready()){this.request_project_specfic_pages();return;}
if(!data_set||data_set.count()==0)return;var rec=data_set.get_record(0);var proj=rec.get('project');this.project_data_sets[proj.id]=data_set;for(i=0;i<data_set.count();i++){rec=data_set.get_record(i);if(rec.get('ui_category')=='project')
this.landing_page_recs.push(rec);}},init_modes:function(){var cookie=this.get_setting(this.get_mode_cookie_name());if(cookie)
this.mode=cookie;else
this.mode='my_pages';cookie=this.get_setting(this.get_project_filter_mode_cookie_name());if(cookie)
this.project_filter_mode=cookie;else
this.project_filter_mode='recent';cookie=this.get_setting(this.get_project_filter_value_cookie_name());if(cookie)
this.project_filter_value=cookie;else
this.project_filter_value=null;},init_open_paths:function(){var cookie=this.get_setting(this.get_open_path_cookie_name());if(cookie)
this.open_paths=cookie;else{this.open_paths=[];var my_path=this.my_path();this.open_paths.push(my_path+'->FAVORITES');this.open_paths.push(my_path+'->RECENTLY VIEWED');this.open_paths.push(my_path+'->MY PERSONAL PAGES');if(this.project_id===undefined)
this.open_paths.push('ALL->GLOBAL PAGES');this.set_open_paths_cookie();}},render:function(){if(!this.container)
this.on_first_render();this.header.update(this.render_header());this.scroll_container.update(this['render_'+this.mode].call(this));this.restore_scroll();if(this.mode=='search')
this.init_search();this.render_filter_message();if(!this.project_dependent_data_sets_ready()){this.pi=new SG.ProgressIndicator(this.scroll_container);this.pi.show();}else if(this.pi){this.pi.hide();}},render_filter_message:function(){if(this.mode!='all_pages')return;if(this.filtered_project_count!=0)return;if(this.open_paths.indexOf('ALL->ACTIVE PROJECTS')==-1)return;var message='';if(this.project_filter_mode=='all'){message='You do not currently have access to any Projects.<br>'+'Contact your admin or manager for help.';}else{message='No matching Projects.'}
var div=this.container.child('div.folder[path="ALL->ACTIVE PROJECTS"]');var html=this.templates.filter_message.apply({message:message});Ext.DomHelper.insertAfter(div,html);},restore_scroll:function(){if(this.mode=='search')return;var scroll_cookie_name=this.get_scroll_cookie_name();var cookie=this.get_setting(scroll_cookie_name);if(cookie)
this.scroll_container.dom.scrollTop=cookie;},init_search:function(){var input=this.container.child('input.search');if(this.listbox)
this.listbox.destroy();this.listbox=new SG.ListBox({items:[{disabled:true,html:"Find a Page by typing it's name"}],position:{dom_elem:input.dom,elem_anchor:"bl",menu_anchor:"tl"},autocomplete:{input_dom:input.dom,prompt_html:"Find a Page by typing it's name",request_url:SG.globals.urls.entity_autocomplete,parameters_callback:{fn:this.request_params,scope:this},response_callback:{fn:this.on_autocomplete_response,scope:this},selection_callback:{fn:this.on_search_item_selected,scope:this},close_on_blur:true,no_keyboard:true},matching:false,page_tree:this});this.listbox.render=function(){this.page_tree.render_search_results.call(this.page_tree,this.items);};this.listbox.show=function(){};this.listbox.find_selected=function(){return null;};input.dom.focus();input.on("keydown",this.matching_keydown,this);if(Ext.isGecko)
input.on("keypress",this.matching_keypress,this);},render_header:function(){return this.templates.header.apply({my_pages_selected:this.mode=='my_pages'?'selected':'',other_pages_selected:['project_pages','all_pages'].indexOf(this.mode)!=-1?'selected':'',other_pages_label:this.project_id===undefined?'All Pages':'All Project Pages',search_selected:this.mode=='search'?'selected':'',});},render_my_pages:function(){var nodes=this.get_nodes_for_path(this.my_path());var html=this.render_nodes(nodes);return html;},render_project_pages:function(){var nodes=this.get_nodes_for_path(this.project_path());var html=this.render_nodes(nodes);return html;},render_all_pages:function(){var nodes=this.get_nodes_for_path('ALL');var html=this.render_nodes(nodes);return html;},render_search:function(){return this.templates.search.apply();},on_first_render:function(){var width=230;var width_cookie=this.get_setting('sg_page_tree_overlay_width');if(width_cookie)
width=width_cookie;var html=this.templates.overlay.apply({mode:this.mode,width:width});this.container=Ext.DomHelper.append(document.body,html,true);this.container.setVisibilityMode(Ext.Element.DISPLAY);this.scroll_container=this.container.child('div.scroll_container');this.header=this.container.child('div.header');this.add_event(this.container,'click',this.on_click);this.add_event(this.scroll_container,'scroll',this.on_scroll);this.add_event(this.container,"mousemove",this.on_mousemove);var dbody=Ext.get(document.body);this.add_event(dbody,'click',this.on_dbody_click);var resizer=new Ext.Resizable(this.container,{handles:'se',minWidth:100,minHeight:100,pinned:true});resizer.on('resize',this.on_resize,this);},on_resize:function(){var width=this.container.getWidth();this.set_setting('sg_page_tree_overlay_width',width);},is_visible:function(){return(this.container&&this.container.isVisible());},show:function(button_elem){this.button_elem=button_elem;var overlay_id=this.get_overlay_id();button_elem.dom.setAttribute('overlay_id',overlay_id);button_elem.addClass('active');if(!this.container)
this.render();else
this.generate_all_nodes();this.container.show();this.container.alignTo(button_elem,"tl-bl",[5,0]);this.container.setX(this.container.getX()-5);this.prime_auto_complete_input();},hide:function(){this.button_elem.removeClass('active');this.container.hide();},on_dbody_click:function(e){if(!this.is_visible())return;var t=Ext.get(e.getTarget());var overlay_button=t.findParent('div[overlay_id]',document.body);if(overlay_button){var overlay_id=this.get_overlay_id();var button_id=overlay_button.getAttribute('overlay_id');if(button_id==this.get_overlay_id()){return;}else{this.hide();return;}}
var container=t.findParent('div.sgc_page_tree_overlay',40);if(!container){this.hide();}},set_mode:function(mode){if(this.mode)
this.teardown_keyboard_events();if(mode=='other_pages'){this.mode=this.project_id===undefined?'all_pages':'project_pages';}else{this.mode=mode;}
this.container.dom.setAttribute('mode',this.mode);this.set_setting(this.get_mode_cookie_name(),this.mode);},on_scroll:function(e){if(this.mode=='search')return;var cookie_name=this.get_scroll_cookie_name();this.set_setting(cookie_name,this.scroll_container.dom.scrollTop);},teardown_keyboard_events:function(){var input=this.container.child('input.search');if(!input)return;input.un("keydown",this.matching_keydown,this);if(Ext.isGecko)
input.un("keypress",this.matching_keypress,this);},matching_keydown:function(e){var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:if(!Ext.isGecko)
this.key_up_down(true);break;case Ext.EventObject.DOWN:if(!Ext.isGecko)
this.key_up_down(false);break;case Ext.EventObject.RETURN:this.open_selected_item();break;}},get_selected_item:function(){var selected_item=sg_find('div.search_item.selected',this.container.dom);if(selected_item){selected_item=Ext.get(selected_item);return selected_item;}
return null;},open_selected_item:function(){var selected_item=this.get_selected_item();if(!selected_item)return;if(this.page.root_widget.show_loading_overlay)
this.page.root_widget.show_loading_overlay();var page_link=Ext.get(selected_item.dom.parentNode);window.location=page_link.dom.getAttribute('href');},key_up_down:function(up){var selected_item=this.get_selected_item();if(!selected_item)return;var parent_item=Ext.get(selected_item.dom.parentNode);var new_selected_parent;if(up&&parent_item.dom.previousSibling){new_selected_parent=Ext.get(parent_item.dom.previousSibling);}else if(!up&&parent_item.dom.nextSibling){new_selected_parent=Ext.get(parent_item.dom.nextSibling);}else{return;}
var new_selected_node=Ext.get(new_selected_parent.dom.firstChild);new_selected_node.addClass('selected');selected_item.removeClass('selected');new_selected_node.scrollIntoView(this.scroll_container);},matching_keypress:function(e){var key_id=e.getKey();switch(key_id)
{case Ext.EventObject.UP:this.key_up_down(true);break;case Ext.EventObject.DOWN:this.key_up_down(false);break;}},on_mousemove:function(e){if(this.mode!='search')return;var t=Ext.get(e.getTarget());var hover_item=t.findParent('div.search_item',this.container.dom,true);if(!hover_item||hover_item.hasClass('selected'))return;var selected_item=this.get_selected_item();hover_item.addClass('selected');if(selected_item);selected_item.removeClass('selected');},on_click:function(e){var t=Ext.get(e.getTarget());var header_button=t.findParent('div.header_button',this.container.dom,true);if(header_button){if(header_button.hasClass('selected'))return;if(header_button.hasClass('my_pages'))
this.set_mode('my_pages');else if(header_button.hasClass('other_pages'))
this.set_mode('other_pages');else
this.set_mode('search');this.re_render();this.prime_auto_complete_input();return;}
var fav_icon=t.findParent('div.fav_icon',this.container.dom,true);if(fav_icon){e.stopEvent();if(fav_icon.dom.hasAttribute('project_id')){var project_id=Number(fav_icon.dom.getAttribute('project_id'));var favorite=fav_icon.dom.getAttribute('favorite');var new_value=favorite=='true'?'false':'true';fav_icon.dom.setAttribute('favorite',new_value);this.toggle_project_favorite(project_id,new_value=='true');}else{var page_id=Number(fav_icon.dom.getAttribute('page_id'));var favorite=fav_icon.dom.getAttribute('favorite');this.toggle_favorite(page_id,favorite=='true');this.generate_all_nodes();this.re_render();}
return;}
var folder_menu=t.findParent('div.icon_filter_menu',this.container.dom);if(folder_menu){if(this.project_filter_menu&&this.project_filter_menu.is_showing())
this.project_filter_menu.hide();else
this.show_project_filter_menu(folder_menu);return;}
var folder_header=t.findParent('div.folder_header',this.container.dom);if(folder_header){var folder=folder_header.parentNode;var state=folder.getAttribute('state');if(state=='open'){if(e.browserEvent.altKey)
this.close_all_folders_below(folder.getAttribute('path'));else
this.close_folder(folder.getAttribute('path'));}else{if(e.browserEvent.altKey)
this.open_all_folders_below(folder.getAttribute('path'));else
this.open_folder(folder.getAttribute('path'));}
return;}
var clear_icon=t.findParent('div.state_icon.clear',this.container.dom);if(clear_icon){this.clear_auto_complete_input();return;}
var page_link=t.findParent('a.page_link',this.container.dom,true);if(page_link){var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;if(ctrl_click){return;}
this.hide();if(this.page.root_widget.show_loading_overlay)
this.page.root_widget.show_loading_overlay();return;}
var quick_jump_left=t.findParent('div.quick_jump_left',this.container.dom,true);if(quick_jump_left){if(this.search_filter_menu&&this.search_filter_menu.is_showing())
this.search_filter_menu.hide();else
this.show_search_filter_menu(quick_jump_left);return;}
var gear_menu=t.findParent('div.gear_menu',this.container.dom);if(gear_menu){if(this.gear_menu&&this.gear_menu.is_showing())
this.gear_menu.hide();else
this.show_gear_menu(gear_menu);return;}
var other_entity_menu_item=t.findParent('div.page_tree_overlay_other_menu_item',this.container);if(other_entity_menu_item){var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;if(ctrl_click)return;this.hide();var root_widget=this.global_nav.get_page_root_widget();root_widget.show_loading_overlay();return;}},clear_auto_complete_input:function(value){var me=this;var input_value=value;setTimeout(function(){var input=me.container.child('input.search');input.dom.value=input_value?input_value:'';me.listbox.autocomplete_request();input.focus();},0);},prime_auto_complete_input:function(){if(this.mode!='search')return;this.clear_auto_complete_input(getCookie('sg_page_tree_overlay_search'));},show_project_filter_menu:function(folder_elem){if(!this.project_filter_menu){this.project_filter_menu=new SG.Menu({render_container:this.container,item_selected:{fn:this.on_project_filter_menu_item,scope:this}});}
this.project_filter_menu.items=this.global_nav.get_project_filter_menu_items(this.project_filter_mode,this.project_filter_value);this.project_filter_menu.render();this.project_filter_menu.position={dom_elem:folder_elem,elem_anchor:'bl',menu_anchor:'tl'};this.project_filter_menu.show();},on_project_filter_menu_item:function(menu,menu_item){this.project_filter_mode=menu_item.value;this.project_filter_value=menu_item.status_value?menu_item.status_value:null;var mode_key=this.get_project_filter_mode_cookie_name();var value_key=this.get_project_filter_value_cookie_name();var settings_hash={};settings_hash[mode_key]=this.project_filter_mode;settings_hash[value_key]=this.project_filter_value;if(this.open_paths.indexOf('ALL->ACTIVE PROJECTS')==-1){this.open_paths.push('ALL->ACTIVE PROJECTS');settings_hash[this.get_open_path_cookie_name()]=this.open_paths;}
this.set_settings(settings_hash);this.generate_all_nodes();this.re_render();},show_search_filter_menu:function(search_elem){if(!this.search_filter_menu){this.search_filter_menu=new SG.Menu({render_container:this.container,icon_width:20,item_selected:{fn:this.on_search_filter_menu_item,scope:this}});}
var items=[];for(var i=0;i<SG.schema.leftnav_page_entity_types.length;i++){var entity_type=SG.schema.leftnav_page_entity_types[i];var edn=SG.schema.entity_types[entity_type]['display_name_pluralized'];items.push({html:edn,entity_type:entity_type,icon_name:'icon_'+entity_type,checked:this.auto_complete_entities&&this.auto_complete_entities.indexOf(entity_type)!=-1});}
items.sort(function(a,b){return a.html.localeCompare(b.html);});items.push({html:'Canvas',entity_type:'_canvas_',icon_name:'icon_Page'});if(this.project_id===undefined){items.push({line:true});var project_records=this.global_nav.get_sorted_project_records('all');for(var i=0;i<project_records.length;i++){var rec=project_records[i];items.push({html:rec.get('name'),project_id:rec.id,checked:this.auto_complete_project_ids&&this.auto_complete_project_ids.indexOf(rec.id)!=-1});}}
this.search_filter_menu.items=items;this.search_filter_menu.render();this.search_filter_menu.position={dom_elem:search_elem,elem_anchor:'bl',menu_anchor:'tl'};this.search_filter_menu.show();},on_search_filter_menu_item:function(menu,menu_item){if(menu_item.project_id!==undefined){if(!this.auto_complete_project_ids)
this.auto_complete_project_ids=[menu_item.project_id];else if(this.auto_complete_project_ids.indexOf(menu_item.project_id)==-1)
this.auto_complete_project_ids.push(menu_item.project_id);else{var index=this.auto_complete_project_ids.indexOf(menu_item.project_id);this.auto_complete_project_ids.splice(index,1);}}else{if(!this.auto_complete_entities)
this.auto_complete_entities=[menu_item.entity_type];else if(this.auto_complete_entities.indexOf(menu_item.entity_type)==-1)
this.auto_complete_entities.push(menu_item.entity_type);else{var index=this.auto_complete_entities.indexOf(menu_item.entity_type);this.auto_complete_entities.splice(index,1);}}
this.listbox.autocomplete_request();var me=this;setTimeout(function(){var input=me.container.child('input.search');input.dom.focus();},100);},can_locate_current_page:function(){if(this.project_id===undefined){var page_project_id=this.global_nav.get_page_project_id();if(page_project_id==null){return this.is_project_data_set_loaded(-1);}
return true;}else{return true;}
var page_project_id=this.global_nav.get_page_project_id();return false;},show_gear_menu:function(gear_elem){if(!this.gear_menu){this.gear_menu=new SG.Menu({render_container:this.container,menu_class:'page_tree_overlay_other_menu',});}
var items=[];items.push({html:'New Page...',item_selected:{fn:this.show_new_page_dialog,scope:this},value:'Page',icon_name:'icon_plus'});var page_project_id=this.global_nav.get_page_project_id();items.push({html:'Locate Current Page...',item_selected:{fn:this.locate_current_page,scope:this},icon_name:'icon_drag_drop_handle',disabled:!this.can_locate_current_page()});var url;if(this.project_id===undefined)
url='/page/global_page?entity_type=Page';else
url='/page/project_default?entity_type=Page&project_id='+this.project_id;items.push({html:'<a href="'+url+'">Manage Pages ...</a>',item_class:'page_tree_overlay_other_menu_item'});this.gear_menu.items=items;this.gear_menu.render();this.gear_menu.position={dom_elem:gear_elem,elem_anchor:'bl',menu_anchor:'tl'};this.gear_menu.show();},locate_current_page:function(){var render_required=false;if(['all_pages','project_pages'].indexOf(this.mode)==-1){this.set_mode('other_pages');render_required=true;}
if(this.project_filter_mode!='all'){this.project_filter_mode='all';this.project_filter_value=null;var settings_hash={};settings_hash[this.get_project_filter_mode_cookie_name()]=this.project_filter_mode;settings_hash[this.get_project_filter_value_cookie_name()]=this.project_filter_value;this.set_settings(settings_hash);this.generate_all_nodes();render_required=true;}
if(render_required)
this.render();var prefix=this.project_id===undefined?'ALL->':this.project_path();var page_node=null;for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];if(node.page_rec&&this.page.id==node.page_rec.id&&node.path.indexOf(prefix)==0){page_node=node;break;}}
if(page_node===null){alert("Can't find current page in the page tree!");return;}
var path_parts=page_node.path.split('->');var path=path_parts[0];for(var i=1;i<path_parts.length;i++){path+='->'+path_parts[i];if(this.open_paths.indexOf(path)==-1)
this.open_paths.push(path);}
this.render();var page_elem=sg_find('a.page_link[href="/page/'+page_node.page_rec.id+'"]',this.container.dom);page_elem=Ext.get(page_elem);page_elem.scrollIntoView(this.scroll_container);},show_new_page_dialog:function(menu,menu_item){this.hide();this.global_nav.on_new_entity_menu_click(menu,menu_item);},show_autocomplete_spinner:function()
{var icon=this.container.child('div.state_icon');icon.removeClass('clear');icon.addClass('spinner');},hide_autocomplete_spinner:function()
{var icon=this.container.child('div.state_icon');icon.removeClass('spinner');icon.addClass('clear');},close_all_folders_below:function(path){var new_open_paths=[];for(var i=0;i<this.open_paths.length;i++){var open_path=this.open_paths[i];if(open_path.indexOf(path)!=0)
new_open_paths.push(open_path);}
this.open_paths=new_open_paths;this.set_open_paths_cookie();var me=this;setTimeout(function(){me.render();},0);},open_all_folders_below:function(path){var click_path=path;var me=this;setTimeout(function(){me.option_click_path=click_path;me.render();me.option_click_path=null;me.set_open_paths_cookie();},0);},open_folder:function(path){if(this.open_paths.indexOf(path)==-1){this.open_paths.push(path);this.set_open_paths_cookie();var folder_div=sg_find('div.folder[path="'+path+'"]',this.container.dom);folder_div=Ext.get(folder_div);folder_div.dom.setAttribute('state','open');var folder_contents_div=folder_div.child('div.folder_contents');if(folder_div.dom.hasAttribute('project_id')){var project_id=Number(folder_div.dom.getAttribute('project_id'));if(!this.is_project_data_set_loaded(project_id)){this.fetch_project_pages(project_id);folder_contents_div.update(this.templates.loading.apply());return;}}
var nodes=this.get_nodes_for_path(path);var html=this.render_nodes(nodes);folder_contents_div.update(html);if(path=='ALL->ACTIVE PROJECTS'){var filter_message_div=this.container.child('div.filter_message');if(!filter_message_div)
this.render_filter_message();}}},fetch_project_pages:function(project_id){var data_set=this.new_data_set('Page',this.on_load_project_data_set,this.on_data_set_change);data_set.project_id=project_id;this.project_data_sets[project_id]=data_set;var cols=["id","name","entity_type","project","folder","created_by","current_user_favorite","page_type","ui_category"];var project=null;if(project_id!=-1)
project={type:'Project',id:project_id};var spec={type:"Page",filters:{logical_operator:"and",conditions:[{path:"ui_category",relation:"in",values:["reports","project"]},{path:"project",relation:"is",values:[project]}]},columns:cols,sorts:[{column:"name",direction:"asc"}],result:data_set};SG.Repo.query(spec);},on_load_project_data_set:function(data_set){var proj_recs=[];for(var i=0;i<data_set.count();i++){var rec=data_set.get_record(i);if(rec.get('ui_category')=='reports')
proj_recs.push(rec);else
this.landing_page_recs.push(rec);}
var proj_nodes=[];var landing_nodes=[];var existing_folders=['ALL->ACTIVE PROJECTS'];var path_prefix='';if(data_set.project_id!=-1){var proj_data_set=SG.globals.global_projects_last_accessed_by_current_user;var proj=proj_data_set.get_record_by_id(data_set.project_id);path_prefix='ALL->ACTIVE PROJECTS->'+proj.get('name')+'->Pages';proj_nodes=this.generate_nodes_for_records(path_prefix,proj_recs);path_prefix='ALL->ACTIVE PROJECTS->'+proj.get('name');existing_folders.push(path_prefix);var landing_nodes=this.generate_landing_page_nodes(path_prefix,proj);}else{if(proj_recs.length>0){path_prefix='ALL->GLOBAL PAGES';existing_folders.push(path_prefix);proj_nodes=this.generate_nodes_for_records(path_prefix,proj_recs);}else{proj_nodes=[{path:'ALL->GLOBAL PAGES',message:'No Global Pages available'}];}}
var temp=landing_nodes.concat(proj_nodes);folders=this.generate_folder_nodes('ALL',temp,existing_folders);proj_nodes=proj_nodes.concat(folders);this.sort_nodes(proj_nodes);this.nodes=this.nodes.concat(landing_nodes);this.nodes=this.nodes.concat(proj_nodes);var folder_div=sg_find('div.folder[project_id="'+data_set.project_id+'"]',this.container.dom);if(!folder_div)return;folder_div=Ext.get(folder_div);var folder_contents_div=folder_div.child('div.folder_contents');var nodes=this.get_nodes_for_path(folder_div.dom.getAttribute('path'));var html=this.render_nodes(nodes);folder_contents_div.update(html);},is_project_data_set_loaded:function(project_id){var data_set=this.project_data_sets[project_id];if(data_set&&data_set.is_loaded())
return true;return false;},close_folder:function(path){var idx=this.open_paths.indexOf(path);this.open_paths.splice(idx,1);this.set_open_paths_cookie();var folder_div=sg_find('div.folder[path="'+path+'"]',this.container.dom);folder_div=Ext.get(folder_div);folder_div.dom.setAttribute('state','closed');var folder_contents_div=folder_div.child('div.folder_contents');folder_contents_div.update('');if(path=='ALL->ACTIVE PROJECTS'){var filter_message_div=this.container.child('div.filter_message');if(filter_message_div)
filter_message_div.remove();}},set_open_paths_cookie:function(){this.set_setting(this.get_open_path_cookie_name(),this.open_paths);},get_overlay_id:function(){var overlay_id=this.project_id===undefined?0:this.project_id;return overlay_id},get_open_path_cookie_name:function(overlay_id){if(overlay_id===undefined)overlay_id=this.get_overlay_id();return'sg_page_tree_overlay_open_paths_'+overlay_id;},get_scroll_cookie_name:function(overlay_id){if(overlay_id===undefined)overlay_id=this.get_overlay_id();return'sg_page_tree_overlay_'+this.mode+'_scroll_'+overlay_id;},get_mode_cookie_name:function(overlay_id){if(overlay_id===undefined)overlay_id=this.get_overlay_id();return'sg_page_tree_overlay_mode_'+overlay_id;},get_project_filter_mode_cookie_name:function(overlay_id){if(overlay_id===undefined)overlay_id=this.get_overlay_id();return'sg_page_tree_filter_mode_'+overlay_id;},get_project_filter_value_cookie_name:function(overlay_id){if(overlay_id===undefined)overlay_id=this.get_overlay_id();return'sg_page_tree_filter_value_'+overlay_id;},re_render:function(){var me=this;setTimeout(function(){me.render();},0);},my_path:function(){var overlay_id=this.get_overlay_id();return'MY_'+overlay_id;},project_path:function(){var overlay_id=this.get_overlay_id();return'PROJECT_'+overlay_id;},toggle_project_favorite:function(project_id,value){var data_set=SG.globals.global_projects_last_accessed_by_current_user;var rec=data_set.get_record_by_id(project_id);rec.set('current_user_favorite',value);var spec={type:'Project',id:project_id,column:'current_user_favorite',value:value,};SG.Repo.update(spec);},generate_all_nodes:function(){this.nodes=[];var remove_global_pages_folder=false;var render_project=this.project_id===undefined;var favorite_pages_set=SG.globals.global_popover_favorite_pages_set;var recent_pages_set=SG.globals.global_popover_recent_pages_set;if(!render_project){if(SG.globals.project_popover_favorite_pages_set)
favorite_pages_set=SG.globals.project_popover_favorite_pages_set;if(SG.globals.project_popover_recent_pages_set)
recent_pages_set=SG.globals.project_popover_recent_pages_set;}
var my_nodes=this.generate_nodes_for_records(this.my_path()+'->FAVORITES',favorite_pages_set.records,true,render_project);this.sort_nodes(my_nodes);var recent=this.generate_nodes_for_records(this.my_path()+'->RECENTLY VIEWED',recent_pages_set.records,true,render_project);my_nodes=my_nodes.concat(recent);var my_page_recs=[];for(var i=0;i<SG.globals.user_my_pages_set.count();i++){var page_rec=SG.globals.user_my_pages_set.get_record(i);my_page_recs.push(page_rec);}
var mine=this.generate_nodes_for_records(this.my_path()+'->MY PERSONAL PAGES',my_page_recs,true,render_project);my_nodes=my_nodes.concat(mine);var final_my_nodes=this.project_id===undefined?my_nodes:this.cull_project_nodes(my_nodes);var folders=this.generate_folder_nodes(this.my_path(),final_my_nodes);final_my_nodes=final_my_nodes.concat(folders);if(this.project_id===undefined){var global_nodes=[];var project_records=this.global_nav.get_sorted_project_records(this.project_filter_mode,this.project_filter_value);this.filtered_project_count=project_records.length;var all_landing_nodes=[];for(var i=0;i<project_records.length;i++){var proj=project_records[i];var proj_nodes=[];if(this.is_project_data_set_loaded(proj.id)){var proj_ds=this.project_data_sets[proj.id];var proj_recs=[];for(var j=0;j<proj_ds.count();j++){var rec=proj_ds.get_record(j);if(rec.get('ui_category')=='reports')
proj_recs.push(proj_ds.get_record(j));}
var path_prefix='ALL->ACTIVE PROJECTS->'+proj.get('name')+'->Pages';proj_nodes=this.generate_nodes_for_records(path_prefix,proj_recs);global_nodes=global_nodes.concat(proj_nodes);path_prefix='ALL->ACTIVE PROJECTS->'+proj.get('name');var landing_nodes=this.generate_landing_page_nodes(path_prefix,proj);all_landing_nodes=all_landing_nodes.concat(landing_nodes);}else{global_nodes.push({folder:proj.get('name'),path:'ALL->ACTIVE PROJECTS',project_id:proj.id,});}}
if(this.is_project_data_set_loaded(-1)){var proj_ds=this.project_data_sets[-1];var proj_recs=[];for(var j=0;j<proj_ds.count();j++){var rec=proj_ds.get_record(j);proj_recs.push(proj_ds.get_record(j));}
if(proj_recs.length>0){path_prefix='ALL->GLOBAL PAGES';proj_nodes=this.generate_nodes_for_records(path_prefix,proj_recs);}else{proj_nodes=[{path:'ALL->GLOBAL PAGES',message:'No Global Pages available'}];}
global_nodes=global_nodes.concat(proj_nodes);}else{global_nodes.push({folder:'GLOBAL PAGES',path:'ALL',project_id:-1});}
if(project_records.length==0)
all_landing_nodes.push({path:'ALL',folder:'ACTIVE PROJECTS'});var temp=all_landing_nodes.concat(global_nodes);folders=this.generate_folder_nodes('ALL',temp);global_nodes=global_nodes.concat(folders);this.sort_nodes(global_nodes);global_nodes=all_landing_nodes.concat(global_nodes);this.nodes=final_my_nodes.concat(global_nodes);}else{var project_recs=[];for(var i=0;i<SG.globals.current_project_pages_set.count();i++){var page_rec=SG.globals.current_project_pages_set.get_record(i);if(page_rec.get('ui_category')=='reports')
project_recs.push(page_rec);}
var proj_nodes=this.generate_nodes_for_records(this.project_path(),project_recs);folders=this.generate_folder_nodes(this.project_path(),proj_nodes);proj_nodes=proj_nodes.concat(folders);this.sort_nodes(proj_nodes);this.nodes=final_my_nodes.concat(proj_nodes);}},generate_landing_page_nodes:function(prefix,proj_record){var nodes=[];var entity_bricks=this.get_project_nav_bricks(proj_record.id);for(var i=0;i<entity_bricks.length;i++){var brick=entity_bricks[i];var url='';if(brick.entity_type=='Project')
url='/detail/Project/'+proj_record.id;else
url='/page/project_default?entity_type='+brick.entity_type+'&project_id='+proj_record.id;var display_name;if(!brick.display_name||brick.display_name=='')
display_name=SG.schema.entity_types[brick.entity_type]['display_name_pluralized'];else
display_name=brick.display_name;var node={path:prefix,entity_type:brick.entity_type,display_name:display_name};var rec=this.get_landing_page_rec(brick.entity_type,proj_record.id);if(rec)
node.page_rec=rec;else
node.url=url;nodes.push(node);}
return nodes;},get_landing_page_rec:function(entity_type,project_id){if(!this.landing_page_recs)return null;for(var i=0;i<this.landing_page_recs.length;i++){var rec=this.landing_page_recs[i];var et=rec.get('entity_type');var project=rec.get('project');if(et==entity_type&&project&&project.id==project_id)
return rec;}
return null;},get_project_nav_bricks:function(project_id){var project=SG.schema.project_by_id(project_id);var entity_field_pref=sg_get_entity_field_pref("nav_bar","Project",project);if(!entity_field_pref)
entity_field_pref=sg_get_entity_field_pref("nav_bar","Project");var i,et;var pp=sg_deep_copy(entity_field_pref.get("settings_serialized"));var entity_bricks=[];for(i=0;i<pp.length;i++){if(pp[i].app_name)continue;et=pp[i].entity_type;if(SG.schema.entity_types[et].enabled&&SG.schema.can_see_entity_type(et))
entity_bricks.push(pp[i]);}
return entity_bricks;},sort_nodes:function(nodes){nodes.sort(function(a,b){if(a.folder&&!b.folder){return 1;}else if(!a.folder&&b.folder){return-1;}else if(a.folder&&b.folder){return a.folder.localeCompare(b.folder);}else if(!a.folder&&!b.folder){if(a.page_rec&&b.page_rec){var a_name=a.page_rec.get('name');var b_name=b.page_rec.get('name');if(!a_name)a_name='';if(!b_name)b_name='';return a_name.localeCompare(b_name);}else if(a.page_rec&&!b.page_rec){var a_name=a.page_rec.get('name');if(!a_name)a_name='';var b_name=b.display_name;return a_name.localeCompare(b_name);}else if(!a.page_rec&&b.page_rec){var b_name=b.page_rec.get('name');if(!b_name)b_name='';var a_name=a.display_name;return a_name.localeCompare(b_name);}else if(!a.page_rec&&!b.page_rec){var a_name=a.display_name;var b_name=b.display_name;return a_name.localeCompare(b_name);}}});},cull_project_nodes:function(nodes){var ret_nodes=[];for(var i=0;i<nodes.length;i++){var node=nodes[i];var proj=node.page_rec.get('project');if(proj&&proj.id==this.project_id)
ret_nodes.push(node);}
return ret_nodes;},generate_folder_nodes:function(path_prefix,nodes,existing_folders){if(!existing_folders)existing_folders=[];var folder_nodes=[];for(var i=0;i<nodes.length;i++){var node=nodes[i];var path_parts=node.path.split('->');var path=path_prefix;var new_path;for(j=1;j<path_parts.length;j++){new_path=path+'->'+path_parts[j];if(existing_folders.indexOf(new_path)==-1){var folder_node={path:path,folder:path_parts[j]};folder_nodes.push(folder_node);existing_folders.push(new_path);}
path=new_path;}}
return folder_nodes;},generate_nodes_for_records:function(path_prefix,records,no_folder_path,render_project){var nodes=[];for(var i=0;i<records.length;i++){var rec=records[i];nodes.push({path:no_folder_path?path_prefix:this.generate_path(path_prefix,rec),page_rec:rec,render_project:render_project});}
return nodes;},generate_path:function(path_prefix,page_rec){var path=path_prefix;var folder=page_rec.get('folder');if(folder){var parts=folder.split('->');for(var i=0;i<parts.length;i++){var part=parts[i];path+='->'+part.trim();}}
return path;},get_nodes_for_path:function(path){var nodes=[];for(var i=0;i<this.nodes.length;i++){var node=this.nodes[i];if(node.path==path)
nodes.push(node);}
return nodes;},get_open_closed_state_for_path:function(path){if(this.option_click_path&&path.indexOf(this.option_click_path)==0){if(this.open_paths.indexOf(path)==-1)
this.open_paths.push(path);return'open';}
if(this.open_paths.indexOf(path)!=-1)
return'open';else
return'closed';},render_nodes:function(nodes){var html='';for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node.message){html+=this.templates.filter_message.apply({message:node.message});}else if(node.folder){var folder_contents='';var fav_icon='';var state=this.get_open_closed_state_for_path(node.path+'->'+node.folder);if(state=='open'){if(node.project_id!=undefined&&!this.is_project_data_set_loaded(node.project_id)){this.fetch_project_pages(node.project_id);folder_contents=this.templates.loading.apply();}else{var folder_nodes=this.get_nodes_for_path(node.path+'->'+node.folder);folder_contents=this.render_nodes(folder_nodes);}}
var header_cls='';var folder_name=node.folder;if(node.path.indexOf('->')==-1&&node.path.indexOf('PROJECT_')==-1){header_cls='section_header';folder_name=this.camel_case(node.folder);}
var folder_icon_override='';if(node.path=='ALL->ACTIVE PROJECTS'){var data_set=SG.globals.global_projects_last_accessed_by_current_user;var proj_rec=data_set.get_record_by_id(node.project_id);if(!proj_rec)proj_rec=this.find_project_record_for_project_name(node.folder);folder_icon_override='project_icon';fav_icon=this.templates.fav_icon_for_project.apply({favorite:proj_rec.get('current_user_favorite')?'true':'false',project_id:node.project_id});}
var project_id='';if(node.project_id!=undefined){project_id='project_id="'+node.project_id+'"';}
var extra_folder_class='';if(node.path=='ALL'&&node.folder=='ACTIVE PROJECTS'){extra_folder_class='filter_menu';folder_name=this.templates.project_filter_menu.apply({display_name:this.global_nav.get_project_filter_display_name(this.project_filter_mode,this.project_filter_value)});}
html+=this.templates.folder.apply({path:node.path+'->'+node.folder,state:state,folder_name:folder_name,folder_contents:folder_contents,header_cls:header_cls,folder_icon_override:folder_icon_override,fav_icon:fav_icon,extra_folder_class:extra_folder_class,project_id:project_id});}else{var entity_icon,page_name,url,selected,project_name,sg_tip,fav_icon;if(node.page_rec){entity_type=node.page_rec.get('entity_type');entity_icon=entity_type?'icon_'+entity_type:'icon_Page';var fav=node.page_rec.get('current_user_favorite');fav_icon=this.templates.fav_icon.apply({favorite:fav,page_id:node.page_rec.id});project_name='';if(node.render_project){var proj=node.page_rec.get('project');if(proj)
project_name+='('+proj.name+')';}
page_name=node.display_name?node.display_name:node.page_rec.get('name');sg_tip=page_name+" "+project_name;url='/page/'+node.page_rec.id;selected=this.page.id==node.page_rec.id?'selected':'';}else{fav_icon='';entity_icon=node.entity_type=='Project'?'icon_Page':'icon_'+node.entity_type;project_name='';page_name=node.display_name;sg_tip=page_name;selected='';url=node.url;}
html+=this.templates.page.apply({entity_icon:entity_icon,page_name:page_name,url:url,fav_icon:fav_icon,selected:selected,project_name:project_name,sg_tip:sg_tip,});}}
return html;},find_project_record_for_project_name:function(project_name){var data_set=SG.globals.global_projects_last_accessed_by_current_user;for(var i=0;i<data_set.count();i++){var record=data_set.get_record(i);if(record.get('name')==project_name)
return record;}
return null;},request_params:function(search_text){this.show_autocomplete_spinner();var complete_classes={Page:{}};if(this.auto_complete_entities&&this.auto_complete_entities.length>0)
complete_classes={Page:{path:'entity_type',relation:'in',values:this.auto_complete_entities}};var request_params={query:search_text,sg_autocomplete:true,complete_classes:Ext.encode(complete_classes)};if(this.project_id!=undefined)
request_params.project_ids=Ext.encode([this.project_id]);else if(this.auto_complete_project_ids&&this.auto_complete_project_ids.length>0)
request_params.project_ids=Ext.encode(this.auto_complete_project_ids);setCookie('sg_page_tree_overlay_search',search_text,300000)
return request_params;},on_autocomplete_response:function(response){this.hide_autocomplete_spinner();var matches=response.matches;var search_terms=response.terms;var items=[];for(var i=0;i<matches.length;i++){var match=matches[i];var name=this.highlight_search_terms(search_terms,match.name);var proj_and_folder=this.highlight_search_terms(search_terms,match.links[1])
var parts=match.subtype.split('|');items.push({page_id:match.id,project_id:match.project_id,page_name:name,project_and_folder:proj_and_folder,sg_tip:match.name+' '+match.links[1],page_type:parts[0],entity_type:parts.length==2?parts[1]:null})}
return items;},render_search_results:function(items){if(!items)items=[];var html='';for(var i=0;i<items.length;i++){var item=items[i];if(item.disabled){html+=this.templates.search_message.apply({html:item.html});continue;}
var icon='icon_Page';if(item.entity_type)
icon='icon_'+item.entity_type;var project_name='';if(item.project_and_folder&&item.project_and_folder!='')
project_name='('+item.project_and_folder+')';html+=this.templates.search_result.apply({sg_tip:item.sg_tip,icon:icon,label:item.page_name,url:'/page/'+item.page_id,selected:i==0?'selected':'',project_name:project_name,current_page:this.page.id==item.page_id?'current_page':'',});}
var search_results_div=this.container.child('div.search_results');search_results_div.update(html);},on_search_item_selected:function(item){},highlight_search_terms:function(search_terms,result)
{var result_lc=result.toLowerCase();var idx,term,indices=[];for(var i=0;i<search_terms.length;++i)
{term=search_terms[i];idx=result_lc.indexOf(term);if(idx!==-1){indices.push([idx,idx+term.length-1]);}}
indices.sort(function(a,b){return a[0]-b[0];});if(indices.length>0)
{var combined_indices=[];var low=indices[0][0];var high=indices[0][1];idx=0;while(idx<indices.length)
{if(idx===indices.length-1)
{high=indices[idx][1];combined_indices.push([low,high]);}
else if(indices[idx][1]>=indices[idx+1][0])
{high=indices[idx+1][1];}
else
{combined_indices.push([low,high]);low=indices[idx+1][0];high=indices[idx+1][1];}
idx+=1;}
var ret=result.substring(0,combined_indices[0][0]);for(var i=0;i<combined_indices.length;++i)
{ret+='<span class="match">'+result.substring(combined_indices[i][0],combined_indices[i][1]+1)+'</span>';if(i!==combined_indices.length-1&&combined_indices[i][1]+1<combined_indices[i+1][0])
{ret+=result.substring(combined_indices[i][1]+1,combined_indices[i+1][0]);}}
ret+=result.substring(combined_indices[combined_indices.length-1][1]+1,result.length);return ret;}
else
return result;},toggle_favorite:function(page_id,favorite){var value=!favorite;var data_sets=[SG.globals.global_popover_recent_pages_set,SG.globals.global_popover_favorite_pages_set,SG.globals.project_popover_recent_pages_set,SG.globals.user_my_pages_set,SG.globals.project_popover_favorite_pages_set];for(var project_id in this.project_data_sets){if(!this.project_data_sets.hasOwnProperty(project_id))continue;var proj_set=this.project_data_sets[project_id];data_sets.push(proj_set);}
var i,j,data_set;var records_to_add_to_favorites=[];for(i=0;i<data_sets.length;i++){data_set=data_sets[i];if(!data_set)continue;var is_favorite_set=false;if(data_set==SG.globals.global_popover_favorite_pages_set||data_set==SG.globals.project_popover_favorite_pages_set){is_favorite_set=true;}
var record=data_set.get_record_by_id(page_id);if(!record)continue;record.set('current_user_favorite',value);if(value){records_to_add_to_favorites.push(record);}else if(is_favorite_set){data_set.remove(record);}}
data_sets=[SG.globals.global_popover_favorite_pages_set,SG.globals.project_popover_favorite_pages_set];var done_ids=[];for(i=0;i<records_to_add_to_favorites.length;i++){var record=records_to_add_to_favorites[i];if(done_ids.indexOf(record.id)!=-1)continue;for(j=0;j<data_sets.length;j++){data_set=data_sets[j];if(!data_set)continue;data_set.prepend_record(record);}
done_ids.push(record.id);}
var spec={type:'Page',id:page_id,column:'current_user_favorite',value:value,};SG.Repo.update(spec);},on_data_set_change:function(changes){if(this.is_visible())return;var server_update=false;for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='server'){server_update=true;break;}}
if(!server_update)return;this.generate_all_nodes();this.re_render();},on_keydown:function(e){if(!this.is_visible()||(this.gear_menu&&this.gear_menu.is_showing())||(this.search_filter_menu&&this.search_filter_menu.is_showing())){return;}
var key_id=e.getKey();if(key_id==Ext.EventObject.ESC){if(this.mode=='search'){var input=this.container.child('input.search');if(input.dom.value=='')
this.hide();else
this.clear_auto_complete_input();}else{this.hide();}}},init_settings:function(){if(SG.globals.page_overlay_settings===false){this.__settings__=this.extract_legacy_cookies_and_delete();this.update_persisted_settings();}else{this.__settings__=SG.globals.page_overlay_settings||{};}},get_setting:function(key){return this.__settings__[key];},set_setting:function(key,value){this.__settings__[key]=value;this.update_persisted_settings();},set_settings:function(settings_hash){for(var key in settings_hash){if(!settings_hash.hasOwnProperty(key))continue;this.__settings__[key]=settings_hash[key];}
this.update_persisted_settings();},extract_legacy_cookies_and_delete:function(){var ret={};var i;var ids_todo=[0];for(i=0;i<SG.schema.projects.length;i++){var project=SG.schema.projects[i];ids_todo.push(project.id);}
var to_delete=[];var cookie_name,cookie;for(var i=0;i<ids_todo.length;i++){var id=ids_todo[i];cookie_name=this.get_open_path_cookie_name(id);cookie=getCookie(cookie_name);if(cookie){to_delete.push(cookie_name);var open_path=Ext.decode(cookie);ret[cookie_name]=open_path;}
cookie_name=this.get_mode_cookie_name(id);cookie=getCookie(cookie_name);if(cookie){to_delete.push(cookie_name);ret[cookie_name]=cookie;}
cookie_name=this.get_project_filter_mode_cookie_name(id);cookie=getCookie(cookie_name);if(cookie){to_delete.push(cookie_name);ret[cookie_name]=cookie;}
cookie_name=this.get_project_filter_value_cookie_name(id);cookie=getCookie(cookie_name);if(cookie){to_delete.push(cookie_name);ret[cookie_name]=cookie;}
cookie_name=this.get_scroll_cookie_name(id);cookie=getCookie(cookie_name);if(cookie){to_delete.push(cookie_name);ret[cookie_name]=cookie;}}
for(i=0;i<to_delete.length;i++){cookie_name=to_delete[i];setCookie(cookie_name,null);}
return ret;},update_persisted_settings:function()
{var options={url:'/page/set_page_overlay_settings',params:{page_overlay_settings:Ext.encode(this.__settings__)},scope:this};var conn=new Ext.data.Connection();conn.request(options);SG.globals.page_overlay_settings=this.__settings__;},camel_case:function(str){var str_lower=str.toLowerCase();var parts=str_lower.split(' ');var ret=[];for(var i=0;i<parts.length;i++){var part=parts[i];ret.push(part.substr(0,1).toUpperCase()+part.substr(1));}
return ret.join(' ');},destroy_component:function(){Ext.EventManager.removeResizeListener(this.on_window_resize,this);},on_window_resize:function(){var dbody=Ext.get(document.body);var browser_width=dbody.getWidth();var browser_height=dbody.getHeight();var overlay_width=this.container.getWidth();var overlay_height=this.container.getHeight();var overlay_top=this.container.getTop();var overlay_left=this.container.getLeft();if((overlay_left+overlay_width)>browser_width){var new_width=browser_width-overlay_left-10;this.container.setWidth(new_width);this.set_setting('sg_page_tree_overlay_width',new_width);}
if((overlay_top+overlay_height)>browser_height){var new_height=browser_height-overlay_top-10;this.container.setHeight(new_height);}},on_project_specific_pages_load:function(){if(this.project_dependent_data_sets_ready()){this.generate_all_nodes();if(this.is_visible())
this.re_render();}},request_project_specfic_pages:function(){SG.globals.project_popover_recent_pages_set=new SG.Data.Set("Page");SG.globals.project_popover_favorite_pages_set=new SG.Data.Set("Page");SG.globals.current_project_pages_set=new SG.Data.Set("Page");this.add_event(SG.globals.project_popover_recent_pages_set,'load',this.on_project_specific_pages_load);this.add_event(SG.globals.project_popover_favorite_pages_set,'load',this.on_project_specific_pages_load);this.add_event(SG.globals.current_project_pages_set,'load',this.on_project_specific_pages_load);this.add_event(SG.globals.project_popover_recent_pages_set,'change',this.on_data_set_change);this.add_event(SG.globals.project_popover_favorite_pages_set,'change',this.on_data_set_change);this.add_event(SG.globals.current_project_pages_set,'change',this.on_data_set_change);var page_request_columns=["id","name","entity_type","project","folder","created_by","current_user_favorite","page_type","ui_category"];var spec1={type:"Page",filters:{logical_operator:"and",conditions:[{path:"ui_category",relation:"in",values:["reports","global_report","project"]},{path:"project",relation:"is",values:[{type:"Project",id:this.project_id}]},]},columns:page_request_columns,sorts:[{column:"last_accessed_by_current_user",direction:"desc"},{column:"created_at",direction:"desc"},],current_page:1,records_per_page:10,result:SG.globals.project_popover_recent_pages_set};SG.Repo.query(spec1);var spec2={type:"Page",filters:{logical_operator:"and",conditions:[{path:"ui_category",relation:"in",values:["reports","global_report","project"]},{path:"current_user_favorite",relation:"is",values:["true"]},{path:"project",relation:"is",values:[{type:"Project",id:this.project_id}]},]},columns:page_request_columns,sorts:[{column:"last_accessed_by_current_user",direction:"desc"},{column:"created_at",direction:"desc"},],current_page:1,records_per_page:25,result:SG.globals.project_popover_favorite_pages_set};SG.Repo.query(spec2);var spec3={type:"Page",filters:{logical_operator:"and",conditions:[{path:"ui_category",relation:"in",values:["reports","project"]},{path:"project",relation:"is",values:[{type:"Project",id:this.project_id}]},]},columns:page_request_columns,sorts:[{column:"name",direction:"asc"}],current_page:1,records_per_page:5000,result:SG.globals.current_project_pages_set};SG.Repo.query(spec3);},});SG.globals.__note_addressings_count__=0;SG.NoteAdressings=function(cfg)
{Ext.apply(this,cfg);SG.NoteAdressings.superclass.constructor.call(this);};Ext.extend(SG.NoteAdressings,SG.Component,{templates:{main:'<div class="icon_HumanUser"></div>{count_summary}{steps}',step:'<span class="step_name {spacer_class}">{step_name}'+'<span class="comma">,</span><span class="colon">:</span></span>{people}',person:'<span class="person">{name}</span>',no_recipients:'<span class="no_recipients">No recipients yet</span>',count_summary:'<span class="count_summary">{label}</span>',comma:'<span class="comma">,</span>',loading:'<img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/>',summary:'<span class="step_name">{summary_text}</span>',},init_component:function(){SG.globals.__note_addressings_count__+=1;this.my_id=SG.globals.__note_addressings_count__;this.show_all=false;this.data_set=this.new_data_set('Task',this.on_data_load);this.data_set.__id=this.my_id;this.add_event(this.owner_data_set,'change',this.on_owner_data_set_change);if(this.tasks){this.read_data();}
this.log('init_component()');},log:function(message,obj,trace){return;console.log('*** Note Addressings %d ***',this.my_id);console.log(message);if(obj)
console.log(obj);if(trace)
console.trace();console.log('***************************');},on_data_load:function(){this.log('on_data_load',this.data_set);this.hide_loading_overlay();this.group_by_step();if(this.ready_to_render_callback)
this.ready_to_render_callback.fn.call(this.ready_to_render_callback.scope,this);else
this.render();},group_by_step:function(){this.steps={};this.addressings={};if(this.addressings_to)
this.addressings[0]=this.addressings_to;for(var i=0;i<this.data_set.count();i++){var rec=this.data_set.get_record(i);var step=rec.get('step');var step_id=0;if(step){var real_step=SG.schema.get_step_schema(step);if(real_step)step_id=step.id;}
var addressings=rec.get('task_assignees');if(!addressings)continue;if(step_id!=0)
this.steps[step_id]=step;if(this.addressings[step_id]){var new_array=this.addressings[step_id].concat(addressings);this.addressings[step_id]=new_array;}else{this.addressings[step_id]=addressings;}}},set_tasks:function(tasks,addressings_to){if(!tasks||tasks.length==0){this.data_set.destroy();this.data_set=this.new_data_set('Task',this.on_data_load);this.steps={};this.addressings={};if(addressings_to)
this.addressings[0]=addressings_to;this.render();return;}
this.addressings_to=sg_deep_copy(addressings_to);this.tasks=sg_deep_copy(tasks);this.read_data();},set_summary_mode:function(on){this.summary_mode=on;this.render();},get_record_id:function(){if(this.record_id!==undefined)
return this.record_id;else if(this.owner.record)
return this.owner.record.id;else
return null;},render:function(){var container=this.get_container();if(!container){this.log('NO CONTAINER',null,true);return;}
var html;if(this.summary_mode)
html=this.render_summary();else
html=this.render_long_form();container.update(html);this.manage_container_classes(container);},manage_container_classes:function(container){if(this.summary_mode&&!container.hasClass('summary_mode'))
container.addClass('summary_mode');if(!this.summary_mode&&container.hasClass('summary_mode'))
container.removeClass('summary_mode')},render_summary:function(){var total=0;for(var step_id in this.addressings){if(!this.addressings.hasOwnProperty(step_id))continue;var addressings=this.addressings[step_id];if(addressings)
total+=addressings.length;}
var summary_text='';if(total==1)
summary_text='Addressed to 1 person';else
summary_text='Addressed to '+total+' people';var summary=this.templates.summary.apply({summary_text:summary_text,});return this.templates.main.apply({count_summary:summary,steps:'',});},render_long_form:function(){var people_no_step='';var step_html='';var count=0;for(var step_id in this.addressings){if(!this.addressings.hasOwnProperty(step_id))continue;var addressings=this.addressings[step_id];if(addressings.length==0)continue;if(step_id==0){people_no_step=this.render_people(this.addressings[step_id]);}else{var step=SG.schema.get_step_schema(this.steps[step_id]);step_html+=this.templates.step.apply({step_name:step.short_name,people:this.render_people(this.addressings[step_id]),spacer_class:count=='0'?'':'left_spacer',});}
count+=1;}
if(people_no_step!=''){step_html+=this.templates.step.apply({step_name:'No Step',people:people_no_step,spacer_class:count=='0'?'no_step':'no_step left_spacer',});}
var count_summary='';if(count==0)
count_summary=this.templates.no_recipients.apply();return this.templates.main.apply({count_summary:count_summary,steps:step_html,});},render_for_html_email:function(){var step_name_html;var people_no_step='';var step_html=[];var count=0;for(var step_id in this.addressings){if(!this.addressings.hasOwnProperty(step_id))continue;var addressings=this.addressings[step_id];if(addressings.length==0)continue;if(step_id==0){step_name_html='<span style="font-weight:bold;color:#566881;">No Step: </span>';people_no_step=step_name_html+this.render_people_for_email(this.addressings[step_id]);}else{var step=SG.schema.get_step_schema(this.steps[step_id]);step_name_html='<span style="font-weight:bold;color:#566881;">'+step.short_name+': '+'</span>';step_html.push(step_name_html+this.render_people_for_email(this.addressings[step_id]));}
count+=1;}
if(people_no_step!='')
step_html.push(people_no_step);if(count==0)
return'<span style="font-style:italics;">No recipients yet</span>';else
return step_html.join(' ');},render_people_for_email:function(addressings){var people=[];for(var i=0;i<addressings.length;i++){var person=addressings[i];people.push(person.name);}
return'<span style="color:#4C4C4C;">'+people.join(', ')+'</span>';},render_people:function(addressings){var html='';for(var i=0;i<addressings.length;i++){var person=addressings[i];var name=person.name;if(i<(addressings.length-1))
name+=this.templates.comma.apply();html+=this.templates.person.apply({name:name});}
return html;},get_container:function(){if(!this.owner.get_container)
return null;var owner_container=this.owner.get_container();if(!owner_container)
return null;var container=null;if(this.container_selector){var container=sg_find(this.container_selector,owner_container.dom)
if(container)container=Ext.get(container);}else{var container=owner_container.child('div.sgc_note_addressings');}
return container;},read_data:function(){this.show_loading_overlay();var task_ids=[];for(var i=0;i<this.tasks.length;i++){task_ids.push(this.tasks[i].id);}
var spec={type:"Task",filters:{logical_operator:"and",conditions:[{path:"id",relation:"in",values:task_ids}]},columns:['step','task_assignees'],result:this.data_set,}
var msg='read_data for record_id: '+this.get_record_id();this.log(msg,spec);SG.Repo.query(spec);},show_loading_overlay:function(){var container=this.get_container();if(!container)return;container.update(this.templates.loading.apply());},hide_loading_overlay:function(){var container=this.get_container();if(!container)return;container.update('');},on_owner_data_set_change:function(changes){var record_id=this.get_record_id();var change_columns=['tasks','addressings_to'];var draft_ids=[];for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='pending')continue;if(change.type=='update'&&change_columns.indexOf(change.column)>-1&&change.record.id==record_id&&!change.value_unchanged)
{this.log('owner_data_set_change',change);this.set_tasks_from_owner_record();return;}}},set_tasks_from_owner_record:function(){var record=this.owner_data_set.get_record_by_id(this.get_record_id());this.set_tasks(record.get('tasks'),record.get('addressings_to'));},destroy_component:function(){this.log('destroy_component');},});SG.PasswordValidator=function(cfg)
{Ext.apply(this,cfg);SG.PasswordValidator.superclass.constructor.call(this);};Ext.extend(SG.PasswordValidator,SG.Component,{templates:{main:'<div class="sgc_password_validator">'+'{current_password}{password}{confirm_password}{strength_indicator}</div>',row:'<div class="row {row_class}"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value {value_class}">{value}</div></td></tr></table></div>',password_input:'<input id="{id}" type="password" value="{value}">',},init_component:function(){var doc=Ext.get(document);this.add_event(doc,'keydown',this.on_keydown);this.current_password='';this.password='';this.confirm_password='';this.strength=0;this.render();},on_keydown:function(e){var me=this;setTimeout(function(){me.update_passwords();},0);},update_passwords:function(){var current_password=sg_find('#sg_current_password',this.container.dom);if(current_password){current_password=Ext.get(current_password);this.current_password=current_password.dom.value;}
var password=Ext.get(sg_find('#sg_password',this.container.dom));var pass=password.dom.value;if(pass!=this.password){this.password=pass;this.compute_strength();this.re_render_strength_indicator();}
var confirm_password=Ext.get(sg_find('#sg_confirm_password',this.container.dom));this.confirm_password=confirm_password.dom.value;},render:function(){var html=this.templates.main.apply({current_password:this.render_current_password(),password:this.render_password(),confirm_password:this.render_confirm_password(),strength_indicator:this.render_strength_indicator()});this.container.update(html);},render_current_password:function(){if(!this.require_current_password)return'';return this.templates.row.apply({row_class:'current_password',label:'Current Password:',value:this.templates.password_input.apply({id:'sg_current_password',value:this.current_password})});},render_password:function(){return this.templates.row.apply({row_class:'',label:'Password:',value:this.templates.password_input.apply({id:'sg_password',value:this.password})});},render_confirm_password:function(){return this.templates.row.apply({row_class:'',label:'Confirm Password:',value:this.templates.password_input.apply({id:'sg_confirm_password',value:this.confirm_password})});},render_strength_indicator:function(){var message=this.templates.row.apply({value_class:'strength_message',value:'Pick a good one:  8+ characters, including 3 of the following:  upper case letters, '+'lower case letters, numbers, symbols',});var meter=this.templates.row.apply({row_class:'strength',value:this.render_strength_meter()});return message+meter;},render_strength_meter:function(){return SG.Renderers.password_strength.render(this.strength);},re_render_strength_indicator:function(){var row=Ext.get(sg_find('div.row.strength',this.container.dom));var value_td=row.child('td.value');value_td.update(this.render_strength_meter());},compute_strength:function(){this.strength=0;var length=0;for(var i=0;i<this.password.length;i++){var c=this.password.charAt(i);if(!c.match(/\s/))
length++;}
if(length>7){this.strength+=18;}
if(this.password_has_lower_case()){this.strength+=18;}
if(this.password_has_upper_case()){this.strength+=18;}
if(this.password.match(/\d+/)){this.strength+=18;}
if(this.password.match(/.[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/)){this.strength+=18;}
if(this.strength>=70&&length>10)
this.strength+=18;if(this.strength>100)
this.strength=100;if(this.password.match(/^$|\s+/)&&length!=0)
this.strength=18;},get_strength_level:function(){var rating=[0,"",10,"Weak",20,"Fair",50,"Better",60,"Medium",70,"Good",90,"Strong"];var msg='';for(var i=rating.length-2;i>=0;i-=2){if(this.strength>=rating[i]){msg=rating[i+1];break;}}
return msg;},password_issue_message:function(){var msg='';if(this.require_current_password&&this.current_password==''){return"Please provide your current password"}
if(this.password!=this.confirm_password){msg+="Your new password and confirmation password do not match.\n";}
if(this.password.match(/^$|\s+/)){msg+="Your password can not contain spaces.\n";}
if(this.password.length<8){msg+="Your password is too short, It must be at least 8 characters.\n";}
var sub_msg=[];var count=0;if(this.password_has_lower_case())
count++;else
sub_msg.push("- lower case letters");if(this.password_has_upper_case())
count++;else
sub_msg.push("- upper case letters");if(this.password.match(/\d+/))
count++;else
sub_msg.push("- a number");if(this.password.match(/[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/))
count++;else
sub_msg.push("- a symbol");if(count<3){msg+='Your password must contain '+(3-count)+' of the following:\n'+sub_msg.join('\n')+'\n';}
if(msg=='')
return null
else
return'There are some problems with your password that you need to fix:\n\n'+msg;},is_a_character:function(c){if(c==' '||c.match(/\d/)||c.match(/[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/))
return false;else
return true;},char_has_case:function(c){return(c.toUpperCase()!=c.toLowerCase());},password_has_upper_case:function(){for(var i=0;i<this.password.length;i++){var c=this.password.charAt(i);if(!this.is_a_character(c))continue;if(this.char_has_case(c)&&c==c.toUpperCase())
return true;}
return false;},password_has_lower_case:function(){for(var i=0;i<this.password.length;i++){var c=this.password.charAt(i);if(!this.is_a_character(c))continue;if(c==c.toLowerCase())
return true;}
return false;},get_password:function(){return this.password;},get_current_password:function(){return this.current_password;},get_password_strength:function(){return this.strength;},set_focus:function(){var selector='input#sg_password';if(this.require_current_password)
selector='input#sg_current_password';var input=this.container.child(selector);input.focus();},});SG.AppWelcomeOverlay=function(config){Ext.apply(this,config);SG.AppWelcomeOverlay.superclass.constructor.call(this,config);};Ext.extend(SG.AppWelcomeOverlay,SG.Component,{templates:{main:'<div class="sgc_app_welcome_overlay">'+'<div class="title">{app_title}</div>'+'<div class="content">{content}</div>'+'<div class="right_bar">{right_bar}</div>'+'<div class="footer"><input class="opt_out_check" type="checkbox" {opt_out_checked} />'+'<span class="checkbox_label">Show this window when '+'{app_display_name} opens (you can always get to it later in the gear menu)</span>'+'<input type="button" value="Close" class="close_overlay" /></div></div>',crew_planning_app_0_1:'<div class="crew_planning_app_0_1"><img src="/images/shotgun_crew_planning_app_overview.png" /></div>',crew_planning_app_0_1_title:'<div class="crew_planning_app_0_1_title">Welcome to Crew Planning 0.1</div>'+'<div class="crew_planning_app_0_1_minor_title">Easily see and manage the projects your team members '+'are working on.</div>',crew_planning_app_0_1_right_bar:'<div class="crew_planning_app_0_1_right_bar"><div class="video_tutorial">'+'<div class="video has_youtube" youtube_id="6bHOTTyuCaw">'+'<img class="play_button" src="/images/review_app_play_overlay_button.png" />'+'<img src="/images/cp_video_tutorial_thumb.png" /></div><div class="heading">Video Tutorial</div>'+'<div class="description">'+"Take a quick tour of the app's main features.</div></div>"+'<div class="help_and_docs">'+'<a target ="_blank" href="https://support.shotgunsoftware.com/entries/21655662">'+'<img class="help_icon" src="/images/help_book.png" /></a>'+'<div class="heading">Help and Docs</div><div class="description">'+'Learn more about the Crew Planning app, recommended workflows and tips & tricks '+'<a href="https://support.shotgunsoftware.com/entries/21655662" target="_blank">on our help site<a>.'+'</div></div></div>',youtube_overlay:'<div class="sg_dialog_mask for_youtube" onclick="sg_kill_youtube_overlay()">'+'<div class="youtube_wrapper">'+'<iframe id="ytplayer" type="text/html" width="640" height="390" '+'src="http://www.youtube.com/embed/{youtube_id}?autoplay=1" frameborder="0"/>'+'</div></div>'},init_component:function(){this.current_user_ds=this.new_data_set('HumanUser',this.on_load_current_user);this.app_welcome_ds=this.new_data_set('AppWelcome',this.on_load_app_welcome);this.fetch_app_welcome();},render:function(){var content_template=this.app_name+'_'+this.app_version.replace('.','_','g');if(!this.templates[content_template])return;var html=this.templates.main.apply({app_title:this.templates[content_template+'_title'].apply(),right_bar:this.templates[content_template+'_right_bar'].apply(),content:this.templates[content_template].apply(),app_display_name:this.app_display_name,opt_out_checked:this.first_time_caller||this.opted_out?'':'checked="true"'});this.mask=Ext.DomHelper.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=Ext.DomHelper.append(this.mask,html,true);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);this.position_overlay();Ext.EventManager.onWindowResize(this.position_overlay,this);},position_overlay:function(){var w=this.container.getWidth();var h=this.container.getHeight();var dbody=Ext.get(document.body);var dw=dbody.getWidth();var dh=dbody.getHeight();var l=Math.floor((dw-w)*0.5);var t=Math.floor((dh-h)*0.5);if(l<0)l=0;if(t<0)t=0;this.container.setLeft(l);this.container.setTop(t);},on_click:function(e){var t=Ext.get(e.getTarget());var close_overlay=t.findParent('input.close_overlay',this.container.dom);if(close_overlay){this.destroy();return;}
var youtube_link=t.findParent('.has_youtube',this.container.dom);if(youtube_link){var youtube_id=youtube_link.getAttribute('youtube_id');var mask=Ext.DomHelper.append(document.body,this.templates.youtube_overlay.apply({youtube_id:youtube_id,}),true);var wrapper=mask.child('div.youtube_wrapper');var dbody=Ext.get(document.body);var l=Math.floor((dbody.getWidth()-wrapper.getWidth())*0.5);var t=Math.floor((dbody.getHeight()-wrapper.getHeight())*0.5);wrapper.setLeft(l);wrapper.setTop(t);return;}},on_change:function(e){var opt_out_check=this.container.child('input.opt_out_check');if(opt_out_check.dom.checked){this.current_user.multi_entity_set('app_welcomes',[this.app_as_entity()],'remove');this.current_user.commit(true);}else{this.current_user.multi_entity_set('app_welcomes',[this.app_as_entity()],'add');this.current_user.commit(true);}},destroy_component:function(){if(this.mask){Ext.EventManager.removeResizeListener(this.position_overlay,this);this.mask.remove();}},fetch_current_user:function(){var spec={type:'HumanUser',id:SG.globals.current_user.id,columns:['app_welcomes'],result:this.current_user_ds};SG.Repo.find(spec);},on_load_current_user:function(){this.current_user=this.current_user_ds.get_record(0);this.opted_out=this.has_user_opted_out();if(this.force_display){this.render();}else{if(!this.opted_out){this.render();}else{this.destroy();}}},has_user_opted_out:function(){if(this.long_time_listener_first_time_caller())
return false;var app_welcomes=this.current_user.get('app_welcomes');if(!app_welcomes||(app_welcomes&&app_welcomes.length==0))
return false;for(var i=0;i<app_welcomes.length;i++){var app_welcome=app_welcomes[i];if(app_welcome.id==this.app_welcome.id)
return true;}
return false;},long_time_listener_first_time_caller:function(){var cookie_name=this.app_name+'_'+this.app_version+'_first_'+SG.globals.current_user.id;var cookie=getCookie(cookie_name);if(cookie){return false;}else{setCookie(cookie_name,true,365);this.current_user.multi_entity_set('app_welcomes',[this.app_as_entity()],'add');this.current_user.commit(true);this.first_time_caller=true;return true;}},fetch_app_welcome:function(){var spec={type:'AppWelcome',filters:{logical_operator:"and",conditions:[{active:true,path:'app_name',relation:'is',values:[this.app_name]},{active:true,path:'app_version',relation:'is',values:[this.app_version]},]},columns:['id','app_version','app_name'],current_page:1,records_per_page:1,result:this.app_welcome_ds};SG.Repo.query(spec);},on_load_app_welcome:function(){if(!this.app_welcome_ds.count()==1){this.destroy();return;}
this.app_welcome=this.app_welcome_ds.get_record(0);this.fetch_current_user();},app_as_entity:function(){return{type:this.app_welcome.type,id:this.app_welcome.id,name:this.app_welcome.get('app_name'),valid:'valid'};},});function sg_kill_youtube_overlay(){var mask=sg_find('.sg_dialog_mask.for_youtube',document.body);if(!mask)return;Ext.get(mask).remove();};SG.NewDialog=function(config)
{Ext.apply(this,config);SG.NewDialog.superclass.constructor.call(this);};Ext.extend(SG.NewDialog,SG.Component,{templates:{dialog_container:'<div class="sg_dialog_mask sg_new_dialog {dialog_class}"><div></div></div>',dialog:'<div class="sg_dialog" style="{style}">'+'<div class="header"><span class="header_text">{title}<span></div>'+'<div class="body">{body}</div>'+'<div class="footer"><table><td class="left">{left}</td><td class="right">{right}</td></table></div>'+'</div>',button_action:'<button action_index={index} style="{style}">{label}</button>',link_action:'<span class="fake_link" action_index={index} style="{style}">{label}</span>'},init_component:function()
{this.init_dialog();this.render();this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);this.add_event(document,'keydown',this.on_keydown);Ext.EventManager.onWindowResize(this.center_dialog,this);},destroy_component:function()
{this.destroy_dialog();if(this.container)
{document.body.removeChild(this.container.dom);this.container=null;}
Ext.EventManager.removeResizeListener(this.center_dialog,this);},init_dialog:function()
{},destroy_dialog:function()
{},hide:function()
{if(this.container)
this.container.hide();},render:function()
{if(!this.container)
{this.container=this.templates.dialog_container.append(document.body,{dialog_class:this.css_class});this.container=Ext.get(this.container);}
var style='width:'+(this.width||'400px')+'; ';if(this.height)
style+='height:'+this.height+'; ';var content=this.templates.dialog.apply({style:style,title:this.title,body:this.render_body(),left:this.render_actions('left'),right:this.render_actions('right')});this.container.dom.innerHTML=content;this.dialog=Ext.get(this.container.dom.firstChild);this.body_dom=this.dialog.dom.firstChild.nextSibling;if(!this.render_after_center)
this.render_into_body(this.body_dom);this.center_dialog();if(this.render_after_center)
this.render_into_body(this.body_dom);if(this.after_render_callback)
this.after_render_callback.fn.call(this.after_render_callback.scope,this);},center_dialog:function(){this.dialog.setXY(this.dialog.getCenterXY(true));},render_body:function()
{return this.body;},render_into_body:function(body_dom)
{},render_actions:function(side)
{if(!this.actions)
return'';var html=[];for(var i=0;i<this.actions.length;i++)
{if((side=='left'&&this.actions[i].side=='left')||(side!='left'&&this.actions[i].side!='left'))
{html.push(this.render_action(i,this.actions[i]));}}
return html.join('');},render_action:function(index,action)
{var margin_right=action.margin_right;if(index<(this.actions.length-1)&&!margin_right)
margin_right='15px';var style='';if(action.margin_left)
style+="margin-left: "+action.margin_left+"; ";if(margin_right)
style+="margin-right: "+margin_right+"; ";var template=(action.type=='link')?this.templates.link_action:this.templates.button_action;return template.apply({style:style,index:index,label:action.label});},fire_action:function(action)
{if(!action.dont_close)
this.destroy();if(action.callback)
{var me=this;setTimeout(function(){action.callback.fn.call(action.callback.scope,me,(action.callback.data||null));},0);}},on_click:function(evt)
{var target=Ext.get(evt.target);var action_elem=target.findParent("[action_index]",this.container);if(action_elem)
{var action=this.actions[action_elem.getAttribute('action_index')];if(action){this.fire_action(action);}
return;}
if(this.dialog_click)
{this.dialog_click.fn.call(this.dialog_click.scope,this,evt);}},on_change:function(e){},on_keydown:function(e){var action,keyCode=e.browserEvent.keyCode;var target=Ext.get(e.getTarget());if(['TEXTAREA','SELECT'].indexOf(target.dom.nodeName)!==-1)
return;for(var i=0;i<this.actions.length;i++){action=this.actions[i];if(action.hasOwnProperty('key_code')&&action.key_code==keyCode||(!action.hasOwnProperty('key_code')&&action.label.toLowerCase()=='ok'&&keyCode==Ext.EventObject.RETURN)||(!action.hasOwnProperty('key_code')&&action.label.toLowerCase()=='cancel'&&keyCode==Ext.EventObject.ESC))
{this.fire_action(action);return;}}
if((keyCode==Ext.EventObject.RETURN||keyCode==Ext.EventObject.ESC)&&this.actions.length==1&&!this.actions[0].hasOwnProperty('key_code'))
{this.fire_action(this.actions[0]);return;}}});SG.ManageStepsDialog=function(config){SG.ManageStepsDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ManageStepsDialog,SG.ModalDialog,{sg_dialog_class:'sgd_manage_steps',sg_dialog_submit_button_text:'Save',sg_dialog_width:'600px',templates:{body:'<table style="layout: fixed; width: 600px"><tr><td style="width: 400px">'+'<div class="steps"></div></td><td class="help" style="width: 199px"><div class="help"></div>'+'</td></tr></table><div id="sgd_manage_steps_proxy"></div>',steps:'<div class="add"><a class="add_link" href="#">+ Add New Pipeline Step</a></div>'+'<div class="header">{header}</div><div class="step_rows">{step_rows}</div>',steps_header:'<table style="width: 370px"><tr><td class="drag_column">Order</td>'+'<td class="code_column">Name</td><td class="short_name_column">Short Code</td>'+'<td class="color_column">Color</td><td class="trash_column">&nbsp</td></tr></table>',step_row:'<div class="step_row" record_id="{record_id}"><table style="width: 370px"><tr>'+'<td class="drag_handle drag_column"><img src="/images/grouping_row_icon.png"></td>{cells}'+'<td class="trash_column"><div class="trash" style="display: inline-block;" '+'sg_tip="Delete Step from ALL Projects"></div></td></tr></table></div>',cell:'<td class="{cell_classes} {field}_column" style="{cell_styles} width: {width}px;"'+' {cell_attributes}>{cell_content}</td>',no_steps:'<div class="no_steps">There are no {entity} Pipeline Steps yet.  Use the link above to add one.</div>',help:'<div class="copy"><p>{entity_type} Pipeline Steps define the major categories of work that need to be done '+'on your {entity_type_plural}.  Each Step can have multiple Tasks, which are added on '+'the page below this dialog. '+'Watch a video and read more about how Pipeline Steps work '+'<a target="_blank" href="'+SG.globals.help_urls.configure_pipeline+'">here</a>.</p>'+'<br><p class="warning">Warning: Currently there is one set of {entity_type} Pipeline Steps for all your '+'Projects.  If a Project does not need one {entity_type} Step, '+'simply hide the Step from the pages in that '+'Project. Deleting a Step here deletes it from all Projects and can not be undone, so be careful!</p>'},setup:function()
{this.init_templates();this.sg_dialog_header_text='Manage '+
SG.schema.entity_types[this.entity_type]['display_name']+' Pipeline';this.data_set=new SG.Data.Set('Step');this.data_set.on("change",this.on_data_set_change,this);this.fill_data_set_with_global_steps();},teardown:function()
{this.data_set.un("change",this.on_data_set_change);this.data_set.destroy();},fill_data_set_with_global_steps:function()
{var steps=SG.globals.steps[this.entity_type];if(!steps)
return;var recs=[];for(var i=0;i<steps.length;i++)
{var step=steps[i];var row=SG.Repo.get_row('Step',step.id);row.set('code',step.code);row.set('short_name',step.short_name);row.set('list_order',step.list_order);row.set('color',step.color);row.set('entity_type',this.entity_type);var rec=new SG.Data.Record('Step');rec.load(row);recs.push(rec);}
this.data_set.load(recs);},draw_body:function(){var html=this.templates.body.apply();this.body.update(html);this.steps_div=this.body.child('div.steps');this.help_div=this.body.child('div.help');var dz_cfg={container:this.body,reorder_callback:{fn:this.reorder_steps,scope:this},drag_handle_selector:'td.drag_handle',row_element_selector:'div.step_row',row_proxy_name_selector:'td.code_column>div.sg_cell_content',drag_element_proxy_id:'sgd_manage_steps_proxy',b4_start_drag_callback:{fn:this.apply_edit,scope:this}};var dz=new SG.util.RowDragReorder(dz_cfg);this.construct_cell_manager();this.body.on("click",this.on_click,this);this.render_steps();this.render_help();},construct_cell_manager:function()
{var cell_config={container:this.body,edit_container:this.dialog,data_set:this.data_set,projects:this.context_projects,get_fields_callback:{fn:this.get_columns,scope:this},autocommit:false};this.cell_manager=new SG.CellManager(cell_config);},on_click:function(e)
{var target=Ext.get(e.getTarget());var add=target.findParent('a.add_link');if(add){this.add_step();return;}
var trash=target.findParent('div.trash');if(trash)
{var step_row=target.findParent('div.step_row');this.remove_step(step_row);return;}},add_step:function()
{var list_order_steps=this.generate_list_order_steps();var count=list_order_steps.length;var rec=this.data_set.new_record();rec.set('code','New Step');rec.set('short_name','-');rec.set('color','127,127,127');rec.set('list_order',1);rec.set('entity_type',this.entity_type);var html=this.templates.step_row.apply({cells:this.render_cells(rec),display_name:rec.get('code'),record_id:rec.get_id()});var step_rows_div=this.steps_div.child('div.step_rows');if(count==0)
step_rows_div.update('');else
{for(var i=0;i<list_order_steps.length;i++)
{var a_rec=list_order_steps[i];a_rec.set('list_order',Number(a_rec.get('list_order'))+1);}}
var new_row=Ext.DomHelper.insertFirst(step_rows_div,html,true);new_row.animate({backgroundColor:{from:'#00FF00',to:'#D1D1D1'}},0.5,function(){new_row.dom.style.backgroundColor='#D1D1D1';},'easeOut','color');var db=this.dialog.getBottom();var mb=this.mask.getBottom();if(db+10>=mb)
this.centre_dialog();var sel='.sg_cell[record_id="'+rec.get_id()+'"][field="code"]';var cell_elem=sg_find(sel,this.body.dom);var cell=this.cell_manager.get_cell('code');cell.edit_cell({cell_elem:Ext.get(cell_elem),record:rec});},get_columns:function()
{return['code','short_name','color'];},get_column_width:function(col)
{var widths={code:160,short_name:70,color:50};return widths[col];},render_steps:function()
{var me=this;setTimeout(function(){me.steps_div.update(me.templates.steps.apply({header:me.templates.steps_header.apply(),step_rows:me.render_step_rows()}));});},render_step_rows:function()
{var html='';var recs=this.generate_list_order_steps();if(recs.length==0)
{var dn=SG.schema.entity_types[this.entity_type].display_name;return this.templates.no_steps.apply({entity:dn});}
for(var i=0;i<recs.length;i++)
{rec=recs[i];html+=this.templates.step_row.apply({cells:this.render_cells(rec),display_name:rec.get('code'),record_id:rec.get_id()});}
return html;},generate_list_order_steps:function()
{var recs=[];for(var i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);var s=rec.get_state();if(rec.get_state()!='retired')
recs.push(rec);}
recs.sort(function(a,b){var a_list_order=a.get('list_order');var b_list_order=b.get('list_order');if(a_list_order<b_list_order)
return-1;else if(a_list_order>b_list_order)
return 1;else
return 0;});return recs;},render_cells:function(record)
{var cols=this.get_columns();var html='';for(var i=0;i<cols.length;i++){var col=cols[i];var cell=this.cell_manager.get_cell(col);cell_params=cell.render(record,-1);cell_params.width=this.get_column_width(col);cell_params.field=col;html+=this.templates.cell.apply(cell_params);}
return html;},render_help:function()
{var entity_type=SG.schema.entity_types[this.entity_type].display_name;var entity_type_plural=SG.schema.entity_types[this.entity_type].display_name_pluralized;this.help_div.update(this.templates.help.apply({entity_type:entity_type,entity_type_plural:entity_type_plural}));},reorder_steps:function(){var new_records=[];var new_id_map={};var i,record_id,rec;var step_rows=sg_find_all('div.step_row',this.steps_div.dom);for(i=0;i<step_rows.length;i++)
{record_id=Number(step_rows[i].getAttribute('record_id'));rec=this.data_set.get_record_by_id(record_id);rec.set('list_order',i+1);new_records.push(rec);new_id_map[record_id]=rec;}
for(i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);if(rec.get_state()=='retired')
{new_records.push(rec);new_id_map[rec.get_id()]=rec;}}
this.data_set.records=new_records;this.data_set.id_map=new_id_map;this.render_steps();},submit:function(event,target,options)
{this.cell_manager.apply_all_edits();var retire_count=this.data_set.count_status('retired');var commit_required=this.data_set.count_status('clean','compliment')!=0;if(retire_count!=0)
{var message='You have deleted Steps, which will delete them for ALL PROJECTS.'+'  Are you SURE this is what you want to do?';if(!confirm(message))
{this.block_change_events=true;this.fill_data_set_with_global_steps();this.block_change_events=false;this.render_steps();return;}}
if(commit_required)
{this.pi=new SG.ProgressIndicator(this.dialog);this.pi.show();this.data_set.commit(true);}
else
this.destroy();},update_step_globals:function()
{var recs=this.generate_list_order_steps();var new_globals=[];for(var i=0;i<recs.length;i++)
{var r=recs[i];var step={};step.code=r.get('code');step.short_name=r.get('short_name');step.list_order=r.get('list_order');step.color=r.get('color');step.id=r.get_id();new_globals.push(step);}
SG.globals.steps[this.entity_type]=new_globals;},remove_step:function(step_row_elem)
{var record_id=Number(step_row_elem.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(record_id);var list_order=rec.get('list_order');if(record_id<0)
this.data_set.remove([rec]);else
rec.retire();for(var i=0;i<this.data_set.count();i++)
{rec=this.data_set.get_record(i);if(rec.get_state()!='retired')
{var lo=rec.get('list_order');if(lo>list_order)
rec.set('list_order',lo-1);}}
var me=this;step_row_elem=Ext.get(step_row_elem);step_row_elem.animate({opacity:{from:1,to:0}},0.2,function(){me.render_steps();});},on_data_set_change:function(changes)
{if(this.block_change_events)
return;this.added=[];this.removed=[];this.changed=[];var change,i;for(i=0;i<changes.length;i++)
{change=changes[i];if(change.type=='retire')
this.removed.push(change.record);else if(change.type=='create')
this.added.push(change.record);else if(change.type=='update'&&change.state=='server')
this.changed.push(change.record);}
var c=this.added.length+this.removed.length+this.changed.length;if(c>0)
this.reload_schema_and_close();},reload_schema_and_close:function(){this.update_step_globals();SG.schema.reload_schema({fn:this.on_schema_reloaded,scope:this});},on_schema_reloaded:function(){this.teardown();this.fireEvent('dialog_submitted',this.added,this.removed,this.changed);this.destroy();},draw_footer:function(){this.reset_link=this.dh.append(this.footer,{tag:'a',href:'#',html:'Reset',style:'padding-right:10px;'},true);this.cancel_link=this.dh.append(this.footer,{tag:'a','class':'sgd_cancel_link',href:'#',html:'Cancel',style:'padding-left:10px;'},true);this.submit_button=this.dh.append(this.footer,{tag:'input','class':'sgd_submit_button',type:'button',style:'text-align: center; padding-left: 20px; padding-right: 20px; margin-left: 15px;',value:this.sg_dialog_submit_button_text},true);this.cancel_link.on('click',this.cancel,this);this.submit_button.on('click',this.submit,this);this.reset_link.on('click',this.reset,this);},reset:function(e)
{this.data_set.un("change",this.on_data_set_change);this.data_set.destroy();this.data_set=new SG.Data.Set('Step');this.data_set.on("change",this.on_data_set_change,this);this.fill_data_set_with_global_steps();this.cell_manager.destroy();this.construct_cell_manager();this.render_steps();this.render_help();},apply_edit:function()
{this.cell_manager.apply_all_edits();}});SG.ManageColumnsDialog=function(config){this.omit_identifier_field=false;this.pivot_columns="none";SG.ManageColumnsDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ManageColumnsDialog,SG.ModalDialog,{sg_dialog_header_text:'Manage Columns',sg_dialog_submit_button_text:'Apply',sg_dialog_width:'550px',sg_dialog_focus:'#sgd_cb_manage_columns_toggle_all',checked_count:0,templates:{body:'{warning_message}<div>{toggle_all_table}<hr/>{field_groups}</div>',warning_message:'<div class="warning_message">{message}</div>',toggle_all_table:'<table id="sgd_toggle_all_table"><tr>'+'<td class="manage_columns_checkbox">'+'<input id="sgd_cb_manage_columns_toggle_all" type="checkbox"></input></td>'+'<td class="manage_columns_field_name">Toggle All</td>'+'</tr></table>',field_group:'<div class="manage_columns_group"><div class="manage_columns_group_title">'+'{arrow_image}{group_title}</div>'+'<div class="manage_columns_group_{open_closed}">{contents}</div></div>',field_table:'<table class="sgd_column_table">{fields}</table>',field_row:'<tr>'+'<td class="manage_columns_checkbox">'+'<input id="sgd_cb_{field_identifier}" class="sgd_manage_columns_cb" '+'name="{field_identifier}" type="checkbox" {checked} {disabled}></input></td>'+'<td class="manage_columns_field_name">'+'<label for="sgd_cb_{field_identifier}">{field_display_name}</label>'+'<span class="manage_columns_technical_name">{field_identifier}</span>'+'</td>'+'</tr>',},render_fields:function()
{var html="";var categorized_fields=SG.schema.get_categorized_fields(this.entity_type,this.omit_identifier_field,true);html+=this.render_field_group("",categorized_fields.ordinary,"open");if(this.pivot_columns=='fields')
html+=this.render_field_group("PIPELINE",categorized_fields.pivot_column_fields,"closed");else if(this.pivot_columns=='summary')
html+=this.render_pivot_column_summary_fields("PIPELINE",categorized_fields.pivot_column_fields);else if(this.pivot_columns=='filtering')
html+=this.render_pivot_column_summary_fields("PIPELINE",categorized_fields.pivot_column_fields,'.Task.');if(this.pivot_columns=='fields'||this.pivot_columns=='summary')
html+=this.render_linked_pipeline_summary_fields();if(this.entity_type=='Task')
{categorized_fields.dependency.sort(function(a,b){if(a.absolute_sort_order>b.absolute_sort_order)return 1;if(a.absolute_sort_order<b.absolute_sort_order)return-1;return 0;});html+=this.render_field_group("DEPENDENCIES",categorized_fields.dependency,"closed");}
if(!(this.only_ordinary_fields==true))
{html+=this.render_field_group("AUDIT FIELDS",categorized_fields.audit,"closed");html+=this.render_field_group("SMART FIELDS",categorized_fields.smart_cut,"closed");var multiple_through_joins=(this.join_fields.length>1);for(var i=0;i<this.join_fields.length;i++)
{var section_title="JOIN FIELDS";if(multiple_through_joins)
section_title+=" for "+this.join_fields[i].parent_entity_link_field.display_name;html+=this.render_field_group(section_title,this.join_fields[i].fields,"closed");}
html+=this.render_linked_fields(categorized_fields);}
return html;},render_field_group:function(title,fields,open_closed,field_prefix)
{if(!fields||fields.length==0)
return"";var fields_html="";var checked_count=0;if(!field_prefix)
field_prefix='';fields=SG.schema.locally_sorted_fields(this.column_display_names,fields,field_prefix);for(var i=0;i<fields.length;i++)
{var name=fields[i].name;if(field_prefix)
{if(fields[i].data_type=='summary'&&name.indexOf('.')!=-1)
{}
else
name=field_prefix+name;}
else if(fields[i].field_reference_name)
name=fields[i].field_reference_name;var checked=(this.columns.indexOf(name)!=-1);if(checked)
{checked_count++;this.checked_count++;}
var disabled=false;if(this.field_disabled_callback)
disabled=this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,fields[i]);if(this.read_only_fields&&this.read_only_fields.indexOf(name)!=-1)
disabled=true;var display_name=SG.schema.local_display_name(this.column_display_names,fields[i],name);fields_html+=this.templates['field_row'].apply({field_identifier:name,field_display_name:display_name,checked:checked?"checked":"",disabled:disabled?"disabled":""});}
var fields_table=this.templates['field_table'].apply({fields:fields_html})
if(title!=""&&checked_count>0)
title+=" ("+checked_count+")";var arrow_image=(title!=""?this.get_arrow_html(open_closed):"");return this.templates['field_group'].apply({group_title:title,contents:fields_table,open_closed:open_closed,arrow_image:arrow_image});},get_arrow_html:function(open_closed)
{return"<img src='"+this.get_arrow_url(open_closed)+"' />"},get_arrow_url:function(open_closed)
{return open_closed=="closed"?SG.globals.icons.ArrowClosedDark:SG.globals.icons.ArrowOpenDark;},render_linked_pipeline_summary_fields:function()
{var linked_pipelines=SG.schema.get_linked_pipeline_steps(this.entity_type);var task_fields=SG.schema.get_categorized_fields('Task',false,true).ordinary;if(linked_pipelines.length==0)
return'';this.checked_count=0;var html='';for(var i=0;i<linked_pipelines.length;i++)
{if(linked_pipelines[i].entity_types.length==1)
{var entity_type_info=linked_pipelines[i].entity_types[0];var inner_html='';var current_checked_count=this.checked_count;for(var j=0;j<entity_type_info.steps.length;j++)
{var field_prefix=linked_pipelines[i].schema_field.name+'.'+entity_type_info.entity_type+'.'+'step_'+entity_type_info.steps[j].id+'$';inner_html+=this.render_field_group(entity_type_info.steps[j].code,task_fields,"closed",field_prefix);}
var title=linked_pipelines[i].schema_field.display_name;if(this.checked_count-current_checked_count>0)
title+=" ("+(this.checked_count-current_checked_count)+")";if(inner_html)
{html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}
else
{var inner_html='';var inner_checked_count=this.checked_count;for(var k=0;k<linked_pipelines[i].entity_types.length;k++)
{var entity_type_info=linked_pipelines[i].entity_types[k];var inner_inner_html='';var inner_inner_checked_count=this.checked_count;for(var j=0;j<entity_type_info.steps.length;j++)
{var field_prefix=linked_pipelines[i].schema_field.name+'.'+entity_type_info.entity_type+'.'+'step_'+entity_type_info.steps[j].id+'$';inner_inner_html+=this.render_field_group(entity_type_info.steps[j].code,task_fields,"closed",field_prefix);}
if(inner_inner_html)
{var title=SG.schema.entity_types[entity_type_info.entity_type].display_name;if(this.checked_count-inner_inner_checked_count>0)
title+=" ("+(this.checked_count-inner_inner_checked_count)+")";inner_html+=this.templates['field_group'].apply({group_title:title,contents:inner_inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}
if(inner_html)
{var title=linked_pipelines[i].schema_field.display_name;if(this.checked_count-inner_checked_count>0)
title+=" ("+(this.checked_count-inner_checked_count)+")";html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}}
var title="LINKED PIPELINES";if(this.checked_count>0)
title+=' ('+this.checked_count+')';return this.templates['field_group'].apply({group_title:title,contents:html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},render_pivot_column_summary_fields:function(section_title,fields,delimiter)
{if(!fields||fields.length==0)
return"";delimiter=delimiter||'$';this.checked_count=0;var field;var i;var inner_html='';for(i=0;i<fields.length;i++)
{var field=fields[i];if(field.query)
{var summary_entity_type=field.query.entity_type;var categorized_fields=SG.schema.get_categorized_fields(summary_entity_type,false,true);var summary_fields=[];for(var j=0;j<categorized_fields.ordinary.length;j++)
{var summary_field=sg_deep_copy(categorized_fields.ordinary[j]);summary_field.field_reference_name=field.name+delimiter+summary_field.name;summary_fields.push(summary_field);}
inner_html+=this.render_field_group(field.display_name,summary_fields,"closed");}}
if(this.checked_count>0)
section_title+=' ('+this.checked_count+')';return this.templates['field_group'].apply({group_title:section_title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},render_linked_fields:function(categorized_fields)
{this.checked_count=0;var html="";var local_sorted_fields=SG.schema.locally_sorted_fields(this.column_display_names,categorized_fields.association,'');this.old_field_disabled_callback=this.field_disabled_callback;this.field_disabled_callback={fn:function(field_schema)
{var disabled=null;if(this.old_field_disabled_callback)
{disabled=this.old_field_disabled_callback.fn.call(this.old_field_disabled_callback.scope,field_schema);}
return disabled;},scope:this};for(var i=0;i<local_sorted_fields.length;i++)
{var assoc=local_sorted_fields[i];if(assoc)
{var assoc_display_name=SG.schema.local_display_name(this.column_display_names,assoc,assoc.name);var all_bubbled_fields=SG.schema.get_bubble_fields(assoc);if(!all_bubbled_fields)
continue;if(all_bubbled_fields.length==1)
{var entity_type=all_bubbled_fields[0].entity_type;var field_prefix=assoc.name+'.'+entity_type+'.';var fields=all_bubbled_fields[0].fields
if(fields.length>0)
html+=this.render_field_group(assoc_display_name,fields,"closed",field_prefix);}
else
{var inner_html="";var current_checked_count=this.checked_count;for(var j=0;j<all_bubbled_fields.length;j++)
{var entity_type=all_bubbled_fields[j].entity_type;var field_prefix=assoc.name+'.'+entity_type+'.';var fields=all_bubbled_fields[j].fields
if(fields.length>0)
inner_html+=this.render_field_group(SG.schema.entity_types[entity_type].display_name,fields,"closed",field_prefix);}
if(inner_html!="")
{var title=assoc_display_name;if(this.checked_count-current_checked_count>0)
title+=" ("+(this.checked_count-current_checked_count)+")";html+=this.templates['field_group'].apply({group_title:title,contents:inner_html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});}}}}
this.field_disabled_callback=this.old_field_disabled_callback;if(html=="")
return"";else
var group_title="LINKED FIELDS";if(this.checked_count>0)
group_title+=" ("+this.checked_count+")";return this.templates['field_group'].apply({group_title:group_title,contents:html,open_closed:"closed",arrow_image:this.get_arrow_html("closed")});},draw_body:function()
{this.init_templates();var message=this.warning_message?this.templates.warning_message.apply({message:this.warning_message}):'';var html=this.templates['body'].apply({warning_message:message,toggle_all_table:this.templates['toggle_all_table'].apply(),field_groups:this.render_fields()});Ext.DomHelper.append(this.body,html);this.body.on("click",this.on_body_click,this);},on_body_click:function(event)
{var t=event.getTarget();var group=Ext.get(t);if(group.hasClass("manage_columns_group_title")||(group=Ext.get(t.parentNode)).hasClass("manage_columns_group_title"))
{var contents=Ext.get(group.dom.nextSibling);if(contents.hasClass("manage_columns_group_closed"))
{contents.replaceClass("manage_columns_group_closed","manage_columns_group_open");this.set_arrow(group.dom.firstChild,"open");}
else
{contents.replaceClass("manage_columns_group_open","manage_columns_group_closed");this.set_arrow(group.dom.firstChild,"closed");}}
else if(t.id=="sgd_cb_manage_columns_toggle_all")
{this.toggle_all_checkboxes(t.checked);}},set_arrow:function(image_node,open_closed)
{image_node.setAttribute("src",this.get_arrow_url(open_closed));},toggle_all_checkboxes:function(checked)
{var closed=this.closed_checkboxes();var open=this.open_checkboxes();for(var i=0;i<open.length;i++)
{if(closed.indexOf(open[i])==-1&&!open[i].disabled)
open[i].checked=checked;}},closed_checkboxes:function()
{return sg_find_all('div.manage_columns_group_closed input.sgd_manage_columns_cb',this.body.dom);},open_checkboxes:function()
{return sg_find_all('div.manage_columns_group_open input.sgd_manage_columns_cb',this.body.dom);},submit_values:function(){var added=[],removed=[];var checkboxes=Ext.select('input.sgd_manage_columns_cb',this.body);var dialog=this;checkboxes.each(function()
{var original_state=(dialog.columns.indexOf(this.dom.name)!=-1);new_state=this.dom.checked;if(new_state!=original_state)
{if(new_state){added.push(this.dom.name);}else{removed.push(this.dom.name);}}});return this.fireEvent('dialog_submitted',added,removed);}});SG.CellFormattingDialog=function(config)
{SG.CellFormattingDialog.superclass.constructor.call(this,config);};Ext.extend(SG.CellFormattingDialog,SG.ModalDialog,{sg_dialog_header_text:'Formatting Rules',sg_dialog_class:'sgd_formatting_rules',sg_dialog_submit_button_text:'Save',sg_dialog_width:'640px',setup:function()
{this.mode=this.rule_type=='static_rule'?'rule':'list';if(this.schema_field)
{if(this.mode=='list')
this.sg_dialog_header_text='Formatting Rules for "'+this.field_display_name+'"';else
this.sg_dialog_header_text='Formatting for "'+this.field_display_name+'"';}
else
{this.entity_type_display_name=SG.schema.entity_types[this.entity_type].display_name_pluralized;if(this.mode=='list')
this.sg_dialog_header_text='Row Formatting Rules for '+this.entity_type_display_name;else
this.sg_dialog_header_text='Row Formatting for '+this.entity_type_display_name;}
this.data_set=new SG.Data.Set('FormattingRule');this.data_set.on("change",this.on_data_set_change,this);if(this.mode=='list')
{this.data_set.on('load',this.on_global_rules_loaded,this);SG.CellFormatting.fetch_global_formatting_rules(this.data_set,this.schema_field?this.schema_field:null,this.schema_field?null:this.entity_type);}
else
this.load_page_rules();},get_columns:function()
{if(this.current_component)
return this.current_component.get_columns();else
return[];},rule_fields:['rule_type','page','display_column','row_entity_type','priority','description','text_color','background_color','bold','italic','strike_through','enabled'],get_page_rules_from_settings:function()
{this.rule_record_to_edit=null;var rules=sg_deep_copy(this.page_widget.get('formatting_rules'));if(!rules)
return[];this.sort_in_display_order(rules);var recs=[];for(var i=0;i<rules.length;i++)
{if(!this.schema_field&&rules[i].display_column_id)
continue;if(this.schema_field&&this.schema_field.id!=rules[i].display_column_id)
continue;var rec=new SG.Data.Record('PermissionRule');for(var j=0;j<this.rule_fields.length;j++)
rec.set(this.rule_fields[j],rules[i][this.rule_fields[j]]);if(rules[i].condition)
rec.set('condition',Ext.encode(rules[i].condition));rec.state='clean';rec.id=this.data_set.generate_unused_id();recs.push(rec);}
return recs;},save_page_rules_in_settings:function()
{var rules=[];var all_rules=this.page_widget.get('formatting_rules');if(all_rules)
{for(var i=0;i<all_rules.length;i++)
{if(!this.schema_field&&!all_rules[i].display_column_id)
continue;if(this.schema_field&&this.schema_field.id==all_rules[i].display_column_id)
continue;rules.push(all_rules[i]);}}
var recs=[];var not_clean=0;var retired=0;var rec;for(var i=0;i<this.data_set.records.length;i++)
{rec=this.data_set.records[i];if(rec.get('page'))
{if(rec.state!='retired')
recs.push(rec);else
retired++;}}
for(var i=0;i<recs.length;i++)
{if(recs[i].state!='clean')
not_clean++;var rule={};for(var j=0;j<this.rule_fields.length;j++)
rule[this.rule_fields[j]]=recs[i].get(this.rule_fields[j]);rule.page_id=rule.page.id;rule.display_column_id=rule.display_column?rule.display_column.id:null;if(recs[i].get('condition'))
rule.condition=Ext.decode(recs[i].get('condition'));rules.push(rule);}
if(not_clean>0||retired>0)
{this.sort_in_page_settings_order(rules);this.page_widget.set('formatting_rules',rules);}},sort_in_page_settings_order:function(rules)
{rules.sort(function(r1,r2){if(r1.display_column_id==r2.display_column_id)
return(r2.priority-r1.priority);else
return(r1.display_column_id-r2.display_column_id);});},sort_in_display_order:function(rules)
{rules.sort(function(r1,r2){if(r1.display_column_id==r2.display_column_id)
return(r1.priority-r2.priority);else
return(r1.display_column_id-r2.display_column_id);});},load_page_rules:function()
{var page_recs=this.get_page_rules_from_settings();if(page_recs.length>0)
{var recs=[];recs=recs.concat(this.data_set.records);recs=recs.concat(page_recs);this.data_set.records=[];this.data_set.load(recs);}
if(!this.data_set.is_loaded())
this.data_set.load([]);this.rule_record_to_edit=null;this.conditional_rule_records=[];for(var i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);if(rec.get('condition'))
this.conditional_rule_records.push(rec);else
this.rule_record_to_edit=rec;}
if(!this.rule_record_to_edit&&this.rule_type=='static_rule')
{this.new_static_rule();}},on_global_rules_loaded:function()
{this.data_set.un('load',this.on_global_rules_loaded,this);this.load_page_rules();this.draw_body();},new_static_rule:function()
{this.rule_record_to_edit=this.data_set.new_record();this.rule_record_to_edit.set('description','');this.rule_record_to_edit.set('page',{'type':'Page','id':this.page_id});if(this.schema_field)
{this.rule_record_to_edit.set('display_column',{'type':'DisplayColumn','id':this.schema_field.id});this.rule_record_to_edit.set('rule_type','display_column');}
else
{this.rule_record_to_edit.set('rule_type','row');this.rule_record_to_edit.set('row_entity_type',this.entity_type);}
this.rule_record_to_edit.set('enabled',true);},desc_disabled_prfx:'[DISABLED] ',desc_disabled_prfx_re:/^\[DISABLED\] /,on_data_set_change:function(changes)
{if(this.dont_respond_to_change_events)
return;for(var i=0;i<changes.length;i++)
{if(changes[i].type=='create'||changes[i].type=='retire'||(changes[i].type=='update'&&changes[i].state=='server'))
{this.teardown();this.fireEvent('dialog_submitted',this.schema_field);this.destroy();}
if(changes[i].type=='update'&&changes[i].column=='enabled')
{var description=changes[i].record.get('description');if(changes[i].value===true&&description.match(this.desc_disabled_prfx_re))
changes[i].record.set('description',description.substring(this.desc_disabled_prfx.length));else if(changes[i].value===false&&!description.match(this.desc_disabled_prfx_re))
changes[i].record.set('description',this.desc_disabled_prfx+description);}}},teardown:function()
{if(this.cell_formatting_component)
this.cell_formatting_component.destroy();if(this.list_component)
this.list_component.destroy();if(this.cell_manager)
this.cell_manager.destroy();this.data_set.un("load",this.on_global_rules_loaded);this.data_set.un("change",this.on_data_set_change);this.data_set.destroy();},draw_header:function(){SG.CellFormattingDialog.superclass.draw_header.call(this);this.edit_container=this.dh.append(this.header,'<div style="position: absolute; height: 0px; width: 0px;"></div>');},draw_body:function()
{if(!this.data_set.is_loaded())
{this.body.dom.innerHTML='<div id="sgd_formatting_rules_loading">Loading...</div>';return;}
if(!this.cell_manager)
{var container=Ext.get(this.body);var cell_config={container:container,edit_container:this.edit_container,data_set:this.data_set,get_fields_callback:{fn:this.get_columns,scope:this},autocommit:false};this.cell_manager=new SG.CellManager(cell_config);}
this.cell_manager.empty_cell_cache('description');if(this.mode=='rule')
{if(!this.cell_formatting_component)
{this.cell_formatting_component=new SG.CellFormatting({entity_type:this.entity_type,container:Ext.get(this.body),schema_field:this.schema_field,page_id:this.page_id,data_set:this.data_set,record:this.rule_record_to_edit,context_projects:this.context_projects,show_description:(this.rule_type=='conditional_rules'),cell_manager:this.cell_manager,current_user_token:this.page_widget.get_user_token()});}
else
{this.cell_formatting_component.record=this.rule_record_to_edit;}
this.cell_formatting_component.render();this.current_component=this.cell_formatting_component;this.cell_formatting_component.focus_description();}
else if(this.mode=='list')
{if(!this.list_component){this.list_component=new SG.CellFormattingList({container:Ext.get(this.body),entity_type:this.entity_type,schema_field:this.schema_field,page_id:this.page_id,data_set:this.data_set,records:this.conditional_rule_records,edit_callback:{fn:this.edit_record,scope:this},cell_manager:this.cell_manager});}
this.list_component.render();this.current_component=this.list_component;}},draw_footer:function(){var footer_html='<div style="float: right;"><a class="sgd_cancel_link" href="#">Cancel</a>'+'<input class="sgd_submit_button" type="button" value="Save" '+'style="text-align: center; padding-left: 20px; padding-right: 20px; margin-left: 15px;"/><div>';if(this.mode=='rule'&&this.rule_type=='static_rule')
footer_html='<div id="sgd_clear_formatting_div" style="padding-top: 2px; float: left;">'+'<a class="sgd_clear_formatting_link" href="#">Clear formatting</a></div>'+
footer_html;this.footer.dom.innerHTML=footer_html;if(this.mode=='rule'&&this.rule_type=='static_rule')
{this.clear_link=this.footer.child('a.sgd_clear_formatting_link');this.clear_link.on('click',this.clear_formatting,this);}
this.cancel_link=this.footer.child('a.sgd_cancel_link');this.cancel_link.on('click',this.cancel,this);this.submit_button=this.footer.child('input.sgd_submit_button');this.submit_button.on('click',this.submit,this);},edit_record:function(record)
{this.rule_record_edit_backup=record;this.dont_respond_to_change_events=true;this.rule_record_to_edit=this.data_set.copy_record(record);this.dont_respond_to_change_events=false;this.mode='rule';if(this.schema_field)
this.set_header_text('Editing Formatting Rule for "'+this.field_display_name+'"');else
this.set_header_text('Editing Row Rule for '+this.entity_type_display_name);this.draw_body();this.centre_dialog();this.submit_button.dom.value='OK';},submit:function()
{this.current_component=null;if(this.cell_formatting_component)
{var valid_condition=this.cell_formatting_component.commit_edits();if(valid_condition=='invalid')
return;}
if(this.mode=='rule'&&this.rule_type=='conditional_rules')
{var desc=this.rule_record_to_edit.get('description');if(!desc||desc==SG.CellFormattingList.default_description)
{alert("\"Description\" is a required field. Please provide a description for your rule.")
return;}
var condition_group=Ext.decode(this.rule_record_to_edit.get('condition'));var active_condition_count=0;for(var i=0;i<condition_group.conditions.length;i++)
if(condition_group.conditions[i].active!='false')
active_condition_count++;if(active_condition_count==0)
{alert("Please provide at least one active filter condition for your rule.")
return;}
this.rule_record_to_edit.copy_onto(this.rule_record_edit_backup);this.data_set.remove([this.rule_record_to_edit]);this.rule_record_to_edit.destroy();delete this.rule_record_edit_backup.cell_formatting_new_record;this.mode='list';this.restore_header_text();this.draw_body();this.centre_dialog();this.submit_button.dom.value='Save';return;}
this.retire_empty_static_rule();if(this.data_set.count_status('clean','compliment')>0)
{this.pi=new SG.ProgressIndicator(this.dialog);this.pi.show();this.save_and_remove_page_rules();if(this.data_set.count_status('clean','compliment')>0)
this.data_set.commit();else
{this.fireEvent('dialog_submitted',this.schema_field);this.destroy();}}
else
this.destroy();},save_and_remove_page_rules:function()
{this.save_page_rules_in_settings();var recs=[];for(var i=0;i<this.data_set.records.length;i++)
{var rec=this.data_set.records[i];if(rec.get('page'))
recs.push(rec);}
this.data_set.remove(recs);for(var i=0;i<recs.length;i++)
{recs[i].destroy();}},retire_empty_static_rule:function()
{if(this.rule_type=='static_rule'&&this.rule_record_to_edit)
{var fields_to_check=['background_color','text_color','bold','italic','strike_through'];for(var i=0;i<fields_to_check.length;i++)
{var val=this.rule_record_to_edit.get(fields_to_check[i]);if(val)
return;}
this.rule_record_to_edit.retire();}},cancel:function(e)
{e.stopEvent();this.current_component=null;if(this.mode=='rule'&&this.rule_type=='conditional_rules')
{this.data_set.remove([this.rule_record_to_edit]);this.rule_record_to_edit.destroy();if(this.rule_record_edit_backup.cell_formatting_new_record)
{this.conditional_rule_records.splice(this.conditional_rule_records.indexOf(this.rule_record_edit_backup),1);this.data_set.remove([this.rule_record_edit_backup]);this.rule_record_edit_backup.destroy();}
this.mode='list';this.restore_header_text();this.draw_body();this.centre_dialog();this.submit_button.dom.value='Save';}
else
SG.CellFormattingDialog.superclass.cancel.call(this,e);},clear_formatting:function(e)
{e.stopEvent();this.rule_record_to_edit.retire();this.new_static_rule();this.draw_body();},});SG.ConfigureField=SG.ConfigureField||{};SG.ConfigureField.Dialog=function(config)
{Ext.apply(this,config);SG.ConfigureField.Dialog.superclass.constructor.call(this);};Ext.extend(SG.ConfigureField.Dialog,SG.Component,{templates:{structure:'<div class="sg_dialog_mask"><div class="sgd_cfg_field">'+'<div class="header"></div>'+'<div class="body"></div>'+'<div class="footer"></div>'+'</div></div>',header:'<div><span class="title">{title}</span>'+'<input type="text" class="field_name" value="{field_name}">'+'{field_code}',body:'<table class="tabs">'+'<tr>{tabs}<td class="edge"></td></tr></table>'+'<div class="content"></div>',tab:'<td class="tab {selected}" name="{name}">'+'<div class="tab_name">{display_name}</div></td>',footer:'<table><tr><td class="left">{delete_button}</td>'+'<td class="right"><span class="fake_link cancel">Cancel</span>'+'<button class="save">{save_label}</button></td></tr></table>',delete_button:'<button class="delete">Delete</button>'},init_component:function(){this.current_tab='general';this.current_tab_component=null;this.tabs=['general','permissions'];this.tab_details={general:{display_name:'General',component:SG.ConfigureField.GeneralTab},permissions:{display_name:'Permissions',component:SG.ConfigureField.PermissionsTab}};this.init_state();this.request_permissions();this.render_structure();this.set_fieldname_focus();},destroy_component:function(){if(this.mask){document.body.removeChild(this.mask.dom);this.container=null;}
Ext.EventManager.removeResizeListener(this.center_dialog,this);},init_state:function(){this.state={entity_type:this.entity_type,schema_field:this.schema_field,data_type:this.schema_field?this.schema_field.data_type:'text',widget:this.widget,field_name:this.schema_field?this.schema_field.display_name:'New Field Name',original_permissions:null,permissions:null,status_list_subset:[],allowed_entity_types:[],summary:{entity_type:this.entity_type,filters:{conditions:[],logical_operator:'and'},column:'id',type:'record_count',value:null}};this.compute_state();},compute_state:function(){if(!this.schema_field)return;var sf=this.schema_field;this.state.original_data_type=sf.data_type;if(sf.data_type!='summary'){if(sf.summary_default)
this.state.summary_default=sf.summary_default;else
this.state.summary_default=sf.summary_defaults[sf.data_type];}
this.state.substitute_sort_field=sf.substitute_sort_field||null;switch(sf.data_type){case'text':case'number':this.state.unique=(sf.unique===true);break;case'url':this.state.open_in_new_window=(sf.open_in_new_window===false)?false:true;break;case'list':this.state.list_values=sf.display_values?sf.display_values.join('\n'):'';break;case'entity':case'multi_entity':if(!sf.allowed_entity_types)
this.state.allowed_entity_types=[];else
this.state.allowed_entity_types=sg_deep_copy(sf.allowed_entity_types);break;case'summary':this.state.summary={entity_type:sf.query.entity_type,filters:sf.query.filters,column:sf.summary_field,type:sf.summary_default,value:sf.summary_value};break;case'status_list':this.state.status_list_default=this.schema_field.status_list_default;this.state.status_list_subset=sg_deep_copy(this.schema_field.status_list_subset);break;}},render_structure:function(){this.mask=this.templates.structure.append(document.body,{},true);this.container=Ext.get(this.mask.dom.firstChild);this.header=this.container.child('div.header');this.body=this.container.child('div.body');this.footer=this.container.child('div.footer');this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);Ext.EventManager.onWindowResize(this.center_dialog,this);this.add_event(document.body,'keydown',this.on_keydown);this.render();this.center_dialog();},render:function(){this.render_header();this.render_body();this.render_footer();},render_header:function(){var cfg={title:"New Field Name",field_name:this.state.field_name}
if(this.state.schema_field){cfg.title="Field Name";cfg.field_code='<span class="field_code">Field code: '+this.state.schema_field.name+'</span>';}
this.header.update(this.templates.header.apply(cfg));},render_body:function(){var i,h='';var tab,cfg;for(i=0;i<this.tabs.length;i++){tab=this.tabs[i];cfg={name:tab,display_name:this.tab_details[tab].display_name,selected:(this.current_tab==tab)?"selected":""}
h+=this.templates.tab.apply(cfg);}
cfg={num_tabs:this.tabs.length,tabs:h};this.body.update(this.templates.body.apply(cfg));this.render_current_tab();},render_current_tab:function(){this.construct_tab(this.current_tab);this.current_tab_component.render();},render_footer:function(){var cfg={save_label:this.state.schema_field?'Update Field':'Create Field'};var can_retire=SG.schema.can_retire_entity('DisplayColumn');if(can_retire&&this.schema_field&&this.schema_field.field_type=="dynamic")
cfg.delete_button=this.templates.delete_button.apply();this.footer.update(this.templates.footer.apply(cfg));},on_click:function(e){var target=Ext.get(e.getTarget());var tab=target.findParent('td.tab');if(tab){this.select_tab(tab);return;}
var cancel=target.findParent('span.cancel');if(cancel){this.destroy();return;}
var save_button=target.findParent('button.save');if(save_button){this.save();return;}
var delete_button=target.findParent('button.delete');if(delete_button){this.retire();return;}},on_change:function(e){var target=Ext.get(e.getTarget());var field_name=target.findParent('input.field_name');if(field_name){this.state.field_name=field_name.value;return;}},on_keydown:function(e){if(e.browserEvent.keyCode==e.ENTER)
{var target=Ext.get(e.getTarget());if(target.dom.nodeName=='INPUT'&&target.dom.className=='field_name')
{target.dom.blur();return;}
if(['TEXTAREA','SELECT','INPUT'].indexOf(target.dom.nodeName)!==-1)
return;var me=this;setTimeout(function(){me.save();},0);}
else if(e.browserEvent.keyCode==e.ESC)
{this.destroy();}},validate:function(){var field_name=this.state.field_name;if(/^\s*$/.test(field_name)||field_name=="New Field Name")
{alert('Please enter a name for this field before creating.');var name_input=sg_find('input.field_name',this.container.dom);if(name_input)
{name_input.focus();name_input.select();}
return false;}
if(!this.schema_field){var field_code="sg_"+field_name.replace(/[^\w]/g,'_').toLowerCase();if(SG.schema.get_field(this.state.entity_type,field_code)){alert('Field name already exists for an active field. Please enter a unique name.');return false;}}
if(this.state.data_type=='summary'){var count=this.count_active_filter_conditions(this.state.summary.filters.conditions);if(count==0){alert('Query fields require at least one active filter condition.');return false;}}
if(!this.schema_field&&this.state.data_type=="multi_entity"){if(field_name.length>30){alert('Please use a shorter field name. Multi-entity field names must be 30 characters or less.');return false;}
if(!this.state.dynamic_multi_entity_type){alert('Please select one entity type.');return false;}}
if(!this.schema_field&&this.state.data_type=="entity"&&this.state.allowed_entity_types.length==0){alert('Please select at least one entity type.');return false;}
if(this.state.data_type=="status_list"){if(this.state.status_list_subset.length==0){alert('Please select at least one status.');return false;}}},save:function(){if(this.validate()===false)return;var request={field_owner_entity_type:this.state.entity_type,field_data_type:this.state.data_type,col_name:this.schema_field?this.schema_field.name:null,field_name:this.state.field_name,substitute_sort_field:this.state.substitute_sort_field};if(!this.state.schema_field){request.field_name_prefix=this.field_name_prefix;}
if(this.state.data_type!=='summary')
request[this.state.data_type+'_summary_options']=this.state.summary_default;switch(this.state.data_type){case'text':case'number':request.unique=this.state.unique;break;case'url':request.open_in_new_window=this.state.open_in_new_window;break;case'list':request.list_values=this.state.list_values;break;case'multi_entity':if(this.state.dynamic_multi_entity_type)
request.entity_type=this.state.dynamic_multi_entity_type;else if(this.state.allowed_entity_types)
request.entity_types=this.state.allowed_entity_types;break;case'entity':request.entity_types=this.state.allowed_entity_types;break;case'summary':request.query={entity_type:this.state.summary.entity_type,filters:this.state.summary.filters};request.summary_field=this.state.summary.column;request.summary_default=this.state.summary.type;request.summary_value=this.state.summary.value;break;case'status_list':request.status_list_default=this.state.status_list_default;request.status_list_subset=this.state.status_list_subset;if(this.schema_field&&this.schema_field.status_list_subset){request.removed_status_list=this.schema_field.status_list_subset.filter(function(e){return request.status_list_subset.indexOf(e)===-1;});}}
this.add_permissions_to_request(request);this.done_callback.fn.call(this.done_callback.scope,request);this.destroy();},retire:function(){if(this.schema_field.flip_side_of)
{var field=SG.schema.get_field(this.schema_field.flip_side_of.entity_type,this.schema_field.flip_side_of.field_name);var entity_type_name=SG.schema.entity_types[field.entity_type].display_name;var msg="Heads up:  This is a bi-directional link field that is connected to the "+
field.display_name+" field on "+entity_type_name.pluralize()+".  Deleting this field will also delete the other."
if(!confirm(msg))
return;}
else if(this.schema_field&&this.schema_field.primary_side_of)
{var field=SG.schema.get_field(this.schema_field.primary_side_of.entity_type,this.schema_field.primary_side_of.field_name);var entity_type_name=SG.schema.entity_types[field.entity_type].display_name;var msg="Heads up:  This is a bi-directional link field that is connected to the "+
field.display_name+" field on "+entity_type_name.pluralize()+".  Deleting this field will also delete the other."
if(!confirm(msg))
return;}
else
{if(!confirm('Delete Field?'))
return;}
var request={field_owner_entity_type:this.state.entity_type,col_name:this.schema_field?this.schema_field.name:null,field_name:this.state.field_name,retire:true};this.done_callback.fn.call(this.done_callback.scope,request);this.destroy();},center_dialog:function(){this.container.setXY(this.container.getCenterXY(true));},select_tab:function(tab){if(this.current_tab==tab.getAttribute("name"))return;var cur_tab=this.container.child('td.tab[name="'+this.current_tab+'"]');cur_tab.removeClass("selected");Ext.fly(tab).addClass("selected");this.current_tab=tab.getAttribute("name");this.render_current_tab();},construct_tab:function(tab){if(this.current_tab_component)
this.current_tab_component.destroy();var cfg={container:Ext.get(sg_find('div.content',this.body.dom)),state:this.state};this.current_tab_component=this.new_component(this.tab_details[tab].component,cfg);},request_permissions:function()
{var options={url:'/page/permissions_for_field_config',params:{entity_type:this.entity_type,field_name:this.schema_field?this.schema_field.name:null},callback:function(options,success,response){if(success){this.state.original_permissions=Ext.decode(response.responseText);this.state.permissions=sg_deep_copy(this.state.original_permissions);if(this.current_tab=="permissions")
this.render_current_tab();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},add_permissions_to_request:function(request)
{var i,p,op;var permissions={see:[],update:[],update_status:[]};for(i=0;i<this.state.permissions.length;i++){changed=sg_deep_copy(this.state.permissions[i]);original=sg_deep_copy(this.state.original_permissions[i]);if(changed.see!=original.see)
permissions.see.push([changed.code,changed.see]);if(changed.update_from)
{if(!original.update_from)
{original.update_from=[];original.update_to=[];}
var is_changed=false;if((changed.update_from.length!=original.update_from.length)||(changed.update_to.length!=original.update_to.length))
is_changed=true;else
{if(changed.update_from.length==original.update_from.length)
{for(var j=0;j<changed.update_from.length&&!is_changed;j++)
{if(original.update_from.indexOf(changed.update_from[j])==-1)
is_changed=true;}}
if(!is_changed&&changed.update_to.length==original.update_to.length)
{for(var j=0;j<changed.update_to.length&&!is_changed;j++)
{if(original.update_to.indexOf(changed.update_to[j])==-1)
is_changed=true;}}}
if(is_changed)
permissions.update_status.push([changed.code,changed.update_from,changed.update_to]);}
else if(changed.update!=original.update)
{permissions.update.push([changed.code,changed.update]);}}
if(permissions.see.length+permissions.update.length+permissions.update_status.length!==0)
request.permissions=permissions;},count_active_filter_conditions:function(conditions)
{var count=0;if(!conditions)return 0;for(var i=0;i<conditions.length;i++)
{var cond=conditions[i];if(cond.conditions)
count+=this.count_active_filter_conditions(cond.conditions);else if(cond.active=='true')
count++;}
return count;},set_fieldname_focus:function()
{var c=this.container;var f=function(){var e=sg_find('input.field_name',c.dom);if(e){e.focus();e.select();}};window.setTimeout(f,0);}});SG.ConfigureField.GeneralTab=function(config)
{Ext.apply(this,config);SG.ConfigureField.GeneralTab.superclass.constructor.call(this);};Ext.extend(SG.ConfigureField.GeneralTab,SG.Component,{templates:{body:'<table><tr>'+'<td class="types"></td>'+'<td class="properties"></td> '+'</tr></table>',types:'<div class="title">Field Type</div>{types}',data_type:'<div class="type {disabled}" data_type="{data_type}">'+'<input type="radio" name="field_data_type" '+'value="{data_type}" {checked} {disabled}/>&nbsp;{type_display_name}</div>',},data_types:['checkbox','currency','date','date_time','duration','entity','multi_entity','float','url','footage','list','number','percent','summary','status_list','text','timecode'],data_types_modify_only:['image','password'],data_types_entity:['entity','url','multi_entity'],data_types_display_names:{'checkbox':'Checkbox','currency':'Currency','date':'Date','date_time':'Date and Time','duration':'Duration','entity':'Entity','multi_entity':'Multi-Entity','float':'Float','url':'File/Link','footage':'Footage','list':'List','number':'Number','percent':'Percent','summary':'Query','status_list':'Status List','text':'Text','timecode':'Timecode','image':'Thumbnail'},init_component:function(){this.data_types=sg_deep_copy(this.data_types);for(var i=0;i<this.data_types_modify_only.length;i++)
if(this.data_types_modify_only[i]==this.state.data_type)
this.data_types.push(this.data_types_modify_only[i]);this.type_properties_component=null;this.add_event(this.container,'click',this.on_click);},render:function(){this.container.update(this.templates.body.apply());this.types_elem=Ext.get(sg_find('td.types',this.container.dom));this.props_elem=Ext.get(sg_find('td.properties',this.container.dom));this.render_types();this.render_properties();},render_types:function(){var org_type=this.state.original_data_type;var cur_type=this.state.data_type;var entity_type=this.state.entity_type;var schema_field=this.state.schema_field;var cfg,type,selected,disabled;var data_types_html=[];for(var i=0;i<this.data_types.length;++i)
{type=this.data_types[i];selected=(type===cur_type);disabled=false;if((!selected&&schema_field&&(schema_field.field_type!='dynamic'||!schema_field.configurable))||(!schema_field&&type=='multi_entity'&&/Connection$/.test(entity_type))||(schema_field&&!selected&&this.data_types_entity.indexOf(org_type)>-1)||(schema_field&&this.data_types_entity.indexOf(org_type)==-1&&this.data_types_entity.indexOf(type)>-1)||(schema_field&&type=='summary'&&org_type!='summary')||(schema_field&&type!='summary'&&schema_field.data_type=='summary')||(!selected&&schema_field&&type!='number'&&schema_field.data_type=='footage')||(!selected&&schema_field&&type=='footage'&&schema_field.data_type!='number'))
{disabled=true}
data_types_html.push(this.templates.data_type.apply({checked:selected?'checked':'',disabled:disabled?'disabled':'',data_type:type,type_display_name:this.data_types_display_names[type],}));}
cfg={types:data_types_html.join(''),}
this.types_elem.update(this.templates.types.apply(cfg));},render_properties:function(){if(this.type_properties_component!==null)
this.type_properties_component.destroy();this.construct_type_properties_component();this.type_properties_component.render();},on_click:function(e){var target=Ext.get(e.getTarget());var type=target.findParent('div.type',this.container,true);if(type&&!type.hasClass('disabled')){this.change_type(type.dom.getAttribute('data_type'));type.child('input').dom.checked=true;e.stopPropagation();return;}},construct_type_properties_component:function(){var cfg={container:this.props_elem,state:this.state};var cmp=SG.ConfigureField.TypeProperties;if(this.state.data_type=="summary")
cmp=SG.ConfigureField.SummaryTypeProperties;this.type_properties_component=this.new_component(cmp,cfg);},change_type:function(type){this.state.data_type=type;if(this.state.data_type===this.state.original_data_type){this.get_parent_component().compute_state();}else{this.state.summary_default=SG.schema.summary_defaults[type];}
this.render_properties();}});SG.ConfigureField.PermissionsTab=function(config)
{Ext.apply(this,config);SG.ConfigureField.PermissionsTab.superclass.constructor.call(this);};Ext.extend(SG.ConfigureField.PermissionsTab,SG.Component,{templates:{content:'<div id="permissions_tab_div"><div class="permissions_ui_learn">Learn about permissions '+'<a href="{learn_url}" target="_blank">here.</a></div>'+'<div class="permissions_ui_checkbox_section">'+'<span>Who can <b>see</b> this field?</span><div>{see_checkboxes}</div></div>'+'<div class="permissions_ui_checkbox_section">'+'<span>Who can <b>edit</b> this field?</span><div>{update_checkboxes}</div></div></div>',checkbox:'<div class="permissions_ui_checkbox {classes}" '+' set_code="{set_code}" rule_type="{rule_type}" status="{status}">'+'<span class="permissions_tab_opener">&nbsp;</span>'+'{checkbox}'+'<label for="{checkbox_id}">{permission_set_name}</label>'+'<span class="restricted_note"> {restricted_note}</span></div>',checkbox_with_exceptions:'<table><tr><td class="permissions_ui_checkbox_cell">'+'<div class="permissions_ui_checkbox {classes}" set_code="{set_code}" rule_type="{rule_type}"'+'><span class="permissions_tab_opener">&nbsp;</span>'+'{checkbox}'+'<label for="{checkbox_id}">{permission_set_name}</label>'+'<span class="restricted_note"> {restricted_note}</span>'+'</div></td><td>'+'<div class="exceptions">{exceptions}</div>'+'</td></tr></table>',status_checkbox:'<div class="permissions_ui_checkbox {classes}" '+'set_code="{set_code}" rule_type="{rule_type}">'+'<span class="permissions_tab_opener status"><div class="arrow_closed_dark"></div></span>'+'{checkbox}'+'<label for="{checkbox_id}">{permission_set_name}</label>'+'<span class="restricted_note" sg_tip="{restricted_note}"> {restricted_star}</span></div>'+'<table class="status_permissions_table hidden">{status_value_rows}</table>',status_value_checkbox_row:'<tr><td class="status">{status}</td>'+'<td class="status_from">{from_checkbox}</td><td class="status_to">{to_checkbox}</td></tr>',status:'<div class="permissions_status_icon_container">{icon}</div>{name}'},init_component:function(){SG.Checkbox.on('change',this.on_checkbox_change,this);this.add_event(this.container,'click',this.on_click);},render:function(){if(this.state.permissions===null){this.container.update("<i>Loading...</i>");return;}
if(this.state.data_type=='status_list')
{for(var i=0;i<this.state.permissions.length;i++)
{var rule_set=this.state.permissions[i];if(!rule_set['update_from']&&!rule_set.disable_status_rule_ui)
{var allowed=rule_set['update'];if(allowed)
{var all=sg_deep_copy(this.state.status_list_subset);all.push(null);rule_set['update_from']=all;rule_set['update_to']=sg_deep_copy(all);}
else
{rule_set['update_from']=[];rule_set['update_to']=[];}}}}
var cfg={see_checkboxes:this.render_permissions_checkboxes('see'),update_checkboxes:this.render_permissions_checkboxes('update'),learn_url:SG.globals.help_urls.permissions};this.container.update(this.templates.content.apply(cfg));},render_permissions_checkboxes:function(permission_type)
{var checkboxes=[];for(var i=0;i<this.state.permissions.length;i++)
{var rule_set=this.state.permissions[i];var checkbox_state=rule_set[permission_type]?'checked':'unchecked';var edit_status_values=(this.state.data_type=='status_list'&&permission_type=='update'&&!rule_set.disable_status_rule_ui);if(edit_status_values)
checkbox_state=this.status_checkbox_state(rule_set);var restrictions=rule_set[permission_type+"_restricted"];var exceptions=rule_set[permission_type+"_exceptions"];if(restrictions=='entity_type_not_visible')
restrictions="(Can't see "+
SG.schema.entity_types[this.state.entity_type].display_name+")";else if(restrictions=='special_rules')
restrictions="(Custom)";else if(restrictions=='read_only')
restrictions="(Read Only)";if(this.state.schema_field&&this.state.schema_field.no_permission_changes||(this.state.schema_field.entity_type=='HumanUser'&&permission_type=='see'&&['password_strength','password_proxy'].indexOf(this.state.schema_field.name)!=-1)){restrictions="(Not Configurable)";}
var exceptions_html;if(exceptions&&!edit_status_values)
{exceptions_html=[];if(exceptions.allow.length>0)
exceptions_html.push("ALLOW "+exceptions.allow.join(", "));if(exceptions.deny.length>0)
exceptions_html.push("DENY "+exceptions.deny.join(", "));exceptions_html="Exceptions: "+exceptions_html.join(", ");}
else
{execeptions=null;exceptions_html='';}
var template=exceptions?'checkbox_with_exceptions':'checkbox';var restricted_star='';var status_special_rules_note='';if(edit_status_values)
{template='status_checkbox';restrictions=null;if(rule_set.custom_status_rules)
{status_special_rules_note="Special (non-configurable) rules apply to this field. "+"Refer to the permissions page "+"for more information. Changes made here that conflict with other rules may not take effect.";restricted_star="*";}}
var status_value_rows='';if(edit_status_values)
status_value_rows=this.render_status_value_rows(rule_set);var classes=(restrictions?' disabled':'');var checkbox_id=permission_type+'_permission_'+rule_set.set_id;checkboxes.push(this.templates[template].apply({checkbox_id:checkbox_id,classes:classes,permission_set_name:rule_set.display_name,set_code:rule_set.code,rule_type:permission_type,restricted_note:restrictions||status_special_rules_note,exceptions:exceptions_html,restricted_star:restricted_star,status_value_rows:status_value_rows,checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,(restrictions?true:false))}));}
return checkboxes.join('');},status_checkbox_state:function(rule_set)
{if(this.state.status_list_subset.length==0)
return'checked';if(rule_set['update_from'].length==0&&rule_set['update_to'].length==0)
return'unchecked';var count=this.state.status_list_subset.length+1;var total_actual=rule_set['update_from'].length+rule_set['update_to'].length;if(total_actual==(count*2))
return'checked';else
return'dashed';},get_all_statuses:function()
{var statuses=sg_deep_copy(this.state.status_list_subset);if(statuses.length>0)
statuses.push(null);return statuses;},render_status_value_rows:function(rule_set)
{var statuses=this.get_all_statuses();if(statuses.length>0)
{var status_rows=[];for(var i=0;i<statuses.length;i++)
{var status=statuses[i];var status_display;if(status!=null)
{var status_schema=SG.schema.status_list[status];var status_icon=SG.Renderers.render_one_status_icon(status);status_display=this.templates.status.apply({icon:status_icon,name:status_schema.name});}
else
{status_display=this.templates.status.apply({icon:'',name:"(Empty)"});}
var update_from_state=rule_set['update_from'].indexOf(status)>-1?'checked':'unchecked';var update_to_state=rule_set['update_to'].indexOf(status)>-1?'checked':'unchecked';var update_from_id='update_from_permission_'+rule_set.set_id+'_status_'+status;var update_to_id='update_to_permission_'+rule_set.set_id+'_status_'+status
status_rows.push(this.templates.status_value_checkbox_row.apply({status:status_display,from_checkbox:this.templates.checkbox.apply({checkbox_id:update_from_id,classes:'status_value',permission_set_name:'Edit From',set_code:rule_set.code,rule_type:'update_from',status:status,checkbox:SG.Checkbox.render(update_from_id,null,update_from_state)}),to_checkbox:this.templates.checkbox.apply({checkbox_id:update_to_id,classes:'status_value',permission_set_name:'Edit To',set_code:rule_set.code,rule_type:'update_to',status:status,checkbox:SG.Checkbox.render(update_to_id,null,update_to_state)})}));}
return status_rows.join('');}
else
return"<tr><td>Please select statuses on the 'General' tab before setting status permissions."},on_checkbox_change:function(checkbox)
{if(Ext.lib.Dom.isAncestor(this.container,checkbox))
{var set_code=checkbox.parentNode.getAttribute("set_code");var type=checkbox.parentNode.getAttribute("rule_type");var checkbox_state=checkbox.getAttribute('checkbox_state');var set=this.find_set(set_code);if(set)
{if(type=='update'&&this.state.data_type=='status_list'&&!set.disable_status_rule_ui)
this.on_status_field_update_permission_change(set,checkbox_state,checkbox);else if(type=='update_from'||type=='update_to')
this.on_status_field_update_value_permission_change(set,type,checkbox);else
set[type]=(checkbox_state=='checked'?true:false);}}},on_click:function(e)
{var target=Ext.get(e.getTarget());var checkbox_parent=target.findParent('span.permissions_tab_opener.status',this.container);if(checkbox_parent)
{var checkbox_div=checkbox_parent.parentNode;var status_table=Ext.get(checkbox_div.nextSibling);var opener=Ext.get(checkbox_div.firstChild.firstChild);if(status_table.hasClass('hidden'))
{status_table.removeClass('hidden');opener.removeClass('arrow_closed_dark');opener.addClass('arrow_open_dark');}
else
{status_table.addClass('hidden');opener.removeClass('arrow_open_dark');opener.addClass('arrow_closed_dark');}}},on_status_field_update_permission_change:function(set,checkbox_state,parent_checkbox)
{var statuses=this.get_all_statuses();for(var i=0;i<statuses.length;i++)
{var status=statuses[i];var checkbox=sg_find('div#update_from_permission_'+set.set_id+'_status_'+status,this.container.dom);SG.Checkbox.set_state(checkbox,checkbox_state);var index=set['update_from'].indexOf(status);if(checkbox_state=='checked'&&index==-1)
{set['update_from'].push(status);}
else if(checkbox_state=='unchecked'&&index>-1)
{set['update_from'].splice(index,1);}
index=set['update_to'].indexOf(status);checkbox=sg_find('div#update_to_permission_'+set.set_id+'_status_'+status,this.container.dom);SG.Checkbox.set_state(checkbox,checkbox_state);if(checkbox_state=='checked'&&index==-1)
{set['update_to'].push(status);}
else if(checkbox_state=='unchecked'&&index>-1)
{set['update_to'].splice(index,1);}}},on_status_field_update_value_permission_change:function(set,type,checkbox)
{var status=checkbox.parentNode.getAttribute('status');if(!status)
status=null;var index=set[type].indexOf(status);var checkbox_state=checkbox.getAttribute('checkbox_state');if(checkbox_state=='checked'&&index==-1)
set[type].push(status);else if(checkbox_state=='unchecked'&&index>-1)
set[type].splice(index,1);var parent_checkbox=sg_find('div#update_permission_'+set.set_id,this.container.dom);var parent_state=this.status_checkbox_state(set);SG.Checkbox.set_state(parent_checkbox,parent_state);},find_set:function(code){var i,set;for(i=0;i<this.state.permissions.length;i++){set=this.state.permissions[i];if(set.code==code)
return set;}
return null;}});SG.ConfigureField.TypeProperties=function(config)
{Ext.apply(this,config);SG.ConfigureField.TypeProperties.superclass.constructor.call(this);};Ext.extend(SG.ConfigureField.TypeProperties,SG.Component,{templates:{summary_default:'<div class="option"><table><tr>'+'<td class="label">Summary:</td>'+'<td><select class="summary_default" {disabled}>{options}</select>'+'</td></tr></table></div>',substitute_sort:'<div class="option"><table><tr>'+'<td class="label">Sort by:</td>'+'<td><select class="substitute_sort" {disabled}>{options}</select>'+'</td></tr></table></div>',select_option:'<option value="{name}" {extra}>{display_name}</option>',open_in_new_window:'<div class="option"><input type="checkbox" class="open_in_new_window" {checked}> '+'Open link in new window</div>',ensure_unique:'<div class="option"><input type="checkbox" class="unique" {checked} {disabled}> '+'Ensure unique values{per_project}</div>',list_values:'<div class="option"><div><b>List of Choices</b></div>'+'<div>(Separate each choice on a new line.)</div>'+'<textarea rows="6" class="list_values">'+'{values}</textarea></div>',entity_type_radios:'<div class="option"><div class="entity_type_title"><b>Link to Entity Type</b></div>'+'<div>{radios}</div></div>',entity_type_radio:'<input type="radio" name="entity_type_radio" value="{value}" {extra}>&nbsp;{display_name}<br>',entity_type_checks:'<div class="option"><div class="entity_type_title"><b>Restrict to Entity Type(s)</b></div>'+'{special}<div>{checks}</div></div>',entity_type_check:'<input type="checkbox" class="entity_type_check" value="{value}" {extra}>&nbsp;{display_name}<br>',status_list_data_type_options:'<div id="sgd_status_list_restriction" style="margin-bottom: 5px;">'+'<table class="status_list_layout_table">'+'<td class="status_list_all_statuses"><table class="status_list_icons">{checkbox_rows}</table></td>'+'<td class="status_list_divider" style="width:"></td>'+'<td class="status_list_ordered_statuses">'+'<div id="status_list_order_drag_proxy">&nbsp;</div>'+'<table>{ordered_statuses}</table>'+'<div class="option status_list_default" style="{status_list_default_style}">Default: '+'<select class="status_list_default" {select_attr}>'+'{select_options}</select></div>'+'</td>'+'</table></div>'+'<div id="sgd_status_list_custom_link">'+'<span class="add_custom_status fake_link">[+] Add New Status</span>{go_to_status_page_link}</div>',status_list_go_to_status_page_link:'<a href="/page/{page_id}" class="go_to_status_page fake_link">Go to Status List page</a>',status_list_checkbox_row:'<tr class="{new_class}">'+'<td class="checkbox">'+'<input type="checkbox" class="status_list_subset" id="sgd_status_list_options_{status}" '+'value="{status}" {attr} /></td>'+'<td class="icon"><label for="sgd_status_list_options_{status}">{status_icon_html}</label></td>'+'<td class="code"><label for="sgd_status_list_options_{status}">{status}</label></td>'+'<td class="label"><label for="sgd_status_list_options_{status}">{status_display_name}</label></td></tr>',status_list_order_block:'<tr class="status_list_order_row" status="{status}">'+'<td class="status_list_order_icon"><div>{status_icon_html}</div></td>'+'<td class="status_list_order_code">{status}</td>'+'<td class="status_list_order_name">{name}</td>'+'<td class="status_list_order_drag_handle"><div class="field_prop_drag_handle"></div></td>'+'<td class="status_list_order_trash"><div class="trash"></div></td>'+'</tr>',},init_component:function(){this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);},render:function(){var sf=this.state.schema_field;var h='';switch(this.state.data_type){case'text':case'number':if(sf&&!sf.read_only)h+=this.render_ensure_unique();break;case'url':h+=this.render_open_in_new_window();break;case'list':h+=this.render_list_values();break;case'multi_entity':if(sf&&sf.field_type!="dynamic")
h+=this.render_entity_type_checkboxes();else
h+=this.render_entity_type_radios();break;case'entity':h+=this.render_entity_type_checkboxes();break;case'status_list':h+=this.render_status_list();break;}
h+=this.render_summary_default();if(!(sf&&sf.entity_type=="Task"&&sf.name=="step"))
h+=this.render_substitute_sort();this.container.update(h);if(this.state.data_type=='status_list'&&!this.status_dnd)
{var dnd_cfg={container:this.container,reorder_callback:{fn:this.on_status_dnd_reorder,scope:this},drag_handle_selector:'div.field_prop_drag_handle',row_element_selector:'tr.status_list_order_row',row_proxy_name_selector:'tr.status_list_order_row',drag_element_proxy_id:'status_list_order_drag_proxy',};this.status_dnd=new SG.util.RowDragReorder(dnd_cfg);}},render_open_in_new_window:function(){var defined=this.state.hasOwnProperty('open_in_new_window');var checked=defined?this.state.open_in_new_window:true;var cfg={checked:checked?'checked':''};return this.templates.open_in_new_window.apply(cfg);},render_ensure_unique:function(){var defined=this.state.hasOwnProperty('unique');var checked=defined?this.state.unique:false;var disabled=false;if(this.state.schema_field.entity_type=="HumanUser"&&this.state.schema_field.name=="login")
disabled=true;var cfg={checked:checked?'checked':'',disabled:disabled?'disabled':''};var has_projects=SG.schema.entity_types[this.state.entity_type].has_projects;if(has_projects)
cfg.per_project=" per project";return this.templates.ensure_unique.apply(cfg);},render_list_values:function(){return this.templates.list_values.apply({values:this.state.list_values});},render_entity_type_checkboxes:function(){var ets=SG.schema.sorted_valid_field_entity_types();var sf=this.state.schema_field;var all_disabled,et,cfg,extra,h='',special='';if(sf&&sf.entity_types_nonconfigurable)
all_disabled=true;if(sf&&sf.entity_type=="Task"&&sf.name=="entity"){var plink='<a href="/preferences/">site preferences page</a>';special+='<div><br>'+'To enable Tasks on specific entities, go to the "Entities" section on the '+
plink+'.<br><br></div>';all_disabled=true;}
for(var i=0;i<ets.length;i++){et=ets[i];extra='';if(this.state.schema_field&&this.state.schema_field.allowed_entity_types.indexOf(et)!==-1)
extra='checked';if(all_disabled||(sf&&sf.entity_type=="Note"&&sf.name=="note_links"&&['Task','Note'].indexOf(et)!=-1))
extra+=' disabled';cfg={value:et,display_name:SG.schema.entity_types[et].display_name,extra:extra};h+=this.templates.entity_type_check.apply(cfg);}
return this.templates.entity_type_checks.apply({checks:h,special:special});},render_entity_type_radios:function(){var ets=SG.schema.sorted_valid_field_entity_types();var et,cfg,extra,h='';for(var i=0;i<ets.length;i++){et=ets[i];extra='';if(this.state.schema_field)
extra+='disabled';if(this.state.schema_field&&this.state.schema_field.allowed_entity_types[0]==et)
extra+=' checked';cfg={value:et,display_name:SG.schema.entity_types[et].display_name,extra:extra};h+=this.templates.entity_type_radio.apply(cfg);}
return this.templates.entity_type_radios.apply({radios:h});},render_summary_default:function(){var summary_options=SG.schema.summary_options[this.state.data_type];if(!summary_options)return'';var opts=[];for(var i=0;i<summary_options.length;i++){opts.push(this.templates['select_option'].apply({name:summary_options[i],display_name:summary_options[i],extra:(summary_options[i]==this.state.summary_default?'selected':'')}));}
var sf=this.state.schema_field;var disabled=sf&&sf.no_summary;var cfg={options:opts.join(''),disabled:disabled?'disabled':''};return this.templates.summary_default.apply(cfg);},render_substitute_sort:function(){var i,sf,extra,opts=[];opts.push(this.templates['select_option'].apply({name:'_NONE_',display_name:'This Field',extra:(this.state.substitute_sort_field!==null)?'':'selected'}));var fields=SG.schema.entity_types[this.state.entity_type].fields_sorted_by_display_name;for(i=0;i<fields.length;i++){sf=SG.schema.get_field(this.state.entity_type,fields[i]);extra='';if(sf.data_type=='pivot_column')
continue;if(sf.no_sorting||sf.substitute_sorting_not_configurable)
extra='disabled';else if(this.state.substitute_sort_field==sf.name)
extra='selected';opts.push(this.templates['select_option'].apply({name:sf.name,display_name:sf.display_name,extra:extra}));}
var sf=this.state.schema_field;var disabled=sf&&sf.substitute_sorting_not_configurable;var cfg={options:opts.join(''),disabled:disabled?'disabled':''};return this.templates.substitute_sort.apply(cfg);},render_status_list:function(){var h='';var status_list=SG.schema.status_list;var sorted_status_list=[];for(var status in status_list){if(status_list.hasOwnProperty(status)){sorted_status_list.push(status);}}
sorted_status_list.sort(function(a,b){var x=status_list[a].name.toLowerCase();var y=status_list[b].name.toLowerCase();return((x<y)?-1:((x>y)?1:0));});var status,status_icon;var status_checkbox_rows=[];for(var k=0;k<sorted_status_list.length;++k)
{status=sorted_status_list[k];status_icon=SG.Renderers.render_one_status_icon(status);status_checkbox_rows.push(this.templates['status_list_checkbox_row'].apply({new_class:(status==this.new_status)?'new_status':'',status:status,status_display_name:status_list[status].name,status_icon_html:status_icon,attr:this.state.status_list_subset.indexOf(status)!=-1?' checked':''}));}
var go_to_status_page_link='';if(SG.schema.can_see_entity_type('Status')&&SG.globals.status_admin_page_id)
go_to_status_page_link=this.templates['status_list_go_to_status_page_link'].apply({page_id:SG.globals.status_admin_page_id});var ordered=[];for(k=0;k<this.state.status_list_subset.length;k++)
{var status=this.state.status_list_subset[k];status_icon=SG.Renderers.render_one_status_icon(status);ordered.push(this.templates.status_list_order_block.apply({status:status,name:status_list[status].name,status_icon_html:status_icon}));}
ordered=ordered.join('');var default_status_dropdown_options='';if(this.state.status_list_subset.length>0)
default_status_dropdown_options=this.render_default_status_dropdown_options();h+=this.templates['status_list_data_type_options'].apply({checkbox_rows:status_checkbox_rows.join(''),select_options:default_status_dropdown_options,status_list_default_style:default_status_dropdown_options==""?"visibility: hidden;":"",go_to_status_page_link:go_to_status_page_link,ordered_statuses:ordered});return h;},render_default_status_dropdown_options:function()
{var select_options=[];select_options.push(this.templates.select_option.apply({name:'_NONE_',display_name:'',extra:''}));for(var i=0;i<this.state.status_list_subset.length;i++)
{var status=this.state.status_list_subset[i];select_options.push(this.templates['select_option'].apply({name:status,display_name:status+' - '+SG.schema.status_list[status].name,extra:status===this.state.status_list_default?'selected':''}));}
return select_options.join('');},rerender_status_order_editor:function()
{var ordered=[];for(k=0;k<this.state.status_list_subset.length;k++)
{var status=this.state.status_list_subset[k];status_icon=SG.Renderers.render_one_status_icon(status);ordered.push(this.templates.status_list_order_block.apply({status:status,name:SG.schema.status_list[status].name,status_icon_html:status_icon}));}
ordered=ordered.join('');var container=sg_find("td.status_list_ordered_statuses",this.container.dom);container=container.childNodes[1];container.innerHTML=ordered;},on_click:function(e){var target=Ext.get(e.getTarget());var click_target=target.findParent('span.add_custom_status');if(click_target)
{this.show_new_status_dialog();return;}
click_target=target.findParent('td.status_list_order_trash',5);if(click_target)
{click_target=target.findParent('tr.status_list_order_row',5);var status=click_target.getAttribute('status');this.toggle_status(status);}},toggle_status:function(status)
{var index=this.state.status_list_subset.indexOf(status);var activate=(index==-1);if(activate)
this.add_status(status);else
this.remove_status(status,index);var item=sg_find('select.status_list_default',this.container.dom);item.innerHTML=this.render_default_status_dropdown_options();if(this.state.status_list_subset.length==0)
Ext.get(item.parentNode).hide();else
Ext.get(item.parentNode).show();var checkbox=sg_find('input#sgd_status_list_options_'+status,this.container.dom);checkbox.checked=activate;this.rerender_status_order_editor();},add_status:function(status)
{this.state.status_list_subset.push(status);for(var i=0;i<this.state.permissions.length;i++)
{var rule_set=this.state.permissions[i];if(!rule_set['update_from'])
continue;if(rule_set['update_from'].length==this.state.status_list_subset.length&&rule_set['update_to'].length==this.state.status_list_subset.length)
{rule_set['update_from'].push(status);rule_set['update_to'].push(status);}}},remove_status:function(status,index)
{this.state.status_list_subset.splice(index,1);for(var i=0;i<this.state.permissions.length;i++)
{var rule_set=this.state.permissions[i];if(!rule_set['update_from'])
continue;var index=rule_set['update_from'].indexOf(status);if(index>-1)
rule_set['update_from'].splice(index,1);index=rule_set['update_to'].indexOf(status);if(index>-1)
rule_set['update_to'].splice(index,1);}},on_change:function(e){var v,idx;var target=Ext.get(e.getTarget());var summary_default=target.findParent('select.summary_default');if(summary_default){this.state.summary_default=summary_default.value;}
var substitute_sort=target.findParent('select.substitute_sort');if(substitute_sort){this.state.substitute_sort_field=substitute_sort.value;if(this.state.substitute_sort_field=='_NONE_')
this.state.substitute_sort_field=null;}
var status_list_default=target.findParent('select.status_list_default');if(status_list_default){this.state.status_list_default=status_list_default.value;if(this.state.status_list_default=='_NONE_')
this.state.status_list_default=null;}
var status_list_subset=target.findParent('input.status_list_subset');if(status_list_subset){this.toggle_status(status_list_subset.value);}
var open_in_new_window=target.findParent('input.open_in_new_window');if(open_in_new_window){this.state.open_in_new_window=open_in_new_window.checked;}
var ensure_unique=target.findParent('input.unique');if(ensure_unique){this.state.unique=ensure_unique.checked;}
var list_values=target.findParent('textarea.list_values');if(list_values){this.state.list_values=list_values.value;}
var entity_type_radio=target.findParent('input[name=entity_type_radio]');if(entity_type_radio){this.state.dynamic_multi_entity_type=entity_type_radio.value;}
var entity_type_check=target.findParent('input.entity_type_check');if(entity_type_check){v=entity_type_check.value;idx=this.state.allowed_entity_types.indexOf(v);if(entity_type_check.checked&&idx===-1)
this.state.allowed_entity_types.push(v);else if(!entity_type_check.checked&&idx!==-1)
this.state.allowed_entity_types.splice(idx,1);}},on_status_dnd_reorder:function()
{var new_status_list=[];var status_rows=Ext.DomQuery.select('tr.status_list_order_row',this.container.dom);for(var i=0;i<status_rows.length;i++)
{var status=status_rows[i].getAttribute('status');new_status_list.push(status);}
this.state.status_list_subset=new_status_list;},show_new_status_dialog:function(){var factory_context={entity_type:'Status',data_record:new SG.Data.Record('Status')};var factory=new SG.EntityFactory(factory_context);factory.on("done",function(record)
{var nef_config={entity_type:'Status',source_record:record};var nef=sg_new_entity_dialog(nef_config);nef.on('entity_created',this.on_new_status_created,this);},this);factory.create();},on_new_status_created:function(new_records){var rec=new_records[0];var icon_id=rec.get('icon').id;var status_hash=sg_deep_copy(SG.schema.icon_list[icon_id]);status_hash['name']=rec.get('name');if(rec.get('bg_color'))
status_hash['bg_color']="rgb("+rec.get('bg_color')+")";SG.schema.status_list[rec.get('code')]=status_hash;this.add_status(rec.get('code'));this.new_status=rec.get('code');setTimeout(function(){var row=Ext.get(sg_find('tr.new_status'));row.animate({backgroundColor:{from:'#00FF00',to:'#FFFFFF'}},0.7,function(){row.removeClass('new_status');this.new_status=null;},'easeOut','color');},700);this.render();}});SG.NewEntityDialog=function(config)
{Ext.apply(this,config);this.projects=sg_deep_copy(config.all_projects);this.events={"entity_created":true,"form_canceled":true};SG.NewEntityDialog.superclass.constructor.call(this,config);};Ext.extend(SG.NewEntityDialog,SG.Component,{cancel_button_text:'Cancel',templates:{dialog_header:'<div class="dialog_drag_div">{title}{gear_menu}</div>'+'<div class="revert_save_div"></div>',gear_menu:'<img class="gear_menu" src="/images/gear_menu_nobg.png">',revert_save_controls:'<center><span class="field_settings_controls">Layout has changed'+'<span class="control revert">Revert</span>|'+'<span class="control save">Save</span></span></center>',field:'<div class="field" field="{field}"><table class="field_edit"><tr>'+'<td class="field_label {mandatory}" sg_tip="{sg_tip}"><div>{field_label}</div></td>'+'<td class="field_value {cell_classes}" {cell_attributes}>{cell_content}'+'</td></tr></table></div>',field_notice:'<div class="field" ><table class="field_edit"><tr>'+'<td class="field_label"></td>'+'<td class="field_value"><div class="field_notice">{notice}</div>'+'</td></tr></table></div>',create_multiple_field:'<div class="field"><table class="field_edit"><tr>'+'<td class="field_label" sg_tip="{sg_tip}"><div>{field_label}</div></td>'+'<td class="field_value create_multiple_field">{cell_content}{create_multiple_notice}'+'</td></tr></table></div>',create_multiple_notice_no_choice:'<div class="create_multiple_notice">'+'Unique {entity_type_plural} will be created for each linked {linked_entity_type_name}.</div>',create_multiple_notice_choices:'<div class="create_multiple_notice" ><form><div sg_tip="{sg_tip}">'+'<input class="multi_choice" type="radio" name="choice" value="one" '+'{single_checked} />Create '+'<span style="font-weight:bold;">1</span> {entity_type} '+'{action} to all these {linked_entity_plural}{and_other_types}<br></div>'+'<input class="multi_choice" type="radio" name="choice" value="many" {multi_checked} />Create '+'<span style="font-weight:bold;">{count}</span> duplicate '+'{entity_type_plural}, each {action} to a single {linked_entity}</form></div>',footer:'<div class="controls">'+'<span class="footer_warning">{warning_text}</span>'+'<span class="cancel">{cancel_button_text}</span>'+'{addition_create_button}'+'<input name="create" type="button" {disabled} value="{create_button_text}"></div>',create_another_button:'<input name="create_another" type="button" value="Create and add another">',empty:'<div class="empty">There are no fields configured for this form.'+' Use the gear menu in the top right hand corner of this form to add some.</div>',extra_controls:'<div class="field"><table class="field_edit"><tr><td class="field_label"></td><td>'+'<span class="more_fields">More fields<div class="dropdown_arrow_small"></div></span>'+'{attachment_toggle}</td></tr></table></div>',attachment_toggle:'<span class="attach_files"><img class="paperclip" src="/images/paperclip.png">'+'<span class="attach_text">Attach</span></span>',new_entity_message:'{entity} {detail_link} has been created.',create_multiple_message:'{count} {entity_type_plural} have been created.',attachment_files:'<div class="attach_me {extra_cls}" field="{field}"></div>',attachment_field:'<div class="field" field="{field}"><table class="field_edit"><tr>'+'<td class="field_label {mandatory}" sg_tip="{sg_tip}"><div>{field_label}</div></td>'+'<td class="field_value">{attachment_files}'+'</td></tr></table></div>',temp_password_control:'<div class="field"><table class="field_edit"><tr><td class="field_label"></td><td>'+'<div class="temp_password_message">Use a temporary password'+'<span class="set_password">Set password</span></div></td></tr></table></div>',password_control:'<div class="wrapper"><div class="control">{control}</div><div class="toggle"></div></div>{email}',password_email_toggle:'<div class="field"><table class="field_edit"><tr><td class="field_label"></td><td>'+'<div class="password_email">{checkbox}<div class="icon_email_password"></div>'+'<span class="message">Send a welcome email</span></div></td></tr></table></div>',use_temp_password:'<div class="field"><table class="field_edit"><tr><td class="field_label"></td><td>'+'<span class="use_temp_password">Use a temporary password</span>'+'</td></tr></table></div>',},field_notices:{Project:{layout_project:"Choose an existing project to use as a template for pages and layouts."},Status:{code:"This value should be less than 7 characters long. It is used by the system as an"+" ID and can not be changed in the future."}},init_component:function()
{this.update_mode='close_on_create';this.persistent_update_mode='close_on_create';if(!this.entity_field_pref)
this.entity_field_pref='new_entity';this.revert_field_settings=[];this.more_fields=[];this.data_set=this.new_data_set(this.entity_type,null,this.on_data_change);this.setup_record();this.render_as_dialog=true;if(this.container)
this.render_as_dialog=false;if(this.parent_entity&&this.parent_entity.type==='TaskTemplate')
this.hide_project_selector=true;if(this.entity_type=='Page')
this.hide_project_selector=true;if(this.render_as_dialog)
this.on_first_render_as_dialog();else
this.on_first_render_in_container();this.attachment_controls={};this.upload_queue=[];this.init_fields();this.render_body();if(!this.ignore_unsaved_data)
SG.Page.unsaved_data.add(this);},setup_record:function()
{if(this.record)
this.data_set.remove([this.record]);this.record=this.data_set.new_record();if(SG.schema.entity_types[this.entity_type].has_projects)
this.set_project(this.single_project?this.single_project:null);if(this.source_record)
this.load_source_record();},save_values_for_reuse:function()
{var fields=this.record.get_fields();var field,i;this.saved_values={};for(i=0;i<fields.length;i++)
{field=fields[i];var schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field.read_only&&!this.blocked_in_this_context(field))
this.saved_values[field]=this.record.get(field);}},copy_record_for_reuse:function()
{this.setup_record();for(var field_name in this.saved_values)
{if(!this.saved_values.hasOwnProperty(field_name))
continue;this.record.set(field_name,this.saved_values[field_name]);}
if(this.saved_values.project)
this.set_project(this.saved_values.project);},has_unsaved_data:function()
{var all_fields=this.field_settings.concat(this.more_fields);for(var i=0;i<all_fields.length;i++)
{var field_hash=all_fields[i];var schema_field=SG.schema.get_field(this.entity_type,field_hash.field);var editor=SG.GridEditorFactory(schema_field.editor||schema_field.data_type);if(editor)
{if(!editor.values_equal(this.record.get(field_hash.field),this.source_record.get(field_hash.field)))
return true;}
else
{if(this.record.get(field)!=this.source_record.get(field))
return true;}}
return false;},init_fields:function()
{this.field_settings=[];var new_entity_fields=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];var db_field_settings=[];if(new_entity_fields&&new_entity_fields.settings.length>0)
db_field_settings=new_entity_fields.settings;var i;for(i=0;i<db_field_settings.length;i++)
{var field_hash=db_field_settings[i];var schema_field=SG.schema.get_field(this.entity_type,field_hash.field);if(schema_field&&!this.blocked_in_this_context(field_hash.field)){this.field_settings.push(field_hash);}}
this.revert_field_settings=sg_deep_copy(this.field_settings);if(SG.schema.entity_types[this.entity_type].has_projects&&!this.hide_project_selector)
this.more_fields.push({field:"project",mandatory_on_create:true,show_label:true});var fields_from_settings=[];for(i=0;i<this.field_settings.length;i++){fields_from_settings.push(this.field_settings[i].field);}
if(!this.hide_fields_with_default_values){var record_fields=this.record.get_fields();var schema_field,simple;for(i=0;i<record_fields.length;i++)
{field=record_fields[i];schema_field=SG.schema.get_field(this.entity_type,field);simple=SG.schema.is_simple_field(this.entity_type,field);if(fields_from_settings.indexOf(field)!==-1)
continue;if(schema_field.data_type=='status_list'&&this.record.get(field)==schema_field.status_list_default){continue;}
if(field!='project'&&simple&&schema_field.grid_column){this.more_fields.push({field:field,show_label:true});}}}
for(var i=0;i<this.field_settings.length;i++)
{var field_hash=this.field_settings[i];var data_type=SG.schema.get_field(this.entity_type,field_hash.field)['data_type'];if(data_type=='multi_entity')
{if(this.record.get(field_hash.field)==null)
this.record.set(field_hash.field,[]);if(this.source_record.get(field_hash.field)==null)
this.source_record.set(field_hash.field,[]);}}
var edit_container=null;if(this.render_as_dialog)
edit_container=this.container;if(this.parent_entity)
this.data_set.parent_entity=this.parent_entity;var cell_config={container:this.container,edit_container:edit_container,data_set:this.data_set,projects:this.projects,in_form:true,get_fields_callback:{fn:this.get_fields,scope:this},before_first_cell:{fn:this.on_before_first_cell,scope:this},after_last_cell:{fn:this.focus_create_button,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);},edit_cell:function(cell)
{var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="'+cell.field+'"]';var cell_elem=sg_find(sel,this.body.dom);if(cell_elem){cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});}},edit_first_field:function()
{if(this.field_settings.length==0)
return;var field_hash=this.field_settings[0];var i=0;while(i<this.field_settings.length&&this.blocked_in_this_context(field_hash.field)){i++;field_hash=this.field_settings[i];}
var cell=this.cell_manager.get_cell(field_hash.field,{type:this.get_cell_type(field_hash)});if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}},edit_last_field:function()
{if(this.last_rendered_cell){var me=this;setTimeout(function(){me.edit_cell(me.last_rendered_cell);});}},get_fields:function(){var sf,f=[];var all_fields=this.field_settings.concat(this.more_fields);for(var i=0;i<all_fields.length;i++){sf=SG.schema.get_field(this.entity_type,all_fields[i].field);if(sf.data_type!="url"&&!(this.entity_type=='HumanUser'&&sf.name=='password_proxy'))
f.push(all_fields[i].field);}
if(this.create_multiple_field)
{var idx=f.indexOf(this.create_multiple_field);if(idx!=-1)
f.splice(idx,1);}
return f;},on_first_render_as_dialog:function()
{this.dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=this.dh.append(this.mask,{tag:'div',cls:'sg_dialog sg_new_entity_form'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'form_header'},true);this.body_scroll=this.dh.append(this.container,{tag:'div',cls:'form_body'},true);this.body=this.dh.append(this.body_scroll,{tag:'div',cls:'body'},true);this.more_fields_div=this.dh.append(this.body_scroll,{tag:'div',cls:'more_fields'},true);this.extra_controls=this.dh.append(this.body_scroll,{tag:'div',cls:'extra_controls'},true);if(this.entity_type=='HumanUser'){var email=this.templates.password_email_toggle.apply({checkbox:SG.Checkbox.render('password_email_toggle',null,'checked',null,'password_email'),});this.password_container=this.dh.append(this.body_scroll,{tag:'div',cls:'password_validator'},true);this.password_container.update(this.templates.password_control.apply({control:this.templates.temp_password_control.apply(),email:email}));this.add_event(this.password_container,'click',this.on_password_container_click);}
this.footer=this.dh.append(this.container,{tag:'div',cls:'form_footer'},true);this.container.setWidth(500);this.container.setHeight(200);this.render_header();this.render_footer();this.render_extra_controls();this.add_event(this.header,'click',this.on_header_click);this.add_event(this.footer,'click',this.on_footer_click);this.add_event(this.extra_controls,'click',this.on_extra_controls_click);this.add_event(this.body_scroll,'scroll',this.on_body_scroll);if(this.entity_type=='HumanUser'){this.add_event(document,'keyup',this.on_new_user_keyup);}else{this.add_event(document,'keydown',this.on_keydown);this.add_event(document,'keyup',this.on_keyup);}
Ext.EventManager.onWindowResize(this.position_form,this,true);this.shadow=new Ext.Shadow({offset:5,mode:'frame'});var dd=new Ext.dd.DDProxy(this.container,"new_entity_dialog",{scroll:false});dd.setHandleElId(this.header);dd.new_entity_dialog=this;dd.startDrag=function(){var me=this;var blur_func=function(){if(me.new_entity_dialog.cell_manager.active_editor)
me.new_entity_dialog.cell_manager.active_editor.blur();};window.setTimeout(blur_func,0);this.constrainTo(this.new_entity_dialog.dbody);var drag_elem=this.getDragEl();Ext.fly(drag_elem).setStyle({border:'2px solid rgb(150,150,150)','z-index':'10001',});this.new_entity_dialog.shadow.hide();};dd.afterDrag=function(){this.new_entity_dialog.last_y=this.new_entity_dialog.container.getTop();this.new_entity_dialog.shadow.show(this.new_entity_dialog.container);};},on_first_render_in_container:function()
{this.dh=Ext.DomHelper;this.container.addClass('sg_new_entity_form');this.header=this.dh.append(this.container,{tag:'div',cls:'form_header'},true);this.body_scroll=this.dh.append(this.container,{tag:'div',cls:'form_body'},true);this.body=this.dh.append(this.body_scroll,{tag:'div',cls:'body'},true);this.more_fields_div=this.dh.append(this.body_scroll,{tag:'div',cls:'more_fields'},true);this.extra_controls=this.dh.append(this.body_scroll,{tag:'div',cls:'extra_controls'},true);this.footer=this.dh.append(this.container,{tag:'div',cls:'form_footer'},true);this.render_header();this.render_footer();this.render_extra_controls();this.add_event(this.header,'click',this.on_header_click);this.add_event(this.footer,'click',this.on_footer_click);this.add_event(this.extra_controls,'click',this.on_extra_controls_click);},render_header:function()
{var can_configure=SG.schema.can_edit_field('EntityFieldPref','settings')&&['Status','Page'].indexOf(this.entity_type)==-1;var html='';if(this.render_as_dialog)
{html=this.templates.dialog_header.apply({title:this.get_dialog_title(),gear_menu:can_configure?this.templates.gear_menu.apply():''});}
else if(can_configure)
html=this.templates.gear_menu.apply();this.header.update(html);},get_dialog_title:function()
{var edn=SG.schema.entity_types[this.entity_type]['display_name'];return'Create a new '+edn;},render_body:function()
{if(this.progress_indicator)
this.progress_indicator.hide();var schema=SG.schema.entity_fields[this.entity_type];var af,h='';for(af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;this.attachment_controls[af].component.destroy();this.attachment_controls[af].component=null;delete(this.attachment_controls[af]);}
if(this.entity_type=="Attachment"){if(!this.attachment_controls.hasOwnProperty('this_file'))
this.attachment_controls['this_file']={};h+=this.templates.attachment_files.apply({field:"this_file"});}
var field_hash,mandatory,field_label,template,sg_tip;var cell,cell_type,cell_hash,first_cell;var settings=sg_deep_copy(this.field_settings).concat(sg_deep_copy(this.more_fields));for(var i=0;i<settings.length;i++)
{field_hash=settings[i];if(this.skip_field_render_callback&&this.skip_field_render_callback.fn.call(this.skip_field_render_callback.scope,field_hash.field))
continue;if(this.entity_type=='HumanUser'&&field_hash.field=='password_proxy')continue;data_type=schema[field_hash.field]['data_type'];if(data_type=='url'){h+=this.render_attachment_field(field_hash);continue;}
sg_tip='';mandatory='';if(field_hash.mandatory_on_create)
{sg_tip='Required';mandatory='mandatory';}
field_label='';if(field_hash.show_label)
{field_label=schema[field_hash.field]['display_name'];if(field_hash.field_label_override)
field_label=field_hash.field_label_override;field_label+=':';}
if(field_hash.field==this.create_multiple_field)
{h+=this.render_create_multiple_field(field_label);continue;}
template=this.templates.field;cell_type=this.get_cell_type(field_hash);cell=this.cell_manager.get_cell(field_hash.field,{type:cell_type});this.last_rendered_cell=cell;cell_hash=cell.render(this.record);cell_hash.field=field_hash.field;cell_hash.mandatory=mandatory;cell_hash.field_label=field_label;cell_hash.sg_tip=sg_tip;h+=template.apply(cell_hash);if(this.field_notices[this.entity_type]&&this.field_notices[this.entity_type][field_hash.field])
h+=this.templates.field_notice.apply({notice:this.field_notices[this.entity_type][field_hash.field]});}
if(settings.length==0)
h=this.templates.empty.apply();if(SG.schema.get_field(this.entity_type,'attachments')){if(!this.attachment_controls.hasOwnProperty('attachments'))
this.attachment_controls['attachments']={visible:false};h+=this.templates.attachment_files.apply({field:'attachments',extra_cls:'threaded'});}
this.body.update(h);var sel,div;for(af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;sel='div.attach_me[field='+af+']';div=this.body.child(sel);div.enableDisplayMode();this.attachment_controls[af].container=div;this.render_attachment_control(af);}
this.position_form();this.edit_first_field();},allowed_layout:function()
{return true;},render_create_multiple_field:function(field_label)
{var schema_field=SG.schema.get_field(this.entity_type,this.create_multiple_field);var edn=SG.schema.entity_types[this.entity_type].display_name;var ednp=SG.schema.entity_types[this.entity_type].display_name_pluralized;var create_multiple_notice;if(schema_field.data_type=='multi_entity')
{var linked_entity_type=this.create_multiple_field_values[0][0].type;var ledn=SG.schema.entity_types[linked_entity_type].display_name;var lednp=SG.schema.entity_types[linked_entity_type].display_name_pluralized;var other_types=this.get_list_of_other_linked_entity_types();var and_other_types='';if(other_types.length>0)
and_other_types=' and linked '+other_types.join(", ");var sg_tip='';var projects_ok=this.check_project_for_linking_all_to_single_entity();if(!projects_ok)
sg_tip='Create 1 Note option disabled because the selected '+lednp+' are in more that one project.';create_multiple_notice=this.templates.create_multiple_notice_choices.apply({entity_type:edn,linked_entity:ledn,linked_entity_plural:lednp,single_checked:projects_ok?'checked="true"':'disabled="true"',multi_checked:projects_ok?'':'checked="true"',sg_tip:sg_tip,count:this.create_multiple_field_values.length,entity_type_plural:ednp,and_other_types:and_other_types,action:this.create_multiple_field=='addressings_to'?'addressed':'linked'});}
else
{var linked_entity_type_name=SG.schema.entity_types[this.create_multiple_field_values[0].type].display_name;create_multiple_notice=this.templates.create_multiple_notice_no_choice.apply({entity_type_plural:ednp,linked_entity_type_name:linked_entity_type_name});}
return this.templates.create_multiple_field.apply({field_label:field_label,create_multiple_notice:create_multiple_notice,cell_content:this.render_create_multiple_field_values(),});},check_project_for_linking_all_to_single_entity:function()
{if(this.create_multiple_field_values.length<2)
return true;var last_project=this.create_multiple_field_values[0][0].project;if(last_project)
last_project=last_project.id;for(var i=1;i<this.create_multiple_field_values.length;i++)
{var project=this.create_multiple_field_values[i][0].project;if(project)
project=project.id;if(last_project!=project)
return false;}
return true;},render_create_multiple_field_values:function()
{var schema_field=SG.schema.get_field(this.entity_type,this.create_multiple_field);if(schema_field.data_type=='entity')
{var renderer=SG.Renderers.nodetail_multi_entity;return renderer.render(this.create_multiple_field_values);}
var linked_entity_type=this.create_multiple_field_values[0][0].type;var s='';var edn=SG.schema.entity_types[linked_entity_type].display_name;var ednp=SG.schema.entity_types[linked_entity_type].display_name_pluralized;var entity_count=this.create_multiple_field_values.length;var dn=entity_count==1?edn:ednp;s+=entity_count+' Selected <div class="sg_entity_icon_span icon_'+linked_entity_type+'"></div>'+dn;if(this.create_multiple_included_task_column)
{s+=' including linked '+this.create_multiple_included_task_column+' Tasks';return s;}
var other_types=this.get_list_of_other_linked_entity_types();if(other_types.length>0)
s+=' including linked '+other_types.join(', ');return s;},get_list_of_other_linked_entity_types:function()
{var other_linked_entity_types={};for(var i=0;i<this.create_multiple_field_values.length;i++)
{var vals=this.create_multiple_field_values[i];for(var j=1;j<vals.length;j++)
{var e_type=vals[j].type;if(!other_linked_entity_types[e_type])
other_linked_entity_types[e_type]=true;}}
var other_types=[];for(var other_entity_type in other_linked_entity_types)
{if(!other_linked_entity_types.hasOwnProperty(other_entity_type))
continue;var ednp=SG.schema.entity_types[other_entity_type].display_name_pluralized;other_types.push(ednp);}
return other_types;},field_is_missing:function(field_hash,schema_field)
{if(!field_hash.mandatory_on_create)return false;if(this.create_multiple_field&&this.create_multiple_field===field_hash.field)return false;if(schema_field.data_type==='url')
return!this.attachment_controls[field_hash.field].component.ready();var value=this.record.get(field_hash.field);return value===null||value===''||(typeof value=='string'&&value.strip()=='');},mandatory_inputs:function()
{var missing_fields=[];var missing_field_indexes=[];var schema=SG.schema.entity_fields[this.entity_type];var sf,value,field_hash,schema_field;var fields=this.field_settings.concat(this.more_fields);for(var i=0;i<fields.length;i++)
{field_hash=fields[i];if(this.entity_type=='HumanUser'&&field_hash.field=='password_proxy')continue;schema_field=schema[field_hash.field];if(this.field_is_missing(field_hash,schema_field)){var display_name=schema_field['display_name'];if(field_hash.field_label_override)
display_name=field_hash.field_label_override;missing_fields.push("'"+display_name+"'");missing_field_indexes.push(i);}}
if(this.entity_type=='Attachment'){var ac=this.attachment_controls['this_file'];if(!ac.component.ready())
missing_fields.push(ac.component.not_ready_error());}
if(missing_fields.length>0)
{alert("Please provide: "+missing_fields.join(", ")+".");var field_hash=fields[missing_field_indexes[0]];var cell=this.cell_manager.get_cell(field_hash.field,{type:this.get_cell_type(field_hash)});if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}
return false;}
return true;},get_cell_type:function(field_hash){var schema=SG.schema.entity_fields[this.entity_type];if(typeof(schema[field_hash.field].editor)==="string")
return SG.FakeInputCell;else if(schema[field_hash.field]['data_type']=='url')
return SG.UrlCell;else if(field_hash.large_text_entry&&schema[field_hash.field]['data_type']=='text')
return SG.LargeTextAreaCell;else if(schema[field_hash.field]['data_type']=='text')
return SG.FakeInputCell;else
return SG.FakeInputCell;},option_keydown:false,shift_keydown:false,on_keydown:function(e)
{if(e.keyCode==18&&!this.allow_keep_form_open)
{this.option_key_warning=true;this.render_footer();return;}
switch(e.keyCode)
{case 18:this.option_keydown=true;break;case Ext.EventObject.SHIFT:this.shift_keydown=true;break;}
this.set_keydown_mode();},on_keyup:function(e)
{if(e.keyCode==18&&!this.allow_keep_form_open)
{this.option_key_warning=false;this.render_footer();return;}
switch(e.keyCode)
{case 18:this.option_keydown=false;break;case Ext.EventObject.SHIFT:this.shift_keydown=false;break;case Ext.EventObject.ESC:this.on_escape_key_pressed(e);return;break;}
this.set_keydown_mode();},on_new_user_keyup:function(e)
{if(e.keyCode==Ext.EventObject.ESC){this.on_escape_key_pressed(e);return;}},set_keydown_mode:function()
{if(this.option_keydown&&this.shift_keydown&&this.update_mode!='reset_on_create')
{this.update_mode='reset_on_create';this.render_footer();}
else if(this.option_keydown&&!this.shift_keydown&&this.update_mode!='keep_on_create')
{this.update_mode='keep_on_create';this.render_footer();}
else if(!this.option_keydown&&this.update_mode!=this.persistent_update_mode)
{this.update_mode=this.persistent_update_mode;this.render_footer();}},upload_done:function(attachments,url_field)
{if(this.upload_pi)this.upload_pi.hide();if(url_field&&attachments.length==1){var rec;for(var i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);rec.set(url_field,attachments[0]);}
this.data_set.commit(true);}
this.hide_progress_indicator();if(this.entity_type=='Attachment')
this.handle_attachment_undo(attachments);if(this.upload_queue.length==0){this.entity_created();}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},entity_created:function()
{if(this.entity_type=='HumanUser'&&this.send_welcome_email_is_checked()&&!this.welcome_email_sent){this.send_welcome_email();return;}
switch(this.transient_update_mode)
{case'close_on_create':this.fireEvent("entity_created",this.data_set.records);this.destroy();return;case'keep_on_create':this.fireEvent("entity_created",this.data_set.records);this.copy_record_for_reuse();break;case'reset_on_create':this.fireEvent("entity_created",this.data_set.records);this.setup_record();}
this.welcome_email_sent=false;this.body_scroll.dom.scrollTop=0;this.hide_progress_indicator();this.creating_now=false;this.render_body();this.render_footer();},handle_attachment_undo:function(attachments)
{var i,row;SG.Repo.reset_undo([{request_type:'create'}]);for(i=0;i<attachments.length;i++){row=SG.Repo.get_row('Attachment',attachments[i].attachment_id);row.set('this_file',attachments[i]);SG.Repo.register_undo({type:'retire',spec:{type:'Attachment',id:attachments[i].attachment_id,no_undo:true}});}
SG.Repo.ready_to_undo();},hide_progress_indicator:function()
{if(this.pi)
{this.pi.hide();this.pi=null;}},load_source_record:function(alternate_source_record)
{var source_record=this.source_record;if(alternate_source_record)
source_record=alternate_source_record;var fields=source_record.get_fields();var field,i;for(i=0;i<fields.length;i++){field=fields[i];var schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field.read_only&&!this.blocked_in_this_context(field))
this.record.set(field,source_record.get(field));}},blocked_in_this_context:function(field)
{if(this.entity_type=='Task'&&field=='entity'&&this.parent_entity&&this.parent_entity.type=='TaskTemplate')
{return true;}
if(this.entity_type=='Page'&&field=='project'&&!SG.globals.current_user.can_save_as_project_page)
return true;return false;},reset_after_error:function()
{this.creating_now=false;this.render_footer();this.hide_progress_indicator();},on_data_change:function(changes)
{var change,i;var found_create=false;for(i=0;i<changes.length;i++){change=changes[i];if(change.type=="create")
{found_create=true;}
else if(change.type=="create_failed")
{this.reset_after_error();return;}
else if(change.type=="update"&&change.column=="project")
{if(!this.setting_project)
this.set_project(change.value);}}
if(found_create===false)
return;this.upload_queue=this.create_upload_queue();if(this.upload_queue.length===0){this.hide_progress_indicator();this.entity_created();}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},create_upload_queue:function(){var af,ac,fv,rec,links;var queue=[];for(var af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;ac=this.attachment_controls[af];if(ac.component.ready())
no_attach=false;else
continue;var rec,links=[],fv=[];for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);links.push({type:rec.get_type(),id:rec.get_id()});}
fv.push({column:"attachment_links",value:links});if(this.record.get("project"))
fv.push({column:"project",value:this.record.get("project")});queue.push(this.make_upload_fn_callback(ac,fv));}
return queue;},create_new_entity_if_ready:function()
{if(this.mandatory_inputs()&&this.values_valid())
this.create_new_entity();else
this.creating_now=false;},create_new_entity:function()
{var create_button=this.footer.child('input[name="create"]');create_button.dom.setAttribute('disabled',true);this.pi=new SG.ProgressIndicator();this.pi.show();this.save_values_for_reuse();if(this.entity_type=='Attachment')
{var fields=this.record.get_fields();var fv=[];for(var i=0;i<fields.length;i++){fv.push({column:fields[i],value:this.record.get(fields[i])});}
this.attachment_controls['this_file'].component.submit(fv);return;}
if(this.entity_type=='Page')
{var page_entity_type=this.record.get('entity_type');if(page_entity_type=='_canvas_'){this.record.set('page_type','canvas');this.record.set('entity_type','');}else if(page_entity_type=='_url_'){this.record.set('page_type','url');this.record.set('entity_type','');}}
if(this.entity_type=='HumanUser'){if(this.password_validator){this.temp_password=this.password_validator.get_password();this.record.set('password_proxy',this.temp_password);this.record.set('password_change_next_login',false);this.record.set('password_strength',this.password_validator.get_password_strength());}else{this.temp_password=SG.create_temp_password();this.record.set('password_proxy',this.temp_password);this.record.set('password_change_next_login',true);this.record.set('password_strength',70);}}
if(this.create_multiple_field)
this.create_multiple();else
this.record.commit(this.hide_creation_banner);},send_welcome_email:function(){var rec=this.data_set.get_record(0);SG.send_welcome_email(rec.id,this.temp_password,false,{fn:this.on_welcome_email_sent,scope:this});},on_welcome_email_sent:function(){this.welcome_email_sent=true;this.entity_created();},send_welcome_email_is_checked:function(){var state=SG.Checkbox.get_state('password_email_toggle');return(state=='checked');},create_multiple:function()
{var input_sel=this.container.child('input.multi_choice[value="one"]');if(input_sel&&input_sel.dom.checked)
{var entity_check={};var field_values=[];for(var i=0;i<this.create_multiple_field_values.length;i++)
{var entites=this.create_multiple_field_values[i];for(var j=0;j<entites.length;j++)
{var entity=entites[j];var check_key=entity.type+'_'+entity.id;if(!entity_check[check_key])
{field_values.push(entity);entity_check[check_key]=true;}}}
this.record.set(this.create_multiple_field,field_values);this.record.commit();this.create_multiple_field=null;return;}
var schema_field=SG.schema.get_field(this.entity_type,this.create_multiple_field);var linked_entity_type;var linked_entity_project;if(schema_field.data_type=='multi_entity')
{linked_entity_type=this.create_multiple_field_values[0][0].type;linked_entity_project=this.create_multiple_field_values[0][0].project;}
else
{linked_entity_type=this.create_multiple_field_values[0].type;linked_entity_project=this.create_multiple_field_values[0].project;}
if(SG.schema.entity_types[this.entity_type].has_projects&&SG.schema.entity_types[linked_entity_type].has_projects)
{this.record.set('project',linked_entity_project);}
this.record.set(this.create_multiple_field,this.create_multiple_field_values[0]);for(var i=1;i<this.create_multiple_field_values.length;i++)
{var record=this.data_set.copy_record(this.record);var field_value=this.create_multiple_field_values[i];record.set(this.create_multiple_field,field_value);if(schema_field.data_type=='multi_entity')
{linked_entity_type=field_value[0].type;linked_entity_project=field_value[0].project;}
else
{linked_entity_type=field_value.type;linked_entity_project=field_value.project;}
if(SG.schema.entity_types[this.entity_type].has_projects&&SG.schema.entity_types[linked_entity_type].has_projects)
{record.set('project',linked_entity_project);}
if(SG.schema.entity_types[this.entity_type].has_projects&&linked_entity_type=="Project")
{record.set('project',linked_entity_project);}}
this.data_set.commit();},set_project:function(project,dont_set_record)
{this.setting_project=true;this.record.set('project',project);this.setting_project=false;if(project===null)
{this.projects.splice(0,this.projects.length);for(var i=0;i<this.all_projects.length;i++)
this.projects.push(this.all_projects[i]);}
else
this.projects.splice(0,this.projects.length,project);},values_valid:function()
{if(this.entity_type=='Status')
{var code=this.record.get('code');if(code)
{if(code.length>6)
{alert('The Short Code is too long. Please change it to be less than 7 characters long.');return false;}
if(code.indexOf("'")!=-1||code.indexOf('"')!=-1)
{alert('The Short Code cannot contain single or double quotes.');return false;}}
return true;}
return true;},render_footer:function()
{if(this.create_button)
{this.remove_event(this.create_button,'focus',this.on_create_button_focus);this.remove_event(this.create_button,'blur',this.on_create_button_blur);this.remove_event(this.create_button,"keydown",this.on_create_button_keydown);}
this.footer.update(this.templates.footer.apply({warning_text:this.option_key_warning?"Sorry, \"Keep form\" mode not supported in this context.":"",create_button_text:this.get_create_button_text(),cancel_button_text:this.cancel_button_text,addition_create_button:this.entity_type=='HumanUser'?this.templates.create_another_button.apply():'',disabled:this.configure_only?'disabled="true"':''}));this.create_button=this.footer.child('input[name="create"]');this.add_event(this.create_button,'focus',this.on_create_button_focus);this.add_event(this.create_button,'blur',this.on_create_button_blur);this.add_event(this.create_button,"keydown",this.on_create_button_keydown);if(this.create_button_focused)
{var button=this.create_button.dom;setTimeout(function(){button.focus();},0);}},get_create_button_text:function(){var create_button_part_2='';switch(this.update_mode)
{case'close_on_create':create_button_part_2='';break;case'keep_on_create':create_button_part_2=' and Keep Form Values';break;case'reset_on_create':create_button_part_2=' and Reset Form';break;}
var create_button_part_1='Create '+SG.schema.entity_types[this.entity_type]['display_name'];if(this.entity_type=='Attachment')
create_button_part_1='Create';return create_button_part_1+create_button_part_2;},on_create_button_focus:function(e)
{this.create_button_focused=true;},on_create_button_blur:function(e)
{this.create_button_focused=false;},focus_create_button:function()
{var create_button=this.footer.child('input[name="create"]');setTimeout(function(){create_button.dom.focus();});},on_before_first_cell:function()
{this.focus_create_button();},on_create_button_keydown:function(evt)
{var key=evt.getKey();if(key==Ext.EventObject.TAB)
{evt.stopEvent();if(evt.shiftKey)
this.edit_last_field();else
this.edit_first_field();}},render_attachment_field:function(field_hash)
{var field=field_hash.field;var schema_field=SG.schema.get_field(this.entity_type,field);var sg_tip='',mandatory='',field_label='';if(field_hash.mandatory_on_create)
{sg_tip='Required';mandatory='mandatory';}
if(field_hash.show_label)
{field_label=schema_field.display_name;if(field_hash.field_label_override!='')
field_label=field_hash.field_label_override;field_label+=':';}
var cfg={field:field,field_label:field_label,mandatory:mandatory,sg_tip:sg_tip,attachment_files:this.templates.attachment_files.apply({field:field})};if(!this.attachment_controls.hasOwnProperty(field))
this.attachment_controls[field]={url_field:true};return this.templates.attachment_field.apply(cfg);},render_attachment_control:function(field)
{var ac=this.attachment_controls[field];if(ac.visible===false)
ac.container.hide();var cfg={container:ac.container,done_callback:{fn:this.upload_done,scope:this},error_callback:{fn:this.reset_after_error,scope:this}};if(ac.url_field)
cfg.url_field=field;if(field=='attachments')
cfg.close_callback={fn:this.toggle_attachment_control,scope:this};ac.component=this.new_component(SG.AttachmentControl,cfg);ac.component.render();},render_extra_controls:function()
{var attachment_toggle='';if(SG.schema.get_field(this.entity_type,'attachments'))
attachment_toggle=this.templates.attachment_toggle.apply();else if(['Status','Page'].indexOf(this.entity_type)!=-1)
return;this.extra_controls.update(this.templates.extra_controls.apply({attachment_toggle:attachment_toggle}));},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},{property_name:'mandatory_on_create',data_type:'boolean',display_name:'Required for creation',default_value:false},{property_name:'large_text_entry',data_type:'boolean',display_name:'Use tall text box',default_value:false,restrict_to_field_data_types:['text']}],on_password_container_click:function(e){var t=Ext.get(e.getTarget());var set_password=t.findParent('span.set_password',this.password_container.dom);if(set_password){var validator_container=this.password_container.child('div.control');this.password_validator=new SG.PasswordValidator({container:validator_container});var toggle_container=this.password_container.child('div.toggle');toggle_container.update(this.templates.use_temp_password.apply());this.password_container.addClass('showing');}
var use_temp_password=t.findParent('span.use_temp_password',this.password_container.dom);if(use_temp_password){this.password_validator.destroy();this.password_validator=null;var control=this.password_container.child('div.control');control.update(this.templates.temp_password_control.apply());var toggle_container=this.password_container.child('div.toggle');toggle_container.update('');this.password_container.removeClass('showing');}},on_header_click:function(e)
{var t=Ext.get(e.getTarget());var gear_button=t.findParent('img.gear_menu',this.header,true);if(gear_button)
{if(this.gear_menu&&this.gear_menu.is_showing())
{this.gear_menu.hide();return;}
if(!this.gear_menu)
{this.gear_menu=new SG.Menu({item_selected:{fn:this.gear_menu_item_selected,scope:this},items:[{html:'Configure layout...',value:'configure'}]});if(this.entity_type!='HumanUser'){this.gear_menu.items.push({html:"Close Form on Create",value:"close_on_create",checked:this.persistent_update_mode=="close_on_create",disabled:!(this.render_as_dialog&&this.allow_keep_form_open)});this.gear_menu.items.push({html:"Reset Form on Create",value:"reset_on_create",checked:this.persistent_update_mode=="reset_on_create",disabled:!(this.render_as_dialog&&this.allow_keep_form_open)});this.gear_menu.items.push({html:"Keep Form Values on Create",value:"keep_on_create",checked:this.persistent_update_mode=="keep_on_create",disabled:!(this.render_as_dialog&&this.allow_keep_form_open)});}
this.gear_menu.render();}
if(this.render_as_dialog)
this.gear_menu.position={dom_elem:gear_button,elem_anchor:'b',menu_anchor:'t'};else
this.gear_menu.position={dom_elem:gear_button,elem_anchor:'br',menu_anchor:'tr'};this.gear_menu.show();return;}
var revert_span=t.findParent('span.revert',this.header,true);if(revert_span)
{var controls=this.header.child('span.field_settings_controls');controls.remove();this.revert_settings();return;}
var save_span=t.findParent('span.save',this.header,true);if(save_span)
{var controls=this.header.child('span.field_settings_controls');controls.remove();this.revert_field_settings=[];for(var i=0;i<this.field_settings.length;i++)
this.revert_field_settings.push(this.field_settings[i]);this.update_entity_field_prefs(this.field_settings);return;}},revert_settings:function(){this.field_settings=[];for(var i=0;i<this.revert_field_settings.length;i++)
this.field_settings.push(this.revert_field_settings[i]);this.render_body();},gear_menu_item_selected:function(menu,item)
{switch(item.value)
{case'configure':this.configure(menu,item);break;case'close_on_create':case'keep_on_create':case'reset_on_create':this.update_mode=item.value;this.persistent_update_mode=item.value;this.render_footer();}
this.gear_menu.destroy();this.gear_menu=null;},configure:function(menu,item)
{var read_only_fields=this.configure_fields_read_only();var config={entity_type:this.entity_type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:this.field_settings,only_ordinary_fields:true,field_disabled_callback:{fn:this.configure_fields_disabled,scope:this},settings_applied_callback:{fn:this.on_fields_set,scope:this},read_only_fields:read_only_fields};if(this.entity_type=='Project')
config.read_only_fields=['layout_project'];var fpd=new SG.FieldProperties.Dialog(config);return;},configure_fields_read_only:function(){var read_only_fields=[];if(this.entity_type=='HumanUser')
read_only_fields=['email'];return read_only_fields;},configure_fields_disabled:function(field_schema)
{var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','system_task_type','list','timecode','date_time','footage'];if(this.entity_type!="Attachment")
supported_data_types.push("url");if(field_schema.name=='project'&&SG.schema.entity_types[this.entity_type].has_projects&&!this.hide_project_selector)
{return true;}
else if(field_schema.read_only)
return true;else if(supported_data_types.indexOf(field_schema.data_type)==-1)
return true;else if(field_schema.entity_type=='Status'&&['name','code','icon','bg_color'].indexOf(field_schema.name)>-1)
return true;else if(field_schema.name==='attachments'&&field_schema.data_type==='multi_entity')
return true;return false;},on_extra_controls_click:function(e)
{var t=Ext.get(e.getTarget());var attach_files=t.findParent('span.attach_files',this.body_scroll,true);if(attach_files)
{this.attach_button=attach_files;this.attach_button.hide();this.attachment_controls['attachments'].container.show();this.position_form();return;}
var more_fields=t.findParent('span.more_fields',4,true);if(more_fields)
{this.show_more_fields_menu(more_fields);}},toggle_attachment_control:function(container)
{this.attach_button.show();container.hide();this.position_form();},show_more_fields_menu:function(dom_elem)
{if(!this.more_fields_menu)
{this.more_fields_menu=new SG.Menu({item_selected:{fn:function(menu,menu_item){this.on_more_fields_set(menu,menu_item);this.render_body();},scope:this}});}
var settings_fields=[];var i;for(i=0;i<this.field_settings.length;i++)
settings_fields.push(this.field_settings[i].field);var more_fields_names=[];for(i=0;i<this.more_fields.length;i++)
more_fields_names.push(this.more_fields[i].field);this.more_fields_menu.items=[];var fields=SG.schema.get_categorized_fields(this.entity_type).ordinary;for(i=0;i<fields.length;i++)
{if(fields[i].grid_column==false)continue;if(this.entity_type=='HumanUser'&&fields[i].name=='email')continue;this.more_fields_menu.items.push({html:fields[i].display_name,field_name:fields[i].name,checked:more_fields_names.indexOf(fields[i].name)>-1||settings_fields.indexOf(fields[i].name)>-1,disabled:this.more_fields_disabled(fields[i],settings_fields)});}
this.more_fields_menu.render();this.more_fields_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_more_fields_set:function(menu,menu_item)
{if(SG.schema.can_edit_field('EntityFieldPref','settings'))
{var index=-1;for(var i=0;i<this.more_fields.length;i++)
{if(this.more_fields[i].field==menu_item.field_name)
{index=i;break;}}
if(index>-1)
{this.more_fields.splice(index,1);this.render_body();}
else
{index=-1;for(var i=0;i<this.field_settings.length;i++)
{if(this.field_settings[i].field==menu_item.field_name)
index=i;}
var new_field_settings=sg_deep_copy(this.field_settings);if(index>-1)
new_field_settings.splice(index,1);else
{new_field_settings.push({field:menu_item.field_name,show_label:true,field_label_override:"",mandatory_on_create:false});}
this.on_fields_set(new_field_settings);}
return;}
var index=-1;for(var i=0;i<this.more_fields.length;i++)
{if(this.more_fields[i].field==menu_item.field_name)
{index=i;break;}}
if(index>-1){this.more_fields.splice(index,1);}else{this.more_fields.push({field:menu_item.field_name,show_label:true});}},more_fields_disabled:function(field_schema,settings_fields)
{var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','system_task_type','list','timecode','date_time','entity_type','footage'];if(this.entity_type!="Attachment")
supported_data_types.push("url");if(field_schema.name=='project'&&SG.schema.entity_types[this.entity_type].has_projects&&!this.hide_project_selector)
{return true;}
else if(field_schema.read_only)
return true;else if(supported_data_types.indexOf(field_schema.data_type)==-1)
return true;else if(!SG.schema.can_edit_field('EntityFieldPref','settings')&&settings_fields.indexOf(field_schema.name)!=-1)
return true;else if(field_schema.name==='attachments'&&field_schema.data_type==='multi_entity')
return true;return this.blocked_in_this_context(field_schema.name);},validate_and_create:function()
{if(this.allow_keep_form_open)
{this.option_keydown=false;this.shift_keydown=false;this.set_keydown_mode();}
var empty=this.body.child('div.empty');if(empty)
{alert('Can not create '+SG.schema.entity_types[this.entity_type]['display_name']+' without any fields.');return;}
if(this.password_validator&&SG.globals.preferences.enforce_strong_passwords){var password_issue=this.password_validator.password_issue_message();if(password_issue){alert(password_issue);this.creating_now=false;return;}}
this.create_new_entity_if_ready();},on_footer_click:function(e)
{var t=Ext.get(e.getTarget());var create_button=t.findParent('input[name="create"]',this.footer,true);if(!create_button){create_button=t.findParent('input[name="create_another"]',this.footer,true);if(create_button)
this.update_mode='reset_on_create';}
if(create_button&&!this.creating_now)
{this.creating_now=true;this.transient_update_mode=this.update_mode;var me=this;setTimeout(function(){me.validate_and_create();},0);return;}
var cancel=t.findParent('span.cancel',this.footer,true);if(cancel)
{if(this.data_set.count()>1)
{this.fireEvent("entity_created",this.data_set.records);this.destroy();return;}
else
{this.fireEvent("form_canceled",e);this.destroy();return;}}},on_escape_key_pressed:function(evt)
{if(!this.ignore_unsaved_data){if(!this.cell_manager.active_editor&&SG.Page.unsaved_data.confirm_proceed())
{this.fireEvent("form_canceled",evt);this.destroy();return;}}else if(!this.cell_manager.active_editor){this.fireEvent("form_canceled",evt);this.destroy();return;}},destroy_component:function()
{if(!this.ignore_unsaved_data)
SG.Page.unsaved_data.remove(this);Ext.EventManager.removeResizeListener(this.position_form,this);this.container.remove();if(this.render_as_dialog)
this.mask.remove();this.revert_field_settings=[];this.field_settings=[];this.more_fields=[];if(this.gear_menu)
this.gear_menu.destroy();if(this.shadow)
this.shadow.el.remove();},on_fields_set:function(field_settings)
{var i;var field_check=[];for(i=0;i<field_settings.length;i++){if(this.entity_type=='HumanUser'&&field_settings[i].field=='email')
field_settings[i].mandatory_on_create=true;field_check.push(field_settings[i].field);}
var new_more_fields=[];for(i=0;i<this.more_fields.length;i++)
{if(field_check.indexOf(this.more_fields[i].field)==-1)
new_more_fields.push(this.more_fields[i]);}
this.more_fields=new_more_fields;var revert_save_controls=this.header.child('span.field_settings_controls');if(this.render_as_dialog&&!revert_save_controls)
{var revert_save_div=this.header.child('div.revert_save_div');Ext.DomHelper.insertFirst(revert_save_div,this.templates.revert_save_controls.apply());}
else if(!revert_save_controls)
Ext.DomHelper.insertFirst(this.header,this.templates.revert_save_controls.apply());this.field_settings=field_settings;this.render_body();},update_entity_field_prefs:function(field_settings)
{var new_entity_fields=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];if(new_entity_fields)
{var update_config={request_type:"update",type:"EntityFieldPref",id:new_entity_fields.id,column:'settings',value:Ext.encode(field_settings)};var update_request=new SG.CrudRequest(update_config,null);update_request.on("completed",function(){new_entity_fields.settings=field_settings;},this);update_request.send();}
else
{var create_config={request_type:'create',type:'EntityFieldPref',columns:['entity_type','settings'],field_values:[{column:'entity_type',value:this.entity_type},{column:'pref_type',value:this.entity_field_pref},{column:'settings',value:Ext.encode(field_settings)}]};var request=new SG.CrudRequest(create_config,null);request.on("completed",function(responses){var response=responses[0];if(response.status=="successful")
{SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type]={};var field_prefs=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];field_prefs['id']=response.row[0];field_prefs['settings']=field_settings;}},this);request.send();}},position_form:function(first_time)
{if(!this.render_as_dialog)
return;var max_for_window=this.mask.getHeight()-100;var max_container=this.max_height_with_no_scroll();var height=max_container<max_for_window?max_container:max_for_window;this.container.setHeight(height);if(this.last_y==undefined)
{this.container.setXY(this.container.getCenterXY());this.last_y=this.container.getTop();}
else
{var dbody_height=this.dbody.getHeight();var container_top=this.container.getTop();if(container_top+height>dbody_height)
{var pos=this.container.getCenterXY();this.container.setY(pos[1]);}}
this.shadow.show(this.container);},max_height_with_no_scroll:function()
{var sum=this.header.getHeight()+this.footer.getHeight()+
this.more_fields_div.getHeight()+this.extra_controls.getHeight()+20;var child=this.body_scroll.dom.firstChild;while(child){if(child.nodeType!==1)
continue;sum+=Ext.get(child).getHeight();child=child.nextSibling;}
if(this.password_container)
sum+=this.password_container.getHeight();return sum;},on_body_scroll:function()
{if(this.render_as_dialog)
this.cell_manager.apply_all_edits();},make_upload_fn_callback:function(ac,fv)
{return function(){ac.component.submit(fv);}},});SG.NewVersionDialog=function(config){SG.NewVersionDialog.superclass.constructor.call(this,config);};SG.NewVersionDialog.is_supported=function(){if(SG.globals.preferences.show_default_entity_creation_form_for_versions)
return false;var file_api_exists=window.FormData!==undefined;if(!file_api_exists)return false;var uploaded_movie_field_exists=SG.schema.entity_fields.Version.sg_uploaded_movie!==undefined;if(!uploaded_movie_field_exists)return false;return SG.schema.can_edit_field('Version','sg_uploaded_movie');};Ext.extend(SG.NewVersionDialog,SG.NewEntityDialog,{templates:{drop_area:'<div class="field" field="sg_uploaded_movie">'+'<table class="field_edit">'+'<tr>'+'<td class="field_label">{field_label}:</div>'+'<td class="field_value">'+'<div class="drop_area">'+'<div class="front card">'+'<div class="drop_area_body">'+'<div class="large_paperclip"></div>'+'<div>'+'<span class="drag_n_drop_main">Drag and drop files here</span><br/>'+'<span class="drag_n_drop_sub">or click to browse</span><br/>'+'<input type="file" name="files[]" multiple/>'+'</div>'+'</div>'+'<div class="upper_right">'+'<div class="manage_files">Manage files</div>'+'<div class="toggle_flip"></div>'+'</div>'+'</div>'+'<div class="back card">'+'<div class="file_table">'+'<div class="header">'+'<div class="columns">'+'<div class="column index"></div>'+'<div class="column icon"></div>'+'<div class="column file">File</div>'+'<div class="column size">Size</div>'+'<div class="column delete"></div>'+'</div>'+'</div>'+'<div class="rows">'+'<div class="files"></div>'+'</div>'+'</div>'+'<div class="upper_right displayed">'+'<div class="toggle_flip"><div class="icon_x_no_shadow"></div></div>'+'</div>'+'</div>'+'</div>'+'</td'+'</tr>'+'</table>'+'</div>',file_entry:'<div class="file_entry" index="{index}">'+'<div class="column index">{index_plus_one}</div>'+'<div class="column icon"><div class="{icon_class}"></div></div>'+'<div class="column file" sg_tip="{file_name}">{file_name}</div>'+'<div class="column size" sg_tip="{file_size}">{file_size}</div>'+'<div class="column trash delete"></div>'+'</div>'},init_component:function(){this.files=[];this.skip_field_render_callback={fn:this.should_skip_field,scope:this};SG.NewVersionDialog.superclass.init_component.call(this);},render_sg_uploaded_movie_field:function(){var schema_field=SG.schema.get_field('Version','sg_uploaded_movie');this.container.addClass('sg_new_version_form');var html=this.templates.drop_area.apply({field_label:schema_field.display_name});this.uploaded_movie_div=Ext.DomHelper.insertFirst(this.body_scroll,html,true);this.drop_area_div=this.uploaded_movie_div.child('div.drop_area');this.file_input=this.drop_area_div.child('input[type=file]');this.files_div=this.uploaded_movie_div.child('div.files');this.uploaded_movie_div.on('click',this.on_click,this);this.file_input.on('change',this.on_change,this);this.drop_area_div.on('dragenter',this.on_dragenter,this);this.drop_area_div.on('dragover',this.on_dragover,this);this.drop_area_div.on('dragleave',this.on_dragleave,this);this.drop_area_div.on('drop',this.on_drop,this);},render_files:function(files){var html='';var i,cfg,file_size,index;for(i=0;i<files.length;i++){index=this.files.indexOf(files[i]);cfg={index:index,index_plus_one:index+1,file_name:files[i].name};if(files[i].type){if(/^image/.test(files[i].type))
cfg.icon_class='filetype_icon_image';if(/^video/.test(files[i].type))
cfg.icon_class='filetype_icon_movie';else if(files[i].type==='application/pdf')
cfg.icon_class='filetype_icon_pdf';}
if(!cfg.icon_class)
cfg.icon_class='filetype_icon_misc';if(files[i].size>-1)
cfg.file_size=SG.Renderers.file_size.render(files[i].size);else
cfg.file_size='-';html+=this.templates.file_entry.apply(cfg);}
Ext.DomHelper.append(this.files_div,html);},get_dialog_title:function(){return'Create '+SG.schema.entity_types.Version.display_name.pluralize(2);},get_create_button_text:function(){var create_button_part_2='';switch(this.update_mode){case'close_on_create':create_button_part_2='';break;case'keep_on_create':create_button_part_2=' and Keep Form Values';break;case'reset_on_create':create_button_part_2=' and Reset Form';break;default:break;}
var num_versions=this.files.length||1;var et_plural=SG.schema.entity_types.Version.display_name.pluralize(num_versions);var create_button_part_1;if(num_versions<2)
create_button_part_1='Create '+et_plural;else
create_button_part_1='Create '+num_versions+' '+et_plural;return create_button_part_1+create_button_part_2;},get_version_name_for_file_name:function(file_name){return file_name.replace(/\.[a-zA-Z0-9]{1,4}$/,'');},init_fields:function(){SG.NewVersionDialog.superclass.init_fields.call(this);var sg_uploaded_movie_found=false;var i;for(i=0;i<this.field_settings.length;i++)
if(this.field_settings[i].field==='sg_uploaded_movie'){sg_uploaded_movie_found=true;break;}
if(!sg_uploaded_movie_found)
this.field_settings.push({field:'sg_uploaded_movie',show_label:true,field_label_override:'',mandatory_on_create:false});this.apply_field_prefs();this.move_fields_to_front();},apply_field_prefs:function(){var i,field_hash;for(i=0;i<this.field_settings.length;i++)
if(this.field_settings[i].field==='sg_uploaded_movie'){field_hash=this.field_settings[i];break;}
if(!field_hash)return;var field_label_div=this.uploaded_movie_div.child('td.field_label');if(field_hash.mandatory_on_create)
field_label_div.addClass('mandatory');else
field_label_div.removeClass('mandatory');if(field_hash.show_label){if(field_hash.field_label_override)
field_label=field_hash.field_label_override;else
field_label=SG.schema.get_field('Version','sg_uploaded_movie').display_name;field_label_div.update(field_label+':');}else{field_label_div.update('');}},should_skip_field:function(field_name){return field_name==='sg_uploaded_movie';},blocked_in_this_context:function(field){if(field==='code'&&this.files.length>1)
return true;return SG.NewVersionDialog.superclass.blocked_in_this_context.call(this,field);},configure_fields_read_only:function(){var read_only=SG.NewVersionDialog.superclass.configure_fields_read_only.call(this);if(read_only.indexOf('sg_uploaded_movie')<0)
read_only.push('sg_uploaded_movie');return read_only;},field_is_missing:function(field_hash,schema_field){var missing=SG.NewVersionDialog.superclass.field_is_missing.call(this,field_hash,schema_field);if(missing&&field_hash.field==='sg_uploaded_movie')
return this.files.length===0;return missing;},save_values_for_reuse:function(){SG.NewVersionDialog.superclass.save_values_for_reuse.call(this);if(this.saved_values.sg_uploaded_movie)
delete this.saved_values.sg_uploaded_movie;},more_fields_disabled:function(field_schema,settings_fields){if(field_schema.name==='sg_uploaded_movie')
return true;return SG.NewVersionDialog.superclass.more_fields_disabled.call(this,field_schema,settings_fields);},revert_settings:function(){SG.NewVersionDialog.superclass.revert_settings.call(this);this.apply_field_prefs();},move_fields_to_front:function(){var sg_uploaded_movie_index=-1;var description_index=-1;var i;for(i=0;i<this.field_settings.length;i++)
if(this.field_settings[i].field==='description')
description_index=i;else if(this.field_settings[i].field==='sg_uploaded_movie')
sg_uploaded_movie_index=i;if(description_index>-1){var description_hash=this.field_settings[description_index];this.field_settings.splice(description_index,1);this.field_settings=[description_hash].concat(this.field_settings);}
if(sg_uploaded_movie_index>-1){var sg_uploaded_movie_hash=this.field_settings[sg_uploaded_movie_index];this.field_settings.splice(sg_uploaded_movie_index,1);this.field_settings=[sg_uploaded_movie_hash].concat(this.field_settings);}},add_files:function(file_list){var files=[];var i;for(i=0;i<file_list.length;i++)
files.push(file_list[i]);this.files=this.files.concat(files);this.render_files(files);this.on_files_change();},remove_file:function(index){var file_divs=this.files_div.query('div.file_entry');var i,idx;for(i=0;i<file_divs.length;i++){idx=Number(file_divs[i].getAttribute('index'));if(idx<index)continue;if(idx===index){Ext.get(file_divs[i]).remove();continue;}
file_divs[i].setAttribute('index',idx-1);index_div=Ext.fly(file_divs[i]).child('div.index');index_div.update(idx);}
this.files.splice(index,1);this.on_files_change();},create_new_entity:function(){var create_button=this.footer.child('input[name="create"]');create_button.dom.setAttribute('disabled',true);this.pi=new SG.ProgressIndicator();this.pi.show();this.save_values_for_reuse();var has_xcode_status=SG.schema.entity_fields.Version.sg_uploaded_movie_transcoding_status;if(this.files.length<2){this.record.commit(this.hide_creation_banner);if(this.files.length===1&&has_xcode_status)
this.record.set('sg_uploaded_movie_transcoding_status',0);return;}
var i,record,version_name;for(i=0;i<this.files.length;i++){var version_name=this.get_version_name_for_file_name(this.files[i].name);if(i===0){this.record.set('code',version_name);if(has_xcode_status)
this.record.set('sg_uploaded_movie_transcoding_status',0);continue;}
record=this.data_set.copy_record(this.record);record.set('code',version_name);}
this.data_set.commit();},create_upload_queue:function(){var queue=SG.NewVersionDialog.superclass.create_upload_queue.call(this);if(!this.files.length)return queue;var me=this;var make_upload_fn=function(form){return function(){var upload_progress_id=Math.floor(Math.random()*1000000);var job={job_id:upload_progress_id,job_type:'file_upload'};me.upload_pi=new SG.ProgressIndicator(null,'det','Uploading Files...');me.upload_pi.show();me.upload_pi.start_updates_for_job(job);var req=new XMLHttpRequest();req.onreadystatechange=function(event){if(req.readyState===4)
me.on_movie_submit_done(Ext.decode(req.responseText));};req.open('POST','/crud/requests?X-Progress-ID='+upload_progress_id,true);req.send(form);};};var reqs=[];var i,rec,req,file,values,links;for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);values=[{column:'attachment_links',value:[{type:rec.get_type(),id:rec.get_id()}]}];if(rec.get('project'))
values.push({column:'project',value:rec.get('project')});req={request_type:'create',type:'Attachment',columns:['this_file'],field_values:values,upload_value_form_parameter:'upload',entity_data_field_parameter:'uploaded_data',upload_value_form_index:i};reqs.push(req);}
var form=new FormData();form.append('requests',Ext.encode(reqs));for(i=0;i<this.files.length;i++)
form.append('upload[]',this.files[i]);queue.push(make_upload_fn(form));return queue;},setup_record:function(){var records_to_remove=[];var i;for(i=0;i<this.data_set.count();i++){if(this.data_set.get_record(i)===this.record)continue;records_to_remove.push(this.data_set.get_record(i));}
if(records_to_remove.length)
this.data_set.remove(records_to_remove);this.files=[];if(this.files_div){this.files_div.update('')
this.on_files_change();}
SG.NewVersionDialog.superclass.setup_record.call(this);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.delete',this.files_div));if(elem){var parent=Ext.get(elem.findParent('div.file_entry',this.files_div));if(parent){var i=Number(parent.dom.getAttribute('index'));this.remove_file(i);}
return;}
elem=target.findParent('div.toggle_flip',this.drop_area_div);if(!elem)
elem=target.findParent('div.upper_right',this.drop_area_div);if(elem){this.drop_area_div.toggleClass('flipped');return;}
elem=Ext.get(target.findParent('div.drop_area',this.uploaded_movie_div))
if(elem){var input=target.findParent('input[type=file]',this.uploaded_movie_div);if(input)
elem=null;}
if(elem&&!elem.hasClass('flipped')){this.file_input.dom.click();return;}},on_first_render_as_dialog:function(){SG.NewVersionDialog.superclass.on_first_render_as_dialog.call(this);this.render_sg_uploaded_movie_field();},on_first_render_in_container:function(){SG.NewVersionDialog.superclass.on_first_render_in_container.call(this);this.render_sg_uploaded_movie_field();},on_fields_set:function(field_settings){SG.NewVersionDialog.superclass.on_fields_set.call(this,field_settings);this.move_fields_to_front();this.apply_field_prefs();},on_more_fields_set:function(menu,menu_item){SG.NewVersionDialog.superclass.on_more_fields_set.call(this,menu,menu_item);this.move_fields_to_front();},on_files_change:function(){var name_div=this.body.child('div.field[field=code]');if(name_div){if(this.files.length>1)
name_div.setDisplayed(false);else
name_div.setDisplayed(true);}
if(this.files.length===1&&!this.record.get('code')){var version_name=this.get_version_name_for_file_name(this.files[0].name);this.record.set('code',version_name);}else if(this.record.get('code')){this.record.set('code','');}
var upper_right_div=this.drop_area_div.child('div.upper_right');var file_count_div=upper_right_div.child('div.toggle_flip');if(this.files.length<1){file_count_div.update('');upper_right_div.removeClass('displayed');}else{file_count_div.update(this.files.length);upper_right_div.addClass('displayed');}
var flipped=this.drop_area_div.hasClass('flipped');if(!flipped&&this.files.length>0){file_count_div.addClass('bounce');var remove_anim_fn=function(e){if(e.browserEvent.animationName==='bounce')
file_count_div.removeClass('bounce');};file_count_div.on('webkitAnimationEnd',remove_anim_fn,this);file_count_div.on('animationend',remove_anim_fn,this);}
this.render_footer();},on_movie_submit_done:function(responses){if(SG.Repo.throw_crud_error(responses)){if(this.upload_pi)
this.upload_pi.hide();this.reset_after_error();return;}
var attachments;try{attachments=[];for(var i=0;i<responses.length;i++)
attachments.push(responses[i].row[1]);}catch(e){attachments=null;}
if(this.upload_pi)
this.upload_pi.hide();var has_xcode_status=SG.schema.entity_fields.Version.sg_uploaded_movie_transcoding_status;var i,rec;for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);rec.set('sg_uploaded_movie',attachments[i]);if(has_xcode_status)
rec.set('sg_uploaded_movie_transcoding_status',1);}
this.data_set.commit(true);this.hide_progress_indicator();if(this.upload_queue.length==0){this.entity_created();}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},on_change:function(e){e.stopPropagation();e.preventDefault();this.add_files(this.file_input.dom.files);this.file_input.dom.files=[];},on_dragenter:function(e){e.stopPropagation();e.preventDefault();this.drop_area_div.addClass('dragover');},on_dragover:function(e){e.stopPropagation();e.preventDefault();this.drop_area_div.addClass('dragover');},on_dragleave:function(e){e.stopPropagation();e.preventDefault();this.drop_area_div.removeClass('dragover');},on_drop:function(e){e.stopPropagation();e.preventDefault();this.add_files(e.browserEvent.dataTransfer.files);this.drop_area_div.removeClass('dragover');}});SG.NewNoteDialog=function(config)
{Ext.apply(this,config);this.projects=sg_deep_copy(config.all_projects);this.events={"entity_created":true,"form_canceled":true};SG.NewNoteDialog.superclass.constructor.call(this,config);};Ext.extend(SG.NewNoteDialog,SG.Component,{templates:{main:'{header}<div class="body_scroll">'+'<div class="project"></div><div class="links"></div>'+'<div class="tasks sgc_tasks_mini_grid_selector"></div>'+'<div class="create_multiple_choice_div"></div>'+'<div class="more_fields"></div><div class="extra_controls"></div>'+'<div class="note_body_div"></div></div><div class="new_note_footer"></div>',note_body_first_layout:'{header}<div class="body_scroll">'+'<div class="note_body_div"></div>'+'<div class="extra_controls"></div>'+'<div class="project"></div><div class="links"></div>'+'<div class="tasks sgc_tasks_mini_grid_selector"></div>'+'<div class="create_multiple_choice_div"></div>'+'<div class="more_fields"></div>'+'<div class="new_note_footer"></div>',notes_app_layout:'{header}<div class="body_scroll">'+'<div class="note_body_div"></div>'+'<div class="project"></div><div class="links"></div>'+'<div class="tasks sgc_tasks_mini_grid_selector"></div>'+'<div class="create_multiple_choice_div"></div>'+'<div class="more_fields"></div>'+'<div class="extra_controls"></div>'+'<div class="new_note_footer"></div>',header:'<div class="dialog_drag_div {extra}">{title_text}{dot}{gear_menu}</div>',gear_menu:'<img class="gear_menu" src="/images/gear_menu_nobg.png">',dot:'<div class="icon_fin {visible}"></div>',footer:'<div class="controls">'+'<span class="footer_warning">{warning_text}</span>'+'{cancel_button}'+'<input name="create" type="button" {disabled} value="{create_button_text}"></div>',cancel_button:'<span class="cancel">Cancel</span>',field:'<div class="field" field="{field}"><table class="field_edit"><tr>'+'<td class="field_label {mandatory}" sg_tip="{sg_tip}">'+'<div class="field_label_wrapper"><div class="field_label_menu {menu}" field="{field}">'+'<div class="end_graphic arrow_open_dark">'+'</div>{field_label}:</div></div>'+'</td><td class="field_value {cell_classes}" {cell_attributes}>{cell_content}'+'</td></tr></table></div>',tasks_field:'<div class="{cell_classes}" {cell_attributes}>{cell_content}</div>',note_body:'<div class="note_body {cell_classes}" {cell_attributes} field="{field}">{cell_content}</div>',quick_field:'<span class="quick_field" field="{field}">{field_name}</span>',paperclip_icon:'<img class="paperclip" src="/images/paperclip.png">',attachment_toggle:'<span class="attach_files">{paperclip_icon}'+'<span class="attach_ext">Attach</span></span>',attachment_files:'<div class="attach_me {extra_cls}" field="{field}"></div>',attachment_field:'<div class="field" field="{field}"><table class="field_edit"><tr>'+'<td class="field_label " sg_tip="{sg_tip}"><div>{field_label}:</div></td>'+'<td class="field_value">{attachment_files}'+'</td></tr></table></div>',create_multiple_notice_choices:'<div class="create_multiple_notice" ><form><div>'+'<input class="multi_choice" type="radio" name="choice" value="one" '+'{single_checked} />Create '+'<span style="font-weight:bold;">1</span> Note '+'linked to All<br></div>'+'<input class="multi_choice" type="radio" name="choice" value="many" {multi_checked} />Create '+'<span style="font-weight:bold;">{count}</span> duplicate '+'Notes, linked to each</form></div>',},init_component:function()
{if(!this.update_mode){this.update_mode='close_on_create';this.persistent_update_mode='close_on_create';}else{this.persistent_update_mode=this.update_mode;}
this.render_as_dialog=this.container?false:true;this.attachment_controls={};var dh=Ext.DomHelper;if(this.render_as_dialog)
{this.dbody=Ext.get(document.body);this.mask=dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=dh.append(this.mask,{tag:'div',cls:'sg_dialog sgc_new_note_dialog'},true);}
else
this.container.addClass('sgc_new_note_dialog');this.pref_key='new_entity';if(!this.is_large_configuration_of_fields())this.pref_key='new_entity_short';if(this.visible_fields)
this.ignore_field_prefs=true;var dot=this.ignore_field_prefs?'':this.templates.dot.apply({visible:this.are_prefs_dirty()?'visible':''});var header=this.templates.header.apply({extra:this.render_as_dialog?'dialog':'',title_text:this.render_as_dialog?'New Note':'',gear_menu:this.ignore_field_prefs?'':this.templates.gear_menu.apply(),dot:dot,});var html;if(this.notes_app_layout)
html=this.templates.notes_app_layout.apply({header:header});else if(this.render_note_body_first)
html=this.templates.note_body_first_layout.apply({header:header});else
html=this.templates.main.apply({header:header});this.container.update(html);this.header=this.container.child('div.dialog_drag_div');this.body_scroll=this.container.child('div.body_scroll');this.footer=this.container.child('div.new_note_footer');this.shadow=new Ext.Shadow({offset:5,mode:'frame'});if(this.wait_for_source_record)
{this.position_form();this.pi=new SG.ProgressIndicator(this.container);this.pi.show();}
else
this.on_first_render();},source_record_ready:function(source_record)
{this.pi.hide();this.source_record=source_record;this.on_first_render();},on_first_render:function()
{var dh=Ext.DomHelper;this.setup_data_set();if(!this.are_all_entities_from_a_single_project())
{return;}
this.setup_visible_fields();this.setup_cell_manager();this.render_fields();this.render_extra_controls();this.render_footer();this.render_create_multiple_choices();this.tasks_selector_div=this.container.child('div.sgc_tasks_mini_grid_selector');this.note_body_div=this.container.child('div.note_body');this.body_scroll=this.container.child('div.body_scroll');this.setup_events();this.setup_dialog_drag();this.position_form();if(!this.skip_edit_on_load)
this.edit_on_load();if(this.render_as_dialog)
{this.last_container_scroll=this.body_scroll.dom.scrollHeight;var me=this;this.scroll_interval=window.setInterval(function(){me.check_for_change_in_scroll_height();},100);}
if(this.require_project)
dh.append(this.container,{tag:'div',cls:'project_blocker_overlay'});},rerender:function(container){if(!container||this.render_as_dialog)
{this.dbody=Ext.get(document.body);this.mask=dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=dh.append(this.mask,{tag:'div',cls:'sg_dialog sgc_new_note_dialog'},true);}
else
{this.container=container;this.container.addClass('sgc_new_note_dialog');}
this.setup_cell_manager();this.setup_events();this.reset_dialog(true);},are_all_entities_from_a_single_project:function()
{if(!this.render_as_dialog)return true;var project_ids=[];var tasks=this.record.get('tasks');var note_links=this.record.get('note_links');var all_entities=[];if(tasks)all_entities=all_entities.concat(tasks);if(note_links)all_entities=all_entities.concat(note_links);var entity_has_no_project=false;for(var i=0;i<all_entities.length;i++)
{var entity=all_entities[i];var has_projects=SG.schema.entity_types[entity.type].has_projects;if(has_projects&&entity.project_id==undefined)
{entity_has_no_project=true;break;}
else if(has_projects&&project_ids.indexOf(entity.project_id)==-1)
project_ids.push(entity.project_id);}
if(entity_has_no_project||project_ids.length>1)
{this.mask.setVisible(false);this.container.setVisible(false);var cd=new SG.MessageDialog({sg_dialog_header_text:'(!) Links from Multiple Projects',html_msg:'Some of the selected link entities have different Projects.  '+'<div style="margin-top: 8px; margin-bottom: 8px;">Please select only '+'Link entities from a single Project when linking to Notes. '+'You can see the Project each entity is linked to by looking at the "Project" field.</div>'});var me=this;this.add_event(cd,'dialog_submitted',function(){me.destroy();});return false;}
if(project_ids.length==1)
{var all_projects=SG.schema.projects;for(var i=0;i<all_projects.length;i++)
{var project=all_projects[i];if(project.id==project_ids[0])
{this.single_project=project;this.set_project(project);}}}
return true;},check_for_change_in_scroll_height:function()
{if(this.last_container_scroll!=this.body_scroll.dom.scrollHeight&&this.body_scroll.dom.clientHeight<this.body_scroll.dom.scrollHeight)
{this.last_container_scroll=this.body_scroll.dom.scrollHeight;this.position_form();}},destroy_component:function()
{if(this.scroll_interval)
window.clearInterval(this.scroll_interval);},edit_on_load:function()
{var fields=this.get_tabable_fields();var first_field_value=null;if(fields.length>0)
first_field_value=this.record.get(fields[0]);if(!first_field_value&&this.render_as_dialog)
this.edit_field(fields[0]);else
this.edit_field('content');},render_fields:function()
{for(var i=0;i<this.visible_fields.length;i++)
{var div;var field=this.visible_fields[i];if(field=='note_links')
div=this.container.child('div.links');else if(field=='tasks')
div=this.container.child('div.tasks');else if(field=='content')
div=this.container.child('div.note_body_div');else if(field=='project')
div=this.container.child('div.project');else
div=this.container.child('div.more_fields');this.render_field(field,div);}},render_field:function(field,container)
{var schema_field=SG.schema.get_field('Note',field);if(schema_field.data_type=='url'||schema_field.name=='attachments')
{this.render_attachment_field(schema_field,container);return;}
var pref=this.find_entity_field_pref(this.entity_field_prefs,field);var cell=this.cell_manager.get_cell(field,this.get_cell_config(schema_field));if(this.autocommit)
cell.autocommit=true;var config=cell.render(this.record);config.field_label=schema_field.display_name;config.sg_tip=schema_field.display_name;config.field=field;config.mandatory=field=='project'?'mandatory':'';if(field=='project'||(pref&&pref.mandatory_on_create))
config.mandatory='mandatory';else
config.mandatory='';if(container.hasClass('more_fields'))
{if(pref&&pref.mandatory_on_create&&SG.schema.can_edit_field('EntityFieldPref','settings'))
config.menu='enabled';else if(pref&&pref.mandatory_on_create&&!SG.schema.can_edit_field('EntityFieldPref','settings'))
config.menu='';else
config.menu='enabled';if(this.ignore_field_prefs)
config.menu='';}
else
config.menu='';var html;if(field=='content')
html=this.templates.note_body.apply(config);else if(field=='tasks')
html=this.templates.tasks_field.apply(config);else
html=this.templates.field.apply(config);Ext.DomHelper.append(container,html);},render_attachment_field:function(schema_field,container)
{var attachment_cfg={};var cfg={field:schema_field.name,field_label:schema_field.display_name,sg_tip:'TODO',};if(schema_field.name=='attachments')
{cfg.attachment_files=this.templates.attachment_files.apply({field:'attachments',extra_cls:'threaded'});attachment_cfg.visible=false;}
else
{cfg.attachments_files=this.templates.attachment_files.apply({field:schema_field.name});attachment_cfg.url_field=true;}
var html=this.templates.attachment_field.apply(cfg);var div=Ext.DomHelper.append(container,html,true);if(schema_field.name=='attachments')
attachment_cfg.container=div;else
{var attachment_div=div.child('td.field_value');attachment_cfg.container=attachment_div;}
this.attachment_controls[schema_field.name]=attachment_cfg;this.render_attachment_control(schema_field.name);},render_attachment_control:function(field)
{var ac=this.attachment_controls[field];if(ac.visible===false)
ac.container.setDisplayed(false);var cfg={container:ac.container,done_callback:{fn:this.upload_done,scope:this},error_callback:{fn:this.reset_after_error,scope:this}};if(ac.url_field)
cfg.url_field=field;if(field=='attachments')
cfg.close_callback={fn:this.toggle_attachment_control,scope:this};ac.component=this.new_component(SG.AttachmentControl,cfg);ac.component.render();},toggle_attachment_control:function(container)
{container.setDisplayed(false);this.render_extra_controls();this.shrink_dialog();},upload_done:function(attachments,url_field)
{if(this.upload_pi)this.upload_pi.hide();if(url_field&&attachments.length==1){var rec;for(var i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);rec.set(url_field,attachments[0]);}
this.data_set.commit(true);}
this.hide_progress_indicator();if(this.entity_type=='Attachment')
this.handle_attachment_undo(attachments);if(this.upload_queue.length==0){this.entity_created();}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},get_cell_config:function(schema_field){return{type:this.get_cell_type(schema_field),double_click_for_edit:false};},get_cell_type:function(schema_field){if(schema_field.name=='content')
return SG.LargeTextAreaCell;else if(schema_field.name=="tasks")
return SG.TasksMiniGridSelector;else if(typeof(schema_field.editor)==="string")
return SG.FakeInputCell;else if(schema_field.data_type=='url')
return SG.UrlCell;else
return SG.FakeInputCell;},render_extra_controls:function()
{var extra_control_div=this.container.child('div.extra_controls');var h='';for(var i=0;i<this.entity_field_prefs.length;i++)
{var pref=this.entity_field_prefs[i];if(pref.type=='quick_add'&&this.visible_fields.indexOf(pref.field)==-1)
{var schema_field=SG.schema.get_field('Note',pref.field);h+=this.templates.quick_field.apply({field:pref.field,field_name:schema_field.display_name});}}
h+=this.templates.quick_field.apply({field:'_more_fields_',field_name:'More fields...'});if(!this.no_attachments)
{var attachment_div=this.container.child('div[field="attachments"]');if(attachment_div&&!attachment_div.isVisible()){h+=this.templates.attachment_toggle.apply({paperclip_icon:this.hide_paperclip_icon?'':this.templates.paperclip_icon.apply()});}}
extra_control_div.update(h);},position_form:function()
{if(!this.render_as_dialog)return;var max_for_window=this.mask.getHeight()-100;var max_container=this.max_height_with_no_scroll();if(max_container==0)
return;var height=max_container<max_for_window?max_container:max_for_window;this.container.setHeight(height);if(this.last_y==undefined)
{this.container.setXY(this.container.getCenterXY());this.last_y=this.container.getTop();}
else
{var dbody_height=this.dbody.getHeight();var container_top=this.container.getTop();if(container_top+height>dbody_height)
{var pos=this.container.getCenterXY();this.container.setY(pos[1]);}}
this.shadow.show(this.container);},max_height_with_no_scroll:function()
{var body_scroll=this.container.child('div.body_scroll');var ret=body_scroll.dom.scrollHeight+72;return ret;},shrink_dialog:function()
{if(!this.render_as_dialog)return;var divs=['div.project','div.links','div.sgc_tasks_mini_grid_selector','div.create_multiple_choice_div','div.more_fields','div.extra_controls','div.note_body_div'];var total=0;for(var i=0;i<divs.length;i++)
{var div=this.container.child(divs[i]);total+=div.getHeight();}
var body_scroll=this.container.child('div.body_scroll');var body_height=body_scroll.getHeight()-24;if(body_height>total)
{var current_height=this.container.getHeight();this.container.setHeight(current_height-(body_height-total));this.shadow.show(this.container);}},setup_events:function()
{Ext.EventManager.onWindowResize(this.position_form,this,true);this.add_event(this.container,'click',this.on_click);this.add_event(document,'keydown',this.on_keydown);this.add_event(document,'keyup',this.on_keyup);},setup_dialog_drag:function()
{if(!this.render_as_dialog)return;if(!this.shadow)
this.shadow=new Ext.Shadow({offset:5,mode:'frame'});if(this.dd)
this.dd.destroy();this.dd=new Ext.dd.DDProxy(this.container,"new_entity_dialog",{scroll:false});this.dd.setHandleElId(this.header);this.dd.new_entity_dialog=this;this.dd.startDrag=function(){var me=this;var blur_func=function(){if(me.new_entity_dialog.cell_manager.active_editor)
me.new_entity_dialog.cell_manager.active_editor.blur();};window.setTimeout(blur_func,0);this.constrainTo(this.new_entity_dialog.dbody);var drag_elem=this.getDragEl();Ext.fly(drag_elem).setStyle({border:'2px solid rgb(150,150,150)','z-index':'10001',});this.new_entity_dialog.shadow.hide();};this.dd.afterDrag=function(){this.new_entity_dialog.last_y=this.new_entity_dialog.container.getTop();this.new_entity_dialog.shadow.show(this.new_entity_dialog.container);};},destroy_component:function()
{this.container.remove();if(this.render_as_dialog)
{Ext.EventManager.removeResizeListener(this.position_form,this);if(this.mask)this.mask.remove();if(this.shadow&&this.shadow.el)this.shadow.el.remove();}},setup_data_set:function()
{if(this.edit_source_record_mode)
{this.data_set=this.source_record_data_set;this.record=this.source_record;return;}
if(!this.data_set)
this.data_set=this.new_data_set('Note',null,this.on_data_change);if(this.record)
this.data_set.remove([this.record]);this.record=this.data_set.new_record();this.fields_with_data=[];var fields=this.source_record.get_fields();for(var i=0;i<fields.length;i++)
{var field=fields[i];var schema_field=SG.schema.get_field('Note',field);if(schema_field&&!schema_field.read_only)
{this.record.set(field,this.source_record.get(field));this.fields_with_data.push(field);}}
if(SG.schema.entity_types[this.entity_type].has_projects)
{this.set_project(this.single_project?this.single_project:null);}
var subject=this.record.get('subject');if(!subject||(typeof subject==='string'&&subject.trim()==''))
{if(SG.globals.custom_for=="drd"||SG.globals.custom_for=='brownbag')
{this.record.set("subject","");}
else
{var parts=SG.globals.current_user.display_name.split(' ');this.record.set("subject",parts[0]+"'s Note");}}},project_changed:function()
{var fields=this.record.get_fields();for(var i=0;i<fields.length;i++)
{var field=fields[i];var schema_field=SG.schema.get_field('Note',field);if(schema_field&&!schema_field.read_only&&schema_field.name!='project'&&['entity','multi_entity'].indexOf(schema_field.data_type)!=-1&&schema_field.name!='addressings_cc')
{this.record.set(field,null);}}
if(this.visible_fields.indexOf('tasks')!=-1)
{var tasks_cell=this.get_tasks_cell();tasks_cell.set_entities(null);}},setup_visible_fields:function()
{if(this.visible_fields)
{this.entity_field_prefs=this.get_entity_prefs();return;}
var fields;if(this.is_large_configuration_of_fields())
{if(this.single_project)
fields=['note_links','tasks','attachments','content'];else
{this.require_project=true;this.last_project={type:'Project',id:null};fields=['project','note_links','tasks','attachments','content'];}}
else
{fields=['attachments','content'];}
this.visible_fields=[];var i;for(i=0;i<fields.length;i++){if(!this.excluded_fields||this.excluded_fields.indexOf(fields[i])===-1)
this.visible_fields.push(fields[i]);}
this.entity_field_prefs=this.get_entity_field_prefs();for(i=0;i<this.entity_field_prefs.length;i++)
{var pref=this.entity_field_prefs[i];if(pref.type=='more'&&!pref.hidden)
{if(!(this.require_project&&pref.field=='project'))
this.visible_fields.splice(-1,0,pref.field);}}},is_large_configuration_of_fields:function()
{var new_entity_widget_div=this.container.findParent('div.sgw_new_entity_widget',document.body);if(this.render_as_dialog||new_entity_widget_div)
return true;else
return false;},get_entity_field_prefs:function()
{var cookie_prefs=this.get_cookie_prefs();var entity_prefs=this.get_entity_prefs();var ret=[];for(var i=0;i<entity_prefs.length;i++)
{var entity_pref=entity_prefs[i];if(this.excluded_fields&&this.excluded_fields.indexOf(entity_pref.field)>-1)
continue;var cookie_pref=this.find_entity_field_pref(cookie_prefs,entity_pref.field);if(cookie_pref){ret.push(cookie_pref);}else{var existing_pref=this.find_entity_field_pref(ret,entity_pref.field);if(!existing_pref)
ret.push(entity_pref);}}
for(var i=0;i<cookie_prefs.length;i++)
{var cookie_pref=cookie_prefs[i];if(this.excluded_fields&&this.excluded_fields.indexOf(cookie_pref.field)>-1)
continue;var existing_pref=this.find_entity_field_pref(ret,cookie_pref.field);if(!existing_pref)
ret.push(cookie_pref);}
return ret;},find_entity_field_pref:function(prefs,field_name)
{for(var i=0;i<prefs.length;i++)
{var pref=prefs[i];if(pref.field==field_name)
return pref;}
return null;},get_cookie_prefs:function()
{var cookie=getCookie('note_'+this.pref_key);if(cookie)
{var cookie_settings=Ext.decode(cookie);var ret=[];for(var i=0;i<cookie_settings.length;i++)
{var field_hash=cookie_settings[i];var schema_field=SG.schema.get_field('Note',field_hash.field);if(schema_field)
ret.push(field_hash);}
return ret;}
else
return[];},get_entity_prefs:function()
{var prefs=SG.globals.entity_field_prefs[this.pref_key]['Note']['settings'];var ret=[];for(var i=0;i<prefs.length;i++)
{var field_hash=prefs[i];var schema_field=SG.schema.get_field('Note',field_hash.field);if(schema_field)
ret.push(field_hash);}
return ret;},setup_cell_manager:function()
{var cell_config={container:this.container,data_set:this.data_set,projects:this.projects,in_form:this.edit_source_record_mode?false:true,require_project:this.require_project,get_fields_callback:{fn:this.get_tabable_fields,scope:this},before_first_cell:{fn:this.on_before_first_cell,scope:this},after_last_cell:{fn:this.focus_create_button,scope:this},edit_applied_callback:{fn:this.on_after_cell_edit,scope:this},};if(this.render_as_dialog)
cell_config.edit_container=this.container;else
cell_config.edit_container=this.edit_container;this.cell_manager=this.new_component(SG.CellManager,cell_config);},get_tabable_fields:function()
{var fields=[];for(var i=0;i<this.visible_fields.length;i++)
{if(this.visible_fields[i]!='attachments')
fields.push(this.visible_fields[i]);}
return fields;},focus_create_button:function()
{var create_button=this.container.child('input[name="create"]');if(!create_button)return;setTimeout(function(){create_button.dom.focus();});},on_before_first_cell:function()
{this.focus_create_button();},on_data_change:function(changes)
{var change,i;var found_create=false;for(i=0;i<changes.length;i++){change=changes[i];if(change.state=='pending')
continue;if(change.type=="create")
{found_create=true;}
else if(change.type=="create_failed")
{this.reset_after_error();return;}
else if(change.type=="update"&&change.column=="project")
{if(!this.setting_project)
this.set_project(change.value);}}
if(found_create===false)
return;var af,ac,fv,rec,links,no_attach=true;this.upload_queue=[];for(var af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;ac=this.attachment_controls[af];if(ac.component.ready())
no_attach=false;else
continue;var rec,links=[],fv=[];for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);links.push({type:rec.get_type(),id:rec.get_id()});}
fv.push({column:"attachment_links",value:links});if(this.record.get("project"))
fv.push({column:"project",value:this.record.get("project")});this.upload_queue.push(this.make_upload_fn_callback(ac,fv));}
if(no_attach){this.hide_progress_indicator();this.entity_created();}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},reset_after_error:function()
{this.creating_now=false;this.hide_progress_indicator();},hide_progress_indicator:function()
{if(this.pi)
{this.pi.hide();this.pi=null;}},entity_created:function()
{switch(this.transient_update_mode)
{case'close_on_create':this.fireEvent("entity_created",this.data_set.records);this.destroy();return;case'keep_on_create':this.fireEvent("entity_created",this.data_set.records);this.hide_progress_indicator();this.creating_now=false;this.copy_record_for_reuse();this.reset_dialog(true);break;case'reset_on_create':this.fireEvent("entity_created",this.data_set.records);this.hide_progress_indicator();this.creating_now=false;this.reset_dialog();}},copy_record_for_reuse:function()
{this.data_set.remove([this.record]);this.record=this.data_set.new_record();for(var field_name in this.saved_values)
{if(!this.saved_values.hasOwnProperty(field_name))
continue;this.record.set(field_name,this.saved_values[field_name])}
if(this.saved_values['project'])
this.set_project(this.saved_values['project']);},reset_dialog:function(skip_data_set)
{var dot=this.ignore_field_prefs?'':this.templates.dot.apply({visible:this.are_prefs_dirty()?'visible':''});var header=this.templates.header.apply({extra:this.render_as_dialog?'dialog':'',title_text:this.render_as_dialog?'New Note':'',gear_menu:this.ignore_field_prefs?'':this.templates.gear_menu.apply(),dot:dot,});var html;if(this.render_note_body_first)
html=this.templates.note_body_first_layout.apply({header:header});else
html=this.templates.main.apply({header:header});this.container.update(html);this.footer=this.container.child('div.new_note_footer');this.cell_manager.empty_cell_cache();if(!skip_data_set)
{this.setup_data_set();}
this.render_fields();this.render_extra_controls();this.render_footer();this.header=this.container.child('div.dialog_drag_div');this.tasks_selector_div=this.container.child('div.sgc_tasks_mini_grid_selector');this.note_body_div=this.container.child('div.note_body');this.setup_dialog_drag();},on_click:function(e)
{var t=Ext.get(e.getTarget());var attach_files=t.findParent('span.attach_files',this.body_scroll,true);if(attach_files)
{this.attach_button=attach_files;this.attach_button.setDisplayed(false);this.attachment_controls['attachments'].container.setDisplayed(true);this.position_form();return;}
var quick_field=t.findParent('span.quick_field',this.container);if(quick_field)
{var field=quick_field.getAttribute('field');if(field=='_more_fields_')
{this.show_more_fields_menu(quick_field);return;}
else
{this.show_field(field);this.update_dirty_dot();}
return;}
var cancel=t.findParent('span.cancel',this.container);if(cancel)
{if(this.cell_manager.active_editor)
this.cell_manager.active_editor.selection_manager_mouse_down(e);if(this.data_set.count()>1)
{this.fireEvent("entity_created",this.data_set.records);this.destroy();return;}
else
{this.fireEvent("form_canceled",e);this.destroy();return;}}
var create_button=t.findParent('input[name="create"]',this.footer,true);if(create_button&&!this.creating_now&&this.check_for_mandatory_inputs())
{this.creating_now=true;this.transient_update_mode=this.update_mode;this.pi=new SG.ProgressIndicator();this.pi.show();var tasks_cell=this.get_tasks_cell();tasks_cell.get_selected_tasks({fn:this.on_get_selected_tasks,scope:this});}
var field_menu_div=t.findParent('div.field_label_menu.enabled',this.container,true);if(field_menu_div)
{this.display_field_option_menu(e,field_menu_div);return;}
var gear_menu_img=t.findParent('img.gear_menu',this.container,true);if(gear_menu_img)
{var blocker=this.container.child('div.project_blocker_overlay');if(blocker&&blocker.isDisplayed())
return;this.display_gear_menu(e,gear_menu_img);return;}},display_gear_menu:function(e,menu_div)
{this.gear_menu_elem=menu_div;if(e.type=='contextmenu')e.stopEvent();if(!this.gear_menu)
this.gear_menu=this.create_gear_menu();if(this.gear_menu.is_showing())
this.gear_menu.hide();else
{this.gear_menu.position={dom_elem:this.gear_menu_elem.dom,elem_anchor:'bl',menu_anchor:'tl'};this.gear_menu.show();}},create_gear_menu:function()
{var menu=new SG.Menu({before_show:{fn:this.on_before_show_gear_menu,scope:this},});menu.items=[];menu.render();return menu;},on_before_show_gear_menu:function(menu)
{var is_dirty=this.are_prefs_dirty();var items=[];if(SG.schema.can_edit_field('EntityFieldPref','settings'))
{items.push({html:'Save as default',item_selected:{fn:this.save_entity_field_prefs,scope:this},disabled:!is_dirty});items.push({line:true});}
items.push({html:'Reset to default',item_selected:{fn:this.reset_entity_field_prefs,scope:this},disabled:!is_dirty});menu.items=items;menu.render();},save_entity_field_prefs:function()
{var entity_prefs=SG.globals.entity_field_prefs[this.pref_key]['Note'];var cookie_prefs=this.get_cookie_prefs();var prefs_to_save=[];for(var i=0;i<this.entity_field_prefs.length;i++)
{var pref=this.entity_field_prefs[i];if(pref.hidden&&['addressings_cc','subject','sg_note_type'].indexOf(pref.field)!=-1)
{pref['type']='quick_add';delete pref['hidden'];prefs_to_save.push(pref);}else if(!pref.hidden&&pref.field!='project'){prefs_to_save.push(pref);}}
this.entity_field_prefs=prefs_to_save;var update_config={request_type:"update",type:"EntityFieldPref",id:entity_prefs.id,column:'settings',value:Ext.encode(this.entity_field_prefs)};var update_request=new SG.CrudRequest(update_config,null);update_request.on("completed",function(){setCookie('note_'+this.pref_key,Ext.encode([]),365);entity_prefs['settings']=this.entity_field_prefs;this.update_dirty_dot();},this);update_request.send();},reset_entity_field_prefs:function()
{var me=this;setTimeout(function(){var pref_type=me.is_large_configuration_of_fields()?'new_entity':'new_entity_short';setCookie('note_'+pref_type,Ext.encode([]),365);me.visible_fields=null;me.setup_visible_fields();me.reset_dialog();me.shrink_dialog();});},display_field_option_menu:function(e,menu_div)
{this.field_option_menu_div=menu_div;if(e.type=='contextmenu')e.stopEvent();if(!this.field_option_menu)
this.field_option_menu=this.create_field_option_menu();if(this.field_option_menu.is_showing())
this.field_option_menu.hide();else
{this.field_option_menu.position={dom_elem:this.field_option_menu_div.dom,elem_anchor:'bl',menu_anchor:'tl'};this.field_option_menu.show();}},create_field_option_menu:function()
{var menu=new SG.Menu({before_show:{fn:this.on_before_show_field_option_menu,scope:this},after_hide:{fn:this.on_hide_field_option_menu,scope:this},item_selected:{fn:this.on_field_option_menu,scope:this},});menu.items=[];menu.render();return menu;},on_before_show_field_option_menu:function(menu)
{this.field_option_menu_div.addClass('showing');var field=this.field_option_menu_div.dom.getAttribute('field');var items=[];var pref=this.find_entity_field_pref(this.entity_field_prefs,field);if(SG.schema.can_edit_field('EntityFieldPref','settings'))
{items.push({html:'Require Field',checked:field=='project'||(pref&&pref.mandatory_on_create),field:field,type:'mandatory',disabled:field=='project',});}
items.push({html:'Hide Field',field:field,type:'hidden',});menu.items=items;menu.render();},on_hide_field_option_menu:function()
{this.field_option_menu_div.removeClass('showing');},on_field_option_menu:function(menu,menu_item)
{if(menu_item.type=='hidden')
this.hide_more_field(menu_item.field);else
{var mandatory=!menu_item.checked;var field_label_td=this.field_option_menu_div.findParent('td.field_label',this.container.dom,true);if(mandatory)
field_label_td.addClass('mandatory');else
field_label_td.removeClass('mandatory');this.create_or_update_cookie_pref(menu_item.field,null,mandatory);this.entity_field_prefs=this.get_entity_field_prefs();}
this.update_dirty_dot();},create_or_update_cookie_pref:function(field_name,hidden,mandatory,type)
{var cookie_prefs=this.get_cookie_prefs();var entity_prefs=this.get_entity_prefs();var pref=sg_deep_copy(this.find_entity_field_pref(cookie_prefs,field_name));if((pref&&hidden)||(pref&&pref.hidden&&hidden===false))
{var entity_pref=sg_deep_copy(this.find_entity_field_pref(entity_prefs,field_name));if(entity_pref&&(entity_pref.mandatory_on_create!=pref.mandatory_on_create))
{}
else
{this.remove_field_from_cookie_prefs(field_name);return;}}
if((pref&&pref.mandatory_on_create&&mandatory==false)||(pref&&!pref.mandatory_on_create&&mandatory==true))
{var entity_pref=sg_deep_copy(this.find_entity_field_pref(entity_prefs,field_name));if(!entity_pref||(entity_pref.type!=pref.type))
{}
else
{this.remove_field_from_cookie_prefs(field_name);return;}}
if(!pref)
pref=sg_deep_copy(this.find_entity_field_pref(entity_prefs,field_name));if(!pref)
{pref={field:field_name,mandatory_on_create:false,type:'more',hidden:false};}
if(hidden!=null)pref.hidden=hidden;if(mandatory!=null)pref.mandatory_on_create=mandatory;if(type!=null&&type!=undefined)pref.type=type;this.set_cookie_prefs(pref);},remove_field_from_cookie_prefs:function(field_name)
{var cookie_prefs=this.get_cookie_prefs();var new_prefs=[];for(var i=0;i<cookie_prefs.length;i++)
{var pref=cookie_prefs[i];if(pref.field!=field_name)
new_prefs.push(pref);}
setCookie('note_'+this.pref_key,Ext.encode(new_prefs),365);},set_cookie_prefs:function(new_pref)
{var cookie_prefs=this.get_cookie_prefs();var found=false;var new_prefs=[];for(var i=0;i<cookie_prefs.length;i++)
{var cookie_pref=cookie_prefs[i];if(cookie_pref.field==new_pref.field)
{new_prefs.push(new_pref);found=true;}
else
new_prefs.push(cookie_pref);}
if(!found)
new_prefs.push(new_pref);setCookie('note_'+this.pref_key,Ext.encode(new_prefs),365);},get_tasks_cell:function()
{var schema_field=SG.schema.get_field('Note','tasks');var tasks_cell=this.cell_manager.get_cell('tasks',{type:SG.TasksMiniGridSelector});if(this.autocommit)
tasks_cell.autocommit=true;return tasks_cell;},check_for_mandatory_inputs:function()
{var found_project=false;var missing_fields=[];for(var i=0;i<this.entity_field_prefs.length;i++)
{var pref=this.entity_field_prefs[i];if(pref.hidden||!pref.mandatory_on_create)continue;if(pref.field=='project')found_project=true;var value=this.record.get(pref.field);if(value==null||value==""||(typeof value=='string'&&value.strip()==""))
{var schema_field=SG.schema.get_field('Note',pref.field);missing_fields.push(schema_field.display_name);}}
if(!found_project)
{var value=this.record.get('project');if(value==null||value==""||(typeof value=='string'&&value.strip()==""))
{var schema_field=SG.schema.get_field('Note','project');missing_fields.push(schema_field.display_name);}}
if(missing_fields.length==0)
return true;else
{alert("Please provide: "+missing_fields.join(", ")+".");return false;}},on_get_selected_tasks:function(tasks)
{if(tasks!=null)
this.record.set('tasks',tasks);var multi_choice_input=this.container.child('input[value="many"]');if(multi_choice_input&&multi_choice_input.dom.checked)
this.create_multiple_new_entities(tasks);else
this.create_new_entity();},create_new_entity:function()
{this.save_values_for_reuse();this.record.commit(this.no_undo);},create_multiple_new_entities:function(tasks)
{var note_links=this.get_unique_note_links();var tasks_without_links=this.get_tasks_with_no_entity_link(tasks);var record=this.record;for(var i=0;i<note_links.length;i++)
{var entity=note_links[i];var entity_tasks=this.get_tasks_for_entity(entity,tasks);record.set('tasks',entity_tasks);record.set('note_links',[entity]);if(i<note_links.length-1||tasks_without_links.length>0)
record=this.data_set.copy_record(this.record);}
this.data_set.commit();},get_unique_note_links:function()
{var note_links=this.record.get('note_links');if(!note_links)return[];var ret=[];var ids=[];for(var i=0;i<note_links.length;i++)
{var note_link=note_links[i];if(ids.indexOf(note_link.id)==-1)
{ids.push(note_link.id);ret.push(note_link);}}
return ret;},get_tasks_for_entity:function(entity,tasks)
{var ret=[];for(var i=0;i<tasks.length;i++)
{var task=tasks[i];if(task.link&&task.link.type==entity.type&&task.link.id==entity.id)
ret.push(task);}
return ret;},get_tasks_with_no_entity_link:function(tasks)
{var ret=[];for(var i=0;i<tasks.length;i++)
{var task=tasks[i];if(!task.link)
ret.push(task);}
return ret;},save_values_for_reuse:function()
{var fields=this.record.get_fields();var field,i;this.saved_values={};for(i=0;i<fields.length;i++)
{field=fields[i];var schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field.read_only)
this.saved_values[field]=this.record.get(field);}},show_more_fields_menu:function(dom_elem)
{if(!this.more_fields_menu)
{this.more_fields_menu=new SG.Menu({item_selected:{fn:this.on_more_fields_set,scope:this}});}
var items=[];var fields=SG.schema.get_categorized_fields('Note').ordinary;for(i=0;i<fields.length;i++)
{var schema_field=fields[i];if(this.excluded_fields&&this.excluded_fields.indexOf(schema_field.name)>-1)
continue;if(schema_field.grid_column==false)continue;var disabled=this.more_fields_disabled(schema_field);if(!disabled)
{var cant_remove=this.visible_fields.indexOf(schema_field.name)!=-1&&['project','tasks','note_links'].indexOf(schema_field.name)!=-1;items.push({html:schema_field.display_name,field_name:schema_field.name,checked:this.visible_fields.indexOf(schema_field.name)>-1,disabled:cant_remove,});}}
this.more_fields_menu.items=items;this.more_fields_menu.render();this.more_fields_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},hide_more_field:function(field)
{var field_div=sg_find('div.field[field="'+field+'"]',this.container.dom);field_div=Ext.get(field_div);field_div.remove();var index=this.visible_fields.indexOf(field);this.visible_fields.splice(index,1);this.create_or_update_cookie_pref(field,true,null);this.entity_field_prefs=this.get_entity_field_prefs();this.render_extra_controls();this.shrink_dialog();},show_field:function(field)
{var div,index;if(field=='note_links')
{index=0;div=this.container.child('div.links');}
else if(field=='tasks')
{div=this.container.child('div.tasks');index=0;if(this.visible_fields.indexOf('note_links')!=-1)
index=1;}
else if(field=='project')
{index=0;div=this.container.child('div.project');}
else
{index=this.visible_fields.length-1;div=this.container.child('div.more_fields');}
this.visible_fields.splice(index,0,field);this.render_field(field,div);if(field!='project')
this.create_or_update_cookie_pref(field,false,null,'more');this.entity_field_prefs=this.get_entity_field_prefs();this.render_extra_controls();},on_more_fields_set:function(menu,menu_item)
{var field=menu_item.field_name;if(menu_item.checked)
{this.hide_more_field(field);this.update_dirty_dot();return;}
else
{this.show_field(field);this.update_dirty_dot();return;}},more_fields_disabled:function(field_schema)
{var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','system_task_type','list','timecode','date_time','url'];var not_these=['note_links','tasks','attachments','content'];if(!this.render_as_dialog)
not_these=['attachments','content'];if(field_schema.read_only)
return true;else if(supported_data_types.indexOf(field_schema.data_type)==-1)
return true;else if(not_these.indexOf(field_schema.name)!=-1)
return true;else if(!SG.schema.can_edit_field('EntityFieldPref','settings'))
{var pref=this.find_entity_field_pref(this.entity_field_prefs,field_schema.name);if(pref&&pref.mandatory_on_create)
return true;}
return false;},on_after_cell_edit:function(field,record,cell)
{if(field=='project')
{var proj=record.get('project');if(proj)
{if(this.require_project)
{var blocker=this.container.child('div.project_blocker_overlay');if(blocker)
blocker.setDisplayed(false);}
var last_project_id=null;if(this.last_project)
last_project_id=this.last_project.id;if(last_project_id!=proj.id)
this.project_changed();}
else
{this.project_changed();if(this.require_project)
{var blocker=this.container.child('div.project_blocker_overlay');if(blocker)
blocker.setDisplayed(true);}}
this.last_project=proj;return;}
if(field=='note_links')
{this.render_create_multiple_choices();return;}},render_create_multiple_choices:function()
{if(this.edit_source_record_mode)
return;var create_multiple_choice_div=this.container.child('div.create_multiple_choice_div');var note_links=this.record.get('note_links');if(!note_links||(note_links&&note_links.length<2))
{create_multiple_choice_div.update('');return;}
var ids=[note_links[0].id];var entity_type=note_links[0]['type'];for(var i=1;i<note_links.length;i++)
{var note_link=note_links[i];if(entity_type!=note_link.type)
{create_multiple_choice_div.update('');return;}
else if(ids.indexOf(note_link.id)==-1)
ids.push(note_link.id);}
if(ids.length==1)
{create_multiple_choice_div.update('');return;}
var html=this.templates.create_multiple_notice_choices.apply({single_checked:'checked="true"',linked_entity_plural:'linked_entity_plural ',and_other_types:'and_other_types ',multi_checked:'',count:ids.length,});create_multiple_choice_div.update(html);},make_upload_fn_callback:function(ac,fv)
{return function(){ac.component.submit(fv);}},option_keydown:false,shift_keydown:false,on_keydown:function(e)
{if(e.keyCode==18&&!this.allow_keep_form_open)
{this.option_key_warning=true;this.render_footer();return;}
switch(e.keyCode)
{case 18:this.option_keydown=true;break;case Ext.EventObject.SHIFT:this.shift_keydown=true;break;}
this.set_keydown_mode();},on_keyup:function(e)
{if(e.keyCode==18&&!this.allow_keep_form_open)
{this.option_key_warning=false;this.render_footer();return;}
switch(e.keyCode)
{case 18:this.option_keydown=false;break;case Ext.EventObject.SHIFT:this.shift_keydown=false;break;case Ext.EventObject.ESC:this.on_escape_key_pressed(e);return;break;}
this.set_keydown_mode();},set_keydown_mode:function()
{if(this.option_keydown&&this.shift_keydown&&this.update_mode!='reset_on_create')
{this.update_mode='reset_on_create';this.render_footer();}
else if(this.option_keydown&&!this.shift_keydown&&this.update_mode!='keep_on_create')
{this.update_mode='keep_on_create';this.render_footer();}
else if(!this.option_keydown&&this.update_mode!=this.persistent_update_mode)
{this.update_mode=this.persistent_update_mode;this.render_footer();}},on_escape_key_pressed:function(evt)
{if(!this.render_as_dialog)return;if(!this.cell_manager.active_editor&&SG.Page.unsaved_data.confirm_proceed())
{this.fireEvent("form_canceled",evt);this.destroy();return;}},on_create_button_focus:function(e)
{this.create_button_focused=true;},on_create_button_blur:function(e)
{this.create_button_focused=false;},on_create_button_keydown:function(evt)
{var key=evt.getKey();if(key==Ext.EventObject.TAB)
{evt.stopEvent();if(evt.shiftKey)
this.edit_last_field();else
this.edit_first_field();}},render_footer:function()
{if(this.edit_source_record_mode)
return;if(this.create_button)
{this.remove_event(this.create_button,'focus',this.on_create_button_focus);this.remove_event(this.create_button,'blur',this.on_create_button_blur);this.remove_event(this.create_button,"keydown",this.on_create_button_keydown);}
var create_button_part_2='';if(this.persistent_update_mode!=this.update_mode){switch(this.update_mode)
{case'close_on_create':create_button_part_2='';break;case'keep_on_create':create_button_part_2=' and Keep Form Values';break;case'reset_on_create':create_button_part_2=' and Reset Form';break;}}
var create_button_part_1='Create '+SG.schema.entity_types[this.entity_type]['display_name'];this.footer.update(this.templates.footer.apply({warning_text:this.option_key_warning?"Sorry, \"Keep form\" mode not supported in this context.":"",create_button_text:create_button_part_1+create_button_part_2,cancel_button:this.hide_cancel_button?'':this.templates.cancel_button.apply(),disabled:this.configure_only?'disabled="true"':''}));this.create_button=this.footer.child('input[name="create"]');this.add_event(this.create_button,'focus',this.on_create_button_focus);this.add_event(this.create_button,'blur',this.on_create_button_blur);this.add_event(this.create_button,"keydown",this.on_create_button_keydown);if(this.create_button_focused)
{var button=this.create_button.dom;setTimeout(function(){button.focus();},0);}},edit_first_field:function()
{var fields=this.get_tabable_fields();var field=fields[0];this.edit_field(field);},edit_last_field:function()
{var fields=this.get_tabable_fields();var field=fields[fields.length-1];this.edit_field(field);},edit_field:function(field)
{var schema_field=SG.schema.get_field('Note',field);var cell=this.cell_manager.get_cell(field,this.get_cell_config(schema_field));if(this.autocommit)
cell.autocommit=true;if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}},edit_cell:function(cell)
{var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="'+cell.field+'"]';var cell_elem=sg_find(sel,this.container.dom);if(cell_elem){cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});}},set_project:function(project,dont_set_record)
{this.setting_project=true;this.record.set('project',project);this.setting_project=false;if(project===null)
{this.projects.splice(0,this.projects.length);for(var i=0;i<this.all_projects.length;i++)
this.projects.push(this.all_projects[i]);}
else
this.projects.splice(0,this.projects.length,project);},are_prefs_dirty:function()
{var cookie_prefs=this.get_cookie_prefs();if(cookie_prefs.length==0)
return false;else
return true;},update_dirty_dot:function()
{if(this.ignore_field_prefs)return;var is_dirty=this.are_prefs_dirty();var dot_div=this.container.child('div.dialog_drag_div div.icon_fin');if(is_dirty&&!dot_div.hasClass('visible'))
dot_div.addClass('visible')
else if(!is_dirty&&dot_div.hasClass('visible'))
dot_div.removeClass('visible');},});SG.ConfigureField.SummaryTypeProperties=function(config)
{Ext.apply(this,config);SG.ConfigureField.SummaryTypeProperties.superclass.constructor.call(this);};Ext.extend(SG.ConfigureField.SummaryTypeProperties,SG.Component,{templates:{body:'<div id="sgd_summary_data_type_options">'+'<div class="help">Learn about query fields '+'<a target="_blank" href="'+SG.globals.help_urls.query_fields+'">here</a></div>'+'<div class="section"><div class="section_title">Entity</div>'+'<div class="entity_menu fake_menu">{entity_type_menu}</div></div>'+'<div class="section"><div class="section_title">Query</div><div id="summary_field_query"></div></div>'+'<div class="section"><div class="section_title">Display</div>'+'<form><div class="display_choice"><input class="multi_choice" type="radio" name="choice" '+'value="count" {count_checked} />{entity_display_name} Count</div>'+'<div class="display_choice {summarize_disabled}"><table class="summary"><tr>'+'<td class="summarize_check"><div class="pad"><input class="multi_choice" type="radio" name="choice" '+'value="summarize" {summarize_checked} />Summarize field:</div></td>'+'<td class="field_menu"><div class="summary_field_menu fake_menu"><span class="menu_text">'+'{summary_field}</span><div class="dropdown_arrow_small menu_dropdown"></div></div></td>'+'<td class="calculation_label"><div class="pad">Calculation:</div></td>'+'<td class="summary_calc"><div class="summary_op_menu fake_menu"><span class="menu_text">'+'{summary_op}</span><div class="dropdown_arrow_small menu_dropdown"></div></div></td></tr></table>'+'</div>{single_record}</form></div></div>',entity_menu:'<div class="sg_entity_icon_span icon_{entity_type}"></div>'+'<span class="entity_display_name">{entity_display_name}</span>'+'<div class="dropdown_arrow_small menu_dropdown"></div>',single_record:'<div class="display_choice single_record"><input class="multi_choice" type="radio" '+'name="choice" value="single_record" {single_record_checked} />Single {entity_display_name}</div>'+'<div class="single_record_details">'+'<div class="single_record_title">Show the first {entity_display_name} sorted by:</div>'+'<div class="single_record_sort_field_menu fake_menu"><span class="menu_text">'+'{sort_field}</span><div class="dropdown_arrow_small menu_dropdown"></div></div>'+'&nbsp;&nbsp;'+'<div class="single_record_sort_dir_menu fake_menu"><span class="menu_text">'+'{sort_dir}</span><div class="dropdown_arrow_small menu_dropdown"></div></div><div>'+'<div class="single_record_title">Display this {entity_display_name} field:</div>'+'<div><div class="single_record_display_field_menu fake_menu"><span class="menu_text">'+'{display_field}</span><div class="dropdown_arrow_small menu_dropdown"></div></div>'+'</div>'+'<div class="single_record_title"><input type="checkbox" class="detail_link" {detail_extra}>'+'&nbsp;Display cell as link to the {entity_display_name} detail page.</div></div>'},init_component:function(){this.add_event(this.container,'click',this.on_click);},render:function(){var cfg;var sum=this.state.summary;var entity_type=sum.entity_type;var edn=SG.schema.entity_types[entity_type]['display_name'];var entity_type_menu=this.templates.entity_menu.apply({entity_type:entity_type,entity_display_name:edn,});var schema_field=SG.schema.get_field(entity_type,sum.column);var summary_names=SG.schema.summary_display_names;var count=sum.type=='record_count';var single_record=sum.type=='single_record';var summarize=!(count||single_record);var sort_field,sort_dir,display_field;if(count||summarize){sort_field=SG.schema.get_field(entity_type,'created_at')
if(!sort_field)
sort_field=SG.schema.get_categorized_fields(entity_type).ordinary[0];sort_field=sort_field.display_name;sort_dir="Descending";display_field=SG.schema.get_field(entity_type,'id').display_name;}else{var sum_val=JSON.parse(sum.value);sort_field=SG.schema.get_field(entity_type,sum_val.column).display_name;sort_dir=sum_val.direction=='asc'?'Ascending':'Descending';display_field=SG.schema.get_field(entity_type,sum.column).display_name;}
cfg={sort_field:sort_field,sort_dir:sort_dir,display_field:display_field,single_record_checked:single_record?'checked="true"':'',entity_display_name:edn,detail_extra:''};var has_detail=SG.schema.entity_types[entity_type]["has_detail_page"];if(single_record&&(!has_detail||["text","number"].indexOf(schema_field.data_type)===-1))
cfg.detail_extra+=' disabled';if(single_record&&sum_val.detail_link)
cfg.detail_extra+=' checked';var single_record_html=this.templates.single_record.apply(cfg);var summary_field_display_name,summary_op_display_name;if(count||single_record){var disabled_summary=SG.util.SummaryMenuHelper.find_first_non_record_count_summary(entity_type);var disabled_schema_field=SG.schema.get_field(entity_type,disabled_summary.column);summary_field_display_name=disabled_schema_field.display_name;summary_op_display_name=summary_names[disabled_summary.type];}else{summary_field_display_name=schema_field.display_name;summary_op_display_name=summary_names[sum.type];}
cfg={entity_type_menu:entity_type_menu,summary_field:summary_field_display_name,summary_op:summary_op_display_name,count_checked:count?'checked="true"':'',summarize_checked:summarize?'checked="true"':'',summarize_disabled:summarize?'':'disabled',entity_display_name:edn,single_record:single_record_html};this.container.update(this.templates.body.apply(cfg));var single_record_details=Ext.get(sg_find('div.single_record_details',this.container.dom));single_record_details.enableDisplayMode();if(!single_record)single_record_details.hide();this.construct_qb();},on_click:function(e){var t=Ext.get(e.getTarget());var sum=this.state.summary;var entity_menu_div=t.findParent('div.entity_menu',this.container,true);if(entity_menu_div){this.show_entity_menu(entity_menu_div);return;}
var summary_field_menu_div=t.findParent('div.summary_field_menu',this.container,true);if(summary_field_menu_div){var display_choice_div=summary_field_menu_div.findParent('div.display_choice',this.container,true);if(!display_choice_div.hasClass('disabled'))
this.show_summarize_field_menu(summary_field_menu_div);return;}
var summary_op_menu_div=t.findParent('div.summary_op_menu',this.container,true);if(summary_op_menu_div){var display_choice_div=summary_op_menu_div.findParent('div.display_choice',this.container,true);if(!display_choice_div.hasClass('disabled'))
this.show_summarize_calculation_menu(summary_op_menu_div);return;}
var count_checkbox=t.findParent('input[value="count"]',this.container,true);if(count_checkbox&&count_checkbox.dom.checked){var ident_field=SG.schema.get_identifier_field(sum.entity_type);sum.column=ident_field;sum.type='record_count';sum.value=null;sum.filters=this.summary_condition_component.get_condition();this.render();return;}
var summarize_checkbox=t.findParent('input[value="summarize"]',this.container,true);if(summarize_checkbox&&summarize_checkbox.dom.checked){var new_sum=SG.util.SummaryMenuHelper.find_first_non_record_count_summary(sum.entity_type);sum.column=new_sum.column;sum.type=new_sum.type;sum.value=new_sum.value;sum.filters=this.summary_condition_component.get_condition();this.render();return;}
var single_record_checkbox=t.findParent('input[value="single_record"]',this.container,true);if(single_record_checkbox&&single_record_checkbox.dom.checked){sum.type='single_record',sum.column='id',sum.value=JSON.stringify({column:'created_at',direction:'desc',detail_link:false});sum.filters=this.summary_condition_component.get_condition();this.render();return;}
var single_record_sort_field_menu=t.findParent('div.single_record_sort_field_menu',this.container,true);if(single_record_sort_field_menu){var disabled_div=single_record_sort_field_menu.findParent('div.disabled',this.container,true);if(!disabled_div)
this.show_single_record_sort_field_menu(single_record_sort_field_menu);return;}
var single_record_sort_dir_menu=t.findParent('div.single_record_sort_dir_menu',this.container,true);if(single_record_sort_dir_menu){var disabled_div=single_record_sort_dir_menu.findParent('div.disabled',this.container,true);if(!disabled_div)
this.show_single_record_sort_dir_menu(single_record_sort_dir_menu);return;}
var single_record_display_field_menu=t.findParent('div.single_record_display_field_menu',this.container,true);if(single_record_display_field_menu){var disabled_div=single_record_display_field_menu.findParent('div.disabled',this.container,true);if(!disabled_div)
this.show_single_record_display_field_menu(single_record_display_field_menu);return;}
var single_record_detail_link=t.findParent('input.detail_link',this.container,true);if(single_record_detail_link){var cur=JSON.parse(sum.value);cur.detail_link=single_record_detail_link.dom.checked;sum.value=JSON.stringify(cur);this.render()
return;}},construct_qb:function(){if(this.summary_condition_component)
this.summary_condition_component.destroy();var sum=this.state.summary;var w=this.state.widget;var tokens=[w.get_entity_token(this.state.entity_type),w.get_user_token()];w.refresh_token_entities_in_filters(sum.filters,this.state.entity_type);this.summary_condition_component=new SG.ConditionGroup({condition:sum.filters,container:'summary_field_query',edit_container:this.container,entity_type:sum.entity_type,context_projects:w.context_projects(),default_field_path:null,use_these_filter_tokens:tokens,condition_changed_callback:{fn:this.on_condition_changed,scope:this}});this.summary_condition_component.render();},show_entity_menu:function(entity_menu_div)
{if(!this.entity_menu){this.entity_menu=new SG.Menu({item_selected:{fn:this.on_entity_menu,scope:this}});}
var entity_types=SG.schema.leftnav_page_entity_types;var items=[];for(var i=0;i<entity_types.length;i++){var entity_type=entity_types[i];var edn=SG.schema.entity_types[entity_type].display_name;items.push({html:edn,entity_type:entity_type,icon_name:'icon_'+entity_type,checked:this.state.summary.entity_type==entity_type});}
if(SG.schema.entity_types[this.state.entity_type].has_replies){items.push({html:'Reply',entity_type:'Reply',icon_name:'icon_Reply',checked:this.state.summary.entity_type=='Reply'});items.sort(function(x,y){x=x.html.toUpperCase();y=y.html.toUpperCase();if(x>y)
return 1;if(x<y)
return-1;return 0;});}
this.entity_menu.items=items;this.entity_menu.position={dom_elem:entity_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.entity_menu.render();this.entity_menu.show();},on_entity_menu:function(menu,menu_item){var sf=this.state.schema_field;var sum=this.state.summary;var entity_type=menu_item.entity_type;sum.entity_type=entity_type;if(sf&&sf.query&&sf.entity_type==entity_type)
{sum.filters=sf.query.filters;sum.column=sf.summary_field;sum.type=sf.summary_default;sum.value=sf.summary_value;this.render();return;}
this.pi=new SG.ProgressIndicator();this.pi.show();var me=this;var options={url:SG.globals.urls.parent_entity_filter,params:{embedded_entity_type:entity_type,entity_type:me.state.entity_type},callback:function(options,success,response){if(success){var filters=Ext.decode(response.responseText);sum.filters=sg_deep_copy(filters);if(sf&&sf.query.entity_type==entity_type){var new_sum=me.state.widget.get_summary(sf.name);sum.column=new_sum.column;sum.type=new_sum.type;sum.value=new_sum.value;}else{var ident_field=SG.schema.get_identifier_field(entity_type);sum.column=ident_field;sum.type='record_count';sum.value=null;}
me.pi.hide();me.render();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},show_summarize_field_menu:function(menu_div){var sum=this.state.summary;if(!this.summarize_field_menu){var cfg={item_selected:{fn:this.on_summarize_field_menu,scope:this}}
this.summarize_field_menu=new SG.Menu(cfg);}
var categorized_fields=SG.schema.get_categorized_fields(sum.entity_type,false,true);var schema_field,schema_fields=categorized_fields['ordinary'];var items=[];for(var i=0;i<schema_fields.length;i++){schema_field=schema_fields[i];items.push({html:schema_field.display_name,schema_field:schema_field,checked:sum.column==schema_field.name,disabled:!SG.util.SummaryMenuHelper.schema_field_has_other_summary_options(schema_field)});}
this.summarize_field_menu.items=items;this.summarize_field_menu.position={dom_elem:menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.summarize_field_menu.render();this.summarize_field_menu.show();},on_summarize_field_menu:function(menu,menu_item){var sum=this.state.summary;var summary_op=SG.util.SummaryMenuHelper.first_good_summary_operator(menu_item.schema_field);sum.column=menu_item.schema_field.name;sum.type=summary_op;sum.value=null;this.render();},show_summarize_calculation_menu:function(menu_div){if(!this.summarize_calculation_menu){this.summarize_calculation_menu=new SG.Menu({item_selected:{fn:this.on_summarize_calculation_menu,scope:this}});}
var sum={column:this.state.summary.column,type:this.state.summary.type,value:this.state.summary.value};var items=SG.util.SummaryMenuHelper.get_summary_calculation_menu_items(this.state.summary.entity_type,sum);this.summarize_calculation_menu.items=items;this.summarize_calculation_menu.position={dom_elem:menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.summarize_calculation_menu.render();this.summarize_calculation_menu.show();},on_summarize_calculation_menu:function(menu,menu_item){this.state.summary.column=menu_item.value.column;this.state.summary.type=menu_item.value.type;this.state.summary.value=menu_item.value.value;this.render();},show_single_record_sort_field_menu:function(menu_div){if(!this.single_record_sort_field_menu){this.single_record_sort_field_menu=new SG.Menu();}
var sort=JSON.parse(this.state.summary.value);var field_checked_fn=function(sf,field_name){return field_name==sort.column};var field_value_fn=function(sf,field_name){return field_name};var field_disabled_fn=function(sf,field_name){return sf.no_sorting};var cfg={entity_type:this.state.summary.entity_type,only_simple_fields:true,no_steps:true,field_checked_callback:{fn:field_checked_fn,scope:this},field_value_callback:{fn:field_value_fn,scope:this},field_disabled_callback:{fn:field_disabled_fn,scope:this},on_field:{fn:this.on_single_record_sort_field_menu,scope:this}};var helper=new SG.util.EntityFieldsMenuHelper(cfg);this.single_record_sort_field_menu.items=helper.get_fields_menu_items();this.single_record_sort_field_menu.position={dom_elem:menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.single_record_sort_field_menu.render();this.single_record_sort_field_menu.show();},on_single_record_sort_field_menu:function(menu,menu_item){var sort=JSON.parse(this.state.summary.value);sort.column=menu_item.value;this.state.summary.value=JSON.stringify(sort);this.render();},show_single_record_sort_dir_menu:function(menu_div){if(!this.single_record_sort_dir_menu){this.single_record_sort_dir_menu=new SG.Menu({item_selected:{fn:this.on_single_record_sort_dir_menu,scope:this}});}
var sort=JSON.parse(this.state.summary.value);var items=[];items.push({html:"Ascending",value:"asc",checked:sort.direciton=="asc"});items.push({html:"Descending",value:"desc",checked:sort.direciton=="desc"});this.single_record_sort_dir_menu.items=items;this.single_record_sort_dir_menu.position={dom_elem:menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.single_record_sort_dir_menu.render();this.single_record_sort_dir_menu.show();},on_single_record_sort_dir_menu:function(menu,menu_item){var sort=JSON.parse(this.state.summary.value);sort.direction=menu_item.value;this.state.summary.value=JSON.stringify(sort);this.render();},show_single_record_display_field_menu:function(menu_div){if(!this.single_record_display_field_menu){this.single_record_display_field_menu=new SG.Menu();}
var sort=JSON.parse(this.state.summary.value);var field_checked_fn=function(sf,field_name){return field_name==this.state.summary.column};var field_value_fn=function(sf,field_name){return field_name};var field_disabled_fn=function(sf,field_name){return sf.data_type=='summary'};var cfg={entity_type:this.state.summary.entity_type,only_simple_fields:true,no_steps:true,field_checked_callback:{fn:field_checked_fn,scope:this},field_value_callback:{fn:field_value_fn,scope:this},field_disabled_callback:{fn:field_disabled_fn,scope:this},on_field:{fn:this.on_single_record_display_field_menu,scope:this}};var helper=new SG.util.EntityFieldsMenuHelper(cfg);this.single_record_display_field_menu.items=helper.get_fields_menu_items();this.single_record_display_field_menu.position={dom_elem:menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.single_record_display_field_menu.render();this.single_record_display_field_menu.show();},on_single_record_display_field_menu:function(menu,menu_item){this.state.summary.column=menu_item.value;this.render();},on_condition_changed:function(){if(this.summary_condition_component.invalid())
{alert("The conditions have one or more invalid values.");return;}
this.state.summary.filters=this.summary_condition_component.get_condition();}});SG.DependencyViolationDialog=function(config)
{Ext.apply(this,config);SG.DependencyViolationDialog.superclass.constructor.call(this);};Ext.extend(SG.DependencyViolationDialog,SG.FloatingComponent,{templates:{header:'<div class="title">Dependency Violation</div>'+'<img class="close_window" src="/images/close_overlay_x.png">',body:'<div class="message">This Task starts <span class="day_count">{day_count} day{day_plural}'+' earlier</span> than it should, based on the End date of its upstream Tasks. You have options:</div>'+'<div class="option_unpin"><div class="icon {unpin_icon}">'+'</div><span class="action action_unpin {unpin_disabled}">Unpin this Task</span>'+'(will adjust the Start date automatically)</div>'+'<div class="push option"><div class="icon {push_icon}">'+'</div><span class="action action_push_start {push_disabled}">Push the Start '+'date {push_count} day{day_plural} </span>to {push_date}</div>'+'<div class="show_tasks_option"><div class="icon {show_tasks_icon}"></div>'+'<span class="action action_view_tasks">View dependent Tasks</span> (in a new window)</div>',},init_component:function(){SG.FloatingComponent.prototype.init_component.call(this);var eqp_widget=this.find_entity_query_page_widget();this.add_event(eqp_widget,'settings_changed',this.on_eqp_widget_settings_changed);this.depress_launch_button();this.on_first_render();this.render();},on_eqp_widget_settings_changed:function(change_hash,source_widget)
{if('mode'in change_hash)
this.destroy();},find_entity_query_page_widget:function()
{var p=this.grid_widget.get_parent();while(p&&p.get('type')!='SG.Widget.EntityQuery.EntityQueryPage')
{p=p.get_parent();}
return p;},hide:function(){this.destroy();},destroy_component:function(){SG.FloatingComponent.prototype.destroy_component.call(this);this.container.remove();this.reorder_proxy.remove();this.shadow.el.remove();},on_first_render:function(){this.dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.container=this.dh.append(this.dbody,{tag:'div',cls:'sgc_dependency_violation_dialog'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'body'},true);this.add_event(this.header,'click',this.on_header_click);this.add_event(this.body,'click',this.on_body_click);this.setup_dialog_drag();this.set_position();},render:function()
{this.render_header();this.render_body();this.shadow.show(this.container);},render_header:function()
{var h=this.templates.header.apply();this.header.update(h);},render_body:function()
{var inv_date=new SG.Date(this.record.get('inventory_date'));var start_date=new SG.Date(this.record.get('start_date'));var days=Math.round((inv_date.getTime()-start_date.getTime())/(1000*24*60*60));var pin_sf=SG.schema.get_field("Task","pinned");var can_unpin=SG.schema.can_edit_field_on_record(this.record,pin_sf);var start_sf=SG.schema.get_field("Task","start_date");var can_push=SG.schema.can_edit_field_on_record(this.record,start_sf);var h=this.templates.body.apply({day_count:days,unpin_icon:'icon_unpin_task',push_icon:'icon_push_pinned_task',show_tasks_icon:'icon_zoom_task_dependencies',push_count:days,day_plural:days==1?'':'s',push_date:inv_date.format('l, M j'),shot_tasks_icon:'',unpin_disabled:can_unpin?'':'disabled',push_disabled:can_push?'':'disabled'});this.body.update(h);},setup_dialog_drag:function()
{this.shadow=new Ext.Shadow({offset:5,mode:'frame'});var dd=new Ext.dd.DDProxy(this.container,"dependency_violation",{scroll:false});dd.setHandleElId(this.header);dd.dependency_violation_dialog=this;dd.startDrag=function(){this.constrainTo(this.dependency_violation_dialog.dbody);this.getDragEl().style.border="2px solid #666666";this.dependency_violation_dialog.shadow.hide();};dd.afterDrag=function(){this.dependency_violation_dialog.shadow.show(this.dependency_violation_dialog.container);};},set_position:function(){var db=Ext.get(document.body);var browser_width=db.getWidth();var browser_height=db.getHeight();var x=this.click_xy[0]+410<browser_width?this.click_xy[0]:browser_width-410;var y=this.click_xy[1]+200<browser_height?this.click_xy[1]:browser_height-200;this.container.setXY([x,y]);},on_header_click:function(e)
{var t=Ext.get(e.getTarget());var close_window=t.findParent('img.close_window',this.header);if(close_window)
{var me=this;setTimeout(function(){me.destroy();},0);}},on_body_click:function(e)
{var t=Ext.get(e.getTarget());var unpin=t.findParent('span.action_unpin',this.body,true);if(unpin&&!unpin.hasClass('disabled'))
{this.data_set.start_batch();this.record.set('pinned',false);this.data_set.end_batch();this.data_set.commit();this.destroy();return;}
var push=t.findParent('span.action_push_start',this.body,true);if(push&&!push.hasClass('disabled'))
{this.data_set.start_batch();this.record.set('start_date',this.record.get('inventory_date'));this.data_set.end_batch();this.data_set.commit();this.destroy();return;}
var show=t.findParent('span.action_view_tasks',this.body);if(show)
{var entity_name=this.record.get('content');var filters={logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]};var page=this.grid_widget.get_page();var focus_context={task_chain:true,entity:{type:'Task',id:this.record.id,name:entity_name},entity_type:'Task',filters:filters,title:'Task Dependency Chain for: '+entity_name,reset_stack:(page.context.get('inside_window')!==true),server_side_filters:"dependency_chain",server_side_filters_params:{task_id:this.record.id},select_entities_on_first_load:[this.record.id],scroll_selection_into_view_on_load:true,callback:{fn:this.grid_widget.reload_all_entities,scope:this.grid_widget}};page.get_focus_window().open(focus_context);this.destroy();return;}},destroy_component:function(){SG.FloatingComponent.prototype.destroy_component.call(this);this.restore_launch_button();this.container.remove();this.shadow.el.remove();},depress_launch_button:function()
{this.button_restore_class=this.launch_button_elem.hasClass('icon_Task_violation')?'icon_Task_violation':'violation_editor_button_selected';this.launch_button_elem.replaceClass(this.button_restore_class,'violation_editor_button_pressed');},restore_launch_button:function()
{this.launch_button_elem.replaceClass('violation_editor_button_pressed',this.button_restore_class);},});SG.FieldProperties=SG.FieldProperties||{};SG.FieldProperties.Dialog=function(config)
{this.config=config;SG.FieldProperties.Dialog.superclass.constructor.call(this);};Ext.extend(SG.FieldProperties.Dialog,SG.Component,{templates:{structure:'<div class="sg_dialog_mask"><div class="sgd_field_properties">'+'<div class="header"><div>Field Properties</div></div>'+'<div class="body"></div>'+'<div class="footer"></div>'+'</div></div>',footer:'<div class="apply_button"><input class="apply_button" type="button" value="Apply"></div>'+'<div class="cancel">Cancel</div>'+'<div class="new_field_link">Add New Field to {entity}</div>',},init_component:function(){this.render_structure();},render_structure:function(){this.mask=this.templates.structure.append(document.body,{},true);this.container=Ext.get(this.mask.dom.firstChild);this.body=this.container.child('div.body');this.footer=this.container.child('div.footer');this.add_event(this.footer,'click',this.on_footer_click);Ext.EventManager.onWindowResize(this.center_dialog,this);this.render();this.center_dialog();},render:function(){this.render_body();this.render_footer();},render_body:function()
{this.config['container']=this.body;this.field_properties_component=new SG.FieldProperties(this.config);},render_footer:function()
{var edn=SG.schema.entity_types[this.config.entity_type]['display_name'];this.footer.update(this.templates.footer.apply({entity:edn}));},on_footer_click:function(e)
{var target=Ext.get(e.getTarget());var apply_button=target.findParent('input.apply_button');if(apply_button)
{var field_settings=this.field_properties_component.get_field_properties();this.config.settings_applied_callback.fn.call(this.config.settings_applied_callback.scope,field_settings);this.destroy();return;}
var cancel=target.findParent('div.cancel');if(cancel)
{this.destroy();return;}
var new_field=target.findParent('div.new_field_link');if(new_field)
{this.create_new_field();return;}},center_dialog:function(){this.container.setXY(this.container.getCenterXY(true));},destroy_component:function(){if(this.mask){document.body.removeChild(this.mask.dom);this.container=null;}
Ext.EventManager.removeResizeListener(this.center_dialog,this);},create_new_field:function()
{var config={entity_type:this.config.entity_type,widget:this.config.widget,show_column_callback:{fn:this.field_properties_component.add_newly_created_field,scope:this.field_properties_component}};var cudc=new SG.util.CreateUpdateDC(config);},});SG.EditSelectedFieldDialog=function(config)
{Ext.apply(this,config);SG.EditSelectedFieldDialog.superclass.constructor.call(this);};Ext.extend(SG.EditSelectedFieldDialog,SG.FloatingComponent,{templates:{main:'<div class="header">{title}</div><img class="close_window" src="/images/close_overlay_x.png">'+'<div class="field_editor"><table><tr>{alert_icon}<td>{field_editor}</td></tr></table></div>'+'<div class="footer"><input class="save" type="button" value="{button_label}"></div>',cell:'<div class="{cell_classes}" {cell_attributes}>{cell_content}</div>',cell_not_editable:'<div class="not_editable">(Not Editable in this Context)</div>',cell_multi_entity:'<div class="field_update_mode"><select>'+'<option value="add" selected="selected">Add</option>'+'<option value="set">Overwrite</option>'+'<option value="remove">Remove</option></select></div>'+'<div class="field_multi_entity_value {cell_classes}" {cell_attributes}>{cell_content}</div>',alert_icon:'<td style="width:20px;"><div class="permissions_alert" sg_tip="{sg_tip}"></div></td>'},init_component:function(){SG.FloatingComponent.prototype.init_component.call(this);var eqp_widget=this.find_entity_query_page_widget();this.add_event(eqp_widget,'settings_changed',this.on_eqp_widget_settings_changed);this.my_data_set=new SG.Data.Set(this.entity_type);this.my_record=this.my_data_set.new_temp_record();this.setup_my_record();this.render();},on_eqp_widget_settings_changed:function(change_hash,source_widget)
{if('mode'in change_hash)
this.destroy();},find_entity_query_page_widget:function()
{var p=this.grid_widget.get_parent();while(p&&p.get('type')!='SG.Widget.EntityQuery.EntityQueryPage')
{p=p.get_parent();}
return p;},hide:function(){this.destroy();},destroy_component:function(){SG.FloatingComponent.prototype.destroy_component.call(this);this.container.remove();this.shadow.el.remove();},render:function()
{this.dh=Ext.DomHelper;this.dbody=Ext.get(document.body);this.container=this.dh.append(this.dbody,{tag:'div',cls:'sgc_edit_selected_field_dialog'},true);this.add_event(this.dbody,'click',this.on_click_dbody);this.add_event(this.container,'click',this.on_click);this.add_event(Ext.get(document),'keydown',this.on_keydown);this.schema_field=SG.schema.get_field(this.entity_type,this.field);var cell_config={container:this.container,edit_container:this.container,data_set:this.my_data_set,projects:this.projects,in_form:true,get_fields_callback:{fn:this.get_fields,scope:this},};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.edit_permissions=this.edit_permissions();this.cell=this.cell_manager.get_cell(this.field);this.cell.override_editable=(this.edit_permissions!='none');var cell_hash=this.cell.render(this.my_record);var alert_icon='';if(this.edit_permissions=='mixed')
{var entity_type=SG.schema.entity_types[this.entity_type].display_name_pluralized;var alert_msg="You only have permission to edit this field on some of the "+
entity_type+" you have selected, so only those "+
entity_type+" will be changed.";alert_icon=this.templates.alert_icon.apply({sg_tip:alert_msg});}
var field_editor;if(this.edit_permissions=='none')
{field_editor=this.templates.cell_not_editable.apply();}
else
{if(this.schema_field.data_type=='multi_entity')
{this.container.addClass('multi_entity');field_editor=this.templates.cell_multi_entity.apply(cell_hash);}
else
field_editor=this.templates.cell.apply(cell_hash);}
this.container.update(this.templates.main.apply({title:'Edit '+this.schema_field.display_name+':',field_editor:field_editor,button_label:this.edit_permissions=='none'?'Close':'Save',alert_icon:alert_icon}));this.header=this.container.child('div.header');this.setup_dialog_drag();this.set_position();this.shadow.show(this.container);if(this.edit_permissions!='none')
{var cell_elem=this.container.child('div.sg_cell');this.cell.edit_cell({cell_elem:cell_elem,record:this.my_record});}},get_fields:function()
{return[this.field];},is_elem_in_document:function(element){while(element=element.parentNode){if(element===document){return true;}}
return false;},on_click_dbody:function(e)
{if(!this.is_elem_in_document(e.getTarget()))return;if(sg_find('div.sg_dialog_mask',document.body))
return;var t=Ext.get(e.getTarget());var dialog_container=t.findParent('div.sgc_edit_selected_field_dialog',40);if(!dialog_container&&!SG.GridEditor.showing_editor)
{var me=this;setTimeout(function(){me.destroy();},0);return;}},on_click:function(e){var t=Ext.get(e.getTarget());var close_window=t.findParent('img.close_window',this.header);if(close_window)
{var me=this;setTimeout(function(){me.destroy();},0);return;}
var save_button=t.findParent('input.save',this.container);if(save_button)
{this.update_selected();return;}},on_keydown:function(e){if(e.target.nodeName=='TEXTAREA'||(e.target.nodeName=='INPUT'&&e.target.getAttribute('type')!='button')){return;}
if(Ext.get(e.target).findParent('.sg_focusable',10))
return;if(sg_find('div.sg_dialog_mask',document.body))
return;if(e.browserEvent.keyCode==e.ENTER){this.update_selected();}else if(e.browserEvent.keyCode==e.ESC){this.destroy();}},set_position:function(){var db=Ext.get(document.body);var browser_width=db.getWidth();var browser_height=db.getHeight();var x=this.click_xy[0]+190<browser_width?this.click_xy[0]:browser_width-190;var y=this.click_xy[1]+100<browser_height?this.click_xy[1]:browser_height-100;this.container.setXY([x,y]);},setup_dialog_drag:function()
{this.shadow=new Ext.Shadow({offset:5,mode:'frame'});var dd=new Ext.dd.DDProxy(this.container,"dependency_violation",{scroll:false});dd.setHandleElId(this.header);dd.dialog=this;dd.startDrag=function(){this.constrainTo(this.dialog.dbody);this.getDragEl().style.border="2px solid #666666";this.dialog.shadow.hide();this.dialog.cell_manager.apply_all_edits();};dd.afterDrag=function(){this.dialog.shadow.show(this.dialog.container);};},update_selected:function()
{if(this.edit_permissions!='none')
{this.cell_manager.apply_all_edits();for(var i=0;i<this.selected_ids.length;i++)
{var rec=this.data_set.get_record_by_id(this.selected_ids[i]);if(!SG.schema.can_edit_field_on_record(rec,this.schema_field))
continue;var val=this.my_record.get(this.field);if(this.schema_field.data_type=='multi_entity')
{var update_mode=this.container.child('div.field_update_mode>select',true);update_mode=update_mode.value;rec.multi_entity_set(this.field,val,update_mode);}
else
rec.set(this.field,val);}
this.data_set.commit();}
this.destroy();},setup_my_record:function(){if(this.entity_type=='Task'&&this.field=='step')
{var entity_type=null;for(var i=0;i<this.selected_ids.length;i++)
{var rec=this.data_set.get_record_by_id(this.selected_ids[i]);var entity=rec.get('entity');if(!entity)
return;else if(entity_type!=entity.type)
{if(entity_type==null)
entity_type=entity.type;else
return;}}
if(entity_type!=null)
{entity.name='';this.my_record.set('entity',{name:'',type:entity_type,id:-1});}}},edit_permissions:function()
{var rec;var editable_count=0;for(i=0;i<this.selected_ids.length;i++)
{rec=this.data_set.get_record_by_id(this.selected_ids[i]);if(SG.schema.can_edit_field_on_record(rec,this.schema_field))
editable_count++;}
if(editable_count==0)
return'none';else if(editable_count==this.selected_ids.length)
return'all';else
return'mixed';},});SG.PagePermissionsDialog=function(config)
{Ext.apply(this,config);SG.PagePermissionsDialog.superclass.constructor.call(this);};Ext.extend(SG.PagePermissionsDialog,SG.NewDialog,{templates:{loading:"Loading...",permission_role:'<div class="role">{checkbox}<span class="role_name">{display_name}</span></div>',permissions:'<div class="prompt">Who can <b>see</b> the {page_pluralized}?</div>'+'<div>{roles}</div>'},init_dialog:function()
{if(this.page_title)
this.title="Edit Permissions on the <i>"+this.page_title+"</i> Page";else if(this.folder_path)
this.title="Edit Permissions on "+this.pages.length+" "+"Page".pluralize(this.pages.length);if(this.page_id)
this.page_ids=[this.page_id];else
{this.page_ids=[];for(var i=0;i<this.pages.length;i++)
this.page_ids.push(this.pages[i].id);}
this.css_class="page_permissions_dialog";if(this.on_cancel)
this.on_cancel.data=this.page_id;this.actions=[{label:'Cancel',type:'link',callback:this.on_cancel||null},{label:'OK',dont_close:true,callback:{fn:this.update_permissions,scope:this}}]
this.dialog_click={fn:this.on_dialog_click,scope:this};this.request_permissions();},render_body:function()
{if(!this.permissions)
return this.templates.loading.apply({});var roles=[];for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
{var role=SG.globals.human_user_permission_groups[i];var checkbox_id="page_permissions_"+role.id;var state=this.get_permission_state(role.id);disabled=(state=='checked'&&role.code==SG.globals.current_user.permission_rule_set.rule_set_code);roles.push(this.templates.permission_role.apply({code:role.code,display_name:role.display_name,checkbox:SG.Checkbox.render(checkbox_id,'page_permissions_checkbox',state,disabled,role.code)}));}
return this.templates.permissions.apply({roles:roles.join(''),page_pluralized:"page".pluralize(this.page_ids.length)});},get_permission_state:function(role_id)
{var denials=0;for(var i=0;i<this.page_ids.length;i++)
if(this.permissions.denied[this.page_ids[i]].indexOf(role_id)>-1)
denials++;if(denials==0)
return"checked";else if(denials==this.page_ids.length)
return"unchecked";else
return"dashed";},on_dialog_click:function(dialog,e)
{var target=Ext.get(e.target);if(target.hasClass("role_name"))
{SG.Checkbox.toggle(e.target.previousSibling);}},request_permissions:function()
{var params={page_ids:[]};if(this.page_id)
params.page_ids.push(this.page_id);else
{params.page_ids=[];for(var i=0;i<this.pages.length;i++)
{params.page_ids.push(this.pages[i].id);}}
params.page_ids=JSON.stringify(params.page_ids);var options={url:SG.globals.urls.get_page_permissions,params:params,callback:function(options,success,response){if(success){response=Ext.decode(response.responseText);this.permissions={denied:response.page_denied_permission_rule_sets};this.saved_permissions={denied:sg_deep_copy(response.page_denied_permission_rule_sets)};this.render();}
else
{}},scope:this};Ext.Ajax.request(options);},set_permission_rule_set_permissions:function(role_id,denied)
{var role_id_index;for(var i=0;i<this.page_ids.length;i++)
{role_id_index=this.permissions.denied[this.page_ids[i]].indexOf(role_id)
if(denied&&(role_id_index==-1))
{this.permissions.denied[this.page_ids[i]].push(role_id);}
else if(!denied&&(role_id_index>-1))
{this.permissions.denied[this.page_ids[i]].splice(role_id_index,1);}}},update_permissions:function()
{var denied_set_ids=[];for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
{var role=SG.globals.human_user_permission_groups[i];var checkbox_id="page_permissions_"+role.id;var state=SG.Checkbox.get_state(checkbox_id);if(state!="dashed")
this.set_permission_rule_set_permissions(role.id,(state=="unchecked"));}
var options={url:SG.globals.urls.set_page_permissions,params:{page_id:this.page_id,page_denied_permission_rule_sets:Ext.encode(this.permissions.denied)},callback:function(options,success,response)
{if(success)
{if(response.responseText=='successful')
{this.destroy();if(this.on_permissions_updated)
{this.on_permissions_updated.fn.call(this.on_permissions_updated.scope,this,this.page_id);}}
else
new SG.ServerErrorHandler().notify_user(response);}
else
{new SG.ServerErrorHandler().notify_user(response);}},scope:this};Ext.Ajax.request(options);}});SG.server_error=function(config)
{if(config&&config.connection_response&&config.connection_response.statusText&&config.connection_response.statusText=='communication failure'){config.connection_error=true;}
if(SG.server_error.dialog)
{SG.server_error.dialog.update(config);return SG.server_error.dialog;}
else
{SG.server_error.dialog=new SG.ServerErrorDialog(config);return SG.server_error.dialog;}}
SG.ServerErrorDialog=function(config)
{SG.ServerErrorDialog.superclass.constructor.call(this,config);};Ext.extend(SG.ServerErrorDialog,SG.NewDialog,{templates:{connection_error:"It seems that your internet connection has temporarily gone down. Please double check that your "+"connection is live, and then click the OK button below. <br><br>"+"If you were in the middle of making changes, we'll resubmit them to the server. Otherwise, "+"this dialog will just go away.<br><br>"+"<span style='font-weight:bold;'>Do not reload the page!</span><br>"+"Reloading can lead to the loss of unsaved changes. If problems continue, "+"please <a href='{support_email}'>contact support</a>. Sorry for the trouble!<br><br>"+"<div class='more_info closed'><span class='tip_target'><div class='tip arrow_closed_dark'></div>"+"Additional Info:</span><div class='additional_info'>{info}</div></div>",problem:"You just ran into a bug.  Sorry about that.  We've collected some info about the bug that will help "+'us fix it ASAP.  If you have 5 seconds, can you <a href="{support_email}">'+'send us the error details via email</a>?<br><br>'+"Thanks for your help, and sorry for the trouble.  Please reload the page at your earliest convenience."+'<br><br><div class="more_info closed"><span class="tip_target"><div class="tip arrow_closed_dark"></div>'+'Details:</span><div class="additional_info">{info}</div></div>',},init_dialog:function(){if(this.connection_error){this.actions=[{label:'OK',callback:{fn:this.resubmit_and_fire_dialog_submitted,scope:this},dont_close:true}];}else{this.actions=[{label:'OK'}];}
this.width='500px';this.css_class="sgd_server_error_dialog";this.on_first_render();this.dialog_click={fn:this.on_dialog_click,scope:this};},on_dialog_click:function(dialog,e){var target=Ext.get(e.target);var tip_target=target.findParent('span.tip_target',this.container.dom,true);if(tip_target){var more_info_div=tip_target.findParent('div.more_info',this.container.dom,true);var tip_icon=more_info_div.child('div.tip');if(more_info_div.hasClass('closed')){more_info_div.replaceClass('closed','open');tip_icon.replaceClass('arrow_closed_dark','arrow_open_dark');}else{more_info_div.replaceClass('open','closed');tip_icon.replaceClass('arrow_open_dark','arrow_closed_dark');}}},update:function(config)
{var time_string='';if(this.last_message)
{var hours=this.last_message_time.getHours();if(hours==0)
hours=12;if(hours>12)
hours=hours-12;var minutes=this.last_message_time.getMinutes();if(minutes<10)
minutes='0'+String(minutes);time_string=hours+":"+minutes+" - ";}
var html_msg=this.get_html_error_message(config.html_msg);this.messages.push(time_string+html_msg);var info_div=this.container.child('div.additional_info');info_div.update(this.messages.join('<br>'));},get_html_error_message:function(message){if(message)
return message;var return_msg="Unknown error connecting to server.";if(this.connection_response){if(this.connection_response.responseText){return_msg=this.connection_response.responseText;}
else if(this.connection_response.statusText=='communication failure'){return_msg="Lost connection to server.";}}
return return_msg;},on_first_render:function()
{this.html_msg=this.get_html_error_message(this.html_msg);this.messages=[this.html_msg];this.title='Oops!';var template,support_email;if(this.connection_error){support_email="mailto:"+SG.globals.preferences.feedback_email_address;template=this.templates.connection_error;}else{support_email=this.generate_problem_email();template=this.templates.problem;}
this.body=template.apply({support_email:support_email,info:this.html_msg});},generate_problem_email:function(){var mailto="mailto:support@shotgunsoftware.com?subject=Doh, found a bug!&body=";mailto+="%0AI encountered a bug! Here's the info from the bug error message:%0A%0A"
mailto+="Person: "+SG.globals.current_user.display_name+" ("+SG.globals.current_user.login+")%0A";mailto+="Page: "+document.location.href+"%0A";mailto+="Shotgun Version: "+SG.globals.shotgun_version+"%0A";mailto+="Browser: "+navigator.userAgent+"%0A%0A";mailto+="Error Details (sorry, this may look pretty scary):%0A%0A";var messages=this.messages.join('%0A');var regex=/(<([^>]+)>)/ig;var clean=messages.replace(regex,'');mailto+=clean;return mailto;},destroy_dialog:function()
{SG.server_error.dialog=null;},resubmit_and_fire_dialog_submitted:function(){SG.CellManager.resubmit_all_error_cells();if(this.dialog_submitted)
this.dialog_submitted.fn.call(this.dialog_submitted.scope);this.destroy();},});SG.NewCanvasTabDialog=function(config)
{Ext.apply(this,config);SG.NewCanvasTabDialog.superclass.constructor.call(this);};Ext.extend(SG.NewCanvasTabDialog,SG.NewDialog,{templates:{row:'<div class="row"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value">{value}</div></td></tr></table></div>',row_table:'<table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value">{value}</div></td></tr></table>',text_input:'<input type="text" setting="{setting}" value="{value}">',fake_menu:'<div class="fake_menu fake_input {menu_class}" value="{value}"><div class="menu_label">{menu_label}</div>'+'<img class="drop_down_arrow" src="/images/dropdown_arrow_small.png"></div>',entity_type_label:'<div class="sg_entity_icon_span icon_{entity_type}"></div>'+'<span class="entity_type_label">{entity_type_display_name}</span>',tab_type_label:'<div class="tab_type_icon {icon}"></div>'+'<span class="entity_type_label">{tab_type}</span>',},init_dialog:function()
{if(!this.title)
this.title='New Tab';this.css_class="new_canvas_tab_dialog";this.actions=[{label:'Cancel',type:'link',callback:this.on_cancel||null},{label:'Create Tab',type:'button',dont_close:true,callback:{fn:this.create_tab,scope:this}}]
this.dialog_click={fn:this.on_dialog_click,scope:this};this.tab_type='Grid View';this.entity_type='Asset';this.tab_name='Untitled Tab';this.mode_helper=new SG.util.EntityQueryModeHelper();this.after_render_callback={fn:this.after_dialog_render,scope:this};},tab_type_icons:{'Grid View':'icon_grid_view','Card View':'icon_card_view','Thumbnail View':'icon_thumbnail_view','Calendar View':'icon_calendar_view','Task View':'icon_Task','Canvas':'icon_Page','URL':'icon_tab_url','Two Pane':'icon_tab_two_pane',},tab_type_modes:{'Grid View':'list','Card View':'card','Thumbnail View':'thumb','Calendar View':'calendar','Task View':'sched','Canvas':null,'URL':null,'Two Pane':null,},render_body:function()
{var html=this.templates.row.apply({label:'Name:',value:this.templates.text_input.apply({setting:'name',value:this.tab_name})});html+=this.templates.row.apply({label:'Tab Type:',value:this.templates.fake_menu.apply({menu_class:'tab_type',value:this.tab_type,menu_label:this.templates.tab_type_label.apply({tab_type:this.tab_type,icon:this.tab_type_icons[this.tab_type]})})});if(['Canvas','URL','Two Pane'].indexOf(this.tab_type)==-1){var edn=SG.schema.entity_types[this.entity_type]['display_name'];html+=this.templates.row.apply({label:'Entity Type:',value:this.templates.fake_menu.apply({menu_class:'entity_type',value:this.entity_type,menu_label:this.templates.entity_type_label.apply({entity_type:this.entity_type,entity_type_display_name:edn})})});}
return html;},after_dialog_render:function(){if(!this.first_time_rendered){this.first_time_rendered=true;var name_input=this.container.child('input[setting="name"]');name_input.dom.select();name_input.focus();}},on_dialog_click:function(dialog,e)
{var target=Ext.get(e.target);var fake_menu=target.findParent('div.fake_menu',this.container.dom,true);if(fake_menu){if(fake_menu.hasClass('tab_type'))
this.show_tab_type_menu(fake_menu);else if(fake_menu.hasClass('entity_type'))
this.show_entity_type_menu(fake_menu);}},show_tab_type_menu:function(anchor_elem){if(!this.tab_type_menu){this.tab_type_menu=new SG.Menu({item_selected:{fn:this.on_tab_type_menu,scope:this},before_show:{fn:this.on_before_show_tab_type_menu,scope:this}});}
this.tab_type_menu.items=[];this.tab_type_menu.render();this.tab_type_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.tab_type_menu.show();},on_before_show_tab_type_menu:function(menu){var items=[];for(var tab_type in this.tab_type_icons){if(!this.tab_type_icons.hasOwnProperty(tab_type))continue;if(tab_type=='Canvas')
items.push({line:true});var mode=this.tab_type_modes[tab_type];var disabled=false;if(mode!=null&&this.mode_helper.disabled(this.entity_type,mode))
disabled=true;if(tab_type=='Two Pane'&&this.page.type!='detail')
disabled=true;items.push({html:tab_type,icon_name:this.tab_type_icons[tab_type],checked:tab_type==this.tab_type,value:tab_type,disabled:disabled});}
menu.items=items;menu.render();},re_render:function(){var me=this;setTimeout(function(){me.render();},0);},on_tab_type_menu:function(menu,menu_item)
{this.tab_type=menu_item.value;this.re_render();},show_entity_type_menu:function(anchor_elem){if(!this.entity_type_menu){this.entity_type_menu=new SG.Menu({menu_class:'new_canvas_tab_dialog',item_selected:{fn:this.on_entity_type_menu,scope:this},});}
var items=[];var entity_types=sg_deep_copy(SG.schema.leftnav_page_entity_types);for(var i=0;i<entity_types.length;i++)
{var entity_type=entity_types[i];var entity_type_hash=SG.schema.entity_types[entity_type];items.push({html:SG.Renderers.render_page_entity_type(entity_type),value:entity_type_hash.display_name,entity_type:entity_type});}
this.entity_type_menu.items=items;this.entity_type_menu.render();this.entity_type_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.entity_type_menu.show();},on_entity_type_menu:function(menu,menu_item){this.entity_type=menu_item.entity_type;var mode=this.tab_type_modes[this.tab_type];if(mode!=null){if(this.mode_helper.disabled(this.entity_type,mode))
this.tab_type=this.find_first_non_disabled_mode();}
this.re_render();},find_first_non_disabled_mode:function(){for(var tab_type in this.tab_type_modes){if(!this.tab_type_modes.hasOwnProperty(tab_type))continue;var mode=this.tab_type_modes[tab_type];if(!this.mode_helper.disabled(this.entity_type,mode))
return tab_type;}},create_tab:function()
{if(this.tab_type=='Canvas')
this.create_canvas_tab();else if(this.tab_type=='Two Pane'||this.tab_type=='Threaded Comments')
this.create_detail_tab();else
this.create_single_widget_tab();},empty_canvas_page_spec:{type:"SG.Widget.Canvas.Body",settings:{"rows":["row_1"]},children:{"row_1":{"type":"SG.Widget.Canvas.Row"}}},web_page_spec:{type:'SG.Widget.Iframe',settings:{}},get_tab_name:function(){var name_input=this.container.child('input[setting="name"]');return name_input.dom.value;},create_canvas_tab:function(){this.on_create_tab.fn.call(this.on_create_tab.scope,this.get_tab_name(),this.empty_canvas_page_spec);this.destroy();},create_single_widget_tab:function()
{if(this.tab_type=='URL'){this.on_create_tab.fn.call(this.on_create_tab.scope,this.get_tab_name(),this.web_page_spec);this.destroy();return;}
var params={widget_type:"SG.Widget.EntityQuery.EntityQueryPage",entity_type:this.context_entity.type,embedded_entity_type:this.entity_type,};if(this.project)
params.project_id=this.project.id;var mode=this.tab_type_modes[this.tab_type];var options={url:SG.globals.urls.tab_widget_spec,params:params,callback:function(options,success,response){if(success)
{var spec={};var str='spec = '+response.responseText+';';eval(str);spec.settings.embedded=false;spec.settings.mode=mode;this.on_create_tab.fn.call(this.on_create_tab.scope,this.get_tab_name(),spec);this.pi.hide();this.destroy();}},scope:this};this.pi=new SG.ProgressIndicator(this.container);this.pi.show();var conn=new Ext.data.Connection();conn.request(options);},create_detail_tab:function()
{var params={entity_type:this.context_entity.type,};var options={url:'/page/detail_tab_spec',params:params,callback:function(options,success,response){if(success)
{var spec={};var str='spec = '+response.responseText+';';eval(str);this.on_create_tab.fn.call(this.on_create_tab.scope,this.get_tab_name(),spec);this.pi.hide();this.destroy();}},scope:this};this.pi=new SG.ProgressIndicator(this.container);this.pi.show();var conn=new Ext.data.Connection();conn.request(options);},on_change:function(e){var t=e.getTarget();if(t.getAttribute("type")=="text")
{var setting=t.getAttribute('setting');if(!setting)return;if(setting=='name'){this.tab_name=t.value;}}},});SG.SavePageAsDialog=function(config)
{Ext.apply(this,config);SG.SavePageAsDialog.superclass.constructor.call(this);};Ext.extend(SG.SavePageAsDialog,SG.NewDialog,{templates:{row:'<div class="row"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value">{value}</div></td></tr></table></div>',field_value:'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'<div class="sg_cell_content {cutter}">{cell_content}</div></div>',},init_dialog:function()
{this.title='Save Page As';this.css_class="save_page_as_dialog";this.actions=[{label:'Cancel',type:'link',callback:this.on_cancel||null},{label:'Create Page',type:'button',dont_close:true,callback:{fn:this.create_page,scope:this}}]
if(!this.data_set){this.data_set=this.new_data_set('Page',this.on_load);this.fetch_page_data();}else{this.call_on_load_in_render_body=true;}},render_body:function()
{if(this.call_on_load_in_render_body){this.call_on_load_in_render_body=false;this.on_load();return;}
if(!this.data_set.is_loaded())
return'';var fields=this.get_fields();var html='';for(var i=0;i<fields.length;i++){var field=fields[i];var schema_field=SG.schema.get_field('Page',field);var cell=this.cell_manager.get_cell(field,{type:this.get_cell_type(schema_field)});var config=cell.render(this.record);var schema_field=SG.schema.get_field('Page',field);var display_name=schema_field.name==='project'?'Save in Project':schema_field.display_name;html+=this.templates.row.apply({label:display_name+':',value:this.templates.field_value.apply(config)});if(field=='folder'){var folder_text='Create nested folders by separating folder names with -> '+'( Example: Reports->Client )';html+=this.templates.row.apply({label:'',value:folder_text});}}
return html;},get_cell_type:function(schema_field){if(typeof schema_field.editor==="string")
return SG.FakeInputCell;else if(schema_field.data_type==='url')
return SG.UrlCell;else if(schema_field.large_text_entry&&schema_field.data_type==='text')
return SG.LargeTextAreaCell;else if(schema_field.data_type==='text')
return SG.FakeInputCell;else
return SG.FakeInputCell;},get_fields:function(){if(SG.globals.current_user.can_save_as_project_page)
return['name','project','description','tag_list','folder'];else
return['name','description','tag_list','folder'];},fetch_page_data:function(){this.pi=new SG.ProgressIndicator();this.pi.show();var spec={type:'Page',id:this.page.id,columns:this.get_fields(),result:this.data_set};SG.Repo.find(spec);},on_load:function(){if(this.pi)this.pi.hide();var old_rec=this.data_set.get_record(0);var project=old_rec.get('project');this.record=this.data_set.copy_record(old_rec);var config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:project?[project]:[],in_form:true,get_fields_callback:{fn:this.get_fields,scope:this},};this.cell_manager=new SG.CellManager(config);this.re_render();var me=this;setTimeout(function(){me.edit_first_field()},0);},re_render:function(){var me=this;setTimeout(function(){me.render();},0);},create_page:function()
{this.on_create_page.fn.call(this.on_create_page.scope,this.record);this.destroy();},edit_cell:function(cell)
{var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="'+cell.field+'"]';var cell_elem=sg_find(sel,this.container.dom);if(cell_elem){cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});}},edit_first_field:function()
{var fields=this.get_fields();var cell=this.cell_manager.get_cell(fields[0]);if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}},});SG.PushProjectPagesDialog=function(config)
{Ext.apply(this,config);SG.PushProjectPagesDialog.superclass.constructor.call(this);};Ext.extend(SG.PushProjectPagesDialog,SG.NewDialog,{templates:{body:'<div class="message">{prompt}</div>{project_menu}{checkboxes}',row:'<div class="row {row_class}"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value">{value}</td></tr></table></div>',project_menu:'<div class="fake_menu fake_input" project_id="{project_id}"><div class="menu_label">{label}</div>'+'<img class="drop_down_arrow" src="/images/dropdown_arrow_small.png"></div>',checkbox:'<input type="checkbox" id="{checkbox_id}" {state}>'+'<label for="{checkbox_id}">{checkbox_label}</label>',},init_dialog:function()
{this.css_class="push_project_pages_dialog";this.copy_reports=this.copy_detail_pages=this.copy_project_nav=true;this.mode=this.source_project_id?'push':'revert';this.title='Push Project Configuration';var action_button_label='Push Configuration';if(this.mode=='revert'){this.title='Revert Project Configuration';action_button_label='Revert Configuration';}
this.actions=[{label:'Cancel',type:'link',callback:this.on_cancel||null},{label:action_button_label,type:'button',dont_close:true,callback:{fn:this.on_copy_pages,scope:this}}]
this.dialog_click={fn:this.on_dialog_click,scope:this};this.data_set=this.new_data_set('Project',this.on_load);this.fetch_project_data();},render_body:function()
{if(!this.data_set.is_loaded())
return'';var prompt=this.mode==='revert'?'Choose a project to copy configuration from and which aspects of the configuration to copy.':'Choose a project to update with the current project configuration.';return this.templates.body.apply({prompt:prompt,project_menu:this.render_project_menu(),checkboxes:this.render_checkboxes()});},render_project_menu:function(){return this.templates.row.apply({label:'Project:',value:this.templates.project_menu.apply({project_id:this.selected_project.id,label:this.selected_project.name}),row_class:'project_menu'});},re_render_project_menu:function(){var div=this.container.child('div.row.project_menu');Ext.DomHelper.insertAfter(div.dom,this.render_project_menu());div.remove();},render_checkboxes:function(){var h=this.templates.row.apply({label:'Copy:',value:this.templates.checkbox.apply({checkbox_id:'sg_push_projects_dialog_project_nav',checkbox_label:'Project Navigation Pages',state:this.copy_project_nav?'checked="true"':'',})});h+=this.templates.row.apply({label:'&nbsp;',value:this.templates.checkbox.apply({checkbox_id:'sg_push_projects_dialog_detail_pages',checkbox_label:'Record Detail Pages',state:this.copy_detail_pages?'checked="true"':'',})});h+=this.templates.row.apply({label:'&nbsp;',value:this.templates.checkbox.apply({checkbox_id:'sg_push_projects_dialog_reports',checkbox_label:'Custom Pages',state:this.copy_reports?'checked="true"':'',})});return h;},fetch_project_data:function(){this.pi=new SG.ProgressIndicator();this.pi.show();var spec={type:'Project',id:this.mode=='revert'?this.target_project_ids[0]:this.source_project_id,columns:['name','layout_project'],result:this.data_set};SG.Repo.find(spec);},on_load:function(){this.pi.hide();var first_record=this.data_set.get_record(0);var layout_project=first_record.get('layout_project');this.selected_project=this.find_default_selected_project();for(var i=0;i<layout_project&&SG.schema.projects.length;i++){var proj=SG.schema.projects[i];if(proj.id==layout_project.id){this.selected_project=proj;break;}}
this.re_render();},find_default_selected_project:function(){for(var i=0;i<SG.schema.projects.length;i++){var proj=SG.schema.projects[i];if(this.mode=='push'&&proj.id!=this.source_project_id)
return proj;if(this.mode=='revert'&&this.target_project_ids.indexOf(proj.id)==-1)
return proj;}
alert('There are no other projects to push to or revert from');this.pi.hide();this.destroy();},on_dialog_click:function(dialog,e)
{var target=Ext.get(e.target);var fake_menu=target.findParent('div.fake_menu',this.container.dom,true);if(fake_menu){this.show_project_menu(fake_menu);}},show_project_menu:function(anchor_elem){if(!this.projects_menu){this.projects_menu=new SG.Menu({item_selected:{fn:this.on_project_selected,scope:this},});}
var items=[];for(var i=0;i<SG.schema.projects.length;i++){var proj=SG.schema.projects[i];if((this.mode=='push'&&proj.id!=this.source_project_id)||(this.mode=='revert'&&this.target_project_ids.indexOf(proj.id)==-1)){items.push({html:proj.name,proj:proj,checked:proj.id==this.selected_project.id});}}
this.projects_menu.items=items;this.projects_menu.render();this.projects_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.projects_menu.show();},on_project_selected:function(menu,menu_item){this.selected_project=menu_item.proj;this.re_render_project_menu();},re_render:function(){var me=this;setTimeout(function(){me.render();},0);},on_copy_pages:function(){if(!this.copy_reports&&!this.copy_detail_pages&&!this.copy_project_nav){alert('You have not selected any page types to be copied !');return;}
if(this.mode=='push')
this.target_project_ids=[this.selected_project.id];else
this.source_project_id=this.selected_project.id;var params={source_project_id:this.source_project_id,target_project_ids:Ext.encode(this.target_project_ids),copy_reports:this.copy_reports,copy_detail_pages:this.copy_detail_pages,copy_project_nav:this.copy_project_nav};var jump_to_project_id=this.jump_to_project_landing_page_when_done?this.target_project_ids[0]:null;var options={url:'/page/push_project_pages',params:params,callback:function(options,success,response){if(success){if(jump_to_project_id)
window.location='/detail/Project/'+jump_to_project_id;else
window.location=window.location.href;}},scope:this};this.pi=new SG.ProgressIndicator(this.container);this.pi.show();var conn=new Ext.data.Connection();conn.request(options);},on_change:function(e){var t=e.getTarget();if(t.getAttribute("type")=="checkbox")
{var id=t.getAttribute('id');if(id=='sg_push_projects_dialog_project_nav'){this.copy_project_nav=t.checked;}else if(id=='sg_push_projects_dialog_detail_pages'){this.copy_detail_pages=t.checked;}else{this.copy_reports=t.checked;}}},});SG.ChangePasswordDialog=function(config)
{Ext.apply(this,config);SG.ChangePasswordDialog.superclass.constructor.call(this);};Ext.extend(SG.ChangePasswordDialog,SG.NewDialog,{templates:{body:'<div class="message">{message}</div>'+'<div class="password_validator"></div>{toggle}{email_check}',temp_password:'<span class="temp_password">Use a temporary password</span>',set_password:'Use a temporary password<span class="set_password">Set password</span>',email_check:'<div class="email">{checkbox}<div class="icon_email_password"></div>'+'<span class="email_check_label">Send a welcome email</span></div>',},messages:{password_weak:"We've updated our minimum password requirements in collaboration with the major studios and "+"the MPAA to ensure your production data is secure.  Please create a stronger password.",requested:"An admin has requested that you choose a new password. Please pick a new one:",first_login:"Welcome to Shotgun! Please create a new password:"},init_dialog:function()
{this.title='New Password';this.css_class="change_password_dialog";this.width="515px";this.actions=[];if(this.allow_cancel)
this.actions.push({label:'Cancel',type:'link',callback:this.on_cancel||null});this.actions.push({label:'Save',type:'button',dont_close:true,callback:{fn:this.save_password,scope:this}});this.dialog_click={fn:this.on_dialog_click,scope:this};this.after_render_callback={fn:this.after_dialog_render,scope:this};this.data_set=this.new_data_set('HumanUser',this.on_data_load,this.on_data_change);this.fetch_user();},fetch_user:function(){var spec={type:'HumanUser',id:this.user_id,columns:['id','password_proxy','password_change_next_login'],result:this.data_set};SG.Repo.find(spec);},on_data_load:function(){},on_data_change:function(changes){for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='server'&&change.type=='update'&&change.column=='password_proxy'){this.send_email_and_close();return;}}},send_email_and_close:function(){if(!this.extra_controls_visible()){this.all_done();return;}
var state=SG.Checkbox.get_state('password_email_toggle');if(state!='checked'){this.all_done();return;}
var record=this.data_set.get_record(0);SG.send_welcome_email(record.id,this.password,true,{fn:this.all_done,scope:this});},all_done:function(){alert('Password change successful!');if(SG.globals.current_user.password_change_required)
window.location.reload(true);else
this.destroy();},render_body:function()
{var message='';if(SG.globals.current_user.password_change_required&&SG.globals.current_user.password_change_reason)
message=this.messages[SG.globals.current_user.password_change_reason];var html=this.templates.body.apply({message:message,toggle:this.render_toggle(),email_check:this.render_email_check(),});return html;},extra_controls_visible:function(){return(!this.require_current_password&&this.show_email_and_temp_password_controls);},render_toggle:function(){if(!this.extra_controls_visible())return'';var message=this.start_with_temp_password?this.templates.set_password.apply():this.templates.temp_password.apply();return'<div class="toggle">'+message+'</div>';},render_email_check:function(){if(!this.extra_controls_visible())return'';return this.templates.email_check.apply({checkbox:SG.Checkbox.render('password_email_toggle',null,'checked',null,'password_email'),});},after_dialog_render:function(){if(!this.first_time_rendered){this.first_time_rendered=true;if(this.opaque_dialog_mask)
this.container.addClass('opaque_mask');if(!this.start_with_temp_password){var password_validator_container=this.container.child('div.password_validator');this.password_validator=new SG.PasswordValidator({container:password_validator_container,require_current_password:this.require_current_password});this.password_validator.set_focus();}
this.center_dialog();}},on_dialog_click:function(dialog,e)
{var target=Ext.get(e.target);var temp_password=target.findParent('span.temp_password',this.container.dom);if(temp_password){this.password_validator.destroy();this.password_validator=null
var password_validator_container=this.container.child('div.password_validator');password_validator_container.update('');var toggle=this.container.child('div.toggle');toggle.update(this.templates.set_password.apply());return;}
var set_password=target.findParent('span.set_password',this.container.dom);if(set_password){var password_validator_container=this.container.child('div.password_validator');this.password_validator=new SG.PasswordValidator({container:password_validator_container,require_current_password:this.require_current_password});var toggle=this.container.child('div.toggle');toggle.update(this.templates.temp_password.apply());this.password_validator.set_focus();return;}},save_password:function()
{if(this.password_validator&&SG.globals.preferences.enforce_strong_passwords){var message=this.password_validator.password_issue_message();if(message!=null){alert(message);return;}}
if(this.require_current_password)
this.validate_current_password();else
this.set_and_commit_record();},validate_current_password:function(){var current_password=this.password_validator.get_current_password();var options={url:'/user/validate_current_password',params:{password:current_password,},callback:function(options,success,response){if(success){if(response.responseText=='FAIL')
alert('Your current password is not correct. Please rectify.');else
this.set_and_commit_record();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},set_and_commit_record:function(){this.password=SG.create_temp_password();var strength='70';if(this.password_validator){this.password=this.password_validator.get_password();strength=this.password_validator.get_password_strength();}
var pi=new SG.ProgressIndicator(this.container);pi.show();var record=this.data_set.get_record(0);record.set('password_proxy',this.password);record.set('password_change_next_login',false);record.set('password_strength',strength);record.commit(true);},});SG.KeyboardShortcutsDialog=function(config)
{Ext.apply(this,config);SG.KeyboardShortcutsDialog.superclass.constructor.call(this);};SG.KeyboardShortcutsDialog.handle_shortcuts=function(e,shortcuts){if(e.shortcut_handled)
return;if(e.target.nodeName=='TEXTAREA'||(e.target.nodeName=='INPUT'&&e.target.getAttribute('type')!='button'))
return;if(Ext.get(e.target).findParent('.sg_focusable',10))
return;if(sg_find('div.sg_dialog_mask',document.body))
return;var key_id=e.getKey();var shift_key=is_shift_click(e);var ctrl_key=is_ctrl_click(e);var alt_key=is_alt_click(e);var is_keydown=(e.type=='keydown');if((is_keydown&&key_id!=Ext.EventObject.ESC)||(!is_keydown&&key_id==Ext.EventObject.ESC))
return;for(var i=0;i<shortcuts.length;i++){if(shortcuts[i].callback&&shortcuts[i].shift==shift_key&&shortcuts[i].ctrl==ctrl_key&&shortcuts[i].alt==alt_key&&(shortcuts[i].key_code==key_id||(key_id>96&&key_id<123&&(shortcuts[i].key_code+32==key_id))))
{e.stopEvent();if(SG.KeyboardShortcutsDialog.is_showing)
SG.KeyboardShortcutsDialog.is_showing.destroy();shortcuts[i].callback.fn.call(shortcuts[i].callback.scope,shortcuts[i]);return true;}}
return false;};Ext.extend(SG.KeyboardShortcutsDialog,SG.NewDialog,{templates:{dialog_container:'<div class="sg_dialog_mask sg_new_dialog {dialog_class}"><div></div></div>',dialog:'<div class="sg_dialog keyboard_shortcuts" style="{style}">'+'<div class="header">{title} ({platform})'+'<div class="keyboard_shortcut_close">'+'<span class="keyboard_shortcut_close">Close</span> (esc)</div></div>'+'<div class="main">{shortcuts}</div>'+'</div>',shortcut:'<table><tr><td class="shortcut"><div class="shortcut">{key}</div></td>'+'<td class="description"><div class="description">{description}</div></td></tr></table>',key:'<span class="key">{html}</span>'},init_dialog:function()
{this.css_class='sgd_keyboard_shortcuts';if(!this.title)
this.title="Keyboard Shortcuts";this.platform=Ext.isMac?'Mac':Ext.isLinux?'Linux':'PC';},render:function(){SG.KeyboardShortcutsDialog.is_showing=this;if(!this.container)
{this.container=this.templates.dialog_container.append(document.body,{dialog_class:this.css_class});this.container=Ext.get(this.container);}
var style='width:'+(this.width||'400px')+'; ';if(this.height)
style+='height:'+this.height+'; ';var shortcut_html=[];for(var i=0;i<this.shortcuts.length;i++){shortcut_html.push(this.render_shortcut(this.shortcuts[i]));}
var content=this.templates.dialog.apply({style:style,title:this.title,platform:this.platform,shortcuts:shortcut_html.join('')});this.container.dom.innerHTML=content;this.dialog=Ext.get(this.container.dom.firstChild);this.body_dom=this.dialog.dom.firstChild.nextSibling;this.center_dialog();},destroy_dialog:function(){SG.KeyboardShortcutsDialog.is_showing=null;},center_dialog:function(){this.dialog.setXY(this.dialog.getCenterXY(true));},on_click:function(e){var t=Ext.get(e.target);if(t.findParent("span.keyboard_shortcut_close",this.container)){this.destroy();}
if(!t.findParent("div.sg_dialog.keyboard_shortcuts")){this.destroy();}},on_keydown:function(e){if(e.browserEvent.keyCode==Ext.EventObject.ESC)
this.destroy();},render_shortcut:function(shortcut_hash){if(!shortcut_hash.description)return'';var elements=[];if(shortcut_hash.ctrl)
elements.push(Ext.isMac?"&#x2318;":"Ctrl");if(shortcut_hash.alt)
elements.push(Ext.isMac?"option":"alt");if(shortcut_hash.shift)
elements.push('shift');elements.push(this.display_text_for(shortcut_hash));for(var i=0;i<elements.length;i++)
elements[i]=this.templates.key.apply({html:elements[i]});return this.templates.shortcut.apply({key:elements.join(''),description:shortcut_hash.description});},display_text_for:function(shortcut){switch(shortcut.key_code){case Ext.EventObject.UP:return'up arrow';case Ext.EventObject.DOWN:return'down arrow';case Ext.EventObject.TAB:return'tab';case Ext.EventObject.BACKSPACE:return'delete';case Ext.EventObject.ESC:return'esc';case 191:if(shortcut.shift)
return'?';else
return'/';}
return String.fromCharCode(shortcut.key_code).toLowerCase();}});SG.ConditionGroup=function(config)
{Ext.apply(this,config);SG.ConditionGroup.superclass.constructor.call(this);};SG.ConditionGroup.default_condition=function(entity_type,path)
{return{logical_operator:'and',conditions:[SG.ConditionRow.default_condition(entity_type,path)]};};SG.ConditionGroup.last_group_id=0;SG.ConditionGroup.array_valued_editor_types=["list","multi_list","status_list","multi_status_list","entity","multi_entity"];SG.ConditionGroup.comma_separated_editor_types=["text","number","float","percent","currency"];SG.ConditionGroup.negative_filter_types=["is_not","type_is_not","not_contains","name_not_contains"];Ext.extend(SG.ConditionGroup,SG.Component,{templates:{group:'<div class="condition_group {group_type}" group_id="{group_id}">{header}<div>{subgroups}</div>'+'<table class="condition_group_table">{rows}</table></div>'+'<div class="condition_group_editor_dump"></div>',parent_with_lone_subgroup:'<div class="condition_group parent_with_lone_subgroup {group_type}" '+'group_id="{group_id}">{subgroups}</div>',header:'<div class="condition_group_header">{match_text}'+'<select class="condition_all_any_select" group_id="{group_id}">'+'<option value="and" {and_selected}>all</option><option value="or" {or_selected}>any</option>'+'</select>'+'of the following {entity_type} conditions:'+'<span class="condition_subgroup_controls">{subgroup_controls}</span>'+'</div>',single_project_filter_mode_header:'',lone_subgroup_controls:'<span class="condition_add_subgroup">[+] Add new filter group</span>',sibling_subgroup_controls:'<img class="condition_remove_subgroup" src="{image_url}"></img>',row:'<tr id="condition_row_{group_id}_{index}" row_index="{index}"></tr>',subgroup:'<div id="condition_subgroup_{group_id}_{index}" class="condition_subgroup {siblings}"></div>',no_rows:'<tr><td>{button}</td></tr>',short_match_prompt:'Match',long_match_prompt:'Show <span class="entity_type_name">{entity_pluralized}</span> which match'},init_component:function()
{this.group_id=(++SG.ConditionGroup.last_group_id);this.condition=sg_deep_copy(this.condition);if(!this.group_type)
this.group_type='top_group';var editable_conditions=[];this.rows=[];this.subgroups=[];this.row_count=0;this.subgroup_count=0;for(var i=0;i<this.condition.conditions.length;i++)
{var editable_condition=this.get_editable_condition(this.condition.conditions[i]);if(editable_condition)
{editable_conditions.push(editable_condition);if(editable_condition.conditions)
{this.subgroup_count++;this.subgroups[i]=this.create_new_subgroup(editable_condition,i);this.rows[i]=null;}
else
{this.row_count++
this.rows[i]=this.create_new_row(editable_condition,i);this.subgroups[i]=null;}}}
this.condition.conditions=editable_conditions;},destroy_component:function()
{if(this.global_scroll_proxy)
document.body.removeEventListener('scroll',this.global_scroll_proxy,true);},get_condition:function()
{this.apply_edit();var condition=sg_deep_copy(this.condition);var saveable_conditions=[];for(var i=0;i<condition.conditions.length;i++)
{var saveable_condition;if(condition.conditions[i].conditions)
saveable_condition=this.subgroups[i].get_condition();else
saveable_condition=this.get_saveable_condition(condition.conditions[i]);if(saveable_condition)
{saveable_conditions.push(saveable_condition);}}
condition.conditions=saveable_conditions;return condition;},get_editable_condition:function(condition)
{var field_info;if(condition.qb_multivalued_condition_subgroup)
{field_info=this.field_info_for(condition.conditions[0].path);if(!field_info)
return null;var multi_valued_type=this.multi_valued_type(field_info,condition.conditions[0]);if(!multi_valued_type)
return null;var values=[];for(var i=0;i<condition.conditions.length;i++)
values.push(condition.conditions[i].values[0]);if(multi_valued_type=='array')
values=[values];else if(multi_valued_type=='string')
values=[values.join(',')];return{path:condition.conditions[0].path,active:condition.conditions[0].active,relation:condition.conditions[0].relation,values:values};}
else if(condition.conditions)
{return condition;}
else
{field_info=this.field_info_for(condition.path);if(!field_info)
return null;if(this.multi_valued_type(field_info,condition)=='array')
{if(condition.values[0]!==null)
condition.values[0]=[condition.values[0]];else
condition.values[0]=[];}
return condition;}},multi_valued_type:function(field_info,condition)
{if(field_info.data_type=='entity'&&field_info.editor=='step_list')
return false;if(condition.top_level_project_filter)
return false;var editor_data_type=SG.ConditionValue.editor_data_type(field_info.data_type,condition);if(SG.ConditionGroup.array_valued_editor_types.indexOf(editor_data_type)>-1){return'array';}else if(SG.ConditionGroup.comma_separated_editor_types.indexOf(editor_data_type)>-1&&['greater_than','less_than','between'].indexOf(condition.relation)==-1)
{return'string';}
else{return false;}},get_saveable_condition:function(condition)
{var field_info=this.field_info_for(condition.path);if(condition.values.length>1)
return condition;var multi_valued_type=this.multi_valued_type(field_info,condition);if(multi_valued_type)
{var values=condition.values[0];if(multi_valued_type=='string')
values=(values===null?[""]:values.toString().split(/\s*,\s*/));else if(!values||values.length==0)
values=[null];if(values.length<2)
{condition.values=values;return condition;}
var conditions=[];for(var i=0;i<values.length;i++)
{conditions.push({path:condition.path,active:condition.active,relation:condition.relation,values:[values[i]]});}
return{logical_operator:(SG.ConditionGroup.negative_filter_types.indexOf(condition.relation)>-1)?"and":"or",conditions:conditions,qb_multivalued_condition_subgroup:true,active:condition.active};}
else
return condition;},field_info_for:function(path)
{return SG.schema.get_field(this.entity_type,path);},create_new_row:function(condition,index)
{return this.new_component(SG.ConditionRow,{group:this,container:'condition_row_'+this.group_id+"_"+index,edit_container:this.edit_container,condition:condition,entity_type:this.entity_type,single_project_filter_mode:this.single_project_filter_mode,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget});},create_new_subgroup:function(condition,index)
{return this.new_component(SG.ConditionGroup,{parent_group:this,container:'condition_subgroup_'+this.group_id+"_"+index,edit_container:this.edit_container,condition:condition,entity_type:this.entity_type,show_entity_type_display_name:this.show_entity_type_display_name,single_project_filter_mode:this.single_project_filter_mode,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget,context_projects:this.context_projects,default_field_path:this.default_field_path,no_multi_valued_fields:this.no_multi_valued_fields,column_display_names:this.column_display_names,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,omit_filter_types:this.omit_filter_types,group_type:'lone_subgroup'});},render:function()
{if(this.group_type=='top_group'&&this.condition.conditions.length==0)
this.add_subgroup(true);if(typeof this.container=='string')
{this.container=Ext.get(this.container);if(!this.container)
return;this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);var me=this;this.global_scroll_proxy=function(e){me.on_global_scroll(e);};document.body.addEventListener('scroll',this.global_scroll_proxy,true);}
var parent_with_lone_subgroup=(this.group_type=='top_group'&&this.row_count==0&&this.subgroup_count==1);var row_html=[];var subgroup_html=[];for(var i=0;i<this.condition.conditions.length;i++)
{if(this.condition.conditions[i].conditions)
subgroup_html.push(this.templates.subgroup.apply({group_id:this.group_id,index:i,siblings:(!parent_with_lone_subgroup)?'siblings':''}));else
row_html.push(this.templates.row.apply({group_id:this.group_id,index:i}));}
if(this.group_type!='top_group'&&row_html.length==0)
{row_html.push(this.templates.no_rows.apply({button:SG.ImageButton.render({up:'plus_button_round',pressed:'plus_button_round_down',extra_classes:'no_rows_plus_button'})}));}
var is_and=(this.condition.logical_operator=='and');var subgroup_controls=(this.group_type=='sibling_subgroup')?this.templates.sibling_subgroup_controls.apply({image_url:SG.globals.icons.OverlayClose}):this.templates.lone_subgroup_controls.apply({});var match_text=this.templates.short_match_prompt.apply({});if(!this.short_match_prompt_only&&['top_group','lone_subgroup'].indexOf(this.group_type)>-1){match_text=this.templates.long_match_prompt.apply({entity_pluralized:SG.schema.entity_types[this.entity_type].display_name_pluralized});}
var header_template=this.single_project_filter_mode?'single_project_filter_mode_header':'header';header_html=this.templates[header_template].apply({match_text:match_text,and_selected:is_and?'selected':'',or_selected:is_and?'':'selected',entity_type:this.show_entity_type_display_name?SG.schema.entity_types[this.entity_type].display_name:'',subgroup_controls:subgroup_controls,group_id:this.group_id});var main_template='group';if(parent_with_lone_subgroup)
main_template='parent_with_lone_subgroup';this.container.dom.innerHTML=this.templates[main_template].apply({group_id:this.group_id,group_type:this.group_type,header:header_html,subgroups:subgroup_html.join(''),rows:row_html.join('')});for(var i=0;i<this.condition.conditions.length;i++)
{if(this.rows[i])
{this.rows[i].container='condition_row_'+this.group_id+"_"+i;this.rows[i].render();}
if(this.subgroups[i])
{this.subgroups[i].container='condition_subgroup_'+this.group_id+"_"+i;this.subgroups[i].group_type=parent_with_lone_subgroup?'lone_subgroup':'sibling_subgroup';this.subgroups[i].render();}}
this.condition_group_editor_dump=this.container.child('div.condition_group_editor_dump',true);},on_click:function(evt)
{var target=Ext.get(evt.getTarget());var target_group_container=target.findParent('div.condition_group');if(!target_group_container||target_group_container.getAttribute('group_id')!=this.group_id)
return;var row=target.findParent('tr.condition_row');if(row)
var index=Number(row.getAttribute('row_index'));if(row&&target.hasClass('condition_plus_button'))
{this.insert_row(index);}
else if(row&&target.hasClass('condition_minus_button'))
{this.delete_row(index);}
else if(row)
{this.rows[index].on_click(target);}
else if(target.hasClass('no_rows_plus_button'))
{this.insert_row(null);}
else if(target.hasClass('condition_add_subgroup'))
{if(this.group_type=='lone_subgroup')
this.parent_group.add_subgroup();else
this.add_subgroup();}
else if(target.hasClass('condition_remove_subgroup'))
{this.parent_group.remove_subgroup(this);}},editor_return_key_pressed:function()
{if(this.parent_group)
this.parent_group.editor_return_key_pressed();else if(this.editor_return_key_pressed_callback)
this.editor_return_key_pressed_callback.fn.call(this.editor_return_key_pressed_callback.scope);},on_change:function(evt)
{var target=Ext.get(evt.getTarget());if(target.hasClass('condition_all_any_select')&&target.dom.getAttribute("group_id")==this.group_id)
{this.condition.logical_operator=target.dom.value;this.condition_changed();}},insert_row:function(index)
{var condition;if(index!=null)
{condition=sg_deep_copy(this.condition.conditions[index]);condition.active='true';index+=1;}
else
{index=this.condition.conditions.length;condition=SG.ConditionRow.default_condition(this.entity_type,this.default_field_path,this.use_these_filter_tokens,this.token_context_widget);}
this.condition.conditions.splice(index,0,condition);this.rows.splice(index,0,this.create_new_row(condition,index));this.row_count++;this.subgroups.splice(index,0,null);this.render();this.condition_changed();},delete_row:function(index)
{var row=this.rows[index];this.condition.conditions.splice(index,1);this.rows.splice(index,1);this.row_count--;this.subgroups.splice(index,1);row.destroy();this.render();this.condition_changed();},add_subgroup:function(no_render)
{if(this.group_type=='top_group'&&this.row_count>0&&this.subgroup_count==0)
{var regroup=this.get_condition();for(var i=0;i<this.rows.length;i++)
if(this.rows[i])
this.rows[i].destroy();this.condition.logical_operator='and';this.condition.conditions=[regroup];this.rows=[null];this.subgroups=[this.create_new_subgroup(regroup,0)];this.row_count=0;this.subgroup_count=1;}
var condition;index=this.condition.conditions.length;condition={'logical_operator':'and','conditions':[]};this.condition.conditions.splice(index,0,condition);this.subgroups.splice(index,0,this.create_new_subgroup(condition,index));this.subgroup_count++;this.rows.splice(index,0,null);if(!no_render)
{this.render();this.condition_changed();}},remove_subgroup:function(subgroup_component)
{var index=this.subgroups.indexOf(subgroup_component);this.condition.conditions.splice(index,1);this.subgroups.splice(index,1);this.subgroup_count--;this.rows.splice(index,1);subgroup_component.destroy();this.render();this.condition_changed();},condition_changed:function()
{if(this.notifying)
return;this.notifying=true;if(this.parent_group)
{this.parent_group.condition_changed();}
else if(this.condition_changed_callback)
{this.apply_edit();this.condition_changed_callback.fn.call(this.condition_changed_callback.scope);}
this.notifying=false;},set_column_menu_items:function(menu)
{var i;var categorized_fields=SG.schema.get_categorized_fields(menu.entity_class_name,false,false);this.add_column_menu_items(menu,categorized_fields.ordinary);if(!this.no_multi_valued_fields&&categorized_fields.pivot_column_fields.length>0){menu.items.push({heading:"PIPELINE"});this.add_pipeline_menu_items(menu,SG.schema.get_pipeline_order_fields(menu.entity_class_name));}
if(categorized_fields.dependency.length>0)
{categorized_fields.dependency.sort(function(a,b){if(a.absolute_sort_order>b.absolute_sort_order)return 1;if(a.absolute_sort_order<b.absolute_sort_order)return-1;return 0;});menu.items.push({heading:"DEPENDENCIES"});this.add_column_menu_items(menu,categorized_fields.dependency,true);}
if(categorized_fields.audit.length>0)
menu.items.push({heading:"AUDIT FIELDS"});this.add_column_menu_items(menu,categorized_fields.audit);if(categorized_fields.smart_cut.length>0)
menu.items.push({heading:"SMART FIELDS"});this.add_column_menu_items(menu,categorized_fields.smart_cut);if(this.through_join_fields&&this.parent_entity){var parent_entity_type_name=SG.schema.entity_types[this.parent_entity.type].display_name;var multiple_through_joins=(this.through_join_fields.length>1);for(i=0;i<this.through_join_fields.length;i++)
{var parent_entity_link_field=this.through_join_fields[i].parent_entity_link_field;var group_title=parent_entity_type_name.toUpperCase()+"-SPECIFIC FIELDS";if(multiple_through_joins)
group_title+=": for "+parent_entity_link_field.display_name;menu.items.push({heading:group_title});this.add_column_menu_items(menu,this.through_join_fields[i].fields);}}
if(categorized_fields.association.length>0)
{menu.items.push({heading:"LINKED FIELDS"});var fields=SG.schema.locally_sorted_fields(this.column_display_names,categorized_fields.association,menu.column_path);for(i=0;i<fields.length;i++)
{var field=fields[i];if(field.no_deep_filtering||field.no_filtering)
continue;if(this.no_multi_valued_fields&&field.data_type!='entity')
continue;var allowed_entity_types=SG.schema.allowed_entity_types(field);var submenu_properties;if(allowed_entity_types.length==1)
submenu_properties={before_first_render:{fn:this.set_column_menu_items,scope:this},column_path:menu.column_path+field.name+'.'+allowed_entity_types[0]+'.',entity_class_name:allowed_entity_types[0]};else
submenu_properties={column_path:menu.column_path+field.name+'.',entity_class_names:SG.schema.allowed_entity_types(field),before_first_render:{fn:this.set_entity_type_menu_items,scope:this}};var display_name=SG.schema.local_display_name(this.column_display_names,field,menu.column_path+field.name);menu.items.push({html:display_name,submenu:submenu_properties,});}}},add_column_menu_items:function(menu,fields,do_not_sort_fields)
{if(!do_not_sort_fields)
fields=SG.schema.locally_sorted_fields(this.column_display_names,fields,menu.column_path);var schema_field;for(var i=0;i<fields.length;i++)
{var schema_field=fields[i];if(schema_field.name==='filmstrip_image')
continue;var column_path=menu.column_path+(schema_field.field_reference_name||schema_field.name);var display_name=SG.schema.local_display_name(this.column_display_names,schema_field,column_path);menu.items.push({html:display_name,disabled:(schema_field.no_filtering||schema_field.data_type=='url'),column_path:column_path});}},add_pipeline_menu_items:function(menu,fields)
{var i,step,field;var step_map={};var steps=SG.schema.get_pipeline_order_steps(menu.entity_class_name);for(i=0;i<steps.length;i++)
{var step=steps[i];var key='step_'+step.id;step_map[key]=step;}
for(i=0;i<fields.length;i++){field=fields[i];step=step_map[field.name];menu.items.push({html:field.display_name,column_path:menu.column_path+field.name,icon_name:'transparent_step_color',icon_bg_color:step.color,submenu:{before_first_render:{fn:this.set_column_menu_items,scope:this},column_path:menu.column_path+field.name+'.Task.',entity_class_name:'Task'}})}},set_entity_type_menu_items:function(menu)
{var class_names=menu.entity_class_names;var me=this;var sorted_values=class_names.sort(function(a,b){var da=me.get_entity_display_name(a);var db=me.get_entity_display_name(b);if(da>db)return 1;if(da<db)return-1;return 0;});menu.items.push({heading:"Entity Type"});for(var i=0;i<sorted_values.length;i++)
{menu.items.push({html:this.get_entity_display_name(sorted_values[i]),submenu:{before_first_render:{fn:this.set_column_menu_items,scope:this},column_path:menu.column_path+sorted_values[i]+'.',entity_class_name:sorted_values[i]}});}},refresh_column_menu:function()
{if(this.column_menu)
{this.column_menu.destroy();this.column_menu=null;}
for(var i=0;i<this.rows.length;i++)
if(this.subgroups[i])
this.subgroups[i].refresh_column_menu();},get_entity_display_name:function(class_name)
{if(SG.schema.entity_types[class_name])
return SG.schema.entity_types[class_name].display_name;else
return"";},on_path_selected:function(menu,item)
{menu.row.on_path_selected(item.column_path);this.condition_changed();},apply_edit:function()
{for(var i=0;i<this.rows.length;i++)
if(this.rows[i])
this.rows[i].apply_edit();else if(this.subgroups[i])
this.subgroups[i].apply_edit();},invalid:function()
{for(var i=0;i<this.rows.length;i++)
{if(this.rows[i]&&this.rows[i].invalid())
return true;}
for(var i=0;i<this.subgroups.length;i++)
{if(this.subgroups[i]&&this.subgroups[i].invalid())
return true;}
return false;},on_global_scroll:function(e)
{var t=e.target;if(t.className.indexOf('sg_menu_body')==-1&&t.className.indexOf('sg_grid_editor_textarea')==-1)
{this.apply_edit();}},});SG.ConditionRow=function(config)
{Ext.apply(this,config);SG.ConditionRow.superclass.constructor.call(this);};SG.ConditionRow.default_condition=function(entity_type,path,use_these_filter_tokens,token_context_widget)
{var field=null;if(path)
field=SG.schema.get_field(entity_type,path);if(!field||field.no_filtering||field.data_type=='url')
{var fields=SG.schema.get_categorized_fields(entity_type,false,false);fields=fields.ordinary;fields=SG.schema.locally_sorted_fields(this.column_display_names,fields,'');path=null;for(var i=0;i<fields.length&&path==null;i++)
{if(!fields[i].no_filtering&&fields[i].data_type!='url')
{path=fields[i].name;field=fields[i];}}}
var value=null;if(token_context_widget)
{var values=token_context_widget.get_tokens_by_context(field);if(values&&values.length>0)
value=[values[0]];}
else if(use_these_filter_tokens)
{value=SG.ConditionRow.get_default_token(field,use_these_filter_tokens);if(value)
value=[value];}
return{path:path,relation:"is",values:[value],active:'true'};};SG.ConditionRow.get_default_token=function(schema_field,tokens)
{if(tokens&&['entity','multi_entity'].indexOf(schema_field.data_type)>-1)
{var allowed_types=SG.schema.allowed_entity_types_for_autocomplete(schema_field);for(var i=0;i<tokens.length;i++)
{if(allowed_types.indexOf(tokens[i].type)>-1)
return tokens[i];}}
return null;};Ext.extend(SG.ConditionRow,SG.Component,{templates:{row_contents:'<td class="condition_active_col">'+'<input type="checkbox" class="condition_active_checkbox" {checked}></td>'+'<td class="condition_column_col">{path_dropdown}</td>'+'<td class="condition_type_col">{type_dropdown}</td>'+'<td class="condition_value_col"></td>'+'<td class="condition_button_col"><div></div></td>',},init_component:function()
{this.previous_condition=sg_deep_copy(this.condition);this.reset_value_component();},reset_value_component:function()
{if(this.value_component)
this.value_component.destroy();this.value_component=this.new_component(SG.ConditionValue,{edit_container:this.edit_container,row:this,schema_field:this.group.field_info_for(this.condition.path),condition:this.condition,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget});},invalid:function()
{return(this.value_component&&this.value_component.invalid);},make_row_active:function()
{if(this.condition.active=='false')
{this.condition.active='true';var checkbox=this.container.child('input.condition_active_checkbox',true);checkbox.checked=true;this.container.removeClass('condition_row_inactive');this.condition_changed();}},render:function()
{if(typeof this.container=='string')
this.container=Ext.get(this.container);var row_classes='condition_row';var active=(this.condition.active!='false');if(!active)
row_classes+=" condition_row_inactive";this.container.dom.className=row_classes;this.container.dom.innerHTML=this.templates.row_contents.apply({checked:active?'checked':''});var schema_field=this.group.field_info_for(this.condition.path);var path_col=this.container.child('td.condition_column_col',true);if(!this.group.column_menu)
{this.group.column_menu=new SG.Menu({before_first_render:{fn:this.group.set_column_menu_items,scope:this.group},item_selected:{fn:this.group.on_path_selected,scope:this.group},column_path:'',entity_class_name:this.entity_type});}
if(this.single_project_filter_mode)
{this.column_dropdown=new SG.Menu.DropDown({read_only:true,container:path_col,content:this.path_display(this.condition.path,schema_field),extra_class:'condition_column_select'});this.column_dropdown.render();}
else
{this.column_dropdown=new SG.Menu.DropDown({menu:this.group.column_menu,container:path_col,content:this.path_display(this.condition.path,schema_field),extra_class:'condition_column_select',extra_onclick:{fn:function(){this.group.column_menu.row=this;this.make_row_active();if(!this.group.column_menu.is_rendered())
this.group.column_menu.render();},scope:this}});this.column_dropdown.render();}
var type_col=this.container.child('td.condition_type_col',true);if(!this.filter_type_menu)
{this.filter_type_menu=new SG.Menu({before_show:{fn:this.on_before_show_filter_type_menu,scope:this},item_selected:{fn:this.on_filter_type_selected,scope:this},});}
var filter_type=this.get_filter_type(schema_field,this.condition.relation);var filter_type_display_name=(filter_type[1]==this.condition.relation?filter_type[0]:this.condition.relation);if(filter_type_display_name=='in')
filter_type_display_name='Is a custom list';this.filter_type_dropdown=new SG.Menu.DropDown({menu:this.filter_type_menu,container:type_col,content:filter_type_display_name,extra_class:'condition_type_select',extra_onclick:{fn:function(){this.make_row_active();},scope:this}});this.filter_type_dropdown.render();this.render_value_component();if(!this.single_project_filter_mode)
{var button_div=this.container.child('td.condition_button_col',true).firstChild;button_div.innerHTML=SG.ImageButton.render({up:'minus_button_round',pressed:'minus_button_round_down',extra_classes:'condition_minus_button'})+
SG.ImageButton.render({up:'plus_button_round',pressed:'plus_button_round_down',extra_classes:'condition_plus_button'});}},render_value_component:function()
{var value_col=this.container.child('td.condition_value_col',true);value_col.innerHTML=this.value_component.render();if(this.force_webkit_rerender_please&&value_col.firstChild.nextSibling)
{value_col.firstChild.nextSibling.style.webkitTransform='scale(1)';if(value_col.firstChild.nextSibling.nextSibling)
value_col.firstChild.nextSibling.nextSibling.style.webkitTransform='scale(1)';}
this.force_webkit_rerender_please=false;},path_display:function(path,opt_schema_field)
{var schema_field=opt_schema_field?opt_schema_field:this.group.field_info_for(path);var display=SG.schema.local_display_name(this.column_display_names,schema_field,path);if(path.indexOf(".")>-1)
{var temp=path.split(".");while(temp.length>1)
{var class_name=temp[temp.length-2];temp=temp.slice(0,temp.length-2);var current_field_path=temp.join(".");schema_field=this.group.field_info_for(current_field_path);if(schema_field)
{var field_display_name=SG.schema.local_display_name(this.column_display_names,schema_field,current_field_path);var class_display_name=SG.schema.entity_types[class_name]?SG.schema.entity_types[class_name].display_name:class_name;if(SG.schema.allowed_entity_types(schema_field).length==1||schema_field.data_type=='pivot_column')
display=field_display_name+" > "+display;else
display=field_display_name+" > "+class_display_name+" > "+display;}}}
return display;},get_column_filter_types:function(schema_field)
{var all_filter_types=SG.globals.filters.all_filter_types[schema_field.data_type];var filter_types=[];var single_type_entity=(['entity','multi_entity'].indexOf(schema_field.data_type)>-1&&SG.schema.allowed_entity_types(schema_field).length==1);var step_list=(schema_field.data_type=='entity'&&schema_field.editor=='step_list');var sibling_tasks=(schema_field.entity_type=='Task'&&schema_field.name=='sibling_tasks');for(var i=0;i<all_filter_types.length;i++)
{if(this.group.omit_filter_types&&this.group.omit_filter_types.indexOf(all_filter_types[i][1])>-1)
continue;if(single_type_entity&&['type_is','type_is_not'].indexOf(all_filter_types[i][1])>-1)
continue;if((step_list||sibling_tasks)&&["name_contains","name_not_contains"].indexOf(all_filter_types[i][1])>-1)
continue;filter_types.push(all_filter_types[i]);}
return filter_types;},get_filter_type:function(schema_field,candidate_type)
{var filter_types=this.get_column_filter_types(schema_field);var filter_type=filter_types[0];for(var i=0;i<filter_types.length;i++)
if(filter_types[i][1]==candidate_type)
filter_type=filter_types[i];return filter_type;},on_path_selected:function(path)
{this.condition.path=path;this.column_dropdown.set_content(this.path_display(this.condition.path));this.no_notifications=true;this.update_filter_type();this.update_filter_value();this.no_notifications=false;this.previous_condition=sg_deep_copy(this.condition);this.condition_changed();},on_filter_type_selected:function(menu,item)
{this.condition.relation=item.value;this.filter_type_dropdown.set_content(item.html);this.no_notifications=true;this.update_filter_value();this.no_notifications=false;this.previous_condition=sg_deep_copy(this.condition);this.condition_changed();},update_filter_type:function()
{var schema_field=this.group.field_info_for(this.condition.path);var filter_type=this.get_filter_type(schema_field,this.condition.relation);this.condition.relation=filter_type[1];this.filter_type_dropdown.set_content(filter_type[0]);this.condition_changed();},update_filter_value:function()
{var schema_field=this.group.field_info_for(this.condition.path);if(this.previous_condition.path!=this.condition.path||!this.filter_types_compatible(this.previous_condition.relation,this.condition.relation))
{this.condition.values=[];}
this.reset_value_component();this.render_value_component();this.condition_changed();},old_new_filter_compatibility:[["is","is_not","contains","not_contains","starts_with","ends_with"],["greater_than","less_than"],["name_contains","name_not_contains","name_is"],["in_last","in_next","not_in_last","not_in_next"],["in_calendar_month","in_calendar_week","in_calendar_day"],["type_is","type_is_not"]],filter_types_compatible:function(old_filter_type,new_filter_type)
{for(var i=0;i<this.old_new_filter_compatibility.length;i++)
{var arr=this.old_new_filter_compatibility[i];if(arr.indexOf(old_filter_type)>-1&&arr.indexOf(new_filter_type)>-1)
return true;}
return false;},on_before_show_filter_type_menu:function(menu)
{var schema_field=this.group.field_info_for(this.condition.path);var filter_types=this.get_column_filter_types(schema_field);menu.items=[];for(var i=0;i<filter_types.length;i++)
{menu.items.push({html:filter_types[i][0],value:filter_types[i][1],selected:filter_types[i][1]==this.condition.relation});}
menu.render();},on_click:function(target)
{if(target.hasClass('condition_active_checkbox'))
{this.condition.active=target.dom.checked?'true':'false';if(target.dom.checked)
this.container.removeClass('condition_row_inactive');else
this.container.addClass('condition_row_inactive');this.condition_changed();return;}
this.value_component.on_click(target);},apply_edit:function()
{if(this.value_component)
this.value_component.apply_edit();},condition_changed:function()
{if(!this.no_notifications)
this.group.condition_changed();}});SG.ConditionValue=function(config)
{Ext.apply(this,config);SG.ConditionValue.superclass.constructor.call(this);};SG.ConditionValue.editor_data_type_overrides={entity:"multi_entity",list:"multi_list",status_list:"multi_status_list"};SG.ConditionValue.editor_data_type=function(field_data_type,condition)
{var data_type=field_data_type;if(data_type=='multi_entity')
data_type='entity';if(data_type=="entity"&&["name_contains","name_not_contains","name_is"].indexOf(condition.relation)>-1)
data_type="text";else if(data_type=="date_time"&&["is","is_not"].indexOf(condition.relation)>-1)
data_type="date";else if(condition.top_level_project_filter===true&&["is","is_not"].indexOf(condition.relation)!==-1)
{data_type='entity';}
else if(this.editor_data_type_overrides[data_type])
data_type=this.editor_data_type_overrides[data_type];return data_type;};Ext.extend(SG.ConditionValue,SG.Component,{templates:{single_typed_value:'<div class="condition_value single_value typed_value_1">{cell}</div>',between_typed_values:'<div class="condition_value double_value typed_value_1">{cell_1}</div>'+'<div class="condition_conjunction"> to </div>'+'<div class="condition_value double_value typed_value_2">{cell_2}</div>',two_values_count_units:'<div class="condition_value count_value typed_value_1">{cell_1}</div>'+'<div class="condition_value units_value typed_value_2">{cell_2}</div>',current_cal_period:'<div class="condition_value cal_period_sign_alone typed_value_1">{cell}</div>',previous_or_next_cal_period:'<div class="condition_value cal_period_sign typed_value_1">{cell_1}</div>'+'<div class="condition_value cal_period_scale typed_value_2">{cell_2}</div>'+'<div class="cal_period_interval_label">{units}</div>',no_value:'<div class="no_condition_value">{cell}</div>',id_in_query:'<div class="id_in_query_value">{cell}</div>'},calendar_period_list:{values:[-1,0,1],display_values:["previous","current","next"]},init_component:function()
{this.reset_data_set();this.rendered=false;},reset_data_set:function()
{if(this.data_set)
this.data_set.destroy();this.data_set=new SG.Data.Set(this.row.entity_type);this.add_event(this.data_set,'change',this.on_data_set_change);},destroy_component:function()
{if(this.data_set)
this.data_set.destroy();if(this.active_editor)
this.active_editor.cancel();},get_render_method:function()
{var relation=this.condition.relation;var data_type=this.schema_field.data_type;var render_method="render_single_typed_value";if(relation=="between")
{render_method="render_between_typed_values";}
else if(data_type=="date"||data_type=="date_time")
{if(['in_next','not_in_next','in_last','not_in_last'].indexOf(relation)>-1)
render_method='render_time_interval';else if(relation.indexOf("in_calendar")>-1)
render_method='render_calendar_period';}
else if(['entity','multi_entity'].indexOf(data_type)>-1&&(relation=="type_is"||relation=="type_is_not"))
{render_method='render_entity_type';}
else if(data_type=='number'&&this.schema_field.name=='id'&&relation=='in')
{render_method='render_id_in_query';}
else if(data_type=='image')
{render_method='render_none';}
if(['number','float','percent','currency'].indexOf(data_type)>-1&&(relation=='is'||relation=='is_not'))
{this.use_comma_separated_numbers=true;}else{this.use_comma_separated_numbers=false;}
return render_method;},render:function()
{var render_method=this.get_render_method();this.rendered=true;return this[render_method].call(this);},render_none:function()
{this.edit_method=null;var record;if(this.data_set.count()==0)
record=this.data_set.new_record(1);else
record=this.data_set.get_record_by_id(1);var value=this.ensure_valid_typed_value(0);record.set(this.condition.path,value);return this.templates.no_value.apply({cell:''});},render_id_in_query:function()
{this.edit_method=null;return this.templates.id_in_query.apply({cell:this.condition.values.join(', ')});},render_single_typed_value:function()
{this.edit_method=this.edit_typed_cell;var record;if(this.data_set.count()==0)
record=this.data_set.new_record(1);else
record=this.data_set.get_record_by_id(1);var value=this.ensure_valid_typed_value(0);record.set(this.condition.path,value);record.render_for_query_builder=true;return this.templates.single_typed_value.apply({cell:this.get_typed_value_renderer().render_nbsp(value,this.schema_field,record)});},render_between_typed_values:function()
{this.edit_method=this.edit_typed_cell;var record_1,record_2;if(this.data_set.count()==0)
{record_1=this.data_set.new_record(1);record_2=this.data_set.new_record(2);}
else
{record_1=this.data_set.get_record_by_id(1);record_2=this.data_set.get_record_by_id(2);}
var value_1=this.ensure_valid_typed_value(0);record_1.set(this.condition.path,value_1);var value_2=this.ensure_valid_typed_value(1);record_2.set(this.condition.path,value_2);return this.templates.between_typed_values.apply({cell_1:this.get_typed_value_renderer().render_nbsp(value_1,this.schema_field,record_1),cell_2:this.get_typed_value_renderer().render_nbsp(value_2,this.schema_field,record_2)});},render_calendar_period:function()
{this.edit_method=this.edit_calendar_period_cell;var list_record;var int_record;if(this.data_set.count()==0)
{list_record=this.data_set.new_record(1);int_record=this.data_set.new_record(2);}
else
{list_record=this.data_set.get_record_by_id(1);int_record=this.data_set.get_record_by_id(2);}
var value=this.condition.values[0];if(value)
return this.render_calendar_period_previous_or_next(value,list_record,int_record);if(!value)
{this.condition.values[0]=0;value=0;}
list_record.set(this.condition.path,value);this.schema_field.override_list=this.calendar_period_list;return this.templates.current_cal_period.apply({cell:SG.Renderers['list'].render_nbsp(value,this.schema_field,list_record)});},render_calendar_period_previous_or_next:function(value,list_record,int_record)
{var sign=value>0?1:-1;var scale=value/sign;list_record.set(this.condition.path,sign);int_record.set(this.condition.path,scale);this.schema_field.override_list=this.calendar_period_list;this.row.force_webkit_rerender_please=true;return this.templates.previous_or_next_cal_period.apply({cell_1:SG.Renderers['list'].render_nbsp(sign,this.schema_field,list_record),cell_2:SG.Renderers['number'].render_nbsp(scale,this.schema_field,int_record),units:this.condition.relation.substring(12).pluralize()});},render_time_interval:function()
{this.edit_method=this.edit_time_interval_cell;var int_record;var list_record;if(this.data_set.count()==0)
{int_record=this.data_set.new_record(1);list_record=this.data_set.new_record(2);}
else
{int_record=this.data_set.get_record_by_id(1);list_record=this.data_set.get_record_by_id(2);}
var int_value=this.condition.values[0];if(!int_value)
{int_value=1;this.condition.values[0]=int_value;}
int_record.set(this.condition.path,int_value);var list_value=this.condition.values[1];if(!list_value)
{list_value='DAY';this.condition.values[1]=list_value;}
list_record.set(this.condition.path,list_value);this.schema_field.override_list=sg_deep_copy(SG.globals.filters.time_units);if(this.schema_field.data_type=='date')
{var hours_index=this.schema_field.override_list.values.indexOf('HOUR');this.schema_field.override_list.values.splice(hours_index,1);this.schema_field.override_list.display_values.splice(hours_index,1);}
return this.templates.two_values_count_units.apply({cell_1:SG.Renderers['number'].render_nbsp(int_value,this.schema_field,int_record),cell_2:SG.Renderers['list'].render_nbsp(list_value,this.schema_field,list_record)});},render_entity_type:function()
{this.edit_method=this.edit_entity_type;var record;if(this.data_set.count()==0)
record=this.data_set.new_record(1);else
record=this.data_set.get_record_by_id(1);var value=this.condition.values[0];if(!value)
value=null;record.set(this.condition.path,value);if(!this.entity_type_list)
this.entity_type_list=this.create_entity_type_list();this.schema_field.override_list=this.entity_type_list;return this.templates.single_typed_value.apply({cell:SG.Renderers['multi_list'].render_nbsp(value,this.schema_field,record)});},create_entity_type_list:function()
{var all_values=SG.schema.allowed_entity_types(this.schema_field);var values=[];for(var i=0;i<all_values.length;i++){if(SG.schema.entity_types[all_values[i]].enabled)
values.push(all_values[i]);}
var me=this;var sorted_values=values.sort(function(a,b){var da=me.row.group.get_entity_display_name(a);var db=me.row.group.get_entity_display_name(b);if(da>db)return 1;if(da<db)return-1;return 0;});var display_values=[];for(var i=0;i<sorted_values.length;i++)
display_values.push(this.row.group.get_entity_display_name(sorted_values[i]));return{values:sorted_values,display_values:display_values};},data_type_for_editing:function()
{return SG.ConditionValue.editor_data_type(this.schema_field.data_type,this.condition);},get_typed_value_renderer:function()
{var data_type=this.data_type_for_editing();var renderer_name;if(this.schema_field.editor=='step_list')
renderer_name='step_entity';else if(data_type=="entity")
renderer_name="nodetail_entity";else if(data_type=="multi_entity")
renderer_name="nodetail_multi_entity";else if(data_type=='date')
renderer_name='date_for_query_builder';else if(data_type=='date_time')
renderer_name='datetime_for_query_builder';else if(data_type=='checkbox')
renderer_name='checkbox';else
renderer_name=SG.Renderers.renderer_defaults[data_type];if(!renderer_name)
renderer_name="text";return SG.Renderers[renderer_name];},get_typed_value_editor:function()
{var data_type=this.data_type_for_editing();if(this.schema_field.editor=='step_list')
data_type='step_list';else if(this.schema_field.editor=='task_template_entity_types')
data_type='task_template_entity_types';var editor=SG.GridEditorFactory(data_type);if(data_type=="list"||data_type=="multi_list"||data_type=="status_list"||data_type=="multi_status_list"||data_type=="system_task_type"||data_type=="multi_system_task_type")
{editor.filter_permitted_values=false;}
if(data_type=='date'||data_type=='date_time')
editor.use_tokens_not_words=true;if(this.use_comma_separated_numbers)
editor.allow_comma_separated_list=true;else
editor.allow_comma_separated_list=false;return editor;},ensure_valid_typed_value:function(condition_values_index)
{var value=this.condition.values[condition_values_index];if((!this.condition.top_level_project_filter&&value===null)||typeof value==='undefined')
{value=this.default_value();this.condition.values[condition_values_index]=value;}
return value;},default_value:function()
{var value=null;switch(this.schema_field.data_type)
{case"number":case"percent":case"currency":case"float":value=1;break;case"checkbox":value=false;break;case"duration":if(SG.globals.preferences.duration_units=="hours")
value=60;else
value=60*SG.globals.preferences.hours_per_day;break;case"entity":case"multi_entity":if(['is','is_not'].indexOf(this.condition.relation)>-1)
{value=SG.ConditionRow.get_default_token(this.schema_field,this.use_these_filter_tokens);if(value)
value=[value];}
break;}
return value;},on_click:function(target)
{var parent;if(target.hasClass('condition_value'))
{var me=this;setTimeout(function(){me.edit_cell(target);},0);}
else if(target.dom.tagName.toLowerCase()=='input')
{parent=Ext.get(target.dom.parentNode);if(parent.hasClass('condition_value'))
{var me=this;setTimeout(function(){me.edit_cell(parent);},0);}}
else if(parent=target.findParent('.condition_value',this.container))
{var me=this;setTimeout(function(){me.edit_cell(Ext.get(parent));},0);}},on_data_set_change:function()
{},edit_cell:function(target)
{this.row.make_row_active();if(this.active_editor)
this.cleanup_active_editor();var editor=this.edit_method?this.edit_method(target):null;if(editor)
{this.active_editor=editor;editor.on("blur",this.on_input_blur,this);editor.on("specialkey",this.on_special_key,this);}},edit_typed_cell:function(target)
{var editor=this.get_typed_value_editor();var record_id=target.hasClass('typed_value_2')?2:1;if(!target.dom.parentNode)
target=this.row.container.child('div.typed_value_'+record_id);var edit_context={container:this.edit_container||this.row.group.condition_group_editor_dump,cell_element:target.dom,record:this.data_set.get_record_by_id(record_id),column_name:this.condition.path,projects:this.row.group.context_projects,click_target:target};editor.use_filter_tokens=null;if(this.token_context_widget&&['entity','multi_entity'].indexOf(this.schema_field.data_type)>-1)
{var tokens=this.token_context_widget.get_tokens_by_context(this.schema_field);if(tokens.length>0)
editor.use_filter_tokens=tokens;}
else if(this.use_these_filter_tokens&&['entity','multi_entity'].indexOf(this.schema_field.data_type)>-1)
{var tokens=[];var allowed_types=SG.schema.allowed_entity_types_for_autocomplete(this.schema_field);for(var i=0;i<this.use_these_filter_tokens.length;i++)
{if(allowed_types.indexOf(this.use_these_filter_tokens[i].type)>-1)
tokens.push(this.use_these_filter_tokens[i]);}
if(tokens.length>0)
editor.use_filter_tokens=tokens;}
editor.edit(edit_context);return editor;},edit_calendar_period_cell:function(target)
{var record_id=target.hasClass('typed_value_2')?2:1;if(!target.dom.parentNode)
target=this.row.container.child('div.typed_value_'+record_id);var editor;if(record_id==2)
editor=SG.GridEditorFactory('number');else
{editor=SG.GridEditorFactory('list');editor.list=this.calendar_period_list;editor.filter_permitted_values=false;}
var edit_context={container:this.edit_container||this.row.group.condition_group_editor_dump,cell_element:target.dom,record:this.data_set.get_record_by_id(record_id),column_name:this.condition.path,click_target:target};editor.edit(edit_context);return editor;},edit_entity_type:function(target)
{var editor=SG.GridEditorFactory('multi_list');editor.list=this.entity_type_list;editor.filter_permitted_values=false;var edit_context={container:this.edit_container||this.row.group.condition_group_editor_dump,cell_element:target.dom,record:this.data_set.get_record_by_id(1),column_name:this.condition.path,click_target:target};editor.edit(edit_context);return editor;},edit_time_interval_cell:function(target)
{var record_id=target.hasClass('typed_value_2')?2:1;if(!target.dom.parentNode)
target=this.row.container.child('div.typed_value_'+record_id);var editor;if(record_id==1)
editor=SG.GridEditorFactory('number');else
{editor=SG.GridEditorFactory('list');editor.list=this.schema_field.override_list;editor.filter_permitted_values=false;}
var edit_context={container:this.edit_container||this.row.group.condition_group_editor_dump,cell_element:target.dom,record:this.data_set.get_record_by_id(record_id),column_name:this.condition.path,click_target:target};editor.edit(edit_context);return editor;},on_input_blur:function()
{this.apply_edit();},on_special_key:function(editor,key_id,shift_key_down)
{switch(key_id)
{case Ext.EventObject.ESC:this.cleanup_active_editor();break;case Ext.EventObject.RETURN:this.apply_edit();this.row.group.editor_return_key_pressed();break;case Ext.EventObject.TAB:this.apply_edit();break;}},apply_edit:function()
{if(!this.rendered)
return;if(!this.edit_method)
return;if(this.active_editor)
{this.active_editor.update_and_hide();}
this.cleanup_active_editor();var old_values=this.put_values_in_condition_hash();this.row.render_value_component();if(old_values[0]!=this.condition.values[0]||(old_values.length==2&&old_values[1]!=this.condition.values[1]))
{this.row.condition_changed();}},put_values_in_condition_hash:function()
{if(this.get_render_method()=='render_calendar_period')
return this.put_calendar_period_values_in_data_set();var old_values=[this.condition.values[0]];this.condition.values[0]=this.data_set.get_record_by_id(1).get(this.condition.path);if(this.data_set.count()==2)
{old_values[1]=this.condition.values[1];this.condition.values[1]=this.data_set.get_record_by_id(2).get(this.condition.path);if(old_values[0]!=this.condition.values[0]||old_values[1]!=this.condition.values[1])
{if(this.data_set.get_record_by_id(1).get_error(this.condition.path)||this.data_set.get_record_by_id(2).get_error(this.condition.path))
{this.invalid=true;}
else
this.invalid=false;}}
else
{if(old_values[0]!=this.condition.values[0])
{if(this.data_set.get_record_by_id(1).get_error(this.condition.path))
this.invalid=true;else
this.invalid=false;}}
return old_values;},put_calendar_period_values_in_data_set:function()
{var old_values=[this.condition.values[0]];var sign=this.data_set.get_record_by_id(1).get(this.condition.path);if(sign==0)
{this.condition.values[0]=0;}
else
{var scale=parseInt(this.data_set.get_record_by_id(2).get(this.condition.path));if(isNaN(scale))
this.invalid=true;else
this.invalid=false;if(!scale)
scale=1;this.condition.values[0]=sign*scale;}
return old_values;},cleanup_active_editor:function()
{if(this.active_editor)
{this.active_editor.cancel();this.active_editor.un("blur",this.on_input_blur);this.active_editor.un("specialkey",this.on_special_key);this.active_editor=false;}},});SG.PageConditions=function(config)
{Ext.apply(this,config);SG.PageConditions.superclass.constructor.call(this);};Ext.extend(SG.PageConditions,SG.Component,{templates:{raw:'<div class="sgc_page_conditions"><div id="page_condition_group_raw_{component_id}"></div></div>',project_and_main:'<div class="sgc_page_conditions">'+'<div id="page_project_condition_gear_menu" class="gear_menu_nobg hidden">&nbsp;</div>'+'<div id="page_project_condition_disabled_warning" class="hidden"></div>'+'<div id="page_condition_group_project_{component_id}"></div>'+'<div id="page_condition_group_main_{component_id}"></div>'+'</div>',main_only:'<div class="sgc_page_conditions">'+'<div id="page_condition_group_main_{component_id}"></div>'+'</div>',page_project_condition_disabled:'<span>The standard Project filter has been disabled, '+'which may display results from other Projects.'+'<div class="enable_project_condition_link_container">'+'<span id="enable_project_condition" class="fake_link">Turn the Project filter back on</span></span>'+'</div>'},init_component:function()
{this.group_id=(++SG.ConditionGroup.last_group_id);this.condition=sg_deep_copy(this.condition);var condition_type=this.analyze_filter_structure();if(condition_type=='main_only'&&SG.schema.entity_types[this.entity_type].has_projects)
{var project=this.page_project?this.page_project:null;this.condition.conditions.splice(0,0,{'logical_operator':'and','conditions':[{'path':'project','relation':'is','values':[project],'active':'false'}]});condition_type='project_and_main';}
if(condition_type=='invalid')
{console.log("Showing filters raw because filter structure is invalid:");console.log(Ext.encode(this.condition));}
if(condition_type=='invalid'||window.location.hash.indexOf('raw_filters')>-1)
{this.raw_group=this.new_component(SG.ConditionGroup,{container:'page_condition_group_raw_'+this.group_id,edit_container:this.edit_container,condition:this.condition,entity_type:this.entity_type,show_entity_type_display_name:this.show_entity_type_display_name,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget,context_projects:this.context_projects,column_display_names:this.column_display_names,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,condition_changed_callback:{fn:this.condition_changed,scope:this},editor_return_key_pressed_callback:{fn:this.editor_return_key_pressed,scope:this}});return;}
if(condition_type=='project_and_main')
{this.condition.conditions[0].top_level_project_filter=true;this.project_group=this.new_component(SG.ConditionGroup,{container:'page_condition_group_project_'+this.group_id,edit_container:this.edit_container,condition:this.condition.conditions[0],entity_type:this.entity_type,show_entity_type_display_name:this.show_entity_type_display_name,single_project_filter_mode:true,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget,context_projects:this.context_projects,column_display_names:this.column_display_names,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,condition_changed_callback:{fn:this.condition_changed,scope:this},editor_return_key_pressed_callback:{fn:this.editor_return_key_pressed,scope:this}});}
this.main_group=this.new_component(SG.ConditionGroup,{container:'page_condition_group_main_'+this.group_id,edit_container:this.edit_container,condition:this.condition.conditions[this.condition.conditions.length-1],entity_type:this.entity_type,show_entity_type_display_name:this.show_entity_type_display_name,use_these_filter_tokens:this.use_these_filter_tokens,token_context_widget:this.token_context_widget,context_projects:this.context_projects,column_display_names:this.column_display_names,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,condition_changed_callback:{fn:this.condition_changed,scope:this},editor_return_key_pressed_callback:{fn:this.editor_return_key_pressed,scope:this}});},analyze_filter_structure:function()
{if(this.condition.logical_operator=='or')
return'invalid';if(this.condition.conditions.length==1&&this.condition.conditions[0].conditions)
return'main_only';if(this.condition.conditions.length==2&&this.condition.conditions[0].conditions&&this.condition.conditions[1].conditions)
{var project_group=this.condition.conditions[0];if(project_group.conditions.length!=1)
return'invalid';if(project_group.conditions[0].path&&project_group.conditions[0].path=='project')
{project_group.conditions[0].top_level_project_filter=true;return'project_and_main';}
return'invalid';}
return'invalid';},get_condition:function()
{if(this.raw_group)
return this.raw_group.get_condition();var cond={'logical_operator':'and','conditions':[]};if(this.project_group)
cond.conditions.push(this.project_group.get_condition());cond.conditions.push(this.main_group.get_condition());return cond;},render:function()
{if(typeof this.container=='string')
{this.container=Ext.get(this.container);if(!this.container)
return;}
var template=this.raw_group?'raw':this.project_group?'project_and_main':'main_only';this.container.dom.innerHTML=this.templates[template].apply({component_id:this.group_id});if(this.raw_group)
this.raw_group.render();if(this.project_group&&!this.project_matches_page_project()){this.project_group.render();}else if(this.project_group&&this.page_project){this.render_page_project_condition_gear_menu();this.render_page_project_condition_warning();}
if(this.main_group)
this.main_group.render();},project_matches_page_project:function()
{var page_project=this.page_project;if(page_project&&this.project_group)
{var filter_project_id;var project_filter=this.condition.conditions[0].conditions[0];if(project_filter.path)
{filter_project_id=project_filter.values[0]&&project_filter.values[0].id;}
else
{return false;}
if(filter_project_id==page_project.id)
return true;}
return false;},condition_changed:function()
{if(this.condition_changed_callback)
this.condition_changed_callback.fn.call(this.condition_changed_callback.scope);},editor_return_key_pressed:function()
{if(this.editor_return_key_pressed_callback)
this.editor_return_key_pressed_callback.fn.call(this.editor_return_key_pressed_callback.scope);},refresh_column_menu:function()
{if(this.raw_group)
this.raw_group.refresh_column_menu();if(this.project_group)
this.project_group.refresh_column_menu();if(this.main_group)
this.main_group.refresh_column_menu();},apply_edit:function()
{if(this.raw_group)
this.raw_group.apply_edit();if(this.project_group)
this.project_group.apply_edit();if(this.main_group)
this.main_group.apply_edit();},invalid:function()
{return((this.raw_group&&this.raw_group.invalid())||(this.project_group&&this.project_group.invalid())||(this.main_group&&this.main_group.invalid()));},render_page_project_condition_gear_menu:function(){var menu_container_dom=sg_find('div#page_project_condition_gear_menu',this.container.dom);Ext.get(menu_container_dom).removeClass('hidden');},show_page_project_condition_menu:function(dom_elem){if(!this.page_project_condition_menu){this.page_project_condition_menu=new SG.Menu({item_selected:{fn:this.page_project_condition_menu_item_selected,scope:this},position:{dom_elem:dom_elem,elem_anchor:"br",menu_anchor:"tr"}});}
currently_enabled=(this.project_group.condition.conditions[0].active!='false');this.page_project_condition_menu.items=[{html:currently_enabled?"Disable Standard Page Project Condition":"Enable Standard Page Project Condition"}],this.page_project_condition_menu.render();this.page_project_condition_menu.show();},page_project_condition_menu_item_selected:function(){var project_filter=this.project_group.condition.conditions[0];if(project_filter.active=='false'){project_filter.active='true';delete project_filter.user_disabled_project_filter;}else{project_filter.active='false';project_filter.user_disabled_project_filter=true;}
this.project_group.condition_changed();this.update_page_project_condition_warning_state();this.editor_return_key_pressed();},render_page_project_condition_warning:function(){var container_dom=sg_find('div#page_project_condition_disabled_warning',this.container.dom);if(this.project_group.condition.conditions[0].active=='false')
Ext.get(container_dom).removeClass('hidden');container_dom.innerHTML=this.templates.page_project_condition_disabled.apply({});},update_page_project_condition_warning_state:function(){var container_dom=sg_find('div#page_project_condition_disabled_warning',this.container.dom);if(this.project_group.condition.conditions[0].active=='false')
Ext.get(container_dom).removeClass('hidden');else
Ext.get(container_dom).addClass('hidden');this.condition_changed();}});SG.Widget.EntityQuery.QueryBuilder=function(config)
{Ext.apply(this,config);SG.Widget.EntityQuery.QueryBuilder.superclass.constructor.call(this);};Ext.extend(SG.Widget.EntityQuery.QueryBuilder,SG.Component,{templates:{main:'<div class="body">'+'<div class="query_builder_div" id="{top_div_id}">'+'{filter_group_containers}'+'</div>'+'</div>'+'<div class="footer"><button id="qb_preview">Preview</button></div>',filter_group_container:'<div class="group {group_type_class}" id="{group_id}"></div>',filter_count:'<span class="query_builder_filter_count">{count_text}</span>',callout:'<div class="callout_div"><img src="/images/callout_triangle.png"></div>'},min_width:610,min_height:100,starting_width:610,starting_height:150,init_component:function()
{this.setup=false;this.top_div_id="qb_"+this.widget.get_widget_id();this.add_event(SG.schema,'reloaded',this.on_schema_changed,this);this.add_event(SG.schema,'column_changed',this.on_schema_changed,this);this.add_event(SG.schema,'column_removed',this.on_schema_changed,this);this.create_condition_groups();},create_condition_groups:function()
{this.widget.refresh_token_entities_in_filters(this.filters);if(this.main_condition_component)
this.main_condition_component.destroy();this.main_condition_component=new SG.PageConditions({condition:this.filters,container:this.top_div_id+"_main_group_filters",edit_container:document.body,entity_type:this.entity_type,show_entity_type_display_name:this.is_pivoted(),column_display_names:this.column_display_names,context_projects:this.widget.is_entity_query_page?this.widget.get_content_widget().context_projects():this.widget.context_projects(),default_field_path:null,token_context_widget:this.widget,page_project:this.page_project,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,condition_changed_callback:{fn:this.update_height,scope:this},editor_return_key_pressed_callback:{fn:this.editor_return_key_pressed,scope:this}});if(this.pivot_condition_component)
this.pivot_condition_component.destroy();if(this.is_pivoted())
{this.pivot_condition_component=new SG.ConditionGroup({condition:this.pivot_filters,container:this.top_div_id+"_pivot_group_filters",edit_container:document.body,entity_type:'Task',show_entity_type_display_name:true,context_projects:this.widget.context_projects(),default_field_path:null,token_context_widget:this.widget,page_project:this.page_project,through_join_fields:this.through_join_fields,parent_entity:this.parent_entity,condition_changed_callback:{fn:this.update_height,scope:this}});}
else
this.pivot_condition_component=null;},invalid:function()
{return(this.main_condition_component.invalid()||(this.pivot_condition_component&&this.pivot_condition_component.invalid()));},is_pivoted:function()
{return!(this.pivot_filters==undefined);},on_schema_changed:function()
{if(this.is_showing()&&this.main_condition_component)
{this.create_condition_groups();this.render();}},refresh_column_menus:function()
{if(this.main_condition_component)
this.main_condition_component.refresh_column_menu();if(this.pivot_condition_component)
this.pivot_condition_component.refresh_column_menu();},apply_edit:function()
{if(this.main_condition_component)
this.main_condition_component.apply_edit();if(this.pivot_condition_component)
this.pivot_condition_component.apply_edit();},editor_return_key_pressed:function()
{this.on_update_click();},on_update_click:function()
{this.set_filters();this.render();},on_click:function(e)
{var t=e.getTarget();if(t.id=='qb_preview'){this.on_update_click();return;}
if(t.id=="page_project_condition_gear_menu"){this.main_condition_component.show_page_project_condition_menu(t);return;}
if(t.id=="enable_project_condition"){this.main_condition_component.page_project_condition_menu_item_selected();return;}},set_filters:function()
{if(this.invalid())
{alert("The conditions have one or more invalid values.");return;}
var new_filters=this.main_condition_component.get_condition();var new_pivot_filters=null;if(this.pivot_condition_component)
{new_pivot_filters=this.pivot_condition_component.get_condition();}
this.filters=new_filters;this.pivot_filters=new_pivot_filters;this.callback.fn.call(this.callback.scope,new_filters,new_pivot_filters);},hide:function(){this.container.addClass('hidden');if(this.resize_callback)
this.resize_callback.fn.call(this.resize_callback.scope);},show:function(){this.container.removeClass('hidden');},is_showing:function(){return!this.container.hasClass('hidden');},toggle_visibility:function(toolbar_item_div){if(this.is_showing())
this.hide();else
this.show();},render:function(){if(!this.setup){this.setup=true;sg_image_node(SG.globals.icons.ArrowOpen);this.add_event(this.container,"click",this.on_click);Ext.EventManager.onWindowResize(this.update_body_max_height,this,true);}
this.container.addClass('sgc_query_builder');this.create_condition_groups();var html=this.templates.main.apply({entity_type_plural:SG.schema.entity_types[this.entity_type].display_name_pluralized,top_div_id:this.top_div_id,filter_group_containers:this.render_filter_group_containers()});this.container.update(html);this.body=Ext.get(sg_find('div.body',this.container.dom));this.footer=Ext.get(sg_find('div.footer',this.container.dom));this.main_condition_component.render();if(this.pivot_condition_component)
this.pivot_condition_component.render();this.show();this.update_height();},update_height:function(){var max_height=Math.round(0.3*Ext.get(document.body).getHeight());this.body.dom.style.maxHeight=max_height+"px";var qb_scroll_height=this.container.dom.clientHeight;if(qb_scroll_height<this.container.dom.scrollHeight){var qb_dialog_top=this.container.getTop();var qb_dialog_height=this.container.getHeight();var browser_height=Ext.get(document.body).getHeight();var vert_available=browser_height-(qb_dialog_top+qb_dialog_height);var diff=this.container.dom.scrollHeight-qb_scroll_height;if((vert_available-diff-10)>0)
this.container.setHeight(qb_dialog_height+diff+10);}
if(this.resize_callback)
this.resize_callback.fn.call(this.resize_callback.scope);},render_filter_group_containers:function()
{var html=this.templates["filter_group_container"].apply({group_id:this.top_div_id+"_main_group_filters",group_type_class:"query_builder_main_group"});if(this.pivot_condition_component)
{html+=this.templates["filter_group_container"].apply({group_id:this.top_div_id+"_pivot_group_filters",group_type_class:"query_builder_pivot_group"});}
return html;},destroy_component:function(){if(this.main_condition_component)
this.main_condition_component.destroy();if(this.pivot_condition_component)
this.pivot_condition_component.destroy();},all_filters_count:function()
{var count=this.filter_count(this.filters);if(this.pivot_filters)
count+=this.filter_count(this.pivot_filters);if(count>0&&this.main_condition_component.project_group&&this.main_condition_component.project_matches_page_project())
{count-=1;}
return count;},filter_count:function(condition)
{var count=0;for(var i=0;i<condition.conditions.length;i++)
{if(condition.conditions[i].active=='false')
continue;if(condition.conditions[i].path)
count++;else if(condition.conditions[i].qb_multivalued_condition_subgroup)
count++;else
count+=this.filter_count(condition.conditions[i]);}
return count;},});SG.ConditionSummaryWriter=function(config)
{Ext.apply(this,config);SG.ConditionGroup.superclass.constructor.call(this);};Ext.extend(SG.ConditionSummaryWriter,SG.Component,{templates:{lead_in:'All <span class="noun">{entity_type_plural}</span>{project_lead_in}',project_lead_in:' in <span class="noun">{project_name}</span>',single_filter:'<span class="condition_summary_filter {inactive_class}">{filter_html}</span>',and_operator:'<span class="and_operator">and</span>',or_operator:'<span class="or_operator">or</span>',condition_wrapper:'<div class="condition_summary"><div class="lead_in">{lead_in} where:</div>'+'{condition}</div>',lead_in_only:'<div class="condition_summary"><div class="lead_in">{lead_in}</div></div>'},render_summary:function(condition){if(condition.path)
return this.templates.condition_wrapper.apply({condition:this.render_condition_group_summary(condition)});if(this.filter_count(condition)===0)
return null;this.add_top_level_project_filter_flag(condition);var entity_type_plural=SG.schema.entity_types[this.entity_type].display_name_pluralized;var lead_in=this.templates.lead_in.apply({entity_type_plural:entity_type_plural});if(condition.conditions[0].top_level_project_filter){var html=[];if(this.filter_count(condition.conditions[0])>0){if(this.filter_count(condition.conditions[0])===1){var project=condition.conditions[0].conditions[0].values[0];var project_lead_in=this.templates.project_lead_in.apply({project_name:project.name});lead_in=this.templates.lead_in.apply({entity_type_plural:entity_type_plural,project_lead_in:project_lead_in});}else{html.push(this.templates.condition_wrapper.apply({lead_in:lead_in,condition:this.render_condition_group_summary(condition.conditions[0])}));lead_in='';}}
if(this.filter_count(condition.conditions[1])>0){html.push(this.templates.condition_wrapper.apply({lead_in:lead_in,condition:this.render_condition_group_summary(condition.conditions[1])}));}else if(lead_in){html.push(this.templates.lead_in_only.apply({lead_in:lead_in,}));}
return html.join('');}else{return this.templates.condition_wrapper.apply({lead_in:lead_in,condition:this.render_condition_group_summary(condition)});}},render_condition_group_summary:function(condition,parent_condition,summary,is_first_child,is_last_child){if(typeof summary==='undefined')
summary=[];var only_child=(parent_condition&&parent_condition.conditions.length===1);var has_one_child=(condition.conditions.length===1);if(parent_condition&&!only_child)
summary.push('<div class="subsection">');var use_parentheses=(parent_condition&&condition.conditions.length>1);if(use_parentheses)
summary.push("( ");var is_multivalued=false;if(condition.conditions.length>1&&condition.conditions[0].path){is_multivalued=true;var path=condition.conditions[0].path;var relation=condition.conditions[0].relation;for(var i=1;i<condition.conditions.length&&is_multivalued;i++){if(condition.conditions[i].active!=='false'&&(condition.conditions[i].path!==path||condition.conditions[i].relation!==relation))
{is_multivalued=false;}}}
var rendered_one_simple_condition=false;for(var i=0;i<condition.conditions.length;i++)
{if(condition.conditions[i].path){if(rendered_one_simple_condition&&is_multivalued){this.render_simple_condition_tail_only(condition.conditions[i],condition,summary,(i==0));}
else{this.render_simple_condition_summary(condition.conditions[i],condition,summary,(i==0));rendered_one_simple_condition=true;}}
else if(this.filter_count(condition.conditions[i],true)>0)
this.render_condition_group_summary(condition.conditions[i],condition,summary,(i===0),(i===(condition.conditions.length-1)));}
if(use_parentheses)
summary.push("&nbsp;)");if(parent_condition&&!is_last_child)
summary.push(this.render_operator(parent_condition.logical_operator));if(parent_condition&&!only_child)
summary.push('</div>');return summary.join('');},add_top_level_project_filter_flag:function(condition)
{if(condition.logical_operator=='or')
return;if(condition.conditions.length==1&&condition.conditions[0].conditions)
return;if(condition.conditions.length==2&&condition.conditions[0].conditions&&condition.conditions[1].conditions)
{var project_group=condition.conditions[0];if(project_group.conditions.length!=1)
return;if(project_group.conditions[0].path&&project_group.conditions[0].path=='project')
{project_group.conditions[0].top_level_project_filter=true;project_group.top_level_project_filter=true;}}
return;},render_simple_condition_summary:function(condition,parent_condition,summary,is_first_child)
{if(!is_first_child)
summary.push(this.render_operator(parent_condition.logical_operator));summary.push(this.filter_summary(condition));},render_simple_condition_tail_only:function(condition,parent_condition,summary,is_first_child){if(!is_first_child)
summary.push(this.render_operator(parent_condition.logical_operator));summary.push(this.filter_summary(condition,true));},get_entity_display_name:function(class_name)
{if(SG.schema.entity_types[class_name])
return SG.schema.entity_types[class_name].display_name;else
return"";},column_info_for:function(column_path)
{var class_and_column=this.parse_path(column_path);return SG.schema.get_field(class_and_column[0],class_and_column[1]);},parse_path:function(column_path)
{column_path=column_path.split(".");if(column_path.length==1)
{var class_name=this.entity_type;var column_name=column_path[0];}
else
{var class_name=column_path[column_path.length-2];var column_name=column_path[column_path.length-1];}
return[class_name,column_name];},column_path_display:function(column_path,opt_column_info)
{var column_info=opt_column_info?opt_column_info:this.column_info_for(column_path);var display=SG.schema.local_display_name(this.column_display_names,column_info,column_path);if(column_path.indexOf(".")>-1)
{var temp=column_path.split(".");while(temp.length>1)
{var class_name=temp[temp.length-2];temp=temp.slice(0,temp.length-2);var current_field_path=temp.join(".");column_info=this.column_info_for(current_field_path);if(column_info)
{var field_display_name=SG.schema.local_display_name(this.column_display_names,column_info,current_field_path);var class_display_name=this.get_entity_display_name(class_name);if(SG.schema.allowed_entity_types(column_info).length==1||column_info.data_type=='pivot_column')
display=field_display_name+" > "+display;else
display=field_display_name+" > "+class_display_name+" > "+display;}}}
return display;},filter_summary_type_text:{"is greater than":">","is less than":"<","is after":"after","is before":"before","is in the range":"from","is in the last":"in last","is in the next":"in next"},filter_summary:function(filter,tail_only)
{var column_info=this.column_info_for(filter.path);var filter_type=filter.relation;var data_type=column_info.data_type;var filter_types=SG.globals.filters.all_filter_types[data_type];var filter_type_text="";var human_name=this.column_path_display(filter.path,column_info);if(filter_type.indexOf("in_calendar")>-1)
{var summary='<span class="noun">'+human_name+"</span> in ";summary+=["previous","current","next"][filter.values[0]+1];summary+=" calendar ";if(filter_type.indexOf("week")>-1)
summary+="week";else if(filter_type.indexOf("day")>-1)
summary+="day";else
summary+="month";return this.wrap_summary(filter,summary);}
for(var i=0;i<filter_types.length;i++)
{if(filter_types[i][1]==filter_type)
filter_type_text=filter_types[i][0];}
if(this.filter_summary_type_text[filter_type_text])
filter_type_text=this.filter_summary_type_text[filter_type_text]
var summary='<span class="noun">'+human_name+'</span> '+escapeHTML(filter_type_text).substring(0,120);if(tail_only)
summary='';if(filter_type=="in_last"||filter_type=="in_next")
{var count=filter.values[0];var unit_index=SG.globals.filters.time_units.values.indexOf(filter.values[1]);var plural_unit=SG.globals.filters.time_units.display_values[unit_index];var singular_unit=plural_unit.substring(0,plural_unit.length-1);summary+=' '+count+' '+singular_unit.pluralize(count);return this.wrap_summary(filter,summary);}
if(filter_type=="type_is"||filter_type=="type_is_not")
{var class_name=filter.values[0]?filter.values[0]:"";var class_display_name=this.get_entity_display_name(class_name);summary+=" "+escapeHTML(class_display_name).substring(0,120);return this.wrap_summary(filter,summary);}
var value=(data_type=="text"&&filter.values[0])?filter.values[0].substring(0,120):filter.values[0];var renderer_name=SG.Renderers.renderer_defaults[data_type];if(renderer_name==='multi_entity')
renderer_name='entity';if(renderer_name==='entity')
renderer_name='basic_entity';var renderer=SG.Renderers[renderer_name];summary+=' <span class="noun">'+renderer.render(value,column_info)+'</span>';if(filter.values[1]!=null)
{if(filter_type_text=="from")
summary+=" to ";else
summary+=" ";value=(data_type=="text"&&filter.values[1])?filter.values[1].substring(0,120):filter.values[1];summary+='<span class="noun">'+renderer.render(value,column_info)+'</span>';}
return this.wrap_summary(filter,summary);},render_operator:function(logical_operator)
{if(logical_operator=="and")
return this.templates.and_operator.apply({});else
return this.templates.or_operator.apply({});},wrap_summary:function(filter,summary_text)
{return this.templates.single_filter.apply({filter_html:summary_text,inactive_class:(filter.active=='false')?'inactive':''});},filter_count:function(condition,include_inactive)
{if((!include_inactive)&&condition.active==='false')
return 0;var count=0;for(var i=0;i<condition.conditions.length;i++)
{if(condition.conditions[i].path)
{if(include_inactive||(condition.conditions[i].active!='false'))
{count++;}}
else
count+=this.filter_count(condition.conditions[i]);}
return count;},});SG.TankActionMenu=function()
{SG.TankActionMenu.superclass.constructor.call(this);};Ext.extend(SG.TankActionMenu,SG.Component,{get_items:function(entity_type,selected_entities,project_ids){if(project_ids.length!==1||project_ids[0]===null)
return[];var project_id=project_ids[0];var items=[];var selection_count=selected_entities.length;if(entity_type=="TankPublishedFile"||entity_type=="Version"){items.push({html:"View Tank Dependency Chain...",icon_name:"tk2_logo_16",value:"tank_dependency_chain",entity_type:entity_type,entity_id:selected_entities[0],disabled:selection_count!==1,item_selected:{fn:this.on_tank_dependency_chain,scope:this}});}
if(!SG.globals.tank_actions.hasOwnProperty(project_id)){SG.globals.tank_actions[project_id]=this.fetch_actions(project_id);}
items=items.concat(this.get_actions(entity_type,selected_entities,project_id));return items;},fetch_actions:function(project_id){var applet=Ext.get('sg_java_localfile');if(!applet)
return[];else
applet=applet.dom;var tank_studio_root=this.get_tank_studio_root();if(tank_studio_root===null)
return[];var dlg;var projects=SG.schema.projects;var project=null;for(i=0;i<projects.length;i++){if(projects[i].id===project_id){project=projects[i];break;}}
if(project===null||!project.tank_name){return[];}
applet.tankGetActions(tank_studio_root,project.tank_name);if(applet.errorResult=="ERROR"){dlg=new SG.NewDialog({title:"Tank Error",width:"600px",body:applet.errorMessage.replace(/\n/g,'<br />'),actions:[{label:'OK'}]});return[];}
if(applet.logOutput){dlg=new SG.NewDialog({title:"Tank Error",width:"600px",body:applet.logOutput.replace(/\n/g,'<br />'),actions:[{label:'OK'}]});}
var lines=applet.singleResult.split("\n");var a,actions=[];for(var i=0;i<lines.length;i++){if(lines[i]=="")continue;a=lines[i].split("$");actions.push({name:a[0],title:a[1],entity_types:a[2]!=""?a[2].split(","):[],deny_permissions:a[3]!=""?a[3].split(","):[],deny_platforms:a[4]!=""?a[4].split(","):[],supports_multiple_selection:a[5]=="True"});}
actions.sort(function(a,b){var x=a["title"].toLowerCase();var y=b["title"].toLowerCase();return((x<y)?-1:((x>y)?1:0));});return actions;},get_actions:function(entity_type,selected_entities,project_id){var items=[];var actions=SG.globals.tank_actions[project_id];var selection_count=selected_entities.length;var cur_role_name=SG.globals.current_user.permission_rule_set.rule_set_display_name;var supported_type,supported_platform,supported_role,supported_project;var i,j,a,multi;for(i=0;i<actions.length;i++){a=actions[i];multi=a["supports_multiple_selection"];supported_type=a["entity_types"].indexOf(entity_type)!==-1;supported_role=a["deny_permissions"].indexOf(cur_role_name)===-1;supported_platform=true;if(sg_platform()=="Windows"&&a["deny_platforms"].indexOf("Windows")!==-1){supported_platform=false;}else if(sg_platform()=="Mac"&&a["deny_platforms"].indexOf("Mac")!==-1){supported_platform=false;}else if(sg_platform()=="Linux"&&a["deny_platforms"].indexOf("Linux")!==-1){supported_platform=false;}
if(supported_type&&supported_platform&&supported_role){items.push({html:a["title"]||a["name"],icon_name:"tk2_logo_16",value:a["name"],entity_type:entity_type,entity_ids:selected_entities,project_ids:[project_id],disabled:selection_count===0||(selection_count>1&&!multi),item_selected:{fn:this.on_item_selected,scope:this}});}}
return items;},on_item_selected:function(menu,item){var ctx=this.validate_tank(item.project_ids);if(ctx===null)return;var action_name=item.value;var entity_type=item.entity_type;var entity_ids=item.entity_ids.join(",");var dlg;ctx.applet.tankRunAction(ctx.local_storage_path,ctx.project_tank_name,action_name,entity_type,entity_ids);if(ctx.applet.errorResult=="ERROR"){dlg=new SG.NewDialog({title:"Tank Error",width:"600px",body:ctx.applet.errorMessage.replace(/\n/g,'<br />'),actions:[{label:'OK'}]});}else if(ctx.applet.singleResult){dlg=new SG.NewDialog({title:"Tank Output",width:"600px",body:ctx.applet.singleResult.replace(/\n/g,'<br />'),actions:[{label:'OK'}]});}},get_tank_studio_root:function(){var local_storages=SG.globals.local_storages;var local_storage=null;var local_storage_path=null;for(var local_storage_id in local_storages){if(!local_storages.hasOwnProperty(local_storage_id))continue;if(local_storages[local_storage_id].code==="Tank"){local_storage=local_storages[local_storage_id];break;}}
if(local_storage===null){return null;}
var platform=sg_platform();if(platform==="Mac"){local_storage_path=local_storage.mac_path;}else if(platform==="Windows"){local_storage_path=local_storage.windows_path;}else if(platform==="Linux"){local_storage_path=local_storage.linux_path;}
if(!local_storage_path){return null;}
return local_storage_path;},validate_tank:function(project_ids){var ctx={};var i;if(!sg_has_localfile_applet()){alert("Tank access is unavailable.\n\n"+"Please make sure that you have local file access enabled "+"in the site preferences.");return null;}
ctx.applet=Ext.get("sg_java_localfile").dom;if(project_ids.length!==1||project_ids[0]===null){alert("All selected entities must be in the same project.");return null;}
var projects=SG.schema.projects;var project=null;for(i=0;i<projects.length;i++){if(projects[i].id===project_ids[0]){project=projects[i];break;}}
if(project===null||!project.tank_name){alert("Couldn't find Project.tank_name for project with id "+project_ids[0]+".");return null;}
ctx.project_tank_name=project.tank_name;ctx.local_storage_path=this.get_tank_studio_root();return ctx;},on_tank_dependency_chain:function(menu,item){var tpf_id;if(item.entity_type=="TankPublishedFile"){tpf_id=item.entity_id;}else if(item.entity_type=="Version"){try{var row=SG.Repo.get_row("Version",item.entity_id);tpf_id=row.get("tank_published_file").id;}catch(err){alert("Sorry, this Version has no associated TankPublishedFile.");return;}}
var page=this.get_parent_widget().get_page();var filters={logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]};var focus_context={entity:{type:'TankPublishedFile',id:tpf_id},entity_type:'TankPublishedFile',filters:filters,title:'Tank Dependency Chain',reset_stack:(page.context.get('inside_window')!==true),server_side_filters:"tank_dependency_chain",server_side_filters_params:{tank_published_file_id:tpf_id},select_entities_on_first_load:[tpf_id],scroll_selection_into_view_on_load:true};page.get_focus_window().open(focus_context);}});