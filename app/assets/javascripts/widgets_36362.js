if(typeof SG.Widget.__instances__=="undefined")
SG.Widget.__instances__={};if(typeof SG.Widget.__uuids__=="undefined")
SG.Widget.__uuids__={};SG.Widget.get_instance_by_id=function(widget_id){return SG.Widget.__instances__[widget_id];};SG.Widget.get_instance_by_uuid=function(uuid){return SG.Widget.__uuids__[uuid];};SG.Widget.__store_instance_by_id__=function(widget_id,instance){SG.Widget.__instances__[widget_id]=instance;if(instance.widget_spec.uuid)
SG.Widget.__uuids__[instance.widget_spec.uuid]=instance;};SG.Widget.__remove_instance_by_id__=function(widget_id){var inst=SG.Widget.__instances__[widget_id];if(inst&&inst.widget_spec.uuid)
delete SG.Widget.__uuids__[inst.widget_spec.uuid];delete SG.Widget.__instances__[widget_id];};SG.Widget.Base=function(context,widget_spec,id){this.context=context;this.widget_spec=widget_spec;this.widget_id=id;this.parent=widget_spec.parent_object;delete widget_spec.parent_widget;SG.Widget.__store_instance_by_id__(id,this);this.events={settings_changed:true,descendent_settings_changed:true,context_changed:true};this.my_default_settings=sg_deep_copy(this.default_settings);SG.Widget.Base.superclass.constructor.call(this);};Ext.extend(SG.Widget.Base,SG.Component,{__inheritable_property_object_names__:["templates","default_settings"],templates:{detail_widgets_edit_header:'<div class="sg_detail_widgets_edit_header" widget_id="{widget_id}" entity_type="{entity_type}">'+'<div class="title">{title}</div>'+'<div class="edit"><div class="icon_edit"></div><span>Edit</span></div></div>',__widget__:'<div class="{widget_cls}" id="{widget_id}"></div>',},default_settings:{},init_component:function(){this.init_children();this.init_widget();},before_init:function(){},init_children:function(){var child_names=this.get_child_names();for(var i=0;i<child_names.length;i++){var child_context=this.context.clone();this.construct_child(child_names[i],child_context);}},init_widget:function(){},parent:null,get_widget_id:function(){return this.widget_id;},new_component:function(component_class,config){var cmp=SG.Widget.Base.superclass.new_component.call(this,component_class,config);cmp.widget=this;cmp.parent_component=null;return cmp;},get_parent:function(){return this.parent;},get_name_in_parent:function(){return this.__name_in_parent__;},get:function(name){var val=this.widget_spec.get_setting(name);if(val==undefined)
val=SG.SettingsUtil.__get_setting__(name,this.my_default_settings);return val;},set:function(){if(arguments.length==1)
this.widget_spec.set_settings(this,arguments[0]);else
this.widget_spec.set_setting(this,arguments[0],arguments[1]);},set_silent:function(){if(arguments.length==1)
this.widget_spec.set_settings(this,arguments[0],true);else
this.widget_spec.set_setting(this,arguments[0],arguments[1],true);},remove:function(setting_names){this.widget_spec.delete_settings(setting_names);},generate_new_child_name:function(prefix){var names=this.get_child_names();var last=-1;var cname,c,i;var name_re=new RegExp(prefix+'_');for(i=0;i<names.length;i++){cname=names[i];if(name_re.exec(cname)!=null){var parts=cname.split('_');if(parts.length==2){c=parseInt(parts[1],10);if(c>last)
last=c;}}}
last++;var str=prefix+'_'+last;return str;},get_child_names:function(){return this.widget_spec.get_child_names();},get_child_widgets:function(){if(this.__child_widgets__)
return this.__child_widgets__;else
return[];},get_child:function(child_name){if(!this.__child_widgets_by_name__)
return null;var child_arr=this.__child_widgets_by_name__[child_name];if(child_arr){if(child_arr.length==1)
return child_arr[0];else if(child_arr.length==0)
return null;else
return child_arr;}
else
return null;},construct_child:function(child_name,context){var spec=this.widget_spec.get_child_spec(child_name);if(!spec){spec=new SG.Widget.Spec(this.widget_spec,{type:"SG.Widget.WarningMessage"});if(!context.get('message'))
context.set('message','Error: Invalid child name '+child_name);}
spec.parent_object=this;var child=SG.Widget.Factory.construct_widget(this,context,spec);child.__name_in_parent__=child_name;child.container_id='sgw_'+child.get_widget_id()+'_'+child_name;if(!this.__child_widgets__){this.__child_widgets__=[];this.__child_widgets_by_name__={};}
if(!this.__child_widgets_by_name__[child_name])
this.__child_widgets_by_name__[child_name]=[];this.__child_widgets__.push(child);this.__child_widgets_by_name__[child_name].push(child);return child;},construct_warning_message:function(message){var child_context=this.context.clone();child_context.set('message',message);return this.construct_child("warning_message_"+Math.floor(Math.random()*100000),child_context);},destroy_child:function(child){if(this.__child_widgets__){var index=this.__child_widgets__.indexOf(child);if(index>-1)
this.__child_widgets__.splice(index,1);var by_name_arr=this.__child_widgets_by_name__[child.__name_in_parent__];if(by_name_arr){index=by_name_arr.indexOf(child);if(index>-1)
by_name_arr.splice(index,1);}}
child.destroy();},on_before_destroy:function(){},get_css_class_name:function(){if(!this.css_class_name){if(this instanceof SG.Widget.WarningMessage){this.css_class_name='sgw_warning_message';return this.css_class_name;}
var temp=this.widget_spec.type.replace(/\./g,'');var temp1=temp.replace('SGWidget','sgw');if(temp==temp1)
temp1=temp.replace('SG','sgw');var lower=temp1.toLowerCase();var ret='';for(var i=0;i<temp1.length;i++){var a=temp1.substr(i,1);var b=lower.substr(i,1);if(a!=b)
ret+='_'+b;else
ret+=b;}
this.css_class_name=ret;return ret;}
else
return this.css_class_name;},get_container_id:function(){return this.container_id;},get_container:function(){if(!this.__container__){this.__container__=Ext.get(this.container_id);}
if(!this.__container__){this.__container__=Ext.get(this.context.get('container'));}
return this.__container__;},get_page:function(){var ret=this;while(ret.parent){ret=ret.parent;}
return ret;},get_canvas:function(){var ret=this;while(ret){if(ret.widget_spec&&ret.widget_spec.type==='SG.Widget.Canvas.Body')
return ret;ret=ret.parent;}
return ret;},spec_settings_changed:function(change_hash,source_widget){this.fireEvent("settings_changed",change_hash,source_widget);},descendent_spec_settings_changed:function(change_hash,source_widget,source_spec){this.fireEvent("descendent_settings_changed",change_hash,source_widget,source_spec);},fire_context_changed:function(key,value){this.fireEvent("context_changed",key,value);},render:function(){if(!this.__rendered__){this.__rendered__=true;this.on_first_render();}
this.render_widget();},on_first_render:function(){},render_widget:function(){alert('MANDATORY: Implement render_widget() for: '+this.get('type'));},destroy_component:function(){this.on_before_destroy();SG.Widget.__remove_instance_by_id__(this.widget_id);this.destroy_widget();this.__destroyed=true;this.widget_spec.remove_settings_listener(this);this.context.un('context_changed');this.destroy_children();var c=this.get_container();if(c)
c.update('');if(this.__overlay_template_div__){this.__overlay_template_div__.remove();this.__overlay_template_div__=null;}},destroy_children:function(){if(this.__child_widgets__){var i;var children=this.__child_widgets__.slice();for(i=0;i<children.length;i++){var w=children[i];if(w)
this.destroy_child(w);}}
this.__child_widgets__=null;},destroy_widget:function(){},show_loading_overlay:function(override_container){var container=override_container||this.get_container();if(!this.__overlay_template_div__){var id="progress_overlay_"+this.get_widget_id();var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(Ext.get(document.body),overlay_html,true);}
this.__overlay_template_div__.alignTo(container,"tl-tl");this.__overlay_template_div__.setWidth(container.getWidth());this.__overlay_template_div__.setHeight(container.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__){this.__overlay_template_div__.hide();}},get_all_widgets:function(){var widgets=[];var root_widget=this.get_page().root_widget;widgets.push(root_widget);this.get_all_descendents(root_widget,widgets);return widgets;},get_all_descendents:function(widget,add_to_this){var i;if(widget.__child_widgets__){for(i=0;i<widget.__child_widgets__.length;i++){var child=widget.__child_widgets__[i];add_to_this.push(child);this.get_all_descendents(child,add_to_this);}}},clear_settings:function(){this.widget_spec.clear_settings();},context_projects:function(_return_single_project_id){var projects=[];if(projects.length==0&&this.context.get('entity_project'))
projects.push(this.context.get('entity_project'));if(projects.length==0&&this.context.get('page_project'))
projects.push(this.context.get('page_project'));if(projects.length==0&&this.context.get('filters'))
projects=this._get_filter_projects();if(projects.length==0&&!_return_single_project_id)
projects=SG.schema.projects;if(_return_single_project_id){if(projects.length==1)
return projects[0];else
return null;}
else
return projects;},context_project_ids:function(){var projects=this.context_projects();var ids=[];for(var i=0;i<projects.length;i++)
ids.push(projects[i].id);return ids;},single_project_from_context:function(){return this.context_projects(true);},_get_filter_projects:function(condition){condition=condition||this.context.get('filters');var projects=[];var project_ids=[];for(var i=0;i<condition.conditions.length;i++){if(condition.conditions[i].path){if(condition.conditions[i].active!='false'&&condition.conditions[i].path=='project'&&condition.conditions[i].relation=='is'&&condition.conditions[i].values.length==1&&condition.conditions[i].values[0]&&condition.conditions[i].values[0].valid!='project_token'&&condition.conditions[i].values[0].id!==undefined&&project_ids.indexOf(condition.conditions[i].values[0].id)==-1){projects.push(condition.conditions[i].values[0]);project_ids.push(condition.conditions[i].values[0].id);}}else{var sub_projects=this._get_filter_projects(condition.conditions[i]);for(var j=0;j<sub_projects.length;j++)
if(sub_projects[j].id!=undefined&&project_ids.indexOf(sub_projects[j].id)==-1){projects.push(sub_projects[j]);project_ids.push(sub_projects[j].id);}}}
return projects;},substitute_filter_tokens:function(condition_hash,__parent_entity){if(!__parent_entity)
__parent_entity=this.context.get('entity');var i;if(condition_hash.path){if(condition_hash.path.indexOf("logged_in_user_token")>-1){var value=false;if(condition_hash.path=="logged_in_user_token"){switch(condition_hash.relation){case'is':value=(condition_hash.values[0].type=='HumanUser'&&condition_hash.values[0].id==SG.globals.current_user.id);break;case'is_not':value=(condition_hash.values[0].type!='HumanUser'||condition_hash.values[0].id!=SG.globals.current_user.id);break;case'name_contains':value=SG.globals.current_user.display_name.indexOf(condition_hash.values[0])>-1;break;case'name_not_contains':value=SG.globals.current_user.display_name.indexOf(condition_hash.values[0])==-1;break;}}
else if(condition_hash.path=="logged_in_user_token.groups"){switch(condition_hash.relation){case'is':value=(condition_hash.values[0].type=='Group'&&SG.globals.current_user.group_ids.indexOf(condition_hash.values[0].id)>-1);break;case'is_not':value=(condition_hash.values[0].type=='Group'&&SG.globals.current_user.group_ids.indexOf(condition_hash.values[0].id)==-1);break;}}
condition_hash.path='id';condition_hash.values=[0];if(value)
condition_hash.relation='is_not';else
condition_hash.relation='is';}
for(i=0;i<condition_hash.values.length;i++){if(condition_hash.values[i]){if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="logged_in_user_token")
condition_hash.values[i]=SG.globals.current_user.entity_hash;else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="parent_entity_token")
condition_hash.values[i]=__parent_entity;else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="project_token")
condition_hash.values[i]=this.single_project_from_context();else if(condition_hash.values[i].date_token)
condition_hash.values[i]=Date.sg_date_for_token(condition_hash.values[i]);}}}else if(condition_hash.subquery){var conditions=condition_hash.subquery.filters.conditions;for(i=0;i<conditions.length;i++)
this.substitute_filter_tokens(conditions[i],__parent_entity);}else{var conditions=condition_hash.conditions;for(i=0;i<conditions.length;i++)
this.substitute_filter_tokens(conditions[i],__parent_entity);}},get_user_token:function(){var token_entity={type:"HumanUser",id:0,name:"Me",valid:"logged_in_user_token"};this.refresh_filter_token(token_entity);return token_entity;},get_entity_token:function(force_entity_type){var token_entity={type:"Entity",id:0,name:"Current Entity",valid:"parent_entity_token"};this.refresh_filter_token(token_entity,force_entity_type);return token_entity;},get_project_token:function(){var token_entity={type:"Project",id:0,name:"Current Project",valid:"project_token"};this.refresh_filter_token(token_entity);return token_entity;},get_tokens_by_context:function(schema_field){if(schema_field.data_type!='entity'&&schema_field.data_type!='multi_entity')
return[];var tokens=[];var allowed_types=SG.schema.allowed_entity_types_for_autocomplete(schema_field);if(allowed_types.indexOf('HumanUser')>-1){tokens.push(this.get_user_token());}
var single_project=this.single_project_from_context();if(allowed_types.indexOf('Project')>-1&&single_project){tokens.push(this.get_project_token());}
var parent_entity=this.context.get('entity');if(parent_entity&&(allowed_types.indexOf(parent_entity.type)>-1))
tokens.push(this.get_entity_token());return tokens;},refresh_filter_token:function(token_entity,force_entity_token_type){if(token_entity.valid=="logged_in_user_token"){token_entity.name="Me";}else if(token_entity.valid=="parent_entity_token"){if(this.context.get('entity')||force_entity_token_type){if(force_entity_token_type){token_entity.type=force_entity_token_type;token_entity.name="Current "+SG.schema.entity_types[force_entity_token_type].display_name;}else{var parent_entity=this.context.get('entity');token_entity.type=parent_entity.type;token_entity.name="Current "+SG.schema.entity_types[parent_entity.type].display_name+" ("+parent_entity.name+")";}}else{token_entity.type="Entity";token_entity.name="Current Entity";}}else if(token_entity.valid=="project_token"){var single=this.single_project_from_context();if(single){token_entity.name='Current '+SG.schema.entity_types.Project.display_name
+' ('+single.name+')';}else{token_entity.name='Current Project';}}},refresh_token_entities_in_filters:function(condition,force_entity_token_type){for(var i=0;i<condition.conditions.length;i++){if(condition.conditions[i].path){for(var j=0;j<condition.conditions[i].values.length;j++){if(condition.conditions[i].values[j]&&condition.conditions[i].values[j].valid)
this.refresh_filter_token(condition.conditions[i].values[j],force_entity_token_type);}}
else
this.refresh_token_entities_in_filters(condition.conditions[i],force_entity_token_type);}},get_new_entity_defaults_from_context:function(){var info=this._get_entity_type_and_filters_from_context();var entity_type=info.entity_type;var filters=info.filters;var rec=new SG.Data.Record(entity_type);filters=sg_deep_copy(filters);this.substitute_filter_tokens(filters);this._get_new_entity_defaults_from_filters(entity_type,filters,rec);rec.set('id',null);rec.set('created_by',null);rec.set('updated_by',null);rec.set('created_at',null);rec.set('updated_at',null);if(SG.schema.entity_types[entity_type].has_projects)
rec.set('project',this.single_project_from_context());var entity=this.context.get('entity');if(entity_type=='Task'&&entity&&entity.type=='TaskTemplate'){var row=SG.Repo.get_row('TaskTemplate',entity.id);rec.set('task_template.TaskTemplate.entity_type',row.get('entity_type'));}
return rec;},_get_entity_type_and_filters_from_context:function(){return{entity_type:this.context.get('entity_type'),filters:this.context.get('filters')};},get_parent_link_fields_from_context:function(){var info=this._get_entity_type_and_filters_from_context();var entity_type=info.entity_type;var filters=info.filters;if(!filters){filters=this.get('filters');entity_type=this.get('entity_type');}
if(!filters||!entity_type)
return[];var rec=new SG.Data.Record(entity_type);this._get_new_entity_defaults_from_filters(entity_type,filters,rec);var join_fields=[];var fields=rec.get_fields();for(var i=0;i<fields.length;i++){var val=rec.get(fields[i]);if(val===null)
continue;if((val.valid&&val.valid=='parent_entity_token')||(val.length&&val.length==1&&val[0].valid&&val[0].valid=='parent_entity_token')){if(join_fields.indexOf(fields[i])==-1)join_fields.push(fields[i]);}
if((val.valid&&val.valid=='project_token')||(val.length&&val.length==1&&val[0].valid&&val[0].valid=='project_token')){if(join_fields.indexOf(fields[i])==-1)
join_fields.push(fields[i]);}}
return join_fields;},get_through_join_fields:function(){var ret=[];var schema=SG.schema.entity_fields[this.context.get('entity_type')];var link_fields=this.get_parent_link_fields_from_context();for(var f=0;f<link_fields.length;f++){var parent_entity_link_field=link_fields[f];if(parent_entity_link_field&&schema[parent_entity_link_field]&&schema[parent_entity_link_field].through_join_entity_type){var through_join_entity_type=schema[parent_entity_link_field].through_join_entity_type;var bubble_down_field_names=SG.schema.entity_types[through_join_entity_type].fields_sorted_by_display_name;var bubble_down_fields=SG.schema.entity_fields[through_join_entity_type];var fields=[];for(var i=0;i<bubble_down_field_names.length;i++){if(bubble_down_fields[bubble_down_field_names[i]].grid_column==false)
continue;var field_type=bubble_down_fields[bubble_down_field_names[i]].field_type;if((['dynamic','system_owned'].indexOf(field_type)==-1)&&(['updated_at','updated_by','created_at','created_by'].indexOf(bubble_down_field_names[i])==-1))
{continue;}
var field=sg_deep_copy(bubble_down_fields[bubble_down_field_names[i]]);field.field_reference_name=SG.schema.generate_field_reference_name({type:"join",base_field:parent_entity_link_field,bubble_source_entity_type:through_join_entity_type,bubbled_up_field:field.name});fields.push(field);}
ret.push({parent_entity_link_field:schema[parent_entity_link_field],fields:fields});}}
return ret;},_get_new_entity_defaults_from_filters:function(entity_type,condition,rec){for(var i=0;i<condition.conditions.length;i++){var cond=condition.conditions[i];if(cond.path){if(cond.active!='false'&&SG.schema.is_simple_field(entity_type,cond.path)){var field=SG.schema.get_field(entity_type,cond.path);if(!field)
continue;var data_type=field.data_type;if(data_type=='date_time')continue;var val=cond.values[0];if(val===null)
continue;else if(data_type=='multi_entity')
val=[val];var previous_val=rec.get(cond.path);if(data_type=='status_list'&&field.status_list_subset.indexOf(val)===-1){continue;}
if(previous_val===null&&cond.relation=='is'){rec.set(cond.path,val);}else{if(data_type=='multi_entity'){if(previous_val===null)
previous_val=[];if(cond.relation=='is'){for(var j=0;j<val.length;j++){if(val[j]&&val[j].type){var found=false;for(var k=0;(k<previous_val.length&&!found);k++)
if(previous_val[k].type==val[j].type&&previous_val[k].id==val[j].id)
found=true;if(!found)
previous_val.push(val[j]);}}}
rec.set(cond.path,previous_val);}else{rec.set(cond.path,null);}}}}else{this._get_new_entity_defaults_from_filters(entity_type,cond,rec);}}},find_child_widget:function(name,type){if(name==this.__name_in_parent__&&type==this.get('type'))
return this;if(!this.__child_widgets__)
return null;for(var i=0;i<this.__child_widgets__.length;i++){var child_widget=this.__child_widgets__[i];var candidate=child_widget.find_child_widget(name,type);if(candidate!=null)
return candidate;}
return null;},get_summary:function(field_name){var column_settings=this.get('columns')||this.get('field_properties');if(column_settings){for(var i=0;i<column_settings.length;i++){var field_hash=column_settings[i];if(field_hash.field==field_name){if(field_hash.summary)
return field_hash.summary;}}}
var entity_type=this.entity_type;if(!entity_type){if(this.entity)
entity_type=this.entity.type;else
return{column:field_name,type:'none',value:null};}
var schema_field=SG.schema.get_field(entity_type,field_name);return SG.schema.get_summary_default(schema_field);},replace_entity_name_in_static_text:function(entity_type,text){var entity_schema=SG.schema.entity_types[entity_type];var t1=text.replace(entity_schema.name,entity_schema.display_name);var t2=t1.replace(entity_schema.name_pluralized,entity_schema.display_name_pluralized);return t2;},on_custom_external_action:function(selected_entity,action_url){var req={user_id:SG.globals.current_user.id,user_login:SG.globals.current_user.login,entity_type:selected_entity.type,selected_ids:selected_entity.id,ids:selected_entity.id,server_hostname:SG.globals.hostname};var project=this.single_project_from_context();if(project){req.project_name=project.name;req.project_id=project.id;}
if(action_url.match(":")&&action_url.indexOf('http')!==0){document.location=action_url+"?"+Ext.urlEncode(req);}else{var form=Ext.get("custom_request_form").dom;var ff,key;Ext.fly(form).update("");form.action=action_url;for(key in req){if(req.hasOwnProperty(key)){ff=document.createElement("INPUT");ff.type="hidden";ff.name=key;ff.value=req[key];form.appendChild(ff);}}
form.submit();}},design_mode_on_detail_page:function()
{if(!this.context.get('design_mode'))return false;var widget=this;while(widget.get_parent){widget=widget.get_parent();if(!widget||!widget.get)return false;var type=widget.get('type');if(['SG.Widget.DetailPageBody','SG.Widget.ThreadedDetailPage'].indexOf(type)!=-1)
return true;}
return false;},edit_widget:function(entity_type)
{var cfg={source:this,root_widget_entity_type:entity_type};this.set_silent('configured',true);this.widget_editor=new SG.Widget.Canvas.WidgetEditor(cfg);},replace_wrapper:function(widget,spec_hash){var name=widget.get_name_in_parent();this.widget_spec.replace_child_spec(name,spec_hash["children"]["child"],this);var old_widget=this.get_child(name);var old_widget_container=old_widget.get_container();old_widget_container.setDisplayed(false);var ctx=this.context.clone();var new_widget=this.construct_child(name,ctx);var html=this.templates.__widget__.apply({widget_cls:new_widget.get_css_class_name(),widget_id:new_widget.get_container_id(),});Ext.DomHelper.insertBefore(old_widget_container,html);new_widget.render();this.destroy_child(old_widget);old_widget_container.remove();},});SG.SettingsUtil={__get_setting__:function(name,settings)
{if(name.indexOf(".")>-1)
{var path=name.split(".");var obj=settings;var i=0;for(i=0;i<path.length-1;i++)
{var next_obj=obj[path[i]];if(!next_obj)
return;obj=next_obj;}
return obj[path[i]];}
else
return settings[name];},__set_setting__:function(name,value,settings)
{if(name.indexOf(".")>-1)
{var path=name.split(".");var obj=settings;var i=0;for(i=0;i<path.length-1;i++)
{var next_obj=obj[path[i]];if(!next_obj){obj[path[i]]={};next_obj=obj[path[i]];}
obj=next_obj;}
obj[path[i]]=value;}
else
settings[name]=value;},__delete_setting__:function(name,settings)
{if(name.indexOf(".")>-1)
{var path=name.split(".");var obj=settings;var i=0;for(i=0;i<path.length-1;i++)
{var next_obj=obj[path[i]];if(!next_obj)
return;obj=next_obj;}
delete obj[path[i]];}
else
delete settings[name];}}
SG.Widget.Spec=function(parent_widget_spec,spec_hash)
{this.parent_spec=parent_widget_spec;this.type=spec_hash['type'];this.settings=spec_hash['settings']||{};if('uuid'in spec_hash){this.uuid=spec_hash['uuid'];}
this.child_specs={};this.widgets=[];var children_spec_hash=spec_hash['children']||{};for(var c in children_spec_hash)
{if(children_spec_hash.hasOwnProperty(c))
{this.child_specs[c]=new SG.Widget.Spec(this,children_spec_hash[c]);}}};SG.Widget.Spec.prototype={to_hash:function(){var h={};h.type=this.type;h.settings=this.settings;h.children={};if(this.uuid)
h.uuid=this.uuid;var child_name;for(child_name in this.child_specs)
{if(this.child_specs.hasOwnProperty(child_name))
{var child_spec=this.child_specs[child_name];var ch=child_spec.to_hash();h.children[child_name]=ch;}}
return h;},get_type:function(){return this.type;},get_setting:function(name){if(name=='type')
return this.get_type();else
return SG.SettingsUtil.__get_setting__(name,this.settings);},set_setting:function(widget,name,value,silent)
{SG.SettingsUtil.__set_setting__(name,value,this.settings);var change_hash={};change_hash[name]=value;if(!silent)
this.on_settings_changed(change_hash,widget,this);},set_settings:function(widget,update_hash,silent)
{for(var update_key in update_hash)
{if(!update_hash.hasOwnProperty(update_key))
continue;SG.SettingsUtil.__set_setting__(update_key,update_hash[update_key],this.settings);}
if(!silent)
this.on_settings_changed(update_hash,widget,this);},delete_settings:function(setting_names)
{for(var i=0;i<setting_names.length;i++)
SG.SettingsUtil.__delete_setting__(setting_names[i],this.settings);var change_hash={};for(var i=0;i<deleted_settings.length;i++)
change_hash[deleted_settings[i]]=null;this.on_settings_changed(change_hash,source_widget,source_spec);},on_settings_changed:function(change_hash,source_widget,source_spec)
{var own_setting=(this==source_spec);for(var i=0;i<this.widgets.length;i++)
{if(this.widgets[i])
{if(own_setting)
this.widgets[i].spec_settings_changed(change_hash,source_widget);else
this.widgets[i].descendent_spec_settings_changed(change_hash,source_widget,source_spec);}}
if(this.parent_spec)
this.parent_spec.on_settings_changed(change_hash,source_widget,source_spec);},override_setting:function(spec_path,setting_name,value){var spec=this.get_descendent_spec(spec_path);if(spec){SG.SettingsUtil.__set_setting__(setting_name,value,spec.settings);return true;}else{return false;}},name_of_child:function(child_spec){for(var i=0;i<this.child_specs.length;i++){if(this.child_specs[i]==child_spec)
return}
for(var child_name in this.child_specs){if(this.child_specs.hasOwnProperty(child_name)&&child_spec==this.child_specs[child_name]){return child_name;}}},spec_path:function(){if(this.parent_spec&&!this.is_root){var parent_path=this.parent_spec.spec_path();return(parent_path.concat(this.parent_spec.name_of_child(this)));}else{return[];}},get_descendent_spec:function(spec_path){if(spec_path.length==0)
return this;if(this.child_specs.hasOwnProperty(spec_path[0])){var child_spec=this.child_specs[spec_path[0]];var len=spec_path.length;if(!child_spec){return null;}else if(len==1){return child_spec;}else{return child_spec.get_descendent_spec(spec_path.slice(1));}}else{return null;}},get_parent_spec:function(){return this.parent_spec;},get_child_spec:function(child_name){return this.child_specs[child_name];},override_child:function(spec_path,spec_hash){if(spec_path.length<2)
throw"Can't override top-level page spec.";var child_name=spec_path.pop();var parent_spec=this.get_descendent_spec(spec_path);if(parent_spec){if(spec_hash===''){if(parent_spec.child_specs.hasOwnProperty(child_name)){delete parent_spec.child_specs[child_name];}else{return false;}}
else{parent_spec.child_specs[child_name]=new SG.Widget.Spec(parent_spec,spec_hash);}
return true;}else{return false;}},clone_child_spec:function(child_name_to_clone,new_child_name,widget){var to_clone=this.get_child_spec(child_name_to_clone);var to_clone_hash=to_clone.to_hash();var new_hash=sg_deep_copy(to_clone_hash);this.child_specs[new_child_name]=new SG.Widget.Spec(this,new_hash);var change_hash={__CHILD__:this.child_specs[new_child_name].to_hash()};this.on_settings_changed(change_hash,widget,this.child_specs[new_child_name]);},create_child_spec:function(new_child_name,new_spec_hash,widget){this.child_specs[new_child_name]=new SG.Widget.Spec(this,new_spec_hash);var change_hash={__CHILD__:this.child_specs[new_child_name].to_hash()};this.on_settings_changed(change_hash,widget,this.child_specs[new_child_name]);},delete_child_spec:function(child_name,widget){var change_hash={__CHILD__:''};this.on_settings_changed(change_hash,widget,this.child_specs[child_name]);delete this.child_specs[child_name];},replace_child_spec:function(child_name,new_hash,widget){this.child_specs[child_name]=new SG.Widget.Spec(this,new_hash)
var change_hash={__CHILD__:this.child_specs[child_name].to_hash()};this.on_settings_changed(change_hash,widget,this.child_specs[child_name]);},get_child_names:function(){var cn=[];var child_name;for(child_name in this.child_specs)
{if(this.child_specs.hasOwnProperty(child_name))
cn.push(child_name);}
return cn;},add_settings_listener:function(widget){this.widgets.push(widget);},remove_settings_listener:function(widget){var i=this.widgets.indexOf(widget);if(i!=-1)
delete this.widgets[i];},clear_settings:function()
{this.settings={};var child_name;for(child_name in this.child_specs)
{if(this.child_specs.hasOwnProperty(child_name))
{var child_spec=this.child_specs[child_name];child_spec.clear_settings();}}},};SG.Widget.Factory=new function()
{this.widget_id_count=0;this.get_widget_class=function(type)
{var arr=type.split('.');var obj=window;for(var i=0;i<arr.length;i++){if(arr[i]in obj)
obj=obj[arr[i]];else
return null;}
return obj};this.construct_widget=function(parent,context,spec)
{var widget_type=spec.get_type();var widget_class=this.get_widget_class(widget_type);if(widget_class===null){context.set('message','Error: Invalid widget type '+widget_type);spec.type='SG.Widget.WarningMessage';widget_class=SG.Widget.WarningMessage;}
this.widget_id_count++;var w=new widget_class(context,spec,this.widget_id_count);spec.add_settings_listener(w);context.on("context_changed",w.fire_context_changed,w);return w;};};SG.Widget.Settings=function(settings)
{this.settings={};Ext.apply(this.settings,settings);this.events={'settings_changed':true};};Ext.extend(SG.Widget.Settings,Ext.util.Observable,{get:function(key){return this.settings[key];},set:function(key,value){this.settings[key]=value;this.persist_settings();this.fireEvent('settings_changed',key,value);}});SG.Widget.Context=function(settings)
{this.settings={};Ext.apply(this.settings,settings);this.events={'context_changed':true};};Ext.extend(SG.Widget.Context,Ext.util.Observable,{get:function(key){return this.settings[key];},set:function(key,value){this.settings[key]=value;this.fireEvent('context_changed',key,value);},set_silent:function(key,value){this.settings[key]=value;},delete_key:function(key)
{delete this.settings[key];this.fireEvent('context_changed',key,undefined);},clone:function()
{var new_context=sg_deep_copy(this.settings);return new SG.Widget.Context(new_context);},keys:function()
{var keys=[];for(var key in this.settings)
{if(this.settings.hasOwnProperty(key))
keys.push(key);}
return keys;}});SG.Widget.EntityQueryMode=function(context,widget_spec,id)
{this.events={'entities_selected':true};SG.Widget.EntityQueryMode.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityQueryMode,SG.Widget.Base,{templates:{toolbar_sorting_menu:'<span class="label">Sort</span><div class="dropdown_arrow_small"></div>',},set_data_store_max_records:function(num_recs)
{alert(this.get('type')+' has not implemented set_data_store_max_records()');},set_data_store_page:function(page_num)
{alert(this.get('type')+' has not implemented set_data_store_page()');},reload_all_entities:function()
{alert(this.get('type')+' has not implemented reload_all_entites()');},on_entities_loaded:function(){this.__get_entity_query_page__().on_content_widget_entities_reloaded();},work_schedule_changed:function()
{if(this.entity_type=='Task')
this.reload_all_entities();},get_entity_data_store:function()
{alert(this.get('type')+' has not implemented get_entity_data_store()');},get_toolbar_items:function()
{alert(this.get('type')+' has not implemented get_toolbar_items()');return[];},get_left_footer_render_callback:function()
{return null;},get_action_menu_items:function(items,target_elem,xy)
{alert(this.get('type')+' has not implemented get_action_menu_items()');return[];},multi_edit_selected:function()
{alert(this.get('type')+' has not implemented multi_edit_selected()');},in_selection_cache:function(group_idx,record_idx)
{var sel_man=this.__get_selection_manager__();return sel_man.in_selection_cache(group_idx,record_idx);},get_selected_record_ids:function()
{var sel_man=this.__get_selection_manager__();return sel_man.get_selected_record_ids();},get_selected_group_indexes:function()
{var sel_man=this.__get_selection_manager__();return sel_man.get_selected_group_indexes();},clear_selection:function()
{var sel_man=this.__get_selection_manager__();sel_man.clear_selection();},select_all:function()
{var sel_man=this.__get_selection_manager__();sel_man.select_all();},select:function(elem)
{var sel_man=this.__get_selection_manager__();sel_man.clear_selection();sel_man.select_entity(elem);},select_first_record:function()
{var sel_man=this.__get_selection_manager__();sel_man.clear_selection();var set=this.get_entity_data_store();if(set.count()===0)
return;if(set.is_grouped())
sel_man.add_entity_to_selection_cache(0,set.get_group(0).ids[0]);else
sel_man.add_entity_to_selection_cache(-1,set.get_ids()[0]);sel_man.fire_selection_callback();},__get_selection_manager__:function()
{if(!this.__selection_manager__)
{var p=this.parent;while(p)
{if('selection_manager'in p&&p.selection_manager instanceof SG.SelectionManager)
break;p=p.parent;}
this.__selection_manager__=p.selection_manager;}
return this.__selection_manager__;},render_empty_message:function(entity_type,container)
{this.__get_entity_query_page__().render_empty_message(entity_type,container);},on_create_new_entity:function(){var parent_widget=this.__get_entity_query_page__();parent_widget.create_new_entity();},show_nested_grouping_dialog:function(column_display_names)
{var entity_query_page=this.__get_entity_query_page__();entity_query_page.show_nested_grouping_dialog(column_display_names);},__get_entity_query_page__:function()
{var parent_widget=this.get_parent();while(!(parent_widget instanceof SG.Widget.EntityQuery.EntityQueryPage)){parent_widget=parent_widget.get_parent();}
return parent_widget;},get_filters:function(){var filters=sg_deep_copy(this.context.get("filters"));var pivot_from_type=this.context.get('pivot_from_type');var pivot_field=this.context.get('pivot_field');var pivot_filters=sg_deep_copy(this.context.get('pivot_filters'));if(pivot_from_type)
{var no_active_filters=(sg_count_active_filters(filters)==0);if(!pivot_filters)
pivot_filters={logical_operator:"and",conditions:[]};filters=sg_pivot_condition_hash(pivot_from_type,pivot_field,filters);filters={logical_operator:'and',conditions:[filters,pivot_filters]};if(no_active_filters)
filters.conditions.push({path:pivot_field,relation:'type_is',values:[pivot_from_type]});}
this.substitute_filter_tokens(filters);return filters;},get_grouping:function(){var grouping=this.context.get('grouping');if(grouping)
{grouping=sg_deep_copy(grouping);return grouping;}
else
return false;},set_grouping:function(grouping)
{var parent_widget=this.__get_entity_query_page__();parent_widget.set_grouping_settings(grouping);},get_group_settings:function()
{var group_settings=this.context.get('group_settings');return group_settings;},set_group_settings:function(val)
{var parent_widget=this.__get_entity_query_page__();if(this.context.get('pivot_field'))
parent_widget.set('pivot_group_settings',val);else
parent_widget.set('group_settings',val);},get_group_state:function(group){var val=this.group_state_key(group);var gset=this.get_group_settings();if(gset[val]){return gset[val];}else{return'open';}},set_group_state:function(group,state){var val=this.group_state_key(group);var gset=this.get_group_settings();gset[val]=state;this.set_group_settings(gset);this.fireEvent('groups_toggled');},group_state_key:function(group)
{if(group.synthetic)
{var temp=group.values.slice(0,group.depth+1);return temp.join('=>');}
else
return group.values.join('=>');},toggle_all_groups:function(state){if(state=='open')
this.set_group_settings({});else
{var gset={};var group,i;var data_set=this.get_entity_data_store();for(i=0;i<data_set.group_count();i++)
{var group=data_set.get_group(i);gset[this.group_state_key(group)]='closed';}
for(i in data_set.synthetic_group_map)
{if(!data_set.synthetic_group_map.hasOwnProperty(i))
continue;group=data_set.synthetic_group_map[i];gset[this.group_state_key(group)]='closed';}
this.set_group_settings(gset);}
this.render_widget();this.fireEvent('groups_toggled');},clear_group_summaries:function()
{var data_set=this.get_entity_data_store();data_set.group_summaries=null;data_set.footer_wait_for_grouped_summaries=false;},request_group_counts:function(summary_set)
{var data_set=this.get_entity_data_store();var group_count=data_set.group_count();if(group_count===0)return;var grouping=this.get_grouping();var page_filters=this.get_filters();var first_group=data_set.get_group(0);var server_side=this.context.get('server_side_filters');var spec,group_filters;group_filters=SG.schema.filters_for_grouping(this.entity_type,grouping,first_group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:[{column:'id',type:'record_count'}],result:summary_set,result_key:'first_group_count'};if(server_side)spec.server_side_filters=server_side;SG.Repo.summarize(spec);var grouped_by_multi_entity=false;for(var i=0;i<grouping.length;i++)
{var group_field=SG.schema.get_field(this.entity_type,grouping[i].column)
if(group_field&&group_field.data_type=='multi_entity')
grouped_by_multi_entity=true;}
if(grouped_by_multi_entity)
{var summaries=[{column:'id',type:'record_count'}];spec={type:this.entity_type,filters:page_filters,grouping:grouping,summaries:summaries,result:data_set,result_key:'grouped_summaries'}
SG.Repo.summarize(spec);data_set.footer_wait_for_grouped_summaries=true;}
else
{data_set.group_summaries=null;data_set.footer_wait_for_grouped_summaries=false;}
var synth_grping;for(i in data_set.synthetic_group_map)
{if(!data_set.synthetic_group_map.hasOwnProperty(i))
continue;group=data_set.synthetic_group_map[i];var low_idx=Number(group.idx.split('_')[0]);if(low_idx!=0)
continue;synth_grping=grouping.slice(0,group.depth+1);group_filters=SG.schema.filters_for_grouping(this.entity_type,synth_grping,group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:[{column:'id',type:'record_count'}],result:summary_set,result_key:'first_group_count_'+group.idx};if(server_side)spec.server_side_filters=server_side;SG.Repo.summarize(spec);}
if(group_count!=1){var last_group=data_set.get_group(group_count-1);group_filters=SG.schema.filters_for_grouping(this.entity_type,grouping,last_group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:[{column:'id',type:'record_count'}],result:summary_set,result_key:'last_group_count'};if(server_side)spec.server_side_filters=server_side;SG.Repo.summarize(spec);for(i in data_set.synthetic_group_map)
{if(!data_set.synthetic_group_map.hasOwnProperty(i))
continue;group=data_set.synthetic_group_map[i];var high_idx=Number(group.idx.split('_')[1]);if(high_idx!=data_set.group_count()-1)
continue;synth_grping=grouping.slice(0,group.depth+1);group_filters=SG.schema.filters_for_grouping(this.entity_type,synth_grping,group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:[{column:'id',type:'record_count'}],result:summary_set,result_key:'last_group_count_'+group.idx};if(server_side)spec.server_side_filters=server_side;SG.Repo.summarize(spec);}}},render_group_header_tooltip:function(group,depth,column_display_names)
{var sg_tip='';var all_grouping=this.get_grouping();for(var i=0;i<all_grouping.length;i++)
{var grouping=all_grouping[i];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);if(i==depth)sg_tip+='[[b]]';for(var j=0;j<i;j++)
sg_tip+='&nbsp;&nbsp;&nbsp;';var field_display_name=schema_field.display_name;if(column_display_names&&column_display_names[schema_field.name])
field_display_name=column_display_names[schema_field.name];sg_tip+='> '+field_display_name;if(i<=depth)
{var display_value=group.display_values[i];if(display_value==='')
display_value="No "+schema_field.display_name;if(typeof display_value==='string')
display_value=display_value.replace(/\"/g,'&#34;');sg_tip+=': '+display_value;}
if(i==depth)sg_tip+='[[/b]]';sg_tip+='[[br]]';}
return sg_tip;},get_custom_external_action_columns:function()
{return[];},get_custom_external_action_column_display_name:function(col)
{return null;},get_custom_external_action_sorts:function()
{return[];},});SG.QuickJump=function(config)
{Ext.apply(this,config);SG.QuickJump.superclass.constructor.call(this,config);};Ext.extend(SG.QuickJump,SG.Component,{templates:{main:'<div class="quick_jump_input">'+'<div class="left quick_jump_left"></div>'+'<input class="qj" type="text" value="{text}" style="width:{input_width}px;"></input>'+'<div class="right quick_filter_right"></div><div class="floater clear"></div></div>',autocomplete_results_link:' (<div class="sg_entity_icon_span {icon_name}">'+'</div>{name})',page_results_item_html:'<span class="page_result">'+'<span class="page_label">Page:</span>&nbsp;<div class="sg_menu_icon">'+'<div class="sg_menu_icon_image_div {icon_name}" {img_style}>&nbsp;</div></div>{content}</span>'},entity_type:'all_entity_types',project_id:0,on_first_render:function()
{this.rendered_once=true;if(!this.prompt_html)
this.prompt_html='Jump to something by typing its name';this.add_event(SG.schema,'reloaded',this.schema_reloaded);},schema_reloaded:function()
{this.setup_autocomplete();this.set_help_text();},render:function()
{if(!this.rendered_once)
this.on_first_render();if(!this.container)
this.container=Ext.get(this.container_id);var input_width=Number(this.container.getWidth())-43;this.container.update(this.templates.main.apply({input_width:input_width,text:'',}));this.quick_jump_div=this.container.child('div.quick_jump_input');this.input=this.container.child('input');this.add_event(this.input,"keydown",this.on_keydown);this.floater=this.container.child('div.floater');this.add_event(this.quick_jump_div,"click",this.on_click);this.setup_autocomplete();this.listbox.render();if(!this.not_global_quick_jump)
SG.globals.quick_jump_component=this;var db=Ext.get(document.body);this.add_event(db,'click',this.on_document_click);this.set_help_text();},setup_autocomplete:function()
{var quick_jump_project_cookie=getCookie("quick_jump_project_id");var quick_jump_entities_cookie=getCookie("quick_jump_entities");if(quick_jump_project_cookie)
this.project_id=quick_jump_project_cookie;else
this.project_id=0;if(this.locked_to_entity_types)
{this.setup_listbox(this.locked_to_entity_types);}
else if(quick_jump_entities_cookie)
{this.entity_type=quick_jump_entities_cookie;if(this.entity_type!='all_entity_types')
this.setup_listbox([this.entity_type]);else
this.setup_listbox(this.get_all_quick_jump_entities());}
else
{this.entity_type='all_entity_types';this.setup_listbox(this.get_all_quick_jump_entities());}},setup_listbox:function(entity_types)
{this.current_entity_types=entity_types;if(!this.listbox)
{this.listbox=new SG.ListBox({menu_class:this.menu_class?this.menu_class:'quick_jump_listbox',items:[{disabled:true,html:this.prompt_html}],position:{dom_elem:this.input.dom,elem_anchor:"bl",menu_anchor:"tl",no_cover:true},autocomplete:{input_dom:this.input.dom,prompt_menu_items_callback:this.prompt_menu_items_callback,waiting_menu_items_callback:this.waiting_menu_items_callback,prompt_html:this.prompt_html,request_url:SG.globals.urls.entity_autocomplete,parameters_callback:{fn:this.request_params,scope:this},response_callback:{fn:this.on_autocomplete_response,scope:this},selection_callback:{fn:this.item_selected,scope:this},close_on_blur:true}});}},request_params:function(search_text)
{this.show_autocomplete_spinner();var request_params={query:search_text,sg_autocomplete:true};request_params.complete_classes=Ext.encode(SG.schema.convert_entity_types_for_autocomplete(this.current_entity_types));if(this.project_id!=0)
request_params.project_ids=Ext.encode([this.project_id]);return request_params;},icon_name_for_entity:function(entity_hash)
{if(entity_hash.type==='Page'){var parts=entity_hash.subtype.split('|');if(parts[1])
return SG.schema.entity_icon_name(parts[1]);else if(parts[0]==='url')
return'icon_url';else
return'icon_Page';}
var icon_name='icon_'+entity_hash.type;if(entity_hash.type==="HumanUser"&&entity_hash.status==="dis")
icon_name="icon_HumanUserDisabled";return icon_name;},on_autocomplete_response:function(response)
{this.hide_autocomplete_spinner();var matches=response.matches;var search_terms=response.terms;var items=[];for(var i=0;i<matches.length;i++)
{var icon_name=this.icon_name_for_entity(matches[i]);var entity_html=this.highlight_search_terms(search_terms,matches[i].name);if(matches[i].subtype&&matches[i].type!=='Page')
entity_html+=" - "+matches[i].subtype;if(matches[i].type!=='HumanUser'&&matches[i].status){entity_html+=" "+SG.Renderers.render_one_status_icon(matches[i].status);}
if(matches[i].type!=='Project'&&matches[i].type!=='Page'&&matches[i].project_id){var project=SG.schema.project_by_id(matches[i].project_id);if(project)
entity_html+=' - '+project.name;}
var links_str='';linked_data_types=['HumanUser','ApiUser','Ticket','Delivery']
if(SG.globals.custom_for=="shotgun")
linked_data_types.push('ZendeskTicket')
if(linked_data_types.indexOf(matches[i].type)>-1){entity_html+=' ('+this.highlight_search_terms(search_terms,matches[i].links[1])+')';}
else if(matches[i].type==='Page'){entity_html=this.templates.page_results_item_html.apply({icon_name:icon_name,content:entity_html+' - '+this.highlight_search_terms(search_terms,matches[i].links[1])});icon_name='blank';}
else{if(matches[i].links[1]!=='')
{entity_html+=this.templates.autocomplete_results_link.apply({icon_name:"icon_"+matches[i].links[0],name:this.highlight_search_terms(search_terms,matches[i].links[1])});}}
items.push({icon_name:icon_name,html:entity_html,value:matches[i]});}
return items;},highlight_search_terms:function(search_terms,result)
{var result_lc=result.toLowerCase();var idx,term,indices=[];for(var i=0;i<search_terms.length;++i)
{term=search_terms[i];idx=result_lc.indexOf(term);if(idx!==-1){indices.push([idx,idx+term.length-1]);}}
indices.sort(function(a,b){return a[0]-b[0];});if(indices.length>0)
{var combined_indices=[];var low=indices[0][0];var high=indices[0][1];idx=0;while(idx<indices.length)
{if(idx===indices.length-1)
{high=indices[idx][1];combined_indices.push([low,high]);}
else if(indices[idx][1]>=indices[idx+1][0])
{high=indices[idx+1][1];}
else
{combined_indices.push([low,high]);low=indices[idx+1][0];high=indices[idx+1][1];}
idx+=1;}
var ret=result.substring(0,combined_indices[0][0]);for(var i=0;i<combined_indices.length;++i)
{ret+='<match>'+result.substring(combined_indices[i][0],combined_indices[i][1]+1)+'</match>';if(i!==combined_indices.length-1&&combined_indices[i][1]+1<combined_indices[i+1][0])
{ret+=result.substring(combined_indices[i][1]+1,combined_indices[i+1][0]);}}
ret+=result.substring(combined_indices[combined_indices.length-1][1]+1,result.length);return ret;}
else
return result;},on_document_click:function(e)
{var t=Ext.get(e.getTarget());var input=t.findParent('input.qj',this.container);if(input)
return;var left_div=t.findParent('div.left',this.container);if(left_div)
return;var floater_div=t.findParent('div.floater.clear',this.container);if(floater_div)
return;var sg_menu_item=t.findParent('div.sg_menu_item',4);if(sg_menu_item)
return;var sg_dialog_mask=t.findParent('div.sg_dialog_mask',4);if(sg_dialog_mask)
return;this.blur_input();},on_click:function(e)
{var t=Ext.get(e.getTarget());var input=t.findParent('input.qj',this.container);if(input)
{if(!this.input.hasClass('ready'))
{this.input.addClass('ready');this.input.dom.value='';}
return;}
var left_div=t.findParent('div.left',this.container);if(left_div)
{var menu=this.get_entity_types_menu();menu.position={xy:e.getXY()};menu.show();return;}
var floater_div=t.findParent('div.floater.clear',this.container);if(floater_div)
{this.quick_key_focus();return;}},clear_input:function()
{this.listbox.hide();this.listbox.items=[];this.set_help_text();this.input.removeClass('ready');this.input.dom.blur();},blur_input:function()
{if(!this.input.hasClass('ready'))
return;this.clear_input();},on_keydown:function(e)
{var key=e.getKey();if(key==e.ESC)
{if(this.input.dom.value=='')
this.blur_input();else
this.quick_key_focus();}},quick_key_focus:function()
{var me=this;setTimeout(function(){me.clear_all()},100);},clear_all:function()
{this.input.dom.value='';this.listbox.autocomplete_request();this.input.addClass('ready');this.input.focus();},item_selected:function(item)
{if(this.item_selected_callback){this.item_selected_callback.fn.call(this.item_selected_callback.scope,item);return;}
SG.Message.show({html:'<b>Loading...</b>'});if(item.value.type==='Page')
window.location='/page/'+item.value.id;else
window.location='/detail/'+item.value.type+'/'+item.value.id;},get_all_quick_jump_entities:function()
{var types=SG.globals.preferences.quick_jump_entities.replace(/ /g,'');types=types.split(',');var all_types=this.locked_to_entity_types||SG.schema.leftnav_page_entity_types;ret=[];for(var i=0;i<all_types.length;i++)
if(types.indexOf(all_types[i])>-1)
ret.push(all_types[i]);return ret;},show_autocomplete_spinner:function()
{this.floater.removeClass('clear');this.floater.addClass('spinner');},hide_autocomplete_spinner:function()
{this.floater.removeClass('spinner');this.floater.addClass('clear');},on_before_show_entity_types_menu:function(menu)
{menu.items=this.get_entity_types_menu_items();menu.render();},get_entity_types_menu:function()
{if(!this.entity_types_menu)
{this.entity_types_menu=this.new_component(SG.Menu,{menu_class:' quick_jump_entity_type_and_project_menu',item_selected:{fn:this.on_entity_type_menu_select,scope:this},before_show:{fn:this.on_before_show_entity_types_menu,scope:this}});}
this.entity_types_menu.render();return this.entity_types_menu;},get_entity_types_menu_items:function()
{var items=[];items.push({html:'All',value:'all_entity_types',checked:this.entity_type=='all_entity_types'});var i;var entity_types=this.get_all_quick_jump_entities();for(i=0;i<entity_types.length;i++)
{items.push({icon_name:'icon_'+entity_types[i],html:SG.schema.entity_types[entity_types[i]]['display_name'],value:entity_types[i],checked:entity_types[i]==this.entity_type});}
items.push({line:true});items.push({html:'All Projects',checked:this.project_id==0,project_id:0,item_selected:{fn:this.on_project_menu_select,scope:this}});for(i=0;i<SG.schema.projects.length;i++)
{items.push({html:SG.schema.projects[i].name,project_id:SG.schema.projects[i].id,checked:this.project_id==SG.schema.projects[i].id,item_selected:{fn:this.on_project_menu_select,scope:this}});}
return items;},on_entity_type_menu_select:function(menu,item)
{this.entity_type=item.value;setCookie("quick_jump_entities",this.entity_type,365);if(item.value=='all_entity_types')
this.setup_listbox(this.get_all_quick_jump_entities());else
this.setup_listbox([item.value]);if(this.input.hasClass('ready'))
{this.listbox.autocomplete_request();var qj=this;setTimeout(function(){qj.input.dom.focus();},100);}
else
this.set_help_text();},on_project_menu_select:function(menu,item)
{this.project_id=item.project_id;setCookie("quick_jump_project_id",this.project_id,365);if(this.entity_type=='all_entity_types')
this.setup_listbox(this.get_all_quick_jump_entities());else
this.setup_listbox([item.value]);if(this.input.hasClass('ready'))
{this.listbox.autocomplete_request();var qj=this;setTimeout(function(){qj.input.dom.focus();},100);}},sidenav_resized:function()
{var w=Number(this.container.getWidth())-43;if(w<50)
this.quick_jump_div.setDisplayed(false);else
{this.quick_jump_div.setDisplayed(true);this.input.setWidth(w);}},set_help_text:function()
{if(this.entity_type=='all_entity_types')
this.input.dom.value='Quick Jump (q)';else
{var dnp=SG.schema.entity_types[this.entity_type].display_name_pluralized;this.input.dom.value='Jump to '+dnp;}},});SG.Widget.Fields=function(context,widget_spec,id)
{SG.Widget.Fields.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Fields,SG.Widget.Base,{default_settings:{columns:[],field_name_column_width:100,show_position:false,all_fields:false},templates:{fields_widget_content_inside_tab:'<div class="sg_widget_fields_intab"><div class="sg_widget_fields_body">'+'<table style="table-layout: fixed">{fields_rows}</table></div></div>',fields_widget_content_not_inside_tab:'<div class="sg_widget_fields_body"><table style="table-layout: fixed">{fields_rows}</table></div>',field_row:'<tr style="line-height:18px;">{field_name}{field_value}</tr>',field_row_empty:'<tr style="line-height:18px;"><td>&nbsp</td><td>&nbsp</td></tr>',field_name:'<td style="width: {field_name_col_width}px" class="sg_widget_fields_cell sg_widget_fields_field_name">'+'<div class="sg_widget_fields_cutter">'+'{field_display_name}</div></td>',field_value:'<td style="{cell_styles}" class="sg_widget_fields_cell {cell_classes}" {cell_attributes}>{cell_content}</td>',},init_widget:function()
{this.events={'widget_resize':true,};this.add_event(this,'settings_changed',this.on_settings_changed);this.add_event(this,'widget_resize',this.on_widget_resize);this.context_entity=this.context.get('entity');this.entity_type=this.context_entity.type;this.entity_set=this.new_data_set(this.context_entity.type,this.on_entity_load);},on_first_render:function()
{this.container=this.get_container();this.contents_div=Ext.DomHelper.append(this.container,{tag:'div',cls:'sg_widget_fields_contents'},true);var cell_config={container:this.container,data_set:this.entity_set,projects:this.context_projects(),field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};if(this.context.get('formatting_rules'))
cell_config.page_formatting_rules=this.context.get('formatting_rules');this.cell_manager=this.new_component(SG.CellManager,cell_config);if(!this.context.get('no_context_menu')||this.get('in_tabs')==true)
{var parent_td=this.container.findParentNode('td.column',2);if(parent_td)
this.add_event(parent_td,"contextmenu",this.on_contextmenu);else
this.add_event(this.container,"contextmenu",this.on_contextmenu);}
this.read_data();},get_field_property_for_cell_manager:function(schema_field){return this.find_field_property(schema_field.name);},get_columns:function(include_spacer)
{var i;if(this.get('all_fields')){var all_fields=SG.schema.entity_types[this.context_entity.type].fields_sorted_by_display_name;var ret_fields=[];for(i=0;i<all_fields.length;i++){if(SG.schema.get_field(this.context_entity.type,all_fields[i]).grid_column)
ret_fields.push(all_fields[i]);}
return ret_fields;}
var col_hash=this.get('columns');var spacer_re=/sg_widget_fields_space/;var add_field=true;var cols=[];var field,schema_field;for(i=0;i<col_hash.length;i++)
{field=col_hash[i]['field']
if(include_spacer&&spacer_re.test(field)){cols.push(field);continue;}
schema_field=SG.schema.get_field(this.context_entity.type,field);if(schema_field)
cols.push(field);}
return cols;},on_settings_changed:function(change_hash,source_widget)
{if(!this.__rendered__)
return;var need_server_call=false;if('columns'in change_hash)
{this.cell_manager.empty_cell_cache();this.read_data();}
else
this.render_widget();},read_data:function(){this.show_loading_overlay();var columns=this.get_columns(false);var spec={type:this.context_entity.type,id:this.context_entity.id,columns:columns,result:this.entity_set,parent_entity:this.context.get('parent_entity')};SG.Repo.find(spec);},on_entity_load:function(){this.record=this.entity_set.get_record(0);this.render_widget();},on_columns_set:function(columns)
{this.set('columns',columns);},label_visible:function(col)
{var col_hash=this.get('columns');for(var i=0;i<col_hash.length;i++)
{if(col_hash[i].field==col)
return col_hash[i].show_label;}
return true;},render_name:function(fieldname)
{var cell=this.cell_manager.get_cell(fieldname);var field_hash=this.find_field_property(fieldname);var display_name;if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_name=field_hash.field_label_override+':';else
display_name=cell.get_field_display_name(fieldname)+':';var display_width=this.get('field_name_column_width');if(!this.label_visible(fieldname))
display_name='&nbsp';var html=this.templates.field_name.apply({field_display_name:display_name,field_name_col_width:display_width});return html;},find_field_property:function(field_name)
{var column_settings=this.get('columns');for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];if(field_hash.field==field_name)
return field_hash;}
return null;},render_value:function(col)
{var cell=this.cell_manager.get_cell(col);var cell_hash=cell.render(this.record);return this.templates.field_value.apply(cell_hash);},render_widget:function(){if(!this.entity_set.is_loaded())
{this.fireEvent("widget_resize",this);return;}
var my_columns=this.get_columns(true);var spacer_re=/sg_widget_fields_space/;var rows_html='';this.rendered_columns=[];for(i=0;i<my_columns.length;i++)
{var fieldname=my_columns[i];if(spacer_re.exec(fieldname)==null)
{if(!SG.schema.get_field(this.context_entity.type,fieldname))
continue;this.rendered_columns.push(fieldname);var name_html=this.render_name(fieldname);var value_html=this.render_value(fieldname);rows_html+=this.templates.field_row.apply({field_name:name_html,field_value:value_html});}
else
{rows_html+=this.templates.field_row_empty.apply();}}
if(this.get('in_tabs')==true){if(my_columns.length==0)
rows_html="There are no fields currently displayed. Right-click to add some.";var content=this.templates.fields_widget_content_inside_tab.apply({fields_rows:rows_html});}
else
{var content=this.templates.fields_widget_content_not_inside_tab.apply({fields_rows:rows_html});}
this.hide_loading_overlay();this.contents_div.update(content);if(my_columns.length>0){this.attach_drag_div();this.fireEvent("widget_resize",this);}},on_widget_resize:function(){if(this.contents){var thumbs=sg_find_all('.sg_cell_content > img.thumb',this.contents);for(var i=0;i<thumbs.length;++i){thumbs[i].setAttribute('onload','sg_limit_thumbnail_cell_size(this);');}}},attach_drag_div:function()
{var dh=Ext.DomHelper;this.contents=this.container.child('.sg_widget_fields_body',true);var name_col_width=this.get('field_name_column_width');this.drag_div=dh.append(this.contents,{tag:'div',cls:'field_name_width_drag_div'},true);this.drag_div.setLeft(Number(name_col_width)-7);this.drag_zone=new SG.Widget.Fields.DragZone(this.drag_div,this);},on_contextmenu:function(e)
{var t=Ext.get(e.getTarget());var href=t.findParent('a',this.container,true);if(href)
return;e.stopEvent();if(!this.context_menu)
this.context_menu=this.create_context_menu();this.context_menu.position={xy:e.getXY()};this.context_menu.target_elem=t;this.context_menu.show();},create_context_menu:function()
{var menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_context_menu,scope:this}});menu.render();return menu;},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},],on_before_show_context_menu:function(menu)
{var items=[];if(!this.get('all_fields')){items.push({html:'Configure...',item_selected:{fn:this.configure,scope:this},});}
menu.items=items.concat(this.cell_manager.get_context_menu_items(menu.target_elem));;menu.render();},configure:function(menu,item)
{var fpd=new SG.FieldProperties.Dialog({entity_type:this.entity_type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:this.get('columns'),join_fields:this.get_through_join_fields(),pivot_columns:'summary',widget:this,settings_applied_callback:{fn:this.on_columns_set,scope:this}});},recalculate_field_name_width:function()
{var left=this.drag_div.getLeft(true);var field_name_tds=Ext.DomQuery.select('td.sg_widget_fields_field_name',this.contents);var i;for(i=0;i<field_name_tds.length;i++)
{var elem=Ext.get(field_name_tds);elem.setWidth(left);}
this.set('field_name_column_width',left+7);}});SG.Widget.Fields.DragZone=function(drag_div,fields_widget)
{this.drag_div=drag_div;this.fields_widget=fields_widget;SG.Widget.Fields.DragZone.superclass.constructor.call(this,this.drag_div,"rows");};Ext.extend(SG.Widget.Fields.DragZone,Ext.dd.DD,{b4StartDrag:function(x,y)
{this.resetConstraints();var left=this.fields_widget.get('field_name_column_width');var right=this.fields_widget.get_container().getWidth()-left-20;left-=10;this.setXConstraint(left,right);this.setYConstraint(0,0);SG.Widget.Fields.DragZone.superclass.b4StartDrag.call(this,x,y);this.drag_div.addClass('dragging');},endDrag:function(e)
{SG.Widget.Fields.DragZone.superclass.endDrag.apply(this,arguments);this.fields_widget.recalculate_field_name_width();this.drag_div.removeClass('dragging');}});SG.Widget.NewFields=function(context,widget_spec,id)
{SG.Widget.NewFields.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NewFields,SG.Widget.Base,{default_settings:{mode:'default',field_properties:[],field_name_width:0.5,filters:{logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]},use_internal_gear_menu:false},templates:{main:'{qb}{body}',internal_gear_menu:'<div class="gear_menu_nobg"></div>',default_field_name:'<td class="cell display_name_width" style="width:{width}%;">'+'<div class="display_name">{display_name}</div></td>',default_field_value:'<td class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'<div class="sg_cell_content {cutter}">{cell_content}</div></td>',default_field:'<table class="field"><tr>{field_name}{field_value}</tr></table>',pivot_field:'<div class="pivot">{content}</div>',pivot_field_name:'<div class="display_name">{display_name}</div>',pivot_field_value:'<div style="{cell_styles}" class="field_value {cell_classes}" {cell_attributes}>'+'{cell_content}</div>',one_line_field:'<div class="one_line">'+'<div class="left"><table class="one_line"><tr>{left}</tr></table></div>'+'<div class="right"><table class="one_line"><tr>{right}</tr></table></div>'+'</div>',one_line_field_name:'<td><div class="display_name">{display_name}</div></td>',one_line_field_value:'<td style="{cell_styles}" class="{cell_classes}" {cell_attributes}>{cell_content}</td>',no_record_message:'<div class="no_record">The Query that has been created for this widget has not returned a valid '+'{entity_display_name}.</div>',drag_div:'<div class="field_name_width_drag_location" style="left:{left}%">'+'<div class="field_name_width_drag_bar"></div></div>',qb:'<div class="filters"></div>',},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},{property_name:'position',data_type:'list',display_name:'Position',default_value:'left',list_data:['left','right']},],init_widget:function()
{this.entity_type=this.get('entity_type');if(!this.entity_type)
{this.entity=this.context.get('entity');this.entity_type=this.entity.type;}
this.data_set=this.new_data_set(this.entity_type,this.on_load);},on_first_render:function()
{this.container=this.get_container();if(!this.container)
{console.log("What the?  No container in new_fields.js. Dying now.");return;}
if(this.design_mode_on_detail_page())
this.container.addClass('design_mode');var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects(),field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.fetch_data();if(this.drag_div_visible())
this.drag_control=new SG.Widget.NewFields.DragResize({widget:this,container:this.container});if(this.get('use_internal_gear_menu'))
this.add_event(this.container,'click',this.on_click);},get_field_property_for_cell_manager:function(schema_field){return this.get_field_property(schema_field.name);},drag_div_visible:function()
{return((this.context.get('design_mode')||this.context.get('edit_mode'))&&this.get('mode')=='default');},render_widget:function()
{if(!this.data_set.is_loaded())
return;var body='';if(!this.record){body=this.render_no_record_messge();}else{var mode=this.get('mode');if(mode=='default')
body=this.render_default_layout();else if(mode=='pivot')
body=this.render_pivot_layout();else
body=this.render_one_line_layout();}
var qb=this.render_query_builder();this.container.update(this.templates.main.apply({qb:qb,body:body}));if(qb!=''){this.construct_and_render_query_builder();this.position_drag_div_top();}},position_drag_div_top:function(){var div=this.container.child('div.field_name_width_drag_bar');if(!div)return;var filters_div=this.container.child('div.filters');var h=filters_div.getHeight();div.setTop(h);},render_query_builder:function(){if(!this.entity&&this.context.get('edit_mode')){return this.templates.qb.apply();}else{return'';}},construct_and_render_query_builder:function(){if(this.qb_component)
this.qb_component.destroy();this.qb_component=new SG.Widget.EntityQuery.QueryBuilder({floating:false,filters:this.get_filters_for_qb(),container:this.container.child('div.filters'),entity_type:this.entity_type,context_projects:this.context_projects(),widget:this,callback:{fn:this.condition_changed,scope:this}});this.qb_component.render();},get_filters_for_qb:function()
{var filters=this.get('filters');this.refresh_token_entities_in_filters(filters);return filters;},condition_changed:function(new_filters){var filters=sg_deep_copy(new_filters);this.set('filters',filters);this.fetch_data();},render_no_record_messge:function()
{var html=this.templates.no_record_message.apply({entity_display_name:SG.schema.entity_types[this.entity_type].display_name});return html;},render_default_layout:function()
{var cols=this.get_columns();var html='';if(this.design_mode_on_detail_page()){html+=this.templates.detail_widgets_edit_header.apply({title:'Fields',widget_id:this.get_widget_id(),entity_type:this.entity_type});}
var name_td_width=Math.floor(100*this.get('field_name_width'));for(var i=0;i<cols.length;i++)
{var col=cols[i];var field_property=this.get_field_property(col);var field_name=this.templates.default_field_name.apply({width:name_td_width,display_name:this.get_field_display_name(field_property,col),});var cell=this.cell_manager.get_cell(col);var config=cell.render(this.record);var field_value=this.templates.default_field_value.apply(config);html+=this.templates.default_field.apply({field_name:field_name,field_value:field_value});}
if(this.drag_div_visible())
html+=this.templates.drag_div.apply({left:name_td_width});if(this.get('use_internal_gear_menu'))
{html+=this.templates.internal_gear_menu.apply({});this.container.addClass('use_internal_gear_menu');}
return html;},render_pivot_layout:function()
{var cols=this.get_columns();var html='';if(this.design_mode_on_detail_page()){html+=this.templates.detail_widgets_edit_header.apply({title:'Fields',widget_id:this.get_widget_id(),entity_type:this.entity_type});}
for(var i=0;i<cols.length;i++)
{var col=cols[i];var field_property=this.get_field_property(col);var field_html='';var display_name=this.get_field_display_name(field_property,col);if(display_name!='')
field_html+=this.templates.pivot_field_name.apply({display_name:display_name});var cell=this.cell_manager.get_cell(col);field_html+=this.templates.pivot_field_value.apply(cell.render(this.record));html+=this.templates.pivot_field.apply({content:field_html});}
return html;},get_field_display_name:function(field_property,field_name)
{var name=null;if(field_property)
{if(!field_property.show_label)
return'';else if(field_property.field_label_override&&field_property.field_label_override!='')
name=field_property.field_label_override;}
if(name==null){var schema_field=SG.schema.get_field(this.entity_type,field_name);name=schema_field.display_name;}
if(this.get('mode')!='pivot')
name+=':';return name;},render_one_line_layout:function()
{var left='';var right='';var html='';var cols=this.get_columns();for(var i=0;i<cols.length;i++)
{var col=cols[i];var field_property=this.get_field_property(col);var display_name=this.get_field_display_name(field_property,col);html='';if(display_name!='')
html+=this.templates.one_line_field_name.apply({display_name:display_name});var cell=this.cell_manager.get_cell(col);var config=cell.render(this.record);html+=this.templates.one_line_field_value.apply(config);if(field_property.position=='right')
right+=html;else
left+=html;}
html='';if(this.design_mode_on_detail_page()){html+=this.templates.detail_widgets_edit_header.apply({title:'Fields',widget_id:this.get_widget_id(),entity_type:this.entity_type});}
html+=this.templates.one_line_field.apply({left:left,right:right});return html;},on_load:function()
{this.hide_loading_overlay();if(this.data_set.count()>0)
this.record=this.data_set.get_record(0);else
this.record=null;this.render_widget();},get_columns:function()
{var cols=[];var field_properties=this.get('field_properties');for(var i=0;i<field_properties.length;i++)
{var field_property=field_properties[i];var field_name=field_property.field;var schema_field=SG.schema.get_field(this.entity_type,field_name);if(schema_field)
cols.push(field_name);}
return cols;},get_field_property:function(field_name)
{var field_properties=this.get('field_properties');for(var i=0;i<field_properties.length;i++)
{var field_property=field_properties[i];if(field_property.field==field_name)
return field_property;}
return null;},fetch_data:function()
{this.show_loading_overlay();if(!this.entity)
{var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);var spec={type:this.entity_type,filters:filters,columns:this.get_columns(),current_page:1,records_per_page:1,result:this.data_set};SG.Repo.query(spec);}
else
{var spec={type:this.entity.type,id:this.entity.id,columns:this.get_columns(),result:this.data_set};SG.Repo.find(spec);}},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.hasClass('gear_menu_nobg'))
{this.show_gear_menu(t.dom);}},show_gear_menu:function(gear_dom)
{if(this.gear_menu&&this.gear_menu.is_showing())
{this.gear_menu.hide();return;}
if(!this.gear_menu)
{this.gear_menu=new SG.Menu({items:[{html:"Configure fields...",item_selected:{fn:this.show_field_properties_dialog,scope:this}}]});}
this.gear_menu.position={dom_elem:gear_dom,elem_anchor:"br",menu_anchor:"tr"}
this.gear_menu.render();this.gear_menu.show();},show_field_properties_dialog:function()
{var fpd=new SG.FieldProperties.Dialog({entity_type:this.entity_type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:this.get('field_properties'),pivot_columns:'summary',widget:this,settings_applied_callback:{fn:this.on_field_properties_set,scope:this}});},on_field_properties_set:function(field_properties)
{this.set('field_properties',field_properties);this.fetch_data();},destroy_widget:function(){if(this.qb_component)
this.qb_component.destroy();},});SG.Widget.NewFields.DragResize=function(config)
{Ext.apply(this,config);SG.Widget.NewFields.DragResize.superclass.constructor.call(this,this.container,"layouts",{resizeFrame:false,scroll:false});};Ext.extend(SG.Widget.NewFields.DragResize,Ext.dd.DDProxy,{handleMouseDown:function(e)
{var target=Ext.get(e.getTarget());var drag_div=target.findParent('div.field_name_width_drag_bar',this.container,true);if(drag_div)
this.drag_div=drag_div;else
return;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},cache_all_width_tds:function()
{this.tds=[];var td_elems=sg_find_all('td.display_name_width',this.container.dom);for(var i=0;i<td_elems.length;i++)
{this.tds.push(Ext.get(td_elems[i]));}
var drag_location_div=Ext.get(this.drag_div.dom.parentNode);this.tds.push(drag_location_div);},b4StartDrag:function(x,y)
{this.cache_all_width_tds();this.container_width=Number(this.container.getWidth());this.container_left=Number(this.container.getLeft());Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e)
{per=Math.floor(100*this.calc_per(e));this.change_td_widths(per);},calc_per:function(e)
{var x=e.getXY()[0]+7;var per=(x-this.container_left)/this.container_width;return per;},change_td_widths:function(per)
{for(var i=0;i<this.tds.length;i++)
{var td_dom=this.tds[i].dom;td_dom.setAttribute('style','width:'+per+'%;');}},endDrag:function(e)
{this.widget.set('field_name_width',this.calc_per(e));},});SG.Widget.EntityCard=function(context,widget_spec,id)
{this.events={'widget_resize':true,'card_handle_click':true};SG.Widget.EntityCard.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityCard,SG.Widget.Base,{default_settings:{column_widths:[],enable_height_drag:false,height:130,enable_selection_handle:false,initial_state:'closed'},templates:{height_column:'<td class="column" style="width: {column_width}px;"><div class="column_pad height_pad">'+'<div class="{widget_cls}" id="{column_id}" style="height: {height}px; overflow: hidden">'+'</div></div></td>',height_column_end:'<td class="column"><div class="column_pad height_pad">'+'<div class="{widget_cls}" id="{column_id}" style="height: {height}px; overflow: hidden">'+'</div></div></td>',no_height_column:'<td class="column" style="width:{column_width}px;"><div class="column_pad">'+'<div class="{widget_cls}" id="{column_id}"></div></div></td>',no_height_column_end:'<td class="column"><div class="column_pad">'+'<div class="{widget_cls}" id="{column_id}"></div></div></td>',column_table:'<table cellspacing="0" style="table-layout: fixed;" class="column_table" '+'"><tr>{columns}</tr></table>',height_drag:'<div class="height_drag card_height_drag" style="top:{height}px;" id="{id}"></div>',column_drag:'<div class="column_drag" style="left:{left}px;" id="{id}"></div>',},init_widget:function()
{this.rendered_body_once=false;this.context_menu_id=this.get_css_class_name()+'_'+this.get_widget_id()+'_ctx_menu';},init_children:function()
{this.entity=this.context.get('entity');var cn=this.get_child_names();var i=cn.indexOf('title');this.has_title_widget=(i!=-1);if(this.has_title_widget)
{var title_context=this.context.clone();title_context.set('initial_state',this.get('initial_state'));this.title_widget=this.construct_child('title',title_context);this.add_event(this.title_widget,"entity_card_open",this.open_card);this.add_event(this.title_widget,"entity_card_close",this.close_card);}
if(this.entity.type!='CutItem')
{var cols=this.get('column_widths');this.column_widgets=[];for(var i=0;i<(cols.length+1);i++)
{var col_context=this.context.clone();var a_widget=this.construct_child('column'+(i+1),col_context);this.column_widgets.push(a_widget);}}
this.drag_divs=[];this.drag_zones=[];this.add_event(this,'settings_changed',this.on_settings_changed);},open_card:function(widget,e)
{this.update_on_open();if(!this.body_div.isDisplayed())
{this.body_div.setDisplayed(true);if(this.footer_widget)
{var footer_container=this.footer_widget.get_container();footer_container.setDisplayed(true);}
if(this.rendered_body_once==false){this.render_body_widgets();this.rendered_body_once=true;}
if(widget!=this.title_widget)
{this.title_widget.display_open_arrow();}
else
{var dom_event=e.browserEvent;if(dom_event.altKey)
{var parent_widget=this.get_parent();if(parent_widget.get('type')=='SG.Widget.EntityCardList'){this.set('initial_state','open');parent_widget.expand_all_cards();}}}
this.adjust_column_widths();this.fireEvent("widget_resize",this);}},close_card:function(widget,e)
{if(this.body_div.isDisplayed())
{this.body_div.setDisplayed(false);if(this.footer_widget)
{var footer_container=this.footer_widget.get_container();footer_container.setDisplayed(false);}
if(widget!=this.title_widget)
{this.title_widget.display_closed_arrow();}
else
{var dom_event=e.browserEvent;if(dom_event.altKey)
{var parent_widget=this.get_parent();if(parent_widget.get('type')=='SG.Widget.EntityCardList'){this.set('initial_state','closed');parent_widget.collapse_all_cards();}}}}},make_card_height_default:function()
{var h=this.height_drag_div.getTop(true);this.set({height:h});},render:function()
{if(this.entity.type=='CutItem')
{this.get_container().update('&nbsp<br>&nbsp<br>&nbsp<br>&nbsp<br>&nbsp<br>&nbsp');this.show_loading_overlay();this.data_set=this.new_data_set(this.entity.type,this.render_data);var spec={type:this.entity.type,id:this.entity.id,columns:['sg_version'],result:this.data_set};SG.Repo.find(spec);}
else
this.render_entity_card();},render_data:function(){var rec=this.data_set.get_record_by_id(this.entity.id);var take=rec.get('sg_version');var cols=this.get('column_widths');this.column_widgets=[];for(var i=0;i<(cols.length+1);i++)
{var col_context=this.context.clone();var a_widget=this.construct_child('column'+(i+1),col_context);this.column_widgets.push(a_widget);}
var child_names=this.get_child_names();if(child_names.indexOf('footer')!=-1)
{if(take==null)
this.footer_widget=this.construct_warning_message_widget_for_missing_version();else
{var footer_context=this.context.clone();footer_context.set('current_take_id',take.id);this.footer_widget=this.construct_child('footer',footer_context);}}
this.get_container().update('');this.hide_loading_overlay();this.render_entity_card();},construct_warning_message_widget_for_missing_version:function()
{var schema=SG.schema;var ver_fields_name=schema.entity_fields[this.entity.type]['sg_version']['display_name'];var ver_name=schema.entity_types['Version']['display_name'];var entity_name=schema.entity_types[this.entity.type]['display_name'];var message='The display of this widget requires the '+ver_fields_name+' field on this '+
entity_name+' be set to a valid '+ver_name+'.';var warn_context=this.context.clone();warn_context.set('message',message);var child_widget_name=this.get_child_names();if(child_widget_name.indexOf('warning_message')==-1)
{var spec={type:'SG.Widget.WarningMessage',settings:{}};this.widget_spec.create_child_spec('warning_message',spec,this);}
var widget=this.construct_child('warning_message',warn_context);return widget;},render_entity_card:function(){this.container=this.get_container();if(this.get_parent().get('type')=='SG.Widget.EntityCardList')
this.container.addClass('card_list');var dh=Ext.DomHelper;var group_idx=this.context.get('group_idx');var parent_widget=this.get_parent();this.handle_width=0;this.enable_selection_handle=this.get('enable_selection_handle');if(this.enable_selection_handle)
{var group_idx=this.context.get('group_idx');var cls='handle selectable seltarget';if(parent_widget.in_selection_cache(group_idx,this.entity.id))
cls+=' selected ';this.handle_div=dh.append(this.container,{tag:'div',cls:cls,group_idx:group_idx,record_id:this.entity.id},true);this.handle_width=20;}
var s='position: relative; left: '+this.handle_width+'px; margin-right: '+this.handle_width+'px;';if(this.has_title_widget)
{var cls=this.title_widget.get_css_class_name();if(parent_widget.in_selection_cache(group_idx,this.entity.id))
cls+=' selected';dh.append(this.container,{tag:'div',id:this.title_widget.get_container_id(),cls:cls,style:s});}
this.body_div=dh.append(this.container,{tag:'div',style:s},true);var cols=this.get('column_widths');var i;var id;var total_width=0;for(i=0;i<cols.length;i++)
{total_width+=cols[i];var div=dh.append(this.body_div,this.templates.column_drag.apply({left:(total_width-3),id:'sg_column_'+this.get_widget_id()+'_drag_'+i}),true);this.drag_divs.push(div);var dz=new SG.ColumnDragZone(div,this);this.drag_zones.push(dz);}
this.local_height=this.get('height');this.enable_height_drag=this.get('enable_height_drag');if(this.enable_height_drag)
{this.height_drag_div=dh.append(this.body_div,this.templates.height_drag.apply({id:'sg_height_'+this.get_widget_id()+'_drag',height:this.local_height}),true);this.height_drag_zone=new SG.HeightDragZone(this.height_drag_div,this,this.recalculate_card_height);}
var column_template,column_template_end;if(this.enable_height_drag)
{column_template=this.templates.height_column;column_template_end=this.templates.height_column_end;}
else
{column_template=this.templates.no_height_column;column_template_end=this.templates.no_height_column_end;}
var cols_html='';for(i=0;i<cols.length;i++)
{cols_html+=column_template.apply({column_id:this.column_widgets[i].get_container_id(),widget_cls:this.column_widgets[i].get_css_class_name(),column_width:cols[i],height:this.local_height});}
cols_html+=column_template_end.apply({column_id:this.column_widgets[i].get_container_id(),widget_cls:this.column_widgets[i].get_css_class_name(),height:this.local_height});dh.append(this.body_div,this.templates.column_table.apply({columns:cols_html}));if(this.footer_widget)
{s='position: relative; left: '+this.handle_width+'px; margin-right: '+this.handle_width+'px;';dh.append(this.container,{tag:'div',id:this.footer_widget.get_container_id(),cls:this.footer_widget.get_css_class_name(),style:s});}
if(this.has_title_widget){this.title_widget.render();if(this.get('initial_state')=='open'){this.render_body_widgets();this.update_on_open();this.rendered_body_once=true;}else{this.body_div.setDisplayed(false);}}else{this.render_body_widgets();}},render_body_widgets:function(){for(var i=0;i<this.column_widgets.length;i++)
{this.add_event(this.column_widgets[i],"widget_resize",this.fire_resize);this.column_widgets[i].render();}
if(this.footer_widget)
this.footer_widget.render();},update_on_open:function(){if(this.entity.type=='Note'&&this.has_title_widget)
{var data_set=this.title_widget.entity_set;var rec=data_set.get_record_by_id(this.entity.id);if(rec&&rec.get('read_by_current_user')!='read')
{var spec={type:this.entity.type,id:this.entity.id,column:'read_by_current_user',value:'read',no_undo:true};SG.Repo.update(spec);}}},fire_resize:function()
{this.fireEvent("widget_resize",this);},get_drag_X:function(drag_num)
{var l=this.drag_divs[drag_num].getLeft();var r=this.drag_divs[drag_num].getRight();return((l+r)/2);},get_drag_constraints:function(drag_num)
{var left,right;if(drag_num==0)
{left=this.drag_divs[drag_num].getLeft()-this.body_div.getLeft();left-=4;}
else
{left=this.drag_divs[drag_num].getLeft()-this.drag_divs[drag_num-1].getRight();left-=4;}
if(drag_num==this.drag_divs.length-1)
{right=500;}
else
{right=this.drag_divs[drag_num+1].getLeft()-this.drag_divs[drag_num].getRight();right-=4;}
return({left:left,right:right});},adjust_column_widths:function()
{var i;var cols=this.get('column_widths');var total_width=0;var widget_div,column_td;for(i=0;i<cols.length;i++)
{widget_div=this.column_widgets[i].get_container();column_td=widget_div.findParentNode('td.column',this.container.dom,true);column_td.setWidth(cols[i]);total_width+=cols[i];}
this.fireEvent("widget_resize",this);},adjust_column_heights:function()
{var h=this.local_height;var cw=this.column_widgets;var i;var td;for(i=0;i<cw.length;i++)
{td=cw[i].get_container();td.setHeight(h);}
this.fireEvent("widget_resize",this);},recalculate_column_widths:function()
{var i;var x;var left=this.body_div.getLeft();var last=left;var cols=[]
for(i=0;i<this.drag_divs.length;i++)
{x=this.get_drag_X(i);cols.push(x-last);last=x;}
this.set({column_widths:cols});},recalculate_card_height:function()
{var h=this.height_drag_div.getTop(true);this.local_height=h;this.adjust_column_heights();},on_settings_changed:function(change_hash,source_widget)
{if('column_widths'in change_hash)
{this.adjust_column_widths();if(source_widget!=this)
this.snap_drags_to_columns();}
else if('height'in change_hash)
{this.local_height=this.get('height');this.adjust_column_heights();if(source_widget!=this)
this.snap_drag_to_height();}},snap_drag_to_height:function()
{var h=this.get('height');this.height_drag_div.setTop(h);},snap_drags_to_columns:function()
{var cols=this.get('column_widths');var i;var total=0;for(i=0;i<cols.length;i++)
{total+=cols[i];this.drag_divs[i].setLeft(total-3);}},destroy_widget:function()
{var i;for(i=0;i<this.drag_zones.length;i++)
this.drag_zones[i].unreg();this.drag_divs=[];this.drag_zones=[];this.column_widgets=[];if(this.enable_height_drag)
this.height_drag_zone.unreg();}});SG.ColumnDragZone=function(drag_div,entity_card_widget)
{this.drag_div=drag_div;this.entity_card_widget=entity_card_widget;var pw_type=entity_card_widget.get_parent().get('type');if(pw_type!='SG.Widget.DetailPageBody')
this.tall_drag=true;else
this.tall_drag=false;SG.ColumnDragZone.superclass.constructor.call(this,this.drag_div,"rows",{scroll:false});};Ext.extend(SG.ColumnDragZone,Ext.dd.DD,{b4StartDrag:function(x,y)
{var drag_div=this.drag_div;if(this.tall_drag)
{drag_div.setHeight(3000);drag_div.setTop(-1500);}
var num=this.get_drag_num(drag_div);var con=this.entity_card_widget.get_drag_constraints(num);this.resetConstraints();this.setXConstraint(con.left,con.right);this.setYConstraint(0,0);SG.ColumnDragZone.superclass.b4StartDrag.call(this,x,y);this.drag_div.addClass('dragging');},endDrag:function(e)
{SG.ColumnDragZone.superclass.endDrag.apply(this,arguments);if(this.tall_drag)
{this.drag_div.setHeight('100%');this.drag_div.setTop(0);}
this.entity_card_widget.recalculate_column_widths();this.drag_div.removeClass('dragging');},get_drag_num:function(drag_div)
{var parts=drag_div.id.split('_');return Number(parts[4]);},});SG.HeightDragZone=function(drag_div,widget,end_drag_function)
{this.drag_div=drag_div;this.widget=widget;this.widget_container=widget.get_container();this.end_drag_function=end_drag_function;SG.HeightDragZone.superclass.constructor.call(this,this.drag_div,"rows",{scroll:false});};Ext.extend(SG.HeightDragZone,Ext.dd.DD,{b4StartDrag:function(x,y)
{this.child_iframe=this.widget_container.child('div.sgw_iframe');if(this.child_iframe)
this.child_iframe.setDisplayed(false);this.resetConstraints();this.setXConstraint(0,0);SG.HeightDragZone.superclass.b4StartDrag.call(this,x,y);this.drag_div.addClass('dragging');},endDrag:function(e)
{SG.HeightDragZone.superclass.endDrag.apply(this,arguments);this.end_drag_function.call(this.widget,this.drag_div);this.drag_div.removeClass('dragging');if(this.child_iframe)
this.child_iframe.setDisplayed(true);},});SG.Widget.EntityCardList=function(context,widget_spec,id)
{SG.Widget.EntityCardList.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityCardList,SG.Widget.EntityQueryMode,{default_settings:{cards_per_page:25,sorts:[],card_mode:"notes",show_only_newer_versions:true,select_first_record:false},setPageRegex:/sg_grid_(\w+)_set_page_(\w+)(?:\s|$)/,templates:{group_tip:'<div class="group_tip notseltarget" sg_tip="{sg_tip}">'+'<span class="group_tip">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="group_type">{group_type}:</span>'+'<span class="group_name">{group}</span>'+'<span class="group_total">({total})</span></div>',group:'<div class="group {state} {synthetic}" group_idx="{group_idx}">'+'<div class="group_tip_div" count="{count}" depth="{depth}" >{tip}</div>'+'<div class="group_contents">{contents}</div></div>',card:'<div class="{card_class}" id="{card_id}"></div>',},init_children:function()
{},init_widget:function()
{this.entity_type=this.context.get('entity_type');this.data_set=this.new_data_set(this.entity_type,this.on_data_load,this.on_data_change);},on_first_render:function()
{this.current_page=1;this.cards=[];this.grp_div_heights={};this.card_ids=[];this.last_clicked_card_index=-1;var dh=Ext.DomHelper;this.container=this.get_container();this.container.addClass('seltarget');this.cards_div=dh.append(this.container,{tag:'div',cls:'cards sg_scroll_container'},true);this.add_event(this.cards_div,'click',this.on_cards_div_click);this.summary_set=new SG.Data.SummarySet(this.entity_type);this.add_event(this.summary_set,'load',this.on_summary_load);this.select_first=this.get('select_first_record');this.add_event(this,"context_changed",this.on_context_changed);this.fetch_card_entities();this.first_render=true;},get_entity_data_store:function()
{return this.data_set;},reload_all_entities:function()
{this.fetch_card_entities();},get_toolbar_items:function()
{var items=[];items.push({position:'left',html:this.templates.toolbar_sorting_menu.apply(),onclick:{fn:this.on_sort_menu_click,scope:this},oncontextmenu:{fn:this.on_sort_menu_click,scope:this},cls:'action_menu',sg_tip:'Sorting Options'});var parent_entity=this.context.get('parent_entity');return items;},on_sort_menu_click:function(e,toolbar_elem)
{this.sort_menu_toolbar_div=toolbar_elem;if(!this.sort_menu)
{this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this},});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:this.entity_type,through_join_fields:this.get_through_join_fields(),parent_entity:this.context.get('parent_entity'),get_sorts_callback:{fn:this.on_get_sorts,scope:this},set_sorts_callback:{fn:this.on_set_sorts,scope:this},column_display_name_callback:{fn:this.get_custom_external_action_column_display_name,scope:this}});}
this.sort_menu.show();},on_get_sorts:function()
{return this.get('sorts');},on_set_sorts:function(new_sorts)
{this.set('sorts',new_sorts);this.fetch_card_entities();},on_before_show_sort_menu:function(menu)
{menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=this.sorting_menu_helper.get_menu_items();menu.render();},on_data_load:function(something)
{this.on_entities_loaded();if(typeof something=='object'&&something.length&&something.length===1&&something[0]=='grouped_summaries')
{return;}
if(this.data_set.is_grouped())
this.request_group_counts(this.summary_set);else
this.clear_group_summaries();if(this.select_first){this.select_first_record();this.select_first=false;}
if(this.restore_scroll)
{this.restore_scroll=false;this.cards_div.scrollTo('top',0,false);}
this.render_widget();},render_widget:function()
{if(this.first_render)
this.first_render=false;else
this.hide_loading_overlay();if(!this.data_set.is_loaded())
{this.cards_div.update('');return;}
this.destroy_all_cards();this.cards_div.update('');this.construct_all_cards();if(this.data_set.count()===0)
this.render_empty_message(this.entity_type,this.cards_div);else
this.render_cards();},destroy_all_cards:function()
{this.destroy_children();this.cards=[];this.card_ids=[];},on_data_change:function(changes)
{var retired=0;var revived=0;for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.type=='retire')retired++;if(change.type=='revive')revived++;}
if(revived>0){this.reload_all_entities();}else if(retired>0){if(this.data_set.is_grouped())
this.request_group_counts(this.summary_set);this.render_widget();}},on_context_changed:function(key,value)
{if(key=="filters"||key=="parent_entity"||key=='grouping'){this.fetch_card_entities();}},fetch_card_entities:function()
{this.show_loading_overlay();var filters=this.get_filters();if(!filters)
filters={};var spec={type:this.entity_type,filters:filters,columns:[],sorts:this.get('sorts'),grouping:this.get_grouping(),current_page:this.current_page,records_per_page:this.get('cards_per_page'),result:this.data_set};var parent_link_fields=this.get_parent_link_fields_from_context();if(parent_link_fields.length==1&&parent_link_fields[0]=="projects"&&this.context.get('page_project'))
{spec.parent_entity=this.context.get('page_project');}else{var parent_entity=this.context.get('parent_entity');if(parent_entity)spec.parent_entity=parent_entity;}
var server_side=this.context.get('server_side_filters');if(server_side)spec.server_side_filters=server_side;SG.Repo.query(spec);},construct_all_cards:function()
{if(this.__get_entity_query_page__().get('formatting_rules'))
this.context.set('formatting_rules',this.__get_entity_query_page__().get('formatting_rules'));else
this.context.set('formatting_rules',null);var card_mode=this.get('card_mode');if(this.get_grouping()!=false)
this.recursively_construct_all_group_cards(this.data_set.groups);else
{for(var i=0;i<this.data_set.count();i++)
{var r=this.data_set.get_record(i);var card_con=this.context.clone();var ne={type:this.entity_type,id:r.get_id(),name:r.get('code')};card_con.set('entity',ne);card_con.set('group_idx',-1);card_con.set('no_context_menu',true);card_con.set('show_only_newer_versions',this.get('show_only_newer_versions'));card_con.set('filters',null);var proj=r.get('project')
if(proj)card_con.set('entity_project',proj);var a_card=this.construct_child('entity_card_'+card_mode,card_con);this.card_ids.push(a_card.get_widget_id());this.cards.push(a_card);}}},recursively_construct_all_group_cards:function(groups)
{for(var i=0;i<groups.length;i++)
{var group=groups[i];if(group.synthetic)
this.recursively_construct_all_group_cards(group.groups);else
{var card_mode=this.get('card_mode');var grp_recs=group.ids;for(j=0;j<grp_recs.length;j++)
{var r=this.data_set.get_record_by_id(grp_recs[j]);var card_con=this.context.clone();var ne={type:this.entity_type,id:r.get_id(),name:r.get('code')};card_con.set('entity',ne);card_con.set('group_idx',i);card_con.set('no_context_menu',true);card_con.set('show_only_newer_versions',this.get('show_only_newer_versions'));card_con.set('filters',null);var proj=r.get('project')
if(proj)card_con.set('entity_project',proj);var a_card=this.construct_child('entity_card_'+card_mode,card_con);this.card_ids.push(a_card.get_widget_id());this.cards.push(a_card);}}}},construct_dummy_card:function(){var card_con=this.context.clone();var ne={type:this.entity_type,id:0,name:'dummy'};card_con.set('entity',ne);card_con.set('group_idx',-1);card_con.set('no_context_menu',true);card_con.set('show_only_newer_versions',this.get('show_only_newer_versions'));card_con.set('filters',null);this.dummy_card=this.construct_child('entity_card_'+this.get('card_mode'),card_con);},destroy_dummy_card:function(){this.dummy_card.destroy();this.dummy_card=null;},destroy_widget:function(){if(this.dummy_card)
this.dummy_card.destroy();},set_data_store_page:function(page)
{this.current_page=page;this.fetch_card_entities();this.restore_scroll=true;},set_data_store_max_records:function(max)
{this.current_page=1;this.set('cards_per_page',max);this.fetch_card_entities();},render_cards:function()
{this.grouping=this.get_grouping();var html='';if(this.grouping)
{SG.Widget.EntityCardList.__card_count__=0;html+=this.recursively_render_grouped_cards(this.data_set.groups,0);}
else
{for(var i=0;i<this.cards.length;i++)
{var card_id=this.cards[i].get_container_id();var card_class=this.cards[i].get_css_class_name();html+=this.templates.card.apply({card_class:card_class,card_id:card_id});}}
this.cards_div.update(html);for(i=0;i<this.cards.length;i++)
this.cards[i].render();},recursively_render_grouped_cards:function(groups,depth)
{var html='';for(var i=0;i<groups.length;i++)
{var group=groups[i];if(group.synthetic)
{var card_count=SG.Widget.EntityCardList.__card_count__;var content_html=this.recursively_render_grouped_cards(group.groups,depth+1);var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,group.depth,this.grouping,schema_field,schema_field.display_name)
var total=SG.Widget.EntityCardList.__card_count__-card_count;var tip=this.templates.group_tip.apply({group:display_name,total:total,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'synthetic',group_idx:group.idx,count:total,depth:depth});}
else
{var content_html='';var grp_recs=group.ids;for(var j=0;j<grp_recs.length;j++)
{content_html+=this.templates.card.apply({card_id:this.cards[SG.Widget.EntityCardList.__card_count__].get_container_id(),card_class:this.cards[SG.Widget.EntityCardList.__card_count__].get_css_class_name(),});SG.Widget.EntityCardList.__card_count__++;}
var schema_field=SG.schema.get_field(this.entity_type,this.grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,this.grouping,schema_field,schema_field.display_name)
var tip=this.templates.group_tip.apply({group:display_name,total:grp_recs.length,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'',group_idx:group.idx,count:grp_recs.length,depth:depth});}}
return html;},card_layout_menu_handler:function(menu,menuitem)
{var card_mode=this.get('card_mode');var menuitem_card_mode=menuitem.value;if(card_mode!=menuitem_card_mode)
{this.set({card_mode:menuitem_card_mode});this.fetch_card_entities();}},get_action_menu_items:function(items,target_elem,xy)
{items.mode.push({html:'Expand All Cards',item_selected:{fn:this.expand_all_cards,scope:this},disabled:this.card_ids.length==0});items.mode.push({html:'Collapse All Cards',item_selected:{fn:this.collapse_all_cards,scope:this},disabled:this.card_ids.length==0});items.mode.push({html:'Select All Cards',item_selected:{fn:this.select_all,scope:this},disabled:this.card_ids.length==0});items.mode.push({html:'Deselect All Cards',item_selected:{fn:this.clear_selection,scope:this},disabled:this.card_ids.length==0});var layout_items=[];var child_widget_names=this.get_child_names();var has_tabs_mode=(child_widget_names.indexOf('entity_card_tabs')!=-1);if(has_tabs_mode&&this.card_ids.length>0){var submenu_items=[];var card_mode=this.get('card_mode');layout_items.push({heading:'WIDGET CONFIGURATION'});layout_items.push({html:'Notes',checked:card_mode=='notes',value:'notes',item_selected:{fn:this.card_layout_menu_handler,scope:this}});layout_items.push({html:'Tabs',checked:card_mode!='notes',value:'tabs',item_selected:{fn:this.card_layout_menu_handler,scope:this}});}
layout_items.push({heading:'CONFIGURE'});layout_items.push({html:'Title Bar',item_selected:{fn:this.configure_card_title,scope:this},disabled:this.card_ids.length==0});if(this.get('card_mode')=='notes'){if(this.entity_type=='Note'||this.entity_type=='Ticket'){layout_items.push({html:'Top Left Fields',item_selected:{fn:this.configure_thread_detail_fields_widget,scope:this},disabled:this.card_ids.length==0,value:'left_fields'});layout_items.push({html:'Top Mid Fields',item_selected:{fn:this.configure_thread_detail_fields_widget,scope:this},value:'right_fields',disabled:this.card_ids.length==0});}else{layout_items.push({html:'Body Fields',item_selected:{fn:this.configure_card_body,scope:this},disabled:this.card_ids.length==0});}}
if(this.card_has_footer_widget()){layout_items.push({html:'Footer Fields',item_selected:{fn:this.configure_card_footer,scope:this},disabled:this.card_ids.length==0});}
var card_height_item=this.get_card_height_item(target_elem);if(card_height_item)
layout_items.push(card_height_item);items.mode.push({html:'Card Layout',submenu:{items:layout_items}});},get_card_height_item:function(target_elem)
{if(this.cards.length==0||!target_elem)
return false;var a_card_widget=this.cards[0];if(!a_card_widget.get('enable_height_drag'))
return false;var card_div=target_elem.findParentNode('div.sgw_entity_card',this.container.dom);if(!card_div)
return false;var widget_id=card_div.getAttribute('id');var parts=widget_id.split('_');if(parts&&parts.length>=3)
{var id=Number(parts[1]);var card_widget=SG.Widget.get_instance_by_id(id);if(!card_widget)
return false;var menu_item={html:'Set all cards to this cards height',item_selected:{fn:card_widget.make_card_height_default,scope:card_widget}};return menu_item;}
return false;},card_has_footer_widget:function()
{if(this.cards.length==0)
return false;var a_card_widget=this.cards[0];var card_widget_child_names=a_card_widget.get_child_names();return(card_widget_child_names.indexOf('footer')!=-1);},gather_merged_title_set:function()
{var title_set,row,rec,new_rec;var recs=[];for(var i=0;i<this.cards.length;i++){title_set=this.cards[i].title_widget.entity_set;rec=title_set.get_record(0);row=SG.Repo.get_row(rec.get_type(),rec.get_id());rec=new SG.Data.Record(row.get_type());rec.load(row);recs.push(rec);}
var merged_set=new SG.Data.Set(this.entity_type);merged_set.load(recs);merged_set.bubble_source_entity=this.context.get('parent_entity')||null;return merged_set;},multi_edit_selected:function()
{var title_widget=this.cards[0].title_widget;var config={data_set:this.gather_merged_title_set(),fields:title_widget.extract_fields_from_column_settings(),selected_entity_ids:this.get_selected_record_ids(),projects:this.context_projects(),column_display_names:title_widget.get_fields_display_names(),};new SG.EditSelectedDialog(config);},delete_selected_cards:function()
{var conf_str='Delete selected?';if(!confirm(conf_str)){return false;}
var checked_entity_ids=this.get_selected_entity_ids();var requests=[];for(var i=0;i<checked_entity_ids.length;i++){requests.push({request_type:"delete",type:this.entity_type,id:checked_entity_ids[i]});}
if(checked_entity_ids.length){var handler=new SG.ResponseHandler();var crud_req=new SG.CrudRequest(requests,handler);crud_req.on("completed",this.fetch_card_entities,this);this.show_loading_overlay();crud_req.send();}},expand_all_cards:function()
{if(this.cards.length<1)return;this.cards[0].set('initial_state','open');for(var i=0;i<this.cards.length;i++)
this.cards[i].open_card()},collapse_all_cards:function()
{if(this.cards.length<1)return;this.cards[0].set('initial_state','closed');for(var i=0;i<this.cards.length;i++)
this.cards[i].close_card()},open_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='open')
return;group_div.replaceClass('closed','open');this.set_group_state(group,'open');},close_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='closed')
return;group_div.replaceClass('open','closed');this.set_group_state(group,'closed');},gen_widget_div_id:function(widget_name)
{var str='sg_entity_list_'+this.get_widget_id()+'_'+widget_name;return str;},configure_card_title:function()
{var widget=this.find_child_widget('title','SG.Widget.EntityCardTitle');if(widget!=null)
widget.configure();},configure_card_body:function()
{var widget=this.find_child_widget('column2','SG.Widget.Fields');if(widget!=null)
widget.configure();},configure_thread_detail_fields_widget:function(menu,menuitem)
{var widget_name=menuitem.value;var widget=this.find_child_widget(widget_name,'SG.Widget.Fields');if(widget!=null)
widget.configure();},configure_card_footer:function()
{var widget=this.find_child_widget('take','SG.Widget.EntityCardTitle');if(widget!=null)
widget.configure();},on_cards_div_click:function(e)
{var t=Ext.get(e.getTarget());var group_tip=t.findParent('div.group_tip',this.cards_div,true);if(group_tip)
{var group_div=group_tip.findParent('div.group',this.cards_div,true);var dom_event=e.browserEvent;if(dom_event.altKey)
{if(group_div.hasClass('open'))
this.toggle_all_groups('closed');else
this.toggle_all_groups('open');}
else
{if(group_div.hasClass('open'))
this.close_group(group_div);else
this.open_group(group_div);}}},on_summary_load:function(keys)
{var regex_first_synth=/first_group_count_(\d+)_(\d+)_(\d+)/;var regex_last_synth=/last_group_count_(\d+)_(\d+)_(\d+)/;var i,key,match;var updates={};var synthetic_group_updates={};for(i=0;i<keys.length;i++){key=keys[i];if(key==='first_group_count')
updates[0]=true;else if(key==='last_group_count')
updates[this.data_set.group_count()-1]=true;else if(match=key.match(regex_first_synth))
synthetic_group_updates[match[1]+'_'+match[2]+'_'+match[3]]=true;else if(match=key.match(regex_last_synth))
synthetic_group_updates[match[1]+'_'+match[2]+'_'+match[3]]=true;}
for(i in updates){if(updates.hasOwnProperty(i))
this.update_group_tip(parseInt(i),false);}
for(i in synthetic_group_updates){if(synthetic_group_updates.hasOwnProperty(i))
this.update_group_tip(i,true);}},update_group_tip:function(group_idx,synthetic)
{var group;var is_first=false;var is_last=false;if(synthetic)
{var low_idx=Number(group_idx.split('_')[0]);var high_idx=Number(group_idx.split('_')[0]);is_first=low_idx==0;is_last=low_idx==this.data_set.group_count()-1;group=this.data_set.get_synthetic_group(group_idx);}
else
{is_first=group_idx==0;is_last=group_idx==this.data_set.group_count()-1;group=this.data_set.get_group(group_idx);}
var group_div=this.container.child('div.group[group_idx="'+group_idx+'"]');if(!group_div)return;var group_tip_div=group_div.child('div.group_tip_div');var count=Number(group_tip_div.dom.getAttribute('count'));var depth=Number(group_tip_div.dom.getAttribute('depth'));var sum;if(is_first)
{var key=synthetic?'first_group_count_'+group_idx:'first_group_count';sum=this.summary_set.get(key,'id');}
else if(is_last)
{var key=synthetic?'last_group_count_'+group_idx:'last_group_count';sum=this.summary_set.get(key,'id');}
if(sum&&count!=sum)count=count+" of "+sum;var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var display_name=group.display_values[depth];if(display_name==='')
display_name="No "+schema_field.display_name;group_tip_div.update(this.templates.group_tip.apply({group:display_name,total:count,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)}));},get_custom_external_action_columns:function()
{if(!this.cards||this.cards[0]){this.construct_dummy_card();var title_widget=this.dummy_card.title_widget;var fields=title_widget.extract_fields_from_column_settings();this.destroy_dummy_card();return fields;}
var title_widget=this.cards[0].title_widget;return title_widget.extract_fields_from_column_settings();},get_custom_external_action_column_display_name:function(col)
{if(!this.cards[0])
{var schema_field=SG.schema.get_field(this.entity_type,col);return schema_field.display_name;}
else
{var title_widget=this.cards[0].title_widget;var display_names=title_widget.get_fields_display_names();if(!display_names[col])
{var schema_field=SG.schema.get_field(this.entity_type,col);return schema_field.display_name;}
else
return display_names[col];}},get_custom_external_action_sorts:function()
{return this.on_get_sorts();},});SG.Widget.EntityCardTitle=function(context,widget_spec,id)
{this.events={'entity_card_open':true,'entity_card_close':true};SG.Widget.EntityCardTitle.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityCardTitle,SG.Widget.Base,{default_settings:{columns:[],},templates:{widget:'<div class="left"><table><colspan width="0" span="{left_count}">'+'<tr><td class="tip"><div>{tip}</div></td>{left_fields}</tr>'+'</table></div><div class="right"><table><colspan width="0" span="{right_count}">'+'<tr>{right_fields}</tr></table></div>',field_name:'<td class="cell"><div class="display_name">{display_name}:</div></td>',field_value:'<td class="cell {cell_classes}" style="{cell_styles} width: {width}px" {cell_attributes}>'+'{cell_content}</td>',tip:'<div class="tip {tip_icon}">&nbsp;</div><div class="sg_entity_icon_span {entity_icon}"></div>',},before_init:function()
{this.entity=this.context.get('entity');var ident_field=SG.schema.get_identifier_field(this.entity.type);if(ident_field!=null)
this.my_default_settings.columns=[{field:ident_field,position:'left',show_label:false}];},on_first_render:function()
{this.entity=this.context.get('entity');this.container=this.get_container();this.container.addClass('selectable');this.container.addClass('seltarget');this.container.dom.setAttribute('record_id',this.entity.id);this.container.dom.setAttribute('group_idx',this.context.get('group_idx'));this.entity_set=this.new_data_set(this.entity.type,this.on_entity_load,this.render_widget);if(!this.context.get('no_context_menu'))
this.add_event(this.container,"contextmenu",this.on_contextmenu);this.add_event(this.container,"click",this.on_click);this.add_event(this,'settings_changed',this.on_settings_changed);if(this.context.get('initial_state')=='open')
this.open=true;var cell_config={container:this.container,data_set:this.entity_set,projects:this.context_projects(),field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};if(this.context.get('formatting_rules'))
cell_config.page_formatting_rules=this.context.get('formatting_rules');this.cell_manager=this.new_component(SG.CellManager,cell_config);this.fetch_data();},get_field_property_for_cell_manager:function(schema_field){var field_settings=this.get('columns');for(var i=0;i<field_settings.length;i++){var field_property=field_settings[i];if(field_property.field==schema_field.name)
return field_property;}
return null;},on_entity_load:function()
{this.record=this.entity_set.get_record(0);this.render_widget();},render_widget:function()
{this.hide_loading_overlay();if(!this.entity_set.is_loaded())
{this.container.update('');return;}
var column_settings=this.get('columns');var fields=this.extract_fields_from_column_settings();var left_fields='';var left_count=1;var rf=[];for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];if(fields.indexOf(field_hash.field)==-1)
continue;if(field_hash.position=='left')
{var cell_config={detail_link:this.is_detail_link(field_hash)};var cell=this.cell_manager.get_cell(field_hash.field,cell_config);if(field_hash.show_label)
{var display_name;if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_name=field_hash.field_label_override;else
display_name=cell.get_field_display_name();left_fields+=this.templates.field_name.apply({display_name:display_name});left_count++;}
left_fields+=this.templates.field_value.apply(cell.render(this.record));left_count++;}
else
rf.push(field_hash);}
var right_count=0;var right_fields='';for(i=rf.length-1;i>=0;i--)
{var field_hash=rf[i];var cell_config={detail_link:this.is_detail_link(field_hash)};var cell=this.cell_manager.get_cell(field_hash.field,cell_config);if(field_hash.show_label)
{var display_name;if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_name=field_hash.field_label_override;else
display_name=cell.get_field_display_name();right_fields+=this.templates.field_name.apply({display_name:display_name});right_count++;}
right_fields+=this.templates.field_value.apply(cell.render(this.record));right_count++;}
this.container.update(this.templates.widget.apply({tip:this.render_tip(),left_count:left_count,left_fields:left_fields,right_count:right_count,right_fields:right_fields}));},is_detail_link:function(field_hash)
{if(SG.schema.is_identifier_field(this.entity.type,field_hash.field))
return true;else
{if(field_hash.detail_link!=undefined)
return field_hash.detail_link;else
return false;}},render_tip:function()
{var entity_icon=this.get_tip_entity_icon();var tip_html='';if(!this.context.get('no_tip'))
{if(this.open)
tip_html=this.templates.tip.apply({tip_icon:'arrow_open_dark',entity_icon:entity_icon});else
tip_html=this.templates.tip.apply({tip_icon:'arrow_closed_dark',entity_icon:entity_icon});}
return tip_html;},get_tip_entity_icon:function()
{if(this.record!=undefined&&SG.schema.get_field(this.record.type,'read_by_current_user'))
{var read_status=this.record.get('read_by_current_user');if(read_status=='unread')
this.container.addClass('unread_note');return'icon_'+this.entity.type+'_'+read_status.toLowerCase();}
else if(this.record!=undefined&&this.record.type=='HumanUser')
{var status=this.record.get('sg_status_list');if(status==='dis')
return'icon_HumanUserDisabled';else
return'icon_HumanUser';}
else
return'icon_'+this.entity.type;},on_settings_changed:function()
{this.cell_manager.empty_cell_cache();this.fetch_data();},display_open_arrow:function()
{this.open=true;var tip=this.container.child('div.tip');if(tip)
tip.replaceClass('arrow_closed_dark','arrow_open_dark');},display_closed_arrow:function()
{this.open=false;var tip=this.container.child('div.tip');if(tip)
tip.replaceClass('arrow_open_dark','arrow_closed_dark');},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'position',data_type:'list',display_name:'Position',default_value:'left',list_data:['left','right']},{property_name:'detail_link',data_type:'boolean',display_name:'Render As Link To Detail Page',default_value:false,restrict_to_field_data_types:['text','number']},{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},],on_click:function(e)
{var target=Ext.get(e.getTarget());var tip=target.findParent('td.tip');if(tip)
{if(!this.open)
{this.display_open_arrow();this.fireEvent("entity_card_open",this,e);}
else
{this.display_closed_arrow();this.fireEvent("entity_card_close",this,e);}}},on_contextmenu:function(e)
{var t=Ext.get(e.getTarget());var href=t.findParent('a',this.container,true);if(href)
return;e.stopEvent();if(!this.context_menu)
this.context_menu=this.create_context_menu();this.context_menu.position={xy:e.getXY()};this.context_menu.show();},create_context_menu:function()
{var menu=this.new_component(SG.Menu,{items:[{html:'Configure...'}],item_selected:{fn:this.configure,scope:this}});menu.render();return menu;},configure:function(menu,item)
{var fpd=new SG.FieldProperties.Dialog({entity_type:this.entity.type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:this.get('columns'),join_fields:this.get_through_join_fields(),pivot_columns:'summary',widget:this,settings_applied_callback:{fn:this.on_columns_set,scope:this}});},on_columns_set:function(columns)
{this.set('columns',columns);},extract_fields_from_column_settings:function()
{var ret=[];var column_settings=this.get('columns');for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];var schema_for_field=SG.schema.get_field(this.entity.type,field_hash.field);if(schema_for_field!=undefined)
ret.push(field_hash.field);}
return ret;},get_fields_display_names:function()
{var display_names={};var column_settings=this.get('columns');for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_names[field_hash.field]=field_hash.field_label_override}
return display_names;},fetch_data:function()
{this.show_loading_overlay();var spec={type:this.entity.type,ids:[this.entity.id],columns:this.extract_fields_from_column_settings(),result:this.entity_set,parent_entity:this.context.get('parent_entity')};SG.Repo.find(spec);},});SG.Widget.CutItemVersions=function(context,widget_spec,id)
{SG.Widget.CutItemVersions.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.CutItemVersions,SG.Widget.Base,{default_settings:{},templates:{},init_children:function()
{},render:function(){this.entity=this.context.get('entity');if(this.context.get('show_only_newer_versions'))
this.get_take_version();else
this.get_versions();},get_take_version:function()
{this.take_ds=this.new_data_set('Version',this.get_versions);this.current_take_id=this.context.get('current_take_id');var spec={type:'Version',id:this.current_take_id,columns:['created_at','entity'],result:this.take_ds};SG.Repo.find(spec);},zero_pad_2_digits:function(num)
{return(num<10?'0'+num:''+num);},to_datetime_string:function(datetime_from_ds)
{var tmp_date=new Date(datetime_from_ds);var utc_year=tmp_date.getUTCFullYear();var utc_month=this.zero_pad_2_digits(tmp_date.getUTCMonth()+1);var utc_day_in_month=this.zero_pad_2_digits(tmp_date.getUTCDate());var utc_hh=this.zero_pad_2_digits(tmp_date.getUTCHours());var utc_mm=this.zero_pad_2_digits(tmp_date.getUTCMinutes());var utc_ss=this.zero_pad_2_digits(tmp_date.getUTCSeconds());var utc_date_str=tmp_date.toUTCString();var utc_timezone=utc_date_str.slice(utc_date_str.lastIndexOf(' ')+1);var datetime_str=''+utc_year+'-'+utc_month+'-'+utc_day_in_month+' '+
utc_hh+':'+utc_mm+':'+utc_ss+' '+utc_timezone;return datetime_str;},get_versions:function(){this.data_set=this.new_data_set('Version',this.render_data);var filters={};filters.logical_operator="and";if(this.context.get('show_only_newer_versions'))
{var rec=this.take_ds.get_record_by_id(this.current_take_id);var take_created_at=rec.get('created_at');var ver_created_at=this.to_datetime_string(take_created_at);filters.conditions=[{active:"true",path:"entity",relation:"is",values:[{type:this.entity.type,id:this.entity.id}]},{path:'created_at',relation:'greater_than',values:[ver_created_at]}];}
else
{filters.conditions=[{active:"true",path:"entity",relation:"is",values:[{type:this.entity.type,id:this.entity.id}]}];}
var spec={type:'Version',filters:filters,columns:['created_at'],sorts:[{column:'created_at',direction:'asc'}],result:this.data_set};SG.Repo.query(spec);},render_data:function(){this.container=this.get_container();var dh=Ext.DomHelper;var ds=this.data_set;if(this.context.get('show_only_newer_versions'))
this.container.addClass('new_version');this.child_widgets=[];var i,r;for(i=0;i<ds.count();i++)
{r=ds.get_record(i);var take_con=this.context.clone();take_con.set('no_tip',true);take_con.set('entity',{type:'Version',id:r.get_id()});var a_ver=this.construct_child('take',take_con);this.child_widgets.push(a_ver);}
for(i=0;i<this.child_widgets.length;i++)
{var w=this.child_widgets[i];dh.append(this.container,{tag:'div',cls:w.get_css_class_name(),id:w.get_container_id()});}
for(i=0;i<this.child_widgets.length;i++)
this.child_widgets[i].render();},});SG.Widget.PageTitle=function(context,widget_spec,id){SG.Widget.PageTitle.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.PageTitle,SG.Widget.Base,{templates:{main:'<div class="title" page_type="{page_type}" ui_category="{ui_category}"></div>',title:'<center>{favorite}<span class="title_text">{title}</span>'+'<span class="title_annotation">{shared}</span></center>',page_menu:'<div class="page_menu {state}"><div class="{icon_name}"></div></div>',action_menu:'<div class="action_menu"><img src="/images/gear_menu_nobg.png"></div>',refresh_button:'<div class="refresh_button" style="right:{right}px;"></div>',toolbar_notes_app_button:'<button class="notes_app"><div class="notes_app_icon icon_Playlist"></div><span>{label}</span></button>',favorite:'<div class="favorite"><div class="{cls}"></div></div>',info_button:'<div class="info_button_wrapper" style="right:{right}px;"><div class="icon_info_dark"></div></div>',info_popover_contents:'{description}'+'{conditions}'+'<div class="info_popover_heading">Creator</div>'+'<div class="info_popover_value">{created_by}</div>'+'<div class="info_popover_heading">Last Updated</div>'+'<div class="info_popover_value">{last_updated}</div>',info_popover_description:'<div class="info_popover_heading">Description</div>'+'<div class="info_popover_value">{description}</div>',info_popover_conditions:'<div class="info_popover_heading">Page Query</div>'+'<div class="info_popover_value">{conditions}</div>',info_popover_no_conditions:'<div class="info_popover_heading">Page Query</div>'+'<div class="info_popover_value">'+'<span class="page_query_prompt">All <span class="noun">{entity_type_plural}</span>'+' (no filters)</span>'+'</div>',},on_first_render:function(){var dh=Ext.DomHelper;this.container=this.get_container();this.page=this.get_page();this.add_event(this.container,'click',this.on_click);var ui_category=this.page.ui_category;if(this.page.entity_type==='Project'&&ui_category==='app')
ui_category='project';this.title_div=this.templates.main.append(this.container,{page_type:this.page.type,ui_category:ui_category},true);this.page_menu_div=this.templates.page_menu.append(this.container,{state:this.page.dirty?'dirty':'',icon_name:this.page.dirty?'icon_page_settings_dirty':'icon_page_settings'},true);this.add_event(this.page_menu_div,'click',this.on_page_menu_div_click);this.add_event(this.page_menu_div,'contextmenu',this.on_page_menu_div_click);this.add_event(this.page,"dirty_changed",this.page_dirty_changed);var action_menu_displayed=false;if(this.page.type=='detail'){this.entity=this.context.get('entity');this.action_menu_items=this.get_action_menu_items();if(this.action_menu_items.length){this.action_menu_icon=dh.append(this.container,this.templates.action_menu.apply(),true);this.add_event(this.action_menu_icon,'click',this.on_action_menu_click);this.add_event(this.action_menu_icon,'contextmenu',this.on_action_menu_click);action_menu_displayed=true;}
if(['Note','Ticket','Delivery'].indexOf(this.entity.type)!==-1||this.entity.type.indexOf('CustomThreadedEntity')==0){this.data_set=this.new_data_set(this.entity.type,this.render_widget,this.on_data_change);switch(this.entity.type){case'Ticket':case'Delivery':this.title_field='title';break;case'Note':this.title_field='subject';break;}
if(this.entity.type.indexOf('CustomThreadedEntity')==0)
this.title_field='code';this.title_field_hash=SG.schema.get_field(this.entity.type,this.title_field);this.fetch_title();}}else if(!this.page.project_id){this.data_set=this.new_data_set('Page',this.render_widget);this.fetch_page_title();}
var right=action_menu_displayed?57:32;this.refresh_div=dh.append(this.container,this.templates.refresh_button.apply({right:right}),true);this.info_button=dh.append(this.container,this.templates.info_button.apply({right:right+22}),true);this.add_event(this.refresh_div,'click',this.on_refresh_button_click);this.add_event(this.refresh_div,'mousedown',this.on_refresh_button_down);this.add_event(this.refresh_div,'mouseup',this.on_refresh_button_up);this.info_popover=this.new_component(SG.Popover,{mouseover_elem:this.info_button,extra_class:'sgw_page_title_info_popover',on_render:{fn:this.render_info_popover_contents,scope:this},on_before_show:{fn:function(popover){popover.render();},scope:this}});},render_widget:function(){if(this.page.type=='detail'){if(this.title_field)
this.render_threaded_detail_page_title();else
this.render_detail_page_title();}else if(['global_report','project'].indexOf(this.page.ui_category)!=-1||this.body_widget_is_entity_query_page()){this.render_entity_query_page_title();}else if(this.page.type=='home'||this.page.type=='canvas'){this.render_canvas_title();}},body_widget_is_entity_query_page:function(){var canvas_page=this.get_parent();var bw=canvas_page.body_widget;if(bw&&bw.get('type')=='SG.Widget.EntityQuery.EntityQueryPage')
return true;return false;},page_dirty_class:function(){return(this.page.dirty?'dirty':'');},render_threaded_detail_page_title:function(){var title='Loading';if(this.data_set.count()==1){var r=this.data_set.get_record(0);var title_field_text=r.get(this.title_field);if(title_field_text===null)
title_field_text='(No '+this.title_field_hash.display_name+')';title=SG.schema.entity_types[this.entity.type].display_name;if(this.entity.type=='Ticket')
title+=' #'+this.entity.id+': '+title_field_text;else if(this.entity.type=='Delivery')
title+=' #'+r.get('delivery_number')+': '+title_field_text;else
title+=': '+title_field_text;}
var html_title=title;var page_project=this.get_page_project();if(page_project)
html_title+=" : "+page_project.name;document.title=html_title;var html=this.templates.title.apply({title:title,dirty:this.page_dirty_class(),shared:''});this.title_div.update(html);},render_sharing:function(){if(['global_report','project'].indexOf(this.page.ui_category)!=-1||['home','detail'].indexOf(this.page.type)!=-1){return'';}else{var shared=this.page.shared;if(this.data_set&&this.data_set.is_loaded()&&this.data_set.count()==1){var rec=this.data_set.get_record(0);shared=rec.get('shared');}
return this.page.project_id?'':shared?' -- shared':' -- private';}},render_detail_page_title:function(){var entity_type=SG.schema.entity_types[this.entity.type].display_name;var title=entity_type+' '+this.entity.name;var html_title=title;var page_project=this.get_page_project();if(page_project)
html_title+=" : "+page_project.name;document.title=html_title;var html=this.templates.title.apply({title:title,dirty:this.page_dirty_class(),shared:'',});this.title_div.update(html);if(entity_type=='Playlist'&&SG.schema.can_create_entity("Note")){this.button=Ext.get(this.templates.toolbar_notes_app_button.append(this.title_div,{label:'Launch Review Notes App'}));if(this.refresh_div.dom.style.right=='110px')
this.button.dom.style.right='135px';this.add_event(this.button,'click',this.start_notes_app);}},render_entity_query_page_title:function(){var title=this.context.get('title');var html=this.templates.title.apply({title:title,dirty:this.page_dirty_class(),favorite:this.render_favorite(),shared:this.render_sharing()});this.title_div.update(html);var html_title;if(this.page.ui_category=='global_report'){html_title=SG.schema.entity_types[this.page.entity_type]['display_name_pluralized'];}else if(this.page.ui_category=='project'){var page_project=this.get_page_project();var entity_field_pref=sg_get_entity_field_pref("nav_bar","Project",page_project);if(!entity_field_pref)
entity_field_pref=sg_get_entity_field_pref("nav_bar","Project");var bricks=entity_field_pref.get('settings_serialized');var display_name=SG.schema.entity_types[this.page.entity_type]['display_name_pluralized'];for(var i=0;i<bricks.length;i++){brick=bricks[i];if(brick.entity_type==this.page.entity_type&&brick.display_name&&brick.display_name!=''){display_name=brick.display_name;break;}}
html_title=display_name+" : "+page_project.name;}else{var html_title=title;var page_project=this.get_page_project();if(page_project)
html_title+=" : "+page_project.name;}
document.title=html_title;},render_canvas_title:function(){var title=this.context.get('title');var html=this.templates.title.apply({title:title,dirty:this.page_dirty_class(),favorite:(this.page.type!="home")?this.render_favorite():"",shared:this.render_sharing(),});this.title_div.update(html);var html_title=title;var page_project=this.get_page_project();if(page_project)
html_title+=" : "+page_project.name;document.title=html_title;},render_favorite:function(){var page=this.get_page();if(['reports','global_report','project'].indexOf(page.ui_category)==-1)
return"";var cls="favorite_editor_button_up";if(page.get_favorite())
cls="favorite_editor_button_selected";return this.templates.favorite.apply({cls:cls});},page_dirty_changed:function(e){var page=this.get_page();if(page.dirty){this.page_menu_div.addClass('dirty');this.page_menu_div.dom.firstChild.className='icon_page_settings_dirty';}else{this.page_menu_div.removeClass('dirty');this.page_menu_div.dom.firstChild.className='icon_page_settings';}},on_page_menu_div_click:function(e){if(e.type=='contextmenu')e.stopEvent();if(!this.page_menu){this.page_menu=this.new_component(SG.Menu,{position:{dom_elem:this.page_menu_div,elem_anchor:"br",menu_anchor:"tr"},before_show:{fn:this.on_before_show_page_menu,scope:this}});this.page_menu.render();}
if(this.page_menu.is_showing())
this.page_menu.hide();else
this.page_menu.show();},on_before_show_page_menu:function(){var disable_all=(this.page.type=='detail'&&this.page.entity_type=='Page');var items=[];var html;var disabled;var is_default_page=this.page.is_default;var is_status_page=(this.page.entity_type=='Status');if(this.page.root_widget instanceof SG.Widget.Canvas.Page){items.push({html:'Design Page',disabled:!this.page.user_can_save()||this.page.is_default||this.page.admin,item_selected:{fn:function(){this.page.root_widget.design_page();},scope:this},icon_name:'icon_design_page'});items.push({line:true});}
html=this.page.is_default?'Revert Page To Global Default':'Revert Page';items.push({html:html,disabled:!this.page.revertable_now(),item_selected:{fn:function(){this.page.settings_revert();},scope:this},icon_name:'icon_revert'});html=this.page.is_default?'Save Page As Global Default':'Save Page';items.push({html:html,disabled:!this.page.saveable_now(),item_selected:{fn:function(){this.page.settings_save();},scope:this},icon_name:'icon_save'});var is_admin_url_page=(this.page.type=='url'&&this.page.admin==true&&this.page.name&&['Trash','Invoicing and Payments'].indexOf(this.page.name)!=-1);if(!this.page.is_default){disabled=['detail','home'].indexOf(this.page.type)>-1||is_default_page||is_status_page||is_admin_url_page;items.push({html:'Save Page As...',disabled:disabled,item_selected:{fn:function(){this.page.settings_save_as_show_dialog();},scope:this}});}
items.push({line:true});disabled=['detail','home'].indexOf(this.page.type)>-1||!this.page.user_can_save()||is_default_page||is_status_page||is_admin_url_page;items.push({html:'Rename Page...',disabled:disabled,item_selected:{fn:function(){this.page.show_rename_page_dialog();},scope:this}});items.push({html:'Page History and Stats...',disabled:this.page.type=='detail'&&this.page.entity_type=='Page',item_selected:{fn:function(){window.open("/detail/Page/"+this.page.id+"?show_nav=no");},scope:this}});if(!this.page.is_default&&['detail'].indexOf(this.page.type)!=-1){var submenu_disabled=(is_status_page||this.page.entity_type.match(/Connection$/));items.push({line:true});var sub_items=[];sub_items.push({html:'Revert Page To Global Default',disabled:!this.page.user_can_save_or_revert_to_default(),item_selected:{fn:this.warn_and_revert_to_global_default,scope:this},icon_name:'icon_revert'});sub_items.push({html:'Save Page As Global Default',disabled:!this.page.user_can_save_or_revert_to_default(),item_selected:{fn:this.warn_and_save_as_global_default,scope:this},icon_name:'icon_save'});var edn=SG.schema.entity_types[this.page.entity_type].display_name;var url='/page/default_for?page_id='+this.page.id;sub_items.push({html:'<a href="'+url+'" target="global_default_page">'+'Go to the '+edn+' Global Default Page...</a>',icon_name:'icon_arrow_right',item_selected:{fn:function(){window.open(url,'global_default_page');},scope:this}});var url2=SG.globals.help_urls.manage_defaults;sub_items.push({html:'<a href="'+url2+'" target="global_layout_help">Help for Global Layouts...</a>',icon_name:'icon_help_balloon_sm',item_selected:{fn:function(){window.open(url2,'global_layout_help');},scope:this}});items.push({html:'Global Default Layout',submenu:{items:sub_items,icon_width:18},disabled:(this.page.type=='detail'&&this.page.entity_type=='Page')||submenu_disabled});}
items.push({line:true});disabled=['detail','site_prefs','home'].indexOf(this.page.type)>-1||!this.page.user_can_save()||is_default_page||is_status_page||is_admin_url_page||this.page.ui_category=='project';items.push({html:'Delete Page',disabled:disabled,item_selected:{fn:this.delete_page,scope:this},icon_name:'trash'});if(disable_all){for(var i=0;i<items.length;i++)
items[i].disabled=true;}
this.page_menu.items=items;this.page_menu.render();},warn_and_revert_to_global_default:function(){new SG.NewDialog({title:"Revert Page to Global Default",body:"You are about to revert settings for this Page to the global defaults. You cannot undo this action."+" Do you want to continue?",actions:[{label:'Cancel',type:'link'},{label:'Revert Page to Global Default',callback:{fn:function(){this.page.settings_revert_to_global_default();},scope:this}}]});},warn_and_save_as_global_default:function(){new SG.NewDialog({title:"Save Page as Global Default",body:"You are about to save the settings for this Page as the global defaults. You cannot undo this action."+" Do you want to continue?",actions:[{label:'Cancel',type:'link'},{label:'Save Page As Global Default',callback:{fn:function(){this.page.settings_save_as_global_default();},scope:this}}]});},delete_page:function(){if(confirm("Delete page ID="+this.page.id+"?"))
document.location=SG.globals.urls.page_delete+'?id='+this.page.id;},fetch_title:function(){var entity=this.context.get('entity');var spec={type:entity.type,id:entity.id,columns:[this.title_field],result:this.data_set};SG.Repo.find(spec);},fetch_page_title:function(){var spec={type:'Page',id:this.page.id,columns:['shared'],result:this.data_set};SG.Repo.find(spec);},on_data_change:function(changes){var change,i;var render=false;for(i=0;i<changes.length;i++){change=changes[i];if(change.type==='update'&&change.column==this.title_field&&change.state==='server')
render=true;}
if(render){this.render_widget();}},on_action_menu_click:function(e){if(e.type=='contextmenu')e.stopEvent();if(!this.action_menu){this.action_menu=this.new_component(SG.Menu,{position:{dom_elem:this.action_menu_icon,elem_anchor:"br",menu_anchor:"tr"},items:this.action_menu_items});this.action_menu.render();}
this.action_menu.show();},get_action_menu_items:function(){var entity_type=this.entity.type;var item,items=[];if(SG.globals.preferences.enable_rv_integration=="yes"){if(entity_type=='Version'){items.push({html:'Play in RV',icon_name:'rv_play',value:'play',order:1,item_selected:{fn:this.on_play_in_rv,scope:this}});items.push({html:'Compare in RV',icon_name:'rv_compare',value:'compare',order:2,item_selected:{fn:this.on_play_in_rv,scope:this}});}}
if(entity_type=='Playlist'){items.push({html:'Launch Review Notes App',item_selected:{fn:this.start_notes_app,scope:this},disabled:!SG.schema.can_create_entity("Note"),icon_name:'icon_Playlist'});}
if(entity_type!='DisplayColumn'){for(var i=0;i<SG.globals.action_menu_items.length;i++){item=SG.globals.action_menu_items[i];if(item.entity_type==null||item.entity_type==entity_type){items.push({html:item.title,url:item.url,order:item.order||1,item_selected:{fn:this.on_custom_external_action,scope:this}});}}}
if(sg_tank_enabled()){if(!this.tank_action_menu){this.tank_action_menu=this.new_component(SG.TankActionMenu);}
var proj=this.get_page_project();var proj_ids=[];if(proj)
proj_ids.push(proj.id);if(items.length)
items.push({line:true});items=items.concat(this.tank_action_menu.get_items(entity_type,[this.entity.id],proj_ids));}
return items;},on_play_in_rv:function(menu,item){var cfg={ids:[this.entity.id],mode:item.value};var p=new SG.util.PlayInRV(cfg);},start_notes_app:function(){SG.NotesApp.show({playlist_id:this.entity.id});},on_custom_external_action:function(menu,item){SG.Widget.PageTitle.superclass.on_custom_external_action.call(this,this.entity,item.url);},on_refresh_button_down:function(e){this.refresh_div.addClass('down');},on_refresh_button_up:function(e){this.refresh_div.removeClass('down');},on_refresh_button_click:function(e){if(!SG.Page.unsaved_data.confirm_proceed())
return;if(this.page.type=='canvas'||this.page.type=='home')
this.refresh_canvas_page_widgets();else if(this.page.type=='detail')
this.refresh_detail_page();else if(this.page.type=='url')
this.refresh_url_page();},refresh_canvas_page_widgets:function(){var page_container=this.page.page_container;var eqp=sg_find('div.body.sgw_entity_query_entity_query_page',page_container.dom);if(eqp){this.refresh_entity_query_page();return;}
var wrappers=sg_find_all('div.sgw_canvas_wrapper',page_container.dom);for(var i=0;i<wrappers.length;i++){var wrapper_div=Ext.get(wrappers[i]);var id_string=wrapper_div.dom.getAttribute('id');var widget=this.get_widget_from_id_string(id_string);widget.refresh_child_widget();}},refresh_url_page:function(){var page_container=this.page.page_container;var iframe_wrapper=page_container.child('div.sgw_iframe');var id_string=iframe_wrapper.dom.getAttribute('id');var widget=this.get_widget_from_id_string(id_string);widget.fetch_fields();},refresh_entity_query_page:function(){var page_container=this.page.page_container;var entity_query_page_div=page_container.child('div.sgw_entity_query_entity_query_page');var id_string=entity_query_page_div.dom.getAttribute('id');var widget=this.get_widget_from_id_string(id_string);if(widget){widget.reload_all_entities();return;}
console.log("Couldn't find the entity query page widget.");var entity_query_mode_div=page_container.child('div.sgw_entity_query_mode');var id_string=entity_query_mode_div.dom.getAttribute('id');var widget=this.get_widget_from_id_string(id_string);widget.reload_all_entities();},refresh_detail_page:function(){var page_container=this.page.page_container;var canvas_body=page_container.child('div.sgw_canvas_body');if(canvas_body){this.refresh_canvas_page_widgets();return;}
var detail_page_body=page_container.child('div.sgw_detail_page_body');var id_string,widget,parent_widget;if(detail_page_body){id_string=detail_page_body.dom.getAttribute('id');widget=this.get_widget_from_id_string(id_string);parent_widget=widget.get_parent();parent_widget.render_widget();return;}
var threaded_detail_page=page_container.child('div.sgw_threaded_detail_page');if(threaded_detail_page){id_string=threaded_detail_page.dom.getAttribute('id');widget=this.get_widget_from_id_string(id_string);parent_widget=widget.get_parent();parent_widget.render_widget();return;}
var eqp=sg_find('div.body.sgw_entity_query_entity_query_page',page_container.dom);if(eqp){this.refresh_entity_query_page();return;}},get_widget_from_id_string:function(id_string){var id=Number(id_string.split('_')[1]);var widget=SG.Widget.get_instance_by_id(id);return widget;},on_click:function(e){var t=Ext.get(e.getTarget());var favorite=t.findParent('div.favorite',this.container,true);if(favorite){this.page.toggle_favorite();this.render();}},render_info_popover_contents:function(popover,popover_body){if(['home','canvas'].indexOf(this.page.type)>-1&&this.body_widget_is_entity_query_page()){var canvas_page=this.get_parent();var eqp=canvas_page.body_widget;var filters=sg_deep_copy(eqp.get('filters'));var writer=this.new_component(SG.ConditionSummaryWriter,{entity_type:this.page.entity_type});if(writer.filter_count(filters)>0){var conditions=this.templates.info_popover_conditions.apply({conditions:writer.render_summary(filters)})}else{var conditions=this.templates.info_popover_no_conditions.apply({entity_type_plural:SG.schema.entity_types[this.page.entity_type].display_name_pluralized});}}
var description='';if(this.page.description&&this.page.description.strip()){description=this.templates.info_popover_description.apply({description:this.page.description});}
popover_body.innerHTML=this.templates.info_popover_contents.apply({description:description,conditions:conditions,created_by:this.page.created_by?this.page.created_by.name:'Shotgun',last_updated:SG.Renderers.friendly_date_time.render(this.page.updated_at)});},get_page_project:function(){if(this.page.project_id)
return SG.schema.project_by_id(this.page.project_id);else
return this.page.root_widget.single_project_from_context();},});SG.Widget.Notes=function(context,widget_spec,id)
{SG.Widget.Notes.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Notes,SG.Widget.Base,{default_settings:{autocreate_new_note:false,filters:{logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:[{name:'Current Entity',type:'None',id:0,valid:'parent_entity_token'}],active:'true'}]}},canvas_quickfilter:true,grouping_delta:60000,templates:{widget:'<div class="sg_widget_notes">'+'<div class="sg_widget_notes_title">{title}</div>'+'{new_notes}{body}</div>',title:'<span class="sg_widget_notes_count">{count}</span>'+'<span class="sg_widget_notes_add">[+] Add Note</span>'+'{playlist_version_selector}{expand_collapse}',title_expand_collapse:'<div class="sg_widget_notes_expand_collapse"><span class="sg_widget_notes_expand">Expand</span>'+'<span class="sg_widget_notes_collapse">Collapse</span></div>',title_no_count:'<span class="sg_widget_notes_count">&nbsp;</span>'+'<span class="sg_widget_notes_add">[+] Add Note</span>{playlist_version_selector}',title_no_add_note:'<span class="sg_widget_notes_count">{count}</span>{playlist_version_selector}',new_notes:'<div class="sg_widget_notes_new_notes"></div>',body:'<div class="sg_widget_notes_body">{content}</div>',closed_note:'<div class="sg_widget_notes_note" note_id="{note_id}" state="closed">'+'<div class="sg_widget_notes_note_header">{header}</div>'+'<div class="sg_widget_notes_note_contents"></div></div>',open_note:'<div class="sg_widget_notes_note" note_id="{note_id}" state="open">'+'<div class="sg_widget_notes_note_header">{header}</div>'+'<div class="sg_widget_notes_note_contents">{content}</div></div>',closed_header:'<table class="sg_widget_notes_note_header_table '+'sg_widget_notes_note_closed_header_table {unread}">'+'<tr>'+'<td class="sg_widget_notes_note_icon"><img src="{icon}"></td>'+'<td class="sg_widget_notes_note_header_to">{to}'+'<span class="sg_widget_notes_note_header_content">{content}</span>'+'</td>'+'<td class="sg_widget_notes_note_header_from">{from}</td>'+'<td class="sg_widget_notes_note_header_updated">{updated}</td>'+'<td style="{status_cell_styles}" class="sg_widget_notes_note_header_status {status_cell_classes}" '+'{status_cell_attributes}>{status_cell_content}</td>'+'</tr>'+'</table>',open_header:'<table class="sg_widget_notes_note_header_table '+'sg_widget_notes_note_open_header_table {unread}">'+'<tr>'+'<td class="sg_widget_notes_note_icon"><img src="{icon}"></td>'+'<td class="sg_widget_notes_note_header_to">{to}'+'<span class="sg_widget_notes_note_header_cc">{cc}</span>'+'</td>'+'<td style="{status_cell_styles}" class="sg_widget_notes_note_header_status {status_cell_classes}" '+'{status_cell_attributes}>{status_cell_content}</td>'+'</tr>'+'</table>',content:'<div class="sg_widget_notes_note_content_root">{note}</div>'+'<div class="sg_widget_notes_note_content_replies">{replies}</div>'+'<div class="sg_widget_notes_note_reply_form"></div>'+'<div class="sg_widget_notes_note_reply_button">'+'<input type="button" value="Reply"></div>',image_attachment:'<div class="attachment_content image" record_id="{record_id}" sg_tip="{sg_tip}">'+'<a href="{image_path}" target="_blank"><img src="/thumbnail/image/{thumb}" onError="sg_missing_image(this)"/></a>'+'</div>',other_attachments:'<div class="attachment_table">{attachments}</div>',other_attachment:'<div class="attachment_other {extra}"><table><tr><td class="filename">'+'<div>{filename}</div></td><td class="file_size"><div>{file_size}</div></td>'+'<td class="trash">{delete_attachment}</td></tr></table></div>',delete_attachment:'<div class="trash attachment_delete" attachment_id="{attachment_id}" note_id="{note_id}"></div>',content_row:'<div class="sg_widget_notes_note_content_row"><b>{user},</b> '+'{updated}<br>{content}</div>',content_row_no_user:'<div class="sg_widget_notes_note_content_row">'+'{updated}<br>{content}</div>',playlist_version_selector:'<span class="playlist_version_selector">{label} '+'<div class="dropdown_arrow_small"></div></span>',note_addressings:'<span class="sgc_note_addressings" note_id="{note_id}"></span>',},init_widget:function()
{var title_options=this.context.get('title_options');this.skip_title_count=false;this.skip_title_add_note=false;if(title_options)
{if(title_options["skip_count"])
this.skip_title_count=true;if(title_options["skip_add_note"])
this.skip_title_add_note=true;if(title_options["version_filter_playlist"])
this.version_filter_playlist=title_options["version_filter_playlist"];}
this.must_not_match_extra_links=this.context.get('must_not_match_extra_links')||[];this.must_also_match_extra_links=this.context.get('must_also_match_extra_links')||[];this.entity=this.context.get('entity');this.grandparent_entity=this.context.get('grandparent_entity');this.notes_set=this.new_data_set('Note',this.on_notes_load,this.on_notes_change);if(this.version_filter_playlist)
this.playlist_version_data_set=this.new_data_set('Version',this.on_versions_load);this.reply_sets={};this.attachment_sets={};this.rendered_once=false;},get_filters:function()
{var context_filters=this.context.get('filters');if(context_filters)
return sg_deep_copy(context_filters);else
return sg_deep_copy(this.get('filters'));},request_data:function(){var spec={result:this.notes_set,type:'Note',sorts:[{column:"updated_at",direction:"desc"}],columns:SG.schema.entity_types['Note'].fields_sorted_by_display_name,};var ssf=this.context.get("server_side_filters");if(ssf){spec.server_side_filters=ssf["type"];spec.server_side_filters_params=ssf["params"];};var filters=this.get_filters();this.substitute_filter_tokens(filters,this.entity);if(this.version_filter_playlist&&this.selected_playlist_version)
{var version={type:'Version',id:this.selected_playlist_version.id};filters.conditions.push({path:"note_links",relation:"is",values:[version]});}
spec.filters=filters;var add_filter=this.context.get('additional_filter_conditions');if(add_filter)
spec['filters']['conditions']=spec['filters']['conditions'].concat(add_filter);SG.Repo.query(spec);if(this.version_filter_playlist)
{filters={logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[this.context.get('entity')]}]};var spec={type:'Version',filters:filters,columns:["id","code"],sorts:[{column:'code',direction:'asc'}],result:this.playlist_version_data_set,parent_entity:this.version_filter_playlist};SG.Repo.query(spec);}},get_notes:function(){var i,note,notes=[];for(i=0;i<this.notes_set.count();i++){note=this.notes_set.get_record(i);notes.push(note);}
return notes;},on_notes_load:function(){this.hide_loading_overlay();this.render();},on_versions_load:function()
{},on_notes_change:function(changes){var note_id,note_hash={};var check=['read_by_current_user','addressings_to','addressings_cc'];var change,i;for(i=0;i<changes.length;i++){change=changes[i];if(change.type==='update'&&change.state==='server'&&check.indexOf(change.column)!==-1){note_hash[change.record.get_id()]=change.record;}
else if(change.type==='prepend')
{this.update_title();this.show_new_note(change.record);}}
for(note_id in note_hash){if(!note_hash.hasOwnProperty(note_id))continue;this.update_note_header(note_hash[note_id]);}},get_reply_set:function(note){var note_id=note.get_id();var ds=this.reply_sets[note_id];if(!ds){ds=this.new_data_set('Reply',this.on_reply_load,this.on_reply_change);ds.note_id=note_id;this.reply_sets[note_id]=ds;}
return ds;},get_attachment_set:function(note){var note_id=note.get_id();var ds=this.attachment_sets[note_id];if(!ds){ds=this.new_data_set('Attachment');ds.note_id=note_id;this.attachment_sets[note_id]=ds;}
return ds;},request_attachments:function(note){var ds=this.get_attachment_set(note);var cols=['file_size','image'].concat(SG.schema.entity_types.Attachment.fields_sorted_by_display_name);var spec={result:ds,type:'Attachment',columns:cols,sorts:[{column:"created_at",direction:"asc"}],filters:{logical_operator:'and',conditions:[{path:'attachment_links',relation:'is',values:[{type:'Note',id:note.get_id()}]}]}};SG.Repo.query(spec);},request_replies:function(note){this.request_attachments(note);var ds=this.get_reply_set(note);var spec={result:ds,type:'Reply',columns:['user','created_at','content'],sorts:[{column:"created_at",direction:"asc"}],filters:{logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:'Note',id:note.get_id()}]}]}};SG.Repo.query(spec);},on_reply_load:function(ds){var note=this.notes_set.get_record_by_id(ds.note_id);this.update_contents(note);},on_reply_change:function(changes){},toggle_note:function(note_elem,force_state){var note_id=Number(note_elem.dom.getAttribute('note_id'));var note=this.notes_set.get_record_by_id(note_id);var note_state=note_elem.dom.getAttribute('state');var contents=note_elem.child('.sg_widget_notes_note_contents');var header=note_elem.child('.sg_widget_notes_note_header');if(note_state=="closed"&&force_state!="closed"){header.update(this.render_open_header(note));note_elem.dom.setAttribute('state','open');contents.update('<i>Loading...</i>');this.mark_as_read(note);this.request_replies(note);}
if(note_state=="open"&&force_state!="open"){header.update(this.render_closed_header(note));note_elem.dom.setAttribute('state','closed');contents.update("");}
this.render_note_addressings(note);},mark_as_read:function(note){spec={type:'Note',id:note.get_id(),column:'read_by_current_user',value:'read',no_undo:true};SG.Repo.update(spec);},update_contents:function(note){var sel='div.sg_widget_notes_note[note_id='+note.get_id()+']';var note_elem=this.container.child(sel);var contents=note_elem.child('.sg_widget_notes_note_contents');contents.update(this.render_contents(note));},filtered_list:function(field)
{var filtered_list=[]
var subset=field.status_list_subset;for(var i=0;i<subset.length;++i){if(SG.allow("update_field",{entity_type:field.entity_type,field_name:field.name,field_value:subset[i]})){filtered_list.push(subset[i]);}}
return filtered_list;},group_replies_and_attachments:function(note){var reply_set=this.get_reply_set(note);var attachment_set=this.get_attachment_set(note);var groups=[];var group_data={};var rec,created_at,i,j;for(i=0;i<reply_set.count();i++){rec=reply_set.get_record(i);created_at=Date.sgParseDateTime(rec.get('created_at')).getTime();groups.push(created_at);group_data[created_at]={reply:rec};}
var prev_group,prev_group_data,prev_primary_rec,prev_user_id;for(i=0;i<attachment_set.count();i++){rec=attachment_set.get_record(i);created_at=Date.sgParseDateTime(rec.get('created_at')).getTime();created_by=rec.get('created_by');user_id=created_by?created_by.id:-1;for(j=0;j<groups.length;j++){if(created_at<groups[j])break;}
prev_group=groups[j-1];if(typeof(prev_group)=="undefined"){groups.splice(0,0,created_at);group_data[created_at]={attachments:[rec]};continue;}
prev_group_data=group_data[prev_group];if('reply'in prev_group_data){prev_primary_rec=prev_group_data.reply;prev_user_id=prev_primary_rec.get('user').id;}else{prev_primary_rec=prev_group_data.attachments[0];prev_user_id=prev_primary_rec.get('created_by').id;}
if(created_at<prev_group+this.grouping_delta&&user_id==prev_user_id){group_data[prev_group].attachments=group_data[prev_group].attachments||[];group_data[prev_group].attachments.push(rec);}else{groups.splice(j,0,created_at);group_data[created_at]={attachments:[rec]};}}
return{groups:groups,group_data:group_data};},on_first_render:function()
{this.container=this.get_container();var cell_config={container:this.container,data_set:this.notes_set,projects:this.context_projects(),ignore_pending_changes:true,edit_applied_callback:{fn:this.on_status_pending_update,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,'click',this.on_click);this.render_loading();this.request_data();},render_widget:function()
{if(!this.notes_set.is_loaded())return;this.render_notes();},render_loading:function()
{this.container.update('<div class="loading"><i>Loading notes...</i></div>');},render_notes:function(){if(this.context.get('zero_notes_disable_render')&&this.notes_set.count()==0)
{var div_to_clear=this.context.get('zero_notes_disable_render_div_to_clear');if(div_to_clear)
div_to_clear.remove();else
this.container.update("");return;}
var title=this.render_title();var new_notes=this.render_new_notes();var body=this.render_body();var widget=this.templates.widget.apply({title:title,new_notes:new_notes,body:body});this.container.update(widget);this.render_all_note_addressings();if(this.rendered_once==false&&this.get('autocreate_new_note')){this.new_note();this.rendered_once=true;}},render_title:function(){var template_label='title';if(this.skip_title_count&&this.skip_title_add_note)
return"";if(this.skip_title_count)
template_label='title_no_count';if(this.skip_title_add_note)
template_label='title_no_add_note';var tpl=this.templates[template_label];var title="";var count=this.render_count();var playlist_version_selector=this.version_filter_playlist?this.render_playlist_version_selector():'';if(!this.skip_title_count){var cfg={count:count,playlist_version_selector:playlist_version_selector}
if(count!="0 Notes"){cfg.expand_collapse=this.templates.title_expand_collapse.apply();}
title=tpl.apply(cfg);}else{title=tpl.apply({playlist_version_selector:playlist_version_selector});}
return title;},render_count:function(){var count=this.get_notes().length;var content='';if(count==1){content='1 Note';}else{content=count+' Notes';}
return content;},render_body:function(){var content='';var notes=this.get_notes();for(var i=0;i<notes.length;i++){content+=this.render_closed_note(notes[i]);}
var body=this.templates.body.apply({content:content});return body;},render_new_notes:function(){return this.templates.new_notes.apply({});},render_contents:function(note){var date_r=SG.Renderers.long_date_time;var entity_r=SG.Renderers.basic_entity;var tpl_params={user:entity_r.render_nbsp(note.get("user")),updated:date_r.render_nbsp(note.get("updated_at")),content:SG.Markup.parse(note.get('content'))};var note_content=this.render_content_row(tpl_params);var replies=this.render_replies(note);var content=this.templates.content.apply({note:note_content,replies:replies});return content;},render_content_row:function(tpl_params){if(tpl_params.user=="&nbsp;")
return this.templates.content_row_no_user.apply(tpl_params);else
return this.templates.content_row.apply(tpl_params);},render_closed_note:function(note){var header=this.render_closed_header(note);return this.templates.closed_note.apply({note_id:note.get_id(),header:header});},render_closed_header:function(note){var entity_r=SG.Renderers.basic_entity;var multi_r=SG.Renderers.basic_multi_entity;var date_r=SG.Renderers.short_date_time;var subject=note.get('subject')||'';var subject_html='<span style="font-weight: bolder;">'+subject+'</span>';var icon=SG.globals.icons.entities['Note_'+note.get('read_by_current_user')];var tpl_params={content:(subject_html+' '+note.get("content")).strip(),icon:icon,to:this.templates.note_addressings.apply({note_id:note.id}),from:entity_r.render_nbsp(note.get("user")),updated:date_r.render_nbsp(note.get("updated_at")),unread:note.get("read_by_current_user")=="unread"?"unread":""};this.render_status_cell(note,tpl_params);var header=this.templates.closed_header.apply(tpl_params);return header;},render_status_cell:function(note,params)
{var cell=this.cell_manager.get_cell('sg_status_list');var cfg=cell.render(note);params.status_cell_styles=cfg.cell_styles;params.status_cell_attributes=cfg.cell_attributes;params.status_cell_classes=cfg.cell_classes;params.status_cell_content=cfg.cell_content;},render_open_note:function(note){var header=this.render_open_header(note);var content=this.render_contents(note);var note=this.templates.open_note.apply({note_id:note.get_id(),header:header,content:content});return note;},render_open_header:function(note){var multi_r=SG.Renderers.basic_multi_entity;var icon=SG.globals.icons.entities['Note_'+note.get('read_by_current_user')];var tpl_params={icon:icon,to:this.templates.note_addressings.apply({note_id:note.id}),unread:note.get("read_by_current_user")=="unread"?"unread":""};var cc=multi_r.render_nbsp(note.get("addressings_cc"));if(cc!="&nbsp;"){tpl_params["cc"]=", Cc: "+cc;}
this.render_status_cell(note,tpl_params);var header=this.templates.open_header.apply(tpl_params);return header;},render_replies:function(note){var date_r=SG.Renderers.long_date_time;var entity_r=SG.Renderers.basic_entity;var grouped=this.group_replies_and_attachments(note);var group_data,reply,attach,i,cfg;var replies='';var content;for(i=0;i<grouped.groups.length;i++){content='';group_data=grouped.group_data[grouped.groups[i]];if('reply'in group_data){reply=group_data.reply;content=SG.Markup.parse(reply.get('content'));if('attachments'in group_data)
content+=this.render_attachments(group_data.attachments,note);cfg={user:entity_r.render_nbsp(reply.get("user")),updated:date_r.render_nbsp(reply.get("created_at")),content:content};replies+=this.render_content_row(cfg);}else{attach=group_data.attachments[0];content="<br>"+this.render_attachments(group_data.attachments,note);cfg={user:entity_r.render_nbsp(attach.get("created_by")),updated:date_r.render_nbsp(attach.get("created_at")),content:content}
replies+=this.render_content_row(cfg);}}
return replies;},render_attachments:function(attachments,note){var url_r=SG.Renderers.url;var size_r=SG.Renderers.file_size;var schema_field=SG.schema.get_field('Attachment','this_file');var html='';var image_attachments=[];var other_attachments=[];var i,attachment_rec;for(i=0;i<attachments.length;i++){attachment_rec=attachments[i];if(attachment_rec.get('filename').match(/.*\.((png)|(jpg)|(gif))$/)&&attachment_rec.get('image'))
image_attachments.push(attachment_rec);else
other_attachments.push(attachment_rec);}
for(i=0;i<image_attachments.length;i++){attachment_rec=image_attachments[i];size_str=size_r.render_nbsp(attachment_rec.get('file_size'));html+=this.templates.image_attachment.apply({record_id:attachment_rec.id,sg_tip:attachment_rec.get('filename')+' ('+size_str+')',thumb:attachment_rec.get('image'),image_path:attachment_rec.get('this_file').url});}
if(html)
html+='<br/>';var file_field=SG.schema.get_field('Attachment','this_file');var attachments='';for(i=0;i<other_attachments.length;i++){if(i==0){attachments+=this.templates.other_attachment.apply({extra:'title',filename:'File',file_size:'Size',delete_attachment:''});}
attachment_rec=other_attachments[i];size_str=SG.Renderers.file_size.render_nbsp(attachment_rec.get('file_size'));file_link=SG.Renderers.url.render(attachment_rec.get('this_file'),file_field,size_str);var delete_attachment='';if(SG.schema.can_retire_entity('Attachment')){delete_attachment=this.templates.delete_attachment.apply({attachment_id:attachment_rec.id,note_id:note.id});}
attachments+=this.templates.other_attachment.apply({extra:i%2==0?'even':'odd',filename:file_link,file_size:size_str,delete_attachment:delete_attachment});}
if(attachments!='')
html+=this.templates.other_attachments.apply({attachments:attachments});return html;},render_playlist_version_selector:function()
{var version_name=this.selected_playlist_version?"Filter: "+this.selected_playlist_version.get('code'):'All Versions';return this.templates.playlist_version_selector.apply({label:version_name});},on_click:function(e){var elem,note_elem;var target=Ext.get(e.getTarget());var dom_event=e.browserEvent;var option_click=dom_event.altKey;elem=target.findParent('.sg_widget_notes_add',this.container,true);if(elem){if(option_click)
{var all_widgets=this.get_all_widgets();var i,w;for(i=0;i<all_widgets.length;i++)
{w=all_widgets[i];if(w.get('type')=='SG.Widget.Notes')
w.new_note();}}
else
this.new_note();return;}
expand_elem=target.findParent('.sg_widget_notes_expand',this.container,true);if(expand_elem){note_elem=this.container.query('.sg_widget_notes_note');for(var i=0;i<note_elem.length;++i){this.toggle_note(Ext.get(note_elem[i]),"open");}
return;}
collapse_elem=target.findParent('.sg_widget_notes_collapse',this.container,true);if(collapse_elem){note_elem=this.container.query('.sg_widget_notes_note');for(var i=0;i<note_elem.length;++i){this.toggle_note(Ext.get(note_elem[i]),"closed");}
return;}
note_elem=target.findParent('.sg_widget_notes_note',this.container,true);elem=target.findParent('.sg_widget_notes_note_header_table',this.container,true);if(elem){elem=target.findParent('.sg_widget_notes_note_header_status',this.container,true);if(elem){}else{if(e.altKey){var note_body=target.findParent('.sg_widget_notes_body',this.container,true);note_elem=note_body.query('.sg_widget_notes_note');for(var i=0;i<note_elem.length;++i){this.toggle_note(Ext.get(note_elem[i]),"open");}}else{this.toggle_note(note_elem);}}
return;}
elem=target.findParent('.sg_widget_notes_note_reply_button',this.container,true);if(elem){this.show_new_reply_form(note_elem);return;}
elem=target.findParent('span.playlist_version_selector',this.container);if(elem)
{this.show_playlist_versions_menu(elem);return;}
elem=target.findParent('div.attachment_delete');if(elem){this.delete_attachment_from_div(elem);}},delete_attachment_from_div:function(attachment_div){var attachment_id=Number(attachment_div.getAttribute('attachment_id'));var note_id=Number(attachment_div.getAttribute('note_id'));var dd=new SG.util.DeleteAttachment({entity_ds:this.notes_set,entity_id:note_id,attachment_id:attachment_id});attachment_div=Ext.get(attachment_div);var attachment_table_div=attachment_div.findParent('div.attachment_table',this.container,true);attachment_table_div.remove();},new_note_form_fields:[{entity_type:'Note',name:'addressings_to'},{entity_type:'Note',name:'addressings_cc',link_to_show_text:'Add Cc'},{entity_type:'Note',name:'note_links',link_to_show_text:'Edit Links'},{entity_type:'Note',name:'subject',link_to_show_text:'Add Subject'},{entity_type:'Note',name:'sg_note_type'},{links_for:['Add Cc','Edit Links','Add Subject']},{entity_type:"Note",name:"content",input_type:'textarea'}],new_reply_form_fields:function(){var form_fields=[];var note_fields=['addressings_to','addressings_cc','note_links','subject','sg_note_type'];for(var i=0;i<note_fields.length;i++){var field_name=note_fields[i];if(SG.schema.can_edit_field('Note',field_name))
form_fields.push({entity_type:'Note',name:field_name,link_to_show_text:'Edit Header'});}
if(form_fields.length)
form_fields.push({links_for:['Edit Header']});form_fields.push({entity_type:"Reply",name:"content",input_type:'textarea'});return form_fields;},new_note:function(){var parent=this.get_parent();if(typeof parent.get_default_note=='function'){parent.get_default_note({fn:this.show_new_note_form,scope:this});return;}
var context={entity_type:'Note',parent_entity:this.entity,data_record:new SG.Data.Record('Note')};if(this.context.get('parent_entity')&&this.context.get('parent_entity').type=='Playlist')
context['grandparent_entity']=this.context.get('parent_entity');var factory=new SG.EntityFactory(context);factory.on('done',this.show_new_note_form,this);factory.create();},show_new_note_form:function(data_record)
{var e=this.container.child('.sg_widget_notes_new_notes');e=Ext.get(e);var container=document.createElement('div');e.insertFirst(container);container=Ext.get(container);var nef_config={entity_type:'Note',single_project:this.single_project_from_context(),all_projects:this.context_projects(),container:container,source_record:data_record,entity_field_pref:'new_entity_short',hide_project_selector:true,hide_fields_with_default_values:true}
var nef=sg_new_entity_dialog(nef_config);var me=this;this.add_event(nef,"entity_created",function(recs){nef.destroy();var request_replies=false;var new_rec;for(var i=0;i<recs.length;i++)
{var r=recs[i];if(r.type=='Note')
{new_rec=new SG.Data.Record('Note');new_rec.load(r.row);me.notes_set.prepend_record(new_rec);}
else if(r.type=='Attachment')
request_replies=true;}
if(request_replies)
me.request_replies(new_rec);});this.add_event(nef,"form_canceled",function(e){var dom_event=e.browserEvent;var option_click=dom_event.altKey;if(option_click)
me.cancel_all_forms_in_all_notes();});if(!this.open_forms)
this.open_forms=[];this.open_forms.push(nef);},show_new_reply_form:function(note_elem){var note_id=Number(note_elem.dom.getAttribute('note_id'));var note=this.notes_set.get_record_by_id(note_id);var button=note_elem.child('.sg_widget_notes_note_reply_button');var form=note_elem.child('.sg_widget_notes_note_reply_form');var container=Ext.DomHelper.append(form,{tag:'div'},true);var form_config={container:container,data_set:this.notes_set,entity:{type:'Note',id:note_id},projects:this.context_projects(),show_cancel:true,focus_reply:true,new_entity_project:this.single_project_from_context(),busy_callback:{fn:this.on_reply_form_busy,scope:this},cancel_callback:{fn:this.on_reply_form_cancel,scope:this},done_callback:{fn:this.on_reply_form_done,scope:this},widget:this};var thread_form=this.new_component(SG.ThreadForm,form_config);thread_form.render();thread_form.extra={note:note,note_elem:note_elem,form:form,button:button};form.show();button.hide();},on_reply_form_busy:function(thread_form){this.show_loading_overlay(thread_form.extra.note_elem);},on_reply_form_cancel:function(thread_form){thread_form.extra.form.update("");thread_form.extra.form.hide();thread_form.extra.button.show();thread_form.destroy();this.hide_loading_overlay(thread_form.extra.note_elem);},on_reply_form_done:function(thread_form){this.on_reply_form_cancel(thread_form);this.request_replies(thread_form.extra.note);},show_new_note:function(note){var elem=this.container.child('.sg_widget_notes_body');var new_note=this.render_open_note(note);var before=elem.dom.firstChild;var dh=Ext.DomHelper;if(before){dh.insertBefore(before,new_note);}else{dh.append(elem,new_note)}
this.render_note_addressings(note);},update_title:function(){if(this.skip_title_count)
return;var title_elem=this.container.child('.sg_widget_notes_title');title_elem.update(this.render_title());},update_replies:function(note){var note_id=note.get_id();var sel='div.sg_widget_notes_note[note_id='+note_id+']';var note_elem=this.container.child(sel);var replies=note_elem.child('.sg_widget_notes_note_content_replies');replies.update(this.render_replies(note));},update_note_header:function(note){var sel='div.sg_widget_notes_note[note_id='+note.get_id()+']';var note_elem=this.container.child(sel);if(!note_elem)return;var note_state=note_elem.dom.getAttribute('state');var header=note_elem.child('.sg_widget_notes_note_header');if(note_state=='open'){header.update(this.render_open_header(note));}else if(note_state=='closed'){header.update(this.render_closed_header(note));}
this.refresh_note_addressings(note);},render_all_note_addressings:function(){var notes=this.get_notes();for(var i=0;i<notes.length;i++){this.render_note_addressings(notes[i]);}},render_note_addressings:function(note){if(!this.note_addressings)this.note_addressings={};if(!this.note_addressings[note.id]){var selector='span.sgc_note_addressings[note_id="'+note.id+'"]';var na=new SG.NoteAdressings({owner:this,container_selector:selector,record_id:note.id,owner_data_set:this.notes_set});na.set_tasks(note.get('tasks'),note.get("addressings_to"));this.note_addressings[note.id]=na;}else{var na=this.note_addressings[note.id];na.render();}},refresh_note_addressings:function(note){if(!this.note_addressings||!this.note_addressings[note.id]){this.render_note_addressings(note);return;}else{var na=this.note_addressings[note.id];na.destroy();this.note_addressings[note.id]=null;this.render_note_addressings(note);}},cancel_all_forms_in_all_notes:function()
{var all_widgets=this.get_all_widgets();var i,w;for(i=0;i<all_widgets.length;i++)
{w=all_widgets[i];if(w.get('type')=='SG.Widget.Notes')
w.cancel_all_forms();}},cancel_all_forms:function()
{if(!this.open_forms)
return;var forms_to_cancel=this.open_forms.concat();for(var i=0;i<forms_to_cancel.length;i++)
forms_to_cancel[i].destroy();},on_status_pending_update:function(field,record,cell)
{cell.update_cell(record);},show_playlist_versions_menu:function(dropdown_dom_elem)
{if(this.playlist_versions_menu&&this.playlist_versions_menu.is_showing())
{this.playlist_versions_menu.hide();return;}
var items=[{html:"All Versions",version_id:null,checked:!this.selected_playlist_version}];var version;for(i=0;i<this.playlist_version_data_set.records.length;i++)
{version=this.playlist_version_data_set.records[i];items.push({html:version.get('code'),version_id:version.id,checked:(this.selected_playlist_version&&this.selected_playlist_version.id==version.id)});}
if(!this.playlist_versions_menu)
{this.playlist_versions_menu=new SG.Menu({items:items,position:{dom_elem:dropdown_dom_elem,elem_anchor:"bl",menu_anchor:"tl"},item_selected:{fn:this.on_playlist_version_selected,scope:this}});}
else
{this.playlist_versions_menu.items=items;this.playlist_versions_menu.position={dom_elem:dropdown_dom_elem,elem_anchor:"bl",menu_anchor:"tl"};}
this.playlist_versions_menu.render();this.playlist_versions_menu.show();},on_playlist_version_selected:function(menu,item)
{var new_version=this.playlist_version_data_set.get_record_by_id(item.version_id);this.selected_playlist_version=new_version;this.show_loading_overlay();this.request_data();}});SG.Widget.NotesOnLinkEntity=function(context,widget_spec,id)
{SG.Widget.NotesOnLinkEntity.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NotesOnLinkEntity,SG.Widget.Base,{default_settings:{},templates:{},init_children:function()
{},init_widget:function()
{this.child_notes_wgts=[];this.entity=this.context.get('entity');},init_children:function()
{},render:function()
{this.container=this.get_container();this.container.update('&nbsp<br>&nbsp<br>&nbsp<br>&nbsp<br>&nbsp<br>&nbsp');this.show_loading_overlay();this.data_set=this.new_data_set(this.entity.type,this.render_data);var spec={type:this.entity.type,id:this.entity.id,columns:['entity'],result:this.data_set};SG.Repo.find(spec);},render_data:function()
{this.hide_loading_overlay();this.container.update('');var rec=this.data_set.get_record_by_id(this.entity.id);this.link=rec.get('entity');var dh=Ext.DomHelper;var main_child_ctx=this.context.clone();main_child_ctx.set('entity',{id:this.entity.id,type:this.entity.type,name:this.entity.name});this.main_notes_wgt=this.construct_child('main_notes',main_child_ctx);this.main_notes_div=dh.append(this.container,{tag:'div',id:this.main_notes_wgt.get_container_id(),cls:this.main_notes_wgt.get_css_class_name(),},true);this.link_notes_options_color='#888888';this.link_notes_options=['ALL','open','closed'];this.link_notes_option_spans_map={};this.link_notes_option_selected='NONE';if(this.link)
{var spacer_height=20;dh.append(this.container,{tag:'div',style:"height: "+spacer_height+"px;"});this.link_notes_header_div=dh.append(this.container,{tag:'div',cls:'sg_notes_on_link_header',html:(' Notes on '+
this.get_entity_type_display_name(this.link.type).toLowerCase()+' '+this.link.name+': &nbsp;&nbsp;'),style:'border-top: 1px solid #BABABA; '+'line-height: 20px; '+'vertical-align: bottom;'},true);this.link_notes_span_all=dh.append(this.link_notes_header_div,{tag:'span',cls:'sg_notes_all',html:'All'},true);dh.append(this.link_notes_header_div,{tag:'span',html:' | ',style:'color: '+
this.link_notes_options_color+';'});this.link_notes_span_open=dh.append(this.link_notes_header_div,{tag:'span',cls:'sg_notes_all_open',html:'Open'},true);dh.append(this.link_notes_header_div,{tag:'span',html:' | ',style:'color: '+
this.link_notes_options_color+';'});this.link_notes_span_closed=dh.append(this.link_notes_header_div,{tag:'span',cls:'sg_notes_all_closed',html:'Closed'},true);this.link_notes_option_spans_map['open']=this.link_notes_span_open;this.link_notes_option_spans_map['closed']=this.link_notes_span_closed;this.link_notes_option_spans_map['ALL']=this.link_notes_span_all;this.deselected_choice_style(this.link_notes_span_open);this.deselected_choice_style(this.link_notes_span_closed);this.deselected_choice_style(this.link_notes_span_all);this.link_notes_div=dh.append(this.container,{tag:'div'},true);this.link_notes_wgt=undefined;this.link_notes_div_curr_wgt_class='';}
this.main_notes_wgt.render();this.add_event(this.container,'click',this.on_click);},set_count_on_option:function(option,count)
{var ext_span=this.link_notes_option_spans_map[option];var inner_html=ext_span.dom.innerHTML;var idx=inner_html.indexOf("(");if(idx!=-1)
{ext_span.dom.innerHTML=inner_html.slice(0,idx)+'('+count+')';}
else
ext_span.dom.innerHTML=inner_html+' ('+count+')';},toggle_choice:function(ext_span)
{var choice_inner_html=ext_span.dom.innerHTML;if(choice_inner_html.indexOf('Hide')==0)
{ext_span.dom.innerHTML=choice_inner_html.replace(/Hide /,'');return'Hide';}
else
{ext_span.dom.innerHTML='Hide '+choice_inner_html;return'Show';}},clicked_choice:function(choice)
{if(!this.link_notes_option_spans_map[choice])
return;var choice_ext_span=this.link_notes_option_spans_map[choice];var choice_action=this.toggle_choice(choice_ext_span);if(choice_action=='Show')
{this.selected_choice_style(choice_ext_span);for(var i=0;i<this.link_notes_options.length;i++)
{if(this.link_notes_options[i]!=choice)
{var ext_span=this.link_notes_option_spans_map[this.link_notes_options[i]];ext_span.dom.innerHTML=ext_span.dom.innerHTML.replace(/Hide /,'');this.deselected_choice_style(ext_span);}}
return choice;}
else
{this.deselected_choice_style(choice_ext_span);return'NONE';}},selected_choice_style:function(ext_obj)
{ext_obj.applyStyles('color: '+this.link_notes_options_color+'; text-decoration: underline; cursor: pointer; font-weight: bold;');},deselected_choice_style:function(ext_obj)
{ext_obj.applyStyles('color: '+this.link_notes_options_color+'; text-decoration: underline; cursor: pointer; font-weight: normal;');},get_entity_type_display_name:function(entity_type)
{if(SG.schema.entity_types[entity_type])
return SG.schema.entity_types[entity_type].display_name;return undefined;},rebuild_link_notes_child:function(link_notes_option)
{if(this.link_notes_wgt)
{this.destroy_child(this.link_notes_wgt);this.link_notes_wgt=undefined;}
var option_for_notes_widget=this.clicked_choice(link_notes_option);if(option_for_notes_widget!='NONE')
{var link_child_ctx=this.context.clone();link_child_ctx.set('entity',{id:this.link.id,type:this.link.type,name:this.link.name});link_child_ctx.set('title_options',{skip_add_note:true});if(link_notes_option=='open')
link_child_ctx.set('additional_filter_conditions',[{path:'sg_status_list',relation:'!=',values:['clsd']}]);if(link_notes_option=='closed')
link_child_ctx.set('additional_filter_conditions',[{path:'sg_status_list',relation:'is',values:['clsd']}]);this.link_notes_wgt=this.construct_child('link_notes',link_child_ctx);this.link_notes_wgt.container_id=this.link_notes_div.id;this.link_notes_wgt.render();}},on_click:function(evt)
{var target=Ext.get(evt.getTarget());elem=target.findParent('.sg_notes_all_open',this.container,true);if(elem)
{this.rebuild_link_notes_child('open');return;}
elem=target.findParent('.sg_notes_all_closed',this.container,true);if(elem)
{this.rebuild_link_notes_child('closed');return;}
elem=target.findParent('.sg_notes_all',this.container,true);if(elem)
{this.rebuild_link_notes_child('ALL');return;}},});SG.Widget.SimpleNotes=function(context,widget_spec,id){SG.Widget.SimpleNotes.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.SimpleNotes,SG.Widget.Base,{default_settings:{filters:{logical_operator:'and',conditions:[]},sorts:[{column:'created_at',direction:'desc'}],records_per_page:5},templates:{table:'<table>{rows}</table>',row:'<tr><td class="icon"><div class="icon_Note"></div></td><td>{note}</td></tr>'},init_widget:function()
{this.data_set=this.new_data_set('Note',this.render_widget);},on_first_render:function()
{this.container=this.get_container();this.request_data();},render_widget:function()
{var rows,rec,note,note_html,i;if(!this.data_set.is_loaded())
return;if(this.data_set.count()===0){this.container.update('<i>No Notes</i>');return;}
rows='';for(var i=0;i<this.data_set.count();i++)
{rec=this.data_set.get_record(i);note={type:'Note',id:rec.get_id(),name:rec.get('content')};note_html=SG.Renderers.render_one_detail_link(note);rows+=this.templates.row.apply({note:note_html});}
this.container.update(this.templates.table.apply({rows:rows}));},get_filters:function()
{var filters=sg_deep_copy(this.get('filters'));var single_project=this.single_project_from_context();if(single_project){filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[single_project],active:'true'},filters]};}
this.substitute_filter_tokens(filters);return filters;},request_data:function()
{var spec={type:'Note',filters:this.get_filters(),sorts:this.get('sorts'),columns:['content'],current_page:1,records_per_page:this.get('records_per_page'),result:this.data_set};SG.Repo.query(spec);}});SG.Widget.Thumbnail=function(context,widget_spec,id)
{SG.Widget.Thumbnail.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Thumbnail,SG.Widget.Base,{default_settings:{filters:{logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]},},templates:{main:'{qb}{thumb}',thumb:'<div class="shadow_pad"><div class="cell {cell_classes}" '+'style="{cell_styles}" {cell_attributes}>{cell_content}</div><div>',qb:'<div class="filters"></div>',},init_widget:function()
{this.entity_type=this.get('entity_type');if(!this.entity_type)
{this.entity=this.context.get('entity');this.entity_type=this.entity.type;}
this.data_set=this.new_data_set(this.entity_type,this.on_entity_load);},on_first_render:function()
{this.container=this.get_container();var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects()};if(this.context.get('formatting_rules'))
cell_config.page_formatting_rules=this.context.get('formatting_rules');this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,"contextmenu",this.on_contextmenu);this.fetch_data();},render_widget:function()
{if(!this.data_set.is_loaded())
{this.container.update('');return;}
this.hide_loading_overlay();var cell=this.cell_manager.get_cell('image');var thumb='';if(cell){if(this.design_mode_on_detail_page()){thumb+=this.templates.detail_widgets_edit_header.apply({title:'Thumbnail',widget_id:this.get_widget_id(),entity_type:this.entity_type});}
thumb+=this.templates.thumb.apply(cell.render(this.record));}
var qb=this.render_query_builder();this.container.update(this.templates.main.apply({qb:qb,thumb:thumb}));if(qb!='')
this.construct_and_render_query_builder();},render_query_builder:function(){if(!this.entity&&this.context.get('edit_mode')){return this.templates.qb.apply();}else{return'';}},construct_and_render_query_builder:function(){if(this.qb_component)
this.qb_component.destroy();this.qb_component=new SG.Widget.EntityQuery.QueryBuilder({floating:false,filters:this.get_filters_for_qb(),container:this.container.child('div.filters'),entity_type:this.entity_type,context_projects:this.context_projects(),widget:this,callback:{fn:this.condition_changed,scope:this}});this.qb_component.render();},get_filters_for_qb:function()
{var filters=this.get('filters');this.refresh_token_entities_in_filters(filters);return filters;},condition_changed:function(new_filters){var filters=sg_deep_copy(new_filters);this.set('filters',filters);this.fetch_data();},on_entity_load:function()
{this.record=this.data_set.get_record(0);this.render_widget();},fetch_data:function()
{this.show_loading_overlay();var columns=['image'];if(!this.entity)
{var spec={type:this.entity_type,filters:this.get('filters'),columns:columns,current_page:1,records_per_page:1,result:this.data_set};SG.Repo.query(spec);}
else
{var spec={type:this.entity.type,id:this.entity.id,columns:columns,result:this.data_set};SG.Repo.find(spec);}},on_contextmenu:function(e)
{e.stopEvent();if(!this.context_menu)
{this.context_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){the_menu.items=this.cell_manager.get_context_menu_items(the_menu.target_elem);the_menu.render();},scope:this},});}
this.context_menu.target_elem=Ext.get(e.target);this.context_menu.position={xy:e.getXY()};this.context_menu.show();},destroy_widget:function(){if(this.qb_component)
this.qb_component.destroy();},});SG.Widget.Navigation=function(context,widget_spec,id)
{SG.Widget.Navigation.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Navigation,SG.Widget.Base,{default_settings:{max_crud_shots:SG.globals.preferences["navigation_max_fetched_shots"]||200,max_crud_assets:SG.globals.preferences["navigation_max_fetched_assets"]||200,max_crud_sequences:SG.globals.preferences["navigation_max_fetched_sequences"]||200,},templates:{menu_with_label:'<td class="sg_widget_navigation_label">{label}</td>'+'<td class="sg_widget_navigation_menu"><div '+'class="sg_widget_navigation_fakemenu {menu_id}"><span class="sg_widget_nav_span {span_id}">'+'{span_label}</span>'+'<img class="sg_widget_navigation_arrow" src="/images/widget/double_arrows.png"></div></td>',menu:'<span class="sg_widget_nav_span">{span_label}</span>'+'<img class="sg_widget_navigation_arrow" src="/images/widget/double_arrows.png">',lr_buttons:'<td class="sg_widget_navigation_label lr_summary_label">{label}</td>'+'<td class="sg_widget_navigation_menu"><div class="nav_widget_lr_buttons">'+'<img class="nav_widget_left_button" src="/images/widget/left_arrow.png" '+'class="nav_widget_button_enabled">'+'<img class="nav_widget_right_button" src="/images/widget/right_arrow.png" '+'class="nav_widget_button_enabled"></div></td>',go_button:'<td class="sg_widget_navigation_menu"><div class="nav_widget_go_button">Go</div></td>',},init_widget:function()
{this.max_crud_shots=this.get('max_crud_shots');this.max_crud_assets=this.get('max_crud_assets');this.max_crud_sequences=this.get('max_crud_sequences');this.nav_by_scene=(SG.globals.preferences["navigate_shots_by_scene"]==="yes");},render:function(){if(this.context.get('design_mode'))return;this.container=this.get_container();var entity_type=this.context.get('entity').type;this.entity_ds=this.new_data_set(entity_type,this.on_load_entity);if(entity_type=="Shot"||entity_type=="Sequence"||entity_type=="Scene"||entity_type=="Element")
{this.init_root_navigation(entity_type);this.init_entity_crud_request();return;}
else if(entity_type=="Asset")
{this.init_asset_navigation();this.init_entity_crud_request();return;}},init_root_navigation:function(entity_type)
{var parent_type=this.nav_by_scene?'Scene':'Sequence';this.parent_ds=this.new_data_set(parent_type,this.on_load_parent);this.shot_ds=this.new_data_set('Shot',this.on_load_shots);if(entity_type==='Element')
this.element_ds=this.new_data_set('Shot',this.on_load_elements);var dh=Ext.DomHelper;var h;var outer=dh.append(this.container,{tag:'div',cls:'sg_widget_navigation_outer'},true);h='<table class="sg_widget_navigation"><tr>';h+=this.templates.lr_buttons.apply({label:''});h+='</tr></table>';var right=dh.append(outer,{tag:'div',cls:'sg_widget_navigation_jump',html:h});var root_label_for_menu='Sequence:';if(this.nav_by_scene&&entity_type!='Sequence')
root_label_for_menu='Scene:';h='<table class="sg_widget_navigation"><tr>';h+=this.templates.menu_with_label.apply({label:root_label_for_menu,menu_id:'nav_widget_root_menu',span_label:'--',span_id:'nav_widget_root_menu_span'});h+=this.templates.menu_with_label.apply({label:'Shot:',menu_id:'nav_widget_shot_menu',span_label:'--',span_id:'nav_widget_shot_menu_span'});if(entity_type=="Element")
{h+=this.templates.menu_with_label.apply({label:'Element:',menu_id:'nav_widget_element_menu',span_label:'--',span_id:'nav_widget_element_menu_span'});}
h+=this.templates.go_button.apply();h+='</tr></table>';dh.append(outer,{tag:'div',id:'sg_widget_navigation_menu',html:h});this.root_menu_div=this.container.child('div.nav_widget_root_menu');this.shot_menu_div=this.container.child('div.nav_widget_shot_menu');this.root_menu_span=this.root_menu_div.child('span.nav_widget_root_menu_span');this.shot_menu_span=this.shot_menu_div.child('span.nav_widget_shot_menu_span');if(entity_type=="Element")
{this.element_menu_div=this.container.child('div.nav_widget_element_menu');this.element_menu_span=this.element_menu_div.child('span.nav_widget_element_menu_span');}
var wid=this.get_widget_id();this.root_menu=this.empty_menu('nav_widget_root_menu_id'+wid,this.root_menu_div,this.root_menu_handler);this.shot_menu=this.empty_menu('nav_widget_shot_menu_id'+wid,this.shot_menu_div,this.shot_menu_handler);if(entity_type=="Element")
{this.element_menu=this.empty_menu('nav_widget_element_menu_id'+wid,this.element_menu_div,this.element_menu_handler);}
this.init_lr_buttons();},init_asset_navigation:function()
{this.asset_ds=this.new_data_set('Asset',this.on_load_assets);var dh=Ext.DomHelper;var h;var outer=dh.append(this.container,{tag:'div',cls:'sg_widget_navigation_outer'},true);h='<table class="sg_widget_navigation"><tr>';h+=this.templates.lr_buttons.apply({label:''});h+='</tr></table>';var right=dh.append(outer,{tag:'div',cls:'sg_widget_navigation_jump',html:h});h='<table class="sg_widget_navigation"><tr>';h+=this.templates.menu_with_label.apply({label:'Asset Type:',menu_id:'nav_widget_asset_type_menu',span_label:'--',span_id:'nav_widget_asset_type_menu_span'});h+=this.templates.menu_with_label.apply({label:'Asset:',menu_id:'nav_widget_asset_menu',span_label:'--',span_id:'nav_widget_asset_menu_span'});h+=this.templates.go_button.apply();h+='</tr></table>';dh.append(outer,{tag:'div',id:'sg_widget_navigation_menu',html:h});this.asset_type_menu_div=this.container.child('div.nav_widget_asset_type_menu');this.asset_menu_div=this.container.child('div.nav_widget_asset_menu');this.asset_type_menu_span=this.asset_type_menu_div.child('span.nav_widget_asset_type_menu_span');this.asset_menu_span=this.asset_menu_div.child('span.nav_widget_asset_menu_span');this.init_lr_buttons();var wid=this.get_widget_id();this.asset_type_menu=this.empty_menu('nav_widget_asset_type_menu_id'+wid,this.asset_type_menu_div,this.asset_type_menu_handler);this.asset_menu=this.empty_menu('nav_widget_asset_menu_id'+wid,this.asset_menu_div,this.asset_menu_handler);},init_lr_buttons:function(){this.go_button=this.container.child('div.nav_widget_go_button');this.add_event(this.go_button,'click',this.go);this.left_button=this.container.child('img.nav_widget_left_button');this.add_event(this.left_button,'click',this.go_left);this.right_button=this.container.child('img.nav_widget_right_button');this.add_event(this.right_button,'click',this.go_right);this.summary_label=this.container.child('td.lr_summary_label');this.enable_left_button(false);this.enable_right_button(false);},init_entity_crud_request:function(){var spec;var entity=this.context.get('entity');var projects=this.context_projects();if(entity.type=='Asset')
{spec={type:'Asset',id:entity.id,columns:['code','sg_asset_type'],result:this.entity_ds};this.mark_asset_menu_loading();this.mark_asset_type_menu_loading();}
else if(entity.type=='Shot'||entity.type=='Sequence'||entity.type=='Scene')
{var col_for_req='sg_sequence';if((this.nav_by_scene&&entity.type!='Sequence')||entity.type=='Scene')
col_for_req='sg_scene';spec={type:entity.type,id:entity.id,columns:['code'],result:this.entity_ds};if(entity.type==='Shot'){if(this.nav_by_scene)
spec.columns.push('sg_scene');else
spec.columns.push('sg_sequence');}
this.mark_root_menu_loading();this.mark_shot_menu_loading();}
else if(entity.type=='Element')
{spec={type:'Element',id:entity.id,columns:['code','shots'],result:this.entity_ds};this.mark_root_menu_loading();this.mark_shot_menu_loading();this.mark_element_menu_loading();}
SG.Repo.find(spec);},set_menu_to_loading:function(menu_div,span){var elem=Ext.get(menu_div);elem.removeClass('sg_widget_navigation_fakemenu');elem.addClass('nav_widget_menu_loading');span.update('Loading ...');},set_menu_to_loaded:function(menu_div,span,span_text)
{var elem=Ext.get(menu_div);elem.addClass('sg_widget_navigation_fakemenu');elem.removeClass('nav_widget_menu_loading');span.update(span_text);},mark_asset_menu_loading:function(){this.set_menu_to_loading(this.asset_menu_div,this.asset_menu_span);},mark_asset_type_menu_loading:function(){this.set_menu_to_loading(this.asset_type_menu_div,this.asset_type_menu_span);},mark_root_menu_loading:function(){this.set_menu_to_loading(this.root_menu_div,this.root_menu_span);},mark_shot_menu_loading:function(){this.set_menu_to_loading(this.shot_menu_div,this.shot_menu_span);},mark_element_menu_loading:function(){this.set_menu_to_loading(this.element_menu_div,this.element_menu_span);},mark_asset_menu_loaded:function(span_text){this.set_menu_to_loaded(this.asset_menu_div,this.asset_menu_span,span_text);},mark_asset_type_menu_loaded:function(span_text){this.set_menu_to_loaded(this.asset_type_menu_div,this.asset_type_menu_span,span_text);},mark_root_menu_loaded:function(span_text){this.set_menu_to_loaded(this.root_menu_div,this.root_menu_span,span_text);},mark_shot_menu_loaded:function(span_text){this.set_menu_to_loaded(this.shot_menu_div,this.shot_menu_span,span_text);},mark_element_menu_loaded:function(span_text){this.set_menu_to_loaded(this.element_menu_div,this.element_menu_span,span_text);},enable_left_button:function(toggle)
{if(toggle)
{this.left_button.addClass('nav_widget_button_enabled');this.left_button.set({src:'/images/widget/left_arrow.png'});}
else
{this.left_button.removeClass('nav_widget_button_enabled');this.left_button.set({src:'/images/widget/left_arrow_disabled.png'});}},enable_right_button:function(toggle)
{if(toggle)
{this.right_button.addClass('nav_widget_button_enabled');this.right_button.set({src:'/images/widget/right_arrow.png'});}
else
{this.right_button.removeClass('nav_widget_button_enabled');this.right_button.set({src:'/images/widget/right_arrow_disabled.png'});}},go:function(){var new_url=null;var entity=this.context.get('entity');if(entity.type=='Asset')
{if(this.last_selected_asset!=null)
{var id=this.last_selected_asset.shotgun_id;if(id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/asset/'+id;}
else
return;}}
else if(entity.type=='Shot'||entity.type=='Sequence'||entity.type=='Scene')
{if(this.last_selected_shot!=null)
{var id=this.last_selected_shot.shotgun_id;if(id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/shot/'+id;}
else
{var e_type_for_url='sequence';if((this.nav_by_scene&&entity.type!='Sequence')||entity.type=='Scene')
{e_type_for_url='scene';}
id=this.last_selected_root.shotgun_id;if(id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/'+e_type_for_url+'/'+id;}
else
return;}}}
else if(entity.type=='Element')
{if(this.last_selected_element!=null)
{var id=this.last_selected_element.shotgun_id;if(id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/element/'+id;}
else
{id=this.last_selected_shot.shotgun_id;if(id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/shot/'+id;}
else
{var e_type_for_url='sequence';if(this.nav_by_scene)
e_type_for_url='scene';id=this.last_selected_root.shotgun_id;if(id&&id!=-1)
{var current_url=window.location;new_url=current_url.protocol+'//'+current_url.host+'/detail/'+e_type_for_url+'/'+id;}
else
return;}}}}
if(new_url!=null)
window.location=new_url;},go_left:function(e){var dir=-1;var button=this.left_button;if(e==null)
{dir=1;button=this.right_button;}
if(button.hasClass('nav_widget_button_enabled'))
{var menu;var menuitem;var type;var entity=this.context.get('entity');if(entity.type=='Asset')
{menu=this.asset_menu;menuitem=this.last_selected_asset;type='asset';}
else if(entity.type=='Shot'||entity.type=='Sequence'||entity.type=='Scene')
{menu=this.shot_menu;menuitem=this.last_selected_shot;var i=menu.items.indexOf(menuitem);type='shot';if(i==this.shot_ds.count())
{menu=this.root_menu;menuitem=this.last_selected_root;type='sequence';if(this.nav_by_scene&&entity.type!='Sequence')
type='scene';}}
else
{menu=this.element_menu;menuitem=this.last_selected_element;type='element';}
var new_index=menu.items.indexOf(menuitem)+dir;if(new_index<0||new_index>menu.items.length)
return;var new_item=menu.items[new_index];var id=new_item.shotgun_id;var current_url=window.location;var new_url=current_url.protocol+'//'+current_url.host+'/detail/'+type+'/'+id;window.location=new_url;}},go_right:function(){this.go_left(null);},fetch_shots_for_root:function(root_id)
{this.mark_shot_menu_loading();var crud_cond=[];var entity_type=this.context.get('entity').type;var type_for_req='Sequence';var col_for_req='sg_sequence';if(this.nav_by_scene&&entity_type!='Sequence')
{type_for_req='Scene';col_for_req='sg_scene';}
crud_cond=[{path:col_for_req,relation:'is',values:[{type:type_for_req,id:root_id}]}];if(root_id==-1)
crud_cond=[{path:col_for_req,relation:'is',values:[null]}];if(SG.globals.custom_for=="laika"){crud_cond.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:'Shot',filters:{logical_operator:'and',conditions:crud_cond},columns:['code',col_for_req,'sg_status_list'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_shots,result:this.shot_ds};this.shot_ds.select_this=-1;SG.Repo.query(spec);},fetch_assets_of_asset_type:function(atype)
{this.mark_asset_menu_loading();var projects=this.context_projects();var type=atype;if(atype=='-No Type-')
type='';var filters={logical_operator:'and',conditions:[{path:'sg_asset_type',relation:'is',values:[type]},{path:'project',relation:'in',values:projects}]};if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
var spec={type:'Asset',filters:filters,columns:['code','sg_status_list'],current_page:1,records_per_page:this.max_crud_assets,sorts:[{column:'code',direction:'asc'}],result:this.asset_ds};this.asset_ds.select_this=null;SG.Repo.query(spec);},fetch_elements_for_shot:function(shot_id)
{var col_for_req='sg_sequence';var entity_type=this.context.get('entity').type;if(this.nav_by_scene&&entity_type!='Sequence')
col_for_req='sg_scene';this.mark_element_menu_loading();var spec={type:'Shot',id:shot_id,columns:['elements',col_for_req],result:this.element_ds};this.element_ds.select_this=null;this.element_ds.bootup=false;SG.Repo.find(spec);},on_load_entity:function(ds){var entity=this.context.get('entity');if(ds.count()!=1)
return;var projects=this.context_projects();var r=ds.get_record(0);var filters,spec;if(entity.type=='Asset')
{this.create_asset_type_menu(r.get('sg_asset_type'));filters={logical_operator:'and',conditions:[{path:'sg_asset_type',relation:'is',values:[r.get('sg_asset_type')]},{path:'project',relation:'in',values:projects}]};if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:'Asset',filters:filters,columns:['code','sg_status_list'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_assets,result:this.asset_ds};this.asset_ds.select_this=r.get_id();SG.Repo.query(spec);}
else if(entity.type=='Shot')
{var type_for_req='Sequence';var col_for_req='sg_sequence';if(this.nav_by_scene)
{type_for_req='Scene';col_for_req='sg_scene';}
filters={logical_operator:'and',conditions:[{path:'project',relation:'in',values:projects}]};if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:type_for_req,filters:filters,columns:['code'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_sequences,result:this.parent_ds};var parent_id=null;var parent_name=null;if(r.get(col_for_req)!==null)
{parent_id=r.get(col_for_req).id;parent_name=r.get(col_for_req).name;}
this.parent_ds.select_this=parent_name;SG.Repo.query(spec);filters={logical_operator:'and',conditions:[{path:'project',relation:'in',values:projects}]};var parent_cond={path:col_for_req,relation:'is',values:[{type:type_for_req,id:parent_id}]};if(parent_id===null){parent_cond={path:col_for_req,relation:'is',values:[null]};}
filters.conditions.push(parent_cond);if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:'Shot',filters:filters,columns:['code',col_for_req,'sg_status_list'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_shots,result:this.shot_ds};this.shot_ds.select_this=r.get_id();this.shot_ds.first_load=true;SG.Repo.query(spec);}
else if(entity.type=='Sequence'||entity.type=='Scene')
{var type_for_req='Sequence';var col_for_req='sg_sequence';if(entity.type=='Scene')
{type_for_req='Scene';col_for_req='sg_scene';}
filters={logical_operator:'and',conditions:[{path:'project',relation:'in',values:projects}]};if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:type_for_req,filters:filters,columns:['code'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_sequences,result:this.parent_ds};var parent_id=r.get_id();var parent_name=r.get('code');this.parent_ds.select_this=parent_name;SG.Repo.query(spec);filters={logical_operator:'and',conditions:[{path:col_for_req,relation:'is',values:[{type:type_for_req,id:parent_id}]},{path:'project',relation:'in',values:projects}]};if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:'Shot',filters:filters,columns:['code',col_for_req,'sg_status_list'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_shots,result:this.shot_ds};this.shot_ds.select_this=-1;SG.Repo.query(spec);}
else if(entity.type=='Element')
{var shot_id=null;if(r.get('shots')&&r.get('shots').length>0)
shot_id=r.get('shots')[0].id;var col_for_req='sg_sequence';if(this.nav_by_scene)
col_for_req='sg_scene';this.element_ds.select_this=r.get_id();this.element_ds.bootup=true;if(shot_id!==null){spec={type:'Shot',id:shot_id,columns:['elements',col_for_req],result:this.element_ds};SG.Repo.find(spec);}else{filters={logical_operator:'and',conditions:[{path:'id',relation:'is',values:[null]}],}
if(SG.globals.custom_for=="laika"){filters.conditions.push({"values":["omt"],"path":"sg_status_list","relation":"is_not"});}
spec={type:'Shot',filters:filters,columns:['elements',col_for_req],result:this.element_ds};SG.Repo.query(spec);}}},on_load_assets:function(ds)
{var r;var sel_asset=null;var aname;var item;this.asset_menu.items=[];for(var i=0;i<ds.count();i++)
{r=ds.get_record(i);aname=r.get('code');var status_icon=SG.Renderers.render_one_status_icon(r.get('sg_status_list'));item={html:aname+" - "+status_icon,shotgun_id:r.get_id()};this.asset_menu.items.push(item);if(r.get_id()===ds.select_this)
{item.checked=true;this.last_selected_asset=item;sel_asset=aname;}}
var item={html:'-No Asset-',shotgun_id:-1};if(sel_asset==null)
{item.checked=true;this.last_selected_asset=item;sel_asset='-No Asset-';}
this.asset_menu.items.push(item);this.asset_menu.render();this.mark_asset_menu_loaded(sel_asset);this.update_left_right_buttons();},create_asset_type_menu:function(selected_asset_type)
{var type_field=SG.schema.get_field('Asset','sg_asset_type');var item;var sel_atype=null;var atypes=type_field.values;this.asset_type_menu.items=[];for(var i=0;i<atypes.length;i++)
{item={html:atypes[i]};this.asset_type_menu.items.push(item);if(atypes[i]==selected_asset_type)
{item.checked=true;this.last_selected_asset_type=item;sel_atype=atypes[i];}}
var item={html:'-No Type-'};if(sel_atype==null)
{item.checked=true;this.last_selected_asset_type=item;sel_atype='-No Type-';}
this.asset_type_menu.items.push(item);this.asset_type_menu.render();this.mark_asset_type_menu_loaded(sel_atype);},on_load_parent:function(ds)
{var sel_root=null;var item;this.root_menu.items=[];for(var i=0;i<ds.count();i++)
{var r=ds.get_record(i);var root_name=r.get('code');item={html:root_name,shotgun_id:r.get_id()};this.root_menu.items.push(item);if(root_name==ds.select_this)
{item.checked=true;this.last_selected_root=item;sel_root=root_name;}}
var text_str='-No Sequence-';var entity_type=this.context.get('entity').type;if(this.nav_by_scene&&entity_type!='Sequence')
text_str='-No Scene-';var item={html:text_str,shotgun_id:-1};if(sel_root==null)
{item.checked=true;this.last_selected_root=item;sel_root=text_str;}
this.root_menu.items.push(item);this.root_menu.render();this.mark_root_menu_loaded(sel_root);},on_load_shots:function(ds)
{var i;var r;if(ds.first_load)
{var er;var er_id;if(this.context.get('entity').type=='Shot'){er=this.entity_ds.get_record(0);if(!ds.get_record_by_id(er.get_id())){r=ds.new_record(er.get_id());r.set('code',er.get('code'));}}else{r=this.entity_ds.get_record(0);if(r.get('shots')&&r.get('shots').length>0){er=r.get('shots')[0];if(!ds.get_record_by_id(er.id)){r=ds.new_record(er.id);r.set('code',er.name);}}}
ds.first_load=false;}
var item;var sel_shot=null;this.shot_menu.items=[];for(i=0;i<ds.count();i++)
{r=ds.get_record(i);var status_icon=SG.Renderers.render_one_status_icon(r.get('sg_status_list'));item={html:r.get('code')+" - "+status_icon,shotgun_id:r.get_id()};this.shot_menu.items.push(item);if(r.get_id()==ds.select_this)
{item.checked=true;this.last_selected_shot=item;sel_shot=r.get('code');}}
var item={html:'--',shotgun_id:-1};if(sel_shot==null)
{item.checked=true;this.last_selected_shot=item;sel_shot='--';}
this.shot_menu.items.push(item);this.shot_menu.render();this.mark_shot_menu_loaded(sel_shot);this.update_left_right_buttons();},on_load_elements:function(ds)
{var no_shot_for_elem=false;var item;var sel_elem=null;var ename,eid;this.element_menu.items=[];if(ds.count()!=1)
{var eds=this.entity_ds;ename=eds.get_record(0).get('code');eid=eds.get_record(0).get_id();item={html:ename,checked:true,shotgun_id:eid}
this.element_menu.items.push(item);this.last_selected_element=item;sel_elem=ename;no_shot_for_elem=true;}
else
{var elem_ds=ds.get_record(0).get('elements');for(var i=0;i<elem_ds.length;i++)
{ename=elem_ds[i].name;eid=elem_ds[i].id;item={html:ename,checked:false,shotgun_id:eid}
this.element_menu.items.push(item);if(eid==ds.select_this)
{item.checked=true;this.last_selected_element=item;sel_elem=ename;}}}
var item={html:'--',shotgun_id:-1};if(sel_elem==null)
{sel_elem='--';item.checked=true;this.last_selected_element=item;}
this.element_menu.items.push(item);this.element_menu.render();this.mark_element_menu_loaded(sel_elem);this.update_left_right_buttons();if(ds.bootup)
{if(no_shot_for_elem)
{this.parent_ds.destroy();this.shot_ds.destroy();this.on_load_shots(this.shot_ds);this.on_load_parent(this.parent_ds);return;}
var r=ds.get_record(0);var projects=this.context_projects();var type_for_req='Sequence';var col_for_req='sg_sequence';if(this.nav_by_scene)
{type_for_req='Scene';col_for_req='sg_scene';}
var filters={logical_operator:'and',conditions:[{path:'project',relation:'in',values:projects}]};var spec={type:type_for_req,filters:filters,columns:['code'],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_sequences,result:this.parent_ds}
var root_id=null;var root_name=null;if(r.get(col_for_req)!=null)
{root_id=r.get(col_for_req).id;root_name=r.get(col_for_req).name;}
this.parent_ds.select_this=root_name;SG.Repo.query(spec);var crud_cond=[{path:col_for_req,relation:'is',values:[{type:type_for_req,id:root_id}]},{path:'project',relation:'in',values:projects}];if(root_id==null)
crud_cond=[{path:col_for_req,relation:'is',values:[null]},{path:'project',relation:'in',values:projects}];spec={type:'Shot',filters:{logical_operator:'and',conditions:crud_cond},columns:['code',col_for_req],sorts:[{column:'code',direction:'asc'}],current_page:1,records_per_page:this.max_crud_shots,result:this.shot_ds};this.shot_ds.select_this=r.get_id();this.shot_ds.first_load=true;SG.Repo.query(spec);}},empty_element_menu:function()
{var item={html:'--',checked:true,shotgun_id:-1};this.element_menu.items=[item];this.last_selected_element=item;this.element_menu.render();this.mark_element_menu_loaded('--');this.element_ds.destroy();this.update_left_right_buttons();},root_menu_handler:function(menu,menu_item)
{if(this.last_selected_root!=null)
this.last_selected_root.checked=false;this.last_selected_root=menu_item;menu_item.checked=true;menu.render();this.root_menu_span.update(menu_item.html);this.fetch_shots_for_root(menu_item.shotgun_id);if(this.context.get('entity').type=='Element')
this.empty_element_menu();},asset_type_menu_handler:function(menu,menu_item)
{if(this.last_selected_asset_type!=null)
this.last_selected_asset_type.checked=false;this.last_selected_asset_type=menu_item;this.last_selected_asset_type.checked=true;menu.render();this.asset_type_menu_span.update(menu_item.html);this.fetch_assets_of_asset_type(menu_item.html);},asset_menu_handler:function(menu,menu_item)
{if(this.last_selected_asset!=null)
this.last_selected_asset.checked=false;this.last_selected_asset=menu_item;this.last_selected_asset.checked=true;menu.render();this.asset_menu_span.update(menu_item.html);this.update_left_right_buttons();},shot_menu_handler:function(menu,menu_item)
{if(this.last_selected_shot!=null)
this.last_selected_shot.checked=false;this.last_selected_shot=menu_item;this.last_selected_shot.checked=true;menu.render();this.shot_menu_span.update(menu_item.html);if(this.context.get('entity').type=='Element')
this.fetch_elements_for_shot(menu_item.shotgun_id);else if(this.context.get('entity').type!='Element')
this.update_left_right_buttons();},element_menu_handler:function(menu,menu_item)
{if(this.last_selected_element!=null)
this.last_selected_element.checked=false;this.last_selected_element=menu_item;this.last_selected_element.checked=true;menu.render();this.element_menu_span.update(menu_item.html);this.update_left_right_buttons();},update_left_right_buttons:function()
{var entity=this.context.get('entity');var i;var total;var type_label;if(entity.type=='Asset')
{var asset_menu_item=this.last_selected_asset;var asset_type_menu_item=this.last_selected_asset_type;total=this.asset_ds.count();i=this.asset_menu.items.indexOf(asset_menu_item)+1;type_label=asset_type_menu_item.html;if(type_label=='-No Type-')
type_label='';if(asset_menu_item.shotgun_id!=this.context.get('entity').id)
this.container.addClass("nav_widget_nav_away");else
this.container.removeClass("nav_widget_nav_away");}
if(entity.type=='Sequence'||entity.type=='Scene'||entity.type=='Shot')
{var menu_item=this.last_selected_shot;total=this.shot_ds.count();i=this.shot_menu.items.indexOf(menu_item)+1;type_label='Shot';if(i>total)
{menu_item=this.last_selected_root;total=this.parent_ds.count();i=this.root_menu.items.indexOf(menu_item)+1;type_label='Sequence';if(this.nav_by_scene&&entity.type!='Sequence')
type_label='Scene';if(menu_item.shotgun_id!=this.context.get('entity').id)
this.container.addClass("nav_widget_nav_away");else
this.container.removeClass("nav_widget_nav_away");}
else
{if(this.last_selected_shot.shotgun_id!=this.context.get('entity').id)
this.container.addClass("nav_widget_nav_away");else
this.container.removeClass("nav_widget_nav_away");}}
else if(entity.type=='Element')
{var ds=this.element_ds;total=0;if(ds.count()==1&&ds.get_record(0).get('elements'))
{var elem_ds=ds.get_record(0).get('elements');total=elem_ds.length;}
var menu_item=this.last_selected_element;i=this.element_menu.items.indexOf(menu_item)+1;type_label='Element';if(this.last_selected_element.shotgun_id!=this.context.get('entity').id)
this.container.addClass("nav_widget_nav_away");else
this.container.removeClass("nav_widget_nav_away");}
if(total==0)
{this.summary_label.update('');this.enable_left_button(false);this.enable_right_button(false);}
else
{var summary;if(total==1)
{summary='1 '+type_label;this.enable_left_button(false);this.enable_right_button(false);}
else
{var s='s';if(type_label=='')
s='';summary=i+' of '+total+' '+type_label+s;if(i==1)
{this.enable_left_button(false);this.enable_right_button(true);}
else if(i==total)
{this.enable_left_button(true);this.enable_right_button(false);}
else
{this.enable_left_button(true);this.enable_right_button(true);}
this.summary_label.update(summary);}}},empty_menu:function(menu_id,dom_elem,handler_method)
{var menu=SG.Menu.get_menu(menu_id);if(!menu)
{menu=this.new_component(SG.Menu,{id:menu_id,position:{dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'},item_selected:{fn:handler_method,scope:this}});Ext.get(dom_elem).on('click',menu.show,menu);Ext.get(dom_elem).on('contextmenu',function(e){e.stopEvent();menu.show();},menu);}
menu.items=[{html:'--'}];menu.render();return menu;},destroy_widget:function()
{var entity_type=this.context.get('entity').type;}});SG.Widget.SimpleNavigation=function(context,widget_spec,id){SG.Widget.SimpleNavigation.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.SimpleNavigation,SG.Widget.Base,{default_settings:{filters:{logical_operator:'and',conditions:[]},sorts:[{column:'id',direction:'asc'}]},templates:{body:'<span>{num} of {count} {display_names}</span>'+'<div class="navbutton {left_cls}" {left_attrs}></div>'+'<div class="navbutton {right_cls}" {right_attrs}></div>'},init_widget:function()
{this.entity=this.context.get('entity');this.entity_type_display_name=SG.schema.entity_types[this.entity.type].display_name_pluralized;this.identifier=SG.schema.get_identifier_field(this.entity.type);this.data_set=this.new_data_set(this.entity.type,this.render_widget);},on_first_render:function()
{this.container=this.get_container();this.request_data();},render_widget:function()
{var html='';if(!this.data_set.is_loaded())
return;var ids=this.data_set.get_ids();var idx=ids.indexOf(this.entity.id);var left_rec=this.data_set.get_record(idx-1);var left_cls,left_attrs;if(left_rec){left_cls='left_arrow active sg_detail_link';left_attrs='sg_entity_type="'+left_rec.get_type()+'" '+'sg_entity_id="'+left_rec.get_id()+'" '+'sg_entity_name="'+left_rec.get(this.identifier)+'"';}else{left_cls='left_arrow_disabled';left_attrs='';}
var right_rec=this.data_set.get_record(idx+1);var right_cls,right_attrs;if(right_rec){right_cls='right_arrow active sg_detail_link';right_attrs='sg_entity_type="'+right_rec.get_type()+'" '+'sg_entity_id="'+right_rec.get_id()+'" '+'sg_entity_name="'+right_rec.get(this.identifier)+'"';}else{right_cls='right_arrow_disabled';right_attrs='';}
html=this.templates.body.apply({num:idx+1,count:this.data_set.count(),display_names:this.entity_type_display_name,left_cls:left_cls,left_attrs:left_attrs,right_cls:right_cls,right_attrs:right_attrs});this.container.update(html);},get_filters:function()
{var filters=this.get('filters');var has_projects=SG.schema.entity_types[this.entity.type].has_projects;var single_project=this.single_project_from_context();if(has_projects&&single_project){filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[single_project],active:'true'},filters]};}
return filters;},request_data:function()
{var spec={type:this.entity.type,filters:this.get_filters(),sorts:this.get('sorts'),columns:[],current_page:1,records_per_page:5000,result:this.data_set};SG.Repo.query(spec);}});SG.Widget.TextFields=function(context,widget_spec,id)
{SG.Widget.TextFields.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.TextFields,SG.Widget.Base,{default_settings:{columns:[]},templates:{text_fields_widget:'{edit_header}<div class="sg_widget_text_fields_contents">'+'{text_fields_content}</div>',text_fields_widget_content_intab:'<div class="sg_widget_text_fields_body_intab">'+'{text_fields_rows}</div>',text_fields_widget_content_not_intab:'<div class="sg_widget_text_fields_body">'+'{text_fields_rows}</div>',text_field_row_empty:'<div style="sg_widget_text_fields_row">&nbsp;</div>',text_field_row:'<div class="sg_widget_text_fields_row" field_name="{field_name}">'+'<div class="{edit_trigger_class}">'+'{field_name_html}{field_value_html}{field_update_info}</div></div>',text_field_name:'<div class="sg_widget_text_fields_field_name">'+'<nobr>{display_name}<span class="sg_widget_text_fields_edit_link"> '+'<a name="edit">Edit</a></span></nobr></div>',text_field_value:'<div class="sg_widget_text_fields_field_value" status="{status}" field="{field}">{text_field_value}</div>',text_field_update_info:'<span class="sg_widget_text_fields_update_info">Updated {date} by {user}<span>',text_field_edit_row:'<div class="sg_widget_text_fields_row" field_name="{field_name}">'+'{field_name_html}{field_value_html}</div></div>',text_field_edit_name:'<div class="sg_widget_text_fields_field_name">{display_name}</div>',text_field_edit_value:'<div class="sg_widget_text_fields_field_value">'+'<textarea class="sg_widget_text_fields_edit_value" cols="80" rows="5" field="{field}">'+'{text_field_value}</textarea><input name="save" type="button" value="Save" /> '+'<span class="sg_widget_text_fields_cancel_link">'+'<a name="cancel">Cancel</a></span></div>',},init_widget:function()
{this.mode=[];this.textarea_listeners={};this.context_entity=this.context.get('entity');this.settings_editable=true;this.update_info={};},destroy_widget:function()
{SG.Page.unsaved_data.remove(this);},has_unsaved_data:function()
{var unsaved=false;var fields=this.get_columns(true);for(i=0;i<fields.length;i++)
{var field_name=fields[i];var textarea=sg_find('textarea.sg_widget_text_fields_edit_value[field="'+field_name+'"]',this.get_container().dom);if(textarea&&textarea.value.strip()!==this.record.get(field_name))
unsaved=true;}
return unsaved;},on_first_render:function(){this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.entity_set=this.new_data_set(this.context_entity.type,this.on_entity_load,this.on_entity_change);this.history_set=this.new_data_set('EventLogEntry',this.on_history_load);this.link_parser=new SG.TicketAndRevisionLinkParser(this.container);this.read_data();},get_columns:function(include_spacer)
{var col_hash=this.get('columns');var spacer_re=/sg_widget_fields_space/;var add_field=true;var cols=[];var schema_field;for(var i=0;i<col_hash.length;i++)
{if(col_hash[i]['field']!=undefined){schema_field=SG.schema.get_field(this.context_entity.type,col_hash[i]['field']);if(!schema_field)continue;if(!include_spacer){add_field=(spacer_re.exec(col_hash[i]['field'])==null);}
if(add_field)
{cols.push(col_hash[i]['field']);}}}
return cols;},label_visible:function(col)
{var col_hash=this.get('columns');for(var i=0;i<col_hash.length;i++)
{if(col_hash[i].field==col)
return col_hash[i].show_label;}
return true;},history_visible:function(col)
{var col_hash=this.get('columns');for(var i=0;i<col_hash.length;i++){if(col_hash[i].field==col)
return col_hash[i].show_history;}
return true;},read_data:function(){this.show_loading_overlay();var entity_cols=this.get_columns();if(SG.globals.custom_for=="d2"||SG.globals.custom_for=="dneg")
{}
else
{var history_filters={logical_operator:'and',conditions:[{active:"true",path:"entity",relation:"is",values:[{type:this.context_entity.type,id:this.context_entity.id}]},{logical_operator:'or',conditions:[]}]}
for(var i=0;i<entity_cols.length;i++){history_filters.conditions[1].conditions.push({path:"attribute_name",relation:"is",values:[entity_cols[i]]});}
var history_spec={type:'EventLogEntry',columns:['description','created_at','attribute_name'],filters:history_filters,sorts:[{column:'created_at',direction:'desc'}],result:this.history_set}
SG.Repo.query(history_spec);}
var entity_spec={type:this.context_entity.type,id:this.context_entity.id,columns:entity_cols,result:this.entity_set};SG.Repo.find(entity_spec);},on_entity_load:function(){this.record=this.entity_set.get_record(0);this.render_widget();},on_entity_change:function(changes){var cols=this.get_columns();var change;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type!=="update")continue;if(cols.indexOf(change.column)!==-1)this.update_cell(change.column);}},is_editable:function(col){var schema_field=SG.schema.get_field(this.context_entity.type,col);return SG.schema.can_edit_field_on_record(this.record,schema_field,undefined,col);},update_cell:function(col)
{this.update_info[col]={date:new Date(),user:SG.globals.current_user.display_name};this.render_row_update(col);},save_field:function(column,value)
{this.mode[column]='display';this.record.set(column,value);this.record.commit();},on_columns_set:function(columns)
{var need_server_call=false;var col_diff=this.check_column_differences(columns);if(col_diff.added.length>0)
need_server_call=true;this.set({'columns':columns});if(need_server_call){this.render_loading();this.read_data();}else{this.render_widget();}},check_column_differences:function(columns)
{var new_cols=[]
var spacer_re=/sg_widget_fields_space/;var old_cols=this.get_columns();var diff={added:[],removed:[]};var exists;for(var i=0;i<columns.length;i++)
{if(spacer_re.exec(columns[i].field)==null){exists=old_cols.indexOf(columns[i].field);if(exists==-1)
{diff.added.push(columns[i].field);}
new_cols.push(columns[i].field);}}
for(var i=0;i<old_cols.length;i++)
{exists=new_cols.indexOf(old_cols[i])
if(exists==-1)
diff.removed.push(old_cols[i]);}
return diff;},render_loading:function(){this.container.update("<i>Loading text fields data...</i>");},on_click:function(e){var target=Ext.get(e.getTarget());var field=target.findParent('.sg_widget_text_fields_row',this.container,true);if(field)
var field_name=field.dom.getAttribute('field_name');switch(target.dom.name){case'edit':SG.Page.unsaved_data.add(this);this.mode[field_name]='edit';this.render_row_update(field_name);return;case'cancel':this.mode[field_name]='display';this.render_row_update(field_name);return;case'save':var new_value=field.child(".sg_widget_text_fields_edit_value").dom.value;this.save_field(field_name,new_value);return;default:}},on_history_load:function()
{var disp_columns=this.get_columns();if(disp_columns.length<1){return;}
var hs=this.history_set;var c,rec,column,created_at,description;var bits,user,dt;for(c=0;c<hs.count();c++){rec=hs.get_record(c);column=rec.get('attribute_name');created_at=rec.get('created_at');description=rec.get('description');if(disp_columns.indexOf(column)>-1){user='';if(description)
{bits=description.split(' ');if(bits[1]&&bits[1].match(/^[A-Z]/))
user=bits[0]+' '+bits[1];else
user=bits[0];}
dt=new Date(Date.parse(created_at));if(!this.update_info.hasOwnProperty(column)||dt.valueOf()>this.update_info[column].date.valueOf())
{this.update_info[column]={'date':dt,'user':user};}}}},render_name:function(fieldname)
{var display_name=SG.schema.get_field(this.context_entity.type,fieldname).display_name;if(!this.label_visible(fieldname))
display_name='';var template_mode='text_field_name';if(this.mode[fieldname]=='edit')
template_mode='text_field_edit_name';var html=this.templates[template_mode].apply({display_name:display_name});return html;},render_value:function(col)
{var status=this.record.get_status(col);var template_mode='text_field_value';var val=this.record.get(col);if(val==null)
val="";if(this.mode[col]=='edit'){template_mode='text_field_edit_value';}
else
{val=SG.Markup.parse(val);val=this.link_parser.parse_content(val);}
var template=this.templates[template_mode];var value_parms={text_field_value:val,status:status,field:col};return template.apply(value_parms);},render_update_info:function(col)
{if(!this.update_info[col]||this.history_visible(col)===false)
return;var date=SG.GridEditor.DateTimeParser.friendly(this.update_info[col].date);return this.templates.text_field_update_info.apply({date:date,user:this.update_info[col].user});},render_row_update:function(col){this.link_parser.begin_parse();var dq=Ext.DomQuery;var col_editable=this.is_editable(col);var edit_trigger_class="";var div=dq.selectNode('div[field_name='+col+']',this.container.dom);var name_html=this.render_name(col);var value_html=this.render_value(col);var update_html=this.render_update_info(col);if(col_editable)
edit_trigger_class="sg_widget_text_fields_edit_trigger";var row_html=this.templates.text_field_row.apply({field_name:col,edit_trigger_class:edit_trigger_class,field_name_html:name_html,field_value_html:value_html,field_update_info:update_html});if(this.mode[col]!='edit')
this.remove_textarea_listener(col);Ext.fly(div).update(row_html);if(this.mode[col]=='edit')
this.add_textarea_listener(col);this.link_parser.end_parse();},remove_textarea_listener:function(col)
{var textarea=this.textarea_listeners[col];if(textarea)
{textarea.un('scroll',this.on_textarea_scroll,this);}},add_textarea_listener:function(col)
{var textarea=this.container.child('textarea[field="'+col+'"]');this.textarea_listeners[col]=textarea;textarea.on('scroll',this.on_textarea_scroll,this);if(textarea.dom.scrollHeight>textarea.getHeight())
textarea.setHeight(textarea.dom.scrollHeight+11);},on_textarea_scroll:function(e)
{var textarea=Ext.get(e.getTarget());textarea.setHeight(textarea.dom.scrollHeight+11);},render_widget:function()
{this.link_parser.begin_parse();var spacer_re=/sg_widget_fields_space/;var html="";if(!this.entity_set.is_loaded())
{this.fireEvent("widget_resize",this);return;}
var fields=this.get_columns(true);var field_count=0;for(i=0;i<fields.length;i++)
{var fieldname=fields[i];if(!this.mode[fieldname])
this.mode[fieldname]='display';if(spacer_re.exec(fieldname)==null)
{var name_html=this.render_name(fieldname);var value_html=this.render_value(fieldname);var col_editable=this.is_editable(fieldname);var edit_trigger_class="";if(this.mode[fieldname]=='edit'){html+=this.templates.text_field_edit_row.apply({field_name:fieldname,field_name_html:name_html,field_value_html:value_html});}else{var update_html=this.render_update_info(fieldname);if(col_editable)
edit_trigger_class="sg_widget_text_fields_edit_trigger";html+=this.templates.text_field_row.apply({field_name:fieldname,edit_trigger_class:edit_trigger_class,field_name_html:name_html,field_value_html:value_html,field_update_info:update_html});}
field_count+=1;}
else
{html+=this.templates.text_field_row_empty.apply();}}
if(field_count==0)
{html='<div class="sg_widget_text_fields_none_configured">There are no fields configured '+'for this widget. Right mouse click to add some.</div>';}
var content;if(this.get('in_tabs')==true){content=this.templates.text_fields_widget_content_intab.apply({text_fields_rows:html});}else{content=this.templates.text_fields_widget_content_not_intab.apply({text_fields_rows:html});}
var edit_header='';if(this.design_mode_on_detail_page()){edit_header=this.templates.detail_widgets_edit_header.apply({title:'Text Fields',widget_id:this.get_widget_id(),entity_type:this.context_entity.type,});}
var full_content=this.templates.text_fields_widget.apply({edit_header:edit_header,text_fields_content:content});this.hide_loading_overlay();this.container.update(full_content);this.fireEvent("widget_resize",this);this.link_parser.end_parse();},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'show_history',data_type:'boolean',display_name:'Display who updated and when',default_value:true}],});SG.Widget.DetailPageBody=function(context,widget_spec,id)
{this.events={'widget_resize':true};SG.Widget.DetailPageBody.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.DetailPageBody,SG.Widget.Base,{default_settings:{top_height:0.3},init_children:function(){this.entity=this.context.get('entity');var nav_context=this.context.clone();this.nav_widget=this.construct_child('navigation',nav_context);var card_context=this.context.clone();this.card_widget=this.construct_child('entity_card',card_context);var textfields_context=this.context.clone();this.textfields_widget=this.construct_child('textfields',textfields_context);var tabs_context=this.context.clone();this.tabs_widget=this.construct_child('tabs',tabs_context);},render:function()
{this.container=this.get_container();var dh=Ext.DomHelper;this.top_div=dh.append(this.container,{tag:'div',cls:'top sg_scroll_container'},true);var nav_div_id=this.nav_widget.get_container_id();var nav_cls=this.nav_widget.get_css_class_name();dh.append(this.top_div,{tag:'div',id:nav_div_id,cls:nav_cls},true);var card_div_id=this.card_widget.get_container_id();var card_cls=this.card_widget.get_css_class_name();dh.append(this.top_div,{tag:'div',id:card_div_id,cls:card_cls});var textfields_div_id=this.textfields_widget.get_container_id();var textfields_cls=this.textfields_widget.get_css_class_name();dh.append(this.top_div,{tag:'div',id:textfields_div_id,cls:textfields_cls});var tabs_div_id=this.tabs_widget.get_container_id();var tabs_cls=this.tabs_widget.get_css_class_name();this.tabs_div=dh.append(this.container,{tag:'div',id:tabs_div_id,cls:tabs_cls},true);var h=this.calculate_top_bottom_split();this.top_div.setHeight(h.top);this.tabs_div.setHeight(h.bottom);var id='sg_height_'+this.get_widget_id()+'_drag';this.height_drag_div=dh.append(this.container,{tag:'div',cls:'height_drag',id:id},true);this.height_drag_div.setTop(h.drag);this.height_drag_zone=new SG.HeightDragZone(this.height_drag_div,this,this.recalculate_tabs_height);this.nav_widget.render();this.add_event(this.card_widget,"widget_resize",this.set_textfields_min_height);this.card_widget.render();this.textfields_widget.render();this.tabs_widget.render();if(this.entity.type=="Attachment"&&this.get_page().context.get('email_link')){this.read_file();}
Ext.EventManager.onWindowResize(this.fire_resize,this);},recalculate_tabs_height:function()
{var h=this.height_drag_div.getTop(true);var per=h/this.container.getHeight();if(per<.15)
per=.15;if(per>.80)
per=.80;this.set('top_height',per);var new_h=this.calculate_top_bottom_split();this.top_div.setHeight(new_h.top);this.tabs_div.setHeight(new_h.bottom);this.height_drag_div.setTop(new_h.drag);this.set_textfields_min_height();},calculate_top_bottom_split:function()
{var full_height=this.container.getHeight();var top_height=Math.round(this.get('top_height')*full_height);var bot_height=full_height-top_height-7;return{top:top_height,bottom:bot_height,drag:top_height};},fire_resize:function()
{var new_h=this.calculate_top_bottom_split();this.top_div.setHeight(new_h.top);this.tabs_div.setHeight(new_h.bottom);this.height_drag_div.setTop(new_h.drag);this.set_textfields_min_height();this.fireEvent('widget_resize',this);},set_textfields_min_height:function()
{if(!this.textfields_widget)
return;var min_h=Math.max(40,(this.top_div.getHeight()-this.card_widget.container.getHeight()-5));this.textfields_widget.get_container().setHeight(min_h);},destroy_widget:function()
{Ext.EventManager.removeResizeListener(this.fire_resize,this);},read_file:function()
{this.file_ds=this.new_data_set('Attachment',this.on_file_load);var spec={type:"Attachment",id:this.entity.id,columns:["this_file"],result:this.file_ds};SG.Repo.find(spec);},on_file_load:function()
{var rec=this.file_ds.get_record(0);var att=rec.get('this_file');if(att.attachment_type!="local_storage")return;var ren=SG.Renderers.local_storage.local_path(att);sg_open_localfile(ren);}});SG.Widget.Tabs=function(context,widget_spec,id){this.events={'widget_resize':true};SG.Widget.Tabs.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Tabs,SG.Widget.Base,{default_settings:{tab_order:[],selected_tab_idx:0},templates:{tab_cell:'<td class="tab_cell {extra_class} {selected_class}" tab_idx="{tab_idx}">{tab_name}</td>',tab_name_design_mode:'<div class="tab_name">{tab_name}</div>'+'<div class="menu_target"><div class="dropdown_arrow_small"></div>&nbsp;</div>',tab_edge:'<td class="tab_edge">&nbsp;</td>',tabs:'<table class="tab_strip"><colgroup span="{num_tabs}" width="0*"/>'+'<colgroup span="1" width="100%"/><tr>{cells}</tr></table>'},init_children:function(){this.add_event(this,'settings_changed',this.on_settings_changed);},init_widget:function(){this.contents_id="sg_widget_tabs_"+this.get_widget_id()+"_contents";this.cur_tab_idx=this.get('selected_tab_idx');var max_idx=this.get_child_names().length-1;if(typeof(this.cur_tab_idx)==undefined||this.cur_tab_idx==null||Number(this.cur_tab_idx)>max_idx){this.set('selected_tab_idx',"0");this.cur_tab_idx=0;}
this.tab_context=this.context.clone();},on_settings_changed:function(change_hash,source_widget)
{if((source_widget!=this)&&('selected_tab_idx'in change_hash))
{this.select_tab(this.get('selected_tab_idx'));}
if('tab_order'in change_hash)
{if(this.have_rendered)
{this.tabs_div.update('');this.render_tabs();this.update_scroll_buttons();if(source_widget==this)
this.select_tab(this.cur_tab_idx);}}},show_tab_menu:function(menu_target){var parent_td=menu_target.findParent('td.tab_cell',this.container);this.contextmenu_tab_index=Number(parent_td.getAttribute('tab_idx'));if(!this.tab_menu){this.tab_menu=this.new_component(SG.Menu,{icon_width:11,item_selected:{fn:this.tabs_context_menu_handler,scope:this},before_show:{fn:this.on_before_show_context_menu,scope:this},});}
this.tab_menu.items=[];this.tab_menu.render();this.tab_menu.position={dom_elem:menu_target,elem_anchor:'bl',menu_anchor:'tl'};this.tab_menu.show();},on_before_show_context_menu:function(menu)
{var items=[{icon_name:'move_left',html:'Move Tab Left',value:'move_tab_left',disabled:menu.tab_elem===null?true:(this.contextmenu_tab_index==0)},{icon_name:'move_right',html:'Move Tab Right',value:'move_tab_right',disabled:menu.tab_elem===null?true:(this.contextmenu_tab_index==(this.get('tab_order').length-1))},{line:true},{html:'Duplicate Tab',value:'duplicate_tab',disabled:menu.tab_elem===null},{html:'Rename Tab...',value:'rename_tab',disabled:menu.tab_elem===null},{html:'Insert New Tab...',value:'new_tab'},];if(this.in_card_widget)
{items.push({line:true});items.push({html:'Flip all cards to this tab',value:'flip_all_cards'});}
var tab_widget_type=null;if(this.tab_widget)
tab_widget_type=this.tab_widget.get('type');if(SG.globals.current_user.admin&&tab_widget_type=='SG.Widget.EntityQuery.EntityQueryPage')
{items.push({line:true});items.push({html:'Revert Tab To Global Default',item_selected:{fn:this.revert_tab_to_global_default,scope:this},disabled:menu.tab_elem===null||this.contextmenu_tab_index!=this.cur_tab_idx,icon_name:'icon_revert'});}
items.push({line:true});items.push({icon_name:'trash',html:'Delete Tab',value:'remove_tab',disabled:menu.tab_elem===null});menu.items=items;menu.render();},tabs_context_menu_handler:function(menu,item)
{var action=item.value;if(action=="flip_all_cards")
this.flip_all_card_tabs(this.contextmenu_tab_index);else if(action=="duplicate_tab")
this.duplicate_tab(this.contextmenu_tab_index);else if(action=="rename_tab")
this.rename_tab(this.contextmenu_tab_index);else if(action=="remove_tab")
this.remove_tab(this.contextmenu_tab_index);else if(action=="new_tab")
this.new_tab(this.contextmenu_tab_index);else if(action=="move_tab_left")
this.move_tab_left(this.contextmenu_tab_index);else if(action=="move_tab_right")
this.move_tab_right(this.contextmenu_tab_index);},duplicate_tab:function(tab_index)
{var new_child_name=this.generate_new_child_name('tab');var tab_order=this.get('tab_order');var sel_tab=tab_order[tab_index];this.widget_spec.clone_child_spec(sel_tab.name,new_child_name,this);var right_index=parseInt(tab_index)+1;var front=tab_order.slice(0,right_index);var back=tab_order.slice(right_index,tab_order.length);var new_tab_order=front.concat({name:new_child_name,display_name:sel_tab.display_name+' Copy'},back);this.cur_tab_idx=right_index;var tw=this;setTimeout(function(){tw.set({tab_order:new_tab_order});},100);},rename_tab:function(tab_index)
{var tab_order=this.get('tab_order');var tw=this;var rename_fn=function(new_name){tab_order[tab_index].display_name=new_name;this.cur_tab_idx=tab_index;setTimeout(function(){tw.set({tab_order:tab_order});},100);};var cfg={old_tab_name:tab_order[tab_index].display_name,callback:{fn:rename_fn,scope:this}};var rtd=new SG.RenameTabDialog(cfg);},remove_tab:function(tab_index)
{var tab_order=this.get('tab_order');var confirm_msg='Delete the tab: '+tab_order[tab_index].display_name+' ?';var confirm_dlg=new SG.ConfirmDialog({html_msg:confirm_msg});this.add_event(confirm_dlg,'dialog_submitted',function(){var next_index=parseInt(tab_index)+1;this.widget_spec.delete_child_spec(tab_order[tab_index].name,this);var new_tab_order;if(tab_index==0)
new_tab_order=tab_order.slice(1,tab_order.length);else if(tab_index==(tab_order.length-1))
new_tab_order=tab_order.slice(0,tab_order.length-1);else
{var front=tab_order.slice(0,tab_index);var back=tab_order.slice(next_index,tab_order.length);new_tab_order=front.concat(back);}
if(tab_index==this.cur_tab_idx||this.cur_tab_idx==new_tab_order.length)
this.cur_tab_idx=0;var tw=this;setTimeout(function(){tw.set({tab_order:new_tab_order});},100);});},new_tab:function(tab_index)
{var et=this.context.get('entity_type');if(!et)
et=this.context.get('entity').type;var ntd=new SG.NewTabDialog({entity_type:et});this.add_event(ntd,'dialog_submitted',this.create_new_tab);},create_new_tab:function(config)
{var entity_type=this.context.get('entity_type');if(!entity_type)
entity_type=this.context.get('entity').type;var params={widget_type:config.widget_type,entity_type:entity_type,embedded_entity_type:config.embedded_entity_type,inside_card:this.in_card_widget};if(this.get_page().project_id)
params.project_id=this.get_page().project_id;if(this.get_page().canvas_designer&&this.get_page().canvas_designer.page&&this.get_page().canvas_designer.page.project_id)
{params.project_id=this.get_page().canvas_designer.page.project_id;}
var options={url:SG.globals.urls.tab_widget_spec,params:params,callback:function(options,success,response){if(success)
{var spec={};var str='spec = '+response.responseText+';';eval(str);var child_name=this.generate_new_child_name('tab');this.widget_spec.create_child_spec(child_name,spec,this);var tab_order=this.get('tab_order');var front=tab_order.slice(0,this.contextmenu_tab_index);var back=tab_order.slice(this.contextmenu_tab_index,tab_order.length);var new_tab_order=front.concat({name:child_name,display_name:config.tab_name},back);this.cur_tab_idx=this.contextmenu_tab_index;var tw=this;setTimeout(function(){tw.set({tab_order:new_tab_order});},100);}},scope:this};if(config.widget_variation)
options.params.widget_variation=config.widget_variation;var conn=new Ext.data.Connection();conn.request(options);},revert_tab_to_global_default:function()
{var entity_type=this.context.get('entity_type');if(!entity_type)
entity_type=this.context.get('entity').type;var params={widget_type:"SG.Widget.EntityQuery.EntityQueryPage",entity_type:entity_type,embedded_entity_type:this.tab_widget.get('entity_type'),inside_card:this.in_card_widget};if(this.get_page().project_id)
params.project_id=this.get_page().project_id;if(this.get_page().canvas_designer&&this.get_page().canvas_designer.page&&this.get_page().canvas_designer.page.project_id)
{params.project_id=this.get_page().canvas_designer.page.project_id;}
var options={url:SG.globals.urls.tab_widget_spec,params:params,callback:function(options,success,response){if(success)
{var spec={};var str='spec = '+response.responseText+';';eval(str);var tab_widget_name=this.tab_widget.__name_in_parent__;this.widget_spec.replace_child_spec(tab_widget_name,spec,this);this.destroy_child(this.tab_widget);this.tab_widget=this.construct_child(tab_widget_name,this.tab_context);this.tab_widget.container_id=this.contents_id;this.tab_widget.render();}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},move_tab_left:function(tab_index)
{var left_index=parseInt(tab_index)-1;var right_index=parseInt(tab_index)+1;var tabs=this.get('tab_order');var front=tabs.slice(0,left_index);var back=tabs.slice(right_index,tabs.length);var new_tab_order=front.concat(tabs[tab_index],tabs[left_index],back);if(this.cur_tab_idx==tab_index)
this.cur_tab_idx=left_index;else if(this.cur_tab_idx==left_index)
this.cur_tab_idx=tab_index;var tw=this;setTimeout(function(){tw.set({tab_order:new_tab_order});},100);},move_tab_right:function(tab_index)
{var right_index=parseInt(tab_index)+1;var right2_index=parseInt(tab_index)+2;var tabs=this.get('tab_order');var front=tabs.slice(0,tab_index);var back=tabs.slice(right2_index,tabs.length);var new_tab_order=front.concat(tabs[right_index],tabs[tab_index],back);var tw=this;if(this.cur_tab_idx==tab_index)
this.cur_tab_idx=right_index;else if(this.cur_tab_idx==right_index)
this.cur_tab_idx=tab_index;setTimeout(function(){tw.set({tab_order:new_tab_order});},100);},flip_all_card_tabs:function(tab_index)
{this.select_tab(tab_index);var tw=this;setTimeout(function(){tw.set({selected_tab_idx:tab_index});},0);},select_tab_css:function(new_idx,new_tab)
{var cur_sel='td.tab_cell[tab_idx='+this.cur_tab_idx+']';var cur_tab=this.tabs_div.child(cur_sel);if(!new_tab)
{var new_sel='td.tab_cell[tab_idx='+new_idx+']';new_tab=this.tabs_div.child(new_sel);}
cur_tab.replaceClass('selected','unselected');new_tab.replaceClass('unselected','selected');this.cur_tab_idx=new_idx;},select_tab:function(new_idx,new_tab)
{this.select_tab_css(new_idx,new_tab);if(this.tab_widget)
this.destroy_child(this.tab_widget);this.curr_tab_content_div.dom.scrollTop=0;this.curr_tab_content_div.dom.scrollLeft=0;this.tab_widget=this.construct_child(this.tabs[new_idx].widget_name,this.tab_context);this.tab_widget.container_id=this.contents_id;this.curr_tab_content_div.set({cls:'child_div '+this.tab_widget.get_css_class_name()});this.tab_widget.render();},render_tabs:function()
{var dh=Ext.DomHelper;var i;var tab_order=this.get('tab_order');this.tabs=[];for(i=0;i<tab_order.length;i++)
{var tab=tab_order[i];this.tabs.push({name:tab.display_name,widget_name:tab.name});}
var tab_cells="";var cell_params;var tab_name;for(i=0;i<this.tabs.length;i++){cell_params={};cell_params.tab_name=this.render_tab_name(this.tabs[i].name);cell_params.tab_idx=i;if(i==0)
cell_params.extra_class='left_tab';else
cell_params.extra_class='';if(this.cur_tab_idx==i){cell_params.selected_class="selected";}else{cell_params.selected_class="unselected";}
tab_cells+=this.templates.tab_cell.apply(cell_params);}
if(this.context.get('design_mode')){tab_cells+=this.templates.tab_cell.apply({extra_class:'new_tab',selected_class:'unselected',tab_idx:-1,tab_name:'+ New Tab',});}
tab_cells+=this.templates.tab_edge.apply();var h='';h=this.templates.tabs.apply({cells:tab_cells,num_tabs:this.context.get('design_mode')?this.tabs.length+1:this.tabs.length});var s='width: '+(this.container.getWidth()-40)+'px;';this.tab_wrap=dh.append(this.tabs_div,{tag:'div',cls:'tab_wrap',style:s,html:h},true);this.tab_edge=this.tab_wrap.child('td.tab_edge');cls='scroll_button left_scroll enabled';this.left_scroll_button=dh.append(this.tabs_div,{tag:'div',cls:cls,html:'<'},true);cls='scroll_button right_scroll enabled';this.right_scroll_button=dh.append(this.tabs_div,{tag:'div',cls:cls,html:'>'},true);},render_tab_name:function(tab_name){if(this.context.get('design_mode'))
return this.templates.tab_name_design_mode.apply({tab_name:tab_name});else
return tab_name;},render:function(){var dh=Ext.DomHelper;var i;var tab_controls_class;if(this.get_parent().get('type')=='SG.Widget.EntityCard'){this.in_card_widget=true;tab_controls_class='tab_controls_small';}else{this.in_card_widget=false;tab_controls_class='tab_controls_big';}
this.container=this.get_container();if(this.context.get('design_mode'))
this.container.addClass('design_mode');this.tabs_div=dh.append(this.container,{tag:'div',cls:tab_controls_class},true);this.add_event(this.tabs_div,'click',this.on_tab_click);this.render_tabs();var tab_content_style="";this.curr_tab_content_div=dh.append(this.container,{tag:'div',id:this.contents_id,cls:"child_div",style:tab_content_style},true);this.container.child(".child_div").setTop(this.container.child("."+tab_controls_class).getHeight());this.select_tab(this.cur_tab_idx);this.update_scroll_buttons();this.have_rendered=true;},on_resize:function()
{this.tab_wrap.setWidth(this.container.getWidth()-40);this.update_scroll_buttons();this.fireEvent("widget_resize",this);},on_tab_click:function(e){var t=Ext.get(e.getTarget());var menu_target=t.findParent('div.menu_target',2,true);if(menu_target){this.show_tab_menu(menu_target);return;}
var p=t.findParent('td.tab_cell',2,true);if(p)
{if(!SG.Page.unsaved_data.confirm_proceed())
return;if(p.hasClass('new_tab'))
{var tab_order=this.get('tab_order');this.contextmenu_tab_index=tab_order.length;this.new_tab();return;}
var idx=p.dom.getAttribute('tab_idx');var dom_event=e.browserEvent;if((!this.in_card_widget)||(this.in_card_widget&&dom_event.altKey))
{this.select_tab_css(idx,p);var tw=this;setTimeout(function(){tw.set({selected_tab_idx:idx});},0);}
this.select_tab(idx,p);}
p=t.findParent('div.left_scroll');if(p)
{this.scroll_left();return;}
p=t.findParent('div.right_scroll');if(p)
{this.scroll_right();return;}},scroll_left:function()
{if(!this.left_scroll_button.hasClass('disabled'))
{this.tab_wrap.scroll('right',100,true);var tw=this;setTimeout(function(){tw.update_scroll_buttons();},500);}},scroll_right:function()
{if(!this.right_scroll_button.hasClass('disabled'))
{this.tab_wrap.scroll('left',100,true);var tw=this;setTimeout(function(){tw.update_scroll_buttons();},500);}},update_scroll_buttons:function()
{var pos_w=Ext.lib.Dom.getXY(this.tab_wrap.dom);var pos_e=Ext.lib.Dom.getXY(this.tab_edge.dom);var width=this.tab_wrap.getWidth();var o=parseInt(this.tab_wrap.dom.scrollLeft,10)||0;if(o==0)
this.left_scroll_button.replaceClass('enabled','disabled');else
this.left_scroll_button.replaceClass('disabled','enabled');if(pos_e[0]<(pos_w[0]+width))
this.right_scroll_button.replaceClass('enabled','disabled');else
this.right_scroll_button.replaceClass('disabled','enabled');},});SG.NewGanttDragHandler=function(config)
{Ext.apply(this,config);var empty=Ext.get('sg_grid_row_drag_nothing');if(!empty)
Ext.DomHelper.append(document.body,{tag:"div",id:"sg_grid_row_drag_nothing"},true);var config={resizeFrame:false,scroll:false};SG.NewGanttDragHandler.superclass.constructor.call(this,this.container,"rows",config);this.setDragElId("sg_grid_row_drag_nothing");if(!this.no_bar_drag)
this.container.on('mousemove',this.on_mousemove,this);var doc=Ext.get(document);doc.on('keydown',this.on_keydown,this);doc.on('keyup',this.on_keyup,this);this.drag_marker=this.container.child('div.drag_marker');this.last_hover_area=null;this.dragging=false;};Ext.extend(SG.NewGanttDragHandler,Ext.dd.DDProxy,{on_keydown:function(e)
{if(!e.browserEvent.altKey)return;if(this.dragging)
{this.offset_records=this.gantt.find_task_dependencies_for_task(this.mouse_down_area.record.id);this.mode='offset_drag';this.alt_key_down=true;return;}
this.alt_key_down=true;if(this.last_hover_area&&this.last_hover_area.record)
{this.tooltip_handler.hide();this.gantt.hide_gantt_bar_drag_handles(this.last_hover_area);this.gantt.show_gantt_bar_drag_handles(this.last_hover_area,e);}},on_keyup:function(e)
{if(!this.alt_key_down)return;this.alt_key_down=false;if(this.dragging&&this.mode=='offset_drag')
this.mode='bar_drag';if(this.last_hover_area&&this.last_hover_area.record)
{this.gantt.hide_gantt_bar_drag_handles(this.last_hover_area);this.gantt.show_gantt_bar_drag_handles(this.last_hover_area);}},is_scroll_click:function(e)
{if(this.scroll_container.dom.scrollHeight>this.scroll_container.dom.clientHeight)
{var r=this.scroll_container.getRight();if(e.xy[0]+20>r)
return true;}
if(this.scroll_container.dom.scrollWidth>this.scroll_container.dom.clientWidth)
{var b=this.scroll_container.getBottom();if(e.xy[1]+20>b)
return true;}
return false;},on_mousemove:function(e)
{if(this.dragging)
{this.last_hover_area=null;return;}
var area=this.dragable_area_callback.fn.call(this.dragable_area_callback.scope,e,true);if(area&&area.type=='group_hook')area=null;if(area&&area.record&&area!=this.last_hover_area)
{if(this.last_hover_area!=null)
this.gantt.hide_gantt_bar_drag_handles(this.last_hover_area)
this.gantt.show_gantt_bar_drag_handles(area,e);this.last_hover_area=area;}
else if(area==null&&this.last_hover_area)
{this.gantt.hide_gantt_bar_drag_handles(this.last_hover_area);this.last_hover_area=null;}},handleMouseDown:function(e)
{if(this.is_scroll_click(e))return;var blur_func=function(){if(SG.globals.active_editor&&SG.globals.active_editor.input_el&&SG.globals.active_editor.input_el.dom!=e.getTarget())
SG.globals.active_editor.blur();};window.setTimeout(blur_func,0);var area=this.dragable_area_callback.fn.call(this.dragable_area_callback.scope,e,true);if(area&&!this.no_bar_drag)
{this.day_length=this.gantt.day_length;this.half_day_length=this.gantt.half_day_length;var coords=this.coordinate_callback.fn.call(this.coordinate_callback.scope,e);if(coords.x<area.l&&area.record)
{this.mode='left_drag';this.handleMouseDown_left_right_drag(area,e);this.update_drag_marker(this.mouse_down_area,e);}
else if(coords.x>area.r&&area.record)
{if(e.browserEvent.altKey)
{this.mode='line_drag';this.handleMouseDown_left_right_drag(area,e);}
else
{this.mode='right_drag';this.handleMouseDown_left_right_drag(area,e);this.update_drag_marker(this.mouse_down_area,e);}}
else if(coords.x>=area.l&&coords.x<=area.r)
{if(e.browserEvent.altKey&&area.upstream_tasks)
{this.mode='offset_drag';this.handleMouseDown_offset_drag(area,e);}
else
{this.mode='bar_drag';this.handleMouseDown_bar_drag(area,e);}}}
else
{area=this.selection_area_callback.fn.call(this.selection_area_callback.scope,e);if(!area)return;this.mode='selection';this.handleMouseDown_selection(area,e);}
Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},handleMouseDown_bar_drag:function(area,e)
{this.mouse_down_area=area;var coords=this.gantt.to_area_coordinates(e);this.start_x=coords.x;this.days_offset=0;this.update_drag_marker(this.mouse_down_area,e);},handleMouseDown_offset_drag:function(area,e)
{this.replace_selection(area);this.mouse_down_area=area;var coords=this.gantt.to_area_coordinates(e);this.start_x=area.l;this.days_offset=0;this.offset_records=this.gantt.find_task_dependencies_for_task(area.record.id);},handleMouseDown_left_right_drag:function(area,e)
{this.mouse_down_area=area;var coords=this.gantt.to_area_coordinates(e);this.start_x=coords.x;this.days_offset=0;},handleMouseDown_line_drag:function(area,e)
{this.mouse_down_area=area;},handleMouseDown_selection:function(area,e)
{this.start_area=area;var dom_event=e.browserEvent;this.ctrl_drag=!Ext.isMac?dom_event.ctrlKey:dom_event.metaKey;this.shift_drag=dom_event.shiftKey;},replace_selection:function(area)
{var selection_manager=this.gantt.__get_selection_manager__();selection_manager.clear_selection(true);if(area.record)
selection_manager.select_entity_by_id(area.record.id,area.group_idx,false,true);else
selection_manager.select_group_by_id(area.group_idx,false,true);selection_manager.fire_selection_callback();},startDrag:function(x,y)
{this.dragging=true;this.tooltip_handler.hide();var fn_name='startDrag_'+this.mode;this[fn_name].call(this,x,y);},startDrag_left_drag:function(x,y)
{this.drag_marker.setVisible(true);if(!this.mouse_down_area.selected)
this.replace_selection(this.mouse_down_area);this.accumulate_selected_areas();},startDrag_right_drag:function(x,y)
{this.drag_marker.setVisible(true);if(!this.mouse_down_area.selected)
this.replace_selection(this.mouse_down_area);this.mouse_down_area.right_drag=true;this.accumulate_selected_areas();this.mark_selected_areas_dragging(true);this.gantt.render_widget();},startDrag_bar_drag:function(x,y)
{this.drag_marker.setVisible(true);if(!this.mouse_down_area.selected)
this.replace_selection(this.mouse_down_area);this.accumulate_selected_areas();this.mark_selected_areas_dragging(true);this.gantt.render_widget();},startDrag_line_drag:function(x,y)
{this.mouse_down_area.dragging=true;this.mouse_down_area.dot='right';var mouse=this.coordinate_callback.fn.call(this.coordinate_callback.scope,{xy:[x,y]});var task_area={l:mouse.x,r:mouse.x,t:mouse.y,b:mouse.y};this.dragging_line_area={l:this.mouse_down_area.r,r:this.mouse_down_area.r,t:this.mouse_down_area.t,b:this.mouse_down_area.b,task_area:task_area,dependent_task_area:this.mouse_down_area,render_fn:this.gantt.render_dependency_line_fn,line_drag:true};this.gantt.line_areas.push(this.dragging_line_area);this.gantt.render_widget();},mark_selected_areas_dragging:function(dragging)
{for(var i=0;i<this.selected_areas.length;i++)
{var area=this.selected_areas[i];this.gantt.toggle_chain_dragging(area,dragging);}},startDrag_offset_drag:function(x,y)
{this.update_drag_marker(this.mouse_down_area,{xy:[x,y]});this.drag_marker.setVisible(true);this.accumulate_selected_areas();this.mark_selected_areas_dragging(true);this.gantt.render_widget();},accumulate_selected_areas:function()
{this.selected_areas=[];var areas=this.gantt.active_dragable_areas;for(var i=0;i<areas.length;i++)
{var area=areas[i];if(area.selected)
{area.start_l=area.l;area.start_r=area.r;this.selected_areas.push(area);}}},startDrag_selection:function(x,y)
{this.selection_manager=this.gantt.__get_selection_manager__();if(!(this.ctrl_drag||this.shift_drag))
this.selection_manager.clear_selection(true);if(this.shift_drag&&this.click_selector.last_click)
{var e={xy:[x,y]};var shift_click_area=this.selection_area_callback.fn.call(this.selection_area_callback.scope,e);this.click_selector.handle_vertical_selection_shift_click(shift_click_area);}
this.selection_manager.fire_selection_callback();},onDrag:function(e)
{var fn_name='onDrag_'+this.mode;this[fn_name].call(this,e);},calc_days_offset:function(e)
{var coords=this.gantt.to_area_coordinates(e);var diff_x=coords.x-this.start_x;var days_offset;if(diff_x<0)
days_offset=Math.ceil(diff_x/this.day_length);else
days_offset=Math.floor(diff_x/this.day_length);return days_offset;},onDrag_bar_drag:function(e)
{var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset)
{var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.move_selected_graphics(diff);this.update_drag_marker(this.mouse_down_area,e);this.gantt.render_widget();}},onDrag_offset_drag:function(e)
{var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset)
{var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.move_selected_graphics(diff);this.update_drag_marker(this.mouse_down_area,e);this.gantt.render_widget();}},calculate_effective_days_offset:function()
{if(!this.gantt.have_background_rules)return this.days_offset;if(this.days_offset==0)return 0;var y=this.mouse_down_area.t;var days_offset_len=Math.abs(this.days_offset);var step=this.days_offset/days_offset_len;var working_days=0;for(var i=1;i<=days_offset_len;i++)
{var x=this.start_x+(i*step*this.day_length);if(this.gantt.is_working_day(this.gantt.bg_ctx,x,y))
working_days++;}
return step*working_days;},update_drag_marker:function(area,e)
{var text='';var mouse=this.coordinate_callback.fn.call(this.coordinate_callback.scope,e);var x=mouse.x-this.gantt.view_port.l;var y;if(this.mode=='left_drag')
{var d=this.gantt.get_time_at_pixel(area.l);text=d.format('D, M j');}
else if(this.mode=='right_drag')
{var d=this.gantt.get_time_at_pixel(area.r-this.day_length);text=d.format('D, M j');}
else if(this.mode=='bar_drag')
{var dl=this.gantt.get_time_at_pixel(area.l);var dr=this.gantt.get_time_at_pixel(area.r-this.day_length);var lM=dl.format('M');var rM=dr.format('M');var ly=dl.format('y');var ry=dr.format('y');if((lM==rM)&&(ly==ry))
text=dl.format('M j - ')+dr.format('j');else if(ly==ry)
text=dl.format('M j - ')+dr.format('M j');else
text=dl.format('M j/y - ')+dr.format('M j/y');}
else
{var effective_offset=this.calculate_effective_days_offset();if(this.offset_records.length==1)
{var record_offset=this.offset_records[0].get('offset_days');effective_offset+=record_offset;}
text='Offset: '+effective_offset;}
var w=(text.length*6)+16;x-=Math.floor(w/2);if(area.dt)
y=area.dt;else
y=area.t-this.gantt.view_port.t;this.drag_marker.setTop(y+24);this.drag_marker.setLeft(x);this.drag_marker.update('<span class="text">'+text+'</span>');},onDrag_left_drag:function(e)
{var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset)
{var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.adjust_selected_area_size(diff,true);this.update_drag_marker(this.mouse_down_area,e);this.gantt.render_widget();}},adjust_selected_area_size:function(days_offset,is_left)
{for(var i=0;i<this.selected_areas.length;i++)
{area=this.selected_areas[i];this.gantt.adjust_area_size(area,days_offset,is_left);}},onDrag_right_drag:function(e)
{var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset)
{var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.adjust_selected_area_size(diff,false);this.update_drag_marker(this.mouse_down_area,e);this.gantt.render_widget();}},onDrag_selection:function(e)
{var mouse=this.coordinate_callback.fn.call(this.coordinate_callback.scope,e);var t=mouse.y<this.start_area.t?mouse.y:this.start_area.t;var b=mouse.y>this.start_area.b?mouse.y:this.start_area.b;var areas=this.gantt.active_selection_areas;for(var i=0;i<areas.length;i++)
{var area=areas[i];if(!area.record_id)continue;if(area.b<=t)continue;if(area.t>=b)continue;this.selection_manager.select_entity_by_id(area.record_id,area.group_idx,false,true);}
this.selection_manager.fire_selection_callback();},onDrag_line_drag:function(e)
{var mouse=this.coordinate_callback.fn.call(this.coordinate_callback.scope,e);var task_area={l:mouse.x,r:mouse.x,t:mouse.y,b:mouse.y};this.dragging_line_area.task_area=task_area;var area=this.dragable_area_callback.fn.call(this.dragable_area_callback.scope,e,true);if(area&&area.record&&area!=this.mouse_down_area)
{if(this.last_line_drag_target)
{this.last_line_drag_target.dragging=false;this.last_line_drag_target.dot=undefined;}
area.dragging=true;area.dot='left';this.last_line_drag_target=area;}
else if(area==null&&this.last_line_drag_target)
{this.last_line_drag_target.dragging=false;this.last_line_drag_target.dot=undefined;this.last_line_drag_target=null;}
this.gantt.render_widget();},move_selected_graphics:function(offset)
{for(var i=0;i<this.selected_areas.length;i++)
{area=this.selected_areas[i];this.gantt.move_area(area,offset);}},clear_gantt_selection_canvas:function()
{this.gantt.sel_ctx.clearRect(0,0,this.gantt.canvas_width,this.gantt.canvas_height);},endDrag:function(e)
{this.last_hover_area=null;this.drag_marker.setVisible(false);this.dragging=false;var fn_name='endDrag_'+this.mode;this[fn_name].call(this,e);},endDrag_offset_drag:function(e)
{this.mark_selected_areas_dragging(false);this.gantt.render_widget();var effective_offset=this.calculate_effective_days_offset();if(effective_offset==0)return;this.gantt.task_dependency_ds.start_batch();for(var i=0;i<this.offset_records.length;i++)
{var r=this.offset_records[i];var old_offset_value=r.get('offset_days');r.set('offset_days',old_offset_value+effective_offset);}
this.gantt.task_dependency_ds.end_batch();this.gantt.task_dependency_ds.commit();},endDrag_bar_drag:function(e)
{this.mark_selected_areas_dragging(false);this.gantt.render_widget();if(this.days_offset==0)
return;var ds=this.gantt.grid_ds;ds.start_batch();var i,record,s_date;var records_done={};for(i=0;i<this.selected_areas.length;i++)
{var area=this.selected_areas[i];if(!area.record)continue;record=area.record;s_date=new SG.Date(record.get('start_date'));s_date=s_date.add(Date.DAY,this.days_offset);record.set('start_date',s_date.data_store_format());area.l=area.l+(this.day_length*this.days_offset);if(area.day_count)
area.r=area.l+(this.day_length*area.day_count);else
area.r=area.r+(this.day_length*this.days_offset);records_done[record.id]=true;}
var record_ids=this.gantt.get_selected_record_ids();for(i=0;i<record_ids.length;i++)
{var record_id=record_ids[i];if(records_done[record_id])continue;record=ds.get_record_by_id(record_id);var start_date=record.get('start_date');if(!start_date)continue;s_date=new SG.Date(start_date);s_date=s_date.add(Date.DAY,this.days_offset);record.set('start_date',s_date.data_store_format());}
ds.end_batch();ds.commit();},endDrag_selection:function(e)
{var last_click=this.selection_area_callback.fn.call(this.selection_area_callback.scope,e);this.click_selector.last_click=last_click;},endDrag_left_drag:function(e)
{var ds=this.gantt.grid_ds;ds.start_batch();var i,record,s_date,e_date;var records_done={};for(i=0;i<this.selected_areas.length;i++)
{record=this.selected_areas[i].record;if(!record)continue;record.set('duration',null);s_date=new SG.Date(record.get('start_date'));e_date=new SG.Date(record.get('due_date'));s_date=s_date.add(Date.DAY,this.days_offset);if(s_date.getTime()>e_date.getTime())
record.set('start_date',e_date.data_store_format());else
record.set('start_date',s_date.data_store_format());records_done[record.id]=true;}
var record_ids=this.gantt.get_selected_record_ids();for(i=0;i<record_ids.length;i++)
{var record_id=record_ids[i];if(records_done[record_id])continue;record=ds.get_record_by_id(record_id);var start_date=record.get('start_date')
var due_date=record.get('due_date')
if(!start_date||!due_date)continue;record.set('duration',null);s_date=new SG.Date(start_date);e_date=new SG.Date(due_date);s_date=s_date.add(Date.DAY,this.days_offset);if(s_date.getTime()>e_date.getTime())
record.set('start_date',e_date.data_store_format());else
record.set('start_date',s_date.data_store_format());}
ds.end_batch();ds.commit();},endDrag_right_drag:function(e)
{this.mark_selected_areas_dragging(false);this.gantt.render_widget();this.drag_marker.setVisible(false);this.dragging=false;this.mouse_down_area.right_drag=false;if(this.days_offset==0)
return;var ds=this.gantt.grid_ds;var i,record,s_date,e_date;var records_done={};ds.start_batch();for(i=0;i<this.selected_areas.length;i++)
{record=this.selected_areas[i].record;if(!record)continue;s_date=new SG.Date(record.get('start_date'));e_date=new SG.Date(record.get('due_date'));e_date=e_date.add(Date.DAY,this.days_offset);if(e_date.getTime()<s_date.getTime())
record.set('due_date',s_date.data_store_format());else
record.set('due_date',e_date.data_store_format());records_done[record.id]=true;}
var record_ids=this.gantt.get_selected_record_ids();for(i=0;i<record_ids.length;i++)
{var record_id=record_ids[i];if(records_done[record_id])continue;record=ds.get_record_by_id(record_id);var start_date=record.get('start_date')
var due_date=record.get('due_date')
if(!start_date||!due_date)continue;s_date=new SG.Date(start_date);e_date=new SG.Date(due_date);e_date=e_date.add(Date.DAY,this.days_offset);if(e_date.getTime()<s_date.getTime())
record.set('due_date',s_date.data_store_format());else
record.set('due_date',e_date.data_store_format());}
ds.end_batch();ds.commit();},endDrag_line_drag:function(e)
{this.mouse_down_area.dragging=false;this.mouse_down_area.dot=undefined;if(!this.last_line_drag_target)
{this.gantt.line_areas.pop();this.gantt.render_widget();return;}
this.last_line_drag_target.dragging=false;this.last_line_drag_target.dot=undefined;var dependent_task_area=this.mouse_down_area;var task_area=this.last_line_drag_target;var line_area=this.dragging_line_area;line_area.line_drag=false;line_area.task_area=task_area;line_area.dependent_task_area=dependent_task_area;this.gantt.add_downstream_line_area_to_task(dependent_task_area,line_area);if(dependent_task_area.downstream_tasks==undefined)
dependent_task_area.downstream_tasks={};dependent_task_area.downstream_tasks[task_area.id]=task_area;if(task_area.upstream_tasks==undefined)
task_area.upstream_tasks={};task_area.upstream_tasks[dependent_task_area.id]=dependent_task_area;if(dependent_task_area.selected)
this.gantt.electrify_chain(dependent_task_area);this.gantt.move_area(dependent_task_area,0);this.gantt.render_widget();var record=this.gantt.grid_ds.get_record_by_id(dependent_task_area.record.id);var entity={id:task_area.record.id,type:'Task',name:''};record.multi_entity_set('downstream_tasks',[entity],'add');this.gantt.grid_ds.commit();},});SG.Widget.EntityQuery.EntityQueryPage=function(context,widget_spec,id){SG.Widget.EntityQuery.EntityQueryPage.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityQuery.EntityQueryPage,SG.Widget.Base,{templates:{page:'<div class="contents">{contents}</div>',widget:'<div class="query_builder_container hidden">'+'<div class="entity_query_page_query_builder hidden"></div>'+'</div>'+'<div class="entity_query_page_toolbar" style="{content_left_style}">{toolbar}</div>'+'<div id="{content_id}" class="{content_class}" style="{content_left_style}"></div>'+'<div class="sgc_filter_panel" style="width:{filter_panel_width}px; display:none;">&nbsp;</div>'+'<div class="footer sgc_footer"></div>',child_widget:'<div id="{child_widget_id}" class="{child_widget_class}"></div>',toolbar:'<div class="toolbar sgc_toolbar" style="{show}"></div>',in_toolbar_filter_button:'<div class="filter_button sgc_quick_filter_button" '+'id="{in_toolbar_filter_button_id}" style="{display_style}">'+'<div class="icon_search"></div></div>',query_builder:'<div class="query_builder sgc_query_builder"></div>',mode_link:'<div class="mode_button {icon_class} {extra_class}" query_mode="{mode}" sg_tip="{tooltip}"></div>',toolbar_icon:'<div class="toolbar_icon {icon_class}"></div>',toolbar_grouping_menu:'<span class="label">Group</span><div class="dropdown_arrow_small"></div>',toolbar_button:'<div class="toolbar_button {extra}">'+'<div class="{left_class}"></div>{label}<div class="right"></div></div>',toolbar_notes_app_button:'<div class="toolbar_button {extra}">'+'<div class="left"></div><div class="notes_app_icon icon_Playlist"></div>'+'{label}<div class="right"></div></div>',empty_content_message:'<div class="sg_no_entities_returned">{message}{trigger}</div>',empty_content_trigger:'<span class="sg_no_entities_add_link_new {trigger_class}">{trigger_text}</span>'},canvas_require_height:true,filter_panel_width:250,default_settings:{entity_type:'Note',filters:{logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]},mode:"list",pivot_filters:{logical_operator:"and",conditions:[]},embedded:false,show_toolbar:true,show_mode_buttons:true,show_toolbar_buttons:true,grouping:false,pivot_grouping:false,group_settings:{},pivot_group_settings:{},empty_message:null,filter_panel_main_entity_type_settings:{},filter_panel_sched_mode_settings:{},show_grouping_toolbar_menu:true},is_entity_query_page:true,get_content_widget_entity_type:function(){var content_widget=this.get_content_widget();return content_widget.context.get('entity_type');},get_filters:function(){if(this.context.get('inside_window'))
return this.context.get('filters');else
return this.get('filters');},get_pivot_filters:function(){if(this.context.get('inside_window'))
return this.context.get('pivot_filters');else
return this.get('pivot_filters');},get_entity_type:function(){return this.get('entity_type');},_get_entity_type_and_filters_from_context:function(){return{entity_type:this.get_entity_type(),filters:this.get_filters()};},get_query_builder_container:function(){return this.container.child('div.query_builder_container');},get_content_widget_container:function(){return this.container.child("."+this.get_content_widget().get_css_class_name());},update_dynamically_detected_positions:function(){this.update_content_widget_position();this.update_filter_panel(true);var content=this.get_content_widget();if(content.update_dynamically_detected_positions)
content.update_dynamically_detected_positions();},update_content_widget_position:function(){var qb_container=this.get_query_builder_container();var toolbar_div=this.container.child('div.entity_query_page_toolbar');var qb_height=qb_container.getHeight();var toolbar_height=toolbar_div.getHeight();toolbar_div.setTop(qb_height);var content_widget_container=this.get_content_widget_container();content_widget_container.setTop(qb_height+toolbar_height-1);Ext.get(this.get_filter_panel_container()).setTop(qb_height);},before_init:function(){if(this.get('embedded')){this.parent_entity=this.context.get('entity');}else{SG.NotificationCenter.add_observer({uuid:'_global_nav_',name:'f_key_pressed',callback:{fn:this.on_f_key_pressed,scope:this}});}},init_children:function(){var content_widget=this.get_content_widget();this.action_menu_id=this.get_css_class_name()+'_'+this.get_widget_id()+'_action_menu';this.context_menu_id=this.get_css_class_name()+'_'+this.get_widget_id()+'_context_menu';this.linking_mode=this.compute_linking_mode();},on_query_builder_filters:function(filters,pivot_filters){this.selection_manager.clear_selection();this.remove_event(this,"settings_changed",this.on_settings_changed);this.set_filters(filters,pivot_filters);this.add_event(this,"settings_changed",this.on_settings_changed);this.update_combined_filters();},set_filters:function(filters,pivot_filters){if(this.context.get('inside_window')){var content_widget=this.get_content_widget();if(filters){this.context.set('filters',filters);content_widget.context.set('filters',filters);}
if(pivot_filters){this.context.set('pivot_filters',pivot_filters);content_widget.context.set('pivot_filters',pivot_filters);}}else{var config={};if(filters)
config.filters=filters;if(pivot_filters)
config.pivot_filters=pivot_filters;this.set(config);}},construct_qb:function(){if(this.query_builder)
this.query_builder.destroy();var config={floating:false,container:Ext.get(sg_find("div.entity_query_page_query_builder",this.container.dom)),entity_type:this.get_entity_type(),filters:this.get_filters(),page_project:this.context.get('page_project'),widget:this,callback:{fn:this.on_query_builder_filters,scope:this},resize_callback:{fn:this.update_dynamically_detected_positions,scope:this}};var join_fields=this.get_content_widget().get_through_join_fields();if(join_fields){config.through_join_fields=join_fields;config.parent_entity=this.parent_entity;}
if(this.content_name()=="sched_content")
config.pivot_filters=this.get_pivot_filters();this.query_builder=new SG.Widget.EntityQuery.QueryBuilder(config);},destroy_widget:function(){if(this.query_builder)
this.query_builder.destroy();if(this.footer)
this.footer.destroy();SG.NotificationCenter.remove_observer({uuid:'_global_nav_',name:'f_key_pressed',callback:{fn:this.on_f_key_pressed,scope:this}});},init_widget:function(){this.selected_entities=[];this.add_event(this,"settings_changed",this.on_settings_changed);},on_settings_changed:function(change_hash){var content_widget=this.get_content_widget();if('filters'in change_hash)
content_widget.context.set('filters',change_hash.filters);if('pivot_filters'in change_hash)
content_widget.context.set('pivot_filters',change_hash.pivot_filters);if('grouping'in change_hash)
content_widget.context.set('grouping',change_hash.grouping);if('pivot_grouping'in change_hash)
content_widget.context.set('grouping',change_hash.pivot_grouping);if('group_settings'in change_hash)
content_widget.context.set('group_settings',change_hash.group_settings);if('pivot_group_settings'in change_hash)
content_widget.context.set('group_settings',change_hash.pivot_group_settings);},set_mode:function(mode){var old_mode=this.get('mode');if(old_mode!=mode){var content_container=this.get_content_widget_container();var content_widget=this.get_content_widget();if(!(content_widget instanceof SG.Widget.EntityQueryMode))
return;this.selection_manager.destroy_drag_selectors();this.destroy_child(content_widget);this.selection_manager.clear_selection(true);if(mode=='sched'||old_mode=='sched')this.destroy_nested_grouping_dialog();this.set({mode:mode});var new_content_widget=this.get_content_widget();content_container.dom.id=new_content_widget.get_container_id();content_container.dom.setAttribute("class",new_content_widget.get_css_class_name()+' sgw_entity_query_mode');new_content_widget.render();this.selected_entities=[];this.query_builder.set_filters();this.construct_qb();if(this.should_show_query_builder())
this.show_query_builder();this.construct_and_render_toolbar();this.construct_and_render_footer();this.update_content_widget_position();this.selection_manager.set_entity_query_mode(mode);}},content_name:function(){return this.get('mode')+'_content';},get_server_side_filters:function(){if(this.get('server_side_filters')){return this.get('server_side_filters');}else if(this.get_entity_type()=="Page"){return"reports_only";}else{return null;}},get_content_widget:function(){var content_widget_name=this.content_name();var content_widget=this.get_child(content_widget_name);if(!content_widget){var content_context=this.context.clone();var entity_type=this.get_entity_type();content_context.set('entity_type',entity_type);this.filter_panel_filters=this.get_filter_panel_component().get_filters();content_context.set('filters',this.combined_filters());if(this.get('embedded')){content_context.set('parent_entity',this.parent_entity);}else{var context_entity=this.context.get('entity');if(context_entity&&context_entity.type=='Project')
content_context.set('parent_entity',context_entity);}
var ssf=this.get_server_side_filters();if(ssf)
content_context.set('server_side_filters',ssf);if(content_widget_name=="sched_content"){content_context.set('pivot_from_type',content_context.get('entity_type'));content_context.set('pivot_field','entity');content_context.set('entity_type','Task');content_context.set('pivot_filters',this.combined_pivot_filters());content_context.set('grouping',this.get_clean_grouping_setting('pivot_grouping'));content_context.set('group_settings',this.get('pivot_group_settings'));}else{content_context.set('grouping',this.get_clean_grouping_setting('grouping'));content_context.set('group_settings',this.get('group_settings'));}
content_widget=this.construct_child(content_widget_name,content_context);}
return content_widget;},render:function(){this.container=this.get_container();var embedded=this.get('embedded');if(embedded)
this.container.addClass('embedded');var toolbar_show='';if(this.get('show_toolbar'))
this.in_toolbar_filter_button_id='filter_button_'+this.get_widget_id();else
toolbar_show='display: none';var content_widget=this.get_content_widget();var widget_html=this.templates.widget.apply({toolbar:this.templates.toolbar.apply({show:toolbar_show}),content_id:content_widget.get_container_id(),content_class:content_widget.get_css_class_name()+' sgw_entity_query_mode',content_left_style:this.filter_panel_is_open()?'left: '+this.filter_panel_width+'px;':'',filter_panel_width:this.filter_panel_width-3});if(embedded){this.container.update(widget_html);}else{this.container.update(this.templates.page.apply({contents:widget_html}));}
if(!(content_widget instanceof SG.Widget.EntityQueryMode)){this.update_content_widget_position();content_widget.render();return;}
this.construct_qb();this.construct_and_render_toolbar();this.construct_and_render_footer();this.update_filter_panel(true);this.update_content_widget_position();content_widget.render();var selection_config={container:this.get('embedded')?this.container:this.container.child('div.contents'),selection_callback:{fn:this.on_entities_selected,scope:this},context_menu_callback:{fn:this.on_contextmenu,scope:this},entity_query_mode:this.get('mode'),entity_type:this.get_entity_type(),entity_query_page_widget:this};var data_store=content_widget.get_entity_data_store();this.selection_manager=this.new_component(SG.SelectionManager,selection_config);var select_entities_on_first_load=this.context.get('select_entities_on_first_load');if(select_entities_on_first_load)
this.add_event(data_store,'load',this.prime_content_widget_selection);var scroll_selection_into_view_on_load=this.context.get('scroll_selection_into_view_on_load');if(scroll_selection_into_view_on_load)
this.add_event(data_store,'load',this.scroll_selection_into_view_on_load);if(this.should_show_query_builder())
this.show_query_builder();},should_show_query_builder:function(){if(this.get('embedded')){var parent_widget=this.get_parent();if(!parent_widget||!parent_widget.init_widget)
return false;var parent_type=parent_widget.get('type');if(parent_type=='SG.Widget.Tabs')
return this.context.get('design_mode');else
return this.context.get('edit_mode');}
else
return this.context.get('design_mode');},scroll_selection_into_view_on_load:function(data_store){this.remove_event(data_store,'load',this.scroll_selection_into_view_on_load);var grid_container=this.container.child('div.sgw_new_grid');if(!grid_container)return;if(grid_container.dom.scrollHeight>grid_container.dom.clientHeight){var row=sg_find('div.row.selectable.selected',grid_container.dom);if(!row)return;row=Ext.get(row);var t=row.getTop()-grid_container.getTop()+Math.floor((grid_container.getHeight()/2));}},prime_content_widget_selection:function(data_store){this.remove_event(data_store,'load',this.prime_content_widget_selection);this.select_entities_by_id(this.context.get('select_entities_on_first_load'));this.selection_manager.fire_selection_callback();},select_entities_by_id:function(id_array,unselect){var content_widget=this.get_content_widget();var content_widget_container=content_widget.get_container();for(var i=0;i<id_array.length;i++){var record_id=id_array[i];var elem=sg_find('.seltarget[record_id="'+record_id+'"]',content_widget_container.dom);if(elem)
this.selection_manager.select_entity(Ext.get(elem),unselect,true);}},construct_and_render_footer:function(){if(this.footer)
this.footer.destroy();var footer_container=this.container.child('div.sgc_footer');var content_widget=this.get_content_widget();var data_store=null;if(typeof content_widget.get_entity_data_store==='function')
data_store=content_widget.get_entity_data_store();var config={container:footer_container,data_store:data_store,entity_query_page:this,size_threshold:500};this.footer=new SG.Footer(config);this.footer.render();},get_left_footer_render_callback:function(){var content_widget=this.get_content_widget();return content_widget.get_left_footer_render_callback();},set_data_store_page:function(page){var content_widget=this.get_content_widget();this.selection_manager.clear_selection(true);content_widget.set_data_store_page(page);},reload_all_entities:function(){var content_widget=this.get_content_widget();content_widget.reload_all_entities();},set_data_store_max_records:function(max){var content_widget=this.get_content_widget();this.selection_manager.clear_selection(true);content_widget.set_data_store_max_records(max);},on_filter_button_click:function(){if(this.filter_panel_is_open())
this.close_filter_panel();else
this.open_filter_panel();},on_filter_button_context_menu:function(e,toolbar_item_div){this.get_filter_panel_component().on_filter_button_context_menu(e);},filter_panel_open_use_setting:function(){return true;},filter_panel_is_open:function(){if(this.filter_panel_open_use_setting())
return(this.get('filter_panel_open')||false);else
return(this.embedded_page_filter_panel_open===true);},open_filter_panel:function(){if(this.filter_panel_open_use_setting())
this.set('filter_panel_open',true);else
this.embedded_page_filter_panel_open=true;this.update_filter_panel();SG.NotificationCenter.post({uuid:'_sg_sidenav_',name:'sidenav_changed',args:null,canvas_id:null});},close_filter_panel:function(){if(this.filter_panel_open_use_setting())
this.set('filter_panel_open',false);else
this.embedded_page_filter_panel_open=false;this.update_filter_panel();SG.NotificationCenter.post({uuid:'_sg_sidenav_',name:'sidenav_changed',args:null,canvas_id:null});},on_f_key_pressed:function(){if(this.filter_panel_is_open()){this.filter_panel_component.focus_text_filter();}else{this.open_filter_panel();}},show_filter_panel_more_fields_menu:function(dom_elem){this.filter_panel_component.show_more_fields_menu(dom_elem);},get_filter_panel_container:function(){if(this.container)
return sg_find('div.sgc_filter_panel',this.container.dom);},get_filter_panel_component:function(){if(!this.filter_panel_component){var filter_panel_container=this.get_filter_panel_container();if(filter_panel_container)
filter_panel_container=Ext.get(filter_panel_container);this.filter_panel_component=this.new_component(SG.Widget.EntityQuery.FilterPanelWrapper,{container:filter_panel_container,entity_type:this.get_entity_type(),widget:this,server_side_filters:this.get_server_side_filters()});}else if(this.container&&!this.filter_panel_component.container){this.filter_panel_component.set_container(Ext.get(this.get_filter_panel_container()));}
return this.filter_panel_component;},on_content_widget_entities_reloaded:function(){this.update_filter_panel();},update_filter_panel:function(no_data_reload){var filter_panel_container=this.get_filter_panel_container();var content_container=this.get_content_widget().get_container();if(!filter_panel_container||!content_container)
return;var toolbar_div=this.container.child('div.entity_query_page_toolbar');var toolbar_filter_button=sg_find('div#'+this.in_toolbar_filter_button_id,this.container.dom);var filter_panel_component=this.get_filter_panel_component();filter_panel_component.set_column_display_names_hash(this.get_column_display_names());if(this.filter_panel_is_open()){content_container.setLeft(this.filter_panel_width+'px');toolbar_div.setLeft(this.filter_panel_width+'px');var focus_text_filter=(filter_panel_container.style.display==='none');var page=this.get_page();if(no_data_reload&&this.get('embedded')||page.type=='notes_app_version_pane')
focus_text_filter=false;filter_panel_container.style.display='block';if(toolbar_filter_button)
toolbar_filter_button.style.display='none';filter_panel_component.render(focus_text_filter,no_data_reload);if(this.footer)
this.footer.update_left_control();}else{content_container.setLeft('0px');toolbar_div.setLeft('0px');filter_panel_container.style.display='none';if(toolbar_filter_button){toolbar_filter_button.style.display='inline-block';if(filter_panel_component.has_filters())
toolbar_filter_button.firstChild.className='icon_search_active';else
toolbar_filter_button.firstChild.className='icon_search';}
if(this.footer)
this.footer.update_left_control();}},set_filter_panel_filters:function(filter_panel_filters){this.filter_panel_filters=filter_panel_filters;this.update_combined_filters();},set_sched_mode_filter_panel_filters:function(task_filter_panel_filters,no_update){this.sched_mode_filter_panel_filters=task_filter_panel_filters;if(no_update)
return;this.update_combined_filters();},on_entities_selected:function(selected_entities,in_drag){this.selected_entities=selected_entities;var ds=this.get_content_widget().get_entity_data_store();var ds_count=ds.count();var i,rec,rec_id;if(!in_drag){var sorted_selected_entities=[];for(i=0;i<ds_count;i++){rec=ds.get_record(i);rec_id=rec.get_id();if(this.selected_entities.indexOf(rec_id)>-1&&sorted_selected_entities.indexOf(rec_id)==-1)
sorted_selected_entities.push(rec_id);}
this.selected_entities=sorted_selected_entities;}
this.toolbar.entity_selection_changed(selected_entities);var content_widget=this.get_content_widget();if(content_widget.entity_selection_changed)
content_widget.entity_selection_changed(selected_entities);if(this.widget_spec.uuid&&!in_drag){var selection=[];var entity_type=this.get_entity_type();var ident=SG.schema.get_identifier_field(entity_type);for(i=0;i<selected_entities.length;i++){rec=ds.get_record_by_id(selected_entities[i]);selection.push({type:entity_type,id:rec.get_id(),name:rec.get(ident)||"No Name"});}
var cfg={uuid:this.widget_spec.uuid,name:'selection_changed',args:selection,canvas_id:this.get_canvas()?this.get_canvas().get_widget_id():null};SG.NotificationCenter.post(cfg);}},show_query_builder:function(e,toolbar_item_div){var qb_container=this.get_query_builder_container();qb_container.removeClass('hidden');this.query_builder.column_display_names=this.get_column_display_names();this.query_builder.refresh_column_menus();this.query_builder.render();},destroy_toolbar:function(){this.toolbar.destroy();},construct_and_render_toolbar:function(){if(this.toolbar)
this.destroy_toolbar();var content_widget_name=this.content_name();var toolbar_container=this.container.child('div.toolbar');var toolbar_config={container:toolbar_container,entity_type:this.get_content_widget_entity_type(),widget:this,pivoted:content_widget_name=='sched_content',size_threshold:400};this.toolbar=new SG.Toolbar(toolbar_config);var mode=this.get('mode');this.toolbar.add_item({position:'left',html:this.templates.in_toolbar_filter_button.apply({in_toolbar_filter_button_id:this.in_toolbar_filter_button_id,display_style:this.filter_panel_is_open()?'display: none;':''}),onclick:{fn:this.on_filter_button_click,scope:this},oncontextmenu:{fn:this.on_filter_button_context_menu,scope:this},visible_when_small:true});if(this.get('show_mode_buttons')){this.toolbar.add_item({position:'left',html:this.render_mode_switcher(),onclick:{fn:this.on_mode_switcher_click,scope:this}});this.toolbar.add_item({position:'left',html:'_SPACER_'});}
if(this.get('show_toolbar_buttons')){var entity_type=this.get_content_widget_entity_type();var disabled=(entity_type=="DisplayColumn"||entity_type=="Booking"||!SG.schema.can_create_entity(entity_type));var entity_display_name=SG.schema.entity_types[entity_type].display_name;var entity_display_name_plural=SG.schema.entity_types[entity_type].display_name_pluralized;this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'toolbar_plus'}),html_disabled:this.templates.toolbar_icon.apply({icon_class:'toolbar_plus_disabled'}),onclick:{fn:this.create_new_entity,scope:this},disabled:disabled,sg_tip:'New '+entity_display_name,visible_when_small:true});var dn,parent_entity_type,pdn;if(this.linking_mode=='linking_window'){dn=SG.schema.entity_types[this.get_entity_type()].display_name_pluralized;parent_entity_type=this.context.get('entity').type;pdn=SG.schema.entity_types[parent_entity_type].display_name;this.toolbar.add_item({position:'left',html:this.templates.toolbar_button.apply({left_class:'left',label:'Link Selected',extra:'green'}),html_disabled:this.templates.toolbar_button.apply({left_class:'left',label:'Link Selected',extra:' green disabled'}),onclick:{fn:this.link_selected_entities,scope:this},sg_tip:'Link Selected '+dn+' to this '+pdn,disabled:this.selected_entities.length===0,toggle_on_entity_selection:true});}else if(this.linking_mode=='linkable_embedded'){dn=SG.schema.entity_types[this.get_entity_type()].display_name_pluralized;parent_entity_type=this.context.get('entity').type;pdn=SG.schema.entity_types[parent_entity_type].display_name;var link_label='Link '+dn;if(entity_type=="Attachment")
link_label='Link Existing '+dn;this.toolbar.add_item({position:'left',html:this.templates.toolbar_button.apply({left_class:'left_plus',label:link_label,extra:'plus'}),onclick:{fn:this.show_quick_linking_bar,scope:this},sg_tip:'Link '+dn+' to this '+pdn});this.toolbar.add_item({position:'left',html:this.templates.toolbar_button.apply({left_class:'left',label:'Unlink',extra:''}),html_disabled:this.templates.toolbar_button.apply({left_class:'left',label:'Unlink',extra:'disabled'}),disabled:this.selected_entities.length===0,toggle_on_entity_selection:true,onclick:{fn:this.unlink_selected_entities,scope:this},sg_tip:'UnLink Selected'});}else{var can_retire_entity=SG.schema.can_retire_entity(entity_type);disabled=!can_retire_entity||this.selected_entities.length===0;this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'toolbar_trash'}),html_disabled:this.templates.toolbar_icon.apply({icon_class:'toolbar_trash_disabled'}),onclick:{fn:this.delete_selected_entities,scope:this},disabled:disabled,toggle_on_entity_selection:can_retire_entity,sg_tip:'Delete Selected '+entity_display_name_plural});}
this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'toolbar_edit_sel'}),html_disabled:this.templates.toolbar_icon.apply({icon_class:'toolbar_edit_sel_disabled'}),onclick:{fn:this.multi_edit_selected,scope:this},disabled:this.selected_entities.length===0,toggle_on_entity_selection:true,sg_tip:'Edit Selected '+entity_display_name_plural});this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'toolbar_gear_menu'}),onclick:{fn:this.on_action_menu,scope:this},oncontextmenu:{fn:this.on_action_menu,scope:this},sg_tip:'More Actions',visible_when_small:true});this.toolbar.add_item({position:'left',html:'_SPACER_'});if(this.get_content_widget_entity_type()=='HumanUser'){var can_enable_disable_user=SG.schema.can_edit_field('HumanUser','sg_status_list');this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'button_person_active_on'}),html_disabled:this.templates.toolbar_icon.apply({icon_class:'button_person_active_off'}),disabled:!can_enable_disable_user||this.selected_entities.length===0,toggle_on_entity_selection:can_enable_disable_user,onclick:{fn:this.on_toolbar_set_human_user_active,scope:this},sg_tip:'Activate User'});this.toolbar.add_item({position:'left',html:this.templates.toolbar_icon.apply({icon_class:'button_person_disabled_on'}),html_disabled:this.templates.toolbar_icon.apply({icon_class:'button_person_disabled_off'}),disabled:!can_enable_disable_user||this.selected_entities.length===0,toggle_on_entity_selection:can_enable_disable_user,onclick:{fn:this.on_toolbar_set_human_user_disabled,scope:this},sg_tip:'Disable User'});this.toolbar.add_item({position:'left',html:'_SPACER_'});}
if(this.get_content_widget_entity_type()=='Playlist'){this.toolbar.add_item({position:'left',toggle_on_entity_selection:true,render_callback:{fn:this.render_notes_app_toolbar_button,scope:this},onclick:{fn:this.start_notes_app,scope:this},sg_tip:'Launch Review Notes App'});}}
if(this.get('show_grouping_toolbar_menu')&&['calendar','report'].indexOf(mode)==-1){this.toolbar.add_item({position:'left',html:this.templates.toolbar_grouping_menu.apply(),onclick:{fn:this.on_grouping_menu,scope:this},oncontextmenu:{fn:this.on_grouping_menu,scope:this},cls:'action_menu',sg_tip:'Grouping Options',visible_when_small:true,});}
var content_widget=this.get_content_widget();if(typeof content_widget.get_toolbar_items==='function'){var content_widget_items=content_widget.get_toolbar_items();this.toolbar.add_items(content_widget_items);}
this.toolbar.render();},render_notes_app_toolbar_button:function(){if(this.selected_entities.length===1&&SG.schema.can_create_entity("Note")){return this.templates.toolbar_notes_app_button.apply({label:'Launch Review Notes App',extra:''});}else{return this.templates.toolbar_notes_app_button.apply({label:'Launch Review Notes App',extra:'disabled'});}},unlink_selected_entities:function(){var link_fields=this.get_parent_link_fields_from_context();var content_widget=this.get_content_widget();var entity_set=content_widget.get_entity_data_store();var new_val=[this.context.get('entity')];var rec;var me=this;this.add_event(entity_set,'change',function(changes){var change;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type==='update'&&change.state==='server'&&link_fields.indexOf(change.column)!==-1)
{content_widget.reload_all_entities();me.on_entities_selected([]);}}});var entity_type=this.get_content_widget_entity_type();var schema_fields=SG.schema.entity_fields[entity_type];for(var i=0;i<this.selected_entities.length;i++){rec=entity_set.get_record_by_id(this.selected_entities[i]);for(var j=0;j<link_fields.length;j++){if(schema_fields[link_fields[j]].data_type==='multi_entity')
rec.multi_entity_set(link_fields[j],new_val,'remove');else
rec.set(link_fields[j],null);}}
entity_set.commit();},compute_linking_mode:function(){var context_entity=this.context.get('entity');if(this.context.get('inside_window')){if(this.context.get('page_has_on_linked_callback'))
return'linking_window';}else if(this.get('embedded')||(!this.get('embedded')&&context_entity&&context_entity.type=='Project')){var join_fields=this.get_parent_link_fields_from_context();var entity_type=this.get_content_widget_entity_type();if(join_fields.length===1&&SG.schema.can_edit_field(entity_type,join_fields[0])){var sf=SG.schema.get_field(entity_type,join_fields[0]);if(sf.data_type==='multi_entity'&&sf.name!=='note_links')
return'linkable_embedded';}}
return'none';},show_linking_focus_window:function(){var entity_type=this.get_content_widget_entity_type();var context={entity:this.context.get('entity'),entity_type:entity_type,link_to:[this.context.get('entity')],link_fields:this.get_parent_link_fields_from_context(),on_linked_callback:{fn:this.entities_have_been_linked,scope:this},filters:this.generate_link_entities_filters(),title:'Link '+SG.schema.entity_types[entity_type].display_name_pluralized,reset_stack:true};this.get_page().get_focus_window().open(context);},show_quick_linking_bar:function(e,toolbar_button_elem){var link_fields=this.get_parent_link_fields_from_context();var ql=new SG.QuickLink({widget:this,entity_type:this.get_content_widget_entity_type(),parent_entity:this.context.get('entity'),link_field_to_parent:link_fields[0],on_link:{fn:this.on_entities_quick_linked,scope:this},on_multi_link:{fn:this.on_entities_quick_linked,scope:this},reset_after_linking:true,overlay_container:this.container,align_to:{dom_elem:toolbar_button_elem,elem_anchor:"bl",dialog_anchor:"tl"}});ql.show();},on_entities_quick_linked:function(){var content_widget=this.get_content_widget();content_widget.reload_all_entities();},show_version_playlist_linking_window:function(){var selected_versions=[];var version_projects=[];var version_project=null;for(var i=0;i<this.selected_entities.length;i++){var id=this.selected_entities[i];var project=this.get_content_widget().get_entity_data_store().get_record_by_id(id).get('project');if(project&&version_projects.indexOf(project.id)==-1){version_projects.push(project.id);version_project=project;}
selected_versions.push({type:'Version',id:id});}
if(version_projects.length>1){var cd=new SG.MessageDialog({sg_dialog_header_text:'(!) Versions from Multiple Projects',html_msg:'Some of the selected Versions have different Projects.  '+'<div style="margin-top: 8px; margin-bottom: 8px;">Please select only '+'Versions from a single Project when linking to Playlists. '+'You can see the Project each Version is linked to by looking at the "Project" field.</div>'});return;}
var entity_type='Playlist';var context={entity:selected_versions[0],entity_type:entity_type,link_to:selected_versions,link_fields:['versions'],on_linked_callback:{fn:this.entities_have_been_linked,scope:this},filters:this.generate_link_entities_filters(version_project),title:'Link Playlists',reset_stack:true};this.get_page().get_focus_window().open(context);},entities_have_been_linked:function(){this.get_page().get_focus_window().close();var content_widget=this.get_content_widget();content_widget.reload_all_entities();},link_selected_entities:function(){var link_fields=this.context.get('link_fields');var entity_type=this.get_content_widget_entity_type();var schema_fields=SG.schema.entity_fields[entity_type];var content_widget=this.get_content_widget();var entity_set=content_widget.get_entity_data_store();var new_val=this.context.get('link_to');var rec;this.add_event(entity_set,'change',this.respond_to_linked_fields);for(var i=0;i<this.selected_entities.length;i++){rec=entity_set.get_record_by_id(this.selected_entities[i]);for(var j=0;j<link_fields.length;j++){if(schema_fields[link_fields[j]].data_type==='multi_entity')
rec.multi_entity_set(link_fields[j],new_val,'add');else
rec.set(link_fields[j],this.context.get('entity'));}}
content_widget.show_loading_overlay();if(this.context.get('on_link_no_undo'))
entity_set.commit(true);else
entity_set.commit();},respond_to_linked_fields:function(changes){var change,linking_changed;var callback=this.get_page().on_linked_callback;var me=this;if(callback&&callback.scope&&!callback.scope.__destroyed__){var error,sed,link_fields=this.context.get('link_fields');var msg='';var ver_dn=SG.schema.entity_types.Version.display_name_pluralized;var play_dn=SG.schema.entity_types.Playlist.display_name;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type==='update'&&change.state==='server'&&link_fields.indexOf(change.column)!==-1)
{error=change.record.get_error(change.column);if(error){msg+='You don\'t have permission to link the selected '+ver_dn+' to the '+play_dn+' "';msg+=change.record.get('code')+'".<br><br>';}else{linking_changed=true;}}}
if(msg){new SG.NewDialog({title:"Oops!",body:msg,actions:[{label:'OK',callback:{fn:function(){me.get_content_widget().reload_all_entities();},scope:me}}]});return;}
if(linking_changed){this.get_content_widget().hide_loading_overlay();callback.fn.call(callback.scope);this.remove_event(this.get_content_widget().get_entity_data_store(),'change',this.respond_to_linked_fields);}}},generate_link_entities_filters:function(optional_project_fallback){var entity_type=this.get_content_widget_entity_type();if(!entity_type)
entity_type=this.context.get('entity').type;var top_conditions=[];var main_conditions=[];if(SG.schema.entity_types[entity_type].has_projects){var project=this.get_content_widget().single_project_from_context()||optional_project_fallback;if(project){top_conditions.push({logical_operator:'and',conditions:[{path:'project',relation:'is',values:[project]}]});}}
top_conditions.push({conditions:main_conditions,logical_operator:'and'});var filters={conditions:top_conditions,logical_operator:'and'};return filters;},multi_edit_selected:function(){var content_widget=this.get_content_widget();content_widget.multi_edit_selected();},show_nested_grouping_dialog:function(column_display_names){if(this.nested_grouping_dialog&&!this.nested_grouping_dialog.__destroyed__)
return;var mode=this.get('mode');var grp_setting=mode=='sched'?'pivot_grouping':'grouping';var config={entity_type:this.get_content_widget_entity_type(),grouping:this.get_clean_grouping_setting(grp_setting),update_callback:{fn:this.update_grouping,scope:this}};if(column_display_names!==undefined)
config.column_display_names=column_display_names;else
config.column_display_names=this.get_column_display_names();this.nested_grouping_dialog=this.new_component(SG.NestedGroupingDialog,config);},get_column_display_names:function(){var mode=this.get('mode');var content_widget=this.get_content_widget();if(content_widget instanceof SG.Widget.EntityQuery.GanttWrapper)
return content_widget.get_child('grid').get('column_display_names');else if(mode=='list')
return content_widget.get('column_display_names');else
return null;},destroy_nested_grouping_dialog:function(){if(this.nested_grouping_dialog){this.nested_grouping_dialog.destroy();this.nested_grouping_dialog=null;}},update_grouping:function(grouping){var mode=this.get('mode');var grp_setting=mode=='sched'?'pivot_grouping':'grouping';var g=sg_deep_copy(grouping);this.set(grp_setting,g);},mark_selected_read_by_current_user:function(menu,menu_item){var content_widget=this.get_content_widget();var ds=content_widget.get_entity_data_store();for(var i=0;i<this.selected_entities.length;i++){var rec=ds.get_record_by_id(this.selected_entities[i]);if(rec)
rec.set('read_by_current_user',menu_item.value);}
ds.commit();},on_toolbar_set_human_user_active:function(){this.set_human_user_status('act');},on_toolbar_set_human_user_disabled:function(){this.set_human_user_status('dis');},set_human_user_status:function(status){var content_widget=this.get_content_widget();var data_set=content_widget.get_entity_data_store();var ds=content_widget.get_entity_data_store();for(var i=0;i<this.selected_entities.length;i++){var rec=ds.get_record_by_id(this.selected_entities[i]);if(rec)
rec.set('sg_status_list',status);}
ds.commit();},on_menu_play_in_rv:function(menu,menu_item){var cfg={ids:this.selected_entities,mode:menu_item.value};var p=new SG.util.PlayInRV(cfg);},on_menu_cinesync_session:function(menu,menu_item){var paths=[];var data_store=menu_item.widget.get_entity_data_store();for(var i=0;i<this.selected_entities.length;i++){var rec=data_store.get_record_by_id(this.selected_entities[i]);paths.push({'name':rec.get('code'),'movie_path':rec.get('sg_uploaded_movie').url,'thumb_path':"/thumbnail/image/"+rec.get('image')});}
var p=new SG.util.PlayInCineSyncOnline({'versions':paths});},duplicate_selected:function(){var content_widget=this.get_content_widget();var entity_type=content_widget.context.get('entity_type');content_widget.show_loading_overlay();var config={entity_type:entity_type,selected_ids:this.selected_entities,parent_entity:content_widget.context.get('parent_entity'),callback:{fn:this.on_duplicate,scope:this}};new SG.util.EntityDuplicator(config);},duplicate_selected_templates:function(){var content_widget=this.get_content_widget();var entity_type=content_widget.context.get('entity_type');content_widget.show_loading_overlay();var config={template_ids:this.selected_entities,callback:{fn:this.on_duplicate,scope:this}};new SG.util.TaskTemplateDuplicator(config);},duplicate_selected_projects:function(){var content_widget=this.get_content_widget();content_widget.show_loading_overlay();var data_store=content_widget.get_entity_data_store();var ident_field=SG.schema.get_identifier_field('Project');var new_project_names=[];for(var i=0;i<this.selected_entities.length;i++){var id=this.selected_entities[i];var record=data_store.get_record_by_id(id);var proj_name=record.get(ident_field)+" (Copy)";new_project_names.push(proj_name);}
var config={duplicate_project_ids:this.selected_entities,duplicate_project_names:new_project_names,callback:{fn:function(){document.location=document.location;},scope:this}};var proj_dupe=new SG.util.ProjectDuplicator(config);},on_duplicate:function(){var content_widget=this.get_content_widget();content_widget.hide_loading_overlay();content_widget.reload_all_entities();},delete_selected_entities:function(e){var content_widget=this.get_content_widget();var entity_type=content_widget.context.get('entity_type');var ds=content_widget.get_entity_data_store();var i,rec;if(entity_type=='DisplayColumn'){var system_fields=[];for(i=0;i<this.selected_entities.length;i++){rec=ds.get_record_by_id(this.selected_entities[i]);var field_info=SG.schema.get_field(rec.get('entity_type'),rec.get('name'));if(field_info.field_type!='dynamic')
system_fields.push(SG.schema.entity_types[field_info.entity_type].display_name+" -> "+field_info.display_name);}
if(system_fields.length>0){new SG.MessageDialog({sg_dialog_header_text:"Can't Delete: System Fields Selected",html_msg:"Some selected fields are system fields that can't be deleted:<br><br>"+
system_fields.join('<br>')});return;}}
var forbidden_records=[];for(i=0;i<this.selected_entities.length;i++){rec=ds.get_record_by_id(this.selected_entities[i]);if(rec){if(!SG.schema.can_retire_record(rec))
forbidden_records.push(rec);}}
if(forbidden_records.length>0){var identifier_field=SG.schema.get_identifier_field(entity_type);var forbidden_identifiers=[];for(i=0;i<forbidden_records.length;i++){var identifier=forbidden_records[i].get(identifier_field);if(!identifier)
identifier=forbidden_records[i].get_id();forbidden_identifiers.push(identifier);}
var entity_name=SG.schema.entity_types[entity_type].display_name;new SG.MessageDialog({sg_dialog_header_text:"Can't Delete: Permission Restrictions",html_msg:"Some selected "+entity_name.pluralize(2)+" can't be deleted because of permission restrictions.<br><br>Restricted "+
entity_name.pluralize(forbidden_identifiers.length)+": "+forbidden_identifiers.join(', ')});return;}
if(entity_type=='Status'){for(i=0;i<this.selected_entities.length;i++){rec=ds.get_record_by_id(this.selected_entities[i]);var short_code=rec.get('code');var problems=[];var et;for(et in SG.schema.entity_fields){if(SG.schema.entity_fields.hasOwnProperty(et)){var field_name,schema_field;var schema_fields=SG.schema.entity_fields[et];for(field_name in schema_fields){if(schema_fields.hasOwnProperty(field_name)){schema_field=schema_fields[field_name];if(schema_field.data_type!='status_list')continue;var list=schema_field.status_list_subset;if(!list)continue;if(list.indexOf(short_code)!=-1){var edn=SG.schema.entity_types[et].display_name;var msg='The "'+schema_field.display_name+'" field on the '+
edn+' entity.';problems.push(msg);}}}}}
if(problems.length>0){var html_msg='The Status "'+rec.get('name')+'" can not be deleted. It is in use by the '+'following fields: <br><br> '+problems.join('<br>')+'<br><br>Please go remove '+'this status from those fields first before deleting.';new SG.MessageDialog({sg_dialog_header_text:"Can't Delete the Status "+'"'+rec.get('name')+'"',html_msg:html_msg});return;}}}
var conf_str='Delete selected?';if(!confirm(conf_str))
return;content_widget.show_loading_overlay();for(i=0;i<this.selected_entities.length;i++){rec=ds.get_record_by_id(this.selected_entities[i]);if(rec)rec.retire();}
ds.commit();this.update_filter_panel();this.selection_manager.clear_selection();},import_entities:function(){var widget=this.get_content_widget();var mode=this.get('mode');var column_display_names=(mode=='list'?this.get_column_display_names():{});var config={entity_type:this.get_content_widget_entity_type(),single_project:widget.single_project_from_context(),column_display_names:column_display_names,parent_entity:widget.context.get('parent_entity')};var importer=new SG.Importer(config);},update_tasks_from_template:function(){var widget=this.get_content_widget();var ds=widget.get_entity_data_store();var rec=ds.get_record_by_id(this.selected_entities[0]);var context={record:rec,widget:widget};new SG.util.UpdateTasks(context);},create_new_entity:function(){var content_widget=this.get_content_widget();var context={entity_type:content_widget.context.get('entity_type'),parent_entity:content_widget.context.get('parent_entity'),data_record:content_widget.get_new_entity_defaults_from_context()};if(!context.parent_entity){context.parent_entity=content_widget.context.get('entity');}
var factory=new SG.EntityFactory(context);this.add_event(factory,"done",this.display_new_entity_form);factory.create();},display_new_entity_form:function(data_record){var content_widget=this.get_content_widget();var nef_config={entity_type:data_record.type,single_project:content_widget.single_project_from_context()||data_record.get('project'),all_projects:content_widget.context_projects(),source_record:data_record,parent_entity:content_widget.context.get('parent_entity'),allow_keep_form_open:true};var nef=sg_new_entity_dialog(nef_config);this.add_event(nef,"entity_created",this.on_new_entity_created);},on_new_entity_created:function(new_entities){var new_entity;if(new_entities&&new_entities.length>0)
new_entity=new_entities[0];else
return;var content_widget=this.get_content_widget();if(new_entity.type=='Page'){setTimeout(function(){setCookie("design_page_on_load",new_entity.id,365);content_widget.show_loading_overlay();var current_url=window.location;var new_url=current_url.protocol+'//'+current_url.host+'/page/'+new_entity.id;window.location=new_url;},0);}else{content_widget.reload_all_entities();}},on_contextmenu:function(e){var menu=SG.Menu.get_menu(this.context_menu_id);if(!menu){menu=this.new_component(SG.Menu,{id:this.context_menu_id,menu_class:'action_menu',before_show:{fn:function(the_menu){the_menu.items=this.get_action_menu_items(the_menu.target_elem,the_menu.position);the_menu.render();},scope:this}});}
menu.target_elem=Ext.get(e.target);menu.position={xy:e.getXY()};menu.show();},on_action_menu:function(e,toolbar_elem){this.action_menu_toolbar_div=toolbar_elem;var menu=SG.Menu.get_menu(this.action_menu_id);if(menu&&menu.is_showing()){menu.hide();return;}
if(!menu){menu=this.new_component(SG.Menu,{id:this.action_menu_id,menu_class:'action_menu',before_show:{fn:function(the_menu){the_menu.items=this.get_action_menu_items();the_menu.render();},scope:this}});}
menu.position={dom_elem:toolbar_elem.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.show();},on_grouping_menu:function(e,toolbar_elem){this.grouping_toolbar_elem=toolbar_elem;var menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_grouping_menu,scope:this}});var mode=this.get('mode');var content_widget=this.get_content_widget();this.grouping_menu_helper=new SG.util.GroupingMenuHelper({entity_type:this.get_content_widget_entity_type(),through_join_fields:content_widget.get_through_join_fields(),parent_entity:content_widget.context.get('parent_entity'),grouping_setting_callback:{fn:this.get_grouping_settings,scope:this},on_grouping_field:{fn:this.on_grouping_field_menu_item,scope:this},on_open_close_all_groups:{fn:this.open_close_all_groups,scope:this},on_advanced_grouping:{fn:this.show_nested_grouping_dialog,scope:this},column_display_names:this.get_column_display_names()});menu.render();menu.show();},get_grouping_settings:function(){var mode=this.get('mode');if(mode=='sched')
return this.get_clean_grouping_setting('pivot_grouping');else
return this.get_clean_grouping_setting('grouping');},set_grouping_settings:function(grouping){var mode=this.get('mode');var grouping_setting=mode=='sched'?'pivot_grouping':'grouping';this.set(grouping_setting,grouping);var group_setting=mode=='sched'?'pivot_group_settings':'group_settings';this.set(group_setting,{});if(this.nested_grouping_dialog&&!this.nested_grouping_dialog.__destroyed__){var grouping_for_dialog=grouping;if(grouping_for_dialog==false)
grouping_for_dialog=[null];this.nested_grouping_dialog.grouping=grouping_for_dialog;this.nested_grouping_dialog.render();}},on_before_show_grouping_menu:function(menu){menu.position={dom_elem:this.grouping_toolbar_elem.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=this.grouping_menu_helper.get_menu_items();menu.render();},open_close_all_groups:function(menu,item){var content_widget=this.get_content_widget();content_widget.toggle_all_groups(item.value);},on_grouping_field_menu_item:function(menu,item){if(item.value=="__ungroup__"||(item.checked&&item.no_ungrouping!=true))
this.set_grouping_settings(false);else
this.set_grouping_settings([item.value]);},get_action_menu_items:function(target_elem,xy){var content_widget=this.get_content_widget();if(this.get('mode')=="calendar"){return content_widget.get_action_menu_items(target_elem,xy);}
var sections=["cell","important","global_top","import_export","entity","mode","tank","custom","global_bottom"];var i,j,sec,fn,items={},menu_items=[];var selection_count=this.selected_entities.length;for(i=0;i<sections.length;i++){sec=sections[i];fn=this["get_"+sec+"_action_menu_items"];if(fn)
items[sec]=fn.call(this,target_elem,xy,selection_count);else
items[sec]=[];}
if(content_widget.get_action_menu_items)
content_widget.get_action_menu_items(items,target_elem,xy);var valid_sections=0;for(i=0;i<sections.length;i++){sec=sections[i];if(items[sec].length===0)continue;if(valid_sections>0)menu_items.push({line:true});for(j=0;j<items[sec].length;j++){menu_items.push(items[sec][j]);}
valid_sections++;}
return menu_items;},get_cell_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();var items=[];if(target_elem){var cell_info=SG.CellManager.find_target(target_elem);if(cell_info)
items=cell_info.cell.get_context_menu_items(cell_info,selection_count);}
return items;},get_important_action_menu_items:function(target_elem,xy,selection_count){if(target_elem)
return[];var entity_type=this.get_content_widget_entity_type();var disabled,items=[];if(this.linking_mode=='linkable_embedded'||this.linking_mode=='linking_window'){disabled=(!SG.schema.can_create_entity(entity_type));var entity_display_name=SG.schema.entity_types[entity_type].display_name;items.push({html:'Create New '+entity_display_name,item_selected:{fn:this.create_new_entity,scope:this},disabled:disabled});}
if(this.linking_mode=='linkable_embedded'){var dn=SG.schema.entity_types[this.get_entity_type()].display_name_pluralized;var parent_entity_type=this.context.get('entity').type;var pdn=SG.schema.entity_types[parent_entity_type].display_name;items.push({html:'Link '+dn+' to this '+pdn,item_selected:{fn:this.show_linking_focus_window,scope:this}});}
return items;},get_global_top_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();var allowed_types,disabled,fn,items=[];items.push({html:'Edit Selected...',item_selected:{fn:this.multi_edit_selected,scope:this},disabled:this.selected_entities.length===0,icon_name:'icon_edit'});allowed_types=SG.schema.entity_fields.Note.note_links.allowed_entity_types;if(allowed_types.indexOf(entity_type)!=-1||entity_type=='Task'){disabled=!SG.schema.can_create_entity('Note')||this.selected_entities.length===0;items.push({html:'Add Note to Selected...',item_id:'add_note_to_selected',disabled:disabled,record_ids:this.selected_entities,item_selected:{fn:this.on_create_new_linked_notes_menuitem,scope:this},icon_name:'add_note_icon'});}
allowed_types=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(allowed_types.indexOf(entity_type)!=-1){disabled=!SG.schema.can_create_entity('Task')||this.selected_entities.length===0;items.push({html:'Add Task to Selected...',item_id:'add_task_to_selected',disabled:disabled,record_ids:this.selected_entities,item_selected:{fn:this.on_create_new_linked_tasks_menuitem,scope:this},icon_name:'add_task_icon'});}
disabled=(['DisplayColumn','TaskTemplate','Attachment','Status','Page','Booking'].indexOf(entity_type)!==-1||!SG.schema.can_create_entity(entity_type)||this.selected_entities.length===0||entity_type.match(/Connection$/));fn={fn:this.duplicate_selected,scope:this};if(entity_type=="Project")
fn={fn:this.duplicate_selected_projects,scope:this};items.push({html:'Duplicate Selected',item_selected:fn,disabled:disabled});return items;},get_import_export_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();var items=[];var disabled=(SG.schema.non_importable_entity_types.indexOf(entity_type)!=-1||SG.schema.leftnav_page_entity_types.indexOf(entity_type)==-1||!SG.schema.can_create_entity(entity_type))||this.context.get('design_mode')||this.context.get('edit_mode');items.push({html:"Import "+SG.schema.entity_types[entity_type].display_name_pluralized,item_selected:{fn:this.import_entities,scope:this},icon_name:'icon_import_csv',disabled:disabled});var content_widget=this.get_content_widget();items.push({html:'Export All to Excel (csv)',disabled:!content_widget.request_csv_data,item_selected:{fn:content_widget.request_csv_data,scope:content_widget},icon_name:'icon_export_excel'});return items;},get_global_bottom_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();var disabled,items=[];var dn=SG.schema.entity_types[entity_type].display_name;if(this.selected_entities.length>1)
dn=SG.schema.entity_types[entity_type].display_name_pluralized;if(this.linking_mode=='linkable_embedded'){var parent_entity_type=this.context.get('entity').type;var pdn=SG.schema.entity_types[parent_entity_type].display_name;items.push({html:'Un-link Selected '+dn+' from this '+pdn,item_selected:{fn:this.unlink_selected_entities,scope:this},disabled:this.selected_entities.length===0});}
var can_retire=SG.schema.can_retire_entity(entity_type);if(entity_type=="Attachment"||SG.globals.custom_for=="laika"){disabled=!can_retire||this.selected_entities.length===0;}else{disabled=!can_retire||this.linking_mode=='linkable_embedded'||this.selected_entities.length===0;}
if(entity_type=='Project'){items.push({html:'Revert Project Configuration...',item_selected:{fn:this.revert_project_pages,scope:this},disabled:this.selected_entities.length===0,grp:300,icon_name:'icon_revert',order:1});}
items.push({html:'<span style="color:'+(disabled?'tomato':'red')+'">Delete Selected '+dn+'</span>',item_selected:{fn:this.delete_selected_entities,scope:this},disabled:disabled,grp:300,icon_name:'trash',order:2});return items;},get_entity_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();var html,disabled,items=[];if(entity_type=='Playlist'){items.push({html:'Launch Review Notes App',item_selected:{fn:this.start_notes_app,scope:this},disabled:(this.selected_entities.length!=1)||!SG.schema.can_create_entity("Note"),icon_name:'icon_Playlist'});}
if(entity_type=='Version'){disabled=this.selected_entities.length===0;if(SG.schema.leftnav_page_entity_types.indexOf('Playlist')>-1){items.push({html:'Add to Existing Playlist...',item_selected:{fn:this.show_version_playlist_linking_window,scope:this},disabled:disabled||!SG.schema.can_edit_field("Playlist","versions")});items.push({html:'Add to New Playlist...',item_selected:{fn:this.create_playlist_with_linked_versions,scope:this},disabled:disabled||!SG.schema.can_create_entity("Playlist")});}
if(SG.globals.preferences.enable_rv_integration=="yes"){if(entity_type=='Version'){items.push({html:'Play in RV',icon_name:'rv_play',value:'play',disabled:disabled,item_selected:{fn:this.on_menu_play_in_rv,scope:this}});items.push({html:'Compare in RV',icon_name:'rv_compare',value:'compare',disabled:disabled,item_selected:{fn:this.on_menu_play_in_rv,scope:this}});}}
if(SG.globals.preferences.enable_cinesync_online_integration&&entity_type=='Version'){var content_widget=this.get_content_widget();items.push({html:'Open in cineSync Online...',disabled:disabled,widget:content_widget,item_selected:{fn:this.on_menu_cinesync_session,scope:this}});}}
if(SG.schema.get_field(entity_type,'read_by_current_user')){items.push({html:'Mark Selected as Read',item_selected:{fn:this.mark_selected_read_by_current_user,scope:this},disabled:this.selected_entities.length===0,value:'read',icon_name:'icon_'+entity_type+'_'+'read'});items.push({html:'Mark Selected as Unread',item_selected:{fn:this.mark_selected_read_by_current_user,scope:this},disabled:this.selected_entities.length===0,value:'unread',icon_name:'icon_'+entity_type+'_'+'unread'});}
if(entity_type=='TaskTemplate'){disabled=this.selected_entities.length===0||!SG.schema.can_create_entity(entity_type);items.push({html:"Duplicate Selected Templates and Tasks",disabled:disabled,item_selected:{fn:this.duplicate_selected_templates,scope:this}});items.push({html:"Update entities with new tasks...",disabled:this.selected_entities.length!=1,item_selected:{fn:this.update_tasks_from_template,scope:this}});}
var work_day_disabled=this.context.get('design_mode')||this.context.get('inside_work_schedule_editor')||!SG.schema.can_create_entity('WorkDayRule');if(entity_type=='HumanUser'){html='Edit Selected '+SG.schema.entity_types[entity_type].display_name_pluralized+"'s Work Schedule...";items.push({html:html,disabled:work_day_disabled||this.selected_entities.length===0,icon_name:'icon_WorkSchedule',item_selected:{fn:this.edit_work_schedule,scope:this},grp:115,order:1});disabled=!SG.schema.can_edit_field('HumanUser','sg_status_list');items.push({html:'Activate User',icon_name:'icon_HumanUser',disabled:disabled||this.selected_entities.length===0,item_selected:{fn:this.on_toolbar_set_human_user_active,scope:this}});items.push({html:'Disable User',icon_name:'icon_HumanUserDisabled',disabled:disabled||this.selected_entities.length===0,item_selected:{fn:this.on_toolbar_set_human_user_disabled,scope:this}});}
if(entity_type=='Project'){html='Edit Selected '+SG.schema.entity_types[entity_type].display_name+"'s Work Schedule...";items.push({html:html,disabled:work_day_disabled||this.selected_entities.length===0,icon_name:'icon_WorkSchedule',item_selected:{fn:this.edit_work_schedule,scope:this}});}
if(entity_type=='Task'){var dependency_actions=new SG.util.DependencyActions(this.get_content_widget());items.push(dependency_actions.get_menu_item());var sub_items=[{html:'Edit Work Schedule',item_selected:{fn:this.edit_work_schedule,scope:this},value:'default',disabled:work_day_disabled||this.selected_entities.length===0},{html:"Edit Assigned People's Work Schedule",item_selected:{fn:this.edit_work_schedule,scope:this},value:'assigned_users',disabled:work_day_disabled||!this.task_has_assignees(this.selected_entities)}];items.push({html:"Work Schedule",disabled:work_day_disabled||this.selected_entities.length===0,icon_name:'icon_WorkSchedule',submenu:{items:sub_items}});}
return items;},get_custom_action_menu_items:function(target_elem,xy,selection_count){var entity_type=this.get_content_widget_entity_type();if(entity_type=='DisplayColumn')
return[];var item,items=[];for(var i=0;i<SG.globals.action_menu_items.length;i++){item=SG.globals.action_menu_items[i];if(item.entity_type==null||item.entity_type==entity_type){items.push({html:item.title,url:item.url,order:item.order||1,disabled:item.selection_required&&this.selected_entities.length===0,selection_required:item.selection_required,item_selected:{fn:this.on_custom_external_action,scope:this}});}}
items.sort(function(a,b){return a.order-b.order;});return items;},get_tank_action_menu_items:function(target_elem,xy,selection_count){if(!sg_tank_enabled())return[];if(!this.tank_action_menu){this.tank_action_menu=this.new_component(SG.TankActionMenu);}
var entity_type=this.get_content_widget_entity_type();var ds=this.get_content_widget().get_entity_data_store();var i,rec,rec_project_id;var project_ids=[];for(i=0;i<this.selected_entities.length;i++){rec=ds.get_record_by_id(this.selected_entities[i]);rec_project_id=rec.get("project")?rec.get("project").id:null;if(project_ids.indexOf(rec_project_id)===-1)
project_ids.push(rec_project_id);}
return this.tank_action_menu.get_items(entity_type,this.selected_entities,project_ids);},on_create_new_linked_notes_menuitem:function(menu,menu_item){var content_widget=this.get_content_widget();var config={widget:content_widget,record_ids:menu_item.record_ids,data_set:content_widget.get_entity_data_store(),pivot_field:menu_item.pivot_field,context_entity:this.context.get('entity')};var adts=new SG.util.AddNoteToSelected(config);},on_create_new_linked_tasks_menuitem:function(menu,menu_item){var content_widget=this.get_content_widget();var config={widget:content_widget,record_ids:menu_item.record_ids,data_set:content_widget.get_entity_data_store(),pivot_field:menu_item.pivot_field,context_entity:this.context.get('entity')};var adts=new SG.util.AddTaskToSelected(config);},start_notes_app:function(){SG.NotesApp.show({playlist_id:this.selected_entities[0]});},render_mode_switcher:function(){var i;var mode_links_html="";var mode=this.get('mode');var modes=['list','card','thumb','calendar','sched'];var mode_tips=['List View','Card View','Thumbnail View','Calendar View','Task View'];var mode_states=['off','off','off','off','off'];var inside_window=this.context.get('inside_window');for(i=0;i<modes.length;i++){if((this.linking_mode=='linking_window'&&modes[i]!='list')||(inside_window&&modes[i]=='card'))
{mode_tips[i]='Disabled: '+mode_tips[i];mode_states[i]='disabled';}}
var entity_type=this.get_entity_type();var mode_helper=new SG.util.EntityQueryModeHelper();for(var i=0;i<modes.length;i++){if(mode_helper.disabled(entity_type,modes[i])){mode_tips[i]='Disabled: '+mode_tips[i];mode_states[i]='disabled';}}
for(i=0;i<modes.length;i++){var state=(modes[i]==mode?"on":mode_states[i]);var url=SG.globals.icons.QueryPageMode[modes[i]][state];mode_links_html+=this.templates.mode_link.apply({icon_class:'icon_mode_'+modes[i]+'_'+state,mode:modes[i],tooltip:mode_tips[i],extra_class:'mode_'+state});}
return mode_links_html;},on_mode_switcher_click:function(click_event){var target_dom=click_event.getTarget();if(target_dom.hasAttribute('query_mode')){if(!Ext.fly(target_dom).hasClass('mode_disabled')){var new_mode=target_dom.getAttribute('query_mode');var eqw=this;setTimeout(function(){eqw.set_mode(new_mode);},1);}}},combined_filters:function(){var filters=sg_deep_copy(this.get_filters());if(this.filter_panel_filters)
filters.conditions.push(this.filter_panel_filters);return filters;},combined_pivot_filters:function(){var filters=sg_deep_copy(this.get_pivot_filters());if(this.sched_mode_filter_panel_filters)
filters.conditions.push(this.sched_mode_filter_panel_filters);return filters;},update_combined_filters:function(){this.selection_manager.clear_selection();this.update_dynamically_detected_positions();var content_widget=this.get_content_widget();var content_widget_name=this.content_name();content_widget.context.set('filters',this.combined_filters());if(content_widget_name=='sched_content')
content_widget.context.set('pivot_filters',this.combined_pivot_filters());},get_clean_grouping_setting:function(setting){var entity_type=setting=='pivot_grouping'?'Task':this.get_entity_type();var grouping=this.get(setting);var clean_grouping=[];for(var i=0;i<grouping.length;i++){var group=grouping[i];var schema_field=SG.schema.get_field(entity_type,group.column);if(schema_field!=null&&!schema_field.no_grouping)
clean_grouping.push(group);}
if(clean_grouping.length===0)
return false;else
return clean_grouping;},render_empty_message:function(entity_type,container){var entities=SG.schema.entity_types[entity_type].display_name_pluralized;var message_text,trigger_class,trigger_text;var linking=(this.linking_mode=='linkable_embedded'&&entity_type==this.get_entity_type());if(linking){var parent_type=SG.schema.entity_types[this.parent_entity.type].display_name;message_text='No '+entities+' linked to this '+parent_type+'.';trigger_text='Link '+entities;trigger_class='link_entities';}else{var entity=SG.schema.entity_types[entity_type].display_name;message_text='No '+entities+' match your search.';trigger_text='Create new '+entity;trigger_class='create_new_entity';}
var empty_message=this.get('empty_message');if(empty_message!=null)
message_text=this.replace_entity_name_in_static_text(entity_type,empty_message);var trigger='';if(empty_message==null&&SG.schema.can_create_entity(entity_type)&&entity_type!='Booking'&&entity_type!="DisplayColumn")
{trigger=this.templates.empty_content_trigger.apply({trigger_class:trigger_class,trigger_text:trigger_text});}
container.update(this.templates.empty_content_message.apply({message:message_text,trigger:trigger}));if(trigger!=''){if(linking){var link_entity_link=Ext.get(Ext.DomQuery.selectNode('span.link_entities',container.dom));link_entity_link.on('click',this.show_linking_focus_window,this);}else{var new_entity_link=Ext.get(Ext.DomQuery.selectNode('span.create_new_entity',container.dom));new_entity_link.on('click',this.create_new_entity,this);}}},create_playlist_with_linked_versions:function(){var content_widget=this.get_content_widget();var data_record=new SG.Data.Record('Playlist');var to_link=[];var version_projects=[];var version_project=null;var id,project;for(var i=0;i<this.selected_entities.length;i++){id=this.selected_entities[i];project=this.get_content_widget().get_entity_data_store().get_record_by_id(id).get('project');if(project&&version_projects.indexOf(project.id)==-1){version_projects.push(project.id);version_project=project;}
to_link.push({type:'Version',id:id,name:''});}
if(version_projects.length>1){var cd=new SG.MessageDialog({sg_dialog_header_text:'(!) Versions from Multiple Projects',html_msg:'Some of the selected Versions have different Projects.  '+'<div style="margin-top: 8px; margin-bottom: 8px;">Please select only '+'Versions from a single Project when linking to Playlists. '+'You can see the Project each Version is linked to by looking at the "Project" field.</div>'});return;}else if(version_projects.length===1){data_record.set('project',project);}
data_record.set('versions',to_link);var context={entity_type:'Playlist',data_record:data_record};var factory=new SG.EntityFactory(context);this.add_event(factory,"done",this.display_new_entity_form);factory.create();},on_custom_external_action:function(menu,item){var content_widget=this.get_content_widget();var content_widget_name=this.content_name();content_widget.show_loading_overlay();var req={};req.base_url=item.url;req.user_id=SG.globals.current_user.id;req.user_login=SG.globals.current_user.login;req.title=this.context.get('title');var entity_type=this.get_content_widget_entity_type();req.entity_type=entity_type;req.server_hostname=SG.globals.hostname;req.referrer_path=this.get_page().get_page_url();req.page_id=this.get_page().id;req.session_uuid=SG.globals.session_uuid;var project=this.single_project_from_context();if(project){req.project_name=project.name;req.project_id=project.id;}
req.ids="";req.selected_ids=this.selected_entities.join(',');req.cols=content_widget.get_custom_external_action_columns();req.column_display_names=[];var col;for(var i=0;i<req.cols.length;i++){col=req.cols[i];req.column_display_names.push(content_widget.get_custom_external_action_column_display_name(col));}
var sorts=content_widget.get_custom_external_action_sorts();if(sorts[0]&&sorts[0].column&&sorts[0].direction){req.sort_column=sorts[0].column;req.sort_direction=sorts[0].direction;}
var grouping=content_widget.get_grouping();if(grouping&&grouping.length>0){req.grouping_column=grouping[0].column;req.grouping_method=grouping[0].method;req.grouping_direction=grouping[0].direction;}
this.custom_external_action=req;if(item.selection_required){req.ids=req.selected_ids;this.custom_external_action_launch();}else{var filter_key=(content_widget_name=='sched_content')?'pivot_filters':'filters';var filters=sg_deep_copy(content_widget.context.get(filter_key));this.substitute_filter_tokens(filters);var data_set=this.new_data_set(entity_type,this.on_custom_external_action_load_data);this.custom_external_action_spec={result:data_set,type:entity_type,columns:[],filters:filters,sorts:content_widget.get_custom_external_action_sorts()};var ssf=this.get_server_side_filters();if(ssf)this.custom_external_action_spec.server_side_filters=ssf;this.custom_external_action_spec.current_page=1;this.custom_external_action_spec.records_per_page=500;var parent_entity=this.context.get('parent_entity');if(parent_entity)this.custom_external_action_spec.parent_entity=parent_entity;SG.Repo.query(this.custom_external_action_spec);}},on_custom_external_action_load_data:function(data_set){this.custom_external_action.ids+=data_set.get_ids().join(',');if(data_set.paging_info.current_page<data_set.paging_info.page_count){this.custom_external_action_spec.current_page+=1;this.custom_external_action.ids+=",";SG.Repo.query(this.custom_external_action_spec);return;}
this.custom_external_action_launch();},custom_external_action_launch:function(){var base_url=this.custom_external_action.base_url;delete this.custom_external_action.base_url;if(base_url.match(":")&&base_url.indexOf('http')!==0){document.location=base_url+"?"+Ext.urlEncode(this.custom_external_action);}else{var form=Ext.get("custom_request_form").dom;var ff,key;Ext.fly(form).update("");form.action=base_url;for(key in this.custom_external_action){if(this.custom_external_action.hasOwnProperty(key)){ff=document.createElement("INPUT");ff.type="hidden";ff.name=key;ff.value=this.custom_external_action[key];form.appendChild(ff);}}
form.submit();}
var content_widget=this.get_content_widget();content_widget.hide_loading_overlay();},edit_work_schedule:function(menu,menu_item){var entity_type=this.get_content_widget_entity_type();var entities=[];if(entity_type=='Task'){if(menu_item.value=='assigned_users'){entity_type='HumanUser';var content_widget=this.get_content_widget();var ds=content_widget.get_entity_data_store();for(var i=0;i<this.selected_entities.length;i++){var id=this.selected_entities[i];var record=ds.get_record_by_id(id);var assignees=record.get('task_assignees');if(!assignees)continue;for(var j=0;j<assignees.length;j++)
entities.push(assignees[j].id);}}else{entity_type=null;entities=[];}}else{entities=this.selected_entities;}
new SG.WorkScheduleOverlay({entity_type:entity_type,selected_entities:entities,entity_query_page:this});},work_schedule_changed:function(){if(this.get_content_widget().work_schedule_changed)
this.get_content_widget().work_schedule_changed();},task_has_assignees:function(selected_entities){var i,r,enabled=false;var ds=this.get_content_widget().get_entity_data_store();for(i=0;i<selected_entities.length;i++){r=ds.get_record_by_id(selected_entities[i]);if(r.get('task_assignees').length>0)return true;}
return false;},get_list_mode_columns_from_child_spec:function(){return this.widget_spec.child_specs.list_content.settings.columns||[];},revert_project_pages:function(){var dialog=new SG.PushProjectPagesDialog({target_project_ids:this.selected_entities,source_project_id:null});},});SG.Widget.EntityQuery.GanttWrapper=function(context,widget_spec,id)
{SG.Widget.EntityQuery.GanttWrapper.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityQuery.GanttWrapper,SG.Widget.EntityQueryMode,{default_settings:{grid_width:0.5,gantt_stowed:false},min_grid_width:.1,max_grid_width:.9,init_children:function()
{var grid_context=this.context.clone();this.grid_widget=this.construct_child('grid',grid_context);var gantt_context=this.context.clone();gantt_context.set('grid_widget',this.grid_widget);gantt_context.set('stowed',this.get('gantt_stowed'));this.gantt_widget=this.construct_child('gantt',gantt_context);this.add_event(this,"context_changed",this.on_context_changed);this.add_event(this.grid_widget,'body_rendered',this.hide_loading_overlay);},get_entity_data_store:function()
{return this.grid_widget.get_entity_data_store();},set_data_store_max_records:function(num_recs)
{this.grid_widget.set_data_store_max_records(num_recs);},set_data_store_page:function(page_num)
{this.grid_widget.set_data_store_page(page_num);},reload_all_entities:function()
{this.grid_widget.reload_all_entities();},get_action_menu_items:function(items,target_elem,xy)
{this.grid_widget.get_action_menu_items(items,target_elem,xy);this.gantt_widget.get_action_menu_items(items,target_elem,xy);},get_toolbar_items:function()
{var grid_items=this.grid_widget.get_toolbar_items();var gantt_items=this.gantt_widget.get_toolbar_items();return grid_items.concat(gantt_items);},multi_edit_selected:function()
{this.grid_widget.multi_edit_selected();},on_context_changed:function(key,value)
{this.grid_widget.context.set(key,value);},get_required_columns:function()
{return['start_date','due_date','duration','sg_status_list','color','task_assignees','milestone','project'];},toggle_all_groups:function(state)
{this.grid_widget.toggle_all_groups(state);},_get_entity_type_and_filters_from_context:function()
{return this.grid_widget._get_entity_type_and_filters_from_context();},render:function()
{this.container=this.get_container();var dh=Ext.DomHelper;var grid_width=this.get_grid_width_in_pixels();var s='right: '+(this.container.getWidth()-grid_width)+'px;';this.grid_div=dh.append(this.container,{tag:'div',id:this.grid_widget.get_container_id(),cls:this.grid_widget.get_css_class_name(),style:s},true);s='left: '+grid_width+'px;';this.gantt_div=dh.append(this.container,{tag:'div',id:this.gantt_widget.get_container_id(),cls:this.gantt_widget.get_css_class_name(),style:s},true);this.add_event(this.grid_div,'scroll',this.on_grid_scroll);var me=this;this.load_proxy=function(e){me.on_thumbnail_load.call(me,e)};this.grid_div.dom.addEventListener('load',this.load_proxy,true);this.drag_div=dh.append(this.container,{tag:'div',cls:'gantt_drag_div',style:s,sg_tip:'Double click to unstow Gantt display'},true);this.drag_zone=new SG.GanttDragZone(this.drag_div,this);this.add_event(this.drag_div,"dblclick",this.on_drag_div_dblclick);Ext.EventManager.onWindowResize(this.on_window_resize,this);SG.NotificationCenter.add_observer({uuid:'_sg_sidenav_',name:'sidenav_changed',callback:{fn:this.on_window_resize,scope:this}});this.add_event(this.grid_widget,"group_opened",this.on_grid_group_opened);this.add_event(this.grid_widget,"group_closed",this.gantt_widget.on_grid_group_closed,this.gantt_widget);this.add_event(this.grid_widget,"grid_empty",this.on_grid_empty);this.add_event(this,"settings_changed",this.on_settings_changed);this.grid_widget.render();this.gantt_widget.render();if(this.get('gantt_stowed'))
this.stow_away_gantt();var gantt_scroll=this.get_gantt_scroll_div();this.add_event(gantt_scroll,'scroll',this.on_gantt_scroll);},on_thumbnail_load:function(e)
{var target=Ext.get(e.target);var thumb=target.findParent('img.thumb',this.grid_div);if(thumb)
this.gantt_widget.on_grid_thumbnail_loaded();},on_grid_empty:function()
{this.set('gantt_stowed',true);},on_grid_group_opened:function()
{var scroll_restore=this.gantt_div.dom.scrollTop;this.gantt_widget.render_widget();this.gantt_div.dom.scrollTop=scroll_restore;},on_window_resize:function(e)
{if(!this.get('gantt_stowed'))
{var grid_width=this.get_grid_width_in_pixels();this.drag_div.setLeft(grid_width);this.gantt_div.setLeft(grid_width);this.grid_div.setRight(this.container.getWidth()-grid_width);}},get_grid_width_in_pixels:function(percent)
{if(percent==undefined)
percent=this.get('grid_width');var cw=this.get_container().getWidth();return Math.round(percent*cw);},get_grid_width_in_percent:function(grid_width_in_pixels)
{var cw=this.get_container().getWidth();var percent=grid_width_in_pixels/cw;return percent;},on_settings_changed:function(change_hash,source_widget)
{if('gantt_stowed'in change_hash&&source_widget==this)
{if(this.get('gantt_stowed'))
this.stow_away_gantt();else
this.unstow_away_gantt();}},stow_away_gantt:function(e)
{var scroll=this.gantt_div.dom.scrollTop;this.gantt_widget.context.set('stowed',true);this.gantt_div.setVisible(false);this.grid_div.setRight(9);this.drag_div.dom.setAttribute('style','');this.grid_div.addClass('gantt_stowed');this.gantt_div.addClass('gantt_stowed');this.drag_div.setRight(0);this.drag_div.set({sg_tip:'Double click to unstow Gantt display'});this.grid_div.dom.scrollTop=scroll;},unstow_away_gantt:function(e)
{var scroll=this.grid_div.dom.scrollTop;this.gantt_widget.context.set('stowed',false);this.gantt_div.setVisible(true);var scroll_restore=this.grid_div.dom.scrollTop;this.drag_div.dom.setAttribute('style','');var grid_width=this.get_grid_width_in_pixels();this.drag_div.setLeft(grid_width,true);this.gantt_div.setLeft(grid_width,true);this.grid_div.setRight(this.container.getWidth()-grid_width,true);this.grid_div.removeClass('gantt_stowed');this.gantt_div.removeClass('gantt_stowed');this.gantt_widget.unstow_yourself();this.gantt_div.scrollTo('top',scroll_restore,false);this.drag_div.set({sg_tip:'Double click to stow Gantt display'});this.gantt_div.dom.scrollTop=scroll;},on_drag_div_dblclick:function(e)
{var gantt_stowed=this.get('gantt_stowed');this.set('gantt_stowed',!gantt_stowed);},on_gantt_scroll:function(e)
{if(!this.get('gantt_stowed'))
{var gantt_scroll=this.get_gantt_scroll_div();if(this.grid_div.dom.scrollTop!=gantt_scroll.dom.scrollTop)
this.grid_div.dom.scrollTop=gantt_scroll.dom.scrollTop;}},on_grid_scroll:function(e)
{if(!this.get('gantt_stowed'))
{var gantt_scroll=this.get_gantt_scroll_div();if(gantt_scroll.dom.scrollTop!=this.grid_div.dom.scrollTop)
gantt_scroll.dom.scrollTop=this.grid_div.dom.scrollTop;}},get_gantt_scroll_div:function()
{if(!this.gantt_scroll_div)
this.gantt_scroll_div=this.gantt_div.child('div.scroll_wrapper');return this.gantt_scroll_div;},update_dynamically_detected_positions:function()
{if(this.drag_div&&!this.get('gantt_stowed'))
{var grid_width=this.get_grid_width_in_pixels();this.drag_div.setLeft(grid_width,true);this.gantt_div.setLeft(grid_width,true);this.grid_div.setRight(this.container.getWidth()-grid_width,true);}},on_splitter_changed:function()
{var new_grid_width=this.drag_div.getLeft(true);this.grid_div.setRight(this.container.getWidth()-new_grid_width);this.gantt_div.setLeft(new_grid_width);var per=this.get_grid_width_in_percent(new_grid_width);var scroll=this.gantt_div.dom.scrollTop;if(this.get('gantt_stowed'))
{if(per<this.min_grid_width||per>this.max_grid_width)
{if(per<this.min_grid_width)
per=this.min_grid_width;else
per=this.max_grid_width;new_grid_width=this.get_grid_width_in_pixels(per);this.drag_div.setLeft(new_grid_width,true);this.gantt_div.setLeft(new_grid_width,true);this.grid_div.setRight(this.container.getWidth()-new_grid_width);}
this.set({grid_width:per,gantt_stowed:false});return;}
else if(per>this.max_grid_width)
{this.set({grid_width:this.max_grid_width,gantt_stowed:true});return;}
else if(per<this.min_grid_width)
{per=this.min_grid_width;new_grid_width=this.get_grid_width_in_pixels(per);this.drag_div.setLeft(new_grid_width,true);this.gantt_div.setLeft(new_grid_width,true);this.grid_div.setRight(this.container.getWidth()-new_grid_width);this.set({grid_width:per,gantt_stowed:false});}
else
{this.set('grid_width',per);this.gantt_div.dom.scrollTop=scroll;}
this.gantt_widget.on_gantt_grid_splitter_moved();},get_custom_external_action_columns:function()
{return this.grid_widget.get_columns();},get_custom_external_action_column_display_name:function(col)
{return this.grid_widget.get_column_display_name(col);},get_custom_external_action_sorts:function()
{return this.grid_widget.get_sorts();},entity_selection_changed:function(selected_entities)
{if(this.gantt_widget.entity_selection_changed)
this.gantt_widget.entity_selection_changed(selected_entities);},work_schedule_changed:function()
{this.reload_all_entities();this.gantt_widget.read_work_day_rules();},request_csv_data:function()
{this.grid_widget.request_csv_data();},destroy_widget:function()
{Ext.EventManager.removeResizeListener(this.on_window_resize,this);}});SG.GanttDragZone=function(drag_div,gantt_wrapper_widget)
{this.drag_div=drag_div;this.gantt_wrapper_widget=gantt_wrapper_widget;var config={resizeFrame:false,scroll:false};SG.GanttDragZone.superclass.constructor.call(this,this.drag_div,"rows",config);this.setYConstraint(0,0);};Ext.extend(SG.GanttDragZone,Ext.dd.DD,{b4StartDrag:function(x,y)
{this.resetConstraints();this.setYConstraint(0,0);SG.GanttDragZone.superclass.b4StartDrag.call(this,x,y);this.drag_div.addClass('dragging');},endDrag:function(e)
{SG.GanttDragZone.superclass.endDrag.apply(this,arguments);this.gantt_wrapper_widget.on_splitter_changed();this.drag_div.removeClass('dragging');},});SG.Widget.EntityQuery.NewGantt=function(context,widget_spec,id)
{SG.Widget.EntityQuery.NewGantt.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.EntityQuery.NewGantt,SG.Widget.EntityQueryMode,{default_settings:{major_unit:'week',group_bar_color:'129,129,129',display_group_bars:true,display_project_dates:true,left_fields:[],right_fields:[]},length_of_a_day_in_pixels:{week:32,month:16,month_weeks:5,quarter:2,year:1},templates:{main:'<div class="scroll_wrapper"><div class="large_scroll_container"></div></div>'+'<canvas class="background" width="{canvas_width}" height="{canvas_height}"></canvas>'+'<canvas class="markers" width="{canvas_width}" height="{canvas_height}"></canvas>'+'<canvas class="lines" width="{canvas_width}" height="{canvas_height}"></canvas>'+'<canvas class="selection" width="{canvas_width}" height="{canvas_height}"></canvas>'+'<canvas class="bar" width="{canvas_width}" height="{canvas_height}"></canvas>'+'<div class="drag_marker"></div><div class="color_edit_container"></div>',day_off_tooltip:'<table class="day_off_tooltip">'+'<tr><td class="label">{rule_type_name}:</td><td class="value">{off_day}</td></tr>'+'<tr><td class="label">Description:</td><td class="value">{description}</td></tr>'+'<tr><td class="label">Work Schedule:</td><td class="value">{work_schedule}</td></tr></table>'+'{click_prompt}',mixed_rule_day:'<div>This is a work day for some people assigned</div><div>to this Task, but not '+'for others.  Details:</div>{rules}{click_prompt}',day_off_tooltip_click_prompt:'<div class="click_prompt">Double click to edit work schedule.</div>',browser_warning_message:'<div class="browser_warning_overlay">{message}'+'<img class="close_browser_warning_overlay" src="/images/close_overlay_x.png"></div>',toolbar_button_pair:'<div class="mode_button {left_class}"></div><div class="mode_button {right_class}"></div>',zoom_slider:'<div class="gantt_zoom_slider {mode} {id}">'+'<div class="small_icon"></div><div class="left_cap"></div><div class="middle"></div>'+'<div class="right_cap"></div><div class="large_icon"></div>'+'<div class="knob slider_gripoff"></div></div>',toolbar_button:'<div class="toolbar_button {extra}">'+'<div class="{left_class}"></div>{label}<div class="right"></div></div>',},on_first_render:function()
{this.container=this.get_container();this.session_time_bounds=null;this.last_scroll_date=null;this.calc_browser_scroll_bar_width();this.canvas_width=this.container.getWidth();this.canvas_height=this.container.getHeight();this.container.update(this.templates.main.apply({canvas_width:this.canvas_width,canvas_height:this.canvas_height}));this.view_port={l:0,r:this.canvas_width,t:0,b:this.canvas_height};this.bg_canvas=this.container.child('canvas.background');this.marker_canvas=this.container.child('canvas.markers');this.line_canvas=this.container.child('canvas.lines');this.sel_canvas=this.container.child('canvas.selection');this.bar_canvas=this.container.child('canvas.bar');this.bg_ctx=this.bg_canvas.dom.getContext("2d");this.marker_ctx=this.marker_canvas.dom.getContext("2d");this.line_ctx=this.line_canvas.dom.getContext("2d");this.sel_ctx=this.sel_canvas.dom.getContext("2d");this.bar_ctx=this.bar_canvas.dom.getContext("2d");this.all_ctx=[this.bg_ctx,this.marker_ctx,this.sel_ctx,this.line_ctx,this.bar_ctx];this.canvases=[this.bg_canvas,this.marker_canvas,this.line_canvas,this.sel_canvas,this.bar_canvas];this.scroll_wrapper=this.container.child('div.scroll_wrapper');this.add_event(this.scroll_wrapper,"scroll",this.on_scroll);this.scroll_container=this.container.child('div.large_scroll_container');this.scroll_container.setStyle({width:this.canvas_width+'px',height:this.canvas_height+'px'});Ext.EventManager.onWindowResize(this.on_window_resize,this);if(SG.schema.can_create_entity('WorkDayRule'))
this.add_event(this.container,"dblclick",this.on_dblclick);this.add_event(this.container,"click",this.on_click);this.add_event(Ext.get(document.body),'mousedown',this.on_mousedown);this.grid_widget=this.context.get('grid_widget');this.add_event(this.grid_widget,'groups_toggled',this.on_grid_rendered);this.add_event(this.grid_widget,'body_rendered',this.on_grid_rendered);this.grid_ds=this.grid_widget.data_set;this.add_event(this.grid_ds,'load',this.on_grid_data_load);this.add_event(this.grid_ds,'change',this.on_grid_data_change);this.add_event(SG.schema,'column_changed',this.on_load_fields);this.add_event(SG.schema,'column_removed',this.on_load_fields);this.add_event(SG.schema,'reloaded',this.on_load_fields);this.work_day_rules_ds=this.new_data_set('WorkDayRule',this.on_load_work_day_rules);this.project_ds=this.new_data_set('Project',this.on_load_project_dates);this.task_dependency_ds=this.new_data_set('TaskDependency',this.on_load_task_dependencies,this.on_task_dependencies_change);this.gantt_ds=this.new_data_set('Task',this.on_load_fields);this.color_editable=SG.schema.can_edit_field('Task','color');this.is_ff_3=false;var ua=navigator.userAgent.toLowerCase();if(ua)
{var index=ua.indexOf('firefox');var substr=ua.substring(index+8,ua.length-1);if(index!==-1&&substr.indexOf('3.0')==0)
{this.is_ff_3=true;this.show_browser_warning_message();}}
this.click_selector=this.new_component(SG.NewGanttSelection,{container:this.container,find_area_callback:{fn:this.find_selection_area,scope:this},coordinate_callback:{fn:this.to_area_coordinates,scope:this},gantt:this,});var bars_dragable=(SG.schema.can_edit_field('Task','start_date')&&SG.schema.can_edit_field('Task','due_date'));this.tooltip_handler=this.new_component(SG.NewGanttTooltips,{container:this.container,find_area_callback:{fn:this.find_tooltip_area,scope:this},gantt_widget:this,});this.gantt_bar_drag=this.new_component(SG.NewGanttDragHandler,{container:this.container,scroll_container:this.scroll_wrapper,selection_area_callback:{fn:this.find_selection_area,scope:this},dragable_area_callback:{fn:this.find_dragable_area,scope:this},coordinate_callback:{fn:this.to_area_coordinates,scope:this},click_selector:this.click_selector,gantt:this,no_bar_drag:!bars_dragable,tooltip_handler:this.tooltip_handler});this.thumbnail_load_count=0;SG.NotificationCenter.add_observer({uuid:'_sg_sidenav_',name:'sidenav_changed',callback:{fn:this.on_window_resize,scope:this}});SG.NotificationCenter.add_observer({uuid:'_sg_focus_window_resized_',name:'focus_window_resized',callback:{fn:this.on_window_resize,scope:this}});this.set_canvas_visibility();this.setup_zoom_slider();},dragging:function()
{return this.gantt_bar_drag.dragging;},show_browser_warning_message:function()
{var cookie=getCookie("gantt_browser_warning_message");if(cookie)return;Ext.DomHelper.append(this.container,this.templates.browser_warning_message.apply({message:this.get_browser_warning_message_text()}));setCookie("gantt_browser_warning_message",true,1);},get_browser_warning_message_text:function()
{var text="Hey "+SG.globals.current_user.display_name+", we updated the gantt pane "+"in 2.1 to be better and faster , but a side effect is that your browser version "+"does not support rendering text next to the gantt bars. Version up to see the "+"goodness!";return text;},unstow_yourself:function()
{this.read_data();},on_gantt_grid_splitter_moved:function()
{this.on_window_resize();},on_window_resize:function()
{var width=this.container.getWidth();var height=this.container.getHeight();var keep_this=this.last_scroll_date.clone();this.scroll_container.setStyle({width:width+'px',height:height+'px'});this.set_canvas_dimensions();this.regenerate_all_areas();this.view_port.r=this.view_port.l+width;this.last_scroll_date=keep_this;this.restore_scroll();if(this.scroll_wrapper.dom.scrollLeft==0)
this.render_widget();},set_canvas_dimensions:function()
{this.canvas_width=this.get_canvas_width();this.canvas_height=this.get_canvas_height();var last_width=this.bg_canvas.dom.getAttribute('width');var last_height=this.bg_canvas.dom.getAttribute('height');if(this.canvas_width==last_width&&this.canvas_height==last_height)
return;for(var i=0;i<this.canvases.length;i++)
{var canvas=this.canvases[i];canvas.dom.setAttribute('width',this.canvas_width);canvas.dom.setAttribute('height',this.canvas_height);}},get_canvas_width:function()
{var w=this.container.getWidth();if(this.scroll_wrapper.dom.scrollHeight>this.scroll_wrapper.dom.clientHeight)
w-=this.browser_scroll_bar_width;return w;},get_canvas_height:function()
{var h=this.container.getHeight();if(this.scroll_wrapper.dom.scrollWidth>this.scroll_wrapper.dom.clientWidth)
h-=this.browser_scroll_bar_width;return h;},entity_selection_changed:function(selected_entities)
{this.select_and_electrify_areas();this.render_widget();},select_and_electrify_areas:function()
{var i;if(this.line_areas)
{for(i=0;i<this.line_areas.length;i++)
this.line_areas[i].electrified=false;}
if(!this.graphic_areas)return;this.selection_intervals={};var to_electrify=[];for(var i=0;i<this.graphic_areas.length;i++)
{var area=this.graphic_areas[i];if(!area.record)
{area.selected=this.in_selection_cache(area.group_idx);continue;}
area.electrified=false;var selected=this.in_selection_cache(area.group_idx,area.record.id);area.selected=selected;if(selected)
{to_electrify.push(area);}}
for(var i=0;i<to_electrify.length;i++)
this.electrify_chain(to_electrify[i]);},render_widget:function()
{if(!this.grid_ds.is_loaded())return;var ctx,i;for(i=0;i<this.all_ctx.length;i++)
{ctx=this.all_ctx[i];ctx.clearRect(0,0,this.canvas_width,this.canvas_height);ctx.save();ctx.translate(-this.view_port.l,-this.view_port.t);}
this.active_tooltip_areas=[];this.active_selection_areas=[];this.active_dragable_areas=[];this.render_background();this.render_selection_bars();this.render_bars();this.render_header();this.render_dependency_lines();this.render_header_selection_intervals();for(i=0;i<this.all_ctx.length;i++)
this.all_ctx[i].restore();},render_header:function()
{this.bar_ctx.translate(this.view_port.l,this.view_port.t);var l=this.view_port.l-this.day_length;var r=this.view_port.r+this.day_length;var l_days=Math.floor(l/this.day_length);var r_days=Math.floor(r/this.day_length);var low=this.time_bounds.low.add(Date.DAY,l_days);var high=this.time_bounds.low.add(Date.DAY,r_days);var i;var grad=[255,252,252,249,247,256,242,241,238,236,233,231,227,226,222];for(i=0;i<grad.length;i++)
{this.bar_ctx.strokeStyle='rgb('+grad[i]+','+grad[i]+','+grad[i]+')';this.bar_ctx.beginPath();this.bar_ctx.moveTo(0,i+2);this.bar_ctx.lineTo(this.canvas_width,i+2);this.bar_ctx.stroke();}
this.bar_ctx.strokeStyle='rgb(144,144,144)';var lines=[0.5,16.5,32.5];for(var i=0;i<lines.length;i++)
{this.bar_ctx.beginPath();this.bar_ctx.moveTo(0,lines[i]);this.bar_ctx.lineTo(this.canvas_width,lines[i]);this.bar_ctx.stroke();}
this.bar_ctx.fillStyle='rgb(0,0,0)';this.bar_ctx.font='11px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.bar_ctx.textAlign='center';if(this.major_unit=='week')
this.render_week_header(low,high);else if(this.major_unit=='month')
this.render_month_days_header(low,high);else if(this.major_unit=='month_weeks')
this.render_month_weeks_header(low,high);else if(this.major_unit=='quarter')
this.render_quarter_header(low,high);else
this.render_year_header(low,high);},find_selection_area:function(e)
{return this.find_active_area(e,this.active_selection_areas);},find_tooltip_area:function(e)
{if(!this.active_tooltip_areas)return null;var areas=this.find_active_area(e,this.active_tooltip_areas,false,true);if(areas.length==0)
return null;else
{var top_area=areas[areas.length-1];var next_area=areas.length-2>=0?areas[areas.length-2]:null;if(top_area.type=='gantt_bar'&&next_area&&next_area.type=='workday_off')
return next_area;if(top_area.type=='workday_on')
return null;return top_area;}},find_dragable_area:function(e,include_drag_handles)
{return this.find_active_area(e,this.active_dragable_areas,include_drag_handles);},find_active_area:function(e,areas,include_drag_handles,return_all_found_areas)
{if(!areas)return null;var all_found_areas=[];var coords=this.to_area_coordinates(e);var offset=include_drag_handles?10:0;for(var i=0;i<areas.length;i++)
{var area=areas[i];if(coords.x<area.l-offset)continue;if(coords.x>area.r+offset)continue;if(coords.y<area.t)continue;if(coords.y>area.b)continue;if(return_all_found_areas)
all_found_areas.push(area);else
return area;}
if(return_all_found_areas)
return all_found_areas;else
return null;},to_area_coordinates:function(e)
{var x=e.xy[0]-this.bg_canvas.getLeft()+this.view_port.l;var y=e.xy[1]-this.bg_canvas.getTop()+this.view_port.t;return{x:x,y:y};},render_areas:function(areas,active_areas,second_active_areas,only_clip_horizontally)
{for(var i=0;i<areas.length;i++)
{area=areas[i];if(!only_clip_horizontally&&area.l>this.view_port.r)continue;if(!only_clip_horizontally&&area.r<this.view_port.l)continue;if(area.t>this.view_port.b)continue;if(area.b<this.view_port.t)continue;area.render_fn.call(this,area);if(active_areas)
active_areas.push(area);if(second_active_areas)
second_active_areas.push(area);}},render_background:function(no_project_dates)
{this.bg_ctx.save();this.marker_ctx.save();this.set_header_clip_for_canvas(this.bg_ctx,17);this.set_header_clip_for_canvas(this.marker_ctx,17);if(this.background_areas)
this.render_areas(this.background_areas,this.active_tooltip_areas);if(!no_project_dates&&this.get('display_project_dates')&&this.project_date_areas)
this.render_areas(this.project_date_areas,this.active_tooltip_areas);this.bg_ctx.restore();this.marker_ctx.restore();},render_bars:function()
{this.bar_ctx.save();this.sel_ctx.save();this.set_header_clip_for_canvas(this.bar_ctx,33);this.set_header_clip_for_canvas(this.sel_ctx,33);if(this.graphic_areas)
this.render_areas(this.graphic_areas,this.active_dragable_areas,this.active_tooltip_areas,true);this.bar_ctx.restore();this.sel_ctx.restore();},render_dependency_lines:function(clear_context_before_rendering)
{this.line_ctx.save();this.set_header_clip_for_canvas(this.line_ctx,33);if(this.line_areas)
this.render_areas(this.line_areas,false,false,true);this.line_ctx.restore();},render_selection_bars:function()
{this.sel_ctx.save();this.set_header_clip_for_canvas(this.sel_ctx,33);if(this.selection_bar_areas)
this.render_areas(this.selection_bar_areas,this.active_selection_areas);this.sel_ctx.restore();},set_header_clip_for_canvas:function(ctx,header_height)
{ctx.beginPath();ctx.rect(this.view_port.l,this.view_port.t+header_height,this.canvas_width,this.canvas_height-header_height);ctx.clip();},render_header_selection_intervals:function()
{var markers=[];for(var i=0;i<this.graphic_areas.length;i++)
{var area=this.graphic_areas[i];if(!area.record||!area.selected)continue;markers.push({x:area.l,l:true});markers.push({x:area.r,l:false});}
markers.sort(function(a,b){if(a.x<b.x)
return-1;else if(a.x>b.x)
return 1;else
return 0;});this.line_ctx.globalAlpha=0.5;this.line_ctx.fillStyle='rgb(255,255,70)';var left;var open_count=0;for(var i=0;i<markers.length;i++)
{var marker=markers[i];if(marker.l)
{if(open_count==0)
left=marker.x;open_count++;}
else
{open_count--;if(open_count==0)
this.line_ctx.fillRect(left,this.view_port.t+17,marker.x-left,17);}}
this.line_ctx.globalAlpha=1;},on_scroll:function(e)
{var t=this.scroll_wrapper.dom.scrollTop;var l=this.scroll_wrapper.dom.scrollLeft;this.view_port={l:l,r:l+this.canvas_width,t:t,b:t+this.canvas_height};this.render_widget();this.center_scroll();this.last_scroll_date=this.get_datetime_at_pixel(this.scroll_wrapper.dom.scrollLeft);},get_datetime_at_pixel:function(x)
{var seconds=(x/this.day_length)*24*60*60;return this.time_bounds.low.add(Date.SECOND,seconds);},calc_datetime_distance_in_pixels:function(from,to)
{var days=(to.getTime()-from.getTime())/(1000*24*60*60);return Math.floor(days*this.day_length);},on_click:function(e)
{var t=Ext.get(e.getTarget());var close_overlay=t.findParent('img.close_browser_warning_overlay',this.container,true);if(close_overlay)
{var warning_div=close_overlay.findParent('div.browser_warning_overlay',this.container,true);warning_div.remove();}},on_mousedown:function(e)
{if(e.browserEvent.which&&e.browserEvent.which==3)
{var t=Ext.get(e.getTarget());var gantt_div=t.findParent('div.sgw_entity_query_new_gantt',document.body);if(gantt_div)
{var click_xy=e.getXY();var container_left=this.container.getLeft();var x=click_xy[0]-container_left+this.scroll_wrapper.dom.scrollLeft;this.center_scroll_date=this.get_time_at_pixel(x);}}
this.last_click_xy=e.getXY();},on_dblclick:function(e)
{var area=this.find_tooltip_area(e);if(area&&area.rule){var r;if(area.rule.constructor==Array)
r=area.rule[0];else
r=area.rule;var cfg={entity_query_page:this.parent.parent};if(r.exception)
cfg.exceptions_date=r.start_date;if(r.user){cfg.entity_type='HumanUser';var entities=[];if(area.rule.constructor==Array)
{for(var i=0;i<area.rule.length;i++)
{if(area.rule[i].user)
entities.push(area.rule[i].user.id);}}
else
entities.push(r.user.id);cfg.selected_entities=entities;}else if(r.project){cfg.entity_type='Project';cfg.selected_entities=[r.project.id];}
new SG.WorkScheduleOverlay(cfg);}},destroy_widget:function()
{Ext.EventManager.removeResizeListener(this.on_window_resize,this);SG.NotificationCenter.remove_observer({uuid:'_sg_sidenav_',name:'sidenav_changed',callback:{fn:this.on_window_resize,scope:this}});SG.NotificationCenter.remove_observer({uuid:'_sg_focus_window_resized_',name:'focus_window_resized',callback:{fn:this.on_window_resize,scope:this}});},on_grid_data_load:function()
{this.regenerate_all_areas();this.restore_scroll();this.read_data();},on_grid_data_change:function(changes)
{var count=0;var request_task_dependencies=false;for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.state!='pending')
{count++;if((change.column&&['upstream_tasks','downstream_tasks'].indexOf(change.column)!=-1)||change.type=='retire')
{request_task_dependencies=true;}}}
if(count>0)
{if(!request_task_dependencies)
this.regenerate_all_areas();this.restore_scroll();}
if(request_task_dependencies){var p=this.get_parent();this.show_loading_overlay(p.get_container());this.read_task_dependency_data();}},center_scroll:function(restore)
{if(restore)
{if(!this.center_scroll_date)
{this.render_widget();return;}
var days=Math.floor(this.canvas_width*.5/this.day_length);this.center_scroll_date=this.center_scroll_date.add(Date.DAY,-1*days);var left=this.calc_time_distance_in_pixels(this.time_bounds.low,this.center_scroll_date);if(left==this.scroll_wrapper.dom.scrollLeft)
this.render_widget();else
this.scroll_wrapper.dom.scrollLeft=left;}
else
{var center_pixel=this.scroll_wrapper.dom.scrollLeft+Math.floor(this.canvas_width*.5);this.center_scroll_date=this.get_time_at_pixel(center_pixel);}},restore_scroll:function()
{if(!this.last_scroll_date)
{this.render_widget();return;}
var left=this.calc_datetime_distance_in_pixels(this.time_bounds.low,this.last_scroll_date);if(left==this.scroll_wrapper.dom.scrollLeft)
this.render_widget();else
this.scroll_wrapper.dom.scrollLeft=left;},regenerate_all_areas:function(do_not_calc_time_bounds)
{this.area_id_count=0;this.major_unit=this.get('major_unit');this.day_length=this.length_of_a_day_in_pixels[this.major_unit];this.half_day_length=Math.floor(this.day_length/2);this.render_offday_overlaps=['week','month'].indexOf(this.major_unit)!=-1;this.gantt_bar_drag.last_hover_area=null;if(!do_not_calc_time_bounds){var time_bounds=this.calculate_entire_time_bounds();if(!time_bounds.low||!time_bounds.high)
{var now=new SG.Date();time_bounds.low=now.add(Date.DAY,-1);time_bounds.high=now.add(Date.DAY,1);}
this.adjust_bounds_for_screen(time_bounds);if(this.session_time_bounds==null)
this.session_time_bounds=time_bounds
else
{if(this.session_time_bounds.low.getTime()<time_bounds.low.getTime())
time_bounds.low=this.session_time_bounds.low;else
this.session_time_bounds.low=time_bounds.low;if(this.session_time_bounds.high.getTime()>time_bounds.high.getTime())
time_bounds.high=this.session_time_bounds.high;else
this.session_time_bounds.high=time_bounds.high;}
if(this.last_scroll_date==null)
this.last_scroll_date=time_bounds.low;this.time_bounds=time_bounds;}
var scroll_width=this.calc_time_distance_in_pixels(this.time_bounds.low,this.time_bounds.high);var scroll_height=this.calc_scroll_container_height(scroll_width);this.scroll_container.setStyle({width:scroll_width+'px',height:scroll_height+'px'});this.set_canvas_dimensions();this.generate_background_areas();this.generate_bar_areas();this.generate_depenedency_line_areas();this.generate_project_date_areas();this.select_and_electrify_areas();this.construct_pipeline_step_color_map();},construct_pipeline_step_color_map:function()
{this.pipeline_step_color_map={};for(var entity_type in SG.globals.steps)
{if(!SG.globals.steps.hasOwnProperty(entity_type))continue;var steps=SG.globals.steps[entity_type];for(var i=0;i<steps.length;i++)
{var step=steps[i];this.pipeline_step_color_map[step.id]=step.color;}}},calc_scroll_container_height:function(scroll_width)
{var grid_container=this.grid_widget.get_container();if(grid_container.dom.scrollHeight>grid_container.dom.clientHeight)
return grid_container.dom.scrollHeight;var container_width=this.container.getWidth();if(scroll_width>container_width)
return grid_container.dom.clientHeight-this.browser_scroll_bar_width;else
return grid_container.dom.clientHeight;},generate_bar_areas:function()
{this.graphic_areas=[];this.selection_bar_areas=[];this.bar_areas_id_map={};var grid_container=this.grid_widget.get_container();if(this.grid_ds.is_grouped())
{var y=this.grid_widget.summaries_visible()?54:34;this.grouping=this.grid_widget.get_grouping();this.grid_container
var grp_hash=this.recusively_generate_group_areas(this.grid_ds.groups,0,y);}
else
{var row,y,r;var y_offset=this.container.getTop();var grid_rows=sg_find_all('div.row',grid_container.dom);for(i=0;i<this.grid_ds.count();i++)
{row=Ext.get(grid_rows[i]);y=row.getTop()-y_offset+this.scroll_wrapper.dom.scrollTop;r=this.grid_ds.get_record(i);this.generate_single_bar_area(y,r,-1);var is_even=row.hasClass('row_even');this.generate_selection_bar_area(y,r.id,-1,is_even,20);}}},recusively_generate_group_areas:function(groups,depth,y,visible)
{var grid_container=this.grid_widget.get_container();var bounds={low:null,high:null};var return_hash={y:y,bounds:bounds};if(visible===undefined)
visible=true;for(var i=0;i<groups.length;i++)
{var group=groups[i];if(group.synthetic)
{var synthetic_group_y=return_hash.y;var grid_group_div=sg_find('div.group[group_idx="'+group.idx+'"]',grid_container.dom);var group_open=visible&&Ext.fly(grid_group_div).hasClass('open');var group_hash=this.recusively_generate_group_areas(group.groups,depth+1,return_hash.y+22,group_open);if(group_open)
return_hash.y=group_hash.y;else
return_hash.y+=22;this.generate_synthetic_group_area(group,group_hash.bounds,group.idx,synthetic_group_y,depth,visible);this.bounds_union(return_hash.bounds,group_hash.bounds);}
else
{var group_hash=this.generate_group_area(group.idx,return_hash.y,depth,visible);return_hash.y+=group_hash.y;this.bounds_union(return_hash.bounds,group_hash.bounds);}}
return return_hash;},generate_synthetic_group_area:function(group,bounds,synthetic_group_idx,y,depth,visible)
{if(!visible)return;this.generate_selection_bar_area(y,undefined,synthetic_group_idx,undefined,22);if(bounds.low&&bounds.high)
{var display_name=group.display_values[depth];if(display_name==='')
{var grouping=this.grouping[depth];var schema_field=SG.schema.get_field('Task',grouping.column);display_name="No "+schema_field.display_name;}
var sg_tip=this.render_tool_tip(display_name,null,null,bounds.low,bounds.high);var left=this.calc_time_distance_in_pixels(this.time_bounds.low,bounds.low);var width=this.calc_time_distance_in_pixels(bounds.low,bounds.high.add(Date.DAY,1));this.graphic_areas.push({id:this.gen_area_id(),l:left,r:left+width,t:y,b:y+22,render_fn:this.render_group_hook_fn,group_idx:synthetic_group_idx,sg_tip:sg_tip,graphic:true,type:'group_hook',});}},gen_area_id:function()
{this.area_id_count++;return this.area_id_count;},render_group_hook_fn:function(area)
{var display_group_bars=this.get('display_group_bars');if(!display_group_bars)return;this.set_colors_for_gantt_group_bar(this.bar_ctx,area.selected);var width=area.r-area.l;var xx=area.l+0.5;var yy=area.t+3.5;var h=5;this.bar_ctx.beginPath();this.bar_ctx.moveTo(xx,yy);this.bar_ctx.lineTo(xx+width,yy);this.bar_ctx.lineTo(xx+width,yy+14);this.bar_ctx.lineTo(xx+width-4,yy+h);this.bar_ctx.lineTo(xx+5,yy+h);this.bar_ctx.lineTo(xx,yy+14);this.bar_ctx.closePath();this.bar_ctx.stroke();this.bar_ctx.fill();},generate_group_area:function(group_idx,y,depth,visible)
{var grid_container=this.grid_widget.get_container();var grp_bounds={low:null,high:null};var ds=this.grid_ds;var grp=ds.get_group(group_idx);var grp_recs=grp.ids;var grp_y=y;var grid_group_div=Ext.get(sg_find('div.group[group_idx="'+group_idx+'"]',grid_container.dom));var grid_open=grid_group_div.hasClass('open');var grid_group_header=sg_find('div.group_header',grid_group_div.dom);var grid_rows=sg_find_all('div.row',grid_group_div.dom);var row_height=grid_group_header.clientHeight+1;if(visible)
this.generate_selection_bar_area(y,undefined,group_idx,undefined,row_height);y+=row_height;var all_milestones=true;for(var j=0;j<grp_recs.length;j++)
{var r=ds.get_record_by_id(grp_recs[j]);var milestone=Number(r.get('milestone'));if(milestone==0)
all_milestones=false;if(grid_open&&visible)
{this.generate_single_bar_area(y,r,group_idx);row_height=grid_rows[j].clientHeight+1;var is_even=Ext.fly(grid_rows[j]).hasClass('row_even');this.generate_selection_bar_area(y,r.id,group_idx,is_even,row_height);y+=row_height;}
var str=r.get('start_date');if(str)this.grow_time_bounds(grp_bounds,new SG.Date(str));str=r.get('due_date');if(str)this.grow_time_bounds(grp_bounds,new SG.Date(str));}
if(visible&&grp_bounds.low&&grp_bounds.high)
{var display_name=grp.display_values[depth];;if(display_name==='')
{var grouping=this.grouping[depth];var schema_field=SG.schema.get_field('Task',grouping.column);display_name="No "+schema_field.display_name;}
var left=this.calc_time_distance_in_pixels(this.time_bounds.low,grp_bounds.low);var sg_tip=this.render_tool_tip(display_name,null,null,grp_bounds.low,grp_bounds.high);if(all_milestones)
{this.graphic_areas.push({id:this.gen_area_id(),l:left,r:left+this.day_length,t:grp_y,b:grp_y+20,render_fn:this.render_milestone_fn,group_idx:group_idx,group_bar:true,sg_tip:sg_tip,graphic:true,milestone:true,type:'group_hook'});}
else
{var width=this.calc_time_distance_in_pixels(grp_bounds.low,grp_bounds.high.add(Date.DAY,1));this.graphic_areas.push({id:this.gen_area_id(),l:left,r:left+width,t:grp_y,b:grp_y+22,render_fn:this.render_group_hook_fn,group_idx:group_idx,sg_tip:sg_tip,graphic:true,type:'group_hook'});}}
return{y:y-grp_y,bounds:grp_bounds};},bounds_union:function(bound,other_bound)
{this.grow_time_bounds(bound,other_bound.low);this.grow_time_bounds(bound,other_bound.high);},generate_selection_bar_area:function(y,record_id,group_idx,is_even,height)
{this.selection_bar_areas.push({id:this.gen_area_id(),l:0,r:this.scroll_container.getWidth(),t:y,b:y+height,record_id:record_id,group_idx:group_idx,even:is_even,render_fn:this.render_selection_bar_fn});},generate_single_bar_area:function(y,record,group_idx)
{var milestone=Number(record.get('milestone'));var s=record.get('start_date')||'';var e=record.get('due_date')||'';if(s==''&&e=='')return;var s_date,e_date;s_date=e_date=null;if(s!='')s_date=new SG.Date(s);if(e!='')e_date=new SG.Date(e);var left,temp_e_date,width;if(milestone)
{if(s_date)
left=this.calc_time_distance_in_pixels(this.time_bounds.low,s_date);else
left=this.calc_time_distance_in_pixels(this.time_bounds.low,e_date);this.graphic_areas.push({id:this.gen_area_id(),l:left,r:left+this.day_length,t:y,b:y+20,record:record,render_fn:this.render_milestone_fn,group_idx:group_idx,graphic:true,milestone:true,pinned:record.get('pinned'),type:'gantt_bar',});this.add_to_bar_areas_id_map(record,this.graphic_areas[this.graphic_areas.length-1]);}
else if(s_date&&e_date)
{left=this.calc_time_distance_in_pixels(this.time_bounds.low,s_date);temp_e_date=e_date.add(Date.DAY,1);width=this.calc_time_distance_in_pixels(s_date,temp_e_date);var working_days=Math.floor(record.get('duration')/(SG.globals.preferences.hours_per_day*60));this.graphic_areas.push({id:this.gen_area_id(),l:left,r:left+width,t:y,b:y+20,record:record,render_fn:this.render_gantt_bar_fn,group_idx:group_idx,graphic:true,working_days:working_days,pinned:record.get('pinned'),type:'gantt_bar'});this.add_to_bar_areas_id_map(record,this.graphic_areas[this.graphic_areas.length-1]);}},add_to_bar_areas_id_map:function(record,area)
{if(this.bar_areas_id_map[record.id])
this.bar_areas_id_map[record.id].push(area);else
this.bar_areas_id_map[record.id]=[area];},render_milestone_fn:function(area)
{if(area.group_bar&&!this.get('display_group_bars'))
return;if(!area.sg_tip)area.sg_tip=this.render_sg_tip_for_area(area.record);if(area.group_bar)
this.set_colors_for_gantt_group_bar(this.bar_ctx,area.selected);else
this.set_colors_for_gantt_bar(this.bar_ctx,area.record,area.selected);if(!area.selected&&area.dragging)
{this.bar_ctx.shadowOffsetX=2.5;this.bar_ctx.shadowOffsetY=2.5;this.bar_ctx.shadowBlur=2;this.bar_ctx.shadowColor="rgba(0, 0, 0, 0.5)";}
var y=area.t;var start_x=area.l+this.half_day_length;this.bar_ctx.lineWidth=2.0;this.bar_ctx.beginPath();this.bar_ctx.moveTo(start_x,y+3.5);this.bar_ctx.lineTo(start_x+6.5,y+9.5);this.bar_ctx.lineTo(start_x,y+15.5);this.bar_ctx.lineTo(start_x-6.5,y+9.5);this.bar_ctx.closePath();if(!area.pinned)
this.bar_ctx.stroke();this.bar_ctx.fill();if(area.pinned)
{y=area.t;start_x=area.l+this.half_day_length;this.bar_ctx.lineWidth=1.0;this.render_dashed_line(this.bar_ctx,4,2,start_x,y+3.5,start_x+6.5,y+9.5);this.render_dashed_line(this.bar_ctx,4,2,start_x+6.5,y+9.5,start_x,y+15.5);this.render_dashed_line(this.bar_ctx,4,2,start_x,y+15.5,start_x-6.5,y+9.5);this.render_dashed_line(this.bar_ctx,4,2,start_x-6.5,y+9.5,start_x,y+3.5);}
this.bar_ctx.lineWidth=1.0;this.bar_ctx.shadowOffsetX=0;this.bar_ctx.shadowOffsetY=0;this.bar_ctx.shadowBlur=0;if(area.dot!=undefined)
this.render_gantt_bar_dot(area,area.dot=='left');this.render_left_right_fields_fn(area);this.render_selection_graphic(area);},set_colors_for_context:function(ctx,color,selected)
{if(selected)
{var cols=color.split(',');var r=Math.round(Number(cols[0])*.85);var g=Math.round(Number(cols[1])*.85);var b=Math.round(Number(cols[2])*.85);ctx.fillStyle='rgb('+r+','+g+','+b+')';}
else
ctx.fillStyle='rgb('+color+')';ctx.strokeStyle='rgb(51, 51, 51)';},set_colors_for_gantt_bar:function(ctx,record,selected)
{var color=record.get('color');if(!color||color=='')
color='2,149,216';else if(color=='pipeline_step')
{var step=record.get('step');if(!step)
color='2,149,216';else
color=this.pipeline_step_color_map[step.id];}
this.set_colors_for_context(ctx,color,selected);},set_colors_for_gantt_group_bar:function(ctx,selected)
{var color=this.get('group_bar_color');this.set_colors_for_context(ctx,color,selected);},render_gantt_bar_fn:function(area)
{if(!area.sg_tip)area.sg_tip=this.render_sg_tip_for_area(area.record);this.set_colors_for_gantt_bar(this.bar_ctx,area.record,area.selected);var w=area.r-area.l;this.bar_ctx.fillRect(area.l+0.5,area.t+3.5,w,12);if(this.render_offday_overlaps)
{var overlaps=[];if(this.work_day_rules_ds.is_loaded())
{for(var x=area.l;x<area.r;x+=this.day_length)
{if(!this.is_working_day(this.bg_ctx,x,area.t))
overlaps.push(x);}}
if(overlaps.length>0)this.bar_ctx.fillStyle="rgb(210,210,210)";for(var i=0;i<overlaps.length;i++)
this.bar_ctx.fillRect(overlaps[i]+0.5,area.t+3.5,this.day_length,12);}
if(area.pinned)
this.render_dashed_rectangle(this.bar_ctx,4,2,area.l+0.5,area.t+3.5,w,12);else
{if(!area.selected&&area.dragging)
{this.sel_ctx.shadowOffsetX=2.5;this.sel_ctx.shadowOffsetY=2.5;this.sel_ctx.shadowBlur=2;this.sel_ctx.shadowColor="rgba(0, 0, 0, 0.5)";this.sel_ctx.fillRect(area.l+0.5,area.t+3.5,w,12);this.sel_ctx.shadowOffsetX=0;this.sel_ctx.shadowOffsetY=0;this.sel_ctx.shadowBlur=0;}
this.bar_ctx.strokeRect(area.l+0.5,area.t+3.5,w,12);}
if(area.dot!=undefined)
this.render_gantt_bar_dot(area,area.dot=='left');this.render_left_right_fields_fn(area);this.render_selection_graphic(area);},render_gantt_bar_drag_handles:function(area)
{this.bar_ctx.strokeStyle="black";var w=area.r-area.l;var lines=[-8.5,-6.5,-4.5,w+4.5,w+6.5,w+8.5];this.bar_ctx.beginPath();for(var i=0;i<lines.length;i++)
{this.bar_ctx.moveTo(area.l+lines[i],area.t+4.5);this.bar_ctx.lineTo(area.l+lines[i],area.t+14.5);}
this.bar_ctx.closePath();this.bar_ctx.stroke();},render_gantt_bar_dot:function(area,is_left)
{var x;if(area.milestone)
x=is_left?area.l+this.half_day_length-14:area.l+this.half_day_length+14;else
x=is_left?area.l-7:area.l+(area.r-area.l)+7;this.bar_ctx.fillStyle="black";this.bar_ctx.beginPath();this.bar_ctx.arc(x,area.t+10,4,0,Math.PI*2,true);this.bar_ctx.closePath();this.bar_ctx.fill();},show_gantt_bar_drag_handles:function(area,e)
{this.bar_ctx.save();this.bar_ctx.translate(-this.view_port.l,-this.view_port.t);this.set_header_clip_for_canvas(this.bar_ctx,33);if(e&&e.browserEvent.altKey)
{this.tooltip_handler.hide();this.render_gantt_bar_dot(area,false);}
else if(!area.milestone)
this.render_gantt_bar_drag_handles(area);this.bar_ctx.restore();},hide_gantt_bar_drag_handles:function(area)
{this.bar_ctx.save();this.bar_ctx.translate(-this.view_port.l,-this.view_port.t);this.set_header_clip_for_canvas(this.bar_ctx,33);var w=area.r-area.l;if(area.milestone)
{this.bar_ctx.clearRect(area.l+this.half_day_length+9,area.t+3,9,13);}
else
{this.bar_ctx.clearRect(area.l-10,area.t+3,8,13);this.bar_ctx.clearRect(area.l+w+3,area.t+3,8,13);}
this.bar_ctx.restore();},electrify_chain:function(area)
{if(!area)return;if(area.pinned)return;if(!area.selected)area.electrified=true;if(!area.downstream_lines)return;for(var i=0;i<area.downstream_lines.length;i++)
{var line_area=area.downstream_lines[i];line_area.electrified=true;this.electrify_chain(line_area.task_area);}},toggle_chain_dragging:function(area,dragging)
{if(!area)return;if(area.pinned)return;area.dragging=dragging;if(!area.downstream_lines)return;for(var i=0;i<area.downstream_lines.length;i++)
{var line_area=area.downstream_lines[i];this.toggle_chain_dragging(line_area.task_area,dragging);}},render_dashed_rectangle:function(ctx,on_length,off_length,x,y,w,h)
{this.render_dashed_line(ctx,on_length,off_length,x,y,x+w,y);this.render_dashed_line(ctx,on_length,off_length,x+w,y,x+w,y+h);this.render_dashed_line(ctx,on_length,off_length,x,y+h,x+w,y+h);this.render_dashed_line(ctx,on_length,off_length,x,y,x,y+h);},render_dashed_line:function(ctx,on_length,off_length,start_x,start_y,end_x,end_y)
{var dx=end_x-start_x;var dy=end_y-start_y;var line_length=Math.sqrt((dx*dx)+(dy*dy));dx=dx/line_length;dy=dy/line_length;var x=start_x;var y=start_y;var len;ctx.beginPath();length_done=0;while(length_done<line_length)
{ctx.moveTo(x,y);len=length_done+on_length>line_length?line_length-length_done:on_length;x+=dx*len;y+=dy*len;ctx.lineTo(x,y);x+=dx*off_length;y+=dy*off_length;length_done+=on_length+off_length;}
ctx.closePath();ctx.stroke();},move_area:function(area,days_offset)
{area.l+=this.day_length*days_offset;if(!this.work_day_rules_ds.is_loaded()||!area.record||area.milestone)
area.r+=this.day_length*days_offset;else
{var line_x;var day_count=0;var working_days=0;for(line_x=area.l;working_days<area.working_days;line_x+=this.day_length)
{day_count++;if(this.is_working_day(this.bg_ctx,line_x,area.t))
working_days++;}
area.r=area.l+(day_count*this.day_length);}
this.move_downstream_tasks(area,days_offset);},adjust_area_size:function(area,days_offset,is_left)
{if(is_left&&(area.l+(days_offset*this.day_length))>=area.r)
return;else if((area.r+(days_offset*this.day_length))<=area.l)
return;if(is_left)
area.l+=days_offset*this.day_length;else
{if(!this.work_day_rules_ds.is_loaded())
area.r+=days_offset*this.day_length;else
{var new_r=area.r+(days_offset*this.day_length);if(new_r>area.r)
{var working_days=0;for(var line_x=new_r;line_x<area.r;line_x+=this.day_length)
{if(this.is_working_day(this.bg_ctx,line_x,area.t))
working_days++;}
area.working_days+=working_days;}
else
{var working_days=0;for(var line_x=area.r;line_x<new_r;line_x+=this.day_length)
{if(this.is_working_day(this.bg_ctx,line_x,area.t))
working_days++;}
area.working_days-=working_days;}
area.r+=days_offset*this.day_length;}
this.move_downstream_tasks(area,days_offset);}},move_downstream_tasks:function(area,days_offset)
{if(area.downstream_tasks==undefined||days_offset==undefined)return;for(var id in area.downstream_tasks)
{if(!area.downstream_tasks.hasOwnProperty(id))continue;var down_stream_area=area.downstream_tasks[id];if(down_stream_area.selected||down_stream_area.pinned)continue;var largest_r=-10000000;for(var uid in down_stream_area.upstream_tasks)
{if(!down_stream_area.upstream_tasks.hasOwnProperty(uid))continue;var upstream_task=down_stream_area.upstream_tasks[uid];var r=upstream_task.milestone?upstream_task.l:upstream_task.r;if(r>largest_r)
largest_r=r;}
if(largest_r!=-10000000)
{var working_days=this.get_task_dependency_offset_days(area,down_stream_area)+1;if(this.work_day_rules_ds.is_loaded()){var working_day_count=this.is_working_day(this.bg_ctx,largest_r,down_stream_area.t);while(working_day_count<working_days)
{largest_r+=this.day_length;working_day_count+=this.is_working_day(this.bg_ctx,largest_r,down_stream_area.t);}}else{largest_r+=this.day_length*working_days;}
var the_offset=(largest_r-down_stream_area.l)/this.day_length;this.move_area(down_stream_area,the_offset);}}},get_task_dependency_offset_days:function(area,down_stream_area)
{if(!area.downstream_lines)
return 0;for(var i=0;i<area.downstream_lines.length;i++)
{var line_area=area.downstream_lines[i];if(!line_area.task_area)continue;if(line_area.task_area.record.id==down_stream_area.record.id)
{if(line_area.offset_days==null)
return 0;else
return line_area.offset_days;}}
return 0;},render_selection_graphic:function(area)
{if(!area.selected)return;if(area.dragging)
{this.sel_ctx.shadowOffsetX=2.5;this.sel_ctx.shadowOffsetY=2.5;this.sel_ctx.shadowBlur=2;this.sel_ctx.shadowColor="rgba(0, 0, 0, 0.5)";}
var width=area.milestone?this.day_length:(area.r-area.l);var pad=area.milestone?8:15;var xx=area.l-pad-0.5;var w=width+(2*pad);var yy=area.t+0.5;var r=6;this.sel_ctx.fillStyle="rgb(255,255,0)";this.sel_ctx.lineStyle="rgb(0,0,0)";this.sel_ctx.globalAlpha=0.8;this.sel_ctx.beginPath();this.sel_ctx.moveTo(xx+r,yy);this.sel_ctx.lineTo(xx+w-r,yy);this.sel_ctx.arc(xx+w-r,yy+r,r,-Math.PI/2,0,false);this.sel_ctx.lineTo(xx+w,yy+18-r);this.sel_ctx.arc(xx+w-r,yy+18-r,r,0,Math.PI/2,false);this.sel_ctx.lineTo(xx+r,yy+18);this.sel_ctx.arc(xx+r,yy+18-r,r,Math.PI/2,Math.PI,false);this.sel_ctx.lineTo(xx,yy+r);this.sel_ctx.arc(xx+r,yy+r,r,Math.PI,3*Math.PI/2,false);this.sel_ctx.closePath();this.sel_ctx.stroke();this.sel_ctx.fill();this.sel_ctx.globalAlpha=1;this.sel_ctx.shadowOffsetX=0;this.sel_ctx.shadowOffsetY=0;this.sel_ctx.shadowBlur=0;},is_working_day:function(ctx,global_x,global_y)
{var x=global_x-this.view_port.l;var y=global_y-this.view_port.t;var pixel;var xx=x;var yy=y;if(xx>=0&&xx<this.canvas_width&&yy>=0&&yy<this.canvas_height)
{pixel=ctx.getImageData(xx,yy,1,1).data;if(pixel[0]!=255)
return false;else
return true;}
xx=x+this.day_length;yy=y;if(xx>=0&&xx<this.canvas_width&&yy>=0&&yy<this.canvas_height)
{pixel=ctx.getImageData(xx,yy,1,1).data;if(pixel[0]!=255)
return false;else
return true;}
xx=x;yy=y+20;if(xx>=0&&xx<this.canvas_width&&yy>=0&&yy<this.canvas_height)
{pixel=ctx.getImageData(xx,yy,1,1).data;if(pixel[0]!=255)
return false;else
return true;}
xx=x+this.day_length;yy=y+20;if(xx>=0&&xx<this.canvas_width&&yy>=0&&yy<this.canvas_height)
{pixel=ctx.getImageData(xx,yy,1,1).data;if(pixel[0]!=255)
return false;else
return true;}
return true;},render_left_right_fields_fn:function(area)
{if(!area.record)return;var x=area.l;var y=area.t;var w=area.milestone?this.day_length:area.r-area.l;var offset=area.milestone?12:18;this.render_fields_fn(area.record,x-offset,y+14,this.left_fields,'left');this.render_fields_fn(area.record,x+w+offset,y+14,this.right_fields,'right');},render_fields_fn:function(record,x,y,fields,alignment)
{if(!this.gantt_ds.is_loaded()||fields.length==0)return;this.canvas_field_renderer.render_fields(record,x,y,fields,alignment);},render_sg_tip_for_area:function(record)
{var task_name=record.get('content');var task_status=record.get('sg_status_list');var addressees=record.get('task_assignees');var s=record.get('start_date')||'';var e=record.get('due_date')||'';var s_date=s==''?null:new SG.Date(s);var e_date=e==''?null:new SG.Date(e);var milestone=Number(record.get('milestone'));var early_days=null;var dependency_violation=record.get('dependency_violation');if(dependency_violation)
{var inv_date=new SG.Date(record.get('inventory_date'));var start_date=new SG.Date(record.get('start_date'));early_days=Math.round((inv_date.getTime()-start_date.getTime())/(1000*24*60*60));}
return this.render_tool_tip(task_name,task_status,addressees,s_date,e_date,milestone,early_days);},render_selection_bar_fn:function(area)
{var selected=this.in_selection_cache(area.group_idx,area.record_id);area.selected=selected;if(area.even!=undefined)
{this.sel_ctx.globalAlpha=.5;if(area.selected)
this.sel_ctx.fillStyle=area.even?'rgb(191,191,219)':'rgb(184,182,215)';else
this.sel_ctx.fillStyle=area.even?'rgb(255,255,255)':'rgb(242,242,242)';this.sel_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);this.sel_ctx.globalAlpha=1;}
else if(selected)
{this.sel_ctx.globalAlpha=.5;this.sel_ctx.fillStyle="#B3B9C9";this.sel_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);this.sel_ctx.globalAlpha=1;}},read_data:function()
{if(this.context.get('stowed'))
return;this.read_fields();this.read_project_dates();this.read_work_day_rules();this.read_task_dependency_data();},read_work_day_rules:function()
{var filters={logical_operator:'or',conditions:[]};var default_work_week_conditions={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[null]},{path:'user',relation:'is',values:[null]},]};filters.conditions.push(default_work_week_conditions);var user_conditions={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[null]},{path:'user',relation:'is_not',values:[null]},]};filters.conditions.push(user_conditions);var project=this.single_project_from_context();var project_condition;if(project)
{project_condition={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[project]},{path:'user',relation:'is',values:[null]},]};}
else
{project_condition={logical_operator:'and',conditions:[{path:'project',relation:'is_not',values:[null]},{path:'user',relation:'is',values:[null]},]};}
filters.conditions.push(project_condition);var sorts=[{column:'precedence',direction:'desc'},{column:'user',direction:'desc'},{column:'project',direction:'desc'},{column:'start_date',direction:'desc'},{column:'end_date',direction:'asc'},]
var spec={type:'WorkDayRule',filters:filters,sorts:sorts,columns:['day_of_week','working','precedence','start_date','end_date','project','user','description'],result:this.work_day_rules_ds};SG.Repo.query(spec);},read_task_dependency_data:function()
{if(this.grid_ds.count()==0)
return;var ids=[];for(var i=0;i<this.grid_ds.count();i++)
{var r=this.grid_ds.get_record(i);ids.push(r.id);}
var filters={logical_operator:'or',conditions:[{path:'task_id',relation:'in',values:ids},{path:'dependent_task_id',relation:'in',values:ids}]};var spec={type:'TaskDependency',filters:filters,columns:['task','dependent_task','offset_days'],result:this.task_dependency_ds};SG.Repo.query(spec);},read_project_dates:function()
{if(!this.get('display_project_dates'))return;var context_project=this.single_project_from_context();if(!context_project)
return;var spec={type:'Project',ids:[context_project.id],columns:this.get_project_date_columns(),result:this.project_ds};SG.Repo.find(spec);},get_project_date_columns:function()
{var cols=[];var schema_fields=SG.schema.entity_fields['Project'];var field;for(field in schema_fields)
{if(schema_fields.hasOwnProperty(field)&&schema_fields[field]['data_type']=='date')
cols.push(field);}
return cols;},on_load_task_dependencies:function()
{this.hide_loading_overlay();this.regenerate_all_areas();this.render_widget();},on_task_dependencies_change:function(changes)
{var count=0;for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.state!='pending')
{count++;}}
if(count>0)
{this.regenerate_all_areas();this.restore_scroll();}},find_task_dependencies_for_task:function(id)
{var records=[];for(var i=0;i<this.task_dependency_ds.count();i++)
{var r=this.task_dependency_ds.get_record(i);var task=r.get('task');if(task.id==id)
records.push(r);}
return records;},generate_depenedency_line_areas:function()
{if(!this.task_dependency_ds.is_loaded())return;var i,j,k;this.line_areas=[];for(i=0;i<this.task_dependency_ds.count();i++)
{var r=this.task_dependency_ds.get_record(i);var task=r.get('task');var dependent_task=r.get('dependent_task');var offset_days=r.get('offset_days');var task_rec=this.grid_ds.get_record_by_id(task.id);var dependent_task_rec=this.grid_ds.get_record_by_id(dependent_task.id);var dependency_violation,dependent_task_areas,task_areas;if(dependent_task_rec&&!task_rec)
{dependent_task_areas=this.bar_areas_id_map[dependent_task_rec.id];if(!dependent_task_areas)continue;for(j=0;j<dependent_task_areas.length;j++)
{var dependent_task_area=dependent_task_areas[j];var line_area={id:this.gen_area_id(),l:dependent_task_area.l,r:dependent_task_area.r+16,t:dependent_task_area.t,b:dependent_task_area.b,connected_task_area:dependent_task_area,render_fn:this.render_broken_arrow_fn,incoming:false,dependency_violation:false};this.line_areas.push(line_area);this.add_downstream_line_area_to_task(dependent_task_area,line_area);}
continue;}
else if(task_rec&&!dependent_task_rec)
{dependency_violation=task_rec.get('dependency_violation');task_areas=this.bar_areas_id_map[task_rec.id];if(!task_areas)continue;for(j=0;j<task_areas.length;j++)
{var task_area=task_areas[j];this.line_areas.push({id:this.gen_area_id(),l:task_area.l-16,r:task_area.r,t:task_area.t,b:task_area.b,connected_task_area:task_area,render_fn:this.render_broken_arrow_fn,incoming:true,dependency_violation:dependency_violation});}
continue;}
if(!task_rec&&!dependent_task_rec)continue;dependency_violation=task_rec.get('dependency_violation');task_areas=this.bar_areas_id_map[task_rec.id];dependent_task_areas=this.bar_areas_id_map[dependent_task_rec.id];if(!(task_areas&&dependent_task_areas))continue;for(j=0;j<task_areas.length;j++)
{var task_area=task_areas[j];if(!task_area)continue;for(k=0;k<dependent_task_areas.length;k++)
{dependent_task_area=dependent_task_areas[k];if(!dependent_task_area)continue;var l=dependent_task_area.l<task_area.l?dependent_task_area.l:task_area.l;var r=dependent_task_area.r>task_area.r?dependent_task_area.r:task_area.r;var t=dependent_task_area.t<task_area.t?dependent_task_area.t:task_area.t;var b=dependent_task_area.b>task_area.b?dependent_task_area.b:task_area.b;var line_area={id:this.gen_area_id(),task_area:task_area,dependent_task_area:dependent_task_area,l:l,r:r,t:t,b:b,render_fn:this.render_dependency_line_fn,offset_days:offset_days,dependency_violation:dependency_violation};this.line_areas.push(line_area);this.add_downstream_line_area_to_task(dependent_task_area,line_area);if(dependent_task_area.downstream_tasks==undefined)
dependent_task_area.downstream_tasks={};dependent_task_area.downstream_tasks[task_area.id]=task_area;if(task_area.upstream_tasks==undefined)
task_area.upstream_tasks={};task_area.upstream_tasks[dependent_task_area.id]=dependent_task_area;}}}},add_downstream_line_area_to_task:function(task_area,line_area)
{if(!task_area.downstream_lines)
task_area.downstream_lines=[];task_area.downstream_lines.push(line_area);},render_broken_arrow_fn:function(area)
{var length=12;var x;var y=area.t+9.5;if(area.incoming)
x=area.connected_task_area.l-(length+1);else
x=area.connected_task_area.r+1;this.set_dependency_line_styles(this.line_ctx,area);this.line_ctx.beginPath();this.line_ctx.moveTo(x,y);x+=length;this.line_ctx.lineTo(x,y);this.line_ctx.stroke();this.line_ctx.beginPath();this.line_ctx.moveTo(x,y);this.line_ctx.lineTo(x-2,y+2);this.line_ctx.lineTo(x-2,y-2);this.line_ctx.lineTo(x,y);this.line_ctx.closePath();this.line_ctx.stroke();this.line_ctx.fill();this.line_ctx.lineWidth=1;},set_dependency_line_styles:function(ctx,area)
{if(area.electrified)
{if(area.dependency_violation)
{ctx.fillStyle='red';ctx.strokeStyle='red';}
else
{ctx.fillStyle='black';ctx.strokeStyle='black';}
ctx.lineWidth=2.0;}
else
{if(area.dependency_violation)
{ctx.fillStyle='rgb(204,127,127)';ctx.strokeStyle='rgb(204,127,127)';}
else
{ctx.fillStyle='rgb(140,140,140)';ctx.strokeStyle='rgb(140,140,140)';}}},render_dependency_line_fn:function(area)
{if(area.line_drag)
{this.render_dependency_line_dragging_fn(area);return;}
var bump=area.electrified?0:0.5;var x=area.dependent_task_area.r+bump;var y=area.dependent_task_area.t+10+bump;var end_x=area.task_area.l+this.half_day_length+bump;var end_y;var above=area.task_area.t<area.dependent_task_area.t;if(above)
end_y=area.task_area.t+16+bump;else
end_y=area.task_area.t+2+bump;this.set_dependency_line_styles(this.line_ctx,area);this.line_ctx.beginPath();this.line_ctx.moveTo(x,y);x=x+this.half_day_length;this.line_ctx.lineTo(x,y);y=above?end_y+5:end_y-5;this.line_ctx.lineTo(x,y);x=end_x;this.line_ctx.lineTo(x,y);y=end_y;this.line_ctx.lineTo(x,y);this.line_ctx.stroke();if(area.offset_days!=undefined&&area.offset_days!=0)
{this.line_ctx.fillStyle='blue';this.line_ctx.strokeStyle='blue';}
if(above)
{this.line_ctx.beginPath();this.line_ctx.moveTo(x-2,y+2);this.line_ctx.lineTo(x+2,y+2);this.line_ctx.lineTo(x,y);this.line_ctx.lineTo(x-2,y+2);this.line_ctx.closePath();this.line_ctx.stroke();this.line_ctx.fill();}
else
{this.line_ctx.beginPath();this.line_ctx.moveTo(x-2,y-2);this.line_ctx.lineTo(x,y);this.line_ctx.lineTo(x+2,y-2);this.line_ctx.lineTo(x-2,y-2);this.line_ctx.closePath();this.line_ctx.stroke();this.line_ctx.fill();}
this.line_ctx.lineWidth=1.0;},render_dependency_line_dragging_fn:function(area)
{var x=area.dependent_task_area.r+0.5;var y=area.dependent_task_area.t+10.5;var end_x=area.task_area.l+0.5;var end_y=area.task_area.t+0.5;var above=area.task_area.t<area.dependent_task_area.t;var behind=(area.dependent_task_area.r+7)>area.task_area.l;this.set_dependency_line_styles(this.line_ctx,area);if(!behind)
{this.line_ctx.beginPath();this.line_ctx.moveTo(x,y);this.line_ctx.lineTo(end_x,y);this.line_ctx.lineTo(end_x,end_y);this.line_ctx.stroke();}
else
{this.line_ctx.beginPath();this.line_ctx.moveTo(x,y);x+=7;this.line_ctx.lineTo(x,y);y=above?y-15:y+15;this.line_ctx.lineTo(x,y);this.line_ctx.lineTo(end_x,y);this.line_ctx.lineTo(end_x,end_y);this.line_ctx.stroke();}
x=end_x;y=end_y;if(above)
{this.line_ctx.beginPath();this.line_ctx.moveTo(x-2,y+2);this.line_ctx.lineTo(x+2,y+2);this.line_ctx.lineTo(x,y);this.line_ctx.lineTo(x-2,y+2);this.line_ctx.closePath();this.line_ctx.stroke();this.line_ctx.fill();}
else
{this.line_ctx.beginPath();this.line_ctx.moveTo(x-2,y-2);this.line_ctx.lineTo(x,y);this.line_ctx.lineTo(x+2,y-2);this.line_ctx.lineTo(x-2,y-2);this.line_ctx.closePath();this.line_ctx.stroke();this.line_ctx.fill();}},on_load_work_day_rules:function()
{var i;var work_week={0:[],1:[],2:[],3:[],4:[],5:[],6:[]};var user_rules=[];var project_rules=[];var user_exceptions=[];var project_exceptions=[];var site_exceptions=[];var context_project=this.single_project_from_context();for(i=0;i<this.work_day_rules_ds.count();i++)
{var r=this.work_day_rules_ds.get_record(i);if(r.get_state()=='retired')continue;var start_date=r.get('start_date');var end_date=r.get('end_date');var user=r.get('user');var project=r.get('project');var day_of_week=r.get('day_of_week');var rank=-1;if(user==null&&project==null&&start_date==null)
rank=2;else if(user==null&&project==null&&start_date!=null)
rank=1;else
rank=0;var rule={id:r.id,day_of_week:day_of_week,start_date:start_date,end_date:end_date,working:r.get('working'),user:user,project:project,rank:rank,description:r.get('description'),exception:r.get('precedence')==1};if(rule.start_date!==null){rule.start_date_js=new SG.Date(start_date);}
if(user==null&&project==null)
{if(rule.exception)
site_exceptions.push(rule);else
work_week[day_of_week].push(rule);}
else if(project!=null&&!rule.exception)
{if(context_project)
work_week[day_of_week].push(rule);else
project_rules.push(rule);}
else if(user!=null&&!rule.exception)
user_rules.push(rule);else if(rule.exception)
{if(user!=null)
user_exceptions.push(rule);else
project_exceptions.push(rule);}}
for(i=0;i<7;i++)
{work_week[i].sort(function(a,b)
{if(a.rank>b.rank)
return 1;else if(a.rank<b.rank)
return-1;else
{var a_start=new SG.Date(a.start_date).getTime();var b_start=new SG.Date(b.start_date).getTime();if(a_start<b_start)
return 1;else if(a_start>b_start)
return-1;else
return 0;}});}
this.work_week_rules={work_week:work_week,project_rules:project_rules,user_rules:user_rules,site_exceptions:site_exceptions,project_exceptions:project_exceptions,user_exceptions:user_exceptions};this.generate_background_areas();this.render_widget();},render_work_rule_fn:function(area)
{if(area.rule.working)
this.bg_ctx.fillStyle="rgb(255,255,255)";else
this.bg_ctx.fillStyle="rgb(210,210,210)";this.bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},render_partial_work_rule_fn:function(area)
{this.bg_ctx.fillStyle="rgb(255,210,210)";this.bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},generate_background_areas:function()
{this.background_areas=[];this.generate_work_day_rules_background_areas();if(this.major_unit=='week'||this.major_unit=='month')
this.generate_end_of_week_lines();if(this.major_unit=='month_weeks')
this.generate_month_weeks_background_areas();else if(this.major_unit=='quarter')
this.generate_quarter_background_areas();else if(this.major_unit=='year')
this.generate_year_background_areas();this.generate_today_background_area();},generate_today_background_area:function()
{var now=new SG.Date();var l=this.calc_time_distance_in_pixels(this.time_bounds.low,now);var scroll_height=this.calc_full_size_area_height();this.background_areas.push({id:this.gen_area_id(),l:l,r:l+this.day_length,t:0,b:scroll_height,sg_tip:'Today',render_fn:this.render_today_fn,z_index:'bg_marker'});},calc_full_size_area_height:function()
{if(this.scroll_wrapper.dom.scrollHeight>this.scroll_wrapper.dom.clientHeight)
return this.scroll_container.getHeight();var grid_container=this.grid_widget.get_container();var grid_body=grid_container.child('div.body');var bump=34;if(this.grid_widget.summaries_visible())
bump+=20;return grid_body.getHeight()+bump;},render_today_fn:function(area)
{this.marker_ctx.globalAlpha=0.5;this.marker_ctx.fillStyle="rgb(195,219,255)";this.marker_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);this.marker_ctx.globalAlpha=1.0;},generate_month_weeks_background_areas:function()
{var scroll_height=this.calc_full_size_area_height();var x=0;var end_date=this.time_bounds.high.clone();var cur_date=this.time_bounds.low.clone();while(cur_date.getTime()<end_date.getTime())
{var day_of_week=cur_date.format('w');var offset=7;if(day_of_week!=1)
{if(day_of_week==0)
offset=1;else
offset=7-(day_of_week-1);}
new_end_date=cur_date.add(Date.DAY,offset);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:0,b:scroll_height,render_fn:this.render_marker_fn,type:'marker',});x+=w;cur_date=new_end_date;}},generate_end_of_week_lines:function()
{var scroll_height=this.calc_full_size_area_height();var x=0;var days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];var pref_eow_day=days.indexOf(SG.globals.preferences.week_end_day);var start_of_week=pref_eow_day==6?0:pref_eow_day+1;var end_date=this.time_bounds.high.clone();var cur_date=this.time_bounds.low.clone();while(cur_date.getTime()<end_date.getTime())
{var day_of_week=cur_date.format('w');while(day_of_week!=start_of_week)
{cur_date=cur_date.add(Date.DAY,1);day_of_week=cur_date.format('w');}
x=this.calc_time_distance_in_pixels(this.time_bounds.low,cur_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:0,b:scroll_height,render_fn:this.render_end_of_week_line_fn,type:'bg_marker'});cur_date=cur_date.add(Date.DAY,7);}},render_end_of_week_line_fn:function(area)
{this.bar_ctx.save();this.set_header_clip_for_canvas(this.bar_ctx,33);this.bar_ctx.strokeStyle='rgb(150,150,150)';this.bar_ctx.beginPath();this.bar_ctx.moveTo(area.l+0.5,area.t);this.bar_ctx.lineTo(area.l+0.5,area.b);this.bar_ctx.stroke();this.bar_ctx.restore();},render_workday_off_fn:function(area)
{this.bg_ctx.fillStyle="rgb(210,210,210)";this.bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},render_marker_fn:function(area)
{this.marker_ctx.fillStyle="rgb(210,210,210)";this.marker_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},generate_quarter_background_areas:function()
{var scroll_height=this.calc_full_size_area_height();var x=0;var cls='';var new_end_date;var month_of_year=0;var cur_date=this.time_bounds.low.clone();var end_date=this.time_bounds.high.clone();while(cur_date.getTime()<end_date.getTime())
{new_end_date=cur_date.add(Date.MONTH,1);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:0,b:scroll_height,render_fn:this.render_marker_fn,type:'marker'});x+=w;cur_date=new_end_date;}},generate_year_background_areas:function()
{var scroll_height=this.calc_full_size_area_height();var x=0;var month_of_year;var cur_date=this.time_bounds.low.clone();var end_date=this.time_bounds.high.clone();while(cur_date.getTime()<end_date.getTime())
{month_of_year=cur_date.format('n');if(month_of_year<4)
new_end_date=new SG.Date(cur_date.format('Y')+'-04-01');else if(month_of_year<7)
new_end_date=new SG.Date(cur_date.format('Y')+'-07-01');else if(month_of_year<10)
new_end_date=new SG.Date(cur_date.format('Y')+'-10-01');else
{var next_year=Number(cur_date.format('Y'))+1;new_end_date=new SG.Date(next_year+'-01-01');}
if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:34,b:scroll_height,render_fn:this.render_marker_fn,type:'marker'});x+=w;cur_date=new_end_date;}},generate_work_day_rules_background_areas:function()
{if(!this.work_day_rules_ds.is_loaded())return;this.generate_default_work_week_areas(this.work_week_rules.work_week);this.generate_row_rules(this.work_week_rules.project_rules,false);this.generate_row_rules(this.work_week_rules.user_rules,true);this.generate_full_height_exceptions(this.work_week_rules.site_exceptions);var project=this.single_project_from_context();if(project)
this.generate_full_height_exceptions(this.work_week_rules.project_exceptions);else
this.generate_exceptions(this.work_week_rules.project_exceptions,false);this.generate_exceptions(this.work_week_rules.user_exceptions,true);if(this.major_unit=='week'||this.major_unit=='month')
this.generate_multi_assignee_background_areas();},generate_multi_assignee_background_areas:function()
{var records=[];for(var i=0;i<this.grid_ds.count();i++)
{var r=this.grid_ds.get_record(i);var assignees=r.get('task_assignees');if(assignees&&assignees.length>1)
records.push(r);}
if(records.length>0)
this.generate_multi_assignee_background_areas_for_records(records);},generate_multi_assignee_background_areas_for_records:function(records)
{var work_day_helper=new SG.util.WorkDayHelper({work_week_rules:this.work_week_rules});var end_time=this.time_bounds.high.getTime();var grid_container=this.grid_widget.get_container();var y_offset=this.container.getTop();var y_scroll=this.scroll_wrapper.dom.scrollTop;for(var i=0;i<records.length;i++)
{var record=records[i];work_day_helper.init_for_task_record(record);var cur_date=this.time_bounds.low.clone();var x=0;var selector='div.row[record_id="'+record.id+'"]';var selection_bars=sg_find_all(selector,grid_container.dom);while(cur_date.getTime()<end_time)
{var config=work_day_helper.evaluate(cur_date);if(config.working!='on')
{for(var j=0;j<selection_bars.length;j++)
{var bar=Ext.get(selection_bars[j]);var y=bar.getTop()-y_offset+y_scroll;var render_fn=this.render_workday_off_fn;if(config.working=='mixed')
render_fn=this.render_partial_work_rule_fn;this.background_areas.push({id:this.gen_area_id(),l:x,r:x+this.day_length,t:y,b:y+bar.dom.clientHeight+1,render_fn:render_fn,sg_tip:this.render_multi_rule_tooltip(config.rules,cur_date),rule:config.rules,type:config.working=='mixed'?'workday_mixed':'workday_off'});}}
x+=this.day_length;cur_date=cur_date.add(Date.DAY,1);}}},generate_default_work_week_areas:function(work_week)
{var scroll_height=this.calc_full_size_area_height();var x=0;var cur_date=this.time_bounds.low.clone();var utc_end_date=this.time_bounds.high.getTime();while(cur_date.getTime()<utc_end_date)
{var day_of_week=Number(cur_date.format('w'));var rule;var working=true;var day_rules=work_week[day_of_week];for(var i=0;i<day_rules.length;i++)
{rule=day_rules[i];if(rule.start_date)
{var start_date=new SG.Date(rule.start_date).getTime();if(cur_date.getTime()>=start_date)
{working=rule.working;break;}}
else
working=rule.working;}
this.background_areas.push({id:this.gen_area_id(),l:x,r:x+this.day_length,t:0,b:scroll_height,rule:rule,render_fn:this.render_work_rule_fn,sg_tip:this.render_rule_tooltip(rule,cur_date),type:working?'workday_on':'workday_off'});x+=this.day_length;cur_date=cur_date.add(Date.DAY,1);}},generate_row_rules:function(rules,are_user_rules)
{if(rules.length==0)return;var i,j,k;var ids={};for(i=0;i<rules.length;i++)
{var rule=rules[i];var entity_id=are_user_rules?rule.user.id:rule.project.id;if(!ids[entity_id])
ids[entity_id]={0:[],1:[],2:[],3:[],4:[],5:[],6:[]};ids[entity_id][rule.day_of_week].push(rule);}
for(var id in ids)
{if(!ids.hasOwnProperty(id))continue;var week_of_rules=ids[id];for(i=0;i<7;i++)
{week_of_rules[i].sort(function(a,b)
{var a_start=new SG.Date(a.start_date).getTime();var b_start=new SG.Date(b.start_date).getTime();if(a_start<b_start)
return 1;else if(a_start>b_start)
return-1;else
return 0;});}}
var render_func=function(record,group_idx,ids,are_user_rules)
{if(are_user_rules)
{var assignees=record.get('task_assignees');if(!assignees)return;if(assignees.length!=1)return;var assigned=assignees[0];if(assigned.id in ids)
this.generate_rule_for_record(record.get_id(),group_idx,ids[assigned.id]);}
else
{var project=record.get('project');if(!project)return;if(project.id in ids)
this.generate_rule_for_record(record.get_id(),group_idx,ids[project.id]);}};var ds=this.grid_ds;if(ds.is_grouped())
{for(i=0;i<ds.group_count();i++)
{var group=ds.get_group(i);var grp_recs=group.ids;for(j=0;j<grp_recs.length;j++)
{var r=ds.get_record_by_id(grp_recs[j]);render_func.call(this,r,i,ids,are_user_rules);}}}
else
{for(i=0;i<ds.count();i++)
{var r=ds.get_record(i);render_func.call(this,r,-1,ids,are_user_rules);}}},generate_rule_for_record:function(record_id,group_idx,week_of_rules)
{var x=0;var grid_container=this.grid_widget.get_container();var y_offset=this.container.getTop();var y_scroll=this.scroll_wrapper.dom.scrollTop;var selector='div.row[record_id="'+record_id+'"][group_idx="'+group_idx+'"]';var selection_bars=sg_find_all(selector,grid_container.dom);for(var i=0;i<selection_bars.length;i++)
{var bar=Ext.get(selection_bars[i]);var y=bar.getTop()-y_offset+y_scroll;var cur_date=this.time_bounds.low.clone();var utc_end_date=this.time_bounds.high.getTime();while(cur_date.getTime()<utc_end_date)
{var day_of_week=Number(cur_date.format('w'));var rules=week_of_rules[day_of_week];for(var j=0;j<rules.length;j++)
{var rule=rules[j];var start_date=new SG.Date(rule.start_date).getTime();if(cur_date.getTime()>=start_date)
{this.background_areas.push({id:this.gen_area_id(),l:x,r:x+this.day_length,t:y,b:y+bar.dom.clientHeight+1,rule:rule,render_fn:this.render_work_rule_fn,sg_tip:this.render_rule_tooltip(rule,cur_date),type:rule.working?'workday_on':'workday_off'});break;}}
x+=this.day_length;cur_date=cur_date.add(Date.DAY,1);}}},generate_full_height_exceptions:function(rules)
{var h=this.calc_full_size_area_height();for(var i=0;i<rules.length;i++)
{var rule=rules[i];var start_date=new SG.Date(rule.start_date);var x=this.calc_time_distance_in_pixels(this.time_bounds.low,start_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+this.day_length,t:0,b:h,rule:rule,render_fn:this.render_work_rule_fn,sg_tip:this.render_rule_tooltip(rule,start_date),type:rule.working?'workday_on':'workday_off'});}},generate_exceptions:function(rules,are_user_rules)
{var ids={};for(var i=0;i<rules.length;i++)
{var rule=rules[i];var entity_id=are_user_rules?rule.user.id:rule.project.id;if(!ids[entity_id])
ids[entity_id]=[rule];else
ids[entity_id].push(rule);}
var render_func=function(record,group_idx,ids,are_user_rules)
{if(are_user_rules)
{var assignees=record.get('task_assignees');if(!assignees)return;if(assignees.length!=1)return;var assignee=assignees[0];if(assignee.id in ids)
this.generate_row_exception(record.id,group_idx,ids[assignee.id]);}
else
{var project=record.get('project');if(!project)return;if(project.id in ids)
this.generate_row_exception(record.id,group_idx,ids[project.id]);}};var ds=this.grid_ds;if(ds.is_grouped())
{for(i=0;i<ds.group_count();i++)
{var group=ds.get_group(i);var grp_recs=group.ids;for(j=0;j<grp_recs.length;j++)
{var r=ds.get_record_by_id(grp_recs[j]);render_func.call(this,r,i,ids,are_user_rules);}}}
else
{for(i=0;i<ds.count();i++)
{var r=ds.get_record(i);render_func.call(this,r,-1,ids,are_user_rules);}}},generate_row_exception:function(record_id,group_idx,rules)
{var grid_container=this.grid_widget.get_container();var y_offset=this.container.getTop();var y_scroll=this.scroll_wrapper.dom.scrollTop;var selector='div.row[record_id="'+record_id+'"][group_idx="'+group_idx+'"]';var selection_bars=sg_find_all(selector,grid_container.dom);for(var i=0;i<rules.length;i++)
{var rule=rules[i];var start_date=rule.start_date_js;if(start_date.getTime()<this.time_bounds.low.getTime()||start_date.getTime()>this.time_bounds.high.getTime())
continue;var x=this.calc_time_distance_in_pixels(this.time_bounds.low,start_date);for(var j=0;j<selection_bars.length;j++)
{var bar=Ext.get(selection_bars[j]);var y=bar.getTop()-y_offset+y_scroll;this.background_areas.push({id:this.gen_area_id(),l:x,r:x+this.day_length,t:y,b:y+20,rule:rule,render_fn:this.render_work_rule_fn,sg_tip:this.render_rule_tooltip(rule,start_date),type:rule.working?'workday_on':'workday_off'});}}},grow_time_bounds:function(bound,adate)
{if(!adate)
return;if(bound.low==null)
bound.low=adate;else if(adate.getTime()<bound.low.getTime())
bound.low=adate;if(bound.high==null)
bound.high=adate;else if(adate.getTime()>bound.high.getTime())
bound.high=adate;},calculate_entire_time_bounds:function()
{var bound={low:null,high:null};var ds=this.grid_ds;var i,r,s,e;var s_date,e_date;for(i=0;i<ds.count();i++)
{r=ds.get_record(i);s=r.get('start_date');e=r.get('due_date');if(s)
{s_date=new SG.Date(s);this.grow_time_bounds(bound,s_date);}
if(e)
{e_date=new SG.Date(e);this.grow_time_bounds(bound,e_date);}}
return bound;},adjust_bounds_for_screen:function(time_bounds)
{var major_unit=this.get('major_unit');var w=this.container.getWidth();var dt;var dx=this.length_of_a_day_in_pixels[major_unit];var l=this.get_fields('left_fields').length+1;var r=this.get_fields('right_fields').length+1;if(major_unit=='week')
{time_bounds.low=time_bounds.low.add(Date.DAY,-4*l);time_bounds.high=time_bounds.high.add(Date.DAY,4*r);}
else if(major_unit=='month')
{time_bounds.low=time_bounds.low.add(Date.DAY,-8*l);time_bounds.high=time_bounds.high.add(Date.DAY,8*r);}
else if(major_unit=='month_weeks')
{time_bounds.low=time_bounds.low.add(Date.DAY,-24*l);time_bounds.high=time_bounds.high.add(Date.DAY,24*r);}
else if(major_unit=='quarter')
{time_bounds.low=time_bounds.low.add(Date.DAY,-64*l);time_bounds.high=time_bounds.high.add(Date.DAY,64*r);}
else
{time_bounds.low=time_bounds.low.add(Date.DAY,-128*l);time_bounds.high=time_bounds.high.add(Date.DAY,128*r);}
dt=this.calc_time_distance_in_pixels(time_bounds.low,time_bounds.high);if(dt<w)
{var days=Math.floor((w-dt)/dx)+1;time_bounds.high=time_bounds.high.add(Date.DAY,days);}},calc_time_distance_in_pixels:function(from,to)
{var days=Math.floor((to.getTime()-from.getTime())/(1000*24*60*60));return days*this.day_length;},render_minor_headers_days:function(low,high)
{var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var half_day=Math.floor(this.day_length/2);var utc_end_date=high.getTime();var cur_date=low.clone();while(cur_date.getTime()<utc_end_date)
{h=cur_date.format('j');this.canvas_text(this.bar_ctx,h,x+half_day,29);x+=this.day_length;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,17);this.bar_ctx.lineTo(x+0.5,33);this.bar_ctx.stroke();cur_date=cur_date.add(Date.DAY,1);}},canvas_text:function(ctx,str,x,y)
{if(this.is_ff_3)
{ctx.save();ctx.mozTextStyle='11px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';var x_off=Math.floor(ctx.mozMeasureText(str)/2);ctx.translate(x-x_off,y);ctx.mozDrawText(str);ctx.restore();}
else
ctx.fillText(str,x,y);},render_month_days_header:function(low,high)
{var end_date=high.clone();var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var h='';var new_end_date;var cur_date=low.clone();var end_year,end_month,w;while(cur_date.getTime()<end_date.getTime())
{end_year=parseInt(cur_date.format('Y'));end_month=parseInt(cur_date.format('n'))+1;if(end_month==13)
{end_month=1;end_year+=1;}
new_end_date=new SG.Date(end_year+'-'+this.pad2(end_month)+'-01');if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>200)
{h=cur_date.format('F Y');this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),12);}
x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,0);this.bar_ctx.lineTo(x+0.5,16);this.bar_ctx.stroke();cur_date=new_end_date;}
this.render_minor_headers_days(low,high);},render_month_weeks_header:function(low,high)
{var end_date=high.clone();var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var h='';var new_end_date;var cur_date=low.clone();var end_year,end_month,w;while(cur_date.getTime()<end_date.getTime())
{end_year=parseInt(cur_date.format('Y'));end_month=parseInt(cur_date.format('n'))+1;if(end_month==13)
{end_month=1;end_year+=1;}
new_end_date=new SG.Date(end_year+'-'+this.pad2(end_month)+'-01');if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>50)
{h=cur_date.format('M y');this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),12);}
x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,0);this.bar_ctx.lineTo(x+0.5,16);this.bar_ctx.stroke();cur_date=new_end_date;}
x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;cur_date=low.clone();while(cur_date.getTime()<end_date.getTime())
{var day_of_week=cur_date.format('w');var offset=7;if(day_of_week!=1)
{if(day_of_week==0)
offset=1;else
offset=7-(day_of_week-1);}
new_end_date=cur_date.add(Date.DAY,offset);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>16)
{h=cur_date.format('d');this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),29);}
x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,17);this.bar_ctx.lineTo(x+0.5,33);this.bar_ctx.stroke();cur_date=new_end_date;}},render_week_header:function(low,high)
{var end_date=high.clone();var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var h='';var new_end_date;var day_of_week,w;var cur_date=low.clone();var utc_end_date=high.getTime();while(cur_date.getTime()<utc_end_date)
{day_of_week=cur_date.format('w');if(day_of_week==0)
{new_end_date=cur_date.add(Date.DAY,7);h=cur_date.format('j/M')+' - '+new_end_date.format('j/M');}
else
{new_end_date=cur_date.add(Date.DAY,(7-day_of_week));var temp=new_end_date.add(Date.DAY,-7);h=temp.format('j/M')+' - '+new_end_date.format('j/M');}
if(new_end_date.getTime()>utc_end_date)
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>70)
this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),12);x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,0);this.bar_ctx.lineTo(x+0.5,16);this.bar_ctx.stroke();cur_date=new_end_date;}
this.render_minor_headers_days(low,high);},render_quarter_header:function(low,high)
{var end_date=high.clone();var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var h='';var new_end_date;var month_of_year,w;var cur_date=low.clone();while(cur_date.getTime()<end_date.getTime())
{month_of_year=cur_date.format('n');if(month_of_year<4)
{new_end_date=new SG.Date(cur_date.format('Y')+'-04-01');h='Qtr 1/'+cur_date.format('Y');}
else if(month_of_year<7)
{new_end_date=new SG.Date(cur_date.format('Y')+'-07-01');h='Qtr 2/'+cur_date.format('Y');}
else if(month_of_year<10)
{new_end_date=new SG.Date(cur_date.format('Y')+'-10-01');h='Qtr 3/'+cur_date.format('Y');}
else
{var next_year=Number(cur_date.format('Y'))+1;new_end_date=new SG.Date(next_year+'-01-01');h='Qtr 4/'+cur_date.format('Y');}
if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>70)
this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),12);x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,0);this.bar_ctx.lineTo(x+0.5,16);this.bar_ctx.stroke();cur_date=new_end_date;}
x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var month_of_year=0;cur_date=low.clone();while(cur_date.getTime()<end_date.getTime())
{month_of_year=cur_date.format('n');new_end_date=cur_date.add(Date.MONTH,1);h=cur_date.format('M');if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>50)
this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),29);x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,17);this.bar_ctx.lineTo(x+0.5,33);this.bar_ctx.stroke();cur_date=new_end_date;}},render_year_header:function(low,high)
{var end_date=high.clone();var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var h='';var new_end_date;var year,w;var cur_date=low.clone();while(cur_date.getTime()<end_date.getTime())
{year=cur_date.format('Y');new_end_date=cur_date.add(Date.YEAR,1);new_end_date=new SG.Date(new_end_date.format('Y')+'-01-01');h=cur_date.format('Y');if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>70)
this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),12);x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,0);this.bar_ctx.lineTo(x+0.5,16);this.bar_ctx.stroke();cur_date=new_end_date;}
x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.view_port.l;var month_of_year;var cur_date=low.clone();while(cur_date.getTime()<end_date.getTime())
{month_of_year=cur_date.format('n');if(month_of_year<4)
{new_end_date=new SG.Date(cur_date.format('Y')+'-04-01');h='Qtr 1';cls='header_marker odd';}
else if(month_of_year<7)
{new_end_date=new SG.Date(cur_date.format('Y')+'-07-01');h='Qtr 2';cls='header_marker even';}
else if(month_of_year<10)
{new_end_date=new SG.Date(cur_date.format('Y')+'-10-01');h='Qtr 3';cls='header_marker odd';}
else
{var next_year=Number(cur_date.format('Y'))+1;new_end_date=new SG.Date(next_year+'-01-01');h='Qtr 4';cls='header_marker even';}
if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(w>70)
this.canvas_text(this.bar_ctx,h,x+Math.floor(w/2),29);x+=w;this.bar_ctx.beginPath();this.bar_ctx.moveTo(x+0.5,17);this.bar_ctx.lineTo(x+0.5,33);this.bar_ctx.stroke();cur_date=new_end_date;}},get_action_menu_items:function(items,target_elem,xy)
{var selected_ids=this.get_selected_record_ids();items.entity.push({html:'Bar Color...',disabled:!this.color_editable||selected_ids.length==0,item_selected:{fn:this.show_bar_color_editor,scope:this}});var mode=this.get('major_unit');var zoom_items=[{html:'Week & Day',value:'week',checked:mode=='week',item_selected:{fn:this.on_timescale_select,scope:this},},{html:'Month & Day',value:'month',checked:mode=='month',item_selected:{fn:this.on_timescale_select,scope:this},},{html:'Month & Week',value:'month_weeks',checked:mode=='month_weeks',item_selected:{fn:this.on_timescale_select,scope:this},},{html:'Quarter & Month',value:'quarter',checked:mode=='quarter',item_selected:{fn:this.on_timescale_select,scope:this},},{html:'Year & Quarter',value:'year',checked:mode=='year',item_selected:{fn:this.on_timescale_select,scope:this},}];items.entity.push({html:'Zoom Gantt',icon_name:'icon_zoom_task_dependencies',submenu:{items:zoom_items}});var group_bar_color=this.get('group_bar_color');var display_group_bars=this.get('display_group_bars');var display_project_dates=this.get('display_project_dates');var display_items=[{html:'Display fields to left...',item_selected:{fn:this.show_manage_left_columns_dialog,scope:this}},{html:'Display fields to right...',item_selected:{fn:this.show_manage_right_columns_dialog,scope:this}},{html:'Display Project Dates',value:'display_project_dates',checked:display_project_dates,item_selected:{fn:this.toggle_project_dates_display,scope:this}},{html:'Display Group Bars',value:'display_group_bars',checked:display_group_bars,item_selected:{fn:this.toggle_group_bar_display,scope:this}},];display_items.push({html:'Group Bar Color...',disabled:!display_group_bars,item_selected:{fn:this.show_group_bar_color_editor,scope:this},});items.entity.push({html:'Gantt Display Options',submenu:{items:display_items}});},position_color_editor_based_on_last_click:function()
{var edit_container=this.container.child('div.color_edit_container');var l=this.last_click_xy[0]-this.container.getLeft()-90;var t=this.last_click_xy[1]-this.container.getTop()-90;var diff=this.container.getWidth()-(l+220);if(diff<0)
l+=diff;diff=this.container.getHeight()-(t+220);if(diff<0)
t+=diff;edit_container.setLeft(l);edit_container.setTop(t);return edit_container;},show_group_bar_color_editor:function(menu,menu_item)
{var edit_container=this.position_color_editor_based_on_last_click();var color=this.get('group_bar_color');var tmp_ds=new SG.Data.Set('Task');var record=tmp_ds.new_record();record.set('color',color);var editor=SG.GridEditorFactory('color');var edit_context={container:this.container,cell_element:edit_container.dom,record:record,column_name:'color',};var me=this;this.add_event(editor,"blur",function(e){me.set('group_bar_color',editor.color);editor.cleanup();me.render_widget();});editor.edit(edit_context);},show_bar_color_editor:function(menu,menu_item)
{var selected_ids=sg_deep_copy(this.get_selected_record_ids());var edit_container=this.position_color_editor_based_on_last_click();var grid_record=this.grid_ds.get_record_by_id(selected_ids[0]);var tmp_ds=new SG.Data.Set('Task');var record=tmp_ds.new_record();record.set('color',grid_record.get('color'));var editor=SG.GridEditorFactory('color');var edit_context={container:this.container,cell_element:edit_container.dom,record:record,column_name:'color',};var me=this;this.add_event(editor,"blur",function(e){me.grid_ds.start_batch();for(var i=0;i<selected_ids.length;i++)
{var rec=me.grid_ds.get_record_by_id(selected_ids[i]);rec.set('color',editor.color);}
me.grid_ds.end_batch();me.grid_ds.commit();editor.cleanup();me.render_widget();});editor.edit(edit_context);},on_bar_color_select:function(menu,menu_item)
{var selected_ids=this.get_selected_record_ids();this.grid_ds.start_batch();for(var i=0;i<selected_ids.length;i++)
{var r=this.grid_ds.get_record_by_id(selected_ids[i]);r.set('color',menu_item.value);}
this.grid_ds.end_batch();this.grid_ds.commit();},on_timescale_select:function(menu,item)
{var gw=this;setTimeout(function(){gw.set_major_unit(item.value);gw.re_render_toolbar();},0);},re_render_toolbar:function(){var parent=this.get_parent();var grand_parent=parent.get_parent();if(grand_parent.toolbar)
grand_parent.toolbar.render();},set_major_unit:function(value,silent)
{var old_value=this.get('major_unit');if(value==old_value)return;if(silent)
this.set_silent('major_unit',value);else
this.set('major_unit',value);this.set_canvas_visibility();this.regenerate_all_areas();this.center_scroll(true);this.render_widget();},toggle_group_bar_display:function(menu,item)
{var gw=this;setTimeout(function(){gw.set('display_group_bars',!gw.get('display_group_bars'));gw.render_widget();});},toggle_project_dates_display:function(menu,item)
{var gw=this;setTimeout(function(){var display_project_dates=!gw.get('display_project_dates');gw.set('display_project_dates',display_project_dates)
if(display_project_dates)
gw.read_project_dates();else
gw.render_widget();},0);},show_manage_right_columns_dialog:function()
{var config={entity_type:'Task',columns:this.get_fields('right_fields'),join_fields:[],field_disabled_callback:{fn:this.left_right_fields_disabled_callback,scope:this},sg_dialog_header_text:'Display Fields to the Right'};if(this.is_ff_3)
config.warning_message=this.get_browser_warning_message_text();var mcd=new SG.ManageColumnsDialog(config);mcd.on('dialog_submitted',this.on_dialog_manage_right_columns,this);},left_right_fields_disabled_callback:function(schema_field)
{var index=['checkbox','summary'].indexOf(schema_field.data_type);return(index!=-1);},on_dialog_manage_right_columns:function(added,removed)
{var i;var right_fields=this.get_fields('right_fields');var new_right_fields=[];for(i=0;i<added.length;i++)
new_right_fields.push(added[i]);for(i=0;i<right_fields.length;i++)
{if(removed.indexOf(right_fields[i])==-1)
new_right_fields.push(right_fields[i]);}
this.set('right_fields',new_right_fields);this.right_fields=new_right_fields;if(new_right_fields.length==0)
this.render_widget();else
this.read_fields();},show_manage_left_columns_dialog:function()
{var config={entity_type:'Task',columns:this.get_fields('left_fields'),join_fields:[],field_disabled_callback:{fn:this.left_right_fields_disabled_callback,scope:this},sg_dialog_header_text:'Display Fields to the Left'};if(this.is_ff_3)
config.warning_message=this.get_browser_warning_message_text();var mcd=new SG.ManageColumnsDialog(config);mcd.on('dialog_submitted',this.on_dialog_manage_left_columns,this);},get_fields:function(setting)
{var ret=[];var fields=this.get(setting);for(var i=0;i<fields.length;i++)
{var schema_field=SG.schema.get_field('Task',fields[i]);if(schema_field)
ret.push(fields[i]);}
return ret;},on_dialog_manage_left_columns:function(added,removed)
{var i;var left_fields=this.get_fields('left_fields');var new_left_fields=[];for(i=0;i<added.length;i++)
new_left_fields.push(added[i]);for(i=0;i<left_fields.length;i++)
{if(removed.indexOf(left_fields[i])==-1)
new_left_fields.push(left_fields[i]);}
this.set('left_fields',new_left_fields);this.left_fields=new_left_fields;if(new_left_fields.length==0)
this.render_widget();else
this.read_fields();},on_grid_rendered:function(){var gw=this;setTimeout(function(){gw.regenerate_all_areas();gw.render_widget();},0);},render_tool_tip:function(task_name,task_status,addressees,start_date,end_date,milestone,early_days)
{var is_milestone=(milestone!=undefined&&milestone==1);var schema_fields=SG.schema.entity_fields['Task'];var tip;if(is_milestone)
tip='<b>Milestone: '+task_name+'</b><br>';else
tip='<b>'+task_name+'</b><br>';if(task_status!=null)
{if(task_status!='')
{var status_icon=SG.Renderers.status_list.render_nbsp(task_status);tip+=schema_fields['sg_status_list']['display_name']+': ';tip+=status_icon
tip+='  '+SG.schema.status_list[task_status].name+'<br>';}
else
tip+=schema_fields['sg_status_list']['display_name']+':<br>';}
if(addressees!=null)
{var s='';for(var i=0;i<addressees.length;i++)
{if(i!=0)
s+=','+addressees[i].name;else
s+=addressees[i].name;}
tip+=schema_fields['task_assignees']['display_name']+': '+s+'<br>';}
if(is_milestone)
{if(start_date)
{tip+='Date: '+start_date.format('D, M j y');if(early_days!=null)
tip+='<span style="color:red;">  ('+early_days+' days early)</span>';tip+='<br>';}
else
tip+='Date: '+end_date.format('D, M j y')+'<br>';}
else
{if(start_date)
{tip+=schema_fields['start_date']['display_name']+': '+start_date.format('D, M j y');if(early_days!=null)
tip+='<span style="color:red;">  ('+early_days+' days early)</span>';tip+='<br>';}
else
tip+=schema_fields['start_date']['display_name']+':<br>';if(end_date)
tip+=schema_fields['due_date']['display_name']+': '+end_date.format('D, M j y')+'<br>';else
tip+=schema_fields['due_date']['display_name']+':<br>';}
return'<div class="task_tip">'+tip+'<div>';},render_rule_tooltip:function(rule,date)
{var click_prompt='';if(SG.schema.can_create_entity('WorkDayRule'))
click_prompt=this.templates.day_off_tooltip_click_prompt.apply();return this.templates.day_off_tooltip.apply({rule_type_name:rule.working?'On Day':'Off Day',off_day:date.format('l, F j'),description:(rule&&rule.description)?rule.description:'(no description)',work_schedule:rule.user?rule.user.name:rule.project?rule.project.name:'Default',click_prompt:click_prompt});},render_multi_rule_tooltip:function(rules,date)
{if(rules.length==1)
return this.render_rule_tooltip(rules[0],date);var rules_html=[];for(var i=0;i<rules.length;i++)
{var rule=rules[i];var h='';if(rule.user!=null)
h='User '+rule.user.name;else if(rule.project!=null)
h='Project '+rule.project.name;else
h='Default';if(rule.exception)
h+=' Exception';else
h+=' Normal Work Week';h+=rule.working?' <b>On</b>':' <b>Off</b>';rules_html.push('<div class="multi_rule_tooltip">'+h+'</div>');}
var click_prompt='';if(SG.schema.can_create_entity('WorkDayRule'))
click_prompt=this.templates.day_off_tooltip_click_prompt.apply();return this.templates.mixed_rule_day.apply({rules:rules_html.join(''),click_prompt:click_prompt});},on_load_project_dates:function()
{this.generate_project_date_areas();this.render_widget();},generate_project_date_areas:function()
{this.project_date_areas=[];if(this.project_ds.is_loaded()&&this.project_ds.count()==1)
{var scroll_height=this.calc_full_size_area_height();var cols=this.get_project_date_columns();var r=this.project_ds.get_record(0);var schema_fields=SG.schema.entity_fields['Project'];var i,s,s_date,s_time;for(i=0;i<cols.length;i++)
{s=r.get(cols[i]);if(s)
{s_date=new SG.Date(s);s_time=s_date.getTime();if(s_time>=this.time_bounds.low.getTime()&&s_time<=this.time_bounds.high.getTime())
{var sg_tip=schema_fields[cols[i]]['display_name']+': '+s_date.format('D, M j y');var l=this.calc_time_distance_in_pixels(this.time_bounds.low,s_date)
this.project_date_areas.push({id:this.gen_area_id(),l:l,r:l+this.day_length,t:0,b:scroll_height,render_fn:this.render_project_date_fn,sg_tip:sg_tip,type:'bg_marker'});}}}}},on_load_fields:function()
{this.left_fields=this.get_fields('left_fields');this.right_fields=this.get_fields('right_fields');var all_fields=this.get_all_fields();this.canvas_field_renderer=new SG.util.CanvasFieldRenderer({entity_type:'Task',fields:all_fields,ctx:this.bar_ctx,is_ff_3:this.is_ff_3});this.render_widget();},render_project_date_fn:function(area)
{this.marker_ctx.globalAlpha=0.5;this.marker_ctx.fillStyle="rgb(103,155,222)";this.marker_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);this.marker_ctx.globalAlpha=1.0;},get_all_fields:function()
{var all_fields=[];all_fields=all_fields.concat(this.get_fields('left_fields'));var right_fields=this.get_fields('right_fields');for(var i=0;i<right_fields.length;i++)
{var right_field=right_fields[i];if(all_fields.indexOf(right_field)==-1)
all_fields.push(right_field);}
return all_fields;},read_fields:function()
{if(this.context.get('stowed'))
return;var all_fields=this.get_all_fields();var task_ids=this.grid_ds.get_ids();if(task_ids.length==0||all_fields.length==0)return;var spec={type:'Task',ids:task_ids,columns:all_fields,result:this.gantt_ds};SG.Repo.find(spec);},get_time_at_pixel:function(x)
{var days=Math.round(x/this.day_length);var ret=this.time_bounds.low.add(Date.DAY,days);return ret;},on_grid_thumbnail_loaded:function()
{this.thumbnail_load_count++;var me=this;var count_now=this.thumbnail_load_count;setTimeout(function(){me.re_render_for_thumb(count_now);},200);},re_render_for_thumb:function(count)
{if(count==this.thumbnail_load_count)
{this.regenerate_all_areas();this.render_widget();}},calc_browser_scroll_bar_width:function()
{var scr=null;var inn=null;var wNoScroll=0;var wScroll=0;scr=document.createElement('div');scr.style.position='absolute';scr.style.top='100px';scr.style.left='100px';scr.style.width='200px';scr.style.height='150px';inn=document.createElement('div');inn.style.width='100&#37;';inn.style.height='200px';scr.appendChild(inn);document.body.appendChild(scr);scr.style.overflow='hidden';wNoScroll=inn.offsetWidth;scr.style.overflow='scroll';wScroll=inn.offsetWidth;if(wNoScroll==wScroll)wScroll=scr.clientWidth;document.body.removeChild(document.body.lastChild);this.browser_scroll_bar_width=(wNoScroll-wScroll);},get_toolbar_items:function()
{var items=[];items.push({position:'right',render_callback:{fn:this.render_gantt_zoom_slider,scope:this},});items.push({position:'right',html:this.templates.toolbar_button.apply({left_class:'left',label:'Today',}),onclick:{fn:this.center_gantt_on_today,scope:this},sg_tip:"Scroll to Today's date in the Gantt",cls:'today'});return items;},center_gantt_on_today:function(){var now=new SG.Date();var days=Math.floor(this.canvas_width*.5/this.day_length);now=now.add(Date.DAY,-1*days);var now_time=now.getTime();var low_time=this.time_bounds.low.getTime();var high_time=this.time_bounds.high.getTime();var do_regen=true;if(now_time<low_time){this.time_bounds.low=now.add(Date.DAY,-1*days);}else if(now_time>high_time){this.time_bounds.high=now.add(Date.DAY,2*days);}else{do_regen=false;}
if(do_regen)
this.regenerate_all_areas(true);this.last_scroll_date=now;this.restore_scroll();},render_gantt_zoom_slider:function()
{return this.templates.zoom_slider.apply({mode:this.get('major_unit'),id:this.get_zoom_slider_id(),});},get_zoom_slider_id:function()
{return'gantt_zoom_slider_'+this.get_widget_id();},setup_zoom_slider:function()
{var slider_container=this.container.findParent('div.sgw_entity_query_entity_query_page',document.body,true);if(slider_container&&slider_container.hasClass('embedded')){var wrapper_div=slider_container.findParent('div.sgw_canvas_wrapper',document.body,true);if(wrapper_div)
slider_container=wrapper_div;else
slider_container=Ext.get(slider_container.dom.parentNode);}else if(!slider_container){return;}
this.gantt_zoom_slider=new SG.GanttZoomSlider({gantt:this,container:slider_container,scroll:false});},pad2:function(num)
{if(num<10)
return'0'+num;else
return num;},set_canvas_visibility:function()
{var major_unit=this.get('major_unit');if(major_unit=='week'||major_unit=='month')
{if(this.bg_canvas.hasClass('hidden'))
this.bg_canvas.removeClass('hidden');}
else
{if(!this.bg_canvas.hasClass('hidden'))
this.bg_canvas.addClass('hidden');}},});SG.GanttZoomSlider=function(config)
{Ext.apply(this,config);var empty=Ext.get('sg_grid_row_drag_nothing');if(!empty)
Ext.DomHelper.append(document.body,{tag:"div",id:"sg_grid_row_drag_nothing"},true);SG.GanttZoomSlider.superclass.constructor.call(this,this.container,"gantt_zoom_slider",config);this.setDragElId("sg_grid_row_drag_nothing");this.gantt_zoom_levels=['year','quarter','month_weeks','month','week'];};Ext.extend(SG.GanttZoomSlider,Ext.dd.DDProxy,{handleMouseDown:function(e)
{var slider_id=this.gantt.get_zoom_slider_id();var target=Ext.get(e.getTarget());this.slider_div=target.findParent('div.'+slider_id,5,true)
if(!this.slider_div)return;this.knob=target.findParent('div.knob',5,true);if(!this.knob)return;this.start_x=e.xy[0];this.starting_mode_index=this.gantt_zoom_levels.indexOf(this.gantt.major_unit);this.last_mode_index=this.starting_mode_index;this.offset=0;SG.GanttZoomSlider.superclass.handleMouseDown.apply(this,arguments);},startDrag:function(x,y){this.knob.replaceClass('slider_gripoff','slider_gripon');},calc_offset:function(e){var diff_x=e.xy[0]-this.start_x;var offset;if(diff_x<0)
offset=Math.ceil(diff_x/10);else
offset=Math.floor(diff_x/10);return offset;},onDrag:function(e){var offset=this.calc_offset(e);if(offset!=this.offset)
{var new_index=this.starting_mode_index+offset;if(new_index<0)new_index=0;if(new_index>=this.gantt_zoom_levels.length-1)new_index=this.gantt_zoom_levels.length-1;var old_class=this.gantt_zoom_levels[this.last_mode_index];var new_class=this.gantt_zoom_levels[new_index];if(old_class==new_class)return;var me=this;setTimeout(function(){me.gantt.set_major_unit(new_class,true);},0);this.slider_div.replaceClass(old_class,new_class);this.last_mode_index=new_index;this.offset=offset;}},endDrag:function(e){this.knob.replaceClass('slider_gripon','slider_gripoff');var new_index=this.starting_mode_index+this.offset;if(new_index<0)new_index=0;if(new_index>=this.gantt_zoom_levels.length-1)new_index=this.gantt_zoom_levels.length-1;var me=this;var new_unit=this.gantt_zoom_levels[new_index];setTimeout(function(){me.gantt.set_major_unit(new_unit);},0);},});SG.NewGanttTooltips=function(config)
{Ext.apply(this,config);SG.NewGanttTooltips.superclass.constructor.call(this,config);};Ext.extend(SG.NewGanttTooltips,SG.Component,{hide_delay:10000,show_delay:200,templates:{},init_component:function()
{this.layer=new Ext.Layer({cls:'sg_tool_tip_layer gantt_tooltip',shim:true,constrain:true});this.layer.fxDefaults={stopFx:true};this.layer.update('<div class="sg_tool_tip">&nbsp;</div>');this.contents=this.layer.child('div.sg_tool_tip');this.contents.update('&nbsp;');this.add_event(this.container,'mouseout',this.hide);this.add_event(this.container,'mousemove',this.on_move);},on_move:function(e)
{var area=this.find_area_callback.fn.call(this.find_area_callback.scope,e);if((this.area&&area!=this.area)||(this.gantt_widget&&this.gantt_widget.dragging()))
{this.hide();this.cancel_previous_show();}
if(area&&area.sg_tip&&(!this.gantt_widget||!this.gantt_widget.dragging()))
{if(area==this.area)return;this.area=area;var me=this;this.xy=e.xy;this.show_proc=setTimeout(function(){me.show();},this.show_delay);}},cancel_previous_show:function()
{if(this.show_proc)
{clearTimeout(this.show_proc);this.show_proc=null;}},cancel_previous_hide:function()
{if(this.hide_proc)
{clearTimeout(this.hide_proc);this.hide_proc=null;}},hide:function()
{this.area=null;this.layer.hide();},show:function()
{if(!this.area)return;var container_top=this.container.getTop();var container_left=this.container.getLeft();var container_height=this.container.getHeight();var area_top=this.area.t+container_top;this.cancel_previous_hide();this.layer.setLeft(this.xy[0]+15);this.layer.setTop(this.xy[1]+15);this.contents.update(this.area.sg_tip);this.layer.show();this.layer.constrainXY();var me=this;this.hide_proc=setTimeout(function(){me.hide();},this.hide_delay);},});SG.NewGanttSelection=function(config)
{Ext.apply(this,config);SG.NewGanttSelection.superclass.constructor.call(this,config);};Ext.extend(SG.NewGanttSelection,SG.Component,{init_component:function()
{this.last_click=null;this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'contextmenu',this.on_right_click);this.add_event(this.container,'mousedown',this.on_mousedown);},on_mousedown:function(e)
{this.mouse_down_xy=e.xy;},on_right_click:function(e)
{var selection_manager=this.gantt.__get_selection_manager__();var area=this.find_area_callback.fn.call(this.find_area_callback.scope,e);if(!area||area.selected)return;selection_manager.clear_selection();if(area.record_id)
selection_manager.select_entity_by_id(area.record_id,area.group_idx);else
selection_manager.select_group_by_id(area.group_idx);},on_click:function(e)
{var selection_manager=this.gantt.__get_selection_manager__();var area=this.find_area_callback.fn.call(this.find_area_callback.scope,e);if(!area)
{selection_manager.clear_selection();return;}
if(e.xy[0]!=this.mouse_down_xy[0]||e.xy[1]!=this.mouse_down_xy[1])return;var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;if(!dom_event.shiftKey||(this.last_click==null))
{if(!ctrl_click)
selection_manager.clear_selection(true);if(!area.selected)
this.last_click=area;if(area.record_id)
selection_manager.select_entity_by_id(area.record_id,area.group_idx,ctrl_click,true);else
selection_manager.select_group_by_id(area.group_idx,ctrl_click,true);}
else
this.handle_vertical_selection_shift_click(area);selection_manager.fire_selection_callback();},handle_vertical_selection_shift_click:function(shift_click_area)
{var t=shift_click_area.t<this.last_click.t?shift_click_area.t:this.last_click.t;var b=shift_click_area.b>this.last_click.b?shift_click_area.b:this.last_click.b;var areas=this.gantt.active_selection_areas;var selection_manager=this.gantt.__get_selection_manager__();var both_are_groups=(!shift_click_area.record_id&&!this.last_click.record_id);for(var i=0;i<areas.length;i++)
{var area=areas[i];var m=Math.floor((area.t+area.b)/2);if(m>t&&m<b)
{if(area.record_id)
selection_manager.select_entity_by_id(area.record_id,area.group_idx,false,true);else if(both_are_groups)
selection_manager.select_group_by_id(area.group_idx,false,true);}}
if(!both_are_groups&&!shift_click_area.record_id)
selection_manager.select_group_by_id(shift_click_area.group_idx,false,true);},});SG.util.WorkDayHelper=function(config){Ext.apply(this,config);this.init();};SG.util.WorkDayHelper.prototype={init:function()
{this.work_week={0:[],1:[],2:[],3:[],4:[],5:[],6:[]};var i;for(i=0;i<this.work_week_rules.user_exceptions.length;i++)
{var rule=this.work_week_rules.user_exceptions[i];this.work_week[rule.day_of_week].push(rule);}
for(i=0;i<this.work_week_rules.project_exceptions.length;i++)
{var rule=this.work_week_rules.project_exceptions[i];this.work_week[rule.day_of_week].push(rule);}
for(i=0;i<this.work_week_rules.site_exceptions.length;i++)
{var rule=this.work_week_rules.site_exceptions[i];this.work_week[rule.day_of_week].push(rule);}
for(i=0;i<this.work_week_rules.user_rules.length;i++)
{var rule=this.work_week_rules.user_rules[i];this.work_week[rule.day_of_week].push(rule);}
for(i=0;i<this.work_week_rules.project_rules.length;i++)
{var rule=this.work_week_rules.project_rules[i];this.work_week[rule.day_of_week].push(rule);}
for(i=0;i<7;i++)
{var day_rules=this.work_week_rules.work_week[i];this.work_week[i]=this.work_week[i].concat(day_rules);}},init_for_task_record:function(task_record)
{this.project=task_record.get('project');var task_assignees=task_record.get('task_assignees');this.user_ids=[];if(task_assignees)
{for(var i=0;i<task_assignees.length;i++)
this.user_ids.push(task_assignees[i].id);}
if(this.user_ids.length==0)
this.user_ids=[null];},evaluate:function(a_date)
{var rules=this.work_week[a_date.get_day_of_the_week()];var found_rules={};for(var i=0;i<this.user_ids.length;i++)
{var user_id=this.user_ids[i];var rule_found=false;for(var j=0;j<rules.length;j++)
{var rule=rules[j];var rule_start_date=null;if(rule.start_date_js)
rule_start_date=rule.start_date_js;if(rule.exception)
{if(!a_date.same_date(rule_start_date))
continue;}
else
{if(rule_start_date!=null&&rule_start_date.getTime()>a_date.getTime())
continue;}
if(rule.user)
{if(user_id==rule.user.id)
{rule_found=true;found_rules[rule.id]=rule;break;}}
else if(rule.project)
{if(this.project&&this.project.id==rule.project.id)
{rule_found=true;found_rules[rule.id]=rule;break;}}
else
{rule_found=true;found_rules[rule.id]=rule;break;}}}
var return_rules=[];var on_count=0;var off_count=0;for(var rule_id in found_rules)
{if(!found_rules.hasOwnProperty(rule_id))
continue;var rule=found_rules[rule_id];if(rule.working)
on_count++;else
off_count++;return_rules.push(rule);}
var working;if(on_count>0&&off_count==0)
working='on';else if(off_count>0&&on_count==0)
working='off';else
working='mixed';return{working:working,rules:return_rules};},dump_some_rules:function(rules)
{for(var i=0;i<rules.length;i++)
{var rule=rules[i];var type='';var entity_name='default';if(rule.user!=null)
{type='user_';entity_name=rule.user.name;}
else if(rule.project!=null)
{type='project_';entity_name=rule.project.name;}
else
type='site_';if(rule.exception)
type+='exception';else
type+='rule';console.log('%s %s[%d] %s ( %s )',rule.start_date,type,rule.id,rule.working,entity_name);}},};SG.Widget.EntityQuery.FilterPanelWrapper=function(config)
{Ext.apply(this,config);SG.Widget.EntityQuery.FilterPanelWrapper.superclass.constructor.call(this);};Ext.extend(SG.Widget.EntityQuery.FilterPanelWrapper,SG.Component,{templates:{design_mode_message:'<div class="design_mode_message">Filters cannot be used in design mode. To permanently filter the '+'page, use the query builder above. <div class="icon_search_open"></div></div>',},init_component:function(){this.sched_mode_panel='tasks';},render:function(focus_text_filter,no_data_reload){var active_panel=this.get_active_panel();if(this.current_active_panel&&this.current_active_panel!==active_panel){this.current_active_panel.destroy_quick_filter();}
if(this.is_sched_mode()){active_panel.show_sched_mode_tabs=true;}else{active_panel.show_sched_mode_tabs=false;}
this.current_active_panel=active_panel;active_panel.render(focus_text_filter,no_data_reload);},render_design_mode_message:function(){this.container.update(this.templates.design_mode_message.apply());this.message_rendered=true;},on_click:function(e){var t=Ext.get(e.target);var icon_search=t.findParent('div.icon_search_open',this.container);if(icon_search)
this.close_filter_panel();},is_sched_mode:function(){return(this.widget.get('mode')==='sched');},toggle_sched_mode_panel:function(){var me=this;setTimeout(function(){me.sched_mode_panel=(me.sched_mode_panel==='tasks'?'main':'tasks');me.render();},0);},get_active_panel:function(){if(this.is_sched_mode()&&this.sched_mode_panel==='tasks')
return this.get_sched_mode_task_panel();else
return this.get_main_entity_type_panel();},get_main_entity_type_panel:function(){if(!this.main_entity_type_panel){this.main_entity_type_panel=this.new_component(SG.Widget.EntityQuery.FilterPanel,{panel_type:'main',wrapper:this,container:this.container,entity_type:this.entity_type,widget:this.widget,server_side_filters:this.server_side_filters,get_displayed_columns_callback:{fn:this.get_displayed_columns_for_main_entity,scope:this},get_sorts_callback:{fn:this.get_sorts_for_main_entity,scope:this},get_page_filters_callback:{fn:this.get_main_entity_type_page_filters,scope:this},update_filters_callback:{fn:this.update_widget_with_main_entity_type_filters,scope:this},column_display_names:this.column_display_names,setting_get_callback:{fn:this.get_main_entity_type_setting,scope:this},setting_set_callback:{fn:this.set_main_entity_type_setting,scope:this}});}
return this.main_entity_type_panel;},get_sched_mode_task_panel:function(){if(!this.sched_mode_task_panel){this.sched_mode_task_panel=this.new_component(SG.Widget.EntityQuery.FilterPanel,{panel_type:'tasks',wrapper:this,container:this.container,entity_type:'Task',widget:this.widget,get_displayed_columns_callback:{fn:this.get_displayed_columns_for_sched_mode,scope:this},get_sorts_callback:{fn:this.get_sorts_for_sched_mode,scope:this},get_page_filters_callback:{fn:this.get_sched_mode_page_filters,scope:this},update_filters_callback:{fn:this.update_widget_with_sched_mode_task_filters,scope:this},column_display_names:this.column_display_names,setting_get_callback:{fn:this.get_sched_mode_setting,scope:this},setting_set_callback:{fn:this.set_sched_mode_setting,scope:this}});}
return this.sched_mode_task_panel;},set_container:function(container_ext_elem){this.container=container_ext_elem;if(this.main_entity_type_panel)
this.main_entity_type_panel.container=this.container;if(this.sched_mode_task_panel)
this.sched_mode_task_panel.container=this.container;},get_filters:function(){return this.get_main_entity_type_panel().get_filters();},get_sched_mode_task_filters:function(){return this.get_sched_mode_task_panel().get_filters();},focus_text_filter:function(){this.get_active_panel().focus_text_filter();},show_more_fields_menu:function(dom_elem){this.get_active_panel().show_more_fields_menu(dom_elem);},set_column_display_names_hash:function(column_display_names){this.column_display_names=column_display_names;if(this.is_sched_mode()){if(this.sched_mode_task_panel)
this.sched_mode_task_panel.set_column_display_names_hash(column_display_names);}else{if(this.main_entity_type_panel)
this.main_entity_type_panel.set_column_display_names_hash(column_display_names);}},has_filters:function(){if(this.is_sched_mode()){return(this.get_sched_mode_task_panel().has_filters()||this.get_main_entity_type_panel().has_filters());}else{return this.get_active_panel().has_filters();}},main_panel_has_filters:function(){return this.main_entity_type_panel.has_filters();},task_panel_has_filters:function(){if(this.is_sched_mode())
return this.sched_mode_task_panel.has_filters();else
return false;},has_saved_filters:function(){if(this.is_sched_mode()){return(this.get_sched_mode_task_panel().has_saved_filters()||this.get_main_entity_type_panel().has_saved_filters());}else{return this.get_active_panel().has_saved_filters();}},close_filter_panel:function(){this.widget.close_filter_panel();},reset_all_filters:function(){if(this.sched_mode_task_panel&&this.sched_mode_task_panel.has_filters()){this.sched_mode_task_panel.reset_filters_no_notify();this.sched_mode_task_panel.save_filters_to_settings();this.widget.set_sched_mode_filter_panel_filters(this.sched_mode_task_panel.get_filters(),true);}
this.main_entity_type_panel.reset_filters();},get_displayed_columns_for_main_entity:function(){if(this.is_sched_mode()){return this.widget.get_list_mode_columns_from_child_spec();}else{return this.widget.get_content_widget().get_custom_external_action_columns();}},get_displayed_columns_for_sched_mode:function(){if(this.is_sched_mode())
return this.widget.get_content_widget().get_custom_external_action_columns();else
return[];},get_sorts_for_main_entity:function(){if(this.is_sched_mode())
return[];else
return this.widget.get_content_widget().get_custom_external_action_sorts();},get_sorts_for_sched_mode:function(){if(this.is_sched_mode())
return this.widget.get_content_widget().get_custom_external_action_sorts();else
return[];},update_widget_with_main_entity_type_filters:function(filters){this.widget.set_filter_panel_filters(filters);},update_widget_with_sched_mode_task_filters:function(filters){this.widget.set_sched_mode_filter_panel_filters(filters);},get_main_entity_type_setting:function(setting_name){return this.widget.get('filter_panel_main_entity_type_settings')[setting_name];},set_main_entity_type_setting:function(setting_name,value){var settings=this.widget.get('filter_panel_main_entity_type_settings');settings[setting_name]=value;this.widget.set('filter_panel_main_entity_type_settings',settings)},get_sched_mode_setting:function(setting_name){return this.widget.get('filter_panel_sched_mode_settings')[setting_name];},set_sched_mode_setting:function(setting_name,value){var settings=this.widget.get('filter_panel_sched_mode_settings');settings[setting_name]=value;this.widget.set('filter_panel_sched_mode_settings',settings)},get_main_entity_type_page_filters:function(filters){return sg_deep_copy(this.widget.get_filters());},get_sched_mode_page_filters:function(filters){if(this.is_sched_mode()&&this.widget.get_content_widget())
return sg_deep_copy(this.widget.get_content_widget().get_filters());else
return sg_deep_copy(this.widget.get_pivot_filters());},get_dataset_total_size:function(){var ds=this.widget.get_content_widget().get_entity_data_store();return ds.paging_info.record_count;},on_filter_button_context_menu:function(e){var active_panel=this.get_active_panel();active_panel.on_filter_button_context_menu(e);},get_through_join_fields_and_parent:function(){if(this.is_sched_mode()){return{through_join_fields:[],parent_entity:null};}else{return{through_join_fields:this.widget.get_content_widget().get_through_join_fields(),parent_entity:this.widget.get_content_widget().context.get('parent_entity')};}},});SG.Widget.EntityQuery.FilterPanel=function(config)
{Ext.apply(this,config);SG.Widget.EntityQuery.FilterPanel.superclass.constructor.call(this);};Ext.extend(SG.Widget.EntityQuery.FilterPanel,SG.Component,{templates:{main:'<div class="text_filter">'+'<div class="filter_button" id="{quick_filter_button_id}"></div>'+'<div class="filter_input" id="{quick_filter_container_id}"></div>'+'</div>'+'<div class="sched_mode_tabs"></div>'+'<div class="scroll_area {extra_scroll_area_class}">'+'<div class="one_click_filters"></div>'+'<div class="draggable saved_filters"></div>'+'</div>'+'<div class="filter_panel_drag_proxy" id="{drag_proxy_id}"></div>',filter_wrapper:'<div class="draggable filter_wrapper" field="{field_path}">{field_content}</div>',spinner:'<img class="spinner" src="/images/indicator_large_transparent.gif" />',sched_mode_tabs:'<table><tr>'+'<td class="left {main_type_tab_class} {main_has_filters_class}">{main_type_name}</td>'+'<td class="{task_tab_class} {task_has_filters_class}">{task_type_name}</td>'+'</tr></table>',one_click_filters:'<div class="one_click_filter {zero_selected}" filter_index="0">My Pages</div>'+'<div class="one_click_filter {one_selected}" filter_index="1">'+'Favorites<div class="favorite_editor_button_selected"></div></div>'+'<div class="one_click_filter {two_selected}" filter_index="2">Recently Viewed</div>',filter_overlay:'<div class="loading_overlay"></div>'},supported_data_types:['entity','multi_entity','status_list','list','text','checkbox','number','currency','percent','float','date','date_time','duration','entity_type','footage'],number_types:['number','currency','percent','float','duration','footage'],cut_fields:['head_in','head_out','head_duration','cut_in','cut_out','cut_duration','tail_in','tail_out','tail_duration','cut_order','sg_head_in','sg_head_out','sg_head_duration','sg_cut_in','sg_cut_out','sg_cut_duration','sg_tail_in','sg_tail_out','sg_tail_duration','sg_cut_order'],default_fields:{Page:['folder','project','tag_list','created_by','sg_status'],Task:['sg_status_list','step','task_assignees','entity','start_date','due_date'],Shot:['sg_sequence','sg_status_list','assets'],Asset:['sg_asset_type','sg_status_list','shots'],Ticket:['sg_status_list','sg_ticket_type','addressings_to'],HumanUser:['sg_status_list','permission_rule_set','groups','projects'],Version:['sg_status_list','entity','user'],all:['sg_status_list','tag_list']},starting_value_count:5,value_count_increment:5,extra_values_to_show:1,MIN_SUMMARIES_TO_REQUEST:200,MAX_RECORD_COUNT_FOR_AUTO_OPEN_FILTERS:20000,init_component:function()
{this.dummy_data_set=this.new_data_set(this.entity_type,null,this.on_filter_edit);this.summary_data_sets={};this.current_filter_values_summary_data_sets={};this.in_process_summary_requests=[];this.have_summary_fields=false;this.confirm_open={};this.dummy_rec=this.dummy_data_set.new_record();this.slider_controllers={};this.filter_states={};this.page_project=this.widget.context.get('page_project');this.quick_filter_button_id="quick_filter_button_"+this.widget.widget_id;this.quick_filter_container_id="quick_filter_"+this.widget.widget_id;this.quick_filter_drag_proxy_id="quick_filter_drag_proxy"+this.widget.widget_id;this.add_event(SG.schema,'column_removed',this.on_schema_column_removed);this.get_filters_from_settings();},on_schema_column_removed:function(entity_type,field_path){this.remove_field_from_panel_filters(field_path);},on_first_render:function()
{this.container.dom.innerHTML=this.templates.main.apply({quick_filter_container_id:this.quick_filter_container_id,quick_filter_button_id:this.quick_filter_button_id,drag_proxy_id:this.quick_filter_drag_proxy_id,extra_scroll_area_class:this.extra_scroll_area_class?this.extra_scroll_area_class:''});var cell_config={container:this.container,data_set:this.dummy_data_set,projects:this.widget.context_projects(),autocommit:false,force_editable:true};this.cell_manager=this.new_component(SG.CellManager,cell_config);var saved_filter_config={container:this.container.child('div.saved_filters'),entity_type:this.entity_type,filter_panel:this,position_right:this.filter_panel_on_right,widget:this.widget};this.saved_filters_component=this.new_component(SG.SavedFilters,saved_filter_config);this.add_event(this.container.dom,"click",this.on_click);this.add_event(this.container.dom,"contextmenu",this.on_contextmenu);this.add_event(SG.Checkbox,"change",this.on_checkbox_changed);this.add_event(document,'keydown',this.on_keydown);this.add_event(document,'keyup',this.on_keyup);},is_number_type:function(data_type){return(this.number_types.indexOf(data_type)>-1);},is_date_type:function(data_type){return(['date','date_time'].indexOf(data_type)>-1);},is_range_type:function(data_type){return(this.is_number_type(data_type)||this.is_date_type(data_type));},is_summary_type:function(schema_field){var t=['entity','multi_entity','status_list','list','checkbox','text','entity_type'];return(t.indexOf(schema_field.data_type)>-1||this.is_range_type(schema_field.data_type)||schema_field.name==='folder');},in_this_filter_panel:function(dom_elem){if(this.container.contains(dom_elem)){if(this.container.dom.getAttribute('filter_panel_type')===this.panel_type)
return true;else
return false;}else{return false;}},is_showing:function(){if(this.is_showing_callback)
return this.is_showing_callback.fn.call(this.is_showing_callback.scope);return(this.wrapper?this.wrapper.current_active_panel===this:true);},render:function(focus_text_filter,no_data_reload)
{if(!this.is_showing())
return;this.get_filters_from_settings();if(!this.rendered){this.on_first_render();this.rendered=true;this.scroll_position=0;}else{this.last_scroll_position=this.container.child('div.scroll_area').dom.scrollTop;}
var quick_filter=this.get_quick_filter();if(!quick_filter.rendered)
quick_filter.render();this.saved_filters_component.container=this.container.child('div.saved_filters');this.saved_filters_component.render();this.render_one_click_filters();if(!this.row_drag_reorder){var row_drag_reorder_cfg={container:this.container,reorder_callback:{fn:this.on_filters_reordered,scope:this},drag_handle_selector:'div.grouping_row_icon',row_element_selector:'div.draggable',row_proxy_name_selector:'div.header>span.field_name',drag_element_proxy_id:this.quick_filter_drag_proxy_id,};this.row_drag_reorder=new SG.util.RowDragReorder(row_drag_reorder_cfg);}
this.container.dom.setAttribute('filter_panel_type',this.panel_type);var tabs=sg_find('div.sched_mode_tabs',this.container.dom);if(this.show_sched_mode_tabs){this.container.addClass('sched_mode_tabs_showing');tabs.innerHTML=this.templates.sched_mode_tabs.apply({main_type_tab_class:this.panel_type==='main'?'current_tab':'toggle_tab',task_tab_class:this.panel_type==='tasks'?'current_tab':'toggle_tab',main_has_filters_class:this.wrapper.main_panel_has_filters()?'has_filters':'',task_has_filters_class:this.wrapper.task_panel_has_filters()?'has_filters':'',main_type_name:SG.schema.entity_types[this.wrapper.entity_type].display_name_pluralized,task_type_name:SG.schema.entity_types.Task.display_name_pluralized});}else{this.container.removeClass('sched_mode_tabs_showing');tabs.innerHTML='';}
this.values_index={};var i,field_path;var filter_html=[];var fields=this.get_fields();var filters=this.get_panel_filters();var number_fields=[];for(i=0;i<fields.length;i++)
{field_path=fields[i];var schema_field=SG.schema.get_field(this.entity_type,field_path);if(schema_field)
{if(!this.filter_states.hasOwnProperty(field_path))
this.filter_states[field_path]="open";var filter_group=this.get_filter_group(filters,field_path);var filter_component=this.get_filter_component();var filter_state=this.filter_states[field_path];if(filter_state==='open'&&!this.confirm_open[field_path])
filter_state='unconfirmed';filter_html.push(this.templates.filter_wrapper.apply({field_path:field_path,field_content:filter_component.render_html(field_path,schema_field,filter_group,this.values_index,filter_state)}));if(this.is_number_type(schema_field.data_type))
number_fields.push([field_path,schema_field]);}}
var filter_wrapper_divs=sg_find_all('div.filter_wrapper',this.container.dom);for(i=0;i<filter_wrapper_divs.length;i++){var div=Ext.get(filter_wrapper_divs[i]);div.remove();}
var one_click_filters_div=this.container.child('div.one_click_filters');Ext.DomHelper.insertAfter(one_click_filters_div,filter_html.join(''));this.restore_saved_filter_position();this.update_filter_button_has_filters();this.hide_summary_request_in_process_overlay();if(!no_data_reload){this.request_summaries();}
for(i=0;i<number_fields.length;i++)
this.setup_range_sliders(number_fields[i][0],number_fields[i][1]);if(this.last_scroll_position){this.container.child('div.scroll_area').dom.scrollTop=this.last_scroll_position;}
this.quick_filter.update_prompt_value();if(focus_text_filter)
this.focus_text_filter();},on_filters_reordered:function(){var fields=[];var scroll_area=this.container.child('div.scroll_area');var div=scroll_area.dom.firstChild;var saved_filter_index=-1;var c=0;while(div){var ediv=Ext.get(div);if(ediv.hasClass('saved_filters')){saved_filter_index=c;}else if(!ediv.hasClass('one_click_filters')){fields.push(div.getAttribute('field'));}
div=div.nextSibling;c++;}
this.set('saved_filter_index',saved_filter_index-1);this.set_fields(fields);},restore_saved_filter_position:function(){var saved_filter_index=this.get('saved_filter_index')+1;var saved_filters=this.container.child('div.saved_filters');var p=saved_filters.dom.parentNode;var keep=p.removeChild(saved_filters.dom);var div=p.firstChild;var c=0;while(div){if(c==saved_filter_index){p.insertBefore(keep,div);return;}
div=div.nextSibling;c++;}
p.appendChild(keep);},get_quick_filter:function(){if(!this.quick_filter){var quick_filter_config={button_id:this.quick_filter_button_id,external_button_click_handler:true,container_id:this.quick_filter_container_id,widget:this.widget,entity_type:this.entity_type,filter_input_value:this.get('last_quick_filter_value')||'',quick_filter_callback:{fn:this.on_text_filters,scope:this},dont_update_widget_positions:true,showing:true,column_display_names:this.column_display_names,get_displayed_columns_callback:this.get_displayed_columns_callback,get_settings_callback:{fn:this.get,scope:this},set_settings_callback:{fn:this.set,scope:this},};this.quick_filter=this.new_component(SG.QuickFilter,quick_filter_config);}
return this.quick_filter;},focus_text_filter:function(){this.quick_filter.focus_quick_filter();},destroy_quick_filter:function(){if(this.quick_filter){this.set('last_quick_filter_value',this.quick_filter.current_filter);this.quick_filter.destroy();this.quick_filter=null;}},get:function(setting_name){return this.setting_get_callback.fn.call(this.setting_get_callback.scope,setting_name);},set:function(setting_name,value){this.setting_set_callback.fn.call(this.setting_set_callback.scope,setting_name,value);},set_fields:function(fields){this.current_fields=fields;this.set('fields',sg_deep_copy(this.current_fields));var schema_field;this.have_summary_fields=false;for(var i=0;i<fields.length;i++){schema_field=SG.schema.get_field(this.entity_type,fields[i]);if(this.is_summary_type(schema_field))
this.have_summary_fields=true;}},clean_up_fields:function(){var good_fields=[];for(var i=0;i<this.current_fields.length;i++){var schema_field=SG.schema.get_field(this.entity_type,this.current_fields[i]);if(schema_field&&this.allowed_field(schema_field))
good_fields.push(this.current_fields[i]);}
this.current_fields=good_fields;},get_fields:function()
{if(this.current_fields){return sg_deep_copy(this.current_fields);}else{this.current_fields=this.get('fields');this.filter_states=this.get('filter_states');if(!this.filter_states)
this.filter_states={};if(this.current_fields){this.clean_up_fields();return sg_deep_copy(this.current_fields);}
this.current_fields=[];var default_fields=this.default_fields[this.entity_type]||this.default_fields.all;for(var i=0;i<default_fields.length;i++){var schema_field=SG.schema.get_field(this.entity_type,default_fields[i]);if(schema_field&&this.allowed_field(schema_field))
this.current_fields.push(default_fields[i]);}
this.open_first_default_fields();return sg_deep_copy(this.current_fields);}},open_first_default_fields:function(){var fields=this.get_fields();var open=(!this.page_project&&this.entity_type==='Page')?4:3;for(var i=0;i<fields.length;i++){if(i<open){this.filter_states[fields[i]]='open';}else{this.filter_states[fields[i]]='closed';}}},get_panel_filters:function()
{return this.panel_filters||{logical_operator:'and',conditions:[]};},set_panel_filters:function(filters){if(filters&&filters.conditions.length>0)
this.panel_filters=filters;else
this.panel_filters=null;},has_filters:function(){return(this.one_click_filters||this.panel_filters||this.text_filters||this.saved_filters)?true:false;},has_saved_filters:function(){return!(this.saved_filters===null||this.saved_filters===undefined);},get_filter_group:function(filters,field_path)
{if(field_path=='_saved_filters_')
return this.saved_filters||null;var filter=null;for(var i=0;i<filters.conditions.length;i++)
{if(filters.conditions[i].conditions[0].path===field_path)
{return filters.conditions[i];}
else if(filters.conditions[i].conditions[0].clustered_date&&filters.conditions[i].conditions[0].clustered_date_field===field_path)
{return filters.conditions[i];}}
return null;},discover_existing_panel_filter_field_paths:function(){if(!this.panel_filters)
return[];var field_paths=[];for(var i=0;i<this.panel_filters.conditions.length;i++)
{var filter_group=this.panel_filters.conditions[i];if(filter_group.conditions[0].clustered_date)
field_paths.push(filter_group.conditions[0].clustered_date_field);else
field_paths.push(filter_group.conditions[0].path);}
return field_paths;},get_filter:function(schema_field,filter_group,value)
{for(var i=0;i<filter_group.conditions.length;i++)
{if(['entity','multi_entity'].indexOf(schema_field.data_type)>-1){if((value===null&&filter_group.conditions[i].values[0]===null)||(value!==null&&filter_group.conditions[i].values[0]!==null&&value.type===filter_group.conditions[i].values[0].type&&value.id===filter_group.conditions[i].values[0].id))
{return filter_group.conditions[i];}}
else if(this.is_date_type(schema_field.data_type)&&value!==null){if(filter_group.conditions[i].clustered_date&&filter_group.conditions[i].clustered_date===value)
return filter_group.conditions[i];}
else if(this.is_number_type(schema_field.data_type)&&value!==null){if(filter_group.conditions[i].values[0]===value[0]&&filter_group.conditions[i].values[1]===value[1])
{return filter_group.conditions[i];}}
else if(filter_group.conditions[i].values&&filter_group.conditions[i].values[0]==value){return filter_group.conditions[i];}}
return null;},on_filter_edit:function(changes)
{for(var i=0;i<changes.length;i++)
{if(changes[i].state=='pending'&&changes[i].type=='update'&&changes[i].record.get_status(changes[i].column)!='invalid_entry')
{this.add_to_filters(changes[i].column,changes[i].value);this.remove_event(this.dummy_data_set,'change',this.on_filter_edit,this);this.dummy_rec.set(changes[i].column,'');this.add_event(this.dummy_data_set,'change',this.on_filter_edit,this);}}},add_to_filters:function(field_path,value)
{var schema_field=SG.schema.get_field(this.entity_type,field_path);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);var filter=null;if(!filter_group)
{filter_group={logical_operator:'or',conditions:[]};filters.conditions.push(filter_group);}
else
{filter=this.get_filter(schema_field,filter_group,value);}
if(!filter)
{var relation='is';var values=[value];if(schema_field.data_type==='text'&&value!=null){relation='contains';filter={path:field_path,relation:relation,values:values};}
else if(this.is_date_type(schema_field.data_type)&&value!==null){filter={logical_operator:'and',clustered_date:value,clustered_date_field:field_path,conditions:SG.schema.clustered_date_filters(field_path,value)};}
else if(this.is_number_type(schema_field.data_type)&&value!==null){relation='between';values=value;if(this.is_number_type(schema_field.data_type)){relation='between_exclusive_top';}
filter={path:field_path,relation:relation,values:values};}else{filter={path:field_path,relation:relation,values:values};}
filter_group.conditions.push(filter);this.panel_filters_changed(filters);}},panel_filters_changed:function(panel_filters)
{var me=this;setTimeout(function(){me.set_panel_filters(panel_filters);me.update_widget_with_current_filters();if(!me.no_updates_keydown){me.render(false,true);}},0);},update_widget_with_current_filters:function(){if(this.no_updates_keydown){this.backlogged_checkbox_changes=true;}else{this.save_filters_to_settings();this.update_filters_callback.fn.call(this.update_filters_callback.scope,this.get_filters());}},reset_filters_no_notify:function(){this.panel_filters=null;this.text_filters=null;this.saved_filters=null;this.one_click_filters=null;this.clear_one_click_filters();if(this.saved_filters_component)
this.saved_filters_component.clear_checked_filters();if(this.quick_filter)
this.quick_filter.clear_search_text();},reset_filters:function(){this.reset_filters_no_notify();this.panel_filters_changed(this.get_panel_filters());},get_filters:function(){if(this.text_filters||this.saved_filters||this.one_click_filters){var conditions=[this.get_panel_filters()];if(this.text_filters)
conditions.push(this.text_filters);if(this.saved_filters)
conditions.push(this.saved_filters);if(this.one_click_filters)
conditions.push(this.one_click_filters);return{logical_operator:'and',conditions:conditions};}else{return this.panel_filters;}},save_filters_to_settings:function(){this.set('panel_filters',(this.panel_filters||null));this.set('text_filters',(this.text_filters||null));this.set('saved_filters',(this.saved_filters||null));this.set('one_click_filters',(this.one_click_filters||null));this.set('filter_states',this.filter_states);},get_filters_from_settings:function(){this.panel_filters=this.get('panel_filters');this.text_filters=this.get('text_filters');this.saved_filters=this.get('saved_filters');this.one_click_filters=this.get('one_click_filters');this.sanitize_filters();},sanitize_filters:function(){var field_paths=this.discover_existing_panel_filter_field_paths();for(var i=0;i<field_paths.length;i++){var schema_field=SG.schema.get_field(this.entity_type,field_paths[i]);if(!(schema_field&&this.allowed_field(schema_field)))
this.remove_filter_group(this.panel_filters,field_paths[i]);}
this.set_panel_filters(this.panel_filters);},remove_from_filters:function(field_path,value)
{var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(!filter_group)
{console.log("Couldn't find filter group for field. Unable to remove filter. ["+field_path+"="+
value+"]");return;}
var schema_field=SG.schema.get_field(this.entity_type,field_path);var filter=this.get_filter(schema_field,filter_group,value);if(filter)
{var index=filter_group.conditions.indexOf(filter);if(index==-1)
console.log("Couldn't find filter in group. Unable to remove.");else
{if(filter_group.conditions.length==1)
{this.remove_filter_group(filters,field_path);}
else
{filter_group.conditions.splice(index,1);}
this.panel_filters_changed(filters);}}},remove_number_slider_filter:function(field_path){var schema_field=SG.schema.get_field(this.entity_type,field_path);if(!this.is_number_type(schema_field.data_type))
return;var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(!filter_group)
return;for(var i=0;i<filter_group.conditions.length;i++){if(filter_group.conditions[i].range_slider){if(filter_group.conditions.length==1){var index=filters.conditions.indexOf(filter_group);if(index>-1)
filters.conditions.splice(index,1);}else{filter_group.conditions.splice(i,1);}
this.set_panel_filters(filters);return;}}},remove_filter_group:function(filters,field_path)
{var filter_group=this.get_filter_group(filters,field_path);if(!filter_group)
return;var index=filters.conditions.indexOf(filter_group);if(index==-1)
console.log("Couldn't find filter group for field. Unable to remove filter group.");else
filters.conditions.splice(index,1);},remove_field_from_panel_filters:function(field_path){var fields=this.get_fields();var index=fields.indexOf(field_path);if(index===-1)
return;fields.splice(index,1);this.set_fields(fields);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(filter_group){this.remove_filter_group(filters,field_path);this.panel_filters_changed(filters);}else{this.remove_field_html(field_path);}},get_filter_component:function()
{if(!this.filter_stamper)
{this.filter_stamper=this.new_component(SG.Widget.EntityQuery.Filter,{record:this.dummy_rec,widget:this.widget,cell_manager:this.cell_manager,summary_data_sets:this.summary_data_sets,current_filter_values_summary_data_sets:this.current_filter_values_summary_data_sets,filter_panel:this});}
return this.filter_stamper;},on_checkbox_changed:function(checkbox)
{if(this.in_this_filter_panel(checkbox))
{var field_path=checkbox.getAttribute('field_path');var value_index=checkbox.getAttribute('value_index');if(value_index=='all_values')
{var filters=this.get_panel_filters();this.remove_filter_group(filters,field_path);this.panel_filters_changed(filters);return;}
if(value_index)
value_index=Number(value_index);if(typeof value_index=='number'&&!isNaN(value_index))
{if(!this.no_updates_keydown)
this.show_summary_request_in_process(field_path);var value=this.values_index[field_path][value_index];if(SG.Checkbox.get_state(checkbox)=='unchecked')
{this.remove_from_filters(field_path,value);}
else
{this.remove_number_slider_filter(field_path);this.add_to_filters(field_path,value);}}}},is_no_updates_key:function(e){return(!Ext.isMac||sg_is_in_rv())?e.browserEvent.ctrlKey:e.browserEvent.metaKey},on_keydown:function(e)
{if(this.is_no_updates_key(e)){this.no_updates_keydown=true;this.backlogged_checkbox_changes=false}},on_keyup:function(e)
{if(this.no_updates_keydown){this.no_updates_keydown=false;if(this.backlogged_checkbox_changes){this.backlogged_checkbox_changes=false;this.update_widget_with_current_filters();this.render();}}},on_click:function(event){var t=Ext.get(event.target);if(!this.in_this_filter_panel(t))
return;var one_click_filter=t.findParent('div.one_click_filter',this.container.dom);if(one_click_filter){this.apply_one_click_filter(one_click_filter);this.update_filter_button_has_filters();return;}
var field_path;if(t.hasClass('more_fields')){this.show_more_fields_menu(t.dom.parentNode);return;}
if(t.hasClass('toggle_tab')){this.wrapper.toggle_sched_mode_panel();return;}
if(t.hasClass('more_values')){field_path=t.dom.getAttribute('field_path');this.show_more_values(field_path);return;}
if(t.hasClass('gear')){this.toggle_gear_menu(t.dom);return;}
var filter_panel_container=t.findParent('div.saved_filters',this.container.dom);if(filter_panel_container){this.saved_filters_component.on_click(event,t);return;}
var header=Ext.get(t.findParent('div.header'),this.container.dom);if(header){var body=Ext.get(header.findParent('div.sgc_filter'),this.container.dom);var new_state=body.hasClass('open')?"closed":"open";field_path=header.dom.getAttribute('field_path');SG.Menu.cancel_current();this.toggle_filter_state(field_path,new_state);event.stopEvent();return;}
var filter_button=t.findParent('div.filter_button',this.container.dom);if(filter_button&&!event.ctrlKey){this.wrapper.close_filter_panel();return;}
var folder=Ext.get(t.findParent('div.folder_row'),this.container.dom);var filters,filter_group,schema_field,folder_info,folder_path;if(folder){if(t.hasClass('folder_opener')&&!folder.hasClass('no_subfolders')){field_path=folder.dom.getAttribute('field_path');folder_info=this.get_filter_component().get_folder_info(folder.dom);folder_path=folder_info.path;filters=this.get_panel_filters();filter_group=this.get_filter_group(filters,field_path);schema_field=SG.schema.get_field(this.entity_type,field_path);this.get_filter_component().toggle_folder(field_path,schema_field,folder.dom,filter_group);return;}
folder_info=this.get_filter_component().get_folder_info(folder.dom);field_path=folder.dom.getAttribute('field_path');if(folder.hasClass('filtered')){filters=this.get_panel_filters();filter_group=this.get_filter_group(filters,field_path);schema_field=SG.schema.get_field(this.entity_type,field_path);this.get_filter_component().toggle_folder(field_path,schema_field,folder.dom,filter_group);this.clear_field_filters(field_path);}else{this.filter_folder_path(field_path,folder_info);}
return;}},filter_folder_path:function(field_path,folder_info){var folder_path=folder_info.path;var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(filter_group){filter_group.conditions=[];}else{filter_group={logical_operator:'and',conditions:[]};filters.conditions.push(filter_group);}
if(folder_info.is_project){filter_group.conditions.push({path:field_path,relation:'starts_with',values:[folder_path],active:'false'});}else if(folder_info.path){filter_group.conditions.push({path:field_path,relation:'starts_with',values:[folder_path]});}else{filter_group.conditions.push({path:field_path,relation:'is',values:[null]});}
var project_val=folder_info.project_id?{type:'Project',id:folder_info.project_id}:null;filter_group.conditions.push({path:'project',relation:'is',values:[project_val]});this.get_filter_component().reset_open_folders(filter_group);this.panel_filters_changed(filters);},on_contextmenu:function(e){var t=Ext.get(e.target);if(!this.in_this_filter_panel(t))
return;var field_path;var filter_button=t.findParent('div.filter_button');if(filter_button){e.stopEvent();this.on_filter_button_context_menu(e);return;}
var header=Ext.get(t.findParent('div.header'));if(header){e.stopEvent();this.toggle_gear_menu(t.dom,e.getXY());return;}},toggle_gear_menu:function(position_dom_elem,xy)
{if(this.gear_menu&&this.gear_menu.is_showing()){this.gear_menu.hide();return;}else{SG.Menu.cancel_current();}
var header=Ext.fly(position_dom_elem).findParent("div.header");var field_path=header.getAttribute("field_path");var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(!this.gear_menu){this.gear_menu=this.new_component(SG.Menu,{item_selected:{fn:this.gear_menu_item_selected,scope:this}});}
this.gear_menu.field_path=field_path;if(xy)
this.gear_menu.position={xy:xy};else
this.gear_menu.position={dom_elem:position_dom_elem,elem_anchor:"br",menu_anchor:"tr"};this.gear_menu.items=[{html:"Reset Filter",value:"reset_filter",disabled:(filter_group===null)},{line:true},{html:"Remove Filter",value:"remove_filter",disabled:field_path=='_saved_filters_'}];this.gear_menu.render();this.gear_menu.show();},gear_menu_item_selected:function(menu,item)
{if(item.value=="reset_filter"){this.clear_field_filters(menu.field_path);}else if(item.value=="remove_filter"){this.remove_field(menu.field_path);}},show_more_fields_menu:function(position_dom_elem)
{if(!this.more_fields_menu){this.more_fields_menu=this.new_component(SG.Menu,{position:{dom_elem:position_dom_elem,elem_anchor:"bl",menu_anchor:"tl"},item_selected:{fn:this.more_fields_menu_item_selected,scope:this}});}
var through_info=this.get_through_join_fields_and_parent();menu_helper=new SG.util.EntityFieldsMenuHelper({entity_type:this.entity_type,column_display_names:this.column_display_names,field_checked_callback:{fn:this.field_checked_callback,scope:this},field_disabled_callback:{fn:this.field_disabled_callback,scope:this},filter_step_field_format:true,through_join_fields:through_info.through_join_fields,parent_entity:through_info.parent_entity});this.more_fields_menu.position={dom_elem:position_dom_elem,elem_anchor:"bl",menu_anchor:"tl"};this.more_fields_menu.items=menu_helper.get_fields_menu_items();this.more_fields_menu.render();this.more_fields_menu.show();},field_checked_callback:function(schema_field,field_path){return(this.current_fields.indexOf(field_path)>-1);},field_disabled_callback:function(schema_field,field_path){return(!this.allowed_field(schema_field));},set_column_display_names_hash:function(column_display_names){this.column_display_names=column_display_names;if(this.quick_filter)
this.quick_filter.column_display_names=column_display_names;},display_name:function(field_path,schema_field){if(this.column_display_names&&this.column_display_names[field_path])
return SG.schema.local_display_name(this.column_display_names,schema_field,field_path);else
return SG.schema.get_field_display_name(this.entity_type,field_path,schema_field)},allowed_field:function(schema_field){if(schema_field.no_summary&&this.is_summary_type(schema_field))
return false;return(!schema_field.no_filtering&&this.supported_data_types.indexOf(schema_field.data_type)>-1);},more_fields_menu_item_selected:function(menu,item){var fields=this.get_fields();var field_path=item.field;var index=fields.indexOf(field_path);if(index==-1){fields.push(field_path);this.filter_states[field_path]='open';this.confirm_open[field_path]=true;this.set_fields(fields);this.render(false,true);this.request_summary(field_path);}else{this.remove_field(field_path);}},remove_field:function(field_path){if(this.filter_states[field_path]){delete this.filter_states[field_path];this.set('filter_states',this.filter_states);}
if(this.summary_data_sets[field_path]){this.summary_data_sets[field_path].destroy();delete this.summary_data_sets[field_path];}
this.remove_field_from_panel_filters(field_path);},request_summaries:function()
{SG.Repo.start_batch();var fields=this.get_fields();for(var i=0;i<fields.length;i++)
{var field=fields[i];this.request_summary(field);}
SG.Repo.end_batch();},show_summary_request_in_process:function(field,schema_field){var schema_field=schema_field||SG.schema.get_field(this.entity_type,field);var header=sg_find('div.header[field_path="'+field+'"]',this.container.dom);if(!header)
return;header.firstChild.className="tip";header.firstChild.innerHTML=this.templates.spinner.apply({});if(this.container.dom.lastChild.className!=='loading_overlay')
this.templates.filter_overlay.append(this.container.dom,{});if(this.is_summary_type(schema_field)){if(this.in_process_summary_requests.indexOf(field)===-1)
this.in_process_summary_requests.push(field);}else{if(this.in_process_summary_requests.length===0){this.in_process_summary_requests.push('_wait_');}}},summary_request_completed:function(field){var i=this.in_process_summary_requests.indexOf(field);if(i>-1)
this.in_process_summary_requests.splice(i,1);},hide_summary_request_in_process_overlay:function(){var hide=false;if(this.in_process_summary_requests.length===0){hide=true;}else if(this.have_summary_fields&&this.in_process_summary_requests.length===1&&this.in_process_summary_requests[0]==='_wait_'){hide=true;}
if(!hide)
return;var layer=sg_find('div.loading_overlay',this.container.dom);if(layer)
layer.parentNode.removeChild(layer);},request_summary:function(field_path)
{var schema_field=SG.schema.get_field(this.entity_type,field_path);if(this.filter_states[field_path]==='closed')
return;if(!this.confirm_open[field_path]){if(this.get_dataset_total_size()>this.MAX_RECORD_COUNT_FOR_AUTO_OPEN_FILTERS){var me=this;setTimeout(function(){me.toggle_filter_state(field_path,'closed')});return;}else{this.confirm_open[field_path]=true;}}
this.show_summary_request_in_process(field_path,schema_field);if(!this.is_summary_type(schema_field))
return;var is_number_or_date=this.is_range_type(schema_field.data_type);if(!this.summary_data_sets[field_path])
{this.summary_data_sets[field_path]=new SG.Data.SummarySet(this.entity_type);if(!is_number_or_date)
{this.summary_data_sets[field_path].now_showing_count=this.starting_value_count;this.add_event(this.summary_data_sets[field_path],'load',this.on_summary_load);this.current_filter_values_summary_data_sets[field_path]=new SG.Data.SummarySet(this.entity_type);this.add_event(this.current_filter_values_summary_data_sets[field_path],'load',this.on_current_values_summary_load);}}
var spec;var summaries=[{column:'id',type:'record_count'}];var grouping=[{column:field_path,direction:"asc",method:"exact"}];var filter_panel_filters=sg_deep_copy(this.get_panel_filters());this.remove_filter_group(filter_panel_filters,field_path);var page_filters=this.get_page_filters_callback.fn.call(this.get_page_filters_callback.scope);page_filters.conditions.push(filter_panel_filters);if(this.saved_filters)
page_filters.conditions.push(this.saved_filters);if(this.one_click_filters)
page_filters.conditions.push(this.one_click_filters);if(this.text_filters)
page_filters.conditions.push(this.text_filters);this.widget.substitute_filter_tokens(page_filters);if(is_number_or_date){if(this.is_date_type(schema_field.data_type))
this.request_date_grouped_summary(field_path,schema_field,page_filters);else
this.request_initial_number_field_summary(field_path,schema_field,page_filters);return;}
if(schema_field.name==='folder'){this.request_folder_summary(field_path,schema_field,page_filters);return;}
var records_to_retrieve=this.summary_data_sets[field_path].now_showing_count+this.extra_values_to_show+1;if(records_to_retrieve<this.MIN_SUMMARIES_TO_REQUEST)
records_to_retrieve=this.MIN_SUMMARIES_TO_REQUEST;var paging={records_per_page:records_to_retrieve,current_page:1};var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(filter_group)
{var current_values_filters=sg_deep_copy(page_filters);var filter_values=[];var null_value=false;for(var i=0;i<filter_group.conditions.length;i++)
{if(filter_group.conditions[i].values[0]===null)
null_value=true;else
filter_values.push(filter_group.conditions[i].values[0]);}
if(null_value&&filter_values.length>0)
current_values_filters.conditions.push({logical_operator:'or',conditions:[{path:field_path,relation:'is',values:[null]},{path:field_path,relation:'in',values:filter_values}]});else if(null_value)
current_values_filters.conditions.push({path:field_path,relation:'is',values:[null]});else if(filter_values.length>0)
current_values_filters.conditions.push({path:field_path,relation:'in',values:filter_values});spec={type:this.entity_type,filters:current_values_filters,grouping:grouping,summaries:summaries,paging:paging,server_side_filters:this.server_side_filters,result:this.current_filter_values_summary_data_sets[field_path],result_key:field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);}
spec={type:this.entity_type,filters:page_filters,grouping:grouping,summaries:summaries,paging:paging,server_side_filters:this.server_side_filters,result:this.summary_data_sets[field_path],result_key:field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);},pivot_summary_spec_for_step_field:function(field_path,schema_field,spec){if(this.entity_type==='Task'||field_path.indexOf('step')!==0)
return;var parsed=SG.schema.parse_field_name(this.entity_type,field_path);if(!parsed.base_field)
return;var step_schema=SG.schema.get_step_entity(this.entity_type,parsed.base_field);var filters={logical_operator:'and',conditions:[]};if(spec.filters&&sg_count_active_filters(spec.filters)>0){var pivoted_filters=sg_deep_copy(spec.filters);pivoted_filters=sg_pivot_condition_hash(this.entity_type,'entity',pivoted_filters);filters.conditions.push(pivoted_filters);}else{filters.conditions.push({path:'entity',relation:'type_is',values:[this.entity_type]});}
if(step_schema.id!==0){filters.conditions.push({path:'step',relation:'is',values:[{type:'Step',id:step_schema.id}]});}
spec.type='Task';spec.filters=filters
spec.server_side_filters=null;if(spec.grouping){for(var i=0;i<spec.grouping.length;i++){if(spec.grouping[i].column===field_path)
spec.grouping[i].column=parsed.bubbled_up_field;}}
if(spec.summaries){for(var i=0;i<spec.summaries.length;i++){if(spec.summaries[i].column===field_path)
spec.summaries[i].column=parsed.bubbled_up_field;}}},request_folder_summary:function(field_path,schema_field,page_filters){var summaries=[{column:'id',type:'record_count'}];var grouping=[{column:'project',direction:'asc',method:'exact'},{column:field_path,direction:"asc",method:"exact"}];var spec={type:this.entity_type,filters:page_filters,grouping:grouping,summaries:summaries,server_side_filters:this.server_side_filters,result:this.summary_data_sets[field_path],result_key:field_path};SG.Repo.summarize(spec);},on_current_values_summary_load:function(field_path)
{},on_summary_load:function(field_paths)
{var field_path=field_paths[0];var summary_data_set=this.summary_data_sets[field_path];var schema_field=SG.schema.get_field(this.entity_type,field_path);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);this.summary_request_completed(field_path);this.rerender_field(field_path,schema_field,filter_group);},rerender_field:function(field_path,schema_field,filter_group){if(!this.is_showing())
return;var filter_component=this.get_filter_component();var filter_wrapper=this.get_filter_wrapper_element(field_path);var state=this.filter_states[field_path];if(state==='open'&&!this.confirm_open[field_path])
state='unconfirmed';filter_wrapper.innerHTML=filter_component.render_html(field_path,schema_field,filter_group,this.values_index,state);this.hide_summary_request_in_process_overlay();},get_filter_wrapper_element:function(field_path){return sg_find('div.filter_wrapper[field="'+field_path+'"]',this.container.dom);},get_dataset_total_size:function(){if(this.dataset_total_size_callback)
return this.dataset_total_size_callback.fn.call(this.dataset_total_size_callback.scope);return this.wrapper.get_dataset_total_size();},get_through_join_fields_and_parent:function(){if(this.through_join_fields_and_parent_callback)
return this.through_join_fields_and_parent_callback.fn.call(this.through_join_fields_and_parent_callback.scope);return this.wrapper.get_through_join_fields_and_parent();},remove_field_html:function(field_path){var filter_wrapper=this.get_filter_wrapper_element(field_path);filter_wrapper.parentNode.removeChild(filter_wrapper);},show_more_values:function(field)
{this.summary_data_sets[field].now_showing_count*=2;this.request_summary(field);},on_widget_context_changed:function(key,value)
{if(key=="filters"||key=="parent_entity"||key=='grouping'){this.request_summaries();}},request_initial_number_field_summary:function(field_path,schema_field,page_filters){var summary_set=this.summary_data_sets[field_path];summary_set.page_filters=page_filters;this.remove_event(summary_set,'load',this.on_number_grouped_summary_load);this.add_event(summary_set,'load',this.on_initial_number_summary_load);var schema_field=SG.schema.get_field(this.entity_type,field_path);var spec={type:this.entity_type,filters:page_filters,summaries:[{column:'id',type:'record_count'}],server_side_filters:this.server_side_filters,result:summary_set,result_key:'_filter_panel_count__'+field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);spec={type:this.entity_type,filters:page_filters,summaries:[{column:field_path,type:'minimum'}],server_side_filters:this.server_side_filters,result:summary_set,result_key:'_filter_panel_minimum__'+field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);spec={type:this.entity_type,filters:page_filters,summaries:[{column:field_path,type:'maximum'}],server_side_filters:this.server_side_filters,result:summary_set,result_key:'_filter_panel_maximum__'+field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);},on_initial_number_summary_load:function(summary_request_keys){var field_path=summary_request_keys[0].split(/_filter_panel_.*?__/)[1];var schema_field=SG.schema.get_field(this.entity_type,field_path);var summary_set=this.summary_data_sets[field_path];if(summary_set.data.hasOwnProperty('_filter_panel_count__'+field_path)&&summary_set.data.hasOwnProperty('_filter_panel_minimum__'+field_path)&&summary_set.data.hasOwnProperty('_filter_panel_maximum__'+field_path))
{var total_recs=summary_set.get('_filter_panel_count__'+field_path,'id');if(total_recs==0){summary_set.min_val=0;summary_set.max_val=100;}else{var min=Number(summary_set.get('_filter_panel_minimum__'+field_path,field_path));var max=Number(summary_set.get('_filter_panel_maximum__'+field_path,field_path));summary_set.min_val=Math.floor(min);summary_set.max_val=Math.ceil(max);if(summary_set.min_val!==summary_set.max_val){var group_sizes=schema_field.data_type==='duration'?this.duration_group_sizes:this.number_group_sizes;if(schema_field.data_type==='footage'){min=SG.Footage.feet_and_frames(min).feet;max=SG.Footage.feet_and_frames(max).feet;}
var group_size=(max-min)/30.0;for(var i=0;i<group_sizes.length;i++){if(group_sizes[i]>group_size)
{this.request_number_grouped_summary(field_path,i,schema_field);return;}}
this.request_number_grouped_summary(field_path,(group_sizes.length-1),schema_field);return;}else{summary_set.max_val=summary_set.max_val+1;}}
this.request_number_grouped_summary(field_path,0,schema_field);}},number_group_sizes:[1,10,100,1000,10000,100000,1000000],number_groups:['ones','tens','hundreds','thousands','tensofthousands','hundredsofthousands','millions'],duration_group_sizes:[],duration_groups:['oneday','fivedays'],request_number_grouped_summary:function(field_path,grouping_index,schema_field){if(schema_field.data_type==='duration'){this.duration_group_sizes[0]=60*SG.globals.preferences.hours_per_day;this.duration_group_sizes[1]=5*this.duration_group_sizes[0];}
var grouping=(schema_field.data_type==='duration')?this.duration_groups[grouping_index]:this.number_groups[grouping_index];var old_summary_set=this.summary_data_sets[field_path];var summary_set=new SG.Data.SummarySet(this.entity_type);summary_set.min_val=old_summary_set.min_val;summary_set.max_val=old_summary_set.max_val;if(schema_field.data_type==='duration'){summary_set.min_val=sg_duration_floor(summary_set.min_val);summary_set.max_val=sg_duration_ceil(summary_set.max_val);}
var page_filters=old_summary_set.page_filters;summary_set.group_size=(schema_field.data_type==='duration')?this.duration_group_sizes[grouping_index]:this.number_group_sizes[grouping_index];this.remove_event(summary_set,'load',this.on_initial_number_summary_load);this.add_event(summary_set,'load',this.on_number_grouped_summary_load);var spec={type:this.entity_type,filters:page_filters,grouping:[{column:field_path,direction:"asc",method:grouping}],summaries:[{column:'id',type:'record_count'}],server_side_filters:this.server_side_filters,result:summary_set,result_key:field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);},on_number_grouped_summary_load:function(field_path,summary_data_set){var field_path=field_path[0];var old_summary_data_set=this.summary_data_sets[field_path];this.summary_data_sets[field_path]=summary_data_set;old_summary_data_set.destroy();var schema_field=SG.schema.get_field(this.entity_type,field_path);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);this.summary_request_completed(field_path);this.rerender_field(field_path,schema_field,filter_group);this.setup_range_sliders(field_path,schema_field);},setup_range_sliders:function(field_path,schema_field){if(this.slider_controllers[field_path])
this.slider_controllers[field_path].destroy();var summary_set=this.summary_data_sets[field_path];if(!summary_set||(typeof summary_set.min_val==='undefined'))
return;var slider_hidden=false;if(summary_set.group_summaries.length<3){var non_null=0;for(var i=0;i<summary_set.group_summaries.length;i++){if(summary_set.group_summaries[i].template_values[0]!==null)
non_null++;}
if(non_null<2){this.hide_slider(field_path);return;}}
this.show_slider(field_path);this.slider_controllers[field_path]=this.new_component(SG.Widget.EntityQuery.Filter.NumberSlider,{filter_panel:this,field_path:field_path,schema_field:schema_field});},hide_slider:function(field_path){var filter_wrapper=this.get_filter_wrapper_element(field_path);Ext.get(filter_wrapper).addClass('hide_slider');},show_slider:function(field_path){var filter_wrapper=this.get_filter_wrapper_element(field_path);Ext.get(filter_wrapper).removeClass('hide_slider');},clear_field_filters:function(field_path){if(field_path=='_saved_filters_'){this.saved_filters=null;this.saved_filters_component.clear_checked_filters();}
var filters=this.get_panel_filters();if(field_path!='_saved_filters_')
this.remove_filter_group(filters,field_path);this.panel_filters_changed(filters);},on_slider_range_changed:function(field_path,min,max)
{var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);if(filter_group){filter_group.conditions=[];}else{filter_group={logical_operator:'or',conditions:[]};filters.conditions.push(filter_group);}
var schema_field=SG.schema.get_field(this.entity_type,field_path);if(schema_field.data_type==='footage'){min=SG.Footage.footage_to_frames(min);max=SG.Footage.footage_to_frames(max);}
filter_group.conditions.push({path:field_path,relation:'between',values:[min,max],range_slider:true});this.panel_filters_changed(filters);},request_date_grouped_summary:function(field_path,schema_field,page_filters){var summary_set=new SG.Data.SummarySet(this.entity_type);this.add_event(summary_set,'load',this.on_date_grouped_summary_load);var spec={type:this.entity_type,filters:page_filters,grouping:[{column:field_path,direction:"asc",method:'clustered_date'}],summaries:[{column:'id',type:'record_count'}],server_side_filters:this.server_side_filters,result:summary_set,result_key:field_path};this.pivot_summary_spec_for_step_field(field_path,schema_field,spec);SG.Repo.summarize(spec);},on_date_grouped_summary_load:function(field_path,summary_data_set){var field_path=field_path[0];var old_summary_data_set=this.summary_data_sets[field_path];this.summary_data_sets[field_path]=summary_data_set;old_summary_data_set.destroy();var schema_field=SG.schema.get_field(this.entity_type,field_path);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);this.summary_request_completed(field_path);this.rerender_field(field_path,schema_field,filter_group);},format_date:function(sg_date){var format=(SG.globals.preferences.date_component_order==='month_day')?'n/j/y':'j/n/y';return sg_date.format(format);},toggle_filter_state:function(field_path,new_state){this.filter_states[field_path]=new_state;this.set('filter_states',this.filter_states);var schema_field=SG.schema.get_field(this.entity_type,field_path);var filters=this.get_panel_filters();var filter_group=this.get_filter_group(filters,field_path);this.rerender_field(field_path,schema_field,filter_group);if(new_state==='open'){this.confirm_open[field_path]=true;this.request_summary(field_path);}},on_saved_filters:function(saved_filters){this.saved_filters=saved_filters;this.update_widget_with_current_filters();},on_text_filters:function(text_filters){if(text_filters.conditions.length==0)
this.text_filters=null;else
this.text_filters=text_filters;this.set('last_quick_filter_value',this.quick_filter.current_filter);this.update_widget_with_current_filters();},update_filter_button_has_filters:function(){if(this.update_filter_button_callback){this.update_filter_button_callback.fn.call(this.update_filter_button_callback.scope);return;}
var quick_filter_button_elem=sg_find('div.sgc_quick_filter_button',this.container.dom);if(quick_filter_button_elem){if(this.wrapper&&this.wrapper.has_filters())
quick_filter_button_elem.firstChild.className='icon_search_active_open';else
quick_filter_button_elem.firstChild.className='icon_search_open';}},on_filter_button_context_menu:function(e){if(!this.filter_button_context_menu){this.filter_button_context_menu=this.new_component(SG.Menu,{item_selected:{fn:this.filter_button_context_menu_item_selected,scope:this}});}else{if(this.filter_button_context_menu.is_showing()){this.filter_button_context_menu.hide();return;}}
this.filter_button_context_menu.items=[{html:"Reset All Filters",value:"reset_all_filters",disabled:(!this.wrapper.has_filters())}];this.filter_button_context_menu.position={dom_elem:e.target,elem_anchor:"bl",menu_anchor:"tl"};this.filter_button_context_menu.render();this.filter_button_context_menu.show();},filter_button_context_menu_item_selected:function(menu,item){if(item.value==='reset_all_filters'){this.wrapper.reset_all_filters();}},render_one_click_filters:function(){var one_click_div=this.container.child('div.one_click_filters');if(this.entity_type!='Page'||this.panel_type==='tasks'){one_click_div.setDisplayed(false);return;}
one_click_div.update(this.templates.one_click_filters.apply({zero_selected:this.one_click_filter_selected(0)?'selected':'',one_selected:this.one_click_filter_selected(1)?'selected':'',two_selected:this.one_click_filter_selected(2)?'selected':'',}));},one_click_filter_choices:[{logical_operator:"and",conditions:[{active:true,path:'created_by',relation:'is',values:[SG.globals.current_user.entity_hash]},{active:true,path:'project',relation:'is',values:[null]}],one_click_filter_type:'my_pages'},{logical_operator:"and",conditions:[{active:true,path:'current_user_favorite',relation:'is',values:[true]}],one_click_filter_type:'favorites'},{logical_operator:"and",conditions:[{path:"last_accessed_by_current_user",relation:"in_last",values:[3,"MONTH"],active:true}],one_click_filter_type:'recently_viewed'},],one_click_filter_selected:function(index){return(this.one_click_filters&&this.one_click_filters.one_click_filter_type===this.one_click_filter_choices[index].one_click_filter_type);},apply_one_click_filter:function(div_elem){var div=Ext.get(div_elem);if(div.hasClass('selected')){this.clear_one_click_filters();this.update_widget_with_current_filters();return;}
this.clear_one_click_filters();div.addClass('selected');var index=Number(div_elem.getAttribute('filter_index'));this.one_click_filters=this.one_click_filter_choices[index];this.update_widget_with_current_filters();},clear_one_click_filters:function(){var div=sg_find('div.one_click_filter.selected',this.container.dom);if(!div)return;Ext.get(div).removeClass('selected');this.one_click_filters=null;},});SG.Widget.EntityQuery.Filter=function(config)
{Ext.apply(this,config);SG.Widget.EntityQuery.Filter.superclass.constructor.call(this);};Ext.extend(SG.Widget.EntityQuery.Filter,SG.Component,{templates:{main:'<div class="sgc_filter {state}">'+'<div class="header" field_path="{field_path}">'+'<div class="tip {state_icon}">{spinner}</div>'+'<span class="field_name">{field_name}</span>'+'<div class="gear gear_menu_nobg"></div>'+'<div class="grouping_row_icon drag"></div>'+'</div>'+'<div class="body">{body}</div>'+'</div>',checkbox_row:'<div class="checkbox_row" sg_checkbox_label="{checkbox_id}" {other_attributes}>'+'{checkbox} '+'<div class="graph"><div class="bar" style="width: {width}%">&nbsp;</div></div>'+'<div class="value {not_in_results_class}">{value}</div>'+'<div class="count {not_in_results_class}">{count}</div>'+'</div>',more_prompt:'<div class="more_values" field_path="{field_path}">Show more...</div>',input_row:'<div class="input_row" field_path="{field_path}">'+'<div style="{cell_styles}" '+'class="field_value {cell_classes} sg_cell_single_click_edit sg_cell_edit_trigger" {cell_attributes}>'+'<div class="sgc_cell_content">Enter {field_name}</div></div></div>',slider:'<div class="slider" field_path="{field_path}">'+'<div class="slider_line">'+'<div class="slider_line_shape"></div>'+'<div id="sgc_filter_slider_{field_path}_min" class="knob min"></div>'+'<div id="sgc_filter_slider_{field_path}_max" class="knob max"></div>'+'</div>'+'<div class="slider_values"></div>'+'</div>',folder:'<div class="folder_row {subfolders_class} {filtered_class} {no_thing_class}" '+'field_path="{field_path}" folder_index="{folder_index}">'+'<div class="spacer" style="width:{spacer_width}px;"></div>'+'<div class="folder_opener {icon_name}"></div>'+'<div class="folder_icon {folder_icon}"></div>'+'<div class="folder_name">{folder_name}</div>'+'<div class="count">{count}</div>'+'</div>',subfolders:'<div class="subfolders">{subfolders}</div>',spinner:'<img class="spinner" src="/images/indicator_large_transparent.gif" />'},FOLDER_INDENT_PIXEL_WIDTH:15,NO_PROJECT:'Global Pages',NO_FOLDER:'No Folder',init_component:function(){if(this.filter_panel.entity_type==='Page')
this.open_folders={};},reset_open_folders:function(filter_group){this.open_folders={};this.set_temp_folder_state(filter_group);if(this.current_folder_path){var path=this.current_folder_path.split('->');if(path[0]){for(var i=0;i<path.length;i++){this.open_folders[path.slice(0,i+1).join('->')]=true;}}}
if(this.current_project_path!=='__not_filtered__'){if(this.current_project)
this.open_folders[sg_project_name(this.current_project.id)]=true;else
this.open_folders[this.NO_PROJECT]=true;}},render_html:function(field_path,schema_field,filter_group,values_hash,state)
{var state_attr,state_icon_name,spinner_html;if(state==='open'){state_attr='open';state_icon_name='arrow_open_dark';spinner_html='';}else if(state==='closed'){state_attr='closed';state_icon_name='arrow_closed_dark';spinner_html='';}else if(state==='unconfirmed'){state_attr=filter_group?'open':'closed';state_icon_name='';spinner_html=this.templates.spinner.apply({});}
return this.templates.main.apply({field_path:field_path,field_name:this.filter_panel.display_name(field_path,schema_field),body:this.render_body(field_path,schema_field,filter_group,values_hash),state:state_attr,state_icon:state_icon_name,spinner:spinner_html});},render_body:function(field_path,schema_field,filter_group,values_hash)
{if(schema_field.name==='folder')
return this.render_folder_body(field_path,schema_field,filter_group,values_hash);var html=[];var i,value,count,checked;var values_arr=[];values_hash[field_path]=values_arr;var filter_values=[];if(filter_group)
{for(i=0;i<filter_group.conditions.length;i++)
{if(filter_group.conditions[i].range_slider)
continue;if(filter_group.conditions[i].clustered_date)
filter_values.push(filter_group.conditions[i].clustered_date);else if(filter_group.conditions[i].values.length==2)
filter_values.push(filter_group.conditions[i].values);else
filter_values.push(filter_group.conditions[i].values[0]);}}
var known_field_values=this.get_field_values(field_path,schema_field);var value_is_entity=['entity','multi_entity'].indexOf(schema_field.data_type)>-1;var rendered_values=[];var max=0;for(i=0;i<known_field_values.length;i++){if(Number(known_field_values[i].freq)>max)
max=known_field_values[i].freq;}
if(known_field_values.length===1)
max=0;for(i=0;i<known_field_values.length;i++)
{value=known_field_values[i].value;count=known_field_values[i].freq;checked=((value_is_entity&&array_contains_entity(filter_values,value))||(this.filter_panel.is_date_type(schema_field.data_type)&&value!==null&&filter_values.indexOf(value)>-1)||(this.filter_panel.is_number_type(schema_field.data_type)&&value!==null&&this.array_contains_range(filter_values,value))||(!value_is_entity&&filter_values.indexOf(value)>-1));html.push(this.render_value(field_path,schema_field,value,(checked?'checked':'unchecked'),count,max,values_arr));rendered_values.push(value);}
for(i=0;i<filter_values.length;i++)
{if(this.filter_panel.is_number_type(schema_field.data_type)){var rendered=this.array_contains_range(rendered_values,filter_values[i]);if(!rendered){html.push(this.render_value(field_path,schema_field,filter_values[i],'checked','',max,values_arr,false));}}else if((value_is_entity&&!array_contains_entity(rendered_values,filter_values[i]))||(!value_is_entity&&rendered_values.indexOf(filter_values[i])==-1))
{value=filter_values[i];var not_in_results=!this.is_in_results(field_path,schema_field,value);html.push(this.render_value(field_path,schema_field,value,'checked','',max,values_arr,not_in_results));}}
var has_more=this.has_more_field_values(field_path,schema_field,known_field_values);if(has_more)
html.push(this.templates.more_prompt.apply({field_path:field_path}));if(has_more&&!this.filter_panel.is_range_type(schema_field.data_type))
{var cell=this.cell_manager.get_cell(field_path);if(schema_field.data_type=='multi_entity'&&cell.schema_field.editor!='entity')
{cell.schema_field=sg_deep_copy(cell.schema_field);cell.schema_field.editor='entity';}
var config=cell.render(this.record);config.field_path=field_path;config.field_name=schema_field.display_name;html.push(this.templates.input_row.apply(config));}
if(this.filter_panel.is_number_type(schema_field.data_type))
{html.push(this.templates.slider.apply({field_path:field_path}));}
return html.join('');},render_value:function(field_path,schema_field,value,state,count,max_value,values_arr,not_in_results)
{var value_index=null;value_index=values_arr.length;values_arr.push(value);var disabled=false;if(value===null||value==='')
{value='(blank)';}
else
{var renderer_name=SG.Renderers.renderer_defaults[schema_field.data_type]||'text';if(schema_field.name==='step'&&schema_field.entity_type==='Task'){renderer_name="step_entity";value.show_entity_type=true;}else if(renderer_name==='multi_entity'||renderer_name==='entity'){renderer_name='nodetail_entity';}else if(schema_field.data_type==='checkbox'){renderer_name='checkbox_as_words';}else if(schema_field.data_type==='status_list'){renderer_name='status_list_table';}else if(schema_field.data_type==='entity_type'&&schema_field.entity_type=="Page"){renderer_name='page_entity_type';}else if(schema_field.data_type==='duration'){if(typeof value!=='string'){var range_top=sg_decrement_duration(value[1]);if(value[0]!==range_top)
value=SG.Renderers.duration.render(value[0])+" - "+
SG.Renderers.duration.render(range_top);else
value=String(SG.Renderers.duration.render(value[0]));}
renderer_name='text';}else if(schema_field.data_type=='footage'){if(typeof value!=='string'){if(value[0]!==value[1]-1){var start_value=SG.Renderers['footage'].render(value[0],schema_field);var end_value=SG.Renderers['footage'].render(value[1]-1,schema_field);value=start_value+" - "+end_value;}else{value=SG.Renderers['footage'].render(value[0],schema_field);}}
renderer_name='text';}else if(this.filter_panel.is_number_type(schema_field.data_type)){renderer_name='text';if(typeof value!=='string'){if(value[0]!==value[1]-1)
value=value[0]+" - "+(value[1]-1);else
value=String(value[0]);}}else if(this.filter_panel.is_date_type(schema_field.data_type)){value=value?SG.GroupHeadingRenderers.date.labels[value]:value;}
value=SG.Renderers[renderer_name].render(value,schema_field);}
var checkbox_id=field_path+"__"+value_index+"__"+this.filter_panel.widget.get_widget_id();var checkbox_attributes='field_path="'+field_path+'" value_index="'+
(value_index===null?'':value_index)+'"';var graph_width=0;if(count&&max_value)
graph_width=Math.floor(100*Number(count)/Number(max_value));return this.templates.checkbox_row.apply({checkbox:SG.Checkbox.render(checkbox_id,'',state,disabled,null,checkbox_attributes),checkbox_id:checkbox_id,value:value,count:count,width:graph_width,not_in_results_class:not_in_results?'not_in_results':'',other_attributes:not_in_results?'sg_tip="This value does not appear in the current page results."':''});},render_folder_body:function(field_path,schema_field,filter_group,values_hash)
{var html=[];var i,value,count,checked;this.set_temp_folder_state(filter_group);var top_folders=this.get_field_values(field_path,schema_field);var value_is_entity=['entity','multi_entity'].indexOf(schema_field.data_type)>-1;var rendered_values=[];for(i=0;i<top_folders.length;i++)
html.push(this.render_folder_recursively(field_path,schema_field,top_folders[i]));return html.join('');},set_temp_folder_state:function(filter_group){this.current_folder_path=null;this.current_project='__not_filtered__';if(filter_group){this.current_folder_path=filter_group.conditions[0].values[0];this.current_project=filter_group.conditions[1].values[0];}},folder_filtered:function(folder){var filtered=false;var child_filtered=false;if(folder.is_project){if(this.current_project==='__not_filtered__'){}else if(this.current_project===null&&folder.project_id===null){filtered=this.current_folder_path==='';child_filtered=!filtered;}else if(this.current_project!==null&&this.current_project.id===folder.project_id){filtered=this.current_folder_path==='';child_filtered=!filtered;}}
else{var project_match=(folder.project_id&&this.current_project&&this.current_project.id===folder.project_id)||(folder.project_id===null&&this.current_project===null);if(project_match){filtered=(this.current_folder_path&&this.current_folder_path===folder.path)||(folder.name===this.NO_FOLDER&&this.current_folder_path===null);child_filtered=(this.current_folder_path&&this.current_folder_path.indexOf(folder.name)===0);}}
return[filtered,child_filtered];},render_folder_recursively:function(field_path,schema_field,folder){var temp=this.folder_filtered(folder);var filtered=temp[0];var child_filtered=temp[1];var folder_html=this.render_folder(field_path,schema_field,folder,filtered,child_filtered);var open=folder.is_project?this.open_folders[folder.name]:this.open_folders[folder.path];if(open){var subfolder_html=[];var subfolder_name,subfolder;this.sort_folder_names(folder.subfolder_names,this.NO_FOLDER);for(var i=0;i<folder.subfolder_names.length;i++){subfolder_name=folder.subfolder_names[i];subfolder=folder.subfolders[subfolder_name];subfolder_html.push(this.render_folder_recursively(field_path,schema_field,subfolder));}
return folder_html+this.templates.subfolders.apply({subfolders:subfolder_html.join('')});}
return folder_html;},render_folder:function(field_path,schema_field,folder,filtered,child_filtered){var open=folder.is_project?this.open_folders[folder.name]:this.open_folders[folder.path];return this.templates.folder.apply({field_path:field_path,folder_index:folder.folder_index,folder_name:folder.name,count:folder.freq,subfolders_class:(folder.subfolder_names.length>0?'':'no_subfolders'),icon_name:open?'arrow_open_dark':'arrow_closed_dark',filtered_class:filtered?'filtered':child_filtered?'child_filtered':'',folder_icon:folder.is_project?'icon_Project':'icon_Folder',spacer_width:(folder.depth*this.FOLDER_INDENT_PIXEL_WIDTH),no_thing_class:[this.NO_FOLDER].indexOf(folder.name)>-1?'no_thing':''});},toggle_folder:function(field_path,schema_field,folder_dom,filter_group){if(folder_dom.firstChild.nextSibling.className.indexOf('arrow_closed_dark')>-1)
this.open_folder(field_path,schema_field,folder_dom,filter_group);else
this.close_folder(field_path,schema_field,folder_dom);},open_folder:function(field_path,schema_field,folder_dom,filter_group){var folder_index=Number(folder_dom.getAttribute('folder_index'));var folder=this.folder_list[folder_index];var subfolder_html=[];if(folder.is_project)
this.open_folders[folder.name]=true;else
this.open_folders[folder.path]=true;this.set_temp_folder_state(filter_group);this.sort_folder_names(folder.subfolder_names,this.NO_FOLDER);var subfolder_name,subfolder;for(var i=0;i<folder.subfolder_names.length;i++){subfolder_name=folder.subfolder_names[i];subfolder=folder.subfolders[subfolder_name];subfolder_html.push(this.render_folder_recursively(field_path,schema_field,subfolder));}
this.templates.subfolders.insertAfter(folder_dom,{subfolders:subfolder_html.join('')});Ext.get(folder_dom.firstChild.nextSibling).removeClass('arrow_closed_dark');Ext.get(folder_dom.firstChild.nextSibling).addClass('arrow_open_dark');},close_folder:function(field_path,schema_field,folder_dom){var folder_index=Number(folder_dom.getAttribute('folder_index'));var folder=this.folder_list[folder_index];if(folder.is_project)
this.open_folders[folder.name]=false;else
this.open_folders[folder.path]=false;folder_dom.parentNode.removeChild(folder_dom.nextSibling);Ext.get(folder_dom.firstChild.nextSibling).removeClass('arrow_open_dark');Ext.get(folder_dom.firstChild.nextSibling).addClass('arrow_closed_dark');},get_folder_info:function(folder_dom){var folder_index=Number(folder_dom.getAttribute('folder_index'));return this.folder_list[folder_index];},is_in_results:function(field_path,schema_field,value)
{if(['entity','multi_entity'].indexOf(schema_field.data_type)===-1){return true;}
var summary_data_set=this.current_filter_values_summary_data_sets[field_path];if(summary_data_set&&summary_data_set.group_summaries)
{for(var i=0;i<summary_data_set.group_summaries.length;i++)
{var found_value=schema_field.data_type=='entity'?summary_data_set.group_summaries[i].template_values[0]:summary_data_set.group_summaries[i].template_values[0][0];if((found_value===null&&value===null)||(found_value&&value&&found_value.type==value.type&&found_value.id==value.id))
{return true;}}
return false;}
else
return true;},array_contains_range:function(array,range){for(var i=0;i<array.length;i++){if(this.number_ranges_equal(array[i],range))
return true;}
return false;},number_ranges_equal:function(range_1,range_2){if(!range_1&&!range_2)
return true;else if(!range_1||!range_2)
return false;else if(range_1[0]===range_2[0]&&range_1[1]===range_2[1])
return true;else
return false;},get_field_values:function(field_path,schema_field)
{var values=[];if(schema_field.name==='folder'){values=this.get_field_values_folder(field_path,schema_field);}else if(this.filter_panel.is_number_type(schema_field.data_type)){values=this.get_field_values_number(field_path,schema_field);}else if(this.filter_panel.is_date_type(schema_field.data_type)){values=this.get_field_values_date(field_path,schema_field);}else if(this.filter_panel.is_summary_type(schema_field)){values=this.get_field_values_summary(field_path,schema_field);}
return values;},get_field_values_number:function(field_path,schema_field){var values=[];var summary_data_set=this.summary_data_sets[field_path];if(summary_data_set&&summary_data_set.group_summaries)
{var i,s,range_start,range_end,display_value;var last_range=null;var got_blank=false;for(i=0;i<summary_data_set.group_summaries.length;i++)
{s=summary_data_set.group_summaries[i];if(s.template_values[0]===null){values.push({value:null,freq:Number(s.summaries[0].value)});got_blank=true;continue;}
range_start=Number(s.template_values[0]);if(last_range===null)
last_range=range_start;else
if(schema_field.data_type==='footage')
last_range+=(summary_data_set.group_size*SG.globals.preferences.frames_per_foot)
else
last_range+=summary_data_set.group_size;while(last_range<range_start){if(schema_field.data_type==='footage')
new_end_range=last_range+(summary_data_set.group_size*SG.globals.preferences.frames_per_foot)
else
new_end_range=last_range+summary_data_set.group_size
values.push({value:[last_range,new_end_range],freq:0});last_range+=summary_data_set.group_size;}
if(schema_field.data_type==='footage')
range_end=range_start+(summary_data_set.group_size*SG.globals.preferences.frames_per_foot);else
range_end=range_start+summary_data_set.group_size;values.push({value:[range_start,range_end],freq:Number(s.summaries[0].value)});}
if(values.length>6){var cluster_size=Math.floor(values.length/5);if(cluster_size<2)cluster_size=2;var new_values=[];var cluster;var limit=got_blank?values.length-1:values.length;for(i=0;i<limit;i+=cluster_size){cluster={value:[values[i].value[0],values[i].value[1]],freq:values[i].freq};for(var j=1;j<cluster_size&&(i+j)<limit;j++){cluster.value[1]=values[i+j].value[1];cluster.freq+=values[i+j].freq;}
new_values.push(cluster);}
if(got_blank){new_values.push(values[limit]);}
values=new_values;}
if(values.length>(got_blank?1:0)){if(values[0].value[0]<summary_data_set.min_val)
values[0].value[0]=summary_data_set.min_val;var index=values.length-(got_blank?2:1);if(schema_field.data_type==='duration'){if(values[index].value[1]>sg_decrement_duration(summary_data_set.max_val))
values[index].value[1]=sg_increment_duration(summary_data_set.max_val);}else if(schema_field.data_type=='footage'){if(values[index].value[1]>summary_data_set.max_val-1){values[index].value[1]=values[index].value[1]+1;}}else{if(values[index].value[1]>summary_data_set.max_val-1){values[index].value[1]=summary_data_set.max_val+1;}}}}
return values;},get_field_values_date:function(field_path,schema_field){var values=[];var summary_data_set=this.summary_data_sets[field_path];if(summary_data_set&&summary_data_set.group_summaries){var s,display_value,group_hash,last_week_hash,tomorrow_hash;var this_week_count=0;var tomorrow_next_week=0;for(var i=0;i<summary_data_set.group_summaries.length;i++)
{s=summary_data_set.group_summaries[i];if(['earlier_this_week','later_this_week'].indexOf(s.template_values[0])>-1){this_week_count+=Number(s.summaries[0].value);continue;}else if(s.template_values[0]==='today'){this_week_count+=Number(s.summaries[0].value);}else if(s.template_values[0]==='yesterday'){if(SG.GridEditor.DateParser.get_normalized_start_of_calendar_week()<=SG.GridEditor.DateParser.get_normalized_yesterday())
{this_week_count+=Number(s.summaries[0].value);}
else if(last_week_hash){last_week_hash.freq+=Number(s.summaries[0].value);}else{values.push({value:'inclusive_last_week',freq:Number(s.summaries[0].value)});}}else if(s.template_values[0]==='tomorrow'){if(SG.GridEditor.DateParser.get_normalized_end_of_calendar_week()>=SG.GridEditor.DateParser.get_normalized_tomorrow())
{this_week_count+=Number(s.summaries[0].value);}
else{tomorrow_next_week=Number(s.summaries[0].value);}}
if(this_week_count>0&&(!s.template_values[0]||(s.template_values[0]==='far_future'||s.template_values[0].indexOf('next_')===0)))
{values.push({value:'this_week',freq:this_week_count});this_week_count=0;}
if(tomorrow_next_week>0&&s.template_values[0]!=='next_week'&&(!s.template_values[0]||(s.template_values[0]==='far_future'||s.template_values[0].indexOf('next_')===0)))
{values.push({value:'next_week',freq:tomorrow_next_week});tomorrow_next_week=0;}
group_hash={value:s.template_values[0],freq:Number(s.summaries[0].value)};values.push(group_hash);if(s.template_values[0]==='last_week'){last_week_hash=group_hash;group_hash.value='inclusive_last_week';}else if(s.template_values[0]==='next_week'){group_hash.freq+=tomorrow_next_week;group_hash.value='inclusive_next_week';tomorrow_next_week=0;}}
if(this_week_count){values.push({value:'this_week',freq:this_week_count});}
if(tomorrow_next_week){values.push({value:'inclusive_next_week',freq:tomorrow_next_week});}}
return values;},get_field_values_summary:function(field_path,schema_field){var values=[];var summary_data_set=this.summary_data_sets[field_path];var dont_sort,current_user,limit;if(summary_data_set&&summary_data_set.group_summaries)
{limit=summary_data_set.now_showing_count;if(summary_data_set.group_summaries.length==limit+this.filter_panel.extra_values_to_show)
limit+=this.filter_panel.extra_values_to_show;dont_sort=(summary_data_set.group_summaries.length==this.filter_panel.MIN_SUMMARIES_TO_REQUEST);var has_users=(['entity','multi_entity'].indexOf(schema_field.data_type)>-1&&schema_field.allowed_entity_types&&schema_field.allowed_entity_types.indexOf('HumanUser')>-1);var i,s,value;for(i=0;i<summary_data_set.group_summaries.length;i++){s=summary_data_set.group_summaries[i];if(schema_field.data_type=="multi_entity"){value={value:s.template_values[0][0]||null,freq:s.summaries[0].value};}else{value={value:s.template_values[0],freq:s.summaries[0].value};}
if(has_users&&value.value&&value.value.type==='HumanUser'&&value.value.id===SG.globals.current_user.id)
{if(value.value.name.indexOf('Me (')!==0)
value.value.name="Me ("+value.value.name+")";current_user=value;}else{values.push(value);}}}
if(!dont_sort){values.sort(function(a,b){return(b.freq-a.freq);});}
if(current_user)
values.splice(0,0,current_user);values=values.slice(0,limit);return values;},get_field_values_folder:function(field_path,schema_field){var i,values=[];var summary_data_set=this.summary_data_sets[field_path];if(summary_data_set&&summary_data_set.group_summaries)
{var single_project_context=this.filter_panel.page_project;this.folder_tree={subfolders:{},subfolder_names:[],freq:0,path:'',name:''};this.folder_list=[];var null_count=null;for(i=0;i<summary_data_set.group_summaries.length;i++)
{var s=summary_data_set.group_summaries[i];var project=s.template_values[0];var project_name=project?sg_project_name(project.id):this.NO_PROJECT;var project_as_folder=this.folder_tree.subfolders[project_name];if(!project_as_folder){project_as_folder={subfolders:{},subfolder_names:[],freq:0,is_project:true,path:'',name:project_name,folder_index:this.folder_list.length,project_id:project?project.id:null,depth:single_project_context?-1:0};this.folder_list.push(project_as_folder);this.folder_tree.subfolders[project_name]=project_as_folder;this.folder_tree.subfolder_names.push(project_name);}
var folder=s.template_values[1];if(folder===null){null_count=s.summaries[0].value;var no_path_key=this.NO_FOLDER;var no_path_folder={subfolders:{},subfolder_names:[],freq:Number(s.summaries[0].value),path:null,name:no_path_key,folder_index:this.folder_list.length,project_id:project?project.id:null,depth:single_project_context?0:1};this.folder_list.push(no_path_folder);project_as_folder.subfolders[no_path_key]=no_path_folder;project_as_folder.subfolder_names.push(no_path_key);project_as_folder.freq+=no_path_folder.freq;}else{this.add_subfolder(project_as_folder,folder.split('->'),Number(s.summaries[0].value));}}
this.sort_folder_names(this.folder_tree.subfolder_names,this.NO_PROJECT);var main_container;if(single_project_context){main_container=this.folder_tree.subfolders[this.folder_tree.subfolder_names[0]];}else{main_container=this.folder_tree;}
for(i=0;main_container&&i<main_container.subfolder_names.length;i++){var folder_name=main_container.subfolder_names[i];values.push(main_container.subfolders[folder_name]);}}
return values;},sort_folder_names:function(folder_names_array,last_token){sg_sort_case_insensitive(folder_names_array);var index=folder_names_array.indexOf(last_token);if(index>-1){folder_names_array.splice(index,1);folder_names_array.splice(0,0,last_token);}},add_subfolder:function(parent_folder,subfolder_path,freq){var name=subfolder_path[0].strip();var subfolder=parent_folder.subfolders[name];if(!subfolder){var path=name;if(parent_folder.path)
path=parent_folder.path+'->'+path;subfolder={subfolders:{},subfolder_names:[],freq:0,path:path,name:name,folder_index:this.folder_list.length,project_id:parent_folder.project_id,depth:parent_folder.depth+1};this.folder_list.push(subfolder);parent_folder.subfolders[name]=subfolder;parent_folder.subfolder_names.push(name);}
subfolder.freq+=freq;if(subfolder_path.length>1){this.add_subfolder(subfolder,subfolder_path.slice(1),freq);}
if(parent_folder.is_project)
parent_folder.freq+=freq;},add_date_grouping_interval:function(date,grouping){switch(grouping){case'day':return date.add(Date.DAY,1);case'week':return date.add(Date.DAY,7);case'month':return date.add(Date.MONTH,1);case'quarter':return date.add(Date.MONTH,3);case'year':return date.add(Date.YEAR,1);}},has_more_field_values:function(field_path,schema_field,known_field_values)
{if(this.filter_panel.is_summary_type(schema_field)&&!this.filter_panel.is_range_type(schema_field.data_type))
{var summary_data_set=this.summary_data_sets[field_path];if(summary_data_set&&summary_data_set.group_summaries&&(summary_data_set.group_summaries.length>known_field_values.length))
return true;}
return false;}});SG.Widget.EntityQuery.Filter.NumberSlider=function(config)
{Ext.apply(this,config);SG.Widget.EntityQuery.Filter.NumberSlider.superclass.constructor.call(this);};Ext.extend(SG.Widget.EntityQuery.Filter.NumberSlider,SG.Component,{templates:{filter_shading:'<div class="filter_shading" style="left:{left}px; width:{width}px;"></div>'},SLIDER_RIGHT_MARGIN:20,SLIDER_HANDLE_CLEARANCE:10,init_component:function(){var summary_set=this.filter_panel.summary_data_sets[this.field_path];this.range_min=summary_set.min_val;this.range_max=summary_set.max_val;this.real_width=this.range_max-this.range_min;var slider_dom_elem=Ext.get(sg_find('div.slider[field_path="'+this.field_path+'"] div.knob.min',this.filter_panel.container.dom));if(!slider_dom_elem)
return;this.width=slider_dom_elem.dom.parentNode.offsetWidth-this.SLIDER_RIGHT_MARGIN;var filters=this.filter_panel.get_panel_filters();var filter_group=this.filter_panel.get_filter_group(filters,this.field_path);var slider_min=null,slider_max=null;var actual_min=null,actual_max=null;var filter_pixel_ranges=[];if(filter_group){var cond;for(var i=0;i<filter_group.conditions.length;i++){cond=filter_group.conditions[i];var max_adjust=cond.range_slider?0:-1;if(cond.values.length===2){if(slider_min===null||cond.values[0]<slider_min)
slider_min=cond.values[0];if(slider_max===null||(cond.values[1]+max_adjust)>slider_max)
slider_max=cond.values[1]+max_adjust;filter_pixel_ranges.push([this.actual_to_slider_position(cond.values[0]),this.actual_to_slider_position(cond.values[1]+max_adjust)]);}}
if(slider_max!==null){if(slider_max>this.range_max)
slider_max=this.range_max;if(slider_min<this.range_min)
slider_min=this.range_min;actual_min=slider_min;actual_max=slider_max;slider_min=this.actual_to_slider_position(slider_min);slider_max=this.actual_to_slider_position(slider_max);}else{slider_min=0;slider_max=this.width;actual_min=this.range_min;actual_max=this.range_max;this.unfiltered=true;}}else{slider_min=0;slider_max=this.width;actual_min=this.range_min;actual_max=this.range_max;this.unfiltered=true;}
this.min=slider_min;this.max=slider_max;this.actual_min=actual_min;this.actual_max=actual_max;this.min_slider_dd=this.create_slider_dd(slider_dom_elem,'min');slider_dom_elem=Ext.get(sg_find('div.slider[field_path="'+this.field_path+'"] div.knob.max',this.filter_panel.container.dom));this.max_slider_dd=this.create_slider_dd(slider_dom_elem,'max');this.set_positions();this.set_display_values();this.render_filter_shadings(filter_pixel_ranges);var slider_line=this.get_slider_line();this.add_event(slider_line,'click',this.on_slider_line_click);},set_range_filter:function(){if(this.actual_min===this.range_min&&this.actual_max===this.range_max)
this.filter_panel.clear_field_filters(this.field_path);else
this.filter_panel.on_slider_range_changed(this.field_path,this.actual_min,this.actual_max);},set_actual:function(side){if(side==='min'){this.actual_min=this.slider_position_to_actual(this.min);}else{this.actual_max=this.slider_position_to_actual(this.max);}},slider_position_to_actual:function(slider_position){return Math.round(this.range_min+(this.real_width*slider_position/this.width));},actual_to_slider_position:function(actual_value){return Math.round(this.width*(actual_value-this.range_min)/this.real_width);},set_display_values:function(){var values_div=this.min_slider_dd.drag_elem.dom.parentNode.nextSibling;var text=this.format(this.actual_min)+" - "+this.format(this.actual_max);if(this.unfiltered)
text+=" (all)";values_div.innerHTML=text;},format:function(value){if(this.schema_field.data_type==='currency'){return SG.Renderers.currency.render(value);}else if(this.schema_field.data_type==='duration'){return SG.Renderers.duration.render(Math.floor(value/60)*60);}else if(this.schema_field.data_type==='percent'){return value+'%';}else if(this.schema_field.data_type==='footage'){return SG.Footage.frames_to_footage(value);}
return value;},set_positions:function(){if(this.min>this.width-this.SLIDER_HANDLE_CLEARANCE)
this.min=this.width-this.SLIDER_HANDLE_CLEARANCE;if(this.max<this.SLIDER_HANDLE_CLEARANCE)
this.max=this.SLIDER_HANDLE_CLEARANCE;if(this.min>this.max-this.SLIDER_HANDLE_CLEARANCE)
this.min=this.max-this.SLIDER_HANDLE_CLEARANCE;this.min_slider_dd.drag_elem.setLeft(this.min);this.max_slider_dd.drag_elem.setLeft(this.max);},create_slider_dd:function(slider_dom_elem,side){var slider_dd=new Ext.dd.DD(slider_dom_elem.dom.id);slider_dd.scroll=false;slider_dd.resizeFrame=false;slider_dd.setYConstraint(0,0);slider_dd.setXConstraint(0,this.width);slider_dd.drag_elem=slider_dom_elem;slider_dd.side=side;slider_dd.other_side=(side==='min')?'max':'min';slider_dd.controller=this;slider_dd.b4StartDrag=function(x,y){this.resetConstraints();var left=this.drag_elem.getLeft(true);if(this.side=='min'){this.setXConstraint(left,this.controller.max-left-this.controller.SLIDER_HANDLE_CLEARANCE);}else{this.setXConstraint(left-this.controller.min-this.controller.SLIDER_HANDLE_CLEARANCE,this.controller.width-left);}
this.setYConstraint(0,0);};slider_dd.startDrag=function(){this.drag_elem.addClass('dragging');};slider_dd.endDrag=function(){this.drag_elem.removeClass('dragging');this.controller[this.side]=this.drag_elem.getLeft(true);this.controller.set_actual(this.side);this.controller.set_display_values();this.controller.set_range_filter();};slider_dd.onDrag=function(){this.controller[this.side]=this.drag_elem.getLeft(true);this.controller.render_changing_filter_shadings();this.controller.unfiltered=false;this.controller.set_actual(this.side);this.controller.set_display_values();};return slider_dd;},get_slider_line:function(){return sg_find('div.slider[field_path="'+this.field_path+'"] div.slider_line_shape',this.filter_panel.container.dom);},render_filter_shadings:function(filter_pixel_ranges){var slider_line=this.get_slider_line();if(filter_pixel_ranges.length===0){slider_line.innerHTML=this.templates.filter_shading.apply({left:0,width:this.width});return;}
var html=[];for(var i=0;i<filter_pixel_ranges.length;i++){html.push(this.templates.filter_shading.apply({left:filter_pixel_ranges[i][0],width:filter_pixel_ranges[i][1]-filter_pixel_ranges[i][0]+1}));}
slider_line.innerHTML=html.join('');},render_changing_filter_shadings:function(){var left=this.min_slider_dd.drag_elem.getLeft(true);var right=this.max_slider_dd.drag_elem.getLeft(true);var slider_line=this.get_slider_line();slider_line.innerHTML=this.templates.filter_shading.apply({left:left,width:right-left});},destroy_component:function(){this.min_slider_dd.destroy();this.max_slider_dd.destroy();},on_slider_line_click:function(e){var x=e.xy[0]-15;if(x-this.min_slider_dd.drag_elem.getLeft(true)<this.max_slider_dd.drag_elem.getLeft(true)-x){this.min=x;this.set_actual('min');this.set_display_values();this.set_range_filter();}else{this.max=x;this.set_actual('max');this.set_display_values();this.set_range_filter();}}});SG.SavedFilters=function(config)
{Ext.apply(this,config);SG.SavedFilters.superclass.constructor.call(this);};Ext.extend(SG.SavedFilters,SG.FloatingComponent,{templates:{main:'<div class="sgc_saved_filters {state}">{header}<div class="saved_filters">{filters}</div></div>',header:'<div class="header" field_path="_saved_filters_">'+'<div class="tip {state_icon}">{spinner}</div><span class="field_name">Custom</span>'+'<div class="gear gear_menu_nobg"></div><div class="grouping_row_icon drag"></div>'+'<div class="toolbar_plus"></div></div>',floating_panel:'<div class="header"><div class="icon_search"></div><div class="header_text">{header_text}</div>'+'<img class="close_window" src="/images/close_overlay_x.png">'+'<div class="callout {callout_position}"></div></div>'+'<div class="filter_name"><table><tr><td class="label"><div class="label">Filter Name:</div></td>'+'<td class="value"><input class="filter_name" type="text" value="{filter_name}"></td></table></div>'+'<div class="page_conditions"></div><div class="footer">'+'<input type="button" value="{button_text}" class="submit_button {button_class}">'+'<input type="button" value="Preview" class="preview"></div>',saved_filter:'<div class="saved_filter_row" record_id="{record_id}" checkbox_id="{checkbox_id}">{checkbox}'+'<div class="filter_name">{filter_name}</div>'+'<div class="trash delete_saved_filter"></div><div class="icon_edit edit_saved_filter"></div></div>',deleted_filter:'<div class="saved_filter_row" record_id="{record_id}" checkbox_id="{checkbox_id}">{checkbox}'+'<div class="filter_name">{filter_name}</div>'+'<div class="trash delete_saved_filter already_deleted_in_db"></div></div>',no_filters_message:'<div class="no_filters">No custom filters yet.</div>',spinner:'<img class="spinner" src="/images/indicator_large_transparent.gif" />'},init_component:function()
{SG.FloatingComponent.prototype.init_component.call(this);},destroy_component:function()
{SG.FloatingComponent.prototype.destroy_component.call(this);},hide:function(){this.hide_floating_panel();},on_first_render:function()
{this.state='open';this.selected_filter_ids=[];this.add_event(SG.Checkbox,"change",this.on_checkbox_changed);this.dbody=Ext.get(document.body);this.add_event(this.dbody,'click',this.on_click_dbody);this.fetch_filters();},render:function()
{if(!this.rendered){this.on_first_render();this.rendered=true;}
var html=this.templates.main.apply({state:this.state,header:this.render_header(),filters:this.render_saved_filters(),});this.container.update(html);},render_header:function(){if(this.data_set.is_loaded()){return this.templates.header.apply({state_icon:this.state=="open"?"arrow_open_dark":"arrow_closed_dark",spinner:'',});}else{return this.templates.header.apply({state_icon:'',spinner:this.templates.spinner.apply()});}},re_render_header:function(){var html=this.render_header();var header=this.container.child('div.header');header.remove();var saved_filters=this.container.child('div.saved_filters');Ext.DomHelper.insertBefore(saved_filters,html);},render_saved_filters:function(){if(!this.data_set.is_loaded())
return'';if(this.data_set.count()==0)
return this.templates.no_filters_message.apply();var html='';for(var i=0;i<this.data_set.count();i++){var rec=this.data_set.get_record(i);var checkbox_id=this.checkbox_id(rec.id);var state=this.is_checked(rec.id)?'checked':'unchecked';html+=this.templates.saved_filter.apply({checkbox_id:checkbox_id,checkbox:SG.Checkbox.render(checkbox_id,'',state,false,null),filter_name:rec.get('code'),record_id:rec.id});}
var filters=this.filter_panel.saved_filters;if(filters){for(var i=0;i<filters.conditions.length;i++){if(filters.conditions[i].saved_filters_record_id&&!this.data_set.get_record_by_id(filters.conditions[i].saved_filters_record_id))
{var id=filters.conditions[i].saved_filters_record_id;var checkbox_id=this.checkbox_id(id);html+=this.templates.deleted_filter.apply({checkbox_id:checkbox_id,checkbox:SG.Checkbox.render(checkbox_id,'','checked',false,null),filter_name:'(Deleted Filter)',record_id:id});}}}
return html;},checkbox_id:function(record_id){return'saved_filter_'+this.widget.get_widget_id()+'_'+record_id;},on_load_saved_filters:function(){this.render();if(this.update_filter_panel_on_load){this.update_filter_panel_on_load=false;this.update_filter_panel();}},fetch_filters:function(){if(this.data_set)
this.data_set.destroy();this.data_set=new SG.Data.Set('SavedFilter');this.data_set.on("load",this.on_load_saved_filters,this);this.data_set.on("change",this.on_change_saved_filters,this);var filters={logical_operator:"and",conditions:[{active:true,path:'entity_type',relation:'is',values:[this.entity_type]},{active:true,path:'created_by',relation:'is',values:[SG.globals.current_user.entity_hash]},]};var spec={type:'SavedFilter',filters:filters,sorts:[{column:"created_at",direction:"desc"}],columns:['id','code','filters'],current_page:1,records_per_page:100,result:this.data_set};SG.Repo.query(spec);},on_click_dbody:function(e){if(!this.inside_document_body(e.target))
return;var t=Ext.get(e.target);var container=t.findParent('div.sgc_saved_filters',document.body);if(container)
return;var floating_panel=t.findParent('div.sgc_saved_filters_panel',40);if(floating_panel)
return;var sg_main=t.findParent('div.sg_main',document.body);if(sg_main)
this.hide_floating_panel();var global_nav=t.findParent('#sg_global_nav',document.body);if(global_nav)
this.hide_floating_panel();},inside_document_body:function(elem){while(elem.parentNode){elem=elem.parentNode;}
return elem==document;},on_click:function(e,t){var plus_button=t.findParent('div.toolbar_plus',this.container.dom,true);if(plus_button){this.hide_floating_panel();this.show_floating_panel(null);return;}
var edit_saved_filter=t.findParent('div.edit_saved_filter',this.container.dom,true);if(edit_saved_filter){var saved_filter_row=edit_saved_filter.findParent('div.saved_filter_row',this.container.dom);var rec_id=Number(saved_filter_row.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(rec_id);this.hide_floating_panel();this.show_floating_panel(rec);return;}
var delete_saved_filter=t.findParent('div.delete_saved_filter',this.container.dom,true);if(delete_saved_filter){var saved_filter_row=delete_saved_filter.findParent('div.saved_filter_row',this.container.dom);if(delete_saved_filter.hasClass('already_deleted_in_db')){var checkbox_div=sg_find('div.sg_checkbox',saved_filter_row);var id=checkbox_div.getAttribute('id');SG.Checkbox.set_state(id,'unchecked');this.update_filter_panel();return;}
var rec_id=Number(saved_filter_row.getAttribute('record_id'));var rec=this.data_set.get_record_by_id(rec_id);rec.retire();this.data_set.commit();return;}
var checkbox=t.findParent('div.sg_checkbox',this.container.dom);if(checkbox)return;var saved_filter_row=t.findParent('div.saved_filter_row',this.container.dom,true);if(saved_filter_row){var checkbox_id=saved_filter_row.dom.getAttribute('checkbox_id');SG.Checkbox.toggle(checkbox_id);var checkbox=saved_filter_row.child('div.sg_checkbox');this.on_checkbox_changed(checkbox.dom);return;}
var header=Ext.get(t.findParent('div.header'),this.container.dom);if(header){var body=Ext.get(header.findParent('div.sgc_saved_filters'),this.container.dom);this.state=body.hasClass('open')?"closed":"open";this.render();e.stopEvent();return;}},show_floating_panel:function(rec){this.preview_happened=false;this.floating_panel=Ext.DomHelper.append(document.body,{tag:'div',cls:'sgc_saved_filters_panel'},true);this.floating_panel_record=rec;this.add_event(this.floating_panel,'click',this.on_floating_panel_click);var button_class='update';var button_text='Update';var filters;var tipout_elem;if(!rec){button_class='create';button_text='Create';filters={logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]};tipout_elem=this.container.child('div.header');}
else
filters=rec.get('filters');var filter_name='New Filter';if(rec){filter_name=rec.get('code');tipout_elem=this.container.child('div.saved_filter_row[record_id="'+rec.id+'"]');}
var html=this.templates.floating_panel.apply({header_text:'',callout_position:this.position_right?'right':'left',button_class:button_class,button_text:button_text,filter_name:filter_name});this.floating_panel.update(html);var qb_container=this.floating_panel.child('div.page_conditions');this.qb_component=new SG.PageConditions({condition:filters,container:qb_container,entity_type:this.entity_type,context_projects:this.widget.context_projects(),token_context_widget:this.widget,condition_changed_callback:{fn:this.qb_filters_changed,scope:this}});this.qb_component.render();this.position_floating_panel(tipout_elem);var filter_name_input=this.floating_panel.child('input.filter_name');if(!rec)filter_name_input.dom.select();filter_name_input.focus();var dd=new Ext.dd.DDProxy(this.floating_panel,"focus_win",{scroll:false});var header=this.floating_panel.child('div.header');dd.setHandleElId(header);dd.saved_filters=this;dd.startDrag=function(){this.constrainTo(this.saved_filters.dbody);this.getDragEl().style.border="2px solid #666666";};dd.afterDrag=function(){var callout=this.saved_filters.floating_panel.child('img.callout');callout.setDisplayed(false);this.getDragEl().style.border="2px solid #aaa";};},position_floating_panel:function(tipout_elem){var height=this.floating_panel.getHeight();var dbody=Ext.get(document.body);var dbody_height=dbody.getHeight();var dbody_width=dbody.getWidth();var tipout_elem_top=tipout_elem.getTop();var tipout_elem_left=tipout_elem.getLeft();var tipout_elem_right=tipout_elem.getRight();var tipout_elem_height=tipout_elem.getHeight();if(tipout_elem_top+height<dbody_height)
this.floating_panel.setTop(tipout_elem_top-32);else
this.floating_panel.setTop(dbody_height-height-52);if(this.position_right)
this.floating_panel.setRight(dbody_width-tipout_elem_left+12);else
this.floating_panel.setLeft(tipout_elem_right+12);},qb_filters_changed:function(filters){var height=this.floating_panel.getHeight();var dbody=Ext.get(document.body);var dbody_height=dbody.getHeight();var panel_top=this.floating_panel.getTop();if(panel_top+height+25>dbody_height){this.floating_panel.setTop(dbody_height-(height+25));var callout=this.floating_panel.child('img.callout');callout.setDisplayed(false);}},hide_floating_panel:function(){if(this.floating_panel){this.remove_event(this.floating_panel,'click',this.on_floating_panel_click);this.qb_component.destroy();this.floating_panel.remove();this.floating_panel=null;if(this.preview_happened)
this.update_filter_panel();}},on_floating_panel_click:function(e){var t=Ext.get(e.target);var close_window=t.findParent('img.close_window',this.floating_panel.dom);if(close_window){var me=this;setTimeout(function(){me.hide_floating_panel();},0);return;}
var button=t.findParent('input.submit_button',this.floating_panel.dom,true);if(button){var filters=this.qb_component.get_condition();var count=this.count_active_filters(filters.conditions);if(count==0){alert('Please provide at least one active filter condition');return;}
if(button.hasClass('create'))
this.create_new_saved_filter();else
this.update_saved_filter();return;}
var preview=t.findParent('input.preview',this.floating_panel.dom);if(preview)
this.preview_filter();},count_active_filters:function(conditions){var count=0;for(var i=0;i<conditions.length;i++){var cond=conditions[i];if(cond.active=="true")
count++;else if(cond.conditions)
count+=this.count_active_filters(cond.conditions);}
return count;},preview_filter:function(){this.preview_happened=true;var filters=this.qb_component.get_condition();this.filter_panel.on_saved_filters(filters);},create_new_saved_filter:function(){var filters=this.qb_component.get_condition();var data_set=new SG.Data.Set('SavedFilter');data_set.on("change",this.on_new_filter_data_set_changed,this);var record=data_set.new_record();record.set('entity_type',this.entity_type);var name_input=this.floating_panel.child('input.filter_name');record.set('code',name_input.dom.value);record.set('filters',filters);data_set.commit(true);},on_new_filter_data_set_changed:function(changes)
{var found_create=false;var found_record;for(var i=0;i<changes.length;i++){var change=changes[i];if(change.type=="create"){found_record=change.record;found_create=true;}}
if(found_create){this.update_filter_panel_on_load=true;this.add_new_filter(found_record);var me=this;setTimeout(function(){me.hide_floating_panel();me.fetch_filters();me.re_render_header();},0);}},on_change_saved_filters:function(changes){var found_update_or_retire=false;var found_unretire=false;var found_record_id;for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='pending')continue;if((change.type=="update"&&change.state=='server')||change.type=='retire')
{found_record_id=change.record.id;found_update_or_retire=true;}else if(change.type=="revive")
found_unretire=true;}
if(found_update_or_retire){var me=this;setTimeout(function(){me.hide_floating_panel();var state=SG.Checkbox.get_state(me.checkbox_id(found_record_id));if(state=='checked')me.update_filter_panel_on_load=true;me.fetch_filters();me.re_render_header();},0);}
if(found_unretire){var me=this;setTimeout(function(){me.hide_floating_panel();me.fetch_filters();me.re_render_header();},0);}},update_saved_filter:function(){var filters=this.qb_component.get_condition();var name_input=this.floating_panel.child('input.filter_name');this.floating_panel_record.set('code',name_input.dom.value);this.floating_panel_record.set('filters',filters);if(SG.Checkbox.get_state(this.checkbox_id(this.floating_panel_record.id))!=='checked'){SG.Checkbox.set_state(this.checkbox_id(this.floating_panel_record.id),'checked');this.update_filter_panel();}
this.data_set.commit(true);},on_checkbox_changed:function(checkbox){if(!this.filter_panel.in_this_filter_panel(checkbox))
return;if(checkbox.parentNode.className!=='saved_filter_row')
return;this.update_filter_panel();},is_checked:function(record_id){var filters=this.filter_panel.saved_filters;if(filters){for(var i=0;i<filters.conditions.length;i++){if(filters.conditions[i].saved_filters_record_id===record_id)
return true;}}
return false;},update_filter_panel:function(){var conditions=[];var checkbox_divs=sg_find_all('div.sg_checkbox',this.container.dom);for(var i=0;i<checkbox_divs.length;i++){var div=Ext.get(checkbox_divs[i]);if(div.hasClass('checkbox_checked')){var id=div.dom.getAttribute('id');var parts=id.split('_');var rec_id=Number(parts[3]);var rec=this.data_set.get_record_by_id(rec_id);var filters=rec.get('filters');filters.saved_filters_record_id=rec_id;conditions.push(filters);}}
if(conditions.length==0){this.filter_panel.on_saved_filters(null);}else{var filters={logical_operator:'or',conditions:conditions};this.filter_panel.on_saved_filters(filters);}},add_new_filter:function(new_record){var filters=this.filter_panel.saved_filters;if(!filters){filters={logical_operator:'or',conditions:[]}}
var rec_filters=new_record.get('filters');rec_filters.saved_filters_record_id=new_record.id;filters.conditions.push(rec_filters);this.data_set.copy_record(new_record,new_record.id);this.filter_panel.on_saved_filters(filters);},clear_checked_filters:function(){var checkbox_divs=sg_find_all('div.sg_checkbox',this.container.dom);for(var i=0;i<checkbox_divs.length;i++){var div=Ext.get(checkbox_divs[i]);if(div.hasClass('checkbox_checked')){var id=div.dom.getAttribute('id');SG.Checkbox.set_state(id,'unchecked');}}},});SG.Widget.EntityPane.Wrapper=function(context,widget_spec,id)
{SG.Widget.EntityPane.Wrapper.superclass.constructor.call(this,context,widget_spec,id);}
Ext.extend(SG.Widget.EntityPane.Wrapper,SG.Widget.Base,{templates:{breadcrumb_link:'<li index="{index}" class="breadcrumb" style="float: left;"><img src="{icon}">'+'<span class="breadcrumb_link {extra_class}">{name}</span></li>',breadcrumb_link1:'<li index="{index}" class="breadcrumb" style="float: left;"><<<img src="{icon}">'+'<span class="breadcrumb_link {extra_class}">{name}</span></li>',breadcrumb_space:'<li style="float: left;"class="breadcrumb_divider">/</li>'},init_children:function(){},init_widget:function(){this.on("context_changed",this.on_context_changed,this);this.rendered_once=false;this.init_history();},init_history:function(){var widget=this;this.hash=window.location.hash;this.hash_interval=window.setInterval(function(){if(widget.hash!=window.location.hash){widget.check_unsaved_changes_and_change_state();}},100);},check_unsaved_changes_and_change_state:function()
{if(SG.Page.unsaved_data.confirm_proceed())
this.change_state();else
window.location.hash=this.hash;},change_state:function()
{var entity=this.context.get('entity');this.hash=window.location.hash;if(this.hash=="#"||this.hash==""){this.close();}
else if(m=this.hash.match(/#([A-Za-z0-9]+)_(\d+)_(.*)/))
{this.open();if(entity==null||m[1]!=entity.type||m[2]!=entity.id){this.context.set('entity',{type:m[1],id:m[2],name:decodeURIComponent(m[3])});}}},destroy_widget:function(){window.clearInterval(this.hash_interval);},on_context_changed:function(x){if(this.rendered_once){this.render();}},init_page:function(page_config){var dh=Ext.DomHelper;var container=this.get_container();dh.append(container,{tag:'div',cls:'sg_page inside_pane',id:'sg_page_'+page_config.config.id});this.page=new SG.Page(page_config.config,page_config.context,page_config.settings);this.page.on('show_entity_detail',this.on_show_entity_detail,this);this.hide_loading_overlay();},render:function()
{this.rendered_once=true;var entity=this.context.get('entity');this.cache_entity(entity);var container=this.get_container();var widget=this;if(this.page){this.page.un('show_entity_detail',this.on_show_entity_detail);this.page.destroy_root_widget();}
if(entity&&entity.type&&entity.id){window.setTimeout(function(){window.location.hash="#"+entity.type+"_"+entity.id+"_"+encodeURIComponent(entity.name);},1);container.update('');this.show_loading_overlay();var options={url:'/detail/'+entity.type+'/'+entity.id,params:{json:true},callback:function(options,success,response){if(response&&response.getResponseHeader&&response.getResponseHeader["SG_FAILED_AUTH"]){window.location.reload(true);return;}
if(success){var page;eval("page = "+response.responseText);page.config["parent_page"]=widget.get_page();page.context["in_pane"]=true;widget.init_page(page);}else{widget.hide_loading_overlay();}},};var conn=new Ext.data.Connection();conn.request(options);}else{container.update("ERROR: No valid entity found");}},render_breadcrumbs:function(container)
{if(!this.entity_cache)
return;return;var dh=Ext.DomHelper;var h='<ul>';var page=this.get_page();var page_name=(page.type=='detail')?this.entity_name_display_string(page.context.get('entity')):page.context.get('title');var root_icon=SG.globals.icons.entities[page.entity_type];if(!root_icon)
{if(page.type=='canvas')
root_icon=SG.globals.icons.Dashboard;else if(page.type=='home')
root_icon=SG.globals.icons.HomePage;else
root_icon=SG.globals.icons.Blank;}
h+=this.templates.breadcrumb_link1.apply({index:-1,icon:root_icon,name:'Back to '+page_name});var name;var extra_class='';var icon,row;for(var i=0;i<this.entity_cache.length;i++)
{extra_class=(this.entity_cache.length-1)==i?'breadcrumb_bold':'';h+=this.templates.breadcrumb_space.apply();icon=SG.globals.icons.entities[this.entity_cache[i].type];if(this.entity_cache[i].type=="Reply"){row=SG.Repo.get_row("Reply",this.entity_cache[i].id);if(row&&row.get('entity'))
icon=SG.globals.icons.entities[row.get('entity').type];}
h+=this.templates.breadcrumb_link.apply({index:i,icon:icon,name:this.entity_name_display_string(this.entity_cache[i]),extra_class:extra_class});}
h+='</ul>';this.breadcrumb_div=dh.append(container,{tag:'div',html:h,cls:'breadcrumb'},true);},entity_name_display_string:function(entity_hash)
{return entity_hash.name.length>50?entity_hash.name.substr(0,50)+'...':entity_hash.name;},on_show_entity_detail:function(entity_type,entity_id,entity_name){this.context.set('entity',{type:entity_type,id:entity_id,name:entity_name});},cache_entity:function(entity){if(!this.entity_cache)
this.entity_cache=[];if(!entity)
return;var c=-1;for(var i=0;i<this.entity_cache.length;i++)
{var cache_entity=this.entity_cache[i];if(cache_entity.id==entity.id&&cache_entity.type==entity.type)
{c=i;break;}}
if(c==-1)
this.entity_cache.push(entity);else
this.entity_cache.splice(c+1);},on_breadcrumb_click:function(e)
{var t=e.getTarget();var elem=Ext.get(t).findParent('li.breadcrumb',this.get_container());if(elem)
{if(!SG.Page.unsaved_data.confirm_proceed())
{e.stopEvent();SG.Menu.cancel_current();return;}
sg_close_all_floating_windows();var i=parseInt(elem.getAttribute('index'));if(i>=0)
{var ec=this.entity_cache[i];this.context.set('entity',{type:ec.type,id:ec.id,name:ec.name});}
else
{this.close();}}},open:function(){var pane=this.get_container().findParent('.pane',document.body,true);Ext.fly(pane.getPrevSibling()).addClass('hidescrollbars');if(!pane.isVisible()){pane.enableDisplayMode();pane.show();}},close:function(){if(this.page){this.page.un('show_entity_detail',this.on_show_entity_detail);this.page.destroy_root_widget();}
this.context.set("entity",null);var pane=this.get_container().findParent('.pane',document.body,true);Ext.fly(pane.getPrevSibling()).removeClass('hidescrollbars');window.setTimeout(function(){window.location.hash="#"},1);if(!pane.isVisible())return;pane.enableDisplayMode();pane.hide();this.entity_cache=[];var page=this.get_page();var title_text=page.context.get('title')+' - Shotgun';if(page.root_widget)
{var title_widget=page.root_widget.get_child('title');if(title_widget&&typeof title_widget.get_browser_page_title=='function'){title_text=title_widget.get_browser_page_title();}
if(!page.root_widget.content_rendered)
setTimeout(function(){page.rerender();},0);}
document.title=title_text;}});SG.Widget.Text=function(context,widget_spec,id)
{SG.Widget.Text.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Text,SG.Widget.Base,{default_settings:{content:"There is currently no content on this page. Click on the *'Edit'* button on the right to add some."},mode:'display',templates:{widget:'<div class="sg_widget_text">{body}</div>',body:'<div class="sg_widget_text_content"><a name="edit" class="sg_widget_text_edit_link"'+' sg_tip="Edit this page">Edit</a>'+'<img class="sg_widget_note_detail_edit" style="float: right;" name="edit" src="'+SG.globals.icons.Edit+'" sg_tip="Edit this page">'+'<div class="sg_widget_text_content_body">{content}</div></div>',edit_body:'<div class="sg_widget_text_edit_content">'+'<textarea class="sg_widget_text_formcontent" name="content">{content}</textarea><br />'+'<input name="save" class="sg_widget_text_save_link" type="button" value="Save"> or '+'<a name="cancel" class="sg_widget_text_cancel_link">Cancel</a></div>',},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_widget_click);},render_widget:function()
{if(this.mode=='edit')
{this.render_edit();}
else
{this.render_display();}},render_display:function()
{var html_content=SG.Markup.parse(this.get('content'));var body=this.templates['body'].apply({content:html_content});var widget=this.templates['widget'].apply({body:body});this.container.update(widget);},render_edit:function()
{var c=this.get('content');if(c==this.default_settings.content){c='';}
var edit_body=this.templates['edit_body'].apply({content:c});var widget=this.templates['widget'].apply({body:edit_body});this.container.update(widget);},on_widget_click:function(e,target,options)
{var name=target.name;if(name=="edit")
{this.mode='edit';this.render_widget();}
else if(name=="save")
{this.save_form();this.mode='display';this.render_widget();}
else if(name=="cancel")
{this.mode='display';this.render_widget();}},save_form:function()
{var new_content=this.container.child(".sg_widget_text_formcontent").dom.value;this.set('content',new_content);},destroy_widget:function()
{}});SG.UserSettingsDialog=function(config){Ext.apply(this,config);this.events={'dialog_submitted':true,'dialog_cancelled':true};SG.UserSettingsDialog.superclass.constructor.call(this,config);};Ext.extend(SG.UserSettingsDialog,SG.Component,{templates:{title:'<div class="title">{name}\'s Settings</div>',layout_menu_clean:'<div class="layout_menu"><img src="/images/icon_page_settings.png"></div>',layout_menu_dirty:'<div class="layout_menu"><img src="/images/icon_page_settings_dirty.png"></div>',header:'<img class="gear_menu" src="/images/gear_menu_nobg.png">',image_field:'<div class="shadow_pad"><div class="cell {cell_classes}" {cell_attributes}>{cell_content}</div><div>',image_text:'<div>Right click on picture to change it.&nbsp; Changes are saved immediately.</div>',email_notifications:'<div class="title">Notifications</div>'+'<div>Shotgun can send you email notifications. &nbsp;Learn more about how this works on '+'<a target="_blank" href="'+
SG.globals.help_urls.user_settings+'">our documentation</a> wiki.<br/>'+'<span class="email_empty" style="color: #f00;">Please fill in your email address above '+'to receive notifications.</span></div>'+'<div style="margin: 14px;"><table class="notifications">{table_contents}</table></div>',email_field:'<tr><td><div class="{cell_classes}" {cell_attributes}>{cell_content}</div></td>'+'<td><div class="email_setting_description">{description}</div></td></tr>',ldap_warning:'<div class="ldap_warning">Disabled fields are defined by a central LDAP server. &nbsp;'+'Contact your site admin to make changes.</div>',field:'<div class="field" field="{field}"><table class="field_edit {field_classes}"><tr>'+'<td class="field_label {mandatory}" sg_tip="{sg_tip}"><div>{field_label}</div></td>'+'<td class="field_value {cell_classes}" {cell_attributes}>{cell_content}'+'</td></tr></table></div>',password_button:'<div class="field password"><table class="field_edit"><tr>'+'<td class="field_label"><div>&nbsp;</div></td>'+'<td class="field_value"><input type="button" class="change_password_button" {disabled} '+'value="Change Password"></td></tr></table></div>',footer:'<div class="controls"><span class="cancel">Cancel</span>'+'<input name="save" type="button" value="Save Changes"></div>',empty:'<div class="empty">There are no fields configured for this form.'+' Use the gear menu in the top right hand corner of this form to add some.</div>',email_all:'Subscribe to all <b>{entity_type_plural}</b> in Projects I have access to.',email_some:'Subscribe to <b>{entity_type_plural}</b> addressed To or Cc you or a Group you&#39;re in, '+'any {entity_type_plural} you&#39;ve created, or any threads you&#39;ve replied to.',email_all_Task:'Subscribe to updates for all <b>{entity_type_plural}</b> in Projects I have access to.',email_some_Task:'Subscribe to updates for <b>{entity_type_plural}</b> Assigned To you or a Group you&#39;re in, or '+'for {entity_type_plural} Cc&#39;d to you or a Group you are in.',email_all_Version:'Subscribe to receive an email when any <b>{entity_type}</b> is created in Projects I have access to.',email_some_Version:'Subscribe to receive an email when someone creates a new <b>{entity_type}</b> on any '+'Shot, Asset, etc. that I&#39;m working on (where I have an assigned Task)',email_version_link_cc:'Subscribe to receive an email when any <b>{entity_type}</b> is created on Shots, Assets or other '+'things I am Cc&#39;d (where my name is in the "Cc" field).'},init_component:function(){this.entity_type='HumanUser';this.ldap=(SG.globals.preferences.user_authentication_method==='ldap');this.data_set=this.new_data_set(this.entity_type,this.on_data_load,this.on_data_change);this.load_user_settings();},destroy_component:function(){Ext.EventManager.removeResizeListener(this.center_form,this);this.field_settings=undefined;this.revert_field_settings=undefined;this.mask.remove();if(this.__overlay_template_div__){this.__overlay_template_div__.remove();}},load_user_settings:function(){var cols=sg_deep_copy(SG.schema.entity_types.HumanUser.fields_sorted_by_display_name);var index=cols.indexOf('bookings');cols.splice(index,1);this.show_loading_overlay();var spec={type:'HumanUser',id:SG.globals.current_user.id,columns:cols,result:this.data_set};SG.Repo.find(spec);},show_loading_overlay:function(){var container=Ext.get(document.body);if(!this.__overlay_template_div__){var id='user_settings_progress_overlay';var overlay_html='<div class="progress_indicator_overlay_container user_settings_not_progress_indicator" id="'+
id+'">'+'<div class="progress_indicator_overlay user_settings_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(container,overlay_html,true);}
this.__overlay_template_div__.alignTo(container,'tl-tl');this.__overlay_template_div__.setWidth(container.getWidth());this.__overlay_template_div__.setHeight(container.getHeight()-1);Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__){this.__overlay_template_div__.hide();}},on_data_load:function(){this.hide_loading_overlay();this.dh=Ext.DomHelper;this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=this.dh.append(this.mask,{tag:'div',cls:'sg_dialog sg_user_settings_dialog'},true);this.title=this.dh.append(this.container,{tag:'div',cls:'form_title'},true);this.header=this.dh.append(this.container,{tag:'div',cls:'form_header'},true);this.body=this.dh.append(this.container,{tag:'div',cls:'form_body'},true);this.body_table=this.dh.append(this.body,{tag:'table',children:[{tag:'tr',children:[{tag:'td',cls:'user_image'},{tag:'td',cls:'user_fields'}]}]},true);var tmp=Ext.DomQuery.selectNode('td.user_image',this.body_table.dom);this.body_image=this.dh.append(tmp,{tag:'div',cls:'image'},true);this.dh.append(tmp,this.templates.image_text.apply(),true);tmp=Ext.DomQuery.selectNode('td.user_fields',this.body_table.dom);this.body_fields=this.dh.append(tmp,{tag:'div',cls:'fields'},true);this.body_notifications=this.dh.append(this.body,{tag:'div',style:'padding: 14px;'},true);this.dh.append(this.body_notifications,{tag:'div',style:'border-bottom: 1px dashed #000;'},true);this.body_notifications_fields=this.dh.append(this.body_notifications,{tag:'div',cls:'user_notifications'},true);this.footer=this.dh.append(this.container,{tag:'div',cls:'form_footer'},true);this.container.setWidth(700);this.container.setHeight(200);this.render_title();this.render_header();this.render_footer();this.center_form();this.add_event(this.layout_menu_icon,'click',this.on_layout_menu_click);this.add_event(this.header,'click',this.on_header_click);this.add_event(this.footer,'click',this.on_footer_click);this.add_event(this.body_image,'contextmenu',this.on_image_click);this.add_event(this.container,'click',this.on_container_click);Ext.EventManager.onWindowResize(this.center_form,this,true);this.init_fields();},init_fields:function(){this.entity_field_pref='user_settings';var user_settings_fields=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];var db_field_settings=[];if(user_settings_fields&&user_settings_fields.settings.length>0){db_field_settings=user_settings_fields.settings;}
var schema=SG.schema.entity_fields[this.entity_type];this.field_settings=db_field_settings.filter(function(field_hash){return schema[field_hash.field];});this.revert_field_settings=sg_deep_copy(this.field_settings);this.layout_changed=false;var cell_config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:this.data_set.get_record(0).get('projects'),in_form:true,get_fields_callback:{fn:this.get_fields,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.render_body();},get_fields:function(){var kbd_order=this.field_settings.map(function(fs){return fs.field;});var i=kbd_order.indexOf('password_proxy');if(i!==-1){kbd_order.splice(i+1,0,'password_proxy_confirm');}
return kbd_order;},on_data_change:function(changes){this.render_notifications_warning();var updated=[],errors=[];var schema=SG.schema.entity_fields[this.entity_type];var change;for(var i=0;i<changes.length;++i){change=changes[i];if(change.column!='image'&&change.type==='update'&&change.state==='server'){var error=change.record.get_error(change.column);if(error===null){updated.push(schema[change.column]['display_name']);}else{errors.push(schema[change.column]['display_name']+': '+error.description);}}}
if(errors.length>0){this.hide_loading_overlay();var msg='';if(updated.length>0){msg+='Updated fields:\n';msg+=updated.join('\n')+'\n\n';}
msg+='Error updating fields:\n';msg+=errors.join('\n');alert(msg);}else if(updated.length>0){this.hide_loading_overlay();this.destroy();}},render_title:function(){var user_record=this.data_set.get_record(0);this.title.update(this.templates.title.apply({name:user_record.get('name')}));this.layout_menu_icon=this.dh.append(this.title,this.templates.layout_menu_clean.apply(),true).child('img');},render_header:function(){if(SG.schema.can_edit_field('EntityFieldPref','settings')){this.header.update(this.templates.header.apply());}},render_footer:function(){this.footer.update(this.templates.footer.apply());},render_body:function(){var fields_to_skip=['password_proxy','password_proxy_confirm'];var ldap_fields=['firstname','lastname','name','email'];var body='';if(this.ldap){body=this.templates.ldap_warning.apply();}
var schema=SG.schema.entity_fields[this.entity_type];var field_hash,mandatory,field_label,sg_tip;var cell,cell_type,cell_hash,read_only_cell;var user_record=this.data_set.get_record(0);for(var i=0;i<this.field_settings.length;++i){field_hash=this.field_settings[i];if(fields_to_skip.indexOf(field_hash.field)!=-1)continue;if(field_hash.mandatory){sg_tip='Required';mandatory='mandatory';}else{sg_tip='';mandatory='';}
field_label='';if(field_hash.show_label){field_label=(field_hash.field_label_override||schema[field_hash.field]['display_name'])+':';}
read_only_cell=!SG.schema.can_edit_field_on_record(user_record,SG.schema.get_field(this.entity_type,field_hash.field))||(this.ldap&&(ldap_fields.indexOf(field_hash.field)!==-1));cell_type=this.get_cell_type(field_hash);cell=this.cell_manager.get_cell(field_hash.field,{type:cell_type,read_only:read_only_cell});cell_hash=cell.render(user_record);cell_hash.field=field_hash.field;cell_hash.mandatory=mandatory;cell_hash.field_label=field_label;cell_hash.sg_tip=sg_tip;if(read_only_cell){cell_hash.field_classes='field_read_only';}
body+=this.templates.field.apply(cell_hash);}
if(this.field_settings.length==0){body=this.templates.empty.apply();}
body+=this.templates.password_button.apply({disabled:this.ldap?'disabled="true"':''});this.body_fields.update(body);cell=this.cell_manager.get_cell('image');cell_hash=cell.render(user_record);this.body_image.update(this.templates.image_field.apply(cell_hash));var email_options=[];var email_types=['Note','Ticket','Delivery','Task','Version','CustomThreadedEntity01','CustomThreadedEntity02','CustomThreadedEntity03','CustomThreadedEntity04','CustomThreadedEntity05'];for(var i=0;i<email_types.length;i++)
{var type=email_types[i];var type_schema=SG.schema.entity_types[type];if(!type_schema||!type_schema.enabled)
continue;var all_template=this.templates['email_all_'+type]||this.templates['email_all'];var some_template=this.templates['email_some_'+type]||this.templates['email_some'];var opts={entity_type_plural:type_schema.display_name_pluralized,entity_type:type_schema.display_name};var field_name_ending=type_schema.name_pluralized_underscored;email_options.push(['email_all_'+field_name_ending,all_template.apply(opts)]);email_options.push(['email_'+field_name_ending,some_template.apply(opts)]);if(type=='Version')
{email_options.push(['email_version_link_cc',this.templates.email_version_link_cc.apply(opts)]);}}
var table_contents='';for(var i=0;i<email_options.length;++i){var field=email_options[i][0];var schema_field=SG.schema.get_field('HumanUser',field);if(!schema_field)continue;cell=this.cell_manager.get_cell(email_options[i][0]);cell_hash=cell.render(user_record);cell_hash.description=email_options[i][1];table_contents+=this.templates.email_field.apply(cell_hash);}
this.body_notifications_fields.update(this.templates.email_notifications.apply({table_contents:table_contents}));if(!user_record.is_dirty('password_proxy')){var tmp=Ext.DomQuery.selectNode('div.field[field="password_proxy"] div.fake_input',this.body_fields.dom);tmp=Ext.get(tmp);if(tmp)
tmp.update('');}
if(!user_record.is_dirty('password_proxy_confirm')){var tmp=Ext.DomQuery.selectNode('div.field[field="password_proxy_confirm"] div.fake_input',this.body_fields.dom);tmp=Ext.get(tmp);if(tmp)
tmp.update('');}
this.render_notifications_warning();this.center_form();},render_notifications_warning:function(){var warning=Ext.get(Ext.DomQuery.selectNode('span.email_empty',this.body_notifications_fields.dom));warning.setVisibilityMode(Ext.Element.DISPLAY);if(this.data_set.get_record(0).get('email')===''){warning.show();}else{warning.hide();}},get_cell_type:function(field_hash){var schema=SG.schema.entity_fields[this.entity_type];if(typeof(schema[field_hash.field].editor)==='string'||field_hash.field=='email'){return SG.FakeInputCell;}else if(field_hash.large_text_entry&&schema[field_hash.field]['data_type']=='text'){return SG.LargeTextAreaCell;}else if(schema[field_hash.field]['data_type']=='text'){return SG.TextAreaCell;}else if(schema[field_hash.field]['data_type']=='password'&&this.ldap){return SG.TextAreaCell;}else{return SG.FakeInputCell;}},on_layout_menu_click:function(event,target,options){if(!this.layout_menu){this.layout_menu=this.new_component(SG.Menu,{position:{dom_elem:this.layout_menu_icon,elem_anchor:'br',menu_anchor:'tr'},before_show:{fn:this.on_before_show_layout_menu,scope:this},});this.layout_menu.render();}
this.layout_menu.show();},on_before_show_layout_menu:function(){var items=[];var disabled;if(!SG.globals.current_user.admin){disabled=true;}else{if(this.layout_changed){disabled=false;}else{disabled=true;}}
items.push({html:'Revert Layout',disabled:disabled,item_selected:{fn:this.revert_layout,scope:this}});items.push({html:'Save Layout',disabled:disabled,item_selected:{fn:this.save_layout,scope:this}});this.layout_menu.items=items;this.layout_menu.render();},revert_layout:function(){this.layout_menu_icon.dom.setAttribute('src','/images/icon_page_settings.png');this.layout_changed=false;this.field_settings=[];for(var i=0;i<this.revert_field_settings.length;++i){this.field_settings.push(this.revert_field_settings[i]);}
this.render_body();},save_layout:function(){this.layout_menu_icon.dom.setAttribute('src','/images/icon_page_settings.png');this.layout_changed=false;this.revert_field_settings=[];for(var i=0;i<this.field_settings.length;++i){this.revert_field_settings.push(this.field_settings[i]);}
this.update_entity_field_prefs(this.field_settings);},on_header_click:function(event,target,options){var t=Ext.get(target);var gear_button=t.findParent('img.gear_menu',this.header,true);if(gear_button){if(!this.gear_menu){this.gear_menu=this.new_component(SG.Menu,{position:{dom_elem:gear_button,elem_anchor:'br',menu_anchor:'tr'},item_selected:{fn:this.configure,scope:this},items:[{html:'Configure layout...'}]});this.gear_menu.render();}
this.gear_menu.show();return;}},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true,disable_for_field_data_types:['password']},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:'',disable_for_field_data_types:['password']},{property_name:'mandatory',data_type:'boolean',display_name:'Required for creation',default_value:false,disable_for_field_data_types:['password']},{property_name:'large_text_entry',data_type:'boolean',display_name:'Use tall text box',default_value:false,restrict_to_field_data_types:['text']}],configure:function(menu,item){var fpd=new SG.FieldProperties.Dialog({entity_type:this.entity_type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:this.field_settings,only_ordinary_fields:true,field_disabled_callback:{fn:this.configure_fields_disabled,scope:this},read_only_fields:['password_proxy'],settings_applied_callback:{fn:this.on_fields_set,scope:this}});return;},configure_fields_disabled:function(field_schema){var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','password','system_task_type','list'];var unsupported_names=['name','email_all_notes','email_notes','email_all_tickets','email_tickets'];if(field_schema.read_only||field_schema.create_only||(supported_data_types.indexOf(field_schema.data_type)===-1)||(unsupported_names.indexOf(field_schema.name)!==-1)||(field_schema.name==='attachments'&&field_schema.data_type==='multi_entity')){return true;}
return false;},on_fields_set:function(field_settings){this.layout_menu_icon.dom.setAttribute('src','/images/icon_page_settings_dirty.png');this.layout_changed=true;this.field_settings=field_settings;this.render_body();},update_entity_field_prefs:function(field_settings){var new_entity_fields=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];if(new_entity_fields){var update_config={request_type:'update',type:'EntityFieldPref',id:new_entity_fields.id,column:'settings',value:Ext.encode(field_settings)};var update_request=new SG.CrudRequest(update_config,null);update_request.on('completed',function(){new_entity_fields.settings=field_settings;},this);update_request.send();}else{var create_config={request_type:'create',type:'EntityFieldPref',columns:['entity_type','settings'],field_values:[{column:'entity_type',value:this.entity_type},{column:'pref_type',value:this.entity_field_pref},{column:'settings',value:Ext.encode(field_settings)}]};var request=new SG.CrudRequest(create_config,null);request.on('completed',function(responses){var response=responses[0];if(response.status=='successful'){SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type]={};var field_prefs=SG.globals.entity_field_prefs[this.entity_field_pref][this.entity_type];field_prefs['id']=response.row[0];field_prefs['settings']=field_settings;}},this);request.send();}},on_container_click:function(e){var t=Ext.get(e.target);var change_password_button=t.findParent('input.change_password_button',this.container.dom);if(change_password_button){var dialog=new SG.ChangePasswordDialog({user_id:SG.globals.current_user.id,require_current_password:true,allow_cancel:true});}},on_footer_click:function(event,target,options){var t=Ext.get(target);var save_button=t.findParent('input[name="save"]',this.footer,true);if(save_button){if(this.body_fields.child('div.empty')){alert('Cannot update '+SG.schema.entity_types[this.entity_type]['display_name']+' without any fields.');return;}
var form=this;window.setTimeout(function(){form.update_user_settings();form.fireEvent('dialog_submitted',event);},1);return;}
var cancel=t.findParent('span.cancel',this.footer,true);if(cancel){this.fireEvent('dialog_cancelled',event);this.destroy();return;}},update_user_settings:function(){if(this.mandatory_inputs()){if(this.data_set.get_record(0).get_state()==='clean'){this.destroy();}else{this.show_loading_overlay();this.data_set.commit();}}},mandatory_inputs:function(){var missing_fields=[];var schema=SG.schema.entity_fields[this.entity_type];var field_hash;var user_record=this.data_set.get_record(0);for(var i=0;i<this.field_settings.length;++i){field_hash=this.field_settings[i];if(field_hash.mandatory){var value=user_record.get(field_hash.field);if(value===null||value===''){missing_fields.push("'"+(field_hash.field_label_override||schema[field_hash.field]['display_name'])+"'");}}}
if(missing_fields.length>0){alert('Please provide: '+missing_fields.join(', ')+'.');return false;}
return true;},on_image_click:function(event,target,options){event.stopEvent();if(!this.image_menu){this.image_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){the_menu.items=this.cell_manager.get_context_menu_items(the_menu.target_elem);the_menu.render();},scope:this},});}
this.image_menu.target_elem=Ext.get(event.target);this.image_menu.position={xy:event.getXY()};this.image_menu.show();},center_form:function(){var max_for_window=this.mask.getHeight()-100;var max_container=this.max_height_with_no_scroll();if(max_container<max_for_window){this.container.setHeight(max_container);}else{this.container.setHeight(max_for_window);}
this.container.setXY(this.container.getCenterXY(true));},max_height_with_no_scroll:function(){return(this.title.getHeight()+this.header.getHeight()+this.footer.getHeight()+
this.body_table.getHeight()+this.body_notifications.getHeight()+20);}});SG.Widget.Calendar=function(context,widget_spec,id)
{SG.Widget.Calendar.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Calendar,SG.Widget.EntityQueryMode,{default_settings:{date_fields:['*'],audit_date_fields:[],display_fields:[],day_aspect_ratio:0.8,display_project_dates:false,display_task_dates:true},templates:{main:'<table style="table-layout:fixed;"><tr>'+'<td style="width:{calendar_width}px;" class="calendar_side"><div class="drag_parent">'+'<div class="body"></div><div class="calendar_drag_div" style="left:{calendar_width}px;"></div></div></td>'+'<td class="config_side"><div class="config"></div></td></tr></table>',header_title:'<div class="header_title">'+'<img class="prev_month" src="/images/pageArrow_left_LG_default.png"/>'+'<img class="next_month" src="/images/pageArrow_rt_LG_default.png"/>'+'<span class="today_link">Today</span><span class="month">{title}'+'<img src="/images/dropdown_doubleArrow.png"></span>'+'<div class="config_link">Configure</div></div>',header_day:'<div class="header_day" style="left:{left}%;width:{width}%">{day}</div>',day:'<div style="position:absolute;left:{left}%;top:{top}%;width:{width}%;height:{height}px;" '+'class="day_square {today}"><div class="day_number event_slot {off_month} {today}">{day_number}'+'</div></div>',day_event:'<div style="position:absolute;left:{left}%;top:{top}px;width:{width}%;" '+'class="event_slot event {extra}"><span class="event_text" date="{edate}" >{text}<span></div>',event_entity:'<span class="event_entity" entity_type="{entity_type}" entity_id="{entity_id}" '+'entity_project_id="entity_project_id" date_field="{date_field}" '+'sg_tip="click to view event">{display}</span>',config_field_row_checked:'<div class="config_row"><img src="/images/checkbox_checked.png" class="field_check {type} checked" '+' field="{field}"/><span class="field_label">{field_display}</span></div>',config_field_row_unchecked:'<div class="config_row"><img src="/images/checkbox_cleared.png" class="field_check {type}"'+' field="{field}"/><span class="field_label">{field_display}</span></div>',config_save_cancel_buttons:'<input class="save" type="button" value="Save Changes" />'+'<span class="cancel">Cancel</a>',config_aspect:'<div class="config_aspect"><span class="aspect_label">Day Aspect Ratio</span>'+'<input type="text" value="{aspect}" class="aspect"/></div>',day_events_overlay_top:'<div style="position:absolute;left:{left}%;top:{top}px;width:{width}%;max-height:{max_height}px;" '+'class ="day_events_overlay {side}">'+'<div style="position:relative" class="day_overlay_header"><span class="date_header">{date_str}</span>'+'<img src="/images/close_overlay_x.png" class="day_x"/></div>{events}</div>',day_events_overlay_bottom:'<div style="position:absolute;left:{left}%;bottom:{bottom}px;width:{width}%;max-height:{max_height}px;" '+'class ="day_events_overlay {side}">'+'<div style="position:relative" class="day_overlay_header"><span class="date_header">{date_str}</span>'+'<img src="/images/close_overlay_x.png" class="day_x"/></div>{events}</div>',event_overlay:'<div style="position:absolute;{position};width:250px;" class="event_overlay {side}">'+'<div class="event_overlay_header"><img src="{icon}" class="entity_icon"/>'+'<span class="event_overlay_header_text">{header_text}</span>'+'<img src="/images/plus_overlay.png" class="event_plus"/>'+'<img src="/images/close_overlay_x.png" class="event_x"/></div>'+'<div class="{fields_class}" id="{fields_id}"></div></div>'},day_width_per:14.2587,task_display_fields:['entity','sg_status_list','task_assignees'],init_widget:function()
{this.entity_type=this.context.get('entity_type');this.month_menu_id=this.get_css_class_name()+'_'+this.get_widget_id()+'_month_menu';this.context_menu_id=this.get_css_class_name()+'_'+this.get_widget_id()+'_ctx_menu';},init_children:function()
{},on_first_render:function()
{var dh=Ext.DomHelper;this.container=this.get_container();this.container.update('');this.container.addClass('sg_scroll_container');this.config_div=dh.append(this.container,{tag:'div',cls:'configure'},true);this.config_div.setDisplayed(false);this.body_div=dh.append(this.container,{tag:'div',cls:'body'},true);this.body_div.update('');Ext.EventManager.onWindowResize(this.render_widget,this);this.entity_set=this.new_data_set(this.entity_type,this.on_data_load);this.project_set=this.new_data_set('Project',this.render_widget);this.task_set=this.new_data_set('Task',this.render_widget);this.add_event(this.body_div,"click",this.on_body_click);this.add_event(this.body_div,"contextmenu",this.on_contextmenu);this.add_event(this.config_div,"click",this.on_config_click);this.add_event(this,"context_changed",this.on_context_changed);this.body_width=this.body_div.getWidth();this.current_date=this.today();this.first_render=true;this.fetch_events();},on_data_load:function(){this.on_entities_loaded();this.render_widget();},get_entity_data_store:function()
{return this.entity_set;},get_action_menu_items:function()
{return[{html:'Configure ...',item_selected:{fn:this.configure,scope:this}}];},get_toolbar_items:function()
{return[];},reload_all_entities:function()
{this.fetch_events();},on_context_changed:function(key,value)
{if(key=="filters")
this.fetch_events();},on_contextmenu:function(e)
{e.stopEvent();var menu=SG.Menu.get_menu(this.context_menu_id);if(!menu)
{menu=this.new_component(SG.Menu,{id:this.context_menu_id,items:this.get_action_menu_items()});menu.render();}
menu.position={xy:e.getXY()};menu.show();},today:function()
{var now=Date.parseDate(new Date().format('Y m d'),'Y m d');return now;},render_widget:function()
{if(this.first_render)
{this.first_render=false;return;}
else
this.hide_loading_overlay();if(this.fields_widget)
{this.destroy_child(this.fields_widget);this.fields_widget=null;}
this.body_div.update('');this.calc_constants();this.render_header();this.render_days();this.render_events();if(this.config_div.isVisible())
this.render_configure();},calc_constants:function()
{this.body_width=this.body_div.getWidth();var first_day_of_month=Date.parseDate(this.current_date.format('Y m 1'),'Y m j');var last_day_of_month=Date.parseDate(this.current_date.format('Y m t'),'Y m j');this.first_day_of_calendar=first_day_of_month.add(Date.DAY,-1*first_day_of_month.format('w'));this.start_week=Number(first_day_of_month.format('W'));this.end_week=Number(last_day_of_month.format('W'));this.day_height=Math.round(Number(this.get('day_aspect_ratio'))*this.body_width/7.0);this.total_weeks=this.end_week-this.start_week+1;this.day_height_per=100.0/this.total_weeks;},days_from_start_of_calendar:function(d)
{var from_utc=this.first_day_of_calendar.getTime();var to_utc=d.getTime();var ret=((to_utc-from_utc)/86400000);return Math.round(ret);},render_header:function()
{var dh=Ext.DomHelper;var title=this.current_date.format('F Y');var h=this.templates.header_title.apply({title:title});var left=0.0;var days;if((this.body_width/7)>80)
days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];else if(this.body_width>250)
days=['Sun','Mon','Tues','Wed','Thurs','Fri','Sat'];else
days=['S','M','T','W','T','F','S'];h+='<div class="header_days">';for(var i=0;i<7;i++)
{h+=this.templates.header_day.apply({left:left,width:this.day_width_per,day:days[i]});left+=this.day_width_per;}
h+='</div>';dh.append(this.body_div,h);},render_days:function()
{var dh=Ext.DomHelper;var h='<div class="day_grid" style="width:100%;height:'+(this.day_height*this.total_weeks)+'px;">';var left=0.0;var top=0.0;var year=this.current_date.format('Y');var month=this.current_date.format('n');var i,j;var day_date=this.first_day_of_calendar;var off_month='';var today=this.today();var day_number='';var today_cls='';var height;for(i=this.start_week;i<=this.end_week;i++)
{for(j=0;j<7;j++)
{left=this.day_width_per*j;top=(i-this.start_week)*this.day_height_per;off_month=day_date.format('n')==month?'':'off_month';if(day_date.format('Y m d')==today.format('Y m d'))
{today_cls='today';if((this.body_width/7)>80)
day_number='Today '+day_date.format('j');else
day_number=day_date.format('j');height=this.day_height-1;}
else
{today_cls='';day_number=day_date.format('j');height=this.day_height-1;}
h+=this.templates.day.apply({left:left,top:top,width:this.day_width_per,height:height,day_number:day_number,off_month:off_month,today:today_cls});day_date=day_date.add(Date.DAY,1);}}
dh.append(this.body_div,h);},parse_date:function(entity_type,field,date_str)
{var schema=SG.schema.entity_fields[entity_type];if(date_str===null)
return null;else if(schema[field]['data_type']=='date')
return Date.parseDate(date_str,'Y-m-d');else
return Date.sgParseDateTime(date_str);},render_events:function()
{var h='';var events_per_day=Math.floor(this.day_height/16)-2;var day_event_map={};var i,j,r,e,e_date,ee;var date_fields,ds,entity_type,ident_field,display_fields;var det=this.templates.day_event;var first_day_of_calendar_utc=this.first_day_of_calendar.getTime();var last_day_of_calendar_utc=this.first_day_of_calendar.add(Date.DAY,(this.total_weeks*7)-1);last_day_of_calendar_utc=last_day_of_calendar_utc.getTime();if(this.get('display_project_dates'))
{date_fields=this.get_entity_date_columns('Project');ds=this.project_set;entity_type='Project';ident_field=SG.schema.get_identifier_field(entity_type);for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{e=r.get(date_fields[j]);if(e)
{e_date=this.parse_date(entity_type,date_fields[j],e);var e_date_utc=e_date.getTime();if(e_date_utc<first_day_of_calendar_utc||e_date_utc>last_day_of_calendar_utc)
continue;ee=e_date.format('Y-m-d');if(!day_event_map[ee])
day_event_map[ee]=1;else
day_event_map[ee]+=1;if(day_event_map[ee]<=events_per_day)
{var day_of_week=e_date.format('w');var days=this.days_from_start_of_calendar(e_date);var left=this.day_width_per*day_of_week;var extra='';if(day_of_week==6)
extra='saturday';extra+=' project_event';var week=Math.floor(days/7);var top=(week*this.day_height)+(16*day_event_map[ee]);var text=this.render_single_event(entity_type,ident_field,date_fields[j],r,[]);h+=det.apply({left:left,top:top,text:text,width:this.day_width_per,extra:extra,edate:ee});}}}}}
if(this.get('display_task_dates'))
{date_fields=this.get_entity_date_columns('Task');ds=this.task_set;entity_type='Task';ident_field=SG.schema.get_identifier_field(entity_type);for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{e=r.get(date_fields[j]);if(e)
{e_date=this.parse_date(entity_type,date_fields[j],e);var e_date_utc=e_date.getTime();if(e_date_utc<first_day_of_calendar_utc||e_date_utc>last_day_of_calendar_utc)
continue;ee=e_date.format('Y-m-d');if(!day_event_map[ee])
day_event_map[ee]=1;else
day_event_map[ee]+=1;if(day_event_map[ee]<=events_per_day)
{var day_of_week=e_date.format('w');var days=this.days_from_start_of_calendar(e_date);var left=this.day_width_per*day_of_week;var extra='';if(day_of_week==6)
extra='saturday';extra+=' task_event';var week=Math.floor(days/7);var top=(week*this.day_height)+(16*day_event_map[ee]);var text=this.render_single_event(entity_type,ident_field,date_fields[j],r,this.task_display_fields);h+=det.apply({left:left,top:top,text:text,width:this.day_width_per,extra:extra,edate:ee});}}}}}
date_fields=this.get_date_fields();display_fields=this.get('display_fields');ds=this.entity_set;entity_type=this.context.get('entity_type');ident_field=SG.schema.get_identifier_field(entity_type);for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{e=r.get(date_fields[j]);if(e)
{e_date=this.parse_date(entity_type,date_fields[j],e);var e_date_utc=e_date.getTime();if(e_date_utc<first_day_of_calendar_utc||e_date_utc>last_day_of_calendar_utc)
continue;ee=e_date.format('Y-m-d');if(!day_event_map[ee])
day_event_map[ee]=1;else
day_event_map[ee]+=1;if(day_event_map[ee]<=events_per_day)
{var day_of_week=e_date.format('w');var days=this.days_from_start_of_calendar(e_date);var left=this.day_width_per*day_of_week;var extra='';if(day_of_week==6)
extra='saturday';var week=Math.floor(days/7);var top=(week*this.day_height)+(16*day_event_map[ee]);var text=this.render_single_event(entity_type,ident_field,date_fields[j],r,display_fields);h+=det.apply({left:left,top:top,text:text,width:this.day_width_per,extra:extra,edate:ee});}}}}
for(e in day_event_map)
{if(day_event_map.hasOwnProperty(e))
{var count=day_event_map[e]-events_per_day;if(count>0)
{e_date=Date.parseDate(e,'Y-m-d');var days=this.days_from_start_of_calendar(e_date);var left=this.day_width_per*e_date.format('w');var week=Math.floor(days/7);var top=(week*this.day_height)+(16*(events_per_day+1));var text='';if(this.body_width<400)
text='..';else
text='+'+count+' more';h+=det.apply({left:left,top:top,text:text,width:this.day_width_per,extra:'more_events',edate:e});}}}
var day_grid_div=this.container.child('div.day_grid');Ext.DomHelper.append(day_grid_div,h);},render_single_event:function(entity_type,ident_field,date_field,record,display_fields)
{var schema_fields=SG.schema.entity_fields[entity_type];var h='<img src="'+SG.globals.icons.entities[entity_type]+'" />';var display=record.get(ident_field);if(ident_field=='this_file')
display=display.display_name;var template_parms={entity_type:entity_type,entity_id:record.get_id(),display:display,date_field:date_field};if(record.get('project'))
template_parms.entity_project_id=record.get('project').id;h+=this.templates.event_entity.apply(template_parms);h+=', '+schema_fields[date_field]['display_name'];for(var i=0;i<display_fields.length;i++)
{var field=display_fields[i];var schema_field=SG.schema.get_field(entity_type,field);if(!schema_field)continue;var render_type=SG.Renderers.renderer_defaults[schema_field.data_type];if(!render_type)
render_type='text';var renderer=SG.Renderers[render_type];h+=', '+renderer.render_nbsp(record.get(field),schema_field,record);}
return h;},get_date_fields:function()
{var af=this.get('audit_date_fields');var df=this.get('date_fields');if(df.length==1&&df[0]=='*')
return af.concat(this.get_entity_date_columns());else
return af.concat(df);},fetch_events:function()
{this.hide_event_detail_overlay();this.hide_day_events_overlay();var requests=[];var handlers=[];var nothing_requested=true;this.show_loading_overlay();this.calc_constants();var date_fields=this.get_date_fields();if(date_fields.length>0)
{var fields=date_fields.concat(this.get('display_fields'));var entity_type=this.context.get('entity_type');var identifier_field=SG.schema.get_identifier_field(entity_type);if(fields.indexOf(identifier_field)==-1)
fields.push(identifier_field);if(SG.schema.entity_types[entity_type].has_projects&&fields.indexOf('project')==-1)
fields.push('project');var primary_spec={type:entity_type,filters:this.construct_bounds_filters(date_fields,this.context.get('filters')),columns:fields,result:this.entity_set};var server_side=this.context.get('server_side_filters');if(server_side)primary_spec.server_side_filters=server_side;nothing_requested=false;SG.Repo.query(primary_spec);}
if(this.get('display_project_dates'))
{var proj_date_fields=this.get_entity_date_columns('Project');var proj_fields=proj_date_fields.concat(SG.schema.get_identifier_field('Project'));var pids=this.context_project_ids();var proj_filter;proj_filter={logical_operator:'and',conditions:[{active:'true',path:'id',relation:'in',values:pids}]};project_spec={type:'Project',filters:this.construct_bounds_filters(proj_date_fields,proj_filter),columns:proj_fields,result:this.project_set};nothing_requested=false;SG.Repo.query(project_spec);}
if(this.get('display_task_dates')&&this.context.get('entity_type')!='Task')
{var task_date_fields=this.get_entity_date_columns('Task');var task_fields=task_date_fields.concat(this.task_display_fields);var identifier_field=SG.schema.get_identifier_field('Task');if(task_fields.indexOf(identifier_field)==-1)
task_fields.push(identifier_field);if(task_fields.indexOf('project')==-1)
task_fields.push('project');var task_filters=sg_deep_copy(this.context.get('filters'));task_filters=sg_pivot_condition_hash(this.context.get('entity_type'),"entity",task_filters);if(task_filters.subquery){task_filters={'logical_operator':'and','conditions':[task_filters]}}
task_spec={type:'Task',filters:this.construct_bounds_filters(task_date_fields,task_filters),columns:task_fields,result:this.task_set};nothing_requested=false;SG.Repo.query(task_spec);}
if(nothing_requested)
{this.hide_loading_overlay();this.render_widget();}},get_entity_date_columns:function(entity_type)
{if(!entity_type)
entity_type=this.context.get('entity_type');var cols=[];var schema_fields=SG.schema.entity_fields[entity_type];var field;for(field in schema_fields)
{if(schema_fields.hasOwnProperty(field)){if((schema_fields[field]['data_type']=='date'||schema_fields[field]['data_type']=='date_time')&&(field!='updated_at'&&field!='created_at'))
cols.push(field);}}
return cols;},construct_bounds_filters:function(date_fields,filters)
{var new_filters=sg_deep_copy(filters);var low=this.first_day_of_calendar.add(Date.DAY,-1);var high=this.first_day_of_calendar.add(Date.DAY,(this.total_weeks*7));var l=low.format('Y-m-d');var h=high.format('Y-m-d');var conditions=[];for(var i=0;i<date_fields.length;i++)
{var date_conditions=[];var field=date_fields[i];date_conditions.push({active:'true',path:field,relation:'greater_than',values:[l]});date_conditions.push({active:'true',path:field,relation:'less_than',values:[h]});conditions.push({logical_operator:'and',conditions:date_conditions});}
new_filters.conditions.push({logical_operator:'or',conditions:conditions});this.substitute_filter_tokens(new_filters);return new_filters;},get_all_non_date_entity_columns:function()
{var cols=[];var entity_type=this.context.get('entity_type');var ident_field=SG.schema.get_identifier_field(entity_type);var schema_fields=SG.schema.entity_fields[entity_type];var schema_types=SG.schema.entity_types[entity_type];var all_fields=schema_types.fields_sorted_by_display_name;for(var i=0;i<all_fields.length;i++)
{var field=all_fields[i];if(schema_fields[field]['data_type']!='date'&&field!=ident_field)
cols.push(field);}
return cols;},configure:function()
{if(this.config_div.isVisible())
return;this.restore_date_fields=this.get_date_fields();this.restore_display_fields=this.get('display_fields');this.restore_day_aspect_ratio=this.get('day_aspect_ratio');this.restore_display_project_dates=this.get('display_project_dates');this.restore_display_task_dates=this.get('display_task_dates');this.render_configure();},render_configure:function()
{this.config_div.update('');this.config_div.setDisplayed(true);var cols=Math.floor(this.config_div.getWidth()/150);var date_fields=this.get_date_fields();var all_date_fields=this.get_entity_date_columns();var schema_fields=SG.schema.entity_fields[this.context.get('entity_type')];var has_audit_fields=schema_fields['created_at']&&schema_fields['updated_at'];var checked=this.templates.config_field_row_checked;var unchecked=this.templates.config_field_row_unchecked;var raw_date_field=this.get('date_fields');var wildcard_date_fields=(raw_date_field.length==1&&raw_date_field[0]=='*');var ch;if(wildcard_date_fields)
ch=checked.apply({field:'wildcard_date_fields',field_display:'Toggle All',type:'date_field'});else
ch=unchecked.apply({field:'wildcard_date_fields',field_display:'Toggle All',type:'date_field'});ch=ch.replace('div','span');var h='<div class="field_config_header">Date Fields '+ch+'</div>';var i,j;var rows=Math.ceil(all_date_fields.length/cols);if(rows<4)
{if(all_date_fields.length<4)
rows=all_date_fields.length;else
rows=4;}
h+='<table>';for(i=0;i<rows;i++)
{h+='<tr>';for(j=0;j<cols;j++)
{var index=(j*rows)+i;if(index<all_date_fields.length)
{var field=all_date_fields[index];h+='<td>';if(date_fields.indexOf(field)==-1)
{h+=unchecked.apply({field:field,field_display:schema_fields[field]['display_name'],type:'date_field'});}
else
{h+=checked.apply({field:field,field_display:schema_fields[field]['display_name'],type:'date_field'});}
h+='</td>';}
else
h+='<td>&nbsp</td>';}
h+='</tr>';}
h+='</table>';if(has_audit_fields)
{var audit_date_fields=this.get('audit_date_fields');h+='<div class="field_config_header">Audit Date Fields</div>';h+='<table><tr><td>';if(audit_date_fields.indexOf('created_at')!=-1)
h+=checked.apply({field:'created_at',field_display:schema_fields['created_at']['display_name'],type:'audit_date_field'});else
h+=unchecked.apply({field:'created_at',field_display:schema_fields['created_at']['display_name'],type:'audit_date_field'});h+='</td><td>';if(audit_date_fields.indexOf('updated_at')!=-1)
h+=checked.apply({field:'updated_at',field_display:schema_fields['updated_at']['display_name'],type:'audit_date_field'});else
h+=unchecked.apply({field:'updated_at',field_display:schema_fields['updated_at']['display_name'],type:'audit_date_field'});h+='</td>';for(j=2;j<cols;j++)
h+='<td>&nbsp</td>';h+='</table>';}
var display_fields=this.get('display_fields');var all_display_fields=this.get_all_non_date_entity_columns();h+='<div class="field_config_header">Event Display Info</div>';rows=Math.ceil(all_display_fields.length/cols);if(rows<4)
{if(all_display_fields.length<4)
rows=all_display_fields.length;else
rows=4;}
h+='<table>';for(i=0;i<rows;i++)
{h+='<tr>';for(j=0;j<cols;j++)
{var index=(j*rows)+i;if(index<all_display_fields.length)
{var field=all_display_fields[index];h+='<td>';if(display_fields.indexOf(field)==-1)
{h+=unchecked.apply({field:field,field_display:schema_fields[field]['display_name'],type:'display_field'});}
else
{h+=checked.apply({field:field,field_display:schema_fields[field]['display_name'],type:'display_field'});}
h+='</td>';}
else
h+='<td>&nbsp</td>';}
h+='</tr>';}
h+='</table>';h+='<div class="field_config_header">Other Display Settings</div>';if(this.get('display_project_dates'))
h+=checked.apply({field:'',field_display:'Display Project Dates',type:'display_project_dates'});else
h+=unchecked.apply({field:'',field_display:'Display Project Dates',type:'display_project_dates'});if(this.get('display_task_dates'))
h+=checked.apply({field:'',field_display:'Display Task Dates',type:'display_task_dates'});else
h+=unchecked.apply({field:'',field_display:'Display Task Dates',type:'display_task_dates'});h+=this.templates.config_aspect.apply({aspect:this.get('day_aspect_ratio')});Ext.DomHelper.append(this.config_div,h);Ext.DomHelper.append(this.config_div,{tag:'div',cls:'buttons',html:this.templates.config_save_cancel_buttons.apply()});var cw=this;var aspect_input=this.config_div.child('div.config_aspect>input.aspect');this.add_event(aspect_input,'keyup',function(e){if(e.getCharCode()==13)
{var last_aspect=cw.get('day_aspect_ratio');var aspect=Number(aspect_input.dom.value);if(aspect<=0.2||aspect>5)
aspect=last_aspect;cw.set('day_aspect_ratio',aspect);aspect_input.dom.value=aspect;cw.render_widget();}});},on_body_click:function(e)
{var t=Ext.get(e.getTarget());var next_month=t.findParent('img.next_month',this.body_div,true);if(next_month)
{var month=this.current_date.format('n');var year=this.current_date.format('Y');if(month==12)
{month=1;year+=1;}
else
month+=1;this.current_date=Date.parseDate(year+' '+month+' 1','Y n j');this.fetch_events();return;}
var prev_month=t.findParent('img.prev_month',this.body_div,true);if(prev_month)
{var month=this.current_date.format('n');var year=this.current_date.format('Y');if(month==1)
{month=12;year-=1;}
else
month-=1;this.current_date=Date.parseDate(year+' '+month+' 1','Y n j');this.fetch_events();return;}
var today_link=t.findParent('span.today_link',this.body_div,true);if(today_link)
{this.current_date=this.today();this.fetch_events();return;}
var config_link=t.findParent('div.config_link',this.body_div,true);if(config_link)
{this.configure();return;}
var month_span=t.findParent('span.month',this.body_div,true);if(month_span)
{var month_menu=this.get_month_menu();month_menu.position={xy:e.getXY()};month_menu.show();return;}
var more_event_div=t.findParent('div.more_events',this.body_div,true);if(more_event_div)
{var text_span=more_event_div.child('span.event_text');this.display_day_events_overlay(text_span.dom.getAttribute('date'));return;}
var day_overlay_x=t.findParent('img.day_x',this.body_div,true);if(day_overlay_x)
{this.hide_event_detail_overlay();var overlay=day_overlay_x.findParent('div.day_events_overlay',this.body_div,true);overlay.remove();return;}
var event_x=t.findParent('img.event_x',this.body_div,true);if(event_x)
{this.hide_event_detail_overlay();return;}
var event_plus=t.findParent('img.event_plus',this.body_div,true);if(event_plus)
{var overlay_header=t.findParent('div.event_overlay_header',this.body_div,true);var detail_href=overlay_header.child('a.sg_detail_link');e.target=detail_href.dom;var page=this.get_page();page.on_bubbled_click(e);return;}
var day_event=t.findParent('div.event',this.body_div,true);if(day_event)
{this.display_event_detail_overlay(day_event);return;}
var event_overlay=t.findParent('div.event_overlay');var events_overlay=t.findParent('div.day_events_overlay');if(event_overlay||events_overlay)
return;else
{this.hide_event_detail_overlay();this.hide_day_events_overlay();}},on_config_click:function(e)
{var t=Ext.get(e.getTarget());var field_check=t.findParent('img.date_field',this.config_div,true);if(field_check)
{var date_fields=this.get('date_fields');if(date_fields.length==1&&date_fields[0]=='*')
date_fields=this.get_entity_date_columns();if(field_check.hasClass('checked'))
{field_check.removeClass('checked');field_check.dom.src="/images/checkbox_cleared.png";var field=field_check.dom.getAttribute('field');if(field=='wildcard_date_fields')
this.set('date_fields',[]);else
{var new_date_fields=[];for(var i=0;i<date_fields.length;i++)
{if(field!=date_fields[i])
new_date_fields.push(date_fields[i]);}
this.set('date_fields',new_date_fields);}
this.render_widget();return;}
else
{field_check.addClass('checked');field_check.dom.src="/images/checkbox_checked.png";var field=field_check.dom.getAttribute('field');if(field=='wildcard_date_fields')
this.set('date_fields',['*']);else
{var new_date_fields=date_fields.concat(field);this.set('date_fields',new_date_fields);}
this.fetch_events();return;}}
field_check=t.findParent('img.audit_date_field',this.config_div,true);if(field_check)
{var audit_date_fields=this.get('audit_date_fields');if(field_check.hasClass('checked'))
{field_check.removeClass('checked');field_check.dom.src="/images/checkbox_cleared.png";var field=field_check.dom.getAttribute('field');var new_date_fields=[];for(var i=0;i<audit_date_fields.length;i++)
{if(field!=audit_date_fields[i])
new_date_fields.push(audit_date_fields[i]);}
this.set('audit_date_fields',new_date_fields);this.render_widget();return;}
else
{field_check.addClass('checked');field_check.dom.src="/images/checkbox_checked.png";var field=field_check.dom.getAttribute('field');var new_date_fields=audit_date_fields.concat(field);this.set('audit_date_fields',new_date_fields);this.fetch_events();return;}}
field_check=t.findParent('img.display_field',this.config_div,true);if(field_check)
{var display_fields=this.get('display_fields');if(field_check.hasClass('checked'))
{field_check.removeClass('checked');field_check.dom.src="/images/checkbox_cleared.png";var field=field_check.dom.getAttribute('field');var new_display_fields=[];for(var i=0;i<display_fields.length;i++)
{if(field!=display_fields[i])
new_display_fields.push(display_fields[i]);}
this.set('display_fields',new_display_fields);this.render_widget();return;}
else
{field_check.addClass('checked');field_check.dom.src="/images/checkbox_checked.png";var new_display_fields=display_fields.concat(field_check.dom.getAttribute('field'));this.set('display_fields',new_display_fields);this.fetch_events();return;}}
var project_dates_check=t.findParent('img.display_project_dates',this.config_div,true);if(project_dates_check)
{if(project_dates_check.hasClass('checked'))
{project_dates_check.removeClass('checked');project_dates_check.dom.src="/images/checkbox_cleared.png";this.set('display_project_dates',false);this.render_widget();return;}
else
{project_dates_check.addClass('checked');project_dates_check.dom.src="/images/checkbox_checked.png";this.set('display_project_dates',true);this.fetch_events();return;}}
var task_dates_check=t.findParent('img.display_task_dates',this.config_div,true);if(task_dates_check)
{if(task_dates_check.hasClass('checked'))
{task_dates_check.removeClass('checked');task_dates_check.dom.src="/images/checkbox_cleared.png";this.set('display_task_dates',false);this.render_widget();return;}
else
{task_dates_check.addClass('checked');task_dates_check.dom.src="/images/checkbox_checked.png";this.set('display_task_dates',true);this.fetch_events();return;}}
var save_button=t.findParent('input.save',this.config_div,true);if(save_button)
{var aspect_input=this.config_div.child('div.config_aspect>input.aspect');if(Number(aspect_input.dom.value)!=Number(this.get('day_aspect_ratio')))
{var last_aspect=this.get('day_aspect_ratio');var aspect=Number(aspect_input.dom.value);if(aspect<=0.2||aspect>5)
aspect=last_aspect;this.set('day_aspect_ratio',aspect);this.config_div.setDisplayed(false);this.render_widget();}
else
this.config_div.setDisplayed(false);return;}
var cancel_text=t.findParent('span.cancel',this.config_div,true);if(cancel_text)
{this.set({date_fields:this.restore_date_fields,display_fields:this.restore_display_fields,day_aspect_ratio:this.restore_day_aspect_ratio,display_project_dates:this.restore_display_project_dates,display_task_dayes:this.restore_display_task_dates});this.config_div.setDisplayed(false);this.fetch_events();return;}},get_month_menu:function()
{var menu=SG.Menu.get_menu(this.month_menu_id);if(menu)
menu.items=[];else
menu=this.new_component(SG.Menu,{id:this.month_menu_id});for(var i=-12;i<13;i++)
{if(i==0||i==1)
menu.items.push({line:true});var menu_date=this.current_date.add(Date.MONTH,i);menu.items.push({html:menu_date.format('F Y'),checked:(i==0),date_str:menu_date.format('Y m 1'),item_selected:{fn:this.on_month_menu_select,scope:this}});}
menu.render();return menu;},on_month_menu_select:function(menu,menu_item,item_dom)
{this.current_date=Date.parseDate(menu_item.date_str,'Y m j');this.fetch_events();},hide_day_events_overlay:function()
{var overlay=this.body_div.child('div.day_events_overlay');if(overlay)
overlay.remove();},hide_event_detail_overlay:function()
{if(this.fields_widget)
{this.destroy_child(this.fields_widget);this.fields_widget=null;var event_overlay=this.body_div.child('div.event_overlay');event_overlay.remove();var selected_day_event=this.body_div.child('div.event.selected');selected_day_event.removeClass('selected');}},display_event_detail_overlay:function(event_div)
{this.hide_event_detail_overlay();event_div.addClass('selected');var event_entity=event_div.child('span.event_entity');var event_text=event_div.child('span.event_text');if(!event_text)
event_text=event_div;else
this.hide_day_events_overlay();var e_date=Date.parseDate(event_text.dom.getAttribute('date'),'Y-m-d');var entity_type=event_entity.dom.getAttribute('entity_type');var entity_id=event_entity.dom.getAttribute('entity_id');var project_id=event_entity.dom.getAttribute('entity_project_id');var date_field=event_entity.dom.getAttribute('date_field');var entity={type:entity_type,id:entity_id};var ident_field=SG.schema.get_identifier_field(entity_type);var record;var ds;if(entity_type=='Project')
{if(this.entity_type=='Project')
{record=this.entity_set.get_record_by_id(entity_id);ds=this.entity_set;}
if(!record)
{record=this.project_set.get_record_by_id(entity_id);ds=this.project_set;}}
else if(entity_type=='Task')
{if(this.entity_type=='Task')
{record=this.entity_set.get_record_by_id(entity_id);ds=this.entity_set;}
if(!record)
{record=this.task_set.get_record_by_id(entity_id);ds=this.task_set;}}
else
{record=this.entity_set.get_record_by_id(entity_id);ds=this.entity_set;}
var fields_context=this.context.clone();fields_context.set('entity',entity);var child_name='event_info';if(event_div.hasClass('project_event'))
child_name='proj_event_info';else if(event_div.hasClass('task_event'))
child_name='task_event_info';this.fields_widget=this.construct_child(child_name,fields_context);var day_of_week=e_date.format('w');var days=this.days_from_start_of_calendar(e_date);var week=Math.floor(days/7);var position='';var side='';if(day_of_week<4)
{var left_per=(this.day_width_per*(day_of_week+1));if(event_div.findParent('div.day_events_overlay',this.body_div))
left_per+=(this.day_width_per*.5);position='left:'+left_per+'%;';side='right';}
else
{var right_per=(this.day_width_per*(7-day_of_week));if(day_of_week==6&&event_div.findParent('div.day_events_overlay',this.body_div))
right_per+=(this.day_width_per*.5);position='right:'+right_per+'%;';side='left';}
if(week<3)
position+='top:'+(week*this.day_height_per)+'%;';else
position+='bottom:'+((this.total_weeks-week-1)*this.day_height_per)+'%;';var icon=SG.globals.icons.entities[entity_type];var header_text='';if(ident_field=='this_file')
{header_text=SG.Renderers.url_no_icon.render_nbsp(record.get(ident_field));}
else if(SG.schema.entity_types[entity_type]["has_detail_page"])
{header_text=SG.Renderers.render_one_detail_link({type:entity_type,id:entity_id,name:record.get(ident_field)});}
else
header_text=record.get(ident_field);if(entity_type=='Task')
{var schema_field=SG.schema.get_field(entity_type,'entity');var render_type=SG.Renderers.renderer_defaults[schema_field.data_type];if(!render_type)
render_type='text';var renderer=SG.Renderers[render_type];header_text+=', '+renderer.render_nbsp(record.get('entity'),schema_field,record);}
header_text+=', '+SG.schema.entity_fields[entity_type][date_field]['display_name'];var h=this.templates.event_overlay.apply({position:position,icon:icon,header_text:header_text,fields_class:this.fields_widget.get_css_class_name(),fields_id:this.fields_widget.get_container_id(),side:side});var day_grid_div=this.container.child('div.day_grid');Ext.DomHelper.append(day_grid_div,h);this.fields_widget.render();return;},display_day_events_overlay:function(date_str)
{this.hide_event_detail_overlay();this.hide_day_events_overlay();var ds;var date_fields;var entity_type;var ident_field;var display_fields;var i,j,r;var h='';if(this.get('display_project_dates'))
{ds=this.project_set;date_fields=this.get_entity_date_columns('Project');entity_type='Project';ident_field=SG.schema.get_identifier_field(entity_type);for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{var as_date=this.parse_date(entity_type,date_fields[j],r.get(date_fields[j]));if(as_date&&as_date.format('Y-m-d')==date_str)
{var text=this.render_single_event(entity_type,ident_field,date_fields[j],r,[]);h+='<div class="event_slot event project_event" date="'+date_str+'">'+text+'</div>';}}}}
if(this.get('display_task_dates'))
{ds=this.task_set;date_fields=this.get_entity_date_columns('Task');entity_type='Task';ident_field=SG.schema.get_identifier_field(entity_type);for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{var as_date=this.parse_date(entity_type,date_fields[j],r.get(date_fields[j]));if(as_date&&as_date.format('Y-m-d')==date_str)
{var text=this.render_single_event(entity_type,ident_field,date_fields[j],r,this.task_display_fields);h+='<div class="event_slot event task_event" date="'+date_str+'">'+text+'</div>';}}}}
var day_records=[];ds=this.entity_set;date_fields=this.get_date_fields();entity_type=this.context.get('entity_type');for(i=0;i<ds.count();i++)
{r=ds.get_record(i);for(j=0;j<date_fields.length;j++)
{var as_date=this.parse_date(entity_type,date_fields[j],r.get(date_fields[j]));if(as_date&&as_date.format('Y-m-d')==date_str)
day_records.push({record:r,date_field:date_fields[j]});}}
entity_type=this.context.get('entity_type');ident_field=SG.schema.get_identifier_field(entity_type);display_fields=this.get('display_fields');for(i=0;i<day_records.length;i++)
{var a_day_rec=day_records[i];var text=this.render_single_event(entity_type,ident_field,a_day_rec.date_field,a_day_rec.record,display_fields);h+='<div class="event_slot event" date="'+date_str+'">'+text+'</div>';}
var e_date=Date.parseDate(date_str,'Y-m-d');var day_of_week=e_date.format('w');var days=this.days_from_start_of_calendar(e_date);var week=Math.floor(days/7);var day_grid_div=this.container.child('div.day_grid');var left;var side='';if(day_of_week!=6)
{left=this.day_width_per*day_of_week;side='right';}
else
{left=this.day_width_per*day_of_week-(this.day_width_per*.5);side='left';}
var date_str;var day_width=this.body_width/7;if(day_width>70)
date_str=e_date.format('M j ( D )');else if(day_width>40)
date_str=e_date.format('M j');else
date_str=e_date.format('j');var width_per=this.day_width_per+(0.5*this.day_width_per);var max_height=this.container.getHeight()/2;var html='';if(week<4)
{var top=(week*this.day_height);html=this.templates.day_events_overlay_top.apply({left:left,top:top,width:width_per,events:h,date_str:date_str,side:side,max_height:max_height});}
else
{var bottom=day_grid_div.getHeight()-((week+1)*this.day_height);html=this.templates.day_events_overlay_bottom.apply({left:left,bottom:bottom,width:width_per,events:h,date_str:date_str,side:side,max_height:max_height});}
var day_grid_div=this.container.child('div.day_grid');Ext.DomHelper.append(day_grid_div,html);},destroy_widget:function()
{Ext.EventManager.removeResizeListener(this.render_widget,this);}});SG.Widget.Iframe=function(context,widget_spec,id)
{SG.Widget.Iframe.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Iframe,SG.Widget.Base,{default_settings:{show_toolbar:true,url:'',},templates:{widget:'{header}<div class="iframe_wrapper {extra_class}">'+'<iframe src="{url}" width="100%" height="100%"></iframe></div>',url_header:'<div class="url_config">'+'<table><tr><td class="label"><div>URL:</div></td>'+'<td class="input"><input type="text" value="{url}" class="url"></td>'+'<td class="preview"><input type="button" value="Preview" class="preview"></td></tr></table></div>',},canvas_require_height:true,on_first_render:function()
{var dh=Ext.DomHelper;this.container=this.get_container();this.entity_type=this.context.get('entity').type;var header='';var extra_class='';if(this.should_show_url_header()){header=this.templates.url_header.apply({url:this.get('url')});extra_class='edit_header';this.add_event(this.container,'click',this.on_click);}
var html=this.templates.widget.apply({url:'',header:header,extra_class:extra_class});this.container.update(html);this.iframe=this.container.child('iframe');if(header!=''){var url_input=this.container.child('input.url');this.add_event(url_input,'blur',this.on_blur);this.add_event(url_input,'change',this.on_blur);}
this.data_set=this.new_data_set(this.entity_type,this.on_data_load);var url=this.get('url');this.url=this.replace_current_user_fields(url);this.fetch_fields();},render_widget:function()
{this.hide_loading_overlay();var field_regex=/\{[\w\.]+\}/g;if(!this.url.match(field_regex))
this.iframe.dom.setAttribute('src',encodeURI(this.url));},on_data_load:function()
{var url=this.get('url');var fields=this.get_fields_from_url(url);var replaced_url=url;var r=this.data_set.get_record(0);for(var i=0;i<fields.length;i++)
{var to_replace='{'+fields[i]+'}';var replace_with=this.get_replacement_string(fields[i],r.get(fields[i]));replaced_url=replaced_url.replace(to_replace,replace_with);}
this.url=this.replace_current_user_fields(replaced_url);this.render_widget();},get_replacement_string:function(field,field_value)
{var schema_fields;if(SG.schema.is_bubbled_field(this.entity_type,field))
{var fi=SG.schema.parse_field_name(this.entity_type,field);schema_fields=SG.schema.entity_fields[fi.bubble_source_entity_type][fi.bubbled_up_field];}
else
schema_fields=SG.schema.entity_fields[this.entity_type][field];if(schema_fields.data_type=='entity'){return field_value?field_value.name:'';}else if(schema_fields.data_type=='multi_entity'){var s='';for(var i=0;i<field_value.length;i++)
{if(i!=0)
s+=',';s+=field_value[i].name;}
return s;}else if(schema_fields.data_type=='url'){return field_value?field_value.url:'';}else{return field_value;}},replace_current_user_fields:function(url)
{if(url[0]=='/'){url=window.location.protocol+'//'+window.location.host+url;}
var s1=url.replace('{current_user.login}',SG.globals.current_user.login);var s2=s1.replace('{current_user.id}',SG.globals.current_user.id);var s3=s2.replace('{current_user.fullname}',SG.globals.current_user.display_name);if(s3.indexOf('://')==-1&&s3.length>0)
s3=window.location.protocol+'//'+s3;return s3;},on_save_config:function(url)
{var check=this.check_fields_in_url(url);if(check!='')
{var message='Unknown field: {'+check+'} in the url.';if(confirm(message))
{var me=this;setTimeout(function(){me.show_configure_url_dialog(null,{url:url});},1);return;}
this.set('url','');this.fetch_fields();return;}
this.set('url',url);this.fetch_fields();},check_fields_in_url:function(url)
{var fields=this.get_fields_from_url(url);for(var i=0;i<fields.length;i++)
{var field=fields[i];if(['current_user.login','current_user.fullname','current_user.id'].indexOf(field)!=-1)
continue;var schema_field=SG.schema.get_field(this.entity_type,field);if(!schema_field)return field;}
return'';},get_fields_from_url:function(url)
{var field_regex=/\{[\w\.]+\}/g;var fields_with_brackets=url.match(field_regex);var fields=[];if(!fields_with_brackets)
return fields;for(var i=0;i<fields_with_brackets.length;i++)
{var field=fields_with_brackets[i];var clean=field.substr(1,field.length-2);if(!(clean=='current_user.login'||clean=='current_user.fullname'||clean=='current_user.id'))
fields.push(clean);}
return fields;},fetch_fields:function()
{this.show_loading_overlay();var entity=this.context.get('entity');var fields=this.get_fields_from_url(this.get('url'));if(fields.length==0)
{this.url=this.replace_current_user_fields(this.get('url'));this.render_widget();return;}
var spec={type:entity.type,id:entity.id,columns:fields,result:this.data_set};SG.Repo.find(spec);},on_click:function(e){var t=Ext.get(e.getTarget());var preview_button=t.findParent('input.preview',this.container);if(preview_button){var url_input=this.container.child('input.url');var check=this.check_fields_in_url(url_input.dom.value);if(check!=''){var message='Unknown field: {'+check+'} in the url. Please fix and retry';alert(message);return;}
var url=url_input.dom.value;this.set_url(url);}},on_blur:function(e){var url_input=this.container.child('input.url');var url=url_input.dom.value;this.set_url(url);},set_url:function(url){this.set('url',url);this.url=this.replace_current_user_fields(url);this.fetch_fields();},should_show_url_header:function(){if(this.context.get('design_mode')){var parent_widget=this.get_parent();var parent_type=parent_widget.get('type');return['SG.Widget.Canvas.Page','SG.Widget.Tabs'].indexOf(parent_type)!=-1;}else if(this.context.get('edit_mode')){var parent_widget=this.get_parent();return(parent_widget.get('type')=='SG.Widget.Canvas.Wrapper');}
else
return false;},});function shotgun_spec_editor()
{var ed=new SG.Widget.SpecEditor();ed.render();}
SG.Widget.SpecEditor=function()
{this.init();};SG.Widget.SpecEditor.update_spec_property=function(spec_id,property_path,value)
{this.get_spec(spec_id).set_setting(null,property_path,value);};SG.Widget.SpecEditor.get_spec=function(spec_id)
{var spec=SG.globals.page.spec;var path=spec_id.split(".");for(var i=1;i<path.length;i++)
spec=spec.child_specs[path[i]];return spec;};SG.Widget.SpecEditor.prototype={templates:{page:'<div class="spec_editor"><div class="spec_editor_scroll">{spec}</div></div>',spec:'<div class="spec_editor_spec_name" onclick="Ext.get(this.nextSibling).toggle();">{spec_name}</div>'+'<div class="spec_editor_spec">{properties}</div>',property:'<span class="spec_editor_prop_name">{property_path}</span>: '+'<input spec_id="{spec_id}" property="{property_path}" type="text" value="{value}" '+'onchange="{on_change}" />',object_property:'<div class="spec_editor_object_name" onclick="Ext.get(this.nextSibling).toggle();">'+'{object_name}</div><div class="spec_editor_object">{properties}</div>'},on_change_attribute:"SG.Widget.SpecEditor.update_spec_property( "+"this.getAttribute('spec_id'), this.getAttribute('property'), this.value )",init:function()
{var template_string;for(var template_name in this.templates)
{if(!this.templates.hasOwnProperty(template_name))
continue;if((typeof this.templates[template_name])=="string")
{template_string=this.templates[template_name]
this.templates[template_name]=new Ext.Template(template_string);}}},render:function()
{var editor_ext_elem=this.templates.page.append(document.body,{spec:this.render_spec("page",SG.globals.page.spec)},true);},render_spec:function(spec_id,spec)
{var html_arr=[];for(var setting in spec.settings)
{if(!spec.settings.hasOwnProperty(setting))
continue;if(['string','number'].indexOf(typeof spec.settings[setting])==0)
html_arr.push(this.render_property(spec_id,spec,setting));else
html_arr.push(this.render_object_property(spec_id,spec,setting));}
var child_name;for(child_name in spec.child_specs)
{if(!spec.child_specs.hasOwnProperty(child_name))
continue;var child_spec=spec.child_specs[child_name];var child_spec_id=spec_id+"."+child_name;html_arr.push(this.render_spec(child_spec_id,child_spec));}
return this.templates.spec.apply({spec_name:spec.type,properties:html_arr.join('')});},render_property:function(spec_id,spec,path)
{return this.templates.property.apply({spec_id:spec_id,property_path:path,value:spec.get_setting(path),on_change:this.on_change_attribute});},render_object_property:function(spec_id,spec,path)
{var prop=spec.get_setting(path);var child_props=[];for(var child_prop in prop)
{if(!prop.hasOwnProperty(child_prop))
continue;if(['string','number'].indexOf(typeof prop[child_prop])==0)
child_props.push(this.render_property(spec_id,spec,path+"."+child_prop));else
child_props.push(this.render_object_property(spec_id,spec,path+"."+child_prop));}
return child_props.join('');}}
SG.Widget.ThreadedDetailPage=function(context,widget_spec,id){SG.Widget.ThreadedDetailPage.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ThreadedDetailPage,SG.Widget.Base,{default_settings:{},templates:{widget:'<div class="contents">'+'<div class ="main_table"><table class="main"><tr><td><div class="left_column">'+'<div class="fields"><table><tr><td>'+'<div id="{left_fields_id}" class="{left_fields_class}"></div></td>'+'<td><div id="{right_fields_id}" class="{right_fields_class}"></div></td></tr></table></div>'+'<div class="sgc_note_links_quick_edit"></div>'+'<div id="{textfields_id}" class="{textfields_class}"></div>'+'<div id="{thread_id}" class="{thread_class}"></div></div></td>'+'<td style="width: 250px;"><div id="{right_column_id}" class="right_column {right_column_class}">'+'</div></td></tr></table></div></div>'},init_widget:function()
{},render:function()
{this.container=this.get_container();this.container.addClass(this.get_css_class_name());var dh=Ext.DomHelper;var left_fields=this.get_child('left_fields');var right_fields=this.get_child('right_fields');var textfields=this.get_child('textfields');var thread=this.get_child('thread');var right_column=this.get_child('right_column');this.container.update(this.templates.widget.apply({left_fields_id:left_fields.get_container_id(),left_fields_class:left_fields.get_css_class_name(),right_fields_id:right_fields.get_container_id(),right_fields_class:right_fields.get_css_class_name(),textfields_id:textfields.get_container_id(),textfields_class:textfields.get_css_class_name(),thread_id:thread.get_container_id(),thread_class:thread.get_css_class_name(),right_column_id:right_column.get_container_id(),right_column_class:right_column.get_css_class_name()}));SG.Repo.start_batch();left_fields.render();right_fields.render();textfields.render();this.construct_note_links_quick_edit_component();thread.render();right_column.render();SG.Repo.end_batch();},construct_note_links_quick_edit_component:function()
{var context_entity=this.context.get('entity');if(!context_entity||context_entity.type!='Note')return;var config={container:this.container.child('div.sgc_note_links_quick_edit'),entity:context_entity,widget:this};var quick_edit=this.new_component(SG.NoteLinksQuickEdit,config);},});SG.Widget.Thread=function(context,widget_spec,id){SG.Widget.Thread.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Thread,SG.Widget.Base,{default_settings:{display_events:false,grouping_delta:60},templates:{creation_event:'<div class="event_log_entry"><table><tr><td width="20"><img src="/images/icon_EventLogEntry.png"></td>'+'<td>Created {entity_type}</td></tr></table></div>',attribute_change_event:'<div class="event_log_entry"><table><tr><td width="20"><img src="/images/icon_EventLogEntry.png"></td>'+'<td>Changed<span class="field_display_name">{field}</span>'+'from<span class="field_value">{old_value}</span>to<span class="field_value">{new_value}</span></td>'+'</tr></table></div>',multi_entity_attribute_change_event:'<div class="event_log_entry"><table><tr><td width="20"><img src="/images/icon_EventLogEntry.png"></td>'+'<td>Changed<span class="field_display_name">{field}</span>'+'<span class="field_value">{verb}</span><span class="field_value">{new_value}</span></td>'+'</tr></table></div>',attribute_change_event_long:'<div class="event_log_entry"><table><tr><td width="20"><img src="/images/icon_EventLogEntry.png"></td>'+'<td>Changed<span class="field_display_name">{field}</span>'+'<a href="#" class="show_long_content">[show change]</a>'+'<div class="long_content" style="display: none">{old_value} => {new_value}</div>'+'</td></tr></table></div>',image_attachment:'<div class="attachment_content image" record_id="{record_id}" sg_tip="{sg_tip}">'+'<a href="{image_path}" target="_blank"><img src="/thumbnail/image/{thumb}" onError="sg_missing_image(this)"/></a>'+'</div>',other_attachments:'<div class="attachment_table">{attachments}</div>',other_attachment:'<div class="attachment_other {extra}"><table><tr><td class="filename">'+'<div>{filename}</div></td><td class="file_size"><div>{file_size}</div></td>'+'<td class="trash">{delete_attachment}</td></tr></table></div>',delete_attachment:'<div class="trash attachment_delete" record_id="{record_id}"></div>',reply_edit_form:'<textarea class="reply_textarea">{content}</textarea>'+'<div class="reply_edit_controls"><input class="reply_edit_update" type="button" value="Update reply"/>'+'<span class="reply_edit_cancel">Cancel</span></div>',reply:'<div class="reply_content" id="{id}"><span class="reply_text">{content}</span>{edit_button}'+'{delete_button}</div>',revision:'<div class="revision_content">Checked in {detail_link} - {content}</div>',revision_shotgun:'<div class="revision_content">Checked in {detail_link} to {branch} - {content}</div>',reply_delete_button:'<img class="reply_button reply_delete" src="'+SG.globals.icons.Trash+'" '+'sg_tip="Delete reply">',reply_edit_button:'<img class="reply_button reply_edit" src="'+SG.globals.icons.Edit+'" '+'sg_tip="Edit reply">',display_events_checked:'<div class="display_events"><input checked="true" type="checkbox" class="display_event_check checked"/>'+'<span class="display_event_label">Display Events<span></div>',display_events_unchecked:'<div class="display_events"><input type="checkbox" class="display_event_check"/>'+'<span class="display_event_label">Display Events</span></div>',group_of_events:'<div class="group_of_events {extra_class}"><table><tr><td class="thumbnail">'+'<div class="sg_widget_note_detail_author_thumb" user_id="{user_id}"></div></td>'+'<td class="events"><div class="events_div">'+'<div class="event_group_header"><span class=author"">{author}</span>'+'<span class="created_at">{created_at}</span></div>'+'{events}</div></td></tr></table></div>'},on_first_render:function()
{var dh=Ext.DomHelper;this.container=this.get_container();this.context_entity=this.context.get('entity');this.context_entity_type=this.context_entity.type;this.header_div=dh.append(this.container,{tag:'div',cls:'header'},true);this.content_div=dh.append(this.container,{tag:'div',cls:'content'},true);this.form_div=dh.append(this.container,{tag:'div',cls:'form'},true);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'contextmenu',this.on_contextmenu);this.render_header();this.entity_set=this.new_data_set(this.context_entity_type,this.render_widget_and_form,this.on_entity_change);this.author_set=this.new_data_set('HumanUser',this.render_thumbnails);this.script_set=this.new_data_set('ApiUser',this.render_thumbnails);this.reply_set=this.new_data_set('Reply',null,this.on_reply_attachment_change);this.event_set=this.new_data_set('EventLogEntry');this.attachment_set=this.new_data_set('Attachment',null,this.on_reply_attachment_change);this.revision_set=this.new_data_set('Revision');this.link_parser=new SG.TicketAndRevisionLinkParser(this.container);this.fetch_data();},render:function()
{if(!this.__rendered__)
{this.on_first_render();this.__rendered__=true;}
else
this.render_widget();},render_widget:function()
{this.hide_loading_overlay();this.render_thread();if(this.thread_form_component)
this.thread_form_component.collapse();},render_widget_and_form:function()
{this.render_widget();this.render_thread_form();},group_records:function()
{this.groups=[];var rec,created_at,meta,user_id;var prev_group,prev_group_data,prev_user_id;var i,j,idx;for(i=0;i<this.reply_set.count();i++){rec=this.reply_set.get_record(i);created_at=this.get_created_time(rec);this.groups.push({created_at:created_at,reply:rec});}
for(i=0;i<this.revision_set.count();i++){rec=this.revision_set.get_record(i);created_at=this.get_created_time(rec);for(j=0;j<this.groups.length;j++){if(created_at<this.groups[j].created_at)break;}
this.groups.splice(j,0,{created_at:created_at,revision:rec});}
for(i=0;i<this.attachment_set.count();i++)
{rec=this.attachment_set.get_record(i);created_at=this.get_created_time(rec);user_id=this.get_user_id({entity_type:'Attachment',record:rec});this.add_to_groups(created_at,'attachments',rec,user_id);}
if(!this.get('display_events'))return;for(i=0;i<this.event_set.count();i++)
{rec=this.event_set.get_record(i);created_at=Date.sgParseDateTime(rec.get('created_at')).getTime();user_id=this.get_user_id({entity_type:'EventLogEntry',record:rec});meta=rec.get('meta');if(meta&&meta.type=="attribute_change"&&!SG.schema.get_field(this.context_entity_type,rec.get('attribute_name'))){continue;}
if(meta&&meta.type=="attribute_change"&&['replies','attachments'].indexOf(rec.get('attribute_name'))!==-1)
{continue;}
this.add_to_groups(created_at,'events',rec,user_id);}},add_to_groups:function(created_at,key,rec,user_id)
{var j;for(var j=0;j<this.groups.length;j++)
if(created_at<this.groups[j].created_at)
break;prev_group=this.groups[j-1];if(typeof(prev_group)=="undefined")
{var hash={created_at:created_at};hash[key]=[rec];this.groups.splice(0,0,hash);return;}
prev_primary_rec=this.get_primary_record(prev_group);prev_user_id=this.get_user_id(prev_primary_rec);var grouping_delta=Number(this.get('grouping_delta'))*1000;if(created_at<prev_group.created_at+grouping_delta&&user_id==prev_user_id)
{prev_group[key]=prev_group[key]||[];if(key=='events'&&prev_group.events.length>0)
{meta=prev_group[key][0].get('meta')||{};if(meta.type=='new_entity')
return;}
prev_group[key].push(rec);}
else
{var hash={created_at:created_at};hash[key]=[rec];this.groups.splice(j,0,hash);}},render_thread_form:function()
{if(!this.entity_set.is_loaded())
{this.form_div.update('');return;}
if(!this.thread_form_component){var form_config={container:this.form_div,data_set:this.entity_set,entity:this.context_entity,projects:this.context_projects(),new_entity_project:this.single_project_from_context(),busy_callback:{fn:function(tf){this.show_loading_overlay();},scope:this},done_callback:{fn:function(tf){this.fetch_data();},scope:this}};this.thread_form_component=this.new_component(SG.ThreadForm,form_config);}
this.thread_form_component.render();var page=this.get_page();if(page.context.get('email_link')||(page.parent_page&&page.parent_page.context.get('email_link'))){this.thread_form_component.focus_on_reply();}},render_thread:function()
{var i;var html='';this.group_records();this.distinct_user_ids={};this.link_parser.begin_parse();for(var i=0;i<this.groups.length;i++){html+=this.render_group(i);}
this.content_div.update(html);this.link_parser.end_parse();var ids=[];for(var id in this.distinct_user_ids)
{if(this.distinct_user_ids.hasOwnProperty(id))
ids.push(id);}
if(ids.length>0)
this.fetch_thumbnails(ids);},render_group:function(idx)
{var group=this.groups[idx];var i;var html='';if(group.hasOwnProperty('reply')){html+=this.render_reply(group.reply);}
if(group.hasOwnProperty('revision')){html+=this.render_revision(group.revision);}
if(group.hasOwnProperty('attachments')){if(html!='')html+="<br/>";html+=this.render_attachments(group);}
if(this.get('display_events')&&group.hasOwnProperty('events')){if(html!='')html+="<br/>";for(i=0;i<group.events.length;i++)
html+=this.render_event(group.events[i]);}
var primary_rec=this.get_primary_record(group);var primary_user_id=this.get_user_id(primary_rec);this.distinct_user_ids[primary_user_id]=true;if(typeof(primary_rec)=="undefined"){return"";}else{var extra_class=idx%2==0?'even':'odd';var author=this.render_author(primary_rec);if(author==='&nbsp;')author="<i>Retired User</i>";return this.templates.group_of_events.apply({user_id:primary_user_id,events:html,extra_class:extra_class,author:author,created_at:this.render_created_at(primary_rec)});}},render_revision:function(record)
{var revision_entity={type:'Revision',id:record.get_id(),name:'r'+record.get('code')};var detail_link=SG.Renderers.render_one_detail_link(revision_entity);var content=SG.Markup.parse(record.get('description'));content=this.link_parser.parse_content(content);var tpl=this.templates.revision;var cfg={detail_link:detail_link,content:content};if(SG.globals.custom_for==='shotgun'){tpl=this.templates.revision_shotgun;cfg.branch=record.get('sg_branch');}
return tpl.apply(cfg);},render_author:function(record_hash)
{var field;switch(record_hash.entity_type)
{case"Reply":field='user';break;case"EventLogEntry":field='user';break;case"Attachment":field='created_by';break;case"Revision":field='created_by';break;}
return this.render_field_value(field,record_hash.record);},render_created_at:function(record_hash)
{return this.render_field_value('created_at',record_hash.record);},get_created_time:function(record)
{var a_date=Date.sgParseDateTime(record.get('created_at'));return a_date.getTime();},get_user_id:function(record_hash)
{if(['Attachment','Ticket','Revision','Delivery','ZendeskTicket'].indexOf(record_hash.entity_type)!==-1)
{var value=record_hash.record.get('created_by');if(value)
return value.id;else
return-1;}
else
{var value=record_hash.record.get('user');if(value)
return value.id;else
return-1;}},get_primary_record:function(group_data)
{var primary_rec;if(group_data.hasOwnProperty('reply')){primary_rec={entity_type:'Reply',record:group_data.reply};}else if(group_data.hasOwnProperty('revision')){primary_rec={entity_type:'Revision',record:group_data.revision};}else if(group_data.hasOwnProperty('attachments')){primary_rec={entity_type:'Attachment',record:group_data.attachments[0]};}else if(group_data.hasOwnProperty('events')){primary_rec={entity_type:'EventLogEntry',record:group_data.events[0]};}
return primary_rec;},render_attachments:function(group)
{var html='';var image_attachments=[];var other_attachments=[];var i,attachment_rec,file_name,is_valid_image;for(i=0;i<group.attachments.length;i++){attachment_rec=group.attachments[i];file_name=attachment_rec.get('filename');is_valid_image=file_name&&file_name.match(/.*\.((png)|(jpg)|(gif))$/);if(attachment_rec.get('image')&&is_valid_image)
image_attachments.push(attachment_rec);else
other_attachments.push(attachment_rec);}
var file_link,size_str,thumbnail;for(i=0;i<image_attachments.length;i++){attachment_rec=image_attachments[i];size_str=SG.Renderers.file_size.render_nbsp(attachment_rec.get('file_size'));html+=this.templates.image_attachment.apply({record_id:attachment_rec.id,sg_tip:attachment_rec.get('filename')+' ('+size_str+')',thumb:attachment_rec.get('image'),image_path:attachment_rec.get('this_file').url});}
if(html)
html+='<br/>';var file_field=SG.schema.get_field('Attachment','this_file');var attachments='';for(i=0;i<other_attachments.length;i++){if(i==0){attachments+=this.templates.other_attachment.apply({extra:'title',filename:'File',file_size:'Size',delete_attachment:''});}
attachment_rec=other_attachments[i];size_str=SG.Renderers.file_size.render_nbsp(attachment_rec.get('file_size'));file_link=SG.Renderers.url.render(attachment_rec.get('this_file'),file_field,size_str);var delete_attachment='';if(SG.schema.can_retire_entity('Attachment'))
delete_attachment=this.templates.delete_attachment.apply({record_id:attachment_rec.id});attachments+=this.templates.other_attachment.apply({extra:i%2==0?'even':'odd',filename:file_link,file_size:size_str,delete_attachment:delete_attachment});}
if(attachments!='')
html+=this.templates.other_attachments.apply({attachments:attachments});return html;},render_event:function(event_rec)
{var meta=event_rec.get('meta');var result="";if(!meta)return result;if(meta.type=="attribute_change"){result=this.render_attribute_change_event(event_rec);}else if(meta.type=="new_entity"){result=this.render_creation_event(event_rec);}
return result;},render_attribute_change_event:function(event_rec)
{var meta=event_rec.get('meta');if(meta.added!=undefined||meta.removed!=undefined)
return this.render_multi_entity_attribute_change_event(meta);if(SG.schema.entity_fields[this.context_entity_type][meta.attribute_name]['data_type']=='url')
return'';var ds=this.entity_set;var rec=this.entity_set.get_record_by_id(meta.entity_id);var sf=SG.schema.get_field(this.context_entity_type,meta.attribute_name);var renderer=this.get_renderer(sf);var old_value=meta.old_value;if(sf.data_type=='text')
old_value=SG.Markup.parse(old_value);var o=renderer.render(old_value,sf,rec);if(meta.attribute_name=="tag_list")o=old_value;if(!o||o=="")o="<i>empty</i>";var new_value=meta.new_value;if(sf.data_type=='text')
new_value=SG.Markup.parse(new_value);var n=renderer.render(new_value,sf,rec);if(meta.attribute_name=="tag_list")n=new_value;if(!n||n=="")n="<i>empty</i>";var entity_type=this.context.get('entity').type;var display_name=sf.display_name;var tmpl;if((old_value&&old_value.length>=100)||(new_value&&new_value.length>=100)){tmpl=this.templates.attribute_change_event_long;}else{tmpl=this.templates.attribute_change_event;}
return tmpl.apply({field:display_name,old_value:o,new_value:n});},render_multi_entity_attribute_change_event:function(meta)
{var h='';if(meta.added&&meta.added.length>0)
{var multi_entities=meta.added.concat([]);var detail_links='';for(var i=0;i<multi_entities.length;i++)
{if(i==0)
detail_links+=' ';else
detail_links+=', ';detail_links+=SG.Renderers.render_one_detail_link(multi_entities[i]);}
var tmpl=this.templates.multi_entity_attribute_change_event;var field=SG.schema.entity_fields[this.context_entity_type][meta.attribute_name];h+=tmpl.apply({field:field.display_name,verb:'Added:',new_value:detail_links});}
if(meta.removed&&meta.removed.length>0)
{var multi_entities=meta.removed.concat([]);var detail_links='';for(var i=0;i<multi_entities.length;i++)
{if(i==0)
detail_links+=' ';else
detail_links+=',';detail_links+=SG.Renderers.render_one_detail_link(multi_entities[i]);}
var tmpl=this.templates.multi_entity_attribute_change_event;var field=SG.schema.entity_fields[this.context_entity_type][meta.attribute_name];h+=tmpl.apply({field:field.display_name,verb:'Removed:',new_value:detail_links});}
return h;},render_creation_event:function(event_rec)
{var entity_type=event_rec.get('entity').type;var display=SG.schema.entity_types[entity_type].display_name;return this.templates.creation_event.apply({entity_type:display});},render_header:function()
{var display_events=this.get('display_events');var h;if(display_events)
h=this.templates.display_events_checked.apply();else
h=this.templates.display_events_unchecked.apply();this.header_div.update(h);},render_reply:function(reply_rec)
{var reply_content=this.render_field_value("content",reply_rec);reply_content=SG.Markup.parse(reply_content);var content=this.link_parser.parse_content(reply_content);return this.templates.reply.apply({id:reply_rec.get_id(),content:content,edit_button:this.render_reply_edit_button(reply_rec),delete_button:this.render_reply_delete_button(reply_rec)});},render_reply_edit_button:function(reply_rec)
{var sf=SG.schema.get_field('Reply','content');var editable=SG.schema.can_edit_field_on_record(reply_rec,sf);if(editable)
return this.templates.reply_edit_button.apply();else
return'';},render_reply_delete_button:function(reply_rec)
{if(SG.schema.can_retire_entity("Reply"))
return this.templates.reply_delete_button.apply();else
return'';},render_reply_edit_form:function(reply_div)
{var reply_id=Number(reply_div.dom.getAttribute('id'));var rec=this.reply_set.get_record_by_id(reply_id);var reply_content=rec.get('content');reply_div.update(this.templates.reply_edit_form.apply({content:reply_content}));var textarea=reply_div.child('textarea.reply_textarea');this.add_event(textarea,'scroll',function(e){if(textarea.getHeight()<textarea.dom.scrollHeight)
textarea.setHeight(textarea.dom.scrollHeight+11);});this.add_event(textarea,'keydown',function(e){SG.Page.unsaved_data.add("reply_"+reply_id);setTimeout(function(){if(textarea.getHeight()<textarea.dom.scrollHeight)
textarea.setHeight(textarea.dom.scrollHeight+11);},0);});},add_values_to_fields:function(fields)
{var entity=this.context.get('entity');var rec=this.entity_set.get_record(0);if(!rec)
return;for(var i=0;i<fields.length;i++)
{var field=fields[i];if(field.entity_type==entity.type)
{field.value=rec.get(field.name);field.value_status=rec.get_status(field.name);}}},on_entity_change:function(changes)
{var has_attach_update=false;for(var i=0;i<changes.length;i++){if(changes[i].type=='update'&&changes[i].state=="server"&&changes[i].column=="attachments"){has_attach_update=true;break;}}
if(has_attach_update)
this.fetch_data();},on_reply_attachment_change:function(changes)
{var revives=0;for(var i=0;i<changes.length;i++){if(changes[i].type=='revive')revives++;}
if(revives>0)
this.fetch_data();else
this.render_thread();},get_renderer:function(schema_field)
{var def=SG.Renderers.renderer_defaults[schema_field.data_type];if(!def){def="text";}else if(schema_field.name=='tag_list'){def="basic_multi_entity";}
return SG.Renderers[def];},render_field_value:function(field_name,record)
{var value=record.get(field_name);var sf=SG.schema.get_field(record.get_type(),field_name);var renderer=this.get_renderer(sf);return renderer.render_nbsp(value,sf,record);},render_thumbnails:function(ds)
{var i,r,h,j,div;var renderer=SG.Renderers.image;var default_img='<img class="thumbnail" src="/images/default_user_thumb.png">';var thumb_divs,value,rendered;for(i=0;i<ds.count();i++)
{r=ds.get_record(i);value=r.get("image");rendered=renderer.render(value);if(rendered=="")
rendered=default_img;thumb_divs=Ext.DomQuery.select('div.sg_widget_note_detail_author_thumb[user_id='+r.get_id()+']',this.content_div.dom);for(j=0;j<thumb_divs.length;j++)
{div=Ext.get(thumb_divs[j]);div.update(rendered);}}
thumb_divs=Ext.DomQuery.select('div.sg_widget_note_detail_author_thumb[user_id='+-1+']',this.content_div.dom);for(j=0;j<thumb_divs.length;j++)
{div=Ext.get(thumb_divs[j]);div.update(default_img);}},fetch_data:function()
{this.show_loading_overlay();var requests=[];var handlers=[];var entity=this.context.get('entity');var reply_filters={logical_operator:"and",conditions:[{path:"entity",relation:"is",values:[{type:entity.type,id:entity.id}]}]};var reply_spec={type:'Reply',columns:SG.schema.entity_types.Reply.fields_sorted_by_display_name,filters:reply_filters,sorts:[{column:"created_at",direction:"asc"}],result:this.reply_set};SG.Repo.query(reply_spec);if(entity.type=='Ticket')
{var revision_filters={logical_operator:"and",conditions:[{path:"tickets",relation:"is",values:[{type:entity.type,id:entity.id}]}]};var revision_spec={type:'Revision',columns:SG.schema.entity_types.Revision.fields_sorted_by_display_name,filters:revision_filters,sorts:[{column:"created_at",direction:"asc"}],result:this.revision_set};SG.Repo.query(revision_spec);}
var attachment_columns=['file_size','image'];attachment_columns=attachment_columns.concat(SG.schema.entity_types.Attachment.fields_sorted_by_display_name);var attachment_filters={logical_operator:"and",conditions:[{path:"attachment_links",relation:"is",values:[{type:entity.type,id:entity.id}]}]};var attachment_spec={type:'Attachment',columns:attachment_columns,filters:attachment_filters,sorts:[{column:"created_at",direction:"asc"}],result:this.attachment_set};SG.Repo.query(attachment_spec);if(this.get('display_events'))
{var event_filters={logical_operator:"and",conditions:[{path:"entity",relation:"is",values:[{type:entity.type,id:entity.id}]},{path:"attribute_name",relation:"is_not",values:["thread_updated_at"]},{path:"attribute_name",relation:"is_not",values:["read_by_current_user"]}]};var event_spec={type:'EventLogEntry',columns:SG.schema.entity_types.EventLogEntry.fields_sorted_by_display_name,filters:event_filters,sorts:[{column:"created_at",direction:"asc"}],result:this.event_set};SG.Repo.query(event_spec);}
var entity_spec={type:entity.type,id:entity.id,columns:SG.schema.entity_types[this.context_entity_type].fields_sorted_by_display_name,result:this.entity_set};SG.Repo.find(entity_spec);},fetch_thumbnails:function(user_ids)
{var author_spec={type:'HumanUser',ids:user_ids,columns:['image'],result:this.author_set};SG.Repo.find(author_spec);if(SG.schema.can_see_entity_type('ApiUser')){var script_spec={type:'ApiUser',ids:user_ids,columns:['image'],result:this.script_set};SG.Repo.find(script_spec);}},delete_attachment_from_div:function(attachment_div){var attachment_id=attachment_div.getAttribute('record_id');var entity_rec=this.entity_set.get_record(0);var dd=new SG.util.DeleteAttachment({entity_ds:this.entity_set,entity_id:entity_rec.get_id(),attachment_id:attachment_id});},on_click:function(e)
{var t=Ext.get(e.getTarget());var display_event_div=t.findParent('div.display_events',this.container,true);if(display_event_div)
{var display_event_check=display_event_div.child('input.display_event_check');this.set('display_events',!display_event_check.hasClass('checked'));this.render_header();this.fetch_data();return;}
var show_long_content=t.findParent('a.show_long_content',this.container,true);if(show_long_content)
{e.stopEvent();var long_content=Ext.get(show_long_content.getNextSibling());long_content.setVisibilityMode(Ext.Element.DISPLAY);long_content.toggle();if(long_content.isVisible()){show_long_content.update("[hide change]");}else{show_long_content.update("[show change]");}
return;}
var delete_reply=t.findParent('img.reply_delete',this.container,true);if(delete_reply)
{var okay=confirm("Do you want to delete the reply?");if(okay)
{var reply_div=t.findParent('div.reply_content',this.container,true);var rec=this.reply_set.get_record_by_id(reply_div.dom.getAttribute('id'));rec.retire();rec.commit();}
return;}
var edit_reply=t.findParent('img.reply_edit',this.container,true);if(edit_reply)
{var reply_div=t.findParent('div.reply_content',this.container,true);this.render_reply_edit_form(reply_div);return;}
var cancel_edit_reply=t.findParent('span.reply_edit_cancel',this.container,true);if(cancel_edit_reply)
{var reply_div=t.findParent('div.reply_content',this.container,true);var reply_id=Number(reply_div.dom.getAttribute('id'));SG.Page.unsaved_data.remove("reply_"+reply_id);this.render_widget();return;}
var update_edit_reply=t.findParent('input.reply_edit_update',this.container,true);if(update_edit_reply)
{var reply_div=t.findParent('div.reply_content',this.container,true);var reply_textarea=reply_div.child('textarea');var reply_id=Number(reply_div.dom.getAttribute('id'));SG.Page.unsaved_data.remove("reply_"+reply_id);var reply_rec=this.reply_set.get_record_by_id(reply_id);reply_rec.set('content',reply_textarea.dom.value);reply_rec.commit();return;}
var attachment_delete=t.findParent('div.attachment_delete');if(attachment_delete)
{this.delete_attachment_from_div(attachment_delete);return;}},on_contextmenu:function(e){var t=Ext.get(e.getTarget());var attachment_image=t.findParent('div.attachment_content.image');if(attachment_image){e.stopEvent();if(!SG.schema.can_retire_entity('Attachment'))return;var record_id=attachment_image.getAttribute('record_id');var record=this.attachment_set.get_record_by_id(Number(record_id));if(!record)return;if(!this.context_menu){this.context_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){the_menu.items=[{html:'Delete Attachment',icon_name:'trash',item_selected:{fn:function(){this.delete_attachment_from_div(the_menu.target_elem);},scope:this}}];the_menu.render();},scope:this}});}
this.context_menu.target_elem=attachment_image;this.context_menu.position={xy:e.getXY()};this.context_menu.show();return;}}});SG.Widget.PivotFields=function(context,widget_spec,id){SG.Widget.PivotFields.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.PivotFields,SG.Widget.Base,{default_settings:{columns:[],},templates:{field:'<div class="field">{content}</div>',field_name:'<div class="display_name">{display_name}</div>',field_value:'<div style="{cell_styles}" class="field_value {cell_classes}" {cell_attributes}>'+'{cell_content}</div>'},on_first_render:function()
{var dh=Ext.DomHelper;this.container=this.get_container();this.content_div=dh.append(this.container,{tag:'div',cls:'content'},true);var parent_td=this.container.findParentNode('td',1);if(parent_td)
this.add_event(parent_td,"contextmenu",this.on_contextmenu);else
this.add_event(this.container,"contextmenu",this.on_contextmenu);var context_entity=this.context.get('entity');this.entity_set=this.new_data_set(context_entity.type,this.on_entity_load);var cell_config={container:this.container,data_set:this.entity_set,projects:this.context_projects(),field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.link_parser=new SG.TicketAndRevisionLinkParser(this.container);this.fetch_data();},get_field_property_for_cell_manager:function(schema_field){var field_settings=this.get('columns');for(var i=0;i<field_settings.length;i++){var field_property=field_settings[i];if(field_property.field==schema_field.name)
return field_property;}
return null;},on_entity_load:function()
{this.record=this.entity_set.get_record(0);this.render_widget();},on_contextmenu:function(e)
{var t=Ext.get(e.getTarget());var href=t.findParent('a',this.container,true);if(href)
return;e.stopEvent();if(!this.context_menu)
this.context_menu=this.create_context_menu();this.context_menu.position={xy:e.getXY()};this.context_menu.target_elem=t;this.context_menu.show();},create_context_menu:function()
{var menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_context_menu,scope:this}});menu.render();return menu;},on_before_show_context_menu:function(menu)
{var items=[];items.push({html:'Configure...',item_selected:{fn:this.configure,scope:this},});menu.items=items.concat(this.cell_manager.get_context_menu_items(menu.target_elem));;menu.render();},configure:function(menu,item)
{var cols=this.get('columns');if(cols.length===0){var all=this.get_columns();for(var i=0;i<all.length;i++)
cols.push({field:all[i],show_label:true});}
var fpd=new SG.FieldProperties.Dialog({entity_type:this.context.get('entity').type,join_fields:[],field_properties_schema:this.field_properties_schema,field_settings:cols,pivot_columns:'summary',widget:this,settings_applied_callback:{fn:this.on_columns_set,scope:this}});},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:true},{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'}],on_columns_set:function(columns,field_name_column_width)
{this.set('columns',columns);this.fetch_data();},label_visible:function(field)
{var col_hash=this.get('columns');for(var i=0;i<col_hash.length;i++)
{if(col_hash[i].field==field)
return col_hash[i].show_label;}
return true;},render:function()
{if(!this.__rendered__)
{this.on_first_render();this.__rendered__=true;}
else
this.render_widget();},render_widget:function()
{this.hide_loading_overlay();if(!this.entity_set.is_loaded())
{this.content_div.update('');return;}
this.link_parser.begin_parse();var columns=this.get_columns();var h='';if(this.design_mode_on_detail_page()){h+=this.templates.detail_widgets_edit_header.apply({title:'Pivot Fields',widget_id:this.get_widget_id(),entity_type:this.entity_type});}
for(i=0;i<columns.length;i++){h+=this.render_field(columns[i]);}
this.content_div.update(h);this.link_parser.end_parse();},render_field:function(field)
{var h='';if(this.label_visible(field)){h+=this.render_field_name(field);}
h+=this.render_field_value(field);return this.templates.field.apply({content:h});},render_field_name:function(field)
{var cell=this.cell_manager.get_cell(field);var name=this.templates.field_name.apply({display_name:cell.get_field_display_name()});return name;},is_attachment_field:function(field,schema_fields)
{return(schema_fields[field].data_type=='multi_entity'&&schema_fields[field].allowed_entity_types&&schema_fields[field].allowed_entity_types.length==1&&schema_fields[field].allowed_entity_types[0]=='Attachment');},render_field_value:function(field)
{var cell=this.cell_manager.get_cell(field);var cell_hash=cell.render(this.record);return this.templates.field_value.apply(cell_hash);},get_columns:function()
{var entity_type=this.context.get('entity').type;var columns=this.get('columns');if(columns.length==0)
{var schema_fields=SG.schema.entity_fields[entity_type];var all=SG.schema.entity_types[entity_type].fields_sorted_by_display_name;var ret=[];for(var i=0;i<all.length;i++)
{var field=all[i];if(schema_fields[field]['grid_column'])
ret.push(field);}
return ret;}
else
{var ret=[];for(var i=0;i<columns.length;i++)
{var field=columns[i].field;var schema_field=SG.schema.get_field(entity_type,field);if(schema_field)
ret.push(field);}
return ret;}},fetch_data:function()
{this.show_loading_overlay();var entity=this.context.get('entity');var spec={type:entity.type,id:entity.id,columns:this.get_columns(),result:this.entity_set};SG.Repo.find(spec);},});SG.ThreadForm=function(config)
{Ext.apply(this,config);SG.ThreadForm.superclass.constructor.call(this);};Ext.extend(SG.ThreadForm,SG.Component,{templates:{update_properties_tip:'<img class="properties_tip_icon {state}" src="{icon}">Update Properties',attach_button:'<img class="paperclip" src="/images/paperclip.png"><span class="attach_text">Attach</span>',reply_textarea:'<div class="reply_textarea"><textarea class="reply_textarea"></textarea></div>',properties_row:'<div class="field"><table><tr><td class="field_name">{display_name}:</td>'+'<td class="field_value {cell_classes}" {cell_attributes}>{cell_content}</td></tr></table></div>',task_selector:'<div class="sgc_tasks_mini_grid_selector">'+'<div class="field_value {cell_classes}" {cell_attributes}>{cell_content}</div></div>',cancel_link:'<a class="cancel_link" href="javascript: void(0)">Cancel</a>',reply_button:'<input type="button" class="reply_button" value="Create Reply">',},note_fields:['note_links','tasks','subject','addressings_cc','sg_status_list','sg_note_type'],ticket_fields:['addressings_to','title','tag_list','sg_status_list','sg_priority'],zendesk_ticket_fields:['addressings_to','title','tickets','sg_zendesk_status','sg_priority'],zendesk_forum_post_fields:['title','tickets','sg_status_list'],delivery_fields:['addressings_to','addressings_cc','sg_due_date','sg_received_date','sg_status_list'],reply_text:'',render:function()
{if(!this.__rendered__)
{this.on_first_render();this.__rendered__=true;}
else
this.render_component();},on_first_render:function(){var dh=Ext.DomHelper;var html='';this.contents=dh.append(this.container,{tag:'div',cls:'sgc_thread_form'},true);this.add_event(this.contents,'click',this.on_click);this.footer=dh.append(this.contents,{tag:'div',cls:'footer'},true);this.properties_tip=dh.append(this.footer,{tag:'div',cls:'properties_tip'},true);this.action_area=dh.append(this.footer,{tag:'div',cls:'reply_div'},true);this.attach_files_button=dh.append(this.footer,{tag:'div',cls:'attach_button'},true);this.attach_files_button.enableDisplayMode();this.properties=dh.append(this.contents,{tag:'div',cls:'properties',style:'display: none'},true);this.properties.enableDisplayMode();this.attach_files_container=dh.append(this.contents,{tag:'div',cls:'attach_files'},true);this.attach_files_container.enableDisplayMode();this.attach_files_container.hide();var textarea_div=dh.append(this.contents,this.templates.reply_textarea.apply());this.reply_textarea=Ext.get(textarea_div.firstChild);this.add_event(this.reply_textarea.dom,'keyup',this.on_text_keyup,this);this.footer_below_properties=dh.append(this.contents,{tag:'div',cls:'footer_below_properties'},true);var button_html=this.templates.reply_button.apply();if(this.show_cancel)
button_html=this.templates.cancel_link.apply()+button_html;dh.append(this.footer_below_properties,button_html);this.reply_button=this.footer_below_properties.child('input.reply_button');var cell_config={container:this.container,data_set:this.data_set,projects:this.projects,in_form:true,get_fields_callback:{fn:this.get_fields,scope:this}};if(this.data_set.entity_type=='Note')
{cell_config.edit_applied_callback={fn:this.on_cell_edit,scope:this};cell_config.on_cell_edit_changed={fn:this.on_cell_edit_changed,scope:this};}
this.cell_manager=this.new_component(SG.CellManager,cell_config);this.render_component();},get_fields:function(){if(SG.globals.custom_for=="shotgun"){if(this.entity.type==='ZendeskTicket')
return this.zendesk_ticket_fields;else if(this.entity.type==='ZendeskForumPost')
return this.zendesk_forum_post_fields;}
if(this.entity.type==='Note'){return this.note_fields;}else if(this.entity.type==='Ticket'){if(SG.globals.custom_for=="shotgun"){var tix=sg_deep_copy(this.ticket_fields);tix.push("sg_sprint");return tix;}else{return this.ticket_fields;}}else if(this.entity.type==='Delivery'){return this.delivery_fields;}else{return[];}},render_component:function(){this.record=this.data_set.get_record_by_id(this.entity.id);this.render_attach_files();this.render_properties();this.render_reply();this.attach_files_button.update(this.templates.attach_button.apply());var tip_state=this.properties.isVisible()?"open":"closed";this.render_properties_tip(tip_state);if(!this.reply_textarea_has_rendered&&this.focus_reply)
{this.focus_on_reply();this.reply_textarea_has_rendered=true;}},render_attach_files:function(){if(this.attachment_control)
this.attachment_control.destroy();var config={container:this.attach_files_container,done_callback:{fn:this.fire_done_callback,scope:this},close_callback:{fn:this.toggle_attach_control,scope:this}};this.attachment_control=this.new_component(SG.AttachmentControl,config);this.attachment_control.render();},render_properties:function(){var rows,field,cell;var fields=this.get_fields();rows="";for(var i=0;i<fields.length;i++){field=fields[i];if(this.data_set.entity_type=='Note'&&field=='tasks')
cell=this.get_tasks_cell();else
cell=this.cell_manager.get_cell(field);if(!cell)
{console.log("Invalid hard-coded field reference in thread_form.js: "+field);continue;}
cell_hash=cell.render(this.record);cell_hash.display_name=cell.get_field_display_name();if(this.data_set.entity_type=='Note'&&field=='tasks')
rows+=this.templates.task_selector.apply(cell_hash);else
rows+=this.templates.properties_row.apply(cell_hash);}
this.properties.update(rows);},render_properties_tip:function(state){var icon;var html;if(state=="open"){icon=SG.globals.icons.ArrowOpen;}else{icon=SG.globals.icons.ArrowClosed;}
html=this.templates.update_properties_tip.apply({icon:icon,state:state});this.properties_tip.update(html);},collapse:function(){if(this.properties.isVisible()){this.properties.hide();this.render_properties_tip("closed");}
if(this.attach_files_container.isVisible()){this.toggle_attach_control();}},toggle_attach_control:function(){this.attach_files_button.show();this.attach_files_container.hide();},toggle_properties_tip:function(){if(this.properties.isVisible()){this.properties.hide();this.render_properties_tip("closed");this.manage_owner_widget_classes(false);}else{this.properties.show();this.render_properties_tip("open");this.manage_owner_widget_classes(true);}},manage_owner_widget_classes:function(properties_open){if(!this.widget)return;var container=this.widget.get_container();if(properties_open){if(!container.hasClass('reply_update_properties_open'))
container.addClass('reply_update_properties_open');}else{if(container.hasClass('reply_update_properties_open'))
container.removeClass('reply_update_properties_open');}},remove_owner_widget_classes:function(){if(!this.widget)return;var container=this.widget.get_container();if(container.hasClass('reply_update_properties_open'))
container.removeClass('reply_update_properties_open');},focus_on_reply:function(){if(this.reply_textarea){var me=this;setTimeout(function(){me.reply_textarea.focus();},100);}},render_reply:function(){if(this.reply_textarea){this.reply_textarea.dom.value=this.reply_text;}},on_click:function(e){var target=Ext.get(e.getTarget());var properties_tip=target.findParent('.properties_tip',this.contents);if(properties_tip)
this.toggle_properties_tip();var reply_button=target.findParent('.reply_button',this.contents);if(reply_button)
{SG.Page.unsaved_data.remove(this.container.dom.id+"_new_reply_text");if(this.data_set.entity_type=='Note')
{this.fire_busy_callback();var cell=this.get_tasks_cell();cell.get_selected_tasks({fn:this.set_tasks_before_submit,scope:this});}
else
this.submit();return;}
var cancel_link=target.findParent('a.cancel_link',this.contents);if(cancel_link)
{SG.Page.unsaved_data.remove(this.container.dom.id+"_new_reply_text");this.fire_cancel_callback();}
var attach_button=target.findParent('.attach_button',this.contents);if(attach_button){this.attach_files_button.hide();this.attach_files_container.show();}},on_text_keyup:function(e)
{var target=e.target;if(target.value=="")
SG.Page.unsaved_data.remove(this.container.dom.id+"_new_reply_text");else
SG.Page.unsaved_data.add(this.container.dom.id+"_new_reply_text");},destroy_component:function(e)
{SG.Page.unsaved_data.remove(this.container.dom.id+"_new_reply_text");this.remove_owner_widget_classes();},set_tasks_before_submit:function(tasks)
{if(tasks!=null)
this.record.set('tasks',tasks);this.submit();},submit:function(){this.cell_manager.apply_all_edits();var reply_text=this.reply_textarea.dom.value;var wait_for_reply=false;var wait_for_upload=this.attachment_control.ready();this.fire_busy_callback();if(reply_text!==""){var reply=new SG.Data.Record('Reply');reply.set_owner(this);reply.set('entity',this.entity);reply.set('content',reply_text);reply.commit();wait_for_reply=true;}
this.record.commit();if(!wait_for_reply){if(wait_for_upload){this.upload_files();}else{this.fire_done_callback();}}},upload_files:function(){var fv=[];fv.push({column:"attachment_links",value:[this.entity]});if(this.new_entity_project)
fv.push({column:"project",value:this.new_entity_project});this.attachment_control.submit(fv);},fire_busy_callback:function(){if(this.busy_callback){this.busy_callback.fn.call(this.busy_callback.scope,this);}},fire_cancel_callback:function(){if(this.cancel_callback){this.cancel_callback.fn.call(this.cancel_callback.scope,this);}},fire_done_callback:function(){if(this.done_callback){this.done_callback.fn.call(this.done_callback.scope,this);}},on_record_change:function(changes){var found_create=false;for(var i=0;i<changes.length;i++){if(changes[i].type=="create"){found_create=true;this.reply_text='';break;}else if(changes[i].type==='create_failed'){this.reply_text=this.reply_textarea.dom.value;this.fire_done_callback();}}
if(found_create){if(this.attachment_control.ready()){this.upload_files();}else{this.fire_done_callback();}}},on_cell_edit:function(field,record,cell)
{if(field!='note_links')return;var cell=this.get_tasks_cell();cell.set_entities(this.record.get('note_links'));},on_cell_edit_changed:function(field,value)
{if(field!='note_links')return;this.record.set('note_links',value);var cell=this.get_tasks_cell();cell.set_entities(value);},get_tasks_cell:function()
{var tasks_cell=this.cell_manager.get_cell('tasks',{type:SG.TasksMiniGridSelector});return tasks_cell;},});SG.NoteLinksQuickEdit=function(config)
{Ext.apply(this,config);SG.NoteLinksQuickEdit.superclass.constructor.call(this);};Ext.extend(SG.NoteLinksQuickEdit,SG.Component,{templates:{main:'<div class="note_links">{note_links}</div>'+'<div class="sgc_tasks_mini_grid_selector">{tasks}</div>',field:'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'<div class="sg_cell_content">{cell_content}</div></div>',},init_component:function(){this.data_set=this.new_data_set('Note',this.on_data_load);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'dblclick',this.on_dblclick);var cell_config={container:this.container,data_set:this.data_set,projects:this.widget.context_projects(),get_fields_callback:{fn:this.get_fields,scope:this},};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.fetch_data();},on_click:function(e)
{var cell=this.cell_manager.get_cell('tasks');if(!cell.render_condensed)return;var t=Ext.get(e.getTarget());var div=t.findParent('div.sgc_tasks_mini_grid_selector',this.container.dom);if(!div)return;var icon=t.findParent('div.icon_edit',this.container.dom);if(icon)
this.render_with_fullsize_task_selector(cell);},on_dblclick:function(e)
{var cell=this.cell_manager.get_cell('tasks');if(!cell.render_condensed)return;var t=Ext.get(e.getTarget());var div=t.findParent('div.sgc_tasks_mini_grid_selector',this.container.dom);if(div)
this.render_with_fullsize_task_selector(cell);},render_with_fullsize_task_selector:function(cell)
{cell.render_condensed=false;this.render_component();var me=this;setTimeout(function(){var div=me.container.child('div.sg_cell[field="tasks"]');me.cell_manager.trigger_editing(div);},0);},get_fields:function()
{return['note_links','tasks'];},on_data_load:function()
{if(this.data_set.count()>0)
this.record=this.data_set.get_record(0);else
this.record=null;this.render_component();},render_component:function()
{var cell=this.cell_manager.get_cell('note_links');var config=cell.render(this.record);var note_links_field=this.templates.field.apply(config);cell=this.cell_manager.get_cell('tasks',{type:SG.TasksMiniGridSelector,render_condensed:true});config=cell.render(this.record);var tasks_field=this.templates.field.apply(config);var html=this.templates.main.apply({note_links:note_links_field,tasks:tasks_field});this.container.update(html);if(cell.render_note_addressings)
cell.render_note_addressings();},fetch_data:function()
{var spec={type:this.entity.type,id:this.entity.id,columns:['note_links','tasks'],result:this.data_set};SG.Repo.find(spec);},});SG.Widget.WarningMessage=function(context,widget_spec,id)
{SG.Widget.WarningMessage.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.WarningMessage,SG.Widget.Base,{default_settings:{},templates:{message:'<div class="message">{message}</div>',page_not_found:'<div class="message"><div class="section"><b>Sorry, this page does not exist.  '+'It may have been deleted or your link may be incorrect.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',page_forbidden:'<div class="message"><div class="section"><b>'+'Sorry, you do not have permission to view this page.  Please contact '+'your admin to request a change in permissions.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',app_inactive:'<div class="message"><div class="section"><b>'+'Sorry, that Shotgun app is not currently active.  Please contact '+'your admin to turn on the app.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',no_pages:'<div class="message"><div class="section"><b>'+'Sorry, you do not have access to any Shotgun pages.<br> Contact '+'your admin to add projects or change access permissions.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',entity_not_found:'<div class="message"><div class="section">'+'<b>Sorry, this {entity_type} does not exist.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',entity_deleted:'<div class="message"><div class="section">'+'<b>Sorry, this {entity_type} has been deleted.  Please contact '+'your admin if you need to revive it.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',entity_forbidden:'<div class="message"><div class="section">'+'<b>Sorry, you do not have permission to view this {entity_type}.  Please contact '+'your admin to request a change in permissions.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',invalid_entity_type:'<div class="message"><div class="section">'+'<b>Sorry, the "{entity_type}" entity type is not available.</b></div>'+'<div class="section">If you believe this is an error, please contact support at '+'<a href="mailto:support@shotgunsoftware.com">support@shotgunsoftware.com</a>.</div>'+'{details}</div>',details:'<div class="details hidden"><div class="show_details" '+'onclick="this.parentNode.className = \'details\'">Show details...</div>'+'<div class="details_content">{message}</div></div>',no_entity_for_default_detail_page:'<div class="message"><div class="section"><b>This Entity does not have any records yet, so please '+'create one that can then be used as an example for the Detail default layout.</b></div>'+'<div class="section">You can create a new {entity_type_display_name} <a '+'href="/new/{entity_type}">here.</a>'},init_widget:function()
{if(this.context.get('message_type')=='page_forbidden')
{var detail_entity=SG.entity_in_hash();if(detail_entity)
window.location.href="/detail/"+detail_entity.type+"/"+detail_entity.id;}},on_first_render:function()
{this.container=this.get_container();},render_widget:function()
{var warning_type=this.context.get('message_type')||'message';var message=this.context.get('message')||"No details available.";template_parms={message:message};if(['entity_forbidden','entity_not_found','entity_deleted','invalid_entity_type'].indexOf(warning_type)>-1)
{var entity_type=this.context.get('entity_type');template_parms.entity_type=SG.schema.entity_types[entity_type].display_name;}
if(warning_type!='message')
template_parms.details=this.templates.details.apply({message:message});if(warning_type=='no_entity_for_default_detail_page')
{var entity_type=this.context.get('entity_type');template_parms.entity_type=entity_type;template_parms.entity_type_display_name=SG.schema.entity_types[entity_type].display_name;}
this.container.update(this.templates[warning_type].apply(template_parms));}});SG.Widget.ThumbnailGrid=function(context,widget_spec,id)
{SG.Widget.ThumbnailGrid.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ThumbnailGrid,SG.Widget.EntityQueryMode,{default_settings:{columns:[{field:'image',show_label:false}],thumbnails_per_page:25,thumb_size:1.0,word_wrap:false,sorts:[],select_first_record:false},templates:{body:'<div class="body" style="font-size:{size}em;"></div>',entity:'<li class="entity seltarget selectable {selected}" group_idx="{group_idx}" record_id="{record_id}" '+'entity_idx="{entity_idx}"><div class="content">'+'<table class="fields top_fields"><col class="col1" /><col class="col2" />{top_fields}</table>'+'{thumb}'+'<table class="fields bottom_fields"><col class="col1" /><col class="col2" />{bottom_fields}</table>'+'</div></li>',thumb:'<div class="thumbnail_grid cell {cell_classes}" style="{cell_styles}" {cell_attributes}'+'sg_entity_type="{entity_type}" sg_entity_id="{entity_id}">'+'<div class="sg_cell_content_wrapper" sg_cell_content_wrapper="true">'+'{cell_content}</div></div>',field_name:'<td class="cell label"><div class="display_name">{display_name}:</div></td>',field_value:'<td class="cell {cell_classes}" style="{cell_styles}" {cell_attributes} {colspan}>'+'<div class="sg_cell_content {cutter}">{cell_content}</div></td>',field:'<tr class="{word_wrap}">{field_name}{field_value}</tr>',group:'<div class="group {state} {synthetic}" group_idx="{group_idx}">'+'<div class="group_header" count="{count}" depth="{depth}">{group_header}</div>'+'<div class="group_contents">{contents}</div></div>',group_header:'<div class="group_tip notseltarget" sg_tip="{sg_tip}">'+'<span class="group_tip">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="group_type">{group_type}:</span>'+'<span class="group_name">{group}</span>'+'<span class="group_total">({total})</span></div>',slider:'<div class="slider {small}">'+'<div class="small_icon"></div><div class="left_cap"></div><div class="middle"></div>'+'<div class="right_cap"></div><div class="large_icon"></div>'+'<div class="knob" id="{slider_id}" style="left:{left}px;"></div></div>',toolbar_field_menu:'<span class="label">Fields</span><img src="/images/dropdown_arrow_small.png" '+'class="down_arrow" />',},before_init:function()
{this.entity_type=this.context.get('entity_type');var ident_field=SG.schema.get_identifier_field(this.entity_type);if(ident_field!=null)
{this.my_default_settings.columns=[{field:'image',show_label:false},{field:ident_field,show_label:false}];}},init_widget:function()
{this.data_set=this.new_data_set(this.entity_type,this.on_data_load,this.on_data_change);this.current_page=1;},on_first_render:function()
{var dh=Ext.DomHelper;this.container=this.get_container();this.container.addClass('seltarget');this.container.addClass('sg_scroll_container');this.add_event(this,"context_changed",this.on_context_changed);this.add_event(this.container,"click",this.on_click);this.add_event(this.container,"dblclick",this.on_double_click);this.summary_set=new SG.Data.SummarySet(this.entity_type);this.add_event(this.summary_set,'load',this.on_summary_load);var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects(),apply_row_rules:true,field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};if(this.__get_entity_query_page__().get('formatting_rules'))
cell_config.page_formatting_rules=this.__get_entity_query_page__().get('formatting_rules');this.select_first=this.get('select_first_record');this.cell_manager=this.new_component(SG.CellManager,cell_config);this.request_data();},get_field_property_for_cell_manager:function(schema_field){var field_settings=this.get('columns');return this.find_field_hash(field_settings,schema_field.name);},render_widget:function()
{this.container.dom.innerHTML=this.templates.body.apply({size:this.get('thumb_size')});this.body_div=this.container.child('div.body');if(this.data_set.is_loaded()&&this.data_set.count()===0){this.render_empty_message(this.entity_type,this.container);}
else
this.render_thumbnails();},on_click:function(e)
{var target=Ext.get(e.getTarget());elem=target.findParent('div.group_tip',this.container,true);if(elem)
{var group_div=elem.findParent('div.group',this.container,true);var dom_event=e.browserEvent;if(dom_event.altKey)
{if(group_div.hasClass('open'))
this.toggle_all_groups('closed');else
this.toggle_all_groups('open');}
else
{if(group_div.hasClass('open'))
this.close_group(group_div);else
this.open_group(group_div);}
return;}},on_double_click:function(e){var target=Ext.get(e.getTarget());if(target.findParent('div.thumb_menu'))return;var elem=target.findParent('div.thumbnail_cell_has_content',this.container,true);if(elem){var cell=this.cell_manager.get_cell('image');if(cell.revolver_overlay_enabled()){var record_id=Number(elem.dom.getAttribute('record_id'));var record=this.cell_manager.data_set.get_record_by_id(record_id);if(record&&cell.launch_revolver_overlay_for_record(record,elem))
return;}
var entity_type=elem.dom.getAttribute('sg_entity_type');var entity_id=elem.dom.getAttribute('sg_entity_id');var entity_name='';if(this.get_page().root_widget.show_entity_detail){if(SG.Page.unsaved_data.confirm_proceed())
{this.get_page().root_widget.show_entity_detail(entity_type,entity_id,entity_name);}}else{var url="/detail/"+entity_type+"/"+entity_id;document.location=url;}}},find_field_hash:function(all_field_hashes,field)
{var i;for(i=0;i<all_field_hashes.length;i++)
{var field_hash=all_field_hashes[i];if(field_hash.field==field)
return field_hash;}
return null;},render_thumbnails:function()
{var rec,group,i;var field_settings=this.get('columns');this.top_fields=[];this.bottom_fields=[];var all_fields=this.get_all_fields();var index=all_fields.length;for(i=0;i<all_fields.length;i++)
{var field_hash=this.find_field_hash(field_settings,all_fields[i]);if(!field_hash)continue;if(field_hash.field=='image')
index=i;else if(i<index)
this.top_fields.push(field_hash);else
this.bottom_fields.push(field_hash);}
var html='';if(this.data_set.is_grouped())
{this.grouping=this.get_grouping();SG.Widget.ThumbnailGrid.__thumb_count__=0;html+=this.recursively_render_groups(this.data_set.groups,0);}
else
{for(i=0;i<this.data_set.count();i++)
{rec=this.data_set.get_record(i);html+=this.render_thumb(rec,-1,i);}
html='<ul>'+html+'</ul>';}
this.body_div.update(html);},recursively_render_groups:function(groups,depth)
{var html='';for(var i=0;i<groups.length;i++)
{var group=groups[i];if(group.synthetic)
{var thumb_count=SG.Widget.ThumbnailGrid.__thumb_count__;var content_html=this.recursively_render_groups(group.groups,depth+1);var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,group.depth,this.grouping,schema_field,schema_field.display_name)
var count=SG.Widget.ThumbnailGrid.__thumb_count__-thumb_count;var group_header=this.templates.group_header.apply({group_type:schema_field.display_name,group:display_name,total:count,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({state:state,synthetic:'synthetic',group_idx:group.idx,group_header:group_header,contents:content_html,count:count,depth:depth});}
else
{var content_html='<ul>';var grp_recs=group.ids;for(var j=0;j<grp_recs.length;j++)
{var rec=this.data_set.get_record_by_id(grp_recs[j]);content_html+=this.render_thumb(rec,group.idx,j);SG.Widget.ThumbnailGrid.__thumb_count__++;}
content_html+='</ul>';var schema_field=SG.schema.get_field(this.entity_type,this.grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,this.grouping,schema_field,schema_field.display_name)
var group_header=this.templates.group_header.apply({group_type:schema_field.display_name,group:display_name,total:grp_recs.length,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({state:state,synthetic:'',group_idx:group.idx,group_header:group_header,contents:content_html,count:grp_recs.length,depth:depth});}}
return html;},on_context_changed:function(key,value)
{if(key=="filters"||key=="parent_entity"||key=='grouping'){this.request_data();}},render_thumb:function(record,group_idx,entity_idx)
{var record_id=record.get_id();var cell=this.cell_manager.get_cell('image');cell.accept_dblclick_event=false;var config=cell.render(record);config.entity_type=this.entity_type;config.entity_id=record_id;var thumb=this.templates.thumb.apply(config);var i,field_hash,cell,name,value;var top_fields_html='';for(i=0;i<this.top_fields.length;i++)
top_fields_html+=this.render_field(this.top_fields[i],record);var bottom_fields_html='';for(i=0;i<this.bottom_fields.length;i++)
bottom_fields_html+=this.render_field(this.bottom_fields[i],record);return this.templates.entity.apply({selected:this.in_selection_cache(group_idx,record_id)?'selected':'',group_idx:group_idx,record_id:record_id,top_fields:top_fields_html,thumb:thumb,entity_idx:entity_idx,bottom_fields:bottom_fields_html});},render_field:function(field_hash,record)
{var cell=this.cell_manager.get_cell(field_hash.field,{detail_link:this.is_detail_link(field_hash)});var name='';colspan='';if(field_hash.show_label){var display_name;if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_name=field_hash.field_label_override;else
display_name=cell.get_field_display_name();name=this.templates.field_name.apply({display_name:display_name});}else{colspan='colspan=2';}
var config=cell.render(record);if(this.get('word_wrap'))
config.cutter='';else
config.cutter='cutter';config.colspan=colspan;var value=this.templates.field_value.apply(config);return this.templates.field.apply({field_name:name,field_value:value,word_wrap:this.get('word_wrap')?'wrap':'no_wrap'});},is_detail_link:function(field_hash)
{if(SG.schema.is_identifier_field(this.entity_type,field_hash.field))
return true;else
{if(field_hash.detail_link!=undefined)
return field_hash.detail_link;else
return false;}},on_data_load:function(something)
{this.hide_loading_overlay();if(typeof something=='object'&&something.length&&something.length===1&&something[0]=='grouped_summaries')
{return;}
if(this.data_set.is_grouped())
this.request_group_counts(this.summary_set);else
this.clear_group_summaries();if(this.select_first){this.select_first_record();this.select_first=false;}
if(this.restore_scroll)
{this.restore_scroll=false;this.container.scrollTo('top',0,false);}
this.on_entities_loaded();this.render_widget();},on_data_change:function(changes)
{var retired=0;var revived=0;for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.type=='retire')retired++;if(change.type=='revive')revived++;}
if(revived>0){this.request_data();}else if(retired>0){this.hide_loading_overlay();this.render_widget();if(this.data_set.is_grouped())
this.request_group_counts(this.summary_set);}},render_size_slider:function(elem,small_controls)
{var WIDTH=140;var RANGE=140-12-31;if(small_controls)
{WIDTH=70;RANGE=70-12-31;}
var slider_id='sgw_thumbnail_grid_size_knob_'+this.get_widget_id();var left=((Number(this.get('thumb_size'))-0.25)*RANGE/3.75)+12;elem.update(this.templates.slider.apply({left:left,slider_id:slider_id,small:small_controls?'small':''}));if(this.size_drag_control)
this.size_drag_control.unreg();this.size_drag_control=new Ext.dd.DD(slider_id);this.size_drag_control.scroll=false;this.size_drag_control.resizeFrame=false;this.size_drag_control.setYConstraint(0,0);this.size_drag_control.setXConstraint(left-12,WIDTH-left-31);this.size_drag_control.drag_knob=elem.child('div.knob');this.size_drag_control.thumb_widget=this;this.size_drag_control.b4StartDrag=function(x,y){this.resetConstraints();var l=this.drag_knob.getLeft(true);this.setXConstraint(l-12,WIDTH-l-31);this.setYConstraint(0,0);};this.size_drag_control.startDrag=function(){this.drag_knob.addClass('dragging');};this.size_drag_control.endDrag=function(){this.drag_knob.removeClass('dragging');var size=this.calc_size();this.thumb_widget.set('thumb_size',size);};this.size_drag_control.calc_size=function(){var left=Number(this.drag_knob.getLeft(true));var size=((left-12)*3.75/RANGE)+0.25;return size;};this.size_drag_control.onDrag=function(){var size=this.calc_size();this.thumb_widget.body_div.set({style:'font-size:'+size+'em;'});};this.slider_div=elem.child('div.slider');this.add_event(this.slider_div,'mousedown',function(e){var target=Ext.get(e.getTarget());var knob=target.findParent('div.knob');if(knob)
return;var slider_left=e.xy[0]-this.slider_div.getLeft();if(slider_left>12&&slider_left<(WIDTH-14))
{if(slider_left>(WIDTH-31))
slider_left=(WIDTH-31);this.size_drag_control.drag_knob.setLeft(slider_left);var size=this.size_drag_control.calc_size();this.body_div.set({style:'font-size:'+size+'em;'});this.set('thumb_size',size);}});},get_left_footer_render_callback:function()
{return{fn:this.render_size_slider,scope:this};},field_properties_schema:[{property_name:'show_label',data_type:'boolean',display_name:'Display field label',default_value:false},{property_name:'detail_link',data_type:'boolean',display_name:'Render As Link To Detail Page',default_value:false,restrict_to_field_data_types:['text','number']},{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},],configure_fields:function()
{var fpd=new SG.FieldProperties.Dialog({entity_type:this.entity_type,join_fields:this.get_through_join_fields(),field_properties_schema:this.field_properties_schema,field_settings:this.get('columns'),read_only_fields:['image'],pivot_columns:'summary',widget:this,settings_applied_callback:{fn:this.on_columns_set,scope:this}});},toggle_word_wrap:function()
{this.set('word_wrap',!this.get('word_wrap'));var me=this;setTimeout(function(){me.render_widget();},0);},on_columns_set:function(columns)
{this.set('columns',columns);this.cell_manager.empty_cell_cache();this.request_data();},on_fields_menu:function(e,toolbar_elem)
{this.fields_menu_toolbar_div=toolbar_elem;if(!this.fields_menu)
{this.fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},});}
this.fields_menu.show();},on_before_show_fields_menu:function(menu)
{var all_fields=this.get_all_fields();var fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:this.entity_type,widget:this,through_join_fields:this.get_through_join_fields(),parent_entity:this.context.get('parent_entity'),field_disabled_callback:{fn:function(field_schema,field_name){return field_name=='image'},scope:this},field_checked_callback:{fn:function(field_schema,field_name){return(all_fields.indexOf(field_name)!=-1);},scope:this},on_field:{fn:this.toggle_field,scope:this},show_pivot_column_summary_fields:true});var items=[];items.push({html:'Configure Layout...',item_selected:{fn:this.configure_fields,scope:this},});items.push({line:true});menu.position={dom_elem:this.fields_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items.concat(fields_menu_helper.get_menu_items());menu.render();},toggle_field:function(menu,menu_item)
{if(menu_item.checked)
{var new_cols=[];var cols=this.get('columns');for(var i=0;i<cols.length;i++)
{if(cols[i].field!=menu_item.field)
new_cols.push(cols[i]);}
this.set('columns',new_cols);this.request_data();}
else
{var cols=sg_deep_copy(this.get('columns'));cols.push({field:menu_item.field,show_label:false});this.set('columns',cols);this.request_data();}},on_sort_menu_click:function(e,toolbar_elem)
{this.sort_menu_toolbar_div=toolbar_elem;if(!this.sort_menu)
{this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this},});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:this.entity_type,through_join_fields:this.get_through_join_fields(),parent_entity:this.context.get('parent_entity'),get_sorts_callback:{fn:this.on_get_sorts,scope:this},set_sorts_callback:{fn:this.on_set_sorts,scope:this},column_display_name_callback:{fn:this.get_custom_external_action_column_display_name,scope:this}});}
this.sort_menu.show();},on_get_sorts:function()
{return this.get('sorts');},on_set_sorts:function(new_sorts)
{this.set('sorts',new_sorts);this.request_data();},on_before_show_sort_menu:function(menu)
{menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=this.sorting_menu_helper.get_menu_items();menu.render();},get_all_fields:function()
{var column_settings=this.get('columns');var fields=[];for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];var schema_field=SG.schema.get_field(this.entity_type,field_hash.field);if(schema_field)
fields.push(field_hash.field);}
return fields;},get_fields_display_names:function()
{var display_names={};var column_settings=this.get('columns');for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];if(field_hash&&field_hash.field_label_override&&field_hash.field_label_override!='')
display_names[field_hash.field]=field_hash.field_label_override}
return display_names;},set_data_store_max_records:function(num_recs)
{this.current_page=1;this.set('thumbnails_per_page',num_recs);this.request_data();},set_data_store_page:function(page_num)
{this.current_page=page_num;this.request_data();this.restore_scroll=true;},reload_all_entities:function()
{this.request_data();},get_entity_data_store:function()
{return this.data_set;},get_toolbar_items:function()
{var items=[];items.push({position:'left',html:this.templates.toolbar_sorting_menu.apply(),onclick:{fn:this.on_sort_menu_click,scope:this},oncontextmenu:{fn:this.on_sort_menu_click,scope:this},cls:'action_menu',sg_tip:'Sorting Options'});items.push({position:'left',html:'_SPACER_'});items.push({position:'left',html:this.templates.toolbar_field_menu.apply(),onclick:{fn:this.on_fields_menu,scope:this},oncontextmenu:{fn:this.on_fields_menu,scope:this},cls:'action_menu',sg_tip:'Manage Thumbnail Fields'});return items;},get_action_menu_items:function(items,target_elem,xy)
{items.mode.push({html:'Wrap Text',item_selected:{fn:this.toggle_word_wrap,scope:this},checked:this.get('word_wrap'),icon_name:'icon_wrap_text'});},multi_edit_selected:function()
{var config={data_set:this.data_set,fields:this.get_all_fields(),selected_entity_ids:this.get_selected_record_ids(),projects:this.context_projects(),column_display_names:this.get_fields_display_names()};new SG.EditSelectedDialog(config);},open_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='open')
return;group_div.replaceClass('closed','open');this.set_group_state(group,'open');},close_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='closed')
return;group_div.replaceClass('open','closed');this.set_group_state(group,'closed');},request_data:function(){this.show_loading_overlay();var spec={type:this.entity_type,filters:this.get_filters(),columns:this.get_all_fields(),sorts:this.get('sorts'),grouping:this.get_grouping(),current_page:this.current_page,records_per_page:this.get('thumbnails_per_page'),result:this.data_set};var parent_link_fields=this.get_parent_link_fields_from_context();if(parent_link_fields.length==1&&parent_link_fields[0]=="projects"&&this.context.get('page_project'))
{spec.parent_entity=this.context.get('page_project');}else{var parent_entity=this.context.get('parent_entity');if(parent_entity)spec.parent_entity=parent_entity;}
SG.Repo.query(spec);},on_summary_load:function(keys)
{var regex_first_synth=/first_group_count_(\d+)_(\d+)_(\d+)/;var regex_last_synth=/last_group_count_(\d+)_(\d+)_(\d+)/;var i,key,match;var updates={};var synthetic_group_updates={};for(i=0;i<keys.length;i++){key=keys[i];if(key==='first_group_count')
updates[0]=true;else if(key==='last_group_count')
updates[this.data_set.group_count()-1]=true;else if(match=key.match(regex_first_synth))
synthetic_group_updates[match[1]+'_'+match[2]+'_'+match[3]]=true;else if(match=key.match(regex_last_synth))
synthetic_group_updates[match[1]+'_'+match[2]+'_'+match[3]]=true;}
for(i in updates){if(updates.hasOwnProperty(i))
this.update_group_header(parseInt(i),false);}
for(i in synthetic_group_updates){if(synthetic_group_updates.hasOwnProperty(i))
this.update_group_header(i,true);}},update_group_header:function(group_idx,synthetic){var group_div=this.container.child('div.group[group_idx="'+group_idx+'"]');if(!group_div)return;var group_header_div=group_div.child('div.group_header');var count=Number(group_header_div.dom.getAttribute('count'));var depth=Number(group_header_div.dom.getAttribute('depth'));var group;var is_first=false;var is_last=false;if(synthetic)
{var low_idx=Number(group_idx.split('_')[0]);var high_idx=Number(group_idx.split('_')[1]);is_first=low_idx==0;is_last=low_idx==this.data_set.group_count()-1;group=this.data_set.get_synthetic_group(group_idx);}
else
{is_first=group_idx==0;is_last=group_idx==this.data_set.group_count()-1;group=this.data_set.get_group(group_idx);}
var sum;if(is_first)
{var key=synthetic?'first_group_count_'+group_idx:'first_group_count';sum=this.summary_set.get(key,'id');}
else if(is_last)
{var key=synthetic?'last_group_count_'+group_idx:'last_group_count';sum=this.summary_set.get(key,'id');}
if(sum&&count!=sum)count=count+" of "+sum;var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);if(group.synthetic){var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,group.depth,this.grouping,schema_field,schema_field.display_name)}else{var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,this.grouping,schema_field,schema_field.display_name)}
group_header_div.update(this.templates.group_header.apply({group_type:schema_field.display_name,group:display_name,total:count,sg_tip:this.render_group_header_tooltip(group,depth)}));},get_custom_external_action_columns:function()
{return this.get_all_fields();},get_custom_external_action_column_display_name:function(col)
{var display_names=this.get_fields_display_names();if(!display_names[col])
{var schema_field=SG.schema.get_field(this.entity_type,col);return schema_field.display_name;}
else
return display_names[col];},get_custom_external_action_sorts:function()
{return this.get('sorts');},});SG.Widget.SitePrefs=function(context,widget_spec,id)
{SG.Widget.SitePrefs.superclass.constructor.call(this,context,widget_spec,id);};SG.Widget.SitePrefs.set_permission_changed=function(permission_checkbox_dom)
{var container=permission_checkbox_dom.parentNode;var original_value=(permission_checkbox_dom.getAttribute('actual')=="true");if(permission_checkbox_dom.checked===original_value)
Ext.fly(container).removeClass('changed');else
Ext.fly(container).addClass('changed');};Ext.extend(SG.Widget.SitePrefs,SG.Widget.Base,{default_settings:{},templates:{widget:'<div class="sgw_site_prefs"><div class="prefs_title">Site Preferences</div>'+'<div class="prefs_page_info">This page contains a big list of site preferences that allow '+'you to modify how Shotgun works.  Saved changes take affect immediately and are seen across '+'all projects in the system.</div>'+'{controls}'+'{prefs}{controls}</div>',controls:'<div class="controls"><button class="update">Save Changes</button>'+'<span class="feedback">{feedback}</span></div>',pref_group:'<div class="pref_group {open_closed}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<span class="prefs_group_title opener_span">{title}</span></div>'+'<div class="content"><div class="prefs_group_info">{info}</div>'+'<table>{prefs}</table></div></div>',pref:'<tr><td class="pref_name"><div class="display_name">{display_name}:</div>'+'<div class="description">{description}</div></td>'+'<td class="prefs_value">{value}</td></tr>',text_input:'<input class="prefs_input handle_change" pref_key="{key}" type="text" '+'value="{value}"></input>',textarea_input:'<textarea rows="10" class="prefs_textarea handle_change" pref_key="{key}">{value}</textarea>',selector:'<select class="prefs_select handle_change" pref_key="{key}" '+'>{choices}</select>',selector_choice:'<option {selected} value="{value}">{display_value}</option>',email_pref_group:'<div class="pref_group entity_pref_group email_pref_group {open_closed}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<div class="entity_name">'+'<span style="vertical-align: middle; padding-left: 5px;">{title}</span></div>'+'<div class="entity_type_description">{description}</div></div>'+'<div class="content"><table>{prefs}</table></div></div>',entity_types_group:'<div class="pref_group {open_closed}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<span class="prefs_group_title opener_span">{title}</span></div>'+'<div class="content"><div class="prefs_group_info">{info}</div>'+'<div>{entity_pref_groups}</div></div></div>',entity_pref_group:'<div class="pref_group entity_pref_group {open_closed} {inactive}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<div class="entity_name">'+'<div class="icon_{entity_type}" style="display: inline-block; vertical-align: middle;"></div>'+'<span style="vertical-align: middle; padding-left: 5px;">{display_name} ({entity_type})</span></div>'+'<div class="entity_type_description">{entity_type_description}</div></div>'+'<div class="content"><table>{prefs}{permissions}</table></div></div>',entity_types_list_entry_checkbox:'<input type="checkbox" pref_key="{key}" entity_type="{entity_type}" '+'class="prefs_entity_type_checkbox handle_changed" {checked} '+'{disabled}></input>',entity_permissions:'<tr><td class="pref_name permissions_ui {open_closed}">'+'<div class="display_name opener" open_key="permissions_ui_{entity_type}">'+'<div class="arrow">&nbsp;</div>'+'Permissions</div>'+'<div class="description"></div></td>'+'<td class="prefs_value"><div id="permissions_ui_{entity_type}" class="permissions_ui_container" '+'state="empty"><i>Loading...</i></div></td></tr>',entity_permissions_content:'<div class="permissions_ui_learn">Learn about permissions '+'<a href="{learn_url}" target="_blank">here.</a></div>'+'{checkboxes}'+'<div class="permissions_ui_where_are_field_permissions">'+'{extra_prompt}'+'</div>',permissions_ui_checkbox_section:'<div class="permissions_ui_checkbox_section">'+'<span>Who can <b>{action}</b>{preposition}{entity_plural}?</span>'+'<div class="description {show_description_class}">{description} Please see the documentation '+'<a href="{learn_url}" target="_blank">here.</a></div>'+'<div class="checkboxes">{checkboxes}</div></div>',permission_checkbox:'<div class="permissions_ui_checkbox {attributes}">'+'<input type="checkbox" id="{checkbox_id}" {attributes} actual="{actual_value}"'+'onchange="SG.Widget.SitePrefs.set_permission_changed(this)" />'+'<label for="{checkbox_id}">{permission_set_name}</label>'+'<span class="restricted_note"> {restricted_note}</span>'+'</div>',permission_checkbox_with_exceptions:'<table><tr><td class="permissions_ui_checkbox_cell">'+'<div class="permissions_ui_checkbox {attributes}">'+'<input type="checkbox" id="{checkbox_id}" {attributes} actual="{actual_value}"'+'onchange="SG.Widget.SitePrefs.set_permission_changed(this)" />'+'<label for="{checkbox_id}">{permission_set_name}</label>'+'<span class="restricted_note"> {restricted_note}</span>'+'</div></td><td>'+'<div class="exceptions">{exceptions}</div>'+'</td></tr></table>',yes_no_radio_button:'<div class="prefs_yes_no_group"><div>'+'<input class="prefs_input_radio yes handle_change" name="{key}" pref_key="{key}" type="radio" value="yes"'+'{yes_checked}></input><span class="radio_label">Yes, {command_text}</span>'+'</div><div>'+'<input class="prefs_input_radio no handle_change" name="{key}" pref_key="{key}" type="radio" value="no"'+' {no_checked}></input><span class="radio_label">No, do not {command_text}</span>'+'</div></div>',email_post_value:'<div class="email_post_value"><b>Note:</b> '+'<a target="_blank" href="'+SG.globals.help_urls.query_fields+'">'+'Query type fields</a> are not supported.',file_management_group:'<div class="pref_group {open_closed}">'+'<div class="opener" open_key="file_management"><div class="arrow">&nbsp;</div>'+'<span class="prefs_group_title opener_span">File Management</span></div>'+'<div class="file_management content">{content}'+'<div class="local_storage_container"></div></div></div>',file_management_checkbox:'<input type="checkbox" pref_key="support_local_storage" {checked} '+'class="handle_change"></input>',email_pref_group_new:'<div class="pref_group email_pref_group {open_closed}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<span class="prefs_group_title opener_span">{title}</span></div>'+'<div class="content">{content}</div></div>',full_email_template:'<table class="full_email_template"><tr><td class="email_template">'+'<div class="wrapper"><div class="pref_label">Subject:</div>{subject_pref}'+'<div class="pref_label">Body:</div>{body_pref}</div></td>'+'<td class="help"><div class="help_title">Personalization reference</div>'+'<div class="instructions">You can insert field codes to personalize your email. Here are some '+'common ones:</div><div class="field_title">Person</div><div class="fields">{user_fields}</div>'+'<div class="field_title">Site</div><div class="fields">{site_fields}</div>'+'</td></tr></table>',email_pref:'<div class="email_pref_heading">{title}</div>'+'<div class="email_pref_info">{info}</div>'+'<div class="email_pref_value">{value}</div>',email_pref_wrapper:'<table><tr class="no_line"><td><div class="email_pref_wrapper">{prefs}</div></td></tr></table>',},feedback:'',pref_groups:{formatting:['format_date_fields','date_component_order','format_currency_fields_display_dollar_sign','format_currency_fields_decimal_options','format_currency_fields_negative_options','format_number_fields','format_float_fields','format_float_fields_rounding','format_footage_fields'],detail_pages:['detail_page_per_type_for_asset'],entities:[],scheduling:['duration_units','hours_per_day','week_end_day','field_to_recalculate_on_task_schedule_changes'],email_defaults:['email_notifications_user_default_all_notes','email_notifications_user_default_notes','email_notifications_user_default_all_tickets','email_notifications_user_default_tickets','email_notifications_user_default_all_deliveries','email_notifications_user_default_deliveries','email_notifications_user_default_all_tasks','email_notifications_user_default_tasks','email_notifications_user_default_all_versions','email_notifications_user_default_versions','email_notifications_user_default_version_link_cc'],email_layouts:['email_notifications_fields_for_note','email_notifications_fields_for_note_links','email_notifications_fields_for_ticket','email_notifications_fields_for_ticket_related_tickets','email_notifications_fields_for_delivery','email_notifications_fields_for_task','email_notifications_fields_for_task_link','email_notifications_fields_for_task_only','email_notifications_fields_for_version'],email_subject_templates:['email_notifications_subject_template_for_note','email_notifications_subject_template_for_ticket','email_notifications_subject_template_for_delivery','email_notifications_subject_template_for_version','email_notifications_subject_template_for_task_create','email_notifications_subject_template_for_task_delete','email_notifications_subject_template_for_task_undelete','email_notifications_subject_template_for_task_change'],email:['email_notifications','email_smtp_domain','email_smtp_user_name','email_notifications_sender','email_smtp_address','email_smtp_password','email_smtp_port','email_smtp_authentication','email_smtp_ssl_certs','email_smtp_enable_tls','email_notifications_user_address_must_include'],navigation_widget:['navigate_shots_by_scene','navigation_max_fetched_assets','navigation_max_fetched_shots','navigation_max_fetched_sequences'],installed_client_advanced:['user_authentication_method'],advanced:['show_linked_entity_thumbnail_on_task','show_linked_entity_thumbnail_on_version','feedback_email_address','show_smart_cut_fields_in_menus','maximum_entity_autocomplete_results','user_default_permission_rule_set_id','script_default_permission_rule_set_id','enable_rv_integration','filmstrip_thumbnails','frames_per_foot','show_default_entity_creation_form_for_versions'],file_management:['support_local_storage'],revolver:['enable_revolver_thumbnail_generation','enable_revolver_quicktime_generation','enable_revolver_quicktime_upload','enable_revolver_transcoding'],revolver_transcoding:['revolver_transcoding_url','revolver_transcoding_service_key'],not_displayed:['temerity_enable_integration','temerity_install_path','temerity_windows_plremote_exec','temerity_windows_pluilder_exec','email_delivery_method','email_sendmail_arguments','email_sendmail_location','site_type','timecode_framerate','site_code','user_default_permission_rule_set_code','script_default_permission_rule_set_code','enable_tank_integration','enable_revolver','enable_revolver_watermarking','enable_cinesync_online_integration','enforce_strong_passwords','simulate_server_errors','simulate_slow_connection','query_generation_beta','crew_planning_app_active'],other:[]},entity_types_to_hide:['DeliveryTarget','CutItem','File','Note','TemerityNode','TankPublishedFile','TankAction','TankDependency','TankType'],entity_type_lists:['disable_detail_page_for_entities','hide_from_new_entity_menu','quick_jump_entities','has_tasks'],invert_entity_type_lists:['disable_detail_page_for_entities','hide_from_new_entity_menu'],email_field_lists:['email_notifications_fields_for_note','email_notifications_fields_for_note_links','email_notifications_fields_for_ticket','email_notifications_fields_for_ticket_related_tickets','email_notifications_fields_for_delivery','email_notifications_fields_for_task','email_notifications_fields_for_task_link','email_notifications_fields_for_version'],init_widget:function()
{this.open_sections=[];this.entity_types_to_show=SG.schema.get_entity_types_for_site_config();var index;for(var i=0;i<this.entity_types_to_hide.length;i++)
{index=this.entity_types_to_show.indexOf(this.entity_types_to_hide[i]);if(index>-1)
this.entity_types_to_show.splice(index,1);}
this.entity_types_to_show=SG.schema.sort_entity_types_by_display_name(this.entity_types_to_show);},is_hosted_site:function()
{return(this.prefs['site_type'].value=='hosted');},on_first_render:function()
{var container=this.get_container();this.add_event(container,'click',this.on_click,this);this.add_event(container,'change',this.on_change,this);},render_widget:function()
{var container=this.get_container();if(!this.prefs)
{this.show_loading_overlay();container.update(this.templates['widget'].apply({}));this.request_prefs();return;}
var html=this.templates['widget'].apply({controls:this.templates['controls'].apply({feedback:this.feedback}),prefs:this.render_groups()});container.update(html);this.construct_local_storage_component(container);this.hide_loading_overlay();},render_groups:function()
{var show_hidden=(document.URL.indexOf('show_hidden_pref')>-1);var groups=[];groups.push(this.render_group(this.pref_groups.formatting,'Formatting','Options to specify how specific field types are displayed throughout the interface.'));groups.push(this.render_group(this.pref_groups.scheduling,'Scheduling','These preferences modify how various scheduling fields and queries behave.'));groups.push(this.render_file_management_group());groups.push(this.render_group(this.pref_groups.navigation_widget,'Navigation Widget','This is a special UI element seen at the top of Shot and Asset detail pages that allows you to '+'navigate from one page to another via two dropdown menus.  Here you can modify the behavior of '+'those dropdowns.'));if(!this.is_hosted_site()||show_hidden)
{groups.push(this.render_group(this.pref_groups.email,'Email Notifications','Turn on or off email notifications and configure the smtp server that handles email delivery.'));}
groups.push(this.render_email_layouts_group());groups.push(this.render_group(this.pref_groups.detail_pages,'Detail Pages',''));groups.push(this.render_entities_group());if(this.prefs['enable_revolver'].value==='yes')
groups.push(this.render_group(this.pref_groups.revolver,'Revolver',''));var advanced=this.pref_groups.other;if(!this.is_hosted_site()||show_hidden)
advanced=advanced.concat(this.pref_groups.installed_client_advanced);groups.push(this.render_group(advanced,'Advanced',''));if(show_hidden){var hidden_prefs=sg_deep_copy(this.pref_groups.not_displayed);if(this.prefs['enable_revolver'].value==='yes'&&this.prefs['enable_revolver_transcoding'].value==='yes'){var enable_revolver_index=hidden_prefs.indexOf('enable_revolver');if(enable_revolver_index>-1){var tmp=hidden_prefs.slice(0,enable_revolver_index+1);tmp=tmp.concat(this.pref_groups.revolver_transcoding);tmp=tmp.concat(hidden_prefs.slice(enable_revolver_index+1));hidden_prefs=tmp;}}
groups.push(this.render_group(hidden_prefs,'Hidden Preferences'));}
return groups.join('');},remove_pref_from_other:function(pref_key)
{var index=this.pref_groups.other.indexOf(pref_key);if(index>-1)
this.pref_groups.other.splice(index,1);},render_pref:function(pref_key){var pref=this.prefs[pref_key];if(!pref)
return null;var val=this.render_pref_editor(pref_key,pref);val+=this.render_post_value(pref_key);return this.templates['pref'].apply({display_name:pref.display_name,value:val,description:pref.description?pref.description:''});},render_group:function(pref_keys,title,info)
{var is_open=this.open_sections.indexOf(title)>-1;var pref_html=[];var html;for(var i=0;i<pref_keys.length;i++)
{html=this.render_pref(pref_keys[i]);if(!html)
continue;pref_html.push(html);}
return this.templates['pref_group'].apply({title:title,info:info,prefs:pref_html.join(''),open_closed:is_open?'open':'closed',open_key:title});},render_entities_group:function()
{var is_open;var pref_html=[];var pref;var disabled_detail_pref=this.prefs['disable_detail_page_for_entities'];var disabled_detail_selected_types=disabled_detail_pref.value.split(/\s*,\s*/);var disabled_detail_checked;var hide_new_menu_pref=this.prefs['hide_from_new_entity_menu'];var hide_new_menu_selected_types=hide_new_menu_pref.value.split(/\s*,\s*/);var hide_new_menu_checked;var quick_jump_pref=this.prefs['quick_jump_entities'];var quick_jump_selected_types=quick_jump_pref.value.split(/\s*,\s*/);var has_tasks_pref=this.prefs['has_tasks'];var has_tasks_selected_types=has_tasks_pref.value.split(/\s*,\s*/);var types=this.entity_types_to_show;var type,entity_prefs_html,entity_prefs,pref,is_open,open_key;for(var i=0;i<types.length;i++)
{type=types[i];open_key='entity_type_group_'+type;is_open=this.open_sections.indexOf(open_key)>-1;entity_prefs_html=[];pref_key_use_entity='use_'+type.tableize();pref_key_display_name='display_name_'+type.underscore();entity_prefs=[pref_key_use_entity,pref_key_display_name];for(var j=0;j<entity_prefs.length;j++)
{pref=this.prefs[entity_prefs[j]];if(!pref)
continue;entity_prefs_html.push(this.templates['pref'].apply({display_name:pref.display_name,value:this.render_pref_editor(entity_prefs[j],pref),description:pref.description?pref.description:''}));}
if(entity_prefs_html.length==0&&type!='Project')
continue;entity_prefs_html.push(this.templates['pref'].apply({display_name:has_tasks_pref.display_name,value:this.templates['entity_types_list_entry_checkbox'].apply({key:'has_tasks',entity_type:types[i],checked:(has_tasks_selected_types.indexOf(types[i])>-1)?'checked':'',disabled:(['Task','TaskTemplate','Note'].indexOf(types[i])>-1)?'disabled':''})}));disabled_detail_checked=!(disabled_detail_selected_types.indexOf(types[i])>-1);entity_prefs_html.push(this.templates['pref'].apply({display_name:disabled_detail_pref.display_name,value:this.templates['entity_types_list_entry_checkbox'].apply({key:'disable_detail_page_for_entities',entity_type:types[i],checked:disabled_detail_checked?'checked':'',disabled:(types[i]=='Project')?'disabled':''})}));entity_prefs_html.push(this.templates['pref'].apply({display_name:quick_jump_pref.display_name,value:this.templates['entity_types_list_entry_checkbox'].apply({key:'quick_jump_entities',entity_type:types[i],checked:(quick_jump_selected_types.indexOf(types[i])>-1)?'checked':''})}));hide_new_menu_checked=!(hide_new_menu_selected_types.indexOf(types[i])>-1);entity_prefs_html.push(this.templates['pref'].apply({display_name:hide_new_menu_pref.display_name,value:this.templates['entity_types_list_entry_checkbox'].apply({key:'hide_from_new_entity_menu',entity_type:types[i],checked:hide_new_menu_checked?'checked':''})}));pref=this.prefs['use_'+type.tableize()];inactive=pref&&(pref.value=='no');var description=this.entity_type_descriptions[type]||'';if(type.indexOf('CustomEntity')!=-1)
description=this.entity_type_descriptions['CustomEntity'];else if(type.indexOf('CustomNonProjectEntity')!=-1)
description=this.entity_type_descriptions['CustomNonProjectEntity'];else if(type.indexOf('CustomThreadedEntity')!=-1)
description=this.entity_type_descriptions['CustomThreadedEntity'];var entity_type_display_name=(typeof this.prefs[pref_key_display_name]!='undefined')?this.prefs[pref_key_display_name].value:SG.schema.entity_types[type].display_name;pref_html.push(this.templates['entity_pref_group'].apply({entity_type:type,display_name:entity_type_display_name,entity_type_description:description,prefs:entity_prefs_html.join(''),open_closed:is_open?'open':'closed',open_key:open_key,inactive:inactive?'inactive':'',permissions:this.templates['entity_permissions'].apply({entity_type:type})}));}
var is_open=this.open_sections.indexOf('Entities')>-1;return this.templates['entity_types_group'].apply({title:'Entities',info:'The Shotgun "schema" is made up of "Entities" and "Fields", and is highly customizable.  '+'Entities are the various things you can track:  Shots, Assets, Elements, Tasks, etc. There '+'are over 50 Entities in the system, including some generic ones.  All entities can be turned '+'on/off, and each entity can be renamed to match studio nomenclature.  Currently you can not '+'make new Entities via the UI, though that is planned in a future release.  In the short term, '+'we have created 25 generic entities that can be renamed and used any way you like.  Fields on '+'each entity can be created and modified on any entity page.  Think of Entities as database tables, '+'and Fields as database fields.  Learn more about entities '+'<a target="_blank" href="'+SG.globals.help_urls.linking_entities+'">here</a>.',entity_pref_groups:pref_html.join(''),open_closed:is_open?'open':'closed',open_key:'Entities'});},render_email_layouts_group:function()
{var email_default_keys=sg_deep_copy(this.pref_groups.email_defaults);var email_layout_keys=sg_deep_copy(this.pref_groups.email_layouts);var email_subject_templates=sg_deep_copy(this.pref_groups.email_subject_templates);this.dynamic_email_field_lists=sg_deep_copy(this.email_field_lists);for(var i=0;i<this.entity_types_to_show.length;i++)
{var entity_type=this.entity_types_to_show[i];var entity_type_schema=SG.schema.entity_types[entity_type];if(entity_type.match(/^CustomThreadedEntity/)&&entity_type_schema)
{var key="email_notifications_fields_for_"+entity_type_schema.name_underscored;this.remove_pref_from_other(key);if(entity_type_schema.enabled)
{email_layout_keys.push(key);this.dynamic_email_field_lists.push(key);}
key="email_notifications_user_default_"+entity_type_schema.name_pluralized_underscored
this.remove_pref_from_other(key);if(entity_type_schema.enabled)
email_default_keys.push(key);key="email_notifications_user_default_all_"+entity_type_schema.name_pluralized_underscored
this.remove_pref_from_other(key);if(entity_type_schema.enabled)
email_default_keys.push(key);key="email_notifications_subject_template_for_"+entity_type_schema.name_underscored;this.remove_pref_from_other(key);if(entity_type_schema.enabled)
email_subject_templates.push(key);}}
var subgroups_html='';subgroups_html+=this.render_email_subgroup('email_notifications_subject_template_for_password_welcome','email_notifications_body_template_for_password_welcome','Welcome Email to New Users');subgroups_html+=this.render_email_subgroup('email_notifications_subject_template_for_password_reset','email_notifications_body_template_for_password_reset','Password Reset');this.remove_pref_from_other('email_notifications_subject_template_for_password_welcome');this.remove_pref_from_other('email_notifications_body_template_for_password_welcome');this.remove_pref_from_other('email_notifications_subject_template_for_password_reset');this.remove_pref_from_other('email_notifications_body_template_for_password_reset');var layouts_hash={};var subject_hash={};for(var i=0;i<email_subject_templates.length;i++){var key=email_subject_templates[i];var entity_type=this.find_entity_type_for_email_key(key);if(!subject_hash[entity_type])
subject_hash[entity_type]=[key];else
subject_hash[entity_type].push(key);}
for(var i=0;i<email_layout_keys.length;i++){var key=email_layout_keys[i];var entity_type=this.find_entity_type_for_email_key(key);if(!layouts_hash[entity_type])
layouts_hash[entity_type]=[key];else
layouts_hash[entity_type].push(key);}
for(var entity_type in layouts_hash){if(!layouts_hash.hasOwnProperty(entity_type))continue;subgroups_html+=this.render_email_for_entity_subgroup(subject_hash[entity_type],layouts_hash[entity_type],entity_type);}
subgroups_html+=this.render_email_layouts_subgroup(email_default_keys,'Default User Subscriptions','Specify the default subscription settings for new user accounts.');var is_open=this.open_sections.indexOf('Email Layouts and User Defaults')>-1;return this.templates['entity_types_group'].apply({title:'Email Layouts and User Defaults',info:'You can customize the information that is displayed in the subject line and the gray box '+'in the body of emails sent about Notes, '+'Tickets, Deliveries, Tasks, etc. and '+'specify the default subscription settings for new user accounts.',entity_pref_groups:subgroups_html,open_closed:is_open?'open':'closed',open_key:'Email Layouts and User Defaults'});},find_entity_type_for_email_key:function(key){var key_end='';if(key.indexOf('email_notifications_subject_template_for')==0){key_end=key.slice(41);}else{key_end=key.slice(31);}
for(var entity_type in SG.schema.entity_types)
{if(!SG.schema.entity_types.hasOwnProperty(entity_type))continue;if(entity_type=='NoteLink')continue;var entity_type_schema=SG.schema.entity_types[entity_type];if(key_end.indexOf(entity_type_schema.name_underscored)>-1){return entity_type_schema.display_name_pluralized;}}},render_email_for_entity_subgroup:function(subject_prefs,template_prefs,entity_type){var all_prefs=subject_prefs.concat(template_prefs);var content='';for(var i=0;i<all_prefs.length;i++){var pref=this.prefs[all_prefs[i]];content+=this.templates.email_pref.apply({title:pref.display_name,info:pref.description,value:this.templates.text_input.apply({key:all_prefs[i],value:pref.value})});}
var html=this.templates.email_pref_wrapper.apply({prefs:content});var is_open=this.open_sections.indexOf(subject_prefs[0])>-1;return this.templates.email_pref_group_new.apply({open_closed:is_open?'open':'closed',open_key:subject_prefs[0],title:entity_type,content:html});},render_email_subgroup:function(subject_pref,body_pref,title){var subject=this.templates.text_input.apply({key:subject_pref,value:this.prefs[subject_pref].value,});var value=this.prefs[body_pref].value.replace('<br>','\n','g');var body=this.templates.textarea_input.apply({key:body_pref,value:value,});var user_fields=['name','firstname','lastname','login','password'];var content=this.templates.full_email_template.apply({subject_pref:subject,body_pref:body,user_fields:'{'+user_fields.join('}<br>{')+'}',site_fields:'{url}',});var is_open=this.open_sections.indexOf(subject_pref)>-1;return this.templates.email_pref_group_new.apply({open_closed:is_open?'open':'closed',open_key:subject_pref,title:title,content:content});},render_email_layouts_subgroup:function(pref_keys,title,info)
{var is_open=this.open_sections.indexOf(title)>-1;var pref_html=[];var pref,val;for(var i=0;i<pref_keys.length;i++)
{pref=this.prefs[pref_keys[i]];if(!pref)
continue;val=this.render_pref_editor(pref_keys[i],pref);val+=this.render_post_value(pref_keys[i]);pref_html.push(this.templates['pref'].apply({display_name:pref.display_name,value:val,description:pref.description?pref.description:''}));}
return this.templates['email_pref_group'].apply({title:title,description:info,prefs:pref_html.join(''),open_closed:is_open?'open':'closed',open_key:title});},render_file_management_group:function()
{var is_open=this.open_sections.indexOf('file_management')>-1;var cfg={checked:this.prefs['support_local_storage'].value=='yes'?'checked':''};var content='<table><tr><td>'+this.templates.file_management_checkbox.apply(cfg)+'</td>'+'<td><div class="title"><b>Enable linking to local files</b></div>'+'<div>This option allows users to point to files or folders on a shared file system instead of '+'uploading them.  Other users with access to that file system can then click to immediately open that'+' file or jump to the folder in their finder / explorer.  Create one or more storage configurations, '+'which includes the base paths for all the operating systems you want to support. '+'<a href="'+SG.globals.help_urls.local_files+'" target="_blank">'+'Read more about how this works</a>.</div></td></tr></table>';return this.templates.file_management_group.apply({content:content,open_closed:is_open?'open':'closed'});},construct_local_storage_component:function(container)
{if(this.local_storage_component)
this.local_storage_component.destroy();this.local_storage_container=Ext.get(sg_find('div.local_storage_container',container.dom));this.local_storage_container.enableDisplayMode();if(this.prefs['support_local_storage'].value=='no')
this.local_storage_container.hide();var cfg={container:this.local_storage_container,dirty_callback:{fn:this.set_dirty_message,scope:this}};this.local_storage_component=this.new_component(SG.LocalStorage,cfg);this.local_storage_component.render();},render_pref_editor:function(key,pref)
{if(key=='user_default_permission_rule_set_id')
{return this.render_permission_dropdown(key,pref,SG.globals.human_user_permission_groups);}
else if(key=='script_default_permission_rule_set_id')
{return this.render_permission_dropdown(key,pref,SG.globals.api_user_permission_groups);}
else if(pref.options=='text')
return this.templates['text_input'].apply({key:key,value:pref.value});else if(pref.options=='number'||pref.options=='float')
return this.templates['text_input'].apply({key:key,value:pref.value});else if(pref.options.length==2&&pref.options.indexOf('yes')>-1&&pref.options.indexOf('no')>-1)
{var command_text=pref.display_name;command_text=command_text.substring(0,1).toLowerCase()+command_text.substring(1);return this.templates['yes_no_radio_button'].apply({key:key,yes_checked:pref.value=='yes'?'checked':'',no_checked:pref.value=='no'?'checked':'',command_text:command_text});}
else
{return this.render_dropdown(key,pref,pref.options);}},render_post_value:function(key)
{if(this.dynamic_email_field_lists&&this.dynamic_email_field_lists.indexOf(key)!==-1)
return this.templates.email_post_value.apply();return"";},render_permission_dropdown:function(key,pref,roles)
{var choices=[];if(pref.value==-1){choices.push(this.templates['selector_choice'].apply({value:-1,display_value:"No Default",selected:'selected'}));}
for(var i=0;i<roles.length;i++)
{choices.push(this.templates['selector_choice'].apply({value:roles[i].id,display_value:roles[i].display_name,selected:roles[i].id==pref.value?'selected':''}));}
return this.templates['selector'].apply({key:key,choices:choices.join('')});},render_dropdown:function(key,pref,options)
{var choices=[];for(var i=0;i<options.length;i++)
{choices.push(this.templates['selector_choice'].apply({value:options[i],display_value:options[i].replace("\\\"","\""),selected:options[i]==pref.value?'selected':''}));}
return this.templates['selector'].apply({key:key,choices:choices.join('')});},request_prefs:function()
{var options={url:'/preferences/get_prefs',params:{},callback:function(options,success,response){if(success)
this.load_prefs(response.responseText);else
SG.server_error({connection_response:response});},scope:this};var conn=new Ext.data.Connection();conn.request(options);this.show_loading_overlay();},load_prefs:function(data_json)
{var data=Ext.decode(data_json);this.prefs=data.prefs;SG.globals.preferences.quick_jump_entities=this.prefs.quick_jump_entities.value;SG.globals.preferences.hide_from_new_entity_menu=this.prefs.hide_from_new_entity_menu.value.split(/,\s*/);this.pref_groups.entities=['disable_detail_page_for_entities','quick_jump_entities','hide_from_new_entity_menu','has_tasks'];var types=SG.schema.entity_classes_for_display_name_cache.concat(['DisplayColumn','TimeLog']);for(var i=0;i<types.length;i++)
{var type=types[i];this.pref_groups.entities.push('use_'+type.tableize());this.pref_groups.entities.push('display_name_'+type.underscore());}
var all_grouped_pref_keys=[];var groups=['formatting','scheduling','navigation_widget','email','detail_pages','entities','advanced','not_displayed','email_layouts','email_defaults','email_subject_templates','installed_client_advanced','file_management','revolver','revolver_transcoding']
for(var i=0;i<groups.length;i++)
all_grouped_pref_keys=all_grouped_pref_keys.concat(this.pref_groups[groups[i]]);this.pref_groups.other=[];for(var i=0;i<data.sorted_keys.length;i++)
{if(!(all_grouped_pref_keys.indexOf(data.sorted_keys[i])>-1))
this.pref_groups.other.push(data.sorted_keys[i]);}
this.pref_groups.other=this.pref_groups.advanced.concat(this.pref_groups.other);if(this.prefs["use_tank_containers"]&&this.prefs["use_tank_containers"].value=="no"){var idx=this.entity_types_to_show.indexOf("TankContainer");if(idx!==-1)
this.entity_types_to_show.splice(idx,1);}
this.render();},on_click:function(event)
{var t=event.target;if(t.className.indexOf('update')>-1)
{this.save_changed_prefs();return;}
else if(t.className.indexOf('cancel')>-1)
{this.request_prefs();this.feedback='';return;}
else if(t.className.indexOf('opener_span')>-1||t.className.indexOf('arrow')>-1||t.className.indexOf('entity_name')>-1||t.className.indexOf('entity_type_description')>-1)
{this.toggle_opener(t.parentNode);return;}
var entity_name_elem=Ext.get(t).findParent('.entity_name');if(entity_name_elem)
{this.toggle_opener(entity_name_elem.parentNode);return;}
if(t.className.indexOf('opener')>-1)
{this.toggle_opener(t);return;}
else if(t.className.indexOf('radio_label')>-1)
{if(!t.previousSibling.checked)
{t.previousSibling.checked=true;this.set_changed(t);}
return;}},on_change:function(e)
{var target=Ext.get(e.getTarget());var handle=target.findParent('.handle_change');if(handle){if(handle.getAttribute('pref_key')=='support_local_storage')
this.local_storage_container.toggle();this.set_changed(handle);}},set_changed:function(input_dom)
{var pref_row=Ext.get(input_dom).findParentNode("tr",10);pref_row.setAttribute('changed','true');this.set_dirty_message();if(input_dom.className.indexOf('prefs_entity_type_checkbox')>-1)
{var total_elem=sg_find_all('span.opener_span',pref_row);if(total_elem.length>0)
{total_elem=total_elem[0];var checkboxes=sg_find_all("input.prefs_entity_type_checkbox",pref_row);var new_total=0;for(var i=0;i<checkboxes.length;i++)
if(checkboxes[i].checked)
new_total++;total_elem.innerHTML=total_elem.innerHTML.replace(/\d*/,String(new_total));}}},set_dirty_message:function()
{var feedback_elements=sg_find_all("div.sgw_site_prefs span.feedback",this.get_container().dom);for(var i=0;i<feedback_elements.length;i++)
feedback_elements[i].innerHTML='Preferences have been modified. Save by clicking the Save Changes button '+'or <span class="cancel">Clear your changes</span>.';},toggle_opener:function(dom_elem)
{var key=dom_elem.getAttribute('open_key');var parent=Ext.get(dom_elem.parentNode);var index=this.open_sections.indexOf(key);if(index>-1)
{this.open_sections.splice(index,1);parent.replaceClass('open','closed');}
else
{this.open_sections.push(key);parent.replaceClass('closed','open');}
if(key.indexOf('permissions_ui_')==0)
{this.toggle_permissions(key);}},toggle_permissions:function(key)
{var permissions_ui_container=this.get_container().child('div#'+key).dom;var state=permissions_ui_container.getAttribute('state');if(state=='empty')
{permissions_ui_container.setAttribute('state','loading');var entity_type=key.substring(15);this.load_entity_permissions(entity_type);}
else if(state=='closed')
{permissions_ui_container.setAttribute('state','open');}
else
permissions_ui_container.setAttribute('state','closed');},load_entity_permissions:function(entity_type)
{if(!this.current_permissions)
this.current_permissions={};var options={url:'/page/permissions_for_entity_type',params:{entity_type:entity_type},callback:function(options,success,response){if(success){this.current_permissions[entity_type]=Ext.decode(response.responseText);this.update_entity_permissions_ui(entity_type);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},update_entity_permissions_ui:function(entity_type)
{var permissions_ui_container=this.get_container().child('div#permissions_ui_'+entity_type).dom;var permissions_sections=[];var entity_plural=SG.schema.entity_types[entity_type].display_name_pluralized;var permissions=[['see','see',' '],['create','create',' '],['retire','retire',' '],['update_field_generic','edit fields',' on ']];for(var i=0;i<permissions.length;i++)
{permissions_sections.push(this.templates.permissions_ui_checkbox_section.apply({action:permissions[i][1],preposition:permissions[i][2],entity_plural:entity_plural,checkboxes:this.render_entity_permissions_checkboxes(entity_type,permissions[i][0]),}));}
permissions_ui_container.innerHTML=this.templates.entity_permissions_content.apply({checkboxes:permissions_sections.join(''),learn_url:SG.globals.help_urls.permissions,display_name:SG.schema.entity_types[entity_type].display_name,extra_prompt:'Permissions on '+SG.schema.entity_types[entity_type].display_name+' fields are set in the "Configure Field" dialog for each field.'});permissions_ui_container.setAttribute('state','open');},render_entity_permissions_checkboxes:function(entity_type,permission_type)
{var current_permissions=this.current_permissions[entity_type];var checkboxes=[];for(var i=0;i<current_permissions.length;i++)
{var rule_set=current_permissions[i];var allowed=rule_set[permission_type];var exceptions_html='';var restrictions=rule_set[permission_type+"_restricted"];if(restrictions=='special_rules'){restrictions="(Custom)";}else if(restrictions=='not_configurable'){restrictions=' ';exceptions_html='Not Configurable'}else{restrictions='';}
var exceptions=rule_set[permission_type+"_exceptions"];if(!exceptions_html&&exceptions)
{exceptions_html=[];if(exceptions.allow.length>0)
exceptions_html.push("ALLOW "+exceptions.allow.join(", "));if(exceptions.deny.length>0)
exceptions_html.push("DENY "+exceptions.deny.join(", "));exceptions_html="Exceptions: "+exceptions_html.join(", ");}
var template=exceptions_html?'permission_checkbox_with_exceptions':'permission_checkbox';checkboxes.push(this.templates[template].apply({checkbox_id:permission_type+'_'+entity_type+'_permission_'+rule_set.set_id,attributes:(allowed?'checked':'')+(restrictions?' disabled':''),permission_set_name:rule_set.display_name,restricted_note:restrictions,exceptions:exceptions_html,actual_value:allowed}));}
return checkboxes.join('');},save_changed_prefs:function()
{var container=this.get_container();var modified_prefs={};var modified_keys=[];var inputs=sg_find_all('input.prefs_input',container.dom);inputs=inputs.concat(sg_find_all('select.prefs_select',container.dom));var key;var original_value;var current_value;for(var i=0;i<inputs.length;i++)
{key=inputs[i].getAttribute('pref_key');current_value=inputs[i].value;original_value=this.prefs[key].value;if(current_value!=original_value)
{modified_keys.push(key);modified_prefs[key]=current_value;}}
inputs=sg_find_all('input.prefs_input_radio.yes',container.dom);var key;var original_value;var current_value;for(var i=0;i<inputs.length;i++)
{key=inputs[i].getAttribute('pref_key');current_value=inputs[i].checked?'yes':'no';original_value=this.prefs[key].value;if(current_value!=original_value)
{modified_keys.push(key);modified_prefs[key]=current_value;}}
inputs=sg_find_all('input.prefs_entity_type_checkbox',container.dom);var original_entity_type_list;var new_entity_type_list;var key,is_checked,was_checked,entity_type,index,is_modified;for(var i=0;i<this.entity_type_lists.length;i++)
{is_modified=false;key=this.entity_type_lists[i];original_entity_type_list=this.prefs[key].value.split(/\s*,\s*/);new_entity_type_list=sg_deep_copy(original_entity_type_list);for(var j=0;j<inputs.length;j++)
{if(key!=inputs[j].getAttribute('pref_key'))
continue;is_checked=inputs[j].checked;if(this.invert_entity_type_lists.indexOf(key)!==-1)
is_checked=!is_checked;entity_type=inputs[j].getAttribute('entity_type');was_checked=(original_entity_type_list.indexOf(entity_type)>-1);if(is_checked==was_checked)
continue;is_modified=true;if(is_checked)
new_entity_type_list.push(entity_type);else
{index=new_entity_type_list.indexOf(entity_type);new_entity_type_list.splice(index,1);}}
if(is_modified)
{modified_keys.push(key);modified_prefs[key]=new_entity_type_list.join(',');}}
var updated_permissions={};var permissions_with_changes=0;for(var entity_type in this.current_permissions)
{if(!this.current_permissions.hasOwnProperty(entity_type))
continue;updated_permissions[entity_type]={see:[],create:[],retire:[],update_field_generic:[]};var permissions=this.current_permissions[entity_type];for(var i=0;i<permissions.length;i++)
{this.add_updated_permissions(updated_permissions,entity_type,permissions[i],'see');this.add_updated_permissions(updated_permissions,entity_type,permissions[i],'create');this.add_updated_permissions(updated_permissions,entity_type,permissions[i],'retire');this.add_updated_permissions(updated_permissions,entity_type,permissions[i],'update_field_generic');}
if(updated_permissions[entity_type].see.length+updated_permissions[entity_type].create.length+
updated_permissions[entity_type].retire.length+
updated_permissions[entity_type].update_field_generic.length==0)
delete updated_permissions[entity_type];else
permissions_with_changes++;}
var input=sg_find('input[pref_key=support_local_storage]',container.dom);if(input){key='support_local_storage';current_value=input.checked?'yes':'no';original_value=this.prefs[key].value;if(current_value!=original_value)
{modified_keys.push(key);modified_prefs[key]=current_value;}}
var inputs=sg_find_all('textarea.prefs_textarea',container.dom);for(var i=0;i<inputs.length;i++)
{key=inputs[i].getAttribute('pref_key');current_value=inputs[i].value;current_value=current_value.replace('\n','<br>','g');original_value=this.prefs[key].value;if(current_value!=original_value){modified_keys.push(key);modified_prefs[key]=current_value;}}
if(permissions_with_changes>0)
modified_prefs.permissions=updated_permissions;if(modified_keys.length==0&&permissions_with_changes==0&&!this.local_storage_component.dirty)
{this.feedback='Not updated: no preferences were changed.';this.render();return;}
this.validate_modified_prefs(modified_prefs);return;},add_updated_permissions:function(updated_permissions,entity_type,rule_set,permission_type)
{if(!rule_set[permission_type+'_restricted'])
{var checkbox_id=permission_type+'_'+entity_type+'_permission_'+rule_set.set_id;var checkbox=this.get_container().child('input#'+checkbox_id);if(checkbox&&checkbox.dom.checked!=rule_set[permission_type])
updated_permissions[entity_type][permission_type].push([rule_set.code,checkbox.dom.checked]);}},submit_saved_prefs:function(modified_prefs)
{this.show_loading_overlay();modified_prefs.pref_type='site';if(this.local_storage_component.dirty)
this.local_storage_component.save()
if(modified_prefs.permissions)
modified_prefs.permissions=Ext.encode(modified_prefs.permissions);var options={url:'/preferences/update_prefs',params:modified_prefs,callback:function(options,success,response){if(success)
{var response_obj=response.responseText.strip();if(response_obj.length>0)
{response_obj=Ext.decode(response_obj);if(response_obj.error)
{this.feedback=response_obj.error;this.reload_core_stuff();SG.server_error({html_msg:response_obj.error,connection_response:response});return;}
var job=response_obj;var pi=new SG.ProgressIndicator(null,'det','Updating...');if(pi.add_job(job)===false)
{this.update_failed(response);}
else
{pi.show();var me=this;pi.set_post_completion(job,function(){me.update_successful();});pi.start_updates(null,true,response);}}
else
this.update_successful();}
else
this.update_failed(response);},scope:this};var conn=new Ext.data.Connection();conn.request(options);},update_successful:function()
{this.feedback='Site preferences successfully updated.';this.reload_core_stuff();},update_failed:function(response)
{this.feedback='Site preferences update failed.';this.reload_core_stuff();SG.server_error({connection_response:response});},reload_core_stuff:function()
{this.request_prefs();SG.schema.reload_schema({fn:function(){this.render();},scope:this});},cancel_save:function()
{this.modified_prefs=null;this.feedback='Not updated: no preferences were changed.';this.render();},subject_template_re:/([(\[]?)\{([\w\.]*)\}([)\]]?)/g,validate_modified_prefs:function(modified_prefs)
{for(var key in modified_prefs)
{if(!modified_prefs.hasOwnProperty(key))
continue;if(key.indexOf('email_notifications_subject_template_for_')!=0)
continue;if(key.indexOf('password')>-1)
continue;var type=key.substring(41);if(type.indexOf('task')==0)
type='task';type=type.to_class_name();var template=sg_deep_copy(modified_prefs[key]);var schema_fields=SG.schema.entity_fields[type];var invalid_tokens=[];template.replace(this.subject_template_re,function(m0,m1,m2,m3){if(m2!='ENTITY_TYPE'&&!(type=='Task'&&m2=='CHANGED_TASK_FIELDS')&&!schema_fields[m2])
invalid_tokens.push(m2);return'';});if(invalid_tokens.length>0)
{alert('The email subject template for '+SG.schema.entity_types[type].display_name+' has invalid field names or tokens: "'+invalid_tokens.join('", "')+'".');return;}}
if(modified_prefs.hasOwnProperty('hours_per_day'))
{var value=modified_prefs[key];if(String(Math.round(value*60))!=String(value*60))
{alert('The value for "Hours Per Day" is not valid because it is equivalent to '+
(value*60)+' minutes.  It must be equivalent to a round number '+'of minutes to allow for accurate duration calculations.  Valid values '+'end in 0 or 1 decimal '+'places, or end in .15, .25, .35, .45, .55, .65, .75, .85, or .95.');return;}
else if(value<=0||value>24)
{alert('The value for "Hours Per Day" is not valid because it is not greater than 0 and less than 24 hours.');return;}}
if(this.local_storage_component.dirty){var me=this;var success_fn=function(){me.submit_saved_prefs(modified_prefs);};var fail_fn=function(msg){me.hide_loading_overlay();if(msg)
alert(msg);}
this.show_loading_overlay();this.local_storage_component.validate(success_fn,fail_fn);}else{this.submit_saved_prefs(modified_prefs);}},entity_type_descriptions:{Asset:"Used to track the things that have to be built to be used in the project.  "+"We do not mean all the digital files generated on disc, but rather the abstract concepts "+"of things that are built, such as \"characters\", \"vehicles\", \"props\", \"environments\", etc."+"  We use the \"type\" field to distinguish the Assets from each other.  That field is just a list that "+"can be edited by an admin.  Assets have Tasks, which define the work that needs to be done on each "+"asset.  Assets can be linked together via the \"Parent Asset\" and \"Sub Asset\" fields, which are many "+"to many entity links.",AssetLibrary:"Used to group Assets together if you need to store extra meta data on each group.",AssetMocapTakeConnection:"",AssetShootDayConnection:"",Blendshape:"",Camera:"Used to track meta data on cameras, most often for mocap workflows.",CameraMocapTakeConnection:"",Candidate:"Often used for recruiting purposes to track people "+"and meta data about those people.",CustomEntity:"You can rename this custom entity and use it to track whatever type of data you want. "+"This type of custom Entity is associated with a single project. "+"To track entities that DON'T require a project association, use the \"Custom Non Project Entity\" type. "+"Read more in the <a target='_blank' href='"+SG.globals.help_urls.entity_types+"'>"+"documentation</a>.",CustomNonProjectEntity:"You can rename this custom entity and use it to track whatever type of data you want. "+"This type of custom Entity is NOT required to be connected to a single Project. "+"To track entities that DO require a project association, use the \"Custom Entity\" type. "+"Read more in the <a target='_blank' href='"+SG.globals.help_urls.entity_types+"'>"+"documentation</a>.",CustomThreadedEntity:"You can rename this custom entity and use it to track whatever type of data you want. "+"This \"threaded\" custom Entity type has To and CC fields, and supports replies and email notifications. "+"Read more in the <a target='_blank' href='"+SG.globals.help_urls.entity_types+"'>"+"documentation</a>.",Cut:"Tracks information from editorial, usually on Sequences.  "+"You can link multiple Versions to build your Cuts "+"and then track the Cut-specific information (Cut In, Cut Out, Cut Duration, Cut Order, Cut Comments) on "+"the CutVersionConnection.",CutItem:"Organize cut events from editorial, linking specific Versions to Cuts with meta data "+"for in/out/duration/order.  Used in conjunction with Cuts to track versions of cut information "+"on Sequences.  This is mostly used by Feature Animation studios.  Most other studios store only "+"the latest cut information on the shots themselves.",Delivery:"Used to track information about files and other data sent to and from the studio from outside "+"partners and vendors.  Deliveries work a lot like Notes and Tickets, with detail pages that support "+"comments and email notifications.  You can learn more about how to use Deliveries "+"<a target='_blank' href='"+SG.globals.help_urls.deliveries+"'>here</a>.",DeliveryTarget:"",Element:"Used by FX studios to track photographic material that comes from a live action shoot.  "+"Types of Elements would be \"Reference\", \"Plates\", etc.  Some studios opt to use Assets instead "+"of Elements.",DisplayColumn:"",Attachment:"",Group:"Groups are lists of people that are used when assigning Tasks and addressing Notes. A Group can "+"contain 1 or more people, and a person can belong to more then one Group. Deleting a Group "+"doesn't delete the individual members of the Group.",Launch:"Used by some feature animation studios as a way to group shots that will progress "+"together down the pipeline.  Because some shots in Sequences are held back for various "+"scheduling reasons, this provides another way to group the Shots.",MocapPass:"Used by some motion capture studios to organize and schedule parts of the script "+"that will be captured at one time in the mocap volume.",Routine:"Similar to Mocap Passes, some mocap studios use this to break down the script into "+"logical chunks that will be captured at one time in the mocap volume.",MocapSetup:"Tracks information for each set of mocap takes.",MocapTake:"Tracks data recorded in a mocap session on a group of performers per take.  Some "+"studios track a take per Performer, while some track the data for all Performers in the "+"volume at the same time.",MocapTakeRange:"A custom entity used by one mocap studio to track specific frame ranges per Take.",MocapTakeRangeShotConnection:"",Note:"Used to track all the notes take in SG.  Each Note can be addressed To or Cc more then "+"one Person or Group.  Notes can be Linked to more then one Entity, mostly used for Assets, "+"Shots, Versions, and Tasks.  There is a hidden entity called Note Reply that tracks all the "+"replies to any Note.",Performer:"Used to track information about the actors in a mocap shoot.  You can store information "+"like gender, weight, description, thumbnail, etc.  Takes are then linked to the Performer.",PerformerMocapTakeConnection:"",PerformerRoutineConnection:"",PerformerShootDayConnection:"",PermissionRuleSet:"",HumanUser:"Used to store information about an individual account holder in SG. A Person must have "+"a unique login (not case sensitive), and be assigned to a permission group (artist, manager, "+"or admin).",PhysicalAsset:"Created for mocap studios who need to track physical assets used during a capture, "+"often linked to a digital Asset.",PhysicalAssetMocapTakeConnection:"",Playlist:"Used to organize Versions into lists for creative review.  For Playlists to work, the Versions "+"entity must also be turned on.  Versions can then be created for other entities (like Asset and Shot) to "+"track the progress on that entity, submitted by an artist for review.  You can learn more "+"about how to use Playlists and Versions "+"<a target='_blank' href='"+SG.globals.help_urls.playlists+"'>here</a>.",Project:"Most work in Shotgun is organized into Projects.  Every entity has a \"Project\" field that "+"links that entity to the Project.  People can also be linked to more then one Project, which defines "+"permissions and is used to create crew lists.",PublishEvent:"Used to integrate Asset Mangement Systems (AMS) with SG.  For each publish "+"in the AMS, a record can be created in Shotgun to track key meta data.  These records can "+"then be seen in context of the entities tracked in SG.  For example, you can make a \"Publishes\" "+"tab on a Shot detail page that shows all publishes related to each Shot.  Common fields on Publish "+"Events are Person, Comment, Links (entities), and Path.",Release:"Used for software development in conjunction with Tickets to track major milestones.",Revision:"Used to integrate code repository systems, such as Subversion, Perforce, or Git.  "+"Revisions are linked to Tickets.  Integration is accomplished via our API by adding a post "+"check-in hook into your code repository system that talks to Shotgun and creates records "+"for each check-in so they can be seen in context of Tickets.",Scene:"Used in various ways by studios depending on how their nomenclature works.  Mocap studios "+"can use this to track Scenes from a feature film script, which is continuous action in a "+"specific location.  FX studios will sometimes use this to specify a group of Sequences, although "+"some of our clients think about it the other way around and have multiple Scenes in every "+"Sequence (we were suprised to find such a wide useage of this term, even in the same studio).  "+"Of course, people also refer to their \"Scene files\" which are used for Shots!  Use any way "+"you like. ",ApiUser:"Used to generate a Key that your API scripts use to connect and login to your Shotgun instance.  "+"We recommend using 1 Script per script, which allows you to monitor what each script is doing "+"in the event log (handy when there is a rogue script that is pegging the database).",Sequence:"Used to organize Shots into groups, often as part of continuous action across multiple "+"locations (see Scene above).  Shots can be linked to one Sequence, and a Sequence has many "+"Shots.  Assets can be linked to more then one Sequeunce, which is often used by feature "+"animation or mocap studios who break down a script before the Shots are defined by Editorial.",ShootDay:"Built for mocap studios to track information by the calendar day of a shoot.  In theory, "+"this could be used by live action studios as well.  When planning for the future, this entity "+"can be used to make \"call sheet\" like pages.  You can link Scenes to a Shoot Day, and therefore "+"all Assets linked to that Scene can be queried (the list of assets needed on set that day).  "+"You can also link Performers to Shoot Days to define when they are needed on set.  During the "+"shoot, you can link the other mocap entties to the Shoot Day, such as Mocap Takes, Mocap "+"Setups, and Mocap Routines.  It is often desirable to know what Shoot Day a Take was captured on.",ShootDaySceneConnection:"",Shot:"Used to track, well, Shots.  Shots can be linked to one Sequence or Scene and multiple Assets.  "+"Multiple Tasks, Notes, Publish Events, and Versions are linked to Shots.",Slate:"Used to track Slate information from a live action shoot.  The Slates can then be linked to "+"Elements, which are linked to Shots.",Tag:"",TankContainer:"",Task:"Used to track each unit of work that needs to be done as part of a workflow and schedule.  "+"Tasks can be linked to one parent entity in the \"Link\" field, such as an Asset, Shot, or "+"Sequence.  Currently, our schedules are made up of a flat list of Tasks, so there are no "+"subtasks.  But because the Tasks are linked to entities, you can query and display the Tasks "+"in many ways.",TaskTemplate:"Used to predefine sets of Tasks and default values that can be added to other "+"entities at once.  Each Task Template is linked to an Entity that the Tasks are used for.  "+"Those entities then have a \"Task Template\" field that can be edited to apply the linked Tasks.",TemerityNode:"",Ticket:"Used for software development to track features, bugs, and issues (all of which are "+"\"types\").  Tickets can be linked to more then one Release, to Tools, and to other Tickets.  "+"Multiple Revisions and Time Logs can be linked to Tickets.",TimeLog:"Used to track durations of time spent by People working on a Task or Ticket.  A "+"special \"Time Logged\" field on Tasks and Tickets displays the sum of all Time Logs "+"linked to that Task or Ticket. ",Tool:"Used to break down software development work into Projects (or \"application\").  "+"Tickets can be linked to Tools, and Tools can be linked to Releases.",Version:"An iteration of work that is created for review.  Often this is a rendered image "+"sequence that is then turned into a movie file with a slate and burn-in.  We mostly "+"see Versions on Assets and Shots, though we have seen studios link Versions to Scenes "+"(the Layout dept doing work across the entire Scene)."}});SG.Widget.ExternalImage=function(context,widget_spec,id){SG.Widget.ExternalImage.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ExternalImage,SG.Widget.Base,{default_settings:{url:''},templates:{image:'<img src="{url}"/>'},on_first_render:function()
{this.url='';this.container=this.get_container();this.entity=this.context.get('entity');var cfg={entity:this.context.get('entity'),url:this.get('url'),callback:{fn:this.url_resolved,scope:this}};this.url_resolver=new SG.util.URLResolver(cfg);},render_widget:function()
{if(this.url===''){this.container.update('<i>No Image</i>');return;}
this.container.update(this.templates.image.apply({url:this.url}));},url_resolved:function(url)
{this.url=url;this.render_widget();}});SG.Widget.OneLineFields=function(context,widget_spec,id){SG.Widget.OneLineFields.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.OneLineFields,SG.Widget.Base,{default_settings:{columns:[]},templates:{body:'<div class="left"><table class="one_line"><tr>{left}</tr></table></div>'+'<div class="right"><table class="one_line"><tr>{right}</tr></table></div>',label:'<td><div class="label">{display_name}</div></td>',value:'<td style="{cell_styles}" class="{cell_classes}" {cell_attributes}>{cell_content}</td>'},on_first_render:function()
{this.container=this.get_container();this.entity=this.context.get('entity');this.entity_set=this.new_data_set(this.entity.type,this.render_widget);var cell_config={container:this.container,data_set:this.entity_set,projects:this.context_projects()};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.request_data();},render_widget:function()
{if(!this.entity_set.is_loaded()){this.container.update('');return;}
var column_settings=this.get('columns');var fields=this.extract_fields_from_column_settings();var i,left,right,s;left='';right='';for(i=0;i<column_settings.length;i++){s=column_settings[i];if(fields.indexOf(s.field)===-1)
continue;if(s.position==='left')
left+=this.render_field(s);else
right+=this.render_field(s);}
this.container.update(this.templates.body.apply({left:left,right:right}));},render_field:function(field_hash)
{var html='';var cell_config={detail_link:this.is_detail_link(field_hash)};var cell=this.cell_manager.get_cell(field_hash.field,cell_config);if(field_hash.show_label)
{html+=this.templates.label.apply({display_name:cell.get_field_display_name()});}
html+=this.templates.value.apply(cell.render(this.entity_set.get_record(0)));return html;},is_detail_link:function(field_hash)
{if(field_hash.detail_link!=undefined)
return field_hash.detail_link;else
return false;},extract_fields_from_column_settings:function()
{var ret=[];var column_settings=this.get('columns');for(var i=0;i<column_settings.length;i++)
{var field_hash=column_settings[i];var schema_for_field=SG.schema.get_field(this.entity.type,field_hash.field);if(schema_for_field!=undefined)
ret.push(field_hash.field);}
return ret;},request_data:function()
{var spec={type:this.entity.type,id:this.entity.id,columns:this.extract_fields_from_column_settings(),result:this.entity_set,parent_entity:this.context.get('parent_entity')};SG.Repo.find(spec);},});SG.Widget.Divider=function(context,widget_spec,id){SG.Widget.Divider.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Divider,SG.Widget.Base,{default_settings:{mode:'title',text:'New Divider',bgcolor:'255,255,255',textcolor:'0,0,0'},templates:{hr:'<div class="hr"><hr/></div>',title:'<div class="title" style="{bgcolor}{textcolor}">{text}</div>'},on_first_render:function()
{this.container=this.get_container();this.mode=this.get('mode');},render_widget:function()
{var h;if(this.mode=='hr'){h=this.templates.hr.apply();}else if(this.mode=='title'){var cfg={text:this.get('text')||'&nbsp;',bgcolor:'background-color: rgb('+this.get('bgcolor')+');',textcolor:'color: rgb('+this.get('textcolor')+');'}
h=this.templates.title.apply(cfg);}
this.container.update(h);}});SG.Widget.Activity=function(context,widget_spec,id){SG.Widget.Activity.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Activity,SG.Widget.Base,{default_settings:{filters:{logical_operator:'and',conditions:[]},sorts:[{column:'created_at',direction:'desc'}],records_per_page:10},templates:{table:'<div>{rows}</div>',row:'<div style="padding-bottom: 5px; font-size: 10px">{event}</div>'},init_widget:function()
{this.data_set=this.new_data_set('EventLogEntry',this.render_widget);},on_first_render:function()
{this.container=this.get_container();this.request_data();},render_widget:function()
{var rows,rec,ev,i;if(!this.data_set.is_loaded())
return;if(this.data_set.count()===0){this.container.update('<i>No Events</i>');return;}
rows='';for(var i=0;i<this.data_set.count();i++)
{rec=this.data_set.get_record(i);rows+=this.templates.row.apply({event:rec.get('description')});}
this.container.update(this.templates.table.apply({rows:rows}));},get_filters:function()
{var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);return filters;},request_data:function()
{var spec={type:'EventLogEntry',filters:this.get_filters(),sorts:this.get('sorts'),columns:['description'],current_page:1,records_per_page:this.get('records_per_page'),result:this.data_set};SG.Repo.query(spec);}});SG.Widget.Collection=function(context,widget_spec,id)
{SG.Widget.Collection.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Collection,SG.Widget.Base,{default_settings:{entity_type:'Note',filters:{logical_operator:'and',conditions:[]},sorts:[{column:'created_at',direction:'desc'}],records_per_page:5,show_border:false,bgcolor:''},templates:{main:'{qb}{items}{paging}',item:'<div class="sgw_collection_item {item_class} {border}" id="{item_id}" style="{bgcolor}"></div>',paging:'<center><div class="paging {left_cls}" page="{prev_page}"></div>'+'<div class="paging">{count}</div>'+'<div class="paging {right_cls}" page="{next_page}"}></div></center>',qb:'<div class="filters"></div>',no_results_message:'{qb}{message}',},init_widget:function()
{this.entity_type=this.get('entity_type');this.ident=SG.schema.get_identifier_field(this.entity_type);this.items=[];},init_children:function()
{},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.data_set=this.new_data_set(this.entity_type,this.on_data_load);this.current_page=1;this.read_data();},render_widget:function()
{if(!this.data_set.is_loaded()){this.container.update('Loading...');return;}
this.teardown();if(this.data_set.count()===0){var disp=SG.schema.entity_types[this.entity_type].display_name_pluralized;var msg='<i>No '+disp+'</i>';if(this.widget_spec.child_specs["prototype"].type=="SG.Widget.Assignment"){msg="<i>You don't have any open Tasks assigned to you.  If you did, you would see "+"cards here with Task info, along with a thumbnail, Notes, and links to get more details.</i>";}
var qb_html='';if(this.context.get('edit_mode'))
qb_html=this.templates.qb.apply();var html=this.templates.no_results_message.apply({qb:qb_html,message:msg});this.container.update(html);if(qb_html!='')
this.construct_and_render_query_builder();return;}
var item_context,item_rec,item_inst;var i;var items_html='';var paging_html='';var show_border=this.get('show_border');var bgcolor=this.get('bgcolor');for(i=0;i<this.data_set.count();i++){item_rec=this.data_set.get_record(i);item_context=this.context.clone();item_entity={type:this.entity_type,id:item_rec.get_id(),name:item_rec.get(this.ident)}
item_context.set('entity',item_entity);if(item_rec.get('project')){item_context.set('entity_project',item_rec.get('project'));}
item_inst=this.construct_child('prototype',item_context);items_html+=this.templates.item.apply({item_class:item_inst.get_css_class_name()+" loading",item_id:item_inst.get_container_id(),border:show_border?'border':'',bgcolor:bgcolor?'background-color: '+bgcolor+';':''});this.items.push(item_inst);}
if(this.data_set.paging_info.page_count>1)
paging_html=this.render_paging();var qb_html=this.render_query_builder();var html=this.templates.main.apply({qb:qb_html,items:items_html,paging:paging_html});this.container.update(html);if(qb_html!='')
this.construct_and_render_query_builder();var coll=this;window.setTimeout(function(){coll.render_items()},0);},render_query_builder:function(){if(!this.context.get('edit_mode'))
return'';return this.templates.qb.apply();},construct_and_render_query_builder:function(){if(this.qb_component)
this.qb_component.destroy();this.qb_component=new SG.Widget.EntityQuery.QueryBuilder({floating:false,filters:this.get_filters_for_qb(),container:this.container.child('div.filters'),entity_type:'Task',context_projects:this.context_projects(),widget:this,callback:{fn:this.condition_changed,scope:this}});this.qb_component.render();},get_filters_for_qb:function()
{var filters=this.get('filters');this.refresh_token_entities_in_filters(filters);return{logical_operator:'and',conditions:[filters.conditions[0],filters.conditions[1]]};},condition_changed:function(new_filters){var filters=sg_deep_copy(new_filters);filters.conditions.push({active:true,path:'entity',relation:'is_not',values:[null]});filters.conditions.push({active:true,path:'step.Step.code',relation:'is_not',values:[null]});this.set('filters',filters);this.read_data();},teardown:function()
{this.destroy_children();this.items=[];if(this.qb_component)
this.qb_component.destroy();this.container.update('');},render_items:function()
{for(var i=0;i<this.items.length;i++){this.items[i].get_container().removeClass('loading');this.items[i].render();}},render_paging:function()
{var cfg={};var pg=this.data_set.paging_info;cfg.left_cls=pg.current_page===1?'left_arrow_disabled':'left_arrow active';cfg.right_cls=pg.current_page===pg.page_count?'right_arrow_disabled':'right_arrow active';cfg.prev_page=pg.current_page-1;cfg.next_page=pg.current_page+1;cfg.count='Page '+pg.current_page+' / '+pg.page_count;return this.templates.paging.apply(cfg);},get_filters:function()
{var filters=sg_deep_copy(this.get('filters'));var ctx_filters=sg_deep_copy(this.context.get('filters'));if(ctx_filters){filters={logical_operator:"and",conditions:[ctx_filters,filters]};}
this.substitute_filter_tokens(filters);return filters;},read_data:function()
{var spec={type:this.entity_type,filters:this.get_filters(),sorts:this.get('sorts'),columns:[],current_page:this.current_page,records_per_page:this.get('records_per_page'),result:this.data_set}
SG.Repo.query(spec);},on_data_load:function()
{this.render_widget();},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.findParent('div.paging.active')){e.stopEvent();this.current_page=Number(t.dom.getAttribute('page'));this.read_data();}},destroy_widget:function(){if(this.qb_component)
this.qb_component.destroy();},});SG.Widget.TaskActivity=function(context,widget_spec,id){SG.Widget.TaskActivity.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.TaskActivity,SG.Widget.Base,{default_settings:{filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Task']},{path:'attribute_name',relation:'is_not',values:[null]},{path:'entity.Task.task_assignees',relation:'is',values:[{type:"HumanUser",id:0,name:"Me",valid:"logged_in_user_token"}]}]},sorts:[{column:'created_at',direction:'desc'}],records_per_page:10,grouping_delta:60},templates:{entry:'<div class="entry"><table><tr>'+'<td class="thumb" {thumb_attrs}><div class="empty"></div></td>'+'<td class="body">{body}</td></tr>'+'</table></div>',},req_cols:['entity','entity.Task.entity','user','created_at','attribute_name','meta','description'],init_widget:function()
{this.data_set=this.new_data_set('EventLogEntry',this.on_data_load);this.thumb_sets={};},get_filters:function()
{var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);return filters;},request_data:function()
{if(!SG.schema.can_see_entity_type('EventLogEntry')){this.container.update("<b>You don't have permission to see event log entries.</b>");return;}
this.container.update('<i>Loading...</i>');var spec={type:'EventLogEntry',filters:this.get_filters(),sorts:this.get('sorts'),columns:this.req_cols,current_page:1,records_per_page:this.get('records_per_page'),result:this.data_set};SG.Repo.query(spec);},request_thumbnails:function()
{var i,rec,spec,task_entity,et;var thumb_entities={};for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);task_entity=rec.get('entity');if(task_entity){thumb_entities[task_entity.type]=thumb_entities[task_entity.type]||[];thumb_entities[task_entity.type].push(task_entity.id);}}
SG.Repo.start_batch();for(et in thumb_entities){if(!thumb_entities.hasOwnProperty(et))
continue;if(!this.thumb_sets.hasOwnProperty(et))
this.thumb_sets[et]=this.new_data_set(et,this.render_thumbnails);spec={type:et,ids:thumb_entities[et],columns:['image'],result:this.thumb_sets[et]};SG.Repo.find(spec);}
SG.Repo.end_batch();},on_data_load:function()
{this.request_thumbnails();this.render_widget();},on_first_render:function()
{this.container=this.get_container();this.request_data();},render_widget:function()
{var rows,rec,html,i;if(!this.data_set.is_loaded())
return;if(this.data_set.count()===0){this.container.update('<i>There have been no updates to Tasks assigned to you.</i>');return;}
html='';var i;var groups=[];var last_group=[this.data_set.get_record(0)];for(i=1;i<this.data_set.count();i++)
{rec=this.data_set.get_record(i);last_group=this.add_to_group(rec,last_group,groups);}
groups.push(last_group);for(i=0;i<groups.length;i++)
html+=this.render_entries(groups[i]);this.container.update(html);},add_to_group:function(rec,last_group,groups)
{var first_rec=last_group[0];var first_entity=first_rec.get('entity');var first_created_at=Date.sgParseDateTime(first_rec.get('created_at')).getTime();var entity=rec.get('entity');var created_at=Date.sgParseDateTime(rec.get('created_at')).getTime();var grouping_delta=Number(this.get('grouping_delta'))*1000;if(entity&&first_entity&&first_entity.id==entity.id&&created_at<(first_created_at+grouping_delta))
{last_group.push(rec);return last_group;}
else
{groups.push(last_group);var new_group=[rec];return new_group;}},render_entries:function(recs)
{var rec=recs[0];var body='';var event_entity=rec.get('entity');var task_entity=rec.get('entity.Task.entity');var thumb_attrs='';if(task_entity&&task_entity.hasOwnProperty('status'))
delete task_entity.status;if(event_entity.hasOwnProperty('status'))
delete event_entity.status;if(task_entity){body+="<span>"+SG.Renderers.entity.render(task_entity);body+=" / "+SG.Renderers.entity.render(event_entity)+"</span><br>";}else{body+="<span>"+SG.Renderers.entity.render(event_entity)+"</span><br>";}
thumb_attrs='entity="'+event_entity.type+'_'+event_entity.id+'"';for(var i=0;i<recs.length;i++)
{var sf=SG.schema.get_field('Task',recs[i].get('attribute_name'));if(!sf)
continue;body+=this.render_event(recs[i],sf);}
body+='<span class="time">';body+=SG.Renderers.friendly_date_time.render(rec.get('created_at'));body+=' by '+rec.get('user').name;body+='</span>';return this.templates.entry.apply({body:body,thumb_attrs:thumb_attrs});},render_event:function(rec,sf)
{var meta=rec.get('meta');var html='';html+='<span class="field">'+sf.display_name+'</span> changed';if(meta.added!=undefined||meta.removed!=undefined)
return html+'. '+this.render_multi_entity_event(meta);var renderer=this.get_renderer(sf);html+=' from ';var o=renderer.render(meta.old_value,sf,rec);if(!o)o='<i>empty</i>';html+='<i>'+o+'</i>';html+=' to ';var n=renderer.render(meta.new_value,sf,rec);if(!n)n='<i>empty</i>';html+=n+'<br>';return html;},render_multi_entity_event:function(meta)
{var links,i,html='';if(meta.added&&meta.added.length>0){links=[];for(i=0;i<meta.added.length;i++){links.push(SG.Renderers.entity.render(meta.added[i]));}
html+='Added: '+links.join(', ');}
if(meta.removed&&meta.removed.length>0){links=[];for(i=0;i<meta.removed.length;i++){links.push(SG.Renderers.entity.render(meta.removed[i]));}
if(html)
html+=', ';html+='Removed: '+links.join(', ');}
return html;},render_thumbnails:function(ds)
{var i,j,sel,rec,els,thumb,val;for(i=0;i<ds.count();i++){rec=ds.get_record(i);val=rec.get('image');if(!val)continue;sel='td[entity='+ds.type+'_'+rec.get_id()+']';els=sg_find_all(sel,this.container.dom);if(els.length){thumb=SG.Renderers.image.render(val);for(j=0;j<els.length;j++){els[j].innerHTML=thumb;}}}},get_renderer:function(schema_field)
{var def=SG.Renderers.renderer_defaults[schema_field.data_type]||'text';if(schema_field.name=='tag_list')
def="text";else if(schema_field.name=='step')
def="basic_entity";return SG.Renderers[def];}});SG.Widget.NewEntityWidget=function(context,widget_spec,id){SG.Widget.NewEntityWidget.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NewEntityWidget,SG.Widget.Base,{default_settings:{defaults:{},},templates:{main:'<div class="title"><span class="title_text">{title_text}</span></div>',},init_widget:function()
{},on_first_render:function()
{this.entity_type=this.get_entity_type();this.container=this.get_container();var edn=SG.schema.entity_types[this.entity_type]['display_name'];if(this.entity_type=='DisplayColumn')
this.render_cannot_create_fields_message();else if(this.entity_type=='Booking')
this.render_cannot_create_booking_message();else if(SG.schema.can_create_entity(this.entity_type)){this.add_event(this.container,'click',this.on_container_click);this.container.update(this.templates.main.apply({title_text:'Create New '+edn}));this.create_new_entity_form();}else{this.render_lack_of_permissions_message(edn);}},render_lack_of_permissions_message:function(edn)
{var message='You do not have sufficient permissions to create a '+edn+'.';this.container.update('<div class="can_not_create_message">'+message+'</div>');},render_cannot_create_fields_message:function()
{var message='You can not create a new Field here. Fields can only be created using the '+'grid column header menu item "Add New Field To entity..."';this.container.update('<div class="can_not_create_message">'+message+'</div>');},render_cannot_create_booking_message:function(){var message='You can not create a new Booking here. Bookings can only be created using the '+'Crew Planning App.';this.container.update('<div class="can_not_create_message">'+message+'</div>');},on_container_click:function(e)
{var t=Ext.get(e.getTarget());var create_button=t.findParent('input[name="create"]',this.container);if(create_button)
{var me=this;setTimeout(function(){if(me.new_entity_form.creating_now)
me.show_loading_overlay();},50);}},render_widget:function()
{},on_entity_created:function(recs)
{this.create_new_entity_form();},on_form_canceled:function(e)
{this.create_new_entity_form();this.form_div.animate({backgroundColor:{from:'#00FF00',to:'#E9E9E9'}},0.5,function(){this.form_div.dom.style.backgroundColor='#E9E9E9';},'easeOut','color');},create_new_entity_form:function()
{this.hide_loading_overlay();this.form_div=Ext.DomHelper.append(this.container,{tag:'div',klass:'form'},true);if(this.new_entity_form)
{this.remove_event(this.new_entity_form,"entity_created",this.on_entity_created);this.remove_event(this.new_entity_form,"form_canceled",this.on_form_canceled);}
var page=this.get_page();var nef_config={entity_type:this.entity_type,single_project:this.single_project_from_context(),all_projects:this.context_projects(),container:this.form_div,source_record:this.get_data_record_with_defaults(),entity_field_pref:'new_entity',hide_project_selector:false,cancel_button_text:'Clear',configure_only:page.is_default};this.new_entity_form=sg_new_entity_dialog(nef_config);this.add_event(this.new_entity_form,"entity_created",this.on_entity_created);this.add_event(this.new_entity_form,"form_canceled",this.on_form_canceled);},get_data_record_with_defaults:function()
{var rec=new SG.Data.Record(this.entity_type);var defaults=this.get('defaults');for(var field_name in defaults)
{if(!defaults.hasOwnProperty(field_name))
continue;var schema_field=SG.schema.get_field(this.entity_type,field_name);if(!schema_field)
continue;rec.set(field_name,defaults[field_name]);}
return rec;},get_entity_type:function()
{var entity_type=this.get('entity_type');if(!entity_type)
{var entity=this.context.get('entity');if(entity&&entity.type)
return entity.type;else
return'HumanUser';}
else
return entity_type;},});SG.Widget.Permissions=function(context,widget_spec,id)
{SG.Widget.Permissions.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Permissions,SG.Widget.Base,{default_settings:{},templates:{widget:'<div class="sgw_permissions"><div class="page_title">Permissions</div>'+'<div class="permissions_page_info">This page contains a list of the different permission roles '+'available, a read-only summary of their current settings, and options to change some of the '+'permissions.  Permissions can also be '+'changed on fields in the "configure field" dialog and on Entities in the Site Preferences. '+'Learn more about permissions '+'<a href="'+SG.globals.help_urls.permissions+'" target="_blank">here</a>.</div>'+'{top_controls}{permissions}{bottom_controls}</div>',controls:'<div class="controls"><button class="update">Save Changes</button>'+'<span class="feedback">{feedback}</span>{new_role}</div>',new_role:'<div class="plus_role"><div class="left_plus"></div>'+'New Permission Role<div class="right_plus"></div></div>',permission_group:'<div class="permission_group {open_closed}" set_id="{set_id}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<span class="group_title opener_span">{title}</span></div>'+'<div class="gear"><div class="gear_menu_nobg"></div></div>'+'<div class="content sections {open_key}">'+'{sections}</div></div>',section:'<div class="permission_group_section {open_closed}">'+'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div>'+'<span class="group_title opener_span">{title}</span></div>'+'<div class="content {open_key}">{content}'+'</div></div>',permission_summary:'<table>{permissions}</table><div class="content_overlay">&nbsp;</div>',permission_line:'<tr><td class="rule_description">{description}:</td><td>{details}</td></tr>',rule_parameter_subgroup:'<span class="rule_action {action_type}">{action_text}</span> {parameters} ',conditional_rule_parameters:'<span class="rule_action condition">CONDITION ON</span> {parameters} '+'<div class="rule_condition">{condition}</div>',blank_line:'<tr><td class="rule_description">&nbsp;</td><td>&nbsp;</td></tr>',advanced_permissions_content:'{checkboxes}<div class="content_overlay">&nbsp;</div>',advanced_permission_checkbox:'<div class="permissions_ui_checkbox {extra_classes} checkbox_selection_area"'+'rule_set_code="{rule_set_code}" rule_type="{rule_type}" actual="{actual}" >'+'{checkbox}'+'<label for="{checkbox_id}" sg_tip="{description}">{permission_set_name}</label>'+'<span class="restricted_note"> {restricted_note}</span>'+'</div>',entity_permissions_content:'<div class="entity_permissions"><table>{checkbox_rows}</table></div>'+'<div class="content_overlay">&nbsp;</div>',entity_field_permissions_content:'<div class="entity_permissions entity_field_permissions">'+'<table>{checkbox_rows}</table></div>'+'<div class="content_overlay">&nbsp;</div>',checkbox_subsection_opener:'<div class="opener" open_key="{open_key}"><div class="arrow">&nbsp;</div></div>',multi_checkbox_row:'<tr><td class="checkbox_subsection_opener {open_closed}">{opener}</td>'+'<td class="entity_name" {status_attr}>{entity_display_name}</td>{checkbox_cells}</tr>',checkbox_cell:'<td sg_tip="{tooltip}" class="{extra_classes} checkbox_selection_area"'+'rule_set_code="{rule_set_code}" rule_type="{rule_type}" entity_type="{entity_type}" '+'field_name="{field_name}" status="{status}" actual="{actual}" >'+'{checkbox}'+'<label for="{checkbox_id}" '+'>{rule_type_name}</label></td>',reset_to_defaults_content:'<div>'+'<div class="permissions_reset_controls">'+'<select class="permissions_reset_select" rule_set_code="{rule_set_code}">{options}</select>'+'<button type="button" rule_set_code="{rule_set_code}">Reset</button></div>'+'<div class="permissions_reset_prompt">Choose a default set and click the Reset button.  '+'But please note, this action is saved '+'immediately and cannot be reverted.  So please be careful!  Here is a summary of the defaults for '+'the <b>{role_name}</b> role:</div>'+'<div class="permissions_reset_default_summary">{summary}</div>'+'</div>',option:'<option value="{value}" {attributes}>{name}</option>',status:'<div class="permissions_status_icon_container">{icon}</div>{name}',status_value_rows:'<tbody class="status_value_rows {open_closed}" id="{open_key}">{checkbox_rows}</tbody>'},rule_type_order:['create_entity',null,'see_entity','see_entity_condition','see_assigned_projects_only','see_tasks_with_no_project','see_field',null,'update_field','update_field_condition',null,'retire_entity','retire_entity_condition',null,'admin_ui_access','import_csv','save_as_project_page','save_shared_page','save_home_page','cannot_see_globalnav','hide_other_in_project_nav'],ui_rule_descriptions:{save_as_project_page:'"Save as" Project Pages',save_shared_page:'"Save" Shared Pages',save_home_page:'Can Design and Save Home Page',admin_ui_access:"Use Admin Options",set_permissions:"Set Permissions",edit_global_formatting:"Edit Global Formatting",see_assigned_projects_only:"See Assigned Projects Only",see_tasks_with_no_project:"See Non-Project Tasks",cannot_see_globalnav:"Hide Global Nav",hide_other_in_project_nav:"Hide 'Other' menu in Project Nav",revolver_without_watermarking:"Hide Watermarking in Revolver Web Player"},advanced_permission_descriptions:{admin_ui_access:"This checkbox preference only gives access to admin UI options. Full access to admin "+"functionality (eg: unretiring entities) may require specific permissions adjustments on a "+"per-entity basis.",save_shared_page:"This checkbox preference requires that the 'Use Admin Options' preference is also checked.",set_permissions:"This checkbox preference requires that the 'Use Admin Options' preference is also checked.",see_assigned_projects_only:"People will only see Projects they are assigned, including all data linked to "+"those Projects. To assign a person to a Project, edit the 'Projects' field on People, or the 'People' "+"field on Projects.",see_tasks_with_no_project:"If a Person is restricted to only see Projects they are assigned, this "+"option creates an exception that allows them to see all Tasks that are not linked to a Project.",cannot_see_globalnav:"When 'Hide Global Nav ' is checked, people will not be able to "+"see or use the navigation bar controls at the top of the page. They will only be able to see "+"their Shotgun Home page, pages they can link to from the Home page, or pages they know the url for.",hide_other_in_project_nav:"In the Project nav bar, don't show people the 'Other' menu."},hidden_advanced_rule_types:[],init_widget:function()
{this.open_sections=[];this.rule_set_entity_type=window.location.hash?window.location.hash.substring(1):'HumanUser';if(!SG.globals.preferences.enable_revolver||!SG.globals.preferences.enable_revolver_watermarking)
this.hidden_advanced_rule_types.push('revolver_without_watermarking');SG.Checkbox.on('change',this.on_checkbox_change,this);this.summary_set=new SG.Data.SummarySet();this.add_event(this.summary_set,'load',this.on_summary_load);},on_first_render:function()
{this.add_event(this.get_container(),'click',this.on_click,this);this.add_event(this.get_container(),'change',this.on_change,this);},render_widget:function()
{if(!this.permissions)
{this.show_loading_overlay();this.get_container().update(this.templates['widget'].apply({}));this.request_summary_permissions();return;}
var html=this.templates['widget'].apply({permissions:this.render_groups(),top_controls:this.templates['controls'].apply({new_role:this.templates['new_role'].apply({})}),bottom_controls:this.templates['controls'].apply({})});this.get_container().update(html);this.hide_loading_overlay();},render_groups:function()
{var groups=[];for(var i=0;i<this.permissions.length;i++)
{var set=this.permissions[i];groups.push(this.render_group(set));}
return groups.join('');},render_group:function(permission_rule_set)
{var is_open=this.open_sections.indexOf(permission_rule_set.code)>-1;var sections=[];sections.push(this.render_summary(permission_rule_set));if(this.rule_set_entity_type.indexOf('PermissionRuleSet'==-1))
{sections.push(this.render_entity_types(permission_rule_set));sections.push(this.render_fields(permission_rule_set));sections.push(this.render_advanced(permission_rule_set));sections.push(this.render_reset_to_defaults(permission_rule_set));}
return this.templates['permission_group'].apply({title:permission_rule_set.display_name,open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(permission_rule_set.code),set_id:permission_rule_set.set_id,sections:sections.join('')});},html_key_from_code:function(permission_rule_set_code){return"p___"+permission_rule_set_code;},code_from_html_key:function(html_key){if(html_key.substring(0,4)=='p___')
return html_key.substring(4);else
return html_key;},render_fields:function(permission_rule_set)
{var open_key=permission_rule_set.code+"_fields";var is_open=this.open_sections.indexOf(open_key)>-1;var entity_types_to_show=SG.schema.get_entity_types_for_permissions();for(var i=0;i<entity_types_to_show.length;i++)
entity_types_to_show[i]=[entity_types_to_show[i],SG.schema.entity_types[entity_types_to_show[i]].display_name];entity_types_to_show.sort(function(x,y){x=x[1].toUpperCase();y=y[1].toUpperCase();if(x>y)
return 1;if(x<y)
return-1;return 0;});var sections=[];for(var i=0;i<entity_types_to_show.length;i++)
{var inner_open_key=open_key+"_"+entity_types_to_show[i][0];sections.push(this.templates['section'].apply({title:entity_types_to_show[i][1],open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(inner_open_key),content:"Loading...",}));}
return this.templates['section'].apply({title:'Field Permissions',open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(open_key),content:sections.join('')});},render_entity_types:function(permission_rule_set)
{var open_key=permission_rule_set.code+"_entities";var is_open=this.open_sections.indexOf(open_key)>-1;return this.templates['section'].apply({title:'Entity Permissions',open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(open_key),content:'Loading...'});},render_advanced:function(permission_rule_set)
{var open_key=permission_rule_set.code+"_advanced";var is_open=this.open_sections.indexOf(open_key)>-1;return this.templates['section'].apply({title:'Advanced',open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(open_key),content:'Loading...'});},render_reset_to_defaults:function(permission_rule_set)
{var open_key=permission_rule_set.code+"_reset";var is_open=this.open_sections.indexOf(open_key)>-1;return this.templates['section'].apply({title:'Reset to Defaults',open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(open_key),content:'Loading...'});},render_summary:function(permission_rule_set)
{var open_key=permission_rule_set.code+"_summary";var is_open=this.open_sections.indexOf(open_key)>-1;return this.templates['section'].apply({title:'Summary',open_closed:is_open?'open':'closed',open_key:this.html_key_from_code(open_key),content:this.render_summary_content(permission_rule_set)});},render_summary_content:function(permission_rule_set)
{var rule_groups=permission_rule_set.rule_groups;var rules_html=[];for(var j=0;j<this.rule_type_order.length;j++)
{var rule_type=this.rule_type_order[j];if(rule_type==null)
{rules_html.push(this.templates['blank_line'].apply({}));}
else
{for(var i=0;i<rule_groups.length;i++)
{if(rule_type==rule_groups[i].rule_type)
rules_html.push(this.render_rule_group(rule_groups[i]));}}}
var extra_rules=[];for(var i=0;i<rule_groups.length;i++)
{if(this.rule_type_order.indexOf(rule_groups[i].rule_type)==-1)
extra_rules.push(this.render_rule_group(rule_groups[i]));}
if(extra_rules.length>0)
{rules_html.push(this.templates['blank_line'].apply({}));rules_html=rules_html.concat(extra_rules);}
return this.templates.permission_summary.apply({permissions:rules_html.join('')});},render_rule_group:function(rule_group)
{switch(rule_group.parameter_names.length)
{case 0:return this.render_simple_rule_group(rule_group);break;case 1:return this.render_simple_rule_group(rule_group);break;default:return this.render_multi_parameter_rule_group(rule_group);break;}},render_simple_rule_group:function(rule_group)
{var lines=[];var lines_with_null_parameter=[];for(var i=0;i<rule_group.rules.length;i++)
{var rule=rule_group.rules[i];var details;if(rule.retrieve_value)
{details=this.templates['conditional_rule_parameters'].apply({parameters:rule.parameter_1?rule.parameter_1:'*',condition:rule.retrieve_value});}
else
{var action=rule.allow?'allow':'deny';details=this.templates['rule_parameter_subgroup'].apply({action_type:action,action_text:action.toUpperCase(),parameters:rule.parameter_1?rule.parameter_1:'*'});}
var line=this.templates['permission_line'].apply({description:rule_group.rule_type_name,details:details});if(!rule.parameter_1)
lines_with_null_parameter.push(line);else
lines.push(line);}
return lines_with_null_parameter.join('')+lines.join('');},render_multi_parameter_rule_group:function(rule_group)
{var parameter_sets=[];var null_parameter_set=null;var parameter_1="NO RULE HERE. NOPE.";var parameter_set=null;for(var i=0;i<rule_group.rules.length;i++)
{var rule=rule_group.rules[i];if(parameter_1!=rule.parameter_1)
{parameter_1=rule.parameter_1;parameter_set={parameter_1:parameter_1,allow_rules:[],deny_rules:[],conditional_rules:[]}
if(parameter_1)
parameter_sets.push(parameter_set);else
null_parameter_set=parameter_set;}
if(rule.retrieve_value)
{parameter_set.conditional_rules.push(rule);parameter_1="NO RULE HERE. NOPE.";}
else if(rule.allow)
parameter_set.allow_rules.push(rule);else
parameter_set.deny_rules.push(rule);}
var lines=[];if(null_parameter_set)
lines.push(this.render_multi_parameter_rules_subset(rule_group.rule_type_name,null_parameter_set));for(var i=0;i<parameter_sets.length;i++)
{lines.push(this.render_multi_parameter_rules_subset(rule_group.rule_type_name,parameter_sets[i]));}
return lines.join('');},render_multi_parameter_rules_subset:function(rule_type_name,parameter_set)
{var description=rule_type_name+" "+(parameter_set.parameter_1?parameter_set.parameter_1:"*");description=description.replace(/ /g,"&nbsp;");if(parameter_set.conditional_rules.length>0)
{var rule=parameter_set.conditional_rules[0];var value=rule.parameter_2||'*';if(rule.parameter_3)
value+="."+rule.parameter_3;var details=this.templates['conditional_rule_parameters'].apply({parameters:value,condition:rule.retrieve_value});return this.templates['permission_line'].apply({description:description,details:details});}
else
return this.templates['permission_line'].apply({description:description,details:this.render_field_rule_parameter_values(parameter_set)});},render_field_rule_parameter_values:function(parameter_set)
{var allow=[];var deny=[];var value=null;for(var i=0;i<parameter_set.allow_rules.length;i++)
{value=parameter_set.allow_rules[i].parameter_2||'*';if(parameter_set.allow_rules[i].parameter_3)
value+="."+parameter_set.allow_rules[i].parameter_3;allow.push(value);}
for(var i=0;i<parameter_set.deny_rules.length;i++)
{value=parameter_set.deny_rules[i].parameter_2||'*';if(parameter_set.deny_rules[i].parameter_3)
value+="."+parameter_set.deny_rules[i].parameter_3;deny.push(value);}
value='';if(allow.length>0)
value+=this.templates['rule_parameter_subgroup'].apply({action_type:'allow',action_text:'ALLOW',parameters:allow.join(', ')});if(deny.length>0)
value+=this.templates['rule_parameter_subgroup'].apply({action_type:'deny',action_text:'DENY',parameters:deny.join(', ')});return value;},on_click:function(event)
{var t=event.target;if(t.className.indexOf('entity_name')>-1&&t.hasAttribute('status_opener'))
{this.toggle_opener(t.previousSibling.firstChild);}
else if(t.className.indexOf('opener_span')>-1||t.className.indexOf('arrow')>-1||t.className.indexOf('entity_name')>-1||t.className.indexOf('entity_type_description')>-1)
{if(t.parentNode.className.indexOf('opener')>-1)
this.toggle_opener(t.parentNode);}
else if(t.className.indexOf('opener')>-1)
{this.toggle_opener(t);}
else if(t.className.indexOf('gear')>-1)
{this.show_gear_menu(event);}
else if(t.nodeName=='BUTTON'&&t.className=='update')
{this.submit_permission_changes();}
else if(t.nodeName=='BUTTON'&&t.hasAttribute('rule_set_code'))
{this.reset_permission_rule_set(t.getAttribute('rule_set_code'));}
else if(t.className=='cancel')
{this.clear_changes();}
var t=Ext.get(event.getTarget());var p=t.findParent('div.plus_role');if(p){this.new_role();}},on_checkbox_change:function(checkbox)
{if(this.get_container().contains(checkbox))
{this.update_checkbox_state(checkbox);}},on_change:function(event)
{var t=event.target;if(t.className.indexOf('permissions_reset_select')>-1)
{this.render_reset_to_default_content(t.getAttribute('rule_set_code'),t.options[t.selectedIndex].value);}},update_checkbox_state:function(checkbox,no_parent_child_updates)
{this.modified_checkboxes=this.modified_checkboxes||{size:0};var checkbox_state=checkbox.getAttribute('checkbox_state');var modified=(checkbox_state!=checkbox.parentNode.getAttribute('actual'));var checkbox_container=Ext.get(checkbox).findParent('.checkbox_selection_area',7,true);var rule_set_code=checkbox.parentNode.getAttribute('rule_set_code');var rule_type=checkbox.parentNode.getAttribute('rule_type');var entity_type=checkbox.parentNode.getAttribute('entity_type');var field_name=checkbox.parentNode.getAttribute('field_name');if(modified)
{if(!this.modified_checkboxes[checkbox.id])
this.modified_checkboxes.size+=1;this.modified_checkboxes[checkbox.id]={permission_rule_set_code:rule_set_code,rule_type:rule_type,allow:(checkbox_state!='unchecked'),entity_type:entity_type,field_name:field_name};this.set_feedback('Permissions have been modified. Save by clicking the Save Changes button '+'or <span class="cancel">Clear your changes</span>.');checkbox_container.addClass('modified');}
else
{if(this.modified_checkboxes[checkbox.id])
{this.modified_checkboxes.size-=1;delete this.modified_checkboxes[checkbox.id];}
checkbox_container.removeClass('modified');if(this.modified_checkboxes.size<=0)
{this.modified_checkboxes.size=0;this.set_feedback('');}}
if(rule_type.indexOf('_field_value')>-1&&!no_parent_child_updates)
{var selector='td[rule_type=update_status_field][entity_type='+entity_type+'][field_name='+field_name+']';var container=this.get_container().dom;var parent_cell=sg_find(selector,container);var parent_checkbox=parent_cell.firstChild;var field=SG.schema.get_field(entity_type,field_name);var statuses=sg_deep_copy(field.status_list_subset);statuses.push(null);var from_count=0;var to_count=0;var selector,child_cell,child_status_checkbox;for(var i=0;i<statuses.length;i++)
{var status=statuses[i]?statuses[i]:'null';selector='td[rule_type=update_from_field_value][entity_type='+entity_type+'][field_name='+field_name+'][status='+status+']';child_cell=sg_find(selector,container);child_status_checkbox=child_cell.firstChild;if(child_status_checkbox.getAttribute('checkbox_state')=='checked')
from_count++;selector='td[rule_type=update_to_field_value][entity_type='+entity_type+'][field_name='+field_name+'][status='+status+']';child_cell=sg_find(selector,container);child_status_checkbox=child_cell.firstChild;if(child_status_checkbox.getAttribute('checkbox_state')=='checked')
to_count++;}
var new_state=null;if(from_count==0&&to_count==0)
new_state='unchecked';else
{var count=statuses.length;var total_actual=from_count+to_count;if(total_actual==(count*2))
new_state='checked';else
new_state='dashed';}
SG.Checkbox.set_state(parent_checkbox,new_state);this.update_checkbox_state(parent_checkbox,true);}
else if(rule_type=='update_status_field'&&!no_parent_child_updates)
{var field=SG.schema.get_field(entity_type,field_name);var statuses=sg_deep_copy(field.status_list_subset);statuses.push(null);var checked_count=0;for(var i=0;i<statuses.length;i++)
{var status=statuses[i]?statuses[i]:'null';selector='td[rule_type=update_from_field_value][entity_type='+entity_type+'][field_name='+field_name+'][status='+status+']';child_cell=sg_find(selector,container);child_status_checkbox=child_cell.firstChild;SG.Checkbox.set_state(child_status_checkbox,checkbox_state);this.update_checkbox_state(child_status_checkbox,true);selector='td[rule_type=update_to_field_value][entity_type='+entity_type+'][field_name='+field_name+'][status='+status+']';child_cell=sg_find(selector,container);child_status_checkbox=child_cell.firstChild;SG.Checkbox.set_state(child_status_checkbox,checkbox_state);this.update_checkbox_state(child_status_checkbox,true);}}},set_feedback:function(text)
{var feedback_elements=this.get_container().query('span.feedback',true);for(var i=0;i<feedback_elements.length;i++)
feedback_elements[i].innerHTML=text;},clear_changes:function()
{if(!this.modified_checkboxes||this.modified_checkboxes.size<=0)
return;for(var checkbox_id in this.modified_checkboxes)
{if(this.modified_checkboxes.hasOwnProperty(checkbox_id)&&checkbox_id!='size')
{var checkbox=sg_find("div#"+checkbox_id,this.get_container().dom);SG.Checkbox.set_state(checkbox,(checkbox.parentNode.getAttribute('actual')=='true'));this.update_checkbox_state(checkbox);}}},submit_permission_changes:function()
{if(!this.modified_checkboxes||this.modified_checkboxes.size<=0)
return;this.set_feedback("Updating permissions...");this.permission_changes=[];status_fields_to_update={};for(var checkbox_id in this.modified_checkboxes)
{if(!this.modified_checkboxes.hasOwnProperty(checkbox_id)||checkbox_id=='size')
continue;var checkbox_hash=this.modified_checkboxes[checkbox_id];if(['update_status_field','update_from_field_value','update_to_field_value'].indexOf(checkbox_hash.rule_type)>-1)
{status_fields_to_update[checkbox_hash.entity_type+checkbox_hash.field_name]={permission_rule_set_code:checkbox_hash.permission_rule_set_code,rule_type:'update_field_values',entity_type:checkbox_hash.entity_type,field_name:checkbox_hash.field_name,}
continue;}
this.permission_changes.push(checkbox_hash);}
for(var key in status_fields_to_update)
{if(!status_fields_to_update.hasOwnProperty(key))
continue;var change_hash=status_fields_to_update[key];change_hash.update_from=[];change_hash.update_to=[];var field=SG.schema.get_field(change_hash.entity_type,change_hash.field_name);var statuses=sg_deep_copy(field.status_list_subset);statuses.push(null);var key_base=change_hash.permission_rule_set_code+"_fields_"+change_hash.entity_type;var container=this.get_container().dom;for(var i=0;i<statuses.length;i++)
{var status_checkbox_id=key_base+"_update_from_"+change_hash.field_name+"_"+statuses[i];var status_checkbox=sg_find("div#"+status_checkbox_id,container);if(status_checkbox.getAttribute('checkbox_state')=='checked')
change_hash.update_from.push(statuses[i]);var status_checkbox_id=key_base+"_update_to_"+change_hash.field_name+"_"+statuses[i];var status_checkbox=sg_find("div#"+status_checkbox_id,container);if(status_checkbox.getAttribute('checkbox_state')=='checked')
change_hash.update_to.push(statuses[i]);}
this.permission_changes.push(change_hash);}
this.modified_checkboxes=null;var options={url:'/page/set_permissions',params:{permission_changes:Ext.encode(this.permission_changes)},callback:function(options,success,response){this.hide_loading_overlay();if(success)
{response=Ext.decode(response.responseText);if(response.error_message)
{this.set_feedback("Permission update failed.");new SG.NewDialog({title:"Server Error",body:"<b>Server Error:</b> "+response.error_message,actions:[{label:'OK'}]});}
else
{var i,changed_sets={};for(i=0;i<response.length;i++){changed_sets[response[i].set_id]=response[i];}
for(i=0;i<this.permissions.length;i++){if(changed_sets.hasOwnProperty(this.permissions[i].set_id)){this.permissions[i]=changed_sets[this.permissions[i].set_id];}}
this.on_set_permissions_done();}}
else
{this.set_feedback("Permission update failed.");var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},on_set_permissions_done:function()
{var reloaded=[];for(var i=0;i<this.permission_changes.length;i++)
{var change=this.permission_changes[i];if(reloaded.indexOf(change.permission_rule_set_code)==-1)
{reloaded.push(change.permission_rule_set_code);for(var i=0;i<this.permissions.length;i++)
{if(this.permissions[i].code==change.permission_rule_set_code)
{this.rerender_group_summary(change.permission_rule_set_code,this.permissions[i]);break;}}}
var section_key=change.permission_rule_set_code;section_key+=(change.field_name?"_fields_":change.entity_type?"_entities":"_advanced");if(change.field_name)
section_key+=change.entity_type;if(reloaded.indexOf(section_key)>-1)
continue;reloaded.push(section_key);this.show_permissions_section_reloading(section_key);if(change.field_name)
this.request_entity_field_permissions(change.permission_rule_set_code,change.entity_type);else if(change.entity_type)
this.request_entity_type_permissions(change.permission_rule_set_code);else
this.request_advanced_permissions(change.permission_rule_set_code);}
this.set_feedback("Permissions successfully updated.");},toggle_opener:function(dom_elem)
{var html_key=dom_elem.getAttribute('open_key');var key=this.code_from_html_key(html_key);var openable=Ext.get(dom_elem.parentNode);var status_value_openable=null;if(openable.hasClass('checkbox_subsection_opener'))
{status_value_openable=Ext.get(sg_find("tbody#"+html_key,this.get_container().dom));var is_status_field=true;}
var index=this.open_sections.indexOf(key);if(index>-1)
{this.open_sections.splice(index,1);openable.replaceClass('open','closed');if(status_value_openable)
status_value_openable.replaceClass('open','closed');return;}
else
{this.open_sections.push(key);openable.replaceClass('closed','open');if(status_value_openable)
status_value_openable.replaceClass('closed','open');}
var index;if((index=key.indexOf('_advanced'))>-1)
this.request_advanced_permissions(key.substring(0,index));else if((index=key.indexOf('_entities'))>-1)
this.request_entity_type_permissions(key.substring(0,index));else if(!is_status_field&&(index=key.indexOf("_fields_"))>-1)
this.request_entity_field_permissions(key.substring(0,index),key.substring(index+8));else if((index=key.indexOf('_reset'))>-1)
this.request_reset_to_default_content(key.substring(0,index));},request_summary_permissions:function()
{params={permission_rule_set_entity_type:this.rule_set_entity_type}
var options={url:'/page/all_permissions',params:params,callback:function(options,success,response){if(success){this.permissions=Ext.decode(response.responseText);this.render();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},request_advanced_permissions:function(permission_group_code)
{params={permission_rule_set_entity_type:this.rule_set_entity_type}
var options={url:'/page/simple_global_permissions',params:params,callback:function(options,success,response){if(success){this.advanced_permissions=Ext.decode(response.responseText);this.render_advanced_permissions_checkboxes(permission_group_code);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},render_advanced_permissions_checkboxes:function(permission_group_code)
{var group_permissions=null;for(var i=0;i<this.advanced_permissions.length&&!group_permissions;i++)
if(this.advanced_permissions[i].code==permission_group_code)
group_permissions=this.advanced_permissions[i];var open_key=permission_group_code+"_advanced";var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);var checkboxes=[];for(var i=0;i<group_permissions.permissions.length;i++)
{var rule=group_permissions.permissions[i];if(this.hidden_advanced_rule_types.indexOf(rule.rule_type)>-1)continue;var display_name=this.ui_rule_descriptions[rule.rule_type]||rule.display_name;var description=this.advanced_permission_descriptions[rule.rule_type]||'';if(description)
display_name+=" *";var checkbox_id='advanced_'+rule.rule_type+"_"+group_permissions.set_id;var checkbox_state=rule.allow?'checked':'unchecked';checkboxes.push(this.templates['advanced_permission_checkbox'].apply({checkbox_id:checkbox_id,permission_set_name:display_name,actual:checkbox_state,rule_set_code:permission_group_code,rule_type:rule.rule_type,description:description,checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,false)}));}
container.innerHTML=this.templates.advanced_permissions_content.apply({checkboxes:checkboxes.join('')});},show_permissions_section_reloading:function(open_key)
{var overlay=sg_find('div.content_overlay',sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom));Ext.get(overlay).addClass('reloading');},request_entity_type_permissions:function(permission_group_code)
{var options={url:'/page/permissions_for_entity_types_for_role',params:{permission_rule_set_code:permission_group_code},callback:function(options,success,response){if(success){this.entity_type_permissions=this.entity_type_permissions||{};this.entity_type_permissions[permission_group_code]=Ext.decode(response.responseText);this.render_entity_type_permissions_checkboxes(permission_group_code);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},render_entity_type_permissions_checkboxes:function(permission_group_code)
{var group_permissions=this.entity_type_permissions[permission_group_code];var open_key=permission_group_code+"_entities";var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);var permission_names={see:'See',create:'Create',retire:'Delete',update_field_generic:'Edit'};var entity_types_to_show=SG.schema.get_entity_types_for_permissions();var rows=[];for(var i=0;i<group_permissions.length;i++)
{if(entity_types_to_show.indexOf(group_permissions[i].entity_type)==-1)
continue;var checkbox_cells=[];var types=['see','create','retire','update_field_generic'];for(var j=0;j<types.length;j++)
{var exceptions_html='';var restrictions=group_permissions[i].permissions[types[j]+"_restricted"];if(restrictions=='special_rules'){restrictions="(Custom)";}else if(restrictions=='not_configurable'){restrictions=' ';exceptions_html='Not Configurable'}else{restrictions='';}
var exceptions=group_permissions[i].permissions[types[j]+"_exceptions"];if(!exceptions_html&&exceptions){exceptions_html=[];if(exceptions.allow.length>0)
exceptions_html.push("ALLOW "+exceptions.allow.join(", "));if(exceptions.deny.length>0)
exceptions_html.push("DENY "+exceptions.deny.join(", "));exceptions_html="Exceptions: "+exceptions_html.join(", ");}
var checkbox_id=group_permissions[i].entity_type+"_"+types[j]+"_"+permission_group_code;var checkbox_state=(group_permissions[i].permissions[types[j]]?'checked':'unchecked');checkbox_cells.push(this.templates.checkbox_cell.apply({checkbox_id:checkbox_id,rule_set_code:permission_group_code,rule_type:types[j],entity_type:group_permissions[i].entity_type,field_name:group_permissions[i].name,extra_classes:(restrictions?' disabled':''),rule_type_name:permission_names[types[j]]+(restrictions||exceptions?" *":""),tooltip:restrictions+(restrictions?" "+exceptions_html:exceptions_html),actual:checkbox_state,checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,(restrictions?true:false))}));}
rows.push(this.templates['multi_checkbox_row'].apply({entity_display_name:SG.schema.entity_types[group_permissions[i].entity_type].display_name,checkbox_cells:checkbox_cells.join('')}));}
container.innerHTML=this.templates.entity_permissions_content.apply({checkbox_rows:rows.join('')});},request_entity_field_permissions:function(permission_group_code,entity_type)
{var field_ids=[];var fields=SG.schema.entity_types[entity_type].fields_sorted_by_display_name;for(var i=0;i<fields.length;i++)
field_ids.push(SG.schema.entity_fields[entity_type][fields[i]].id);var options={url:'/page/permissions_for_fields',params:{request:Ext.encode({permission_rule_set_code:permission_group_code,display_column_ids:field_ids})},callback:function(options,success,response){if(success){this.entity_field_permissions=this.entity_field_permissions||{};this.entity_field_permissions[permission_group_code+"__"+entity_type]=Ext.decode(response.responseText);this.render_entity_field_permissions_checkboxes(permission_group_code,entity_type);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},render_entity_field_permissions_checkboxes:function(permission_group_code,entity_type)
{var field_permissions=this.entity_field_permissions[permission_group_code+"__"+entity_type];var open_key=permission_group_code+"_fields_"+entity_type;var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);var permission_names={see:'See',update:'Edit'};var rows=[];for(var i=0;i<field_permissions.length;i++)
{var checkbox_cells=[];var types=['see','update'];if(field_permissions[i].update_to)
types=['see','update_status'];for(var j=0;j<types.length;j++)
{if(types[j]=='update_status')
this.add_status_value_heading_cell(checkbox_cells,field_permissions[i],permission_group_code,entity_type,open_key);else
{var restrictions=field_permissions[i][types[j]+"_restricted"];if(restrictions=='entity_type_not_visible')
restrictions="(Can't see "+
SG.schema.entity_types[entity_type].display_name+")";else if(restrictions=='special_rules')
restrictions="(Custom)";else if(restrictions=='read_only')
restrictions="(Read Only)";else
restrictions='';if(SG.schema.entity_fields[entity_type][field_permissions[i].name].no_permission_changes||(entity_type=='HumanUser'&&types[j]=='see'&&['password_strength','password_proxy'].indexOf(field_permissions[i].name)!=-1)){restrictions="(Permissions not configurable)";}
var exceptions=field_permissions[i][types[j]+"_exceptions"];var exceptions_html;if(exceptions)
{exceptions_html=[];if(exceptions.allow.length>0)
exceptions_html.push("ALLOW "+exceptions.allow.join(", "));if(exceptions.deny.length>0)
exceptions_html.push("DENY "+exceptions.deny.join(", "));exceptions_html="Exceptions: "+exceptions_html.join(", ");}
else
exceptions_html='';var checkbox_id=open_key+"_"+types[j]+"_"+field_permissions[i].name;var checkbox_state=(field_permissions[i][types[j]]?'checked':'unchecked');checkbox_cells.push(this.templates.checkbox_cell.apply({checkbox_id:checkbox_id,rule_set_code:permission_group_code,rule_type:types[j]+"_field",entity_type:entity_type,field_name:field_permissions[i].name,extra_classes:(restrictions?' disabled':''),rule_type_name:permission_names[types[j]]+(restrictions||exceptions?" *":""),tooltip:restrictions+(restrictions?" "+exceptions_html:exceptions_html),actual:checkbox_state,checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,(restrictions?true:false))}));}}
var opener='';var status_attribute='';if(field_permissions[i].update_to)
{var status_value_open_key=open_key+"_"+field_permissions[i].name;opener=this.templates.checkbox_subsection_opener.apply({open_key:this.html_key_from_code(status_value_open_key)});status_attribute="status_opener"}
rows.push(this.templates['multi_checkbox_row'].apply({entity_display_name:field_permissions[i].display_name,checkbox_cells:checkbox_cells.join(''),opener:opener,open_closed:this.open_sections.indexOf(status_value_open_key)>-1?'open':'closed',status_attr:status_attribute}));if(field_permissions[i].update_to)
this.add_status_value_rows(rows,field_permissions[i],permission_group_code,entity_type,open_key,status_value_open_key);}
container.innerHTML=this.templates.entity_field_permissions_content.apply({checkbox_rows:rows.join('')});},status_parent_checkbox_state:function(field_permissions,entity_type)
{var checkbox_state=null;if(field_permissions['update_from'].length==0&&field_permissions['update_to'].length==0)
checkbox_state='unchecked';else
{var field=SG.schema.get_field(entity_type,field_permissions.name);var count=field.status_list_subset.length+1;var total_actual=field_permissions['update_from'].length+field_permissions['update_to'].length;if(total_actual==(count*2))
checkbox_state='checked';else
checkbox_state='dashed';}
return checkbox_state;},add_status_value_heading_cell:function(checkbox_cells,field_permissions,permission_group_code,entity_type,open_key)
{var checkbox_state=this.status_parent_checkbox_state(field_permissions,entity_type);var checkbox_id=open_key+"_update_status_"+field_permissions.name;var rule_type_name='Edit';var tooltip='';if(field_permissions.custom_status_rules)
{rule_type_name+=' *';tooltip="Special (non-configurable) rules apply to this field. Check the permissions summary "+"for more information. Changes made here that conflict with other rules may not take effect.";}
checkbox_cells.push(this.templates.checkbox_cell.apply({checkbox_id:checkbox_id,rule_set_code:permission_group_code,rule_type:"update_status_field",entity_type:entity_type,field_name:field_permissions.name,rule_type_name:rule_type_name,tooltip:tooltip,actual:checkbox_state,checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,false)}));checkbox_cells.push('<td class="empty"></td>');},add_status_value_rows:function(rows,field_permissions,permission_group_code,entity_type,open_key,status_value_row_open_key)
{var field=SG.schema.get_field(entity_type,field_permissions.name);var statuses=sg_deep_copy(field.status_list_subset);statuses.push(null);var status,cells,checkbox_id,checkbox_state;var status_value_rows=[];for(var i=0;i<statuses.length;i++)
{status=statuses[i];cells=['<td></td>'];checkbox_state=field_permissions['update_from'].indexOf(status)>-1?'checked':'unchecked';checkbox_id=open_key+"_update_from_"+field_permissions.name+"_"+status;cells.push(this.templates.checkbox_cell.apply({checkbox_id:checkbox_id,rule_set_code:permission_group_code,rule_type:'update_from_field_value',entity_type:entity_type,field_name:field_permissions.name,rule_type_name:'Edit From',tooltip:'',actual:checkbox_state,status:status?status:'null',checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,false)}));checkbox_state=field_permissions['update_to'].indexOf(status)>-1?'checked':'unchecked';checkbox_id=open_key+"_update_to_"+field_permissions.name+"_"+status;cells.push(this.templates.checkbox_cell.apply({checkbox_id:checkbox_id,rule_set_code:permission_group_code,rule_type:'update_to_field_value',entity_type:entity_type,field_name:field_permissions.name,rule_type_name:'Edit To',tooltip:'',actual:checkbox_state,status:status?status:'null',checkbox:SG.Checkbox.render(checkbox_id,null,checkbox_state,false)}));var status_display;if(status!=null)
{var status_schema=SG.schema.status_list[status];var status_icon=SG.Renderers.render_one_status_icon(status);status_display=this.templates.status.apply({icon:status_icon,name:status_schema.name});}
else
{status_display=this.templates.status.apply({icon:'',name:"(Empty)"});}
status_value_rows.push(this.templates['multi_checkbox_row'].apply({entity_display_name:status_display,checkbox_cells:cells.join('')}));}
rows.push(this.templates.status_value_rows.apply({checkbox_rows:status_value_rows.join(''),open_key:this.html_key_from_code(status_value_row_open_key),open_closed:this.open_sections.indexOf(status_value_row_open_key)>-1?'open':'closed'}));},request_reset_to_default_content:function(permission_group_code)
{params={permission_rule_set_entity_type:'PermissionRuleSet.'+this.rule_set_entity_type}
var options={url:'/page/all_permissions',params:params,callback:function(options,success,response){if(success){this.system_default_permissions=Ext.decode(response.responseText);this.render_reset_to_default_content(permission_group_code);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},default_rule_sets:[{display_name:'Default Admin',code:'admin_system_default',regex:/admin/,entity_type:'HumanUser'},{display_name:'Default Artist',code:'artist_system_default',regex:/artist/,entity_type:'HumanUser'},{display_name:'Default Manager',code:'manager_system_default',regex:/manager/,entity_type:'HumanUser'},{display_name:'Default Script',code:'api_admin_system_default',regex:/api_admin/,entity_type:'ApiUser'},],render_reset_to_default_content:function(permission_group_code,selected_default_permission_set_code)
{var open_key=permission_group_code+"_reset";var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);var selected=selected_default_permission_set_code;if(!selected)
{selected='artist_system_default';for(var i=0;i<this.default_rule_sets.length;i++)
if(permission_group_code.match(this.default_rule_sets[i].regex))
selected=this.default_rule_sets[i].code;}
var options=[];var selected_name;var attributes;for(var i=0;i<this.default_rule_sets.length;i++)
{if(this.rule_set_entity_type!=this.default_rule_sets[i].entity_type)
continue;attributes='';if(selected==this.default_rule_sets[i].code)
{attributes='selected';selected_name=this.default_rule_sets[i].display_name;}
options.push(this.templates.option.apply({value:this.default_rule_sets[i].code,name:this.default_rule_sets[i].display_name,attributes:attributes}));}
var default_group_permissions;for(var i=0;i<this.system_default_permissions.length;i++)
if(this.system_default_permissions[i].code==selected)
default_group_permissions=this.system_default_permissions[i];var summary=this.render_summary_content(default_group_permissions);container.innerHTML=this.templates.reset_to_defaults_content.apply({rule_set_code:permission_group_code,role_name:selected_name,options:options.join(''),summary:summary});},reset_permission_rule_set:function(permission_group_code)
{if(!confirm("Resetting permission rules cannot be reverted.  Are you sure you want to continue?"))
return;var open_key=permission_group_code+"_reset";var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);var selector=sg_find('select.permissions_reset_select',container);var system_group_code=selector.options[selector.selectedIndex].value;var options={url:'/page/reset_permission_group',params:{reset_permission_group_code:permission_group_code,copy_permission_group_code:system_group_code},callback:function(options,success,response){this.hide_loading_overlay();if(success)
{var permission_summary_for_group=Ext.decode(response.responseText);for(var i=0;i<this.permissions.length;i++)
{if(this.permissions[i].code==permission_group_code)
{this.permissions[i]=permission_summary_for_group;break;}}
this.set_feedback("Permissions successfully updated.");this.rerender_group_sections(permission_group_code,permission_summary_for_group);}
else
{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},rerender_group_sections:function(permission_group_code,permission_summary_for_group)
{this.rerender_group_summary(permission_group_code,permission_summary_for_group);var suffixes=['_fields','_entities','_advanced'];for(var i=0;i<suffixes.length;i++)
{var open_key=permission_group_code+suffixes[i];var opener=sg_find("div.opener[open_key="+this.html_key_from_code(open_key)+"]",this.get_container().dom);var parent=Ext.get(opener.parentNode);var index=this.open_sections.indexOf(open_key);if(index>-1)
{this.open_sections.splice(index,1);parent.replaceClass('open','closed');return;}}},rerender_group_summary:function(permission_group_code,permission_summary_for_group)
{var open_key=permission_group_code+"_summary";this.show_permissions_section_reloading(open_key);var container=sg_find('div.content.'+this.html_key_from_code(open_key),this.get_container().dom);container.innerHTML=this.render_summary_content(permission_summary_for_group);},show_gear_menu:function(e)
{var target=Ext.get(e.getTarget());var group=target.findParent('div.permission_group',this.get_container());var set_id=group.getAttribute('set_id');var menu=SG.Menu.get_menu('permissions_gear');if(!menu)
{var items=[];items.push({html:"Rename",icon_name:"icon_edit",item_selected:{fn:this.on_rename_role_item,scope:this}});items.push({html:"Duplicate",item_selected:{fn:this.on_duplicate_role_item,scope:this}});items.push({line:true});items.push({html:"Delete",icon_name:"trash",disabled:this.permissions.length==1,item_selected:{fn:this.on_delete_role_item,scope:this}});menu=this.new_component(SG.Menu,{id:'permissions_gear',items:items});menu.render();}
menu.set_id=Number(set_id);menu.position={dom_elem:target,no_cover:true};menu.show();},on_rename_role_item:function(menu,menu_item)
{var dlg,body,actions;var role=this.get_role_by_id(menu.set_id);body='<table><tr><td class="label">Name:</td><td class="input">';body+='<input type="text" name="new_name" value="'+role.display_name+'">';body+="</td></tr></table><br>";actions=[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Rename Role',dont_close:true,callback:{fn:this.on_rename_role,scope:this,data:menu.set_id},key_code:Ext.EventObject.ENTER}];dlg=new SG.NewDialog({title:"Rename Permission Role",css_class:'role_dialog',body:body,actions:actions});var el=(sg_find('input[name=new_name]',dlg.container.dom));el.select();el.focus();},on_rename_role:function(dialog,data)
{var new_name=dialog.container.child('input[name=new_name]').dom.value;if(!new_name.strip()){alert("Please fill in the new name.");return;}else if(this.get_role_by_display_name(new_name)!==null){alert("Please choose a unique name.");return;}else{dialog.hide();}
var me=this;var options={url:'/page/rename_permission_group',params:{set_id:data,new_name:new_name},callback:function(options,success,response){dialog.destroy();this.hide_loading_overlay();if(success){var r=me.get_role_by_id(data);r.display_name=new_name;var c=me.get_container();var cont=sg_find('div.permission_group[set_id="'+data+'"] span.group_title',c.dom);cont.innerHTML=new_name;this.green_flash_role(data);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},on_duplicate_role_item:function(menu,menu_item)
{var dlg,body,actions;var role=this.get_role_by_id(menu.set_id);body='<table><tr><td class="label">Name:</td><td class="input">'+'<input type="text" name="new_name" value="'+role.display_name+' Copy">'+'</td></tr>'+'<tr><td></td><td class="input">Note that all the Page and Home Page Tab visibility '+'permissions will be duplicated as well.</td></tr>'+'</table><br>';actions=[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Duplicate Role',dont_close:true,callback:{fn:this.on_duplicate_role,scope:this,data:menu.set_id},key_code:Ext.EventObject.ENTER}];dlg=new SG.NewDialog({title:"Duplicate Permission Role",css_class:'role_dialog',body:body,actions:actions});var el=(sg_find('input[name=new_name]',dlg.container.dom));el.select();el.focus();},on_duplicate_role:function(dialog,data)
{var new_name=dialog.container.child('input[name=new_name]').dom.value;if(!new_name.strip()){alert("Please fill in the new name.");return;}else if(this.get_role_by_display_name(new_name)!==null){alert("Please choose a unique name.");return;}else{dialog.hide();}
var options={url:'/page/new_permission_group',params:{set_id:data,new_name:new_name},callback:function(options,success,response){dialog.destroy();this.hide_loading_overlay();if(success){var new_set=Ext.decode(response.responseText);this.insert_new_role(new_set);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},insert_new_role:function(new_set)
{this.permissions.push(new_set);var h=this.render_group(new_set);var el=this.get_container().dom.firstChild.lastChild;Ext.DomHelper.insertHtml('beforeBegin',el,h);this.green_flash_role(new_set.set_id);SG.globals.human_user_permission_groups.push({id:new_set.set_id,code:new_set.code,display_name:new_set.display_name,parent_set_id:new_set.parent_set_id})},on_delete_role_item:function(menu,menu_item)
{var msg;if(this.rule_set_entity_type=="HumanUser"&&menu.set_id==SG.globals.default_user_role.id){msg="You can't delete the default permission role for new users. Please select a new default in the ";msg=msg+"Advanced section of the Site Preferences page, then try again.";alert(msg);return;}else if(this.rule_set_entity_type=="ApiUser"&&menu.set_id==SG.globals.default_script_role.id){msg="You can't delete the default permission role for new scripts. Please select a new default in the ";msg=msg+"Advanced section of the Site Preferences page, then try again.";alert(msg);return;}
var role=this.get_role_by_id(menu.set_id);var child_roles=[];for(var i=0;i<this.permissions.length;i++){if(this.permissions[i].parent_set_id==menu.set_id)
child_roles.push(this.permissions[i]);}
if(child_roles.length>0){var okay=confirm("This permission role is the parent of "+child_roles.length+" other permission "+("role").pluralize(child_roles.length)+". If you delete it (not recommended), "+" you may cause changes in the permissions for pages and tabs for those roles. "+"Are you sure you want to continue?");if(!okay)
return;}
var spec={type:this.rule_set_entity_type,filters:{logical_operator:'and',conditions:[{path:'permission_rule_set',relation:'is',values:[{type:'PermissionRuleSet',id:menu.set_id}]}]},summaries:[{column:"id",type:"record_count"}],result:this.summary_set,result_key:menu.set_id,use_loading_banner:true};SG.Repo.summarize(spec);},on_summary_load:function(keys)
{var set_id=keys[0];var count=Number(this.summary_set.get(set_id,"id"));if(count==0){this.delete_role(set_id);}else{this.retarget_role(set_id,count);}},delete_role:function(set_id,retarget_set_id)
{if(!confirm("Warning, deleting this role will happen immediately and is not currently undo-able."))
return;var me=this;var options={url:'/page/retire_permission_group',params:{set_id:set_id,retarget_set_id:retarget_set_id||-1},callback:function(options,success,response){this.hide_loading_overlay();if(success){var idx=null;for(var i=0;i<this.permissions.length;i++){if(set_id==this.permissions[i].set_id){idx=i;break;}}
if(idx!==null){this.permissions.splice(idx,1);}
var container=this.get_container().dom;var elem=sg_find('div.permission_group[set_id="'+set_id+'"]',container);Ext.get(elem).remove();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},retarget_role:function(set_id,count)
{if(!confirm("Warning, deleting this role will happen immediately and is not currently undo-able."))
return;var edn,dlg,body,actions;if(count>1)
edn=SG.schema.entity_types[this.rule_set_entity_type].display_name_pluralized+" are ";else
edn=SG.schema.entity_types[this.rule_set_entity_type].display_name+" is ";body='<div style="padding-right: 10px">';body+=count+' '+edn+' assigned to the permission role you are deleting. ';body+='Please cancel and fix this problem or retarget them all to a new role before ';body+='continuing with delete.</div><br>';body+='<table><tr><td class="label">New Role:</td>';body+='<td class="input"><select name="new_role">';body+=this.get_role_options(set_id);body+='</select></td></tr></table>';actions=[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Update & Delete',dont_close:true,callback:{fn:this.on_retarget_role,scope:this,data:set_id},key_code:Ext.EventObject.ENTER}];dlg=new SG.NewDialog({title:"Oops...",css_class:"role_dialog",body:body,actions:actions});},on_retarget_role:function(dialog,data)
{var new_role_id=dialog.container.child('select[name=new_role]').dom.value;this.delete_role(data,new_role_id);dialog.destroy();},new_role:function()
{var body,actions;body='<table><tr><td class="label">Name:</td>';body+='<td class="input"><input type="text" name="new_name" value="New Role">';body+='<tr><td class="label">Template:</td>';body+='<td class="input"><select name="template_role">';body+=this.get_role_options();body+='</select></td></tr>';body+='<tr><td class="label">&nbsp;</td>';body+='<td class="input">Choose a role to use for an ';body+='initial set of rules.</td></tr>'+'<tr><td></td><td class="input">Note that all the Page and Home Page Tab visibility '+'permissions will be duplicated as well.</td></tr>'+'</table>';actions=[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Create Role',dont_close:true,callback:{fn:this.on_new_role,scope:this},key_code:Ext.EventObject.ENTER}];dlg=new SG.NewDialog({title:"New Permission Role",css_class:"role_dialog",body:body,actions:actions});var el=(sg_find('input[name=new_name]',dlg.container.dom));el.select();el.focus();},on_new_role:function(dialog)
{var new_name=dialog.container.child('input[name=new_name]').dom.value;if(!new_name.strip()){alert("Please fill in the new name.");return;}else if(this.get_role_by_display_name(new_name)!==null){alert("Please choose a unique name.");return;}else{dialog.hide();}
var set_id=dialog.container.child('select[name=template_role]').dom.value;var options={url:'/page/new_permission_group',params:{set_id:set_id,new_name:new_name,entity_type:this.rule_set_entity_type},callback:function(options,success,response){dialog.destroy();this.hide_loading_overlay();if(success){var new_set=Ext.decode(response.responseText);this.insert_new_role(new_set);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();this.show_loading_overlay();conn.request(options);},get_role_options:function(ignore_id)
{var h='';for(var p=0;p<this.permissions.length;p++){if(this.permissions[p].set_id!=ignore_id)
h+='<option value="'+this.permissions[p].set_id+'">';h+=this.permissions[p].display_name+'</option>';}
return h;},get_role_by_id:function(set_id)
{for(var i=0;i<this.permissions.length;i++){if(this.permissions[i].set_id==set_id)
return this.permissions[i];}
return null;},get_role_by_display_name:function(display_name)
{for(var i=0;i<this.permissions.length;i++){if(this.permissions[i].display_name==display_name)
return this.permissions[i];}
return null;},green_flash_role:function(role_id)
{var container=this.get_container().dom;var elem=sg_find('div.permission_group[set_id="'+role_id+'"]',container.dom);window.setTimeout(function(){Ext.fly(elem).animate({backgroundColor:{from:'#00FF00',to:'#EEEEEE'}},0.7,null,'easeOut','color');},100);}});SG.Widget.Assignment=function(context,widget_spec,id){SG.Widget.Assignment.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Assignment,SG.Widget.Base,{default_settings:{field_properties:[{field:'content',width:'75'},{field:'sg_status_list',width:'40'},{field:'task_assignees',width:'120'},{field:'start_date',width:'70'},{field:'due_date',width:'70'},{field:'duration',width:'70'}],hide_notes_with_statuses:[]},templates:{title:'<div class="title">{entity} / {task}</div>',body:'<table><tr>'+'<td class="left">{title}{thumb}</td>'+'<td class="spacer">&nbsp;</td>'+'<td class="right">'+'{tank_action_menu}'+'<div class="pipeline"></div>'+'<div class="details">'+'<div class="tasks"></div>'+'<div class="notes">{notes}</div></div>'+'</tr></table>'+'<img class="initial_step" src="/images/cur_assignment2.png">',child:'<div class="{widget_cls}" id="{widget_id}"></div>',tank_action_menu:'<div class="tank_action_menu"><span>Tank Actions</span>'+'<div class="icon arrow_open_dark"></div></div>'},field_properties_schema:[{property_name:'summary',data_type:'summary_type',display_name:'Summary Calculation'},{property_name:'field_label_override',data_type:'string',display_name:'Override field label',default_value:''},{property_name:'width',data_type:'string',display_name:'Width',default_value:'100'}],init_children:function()
{},on_first_render:function()
{this.task=this.context.get('entity');this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.loaded=false;this.data_set=this.new_data_set('Task',this.on_data_load);this.read_data();},render_widget:function()
{if(!this.loaded){this.container.update("Loading...");return;}
var cfg={title:this.render_title(),thumb:this.render_thumb(),notes:this.render_notes(),tank_action_menu:this.render_tank_actions()};this.container.update(this.templates.body.apply(cfg));this.render_tasks();this.thumb_widget.render();this.notes_widget.render();this.render_pipeline_summary();},render_title:function()
{var rec=this.data_set.get_record_by_id(this.task.id);var task={type:'Task',id:this.task.id,name:rec.get('content')};var ent=sg_deep_copy(rec.get('entity'));if(ent.hasOwnProperty('status'))
delete ent.status;var title_cfg={entity:SG.Renderers.entity.render(ent),task:SG.Renderers.entity.render(task)};return this.templates.title.apply(title_cfg);},render_thumb:function()
{var rec=this.data_set.get_record_by_id(this.task.id);var ent=sg_deep_copy(rec.get('entity'));var ctx=this.context.clone();ctx.set('entity',ent);this.thumb_widget=this.construct_child("thumb",this.context.clone());var cfg={widget_cls:this.thumb_widget.get_css_class_name(),widget_id:this.thumb_widget.get_container_id()};return this.templates.child.apply(cfg);},render_notes:function()
{var rec=this.data_set.get_record_by_id(this.task.id);var ent=rec.get('entity');var ssf={type:"step_notes",params:{"entity_type":ent.type,"entity_id":ent.id,"step_id":rec.get("step").id}};var ctx=this.context.clone();ctx.set('server_side_filters',ssf);var hide=this.get("hide_notes_with_statuses");var status_filters={logical_operator:'and',conditions:[]};for(var i=0;i<hide.length;i++){status_filters.conditions.push({path:'sg_status_list',relation:'is_not',values:[hide[i]]});}
ctx.set('additional_filter_conditions',status_filters);this.notes_widget=this.construct_child("notes",ctx);var cfg={widget_cls:this.notes_widget.get_css_class_name(),widget_id:this.notes_widget.get_container_id()};return this.templates.child.apply(cfg);},render_tasks:function()
{var cfg={widget:this,container:this.container.child('div.tasks'),entity_type:'Task',filters:this.get_task_filters(this.record.get('step').id),field_properties:this.get('field_properties'),required_columns:['content','task_assignees'],sorts:[{column:'due_date',direction:'asc'}]};this.tasks_grid=this.new_component(SG.MiniGrid,cfg);this.tasks_grid.render();},render_pipeline_summary:function()
{var rec=this.data_set.get_record_by_id(this.task.id);var cfg={container:Ext.get(sg_find('div.pipeline',this.container.dom)),entity:rec.get('entity'),step_id:rec.get('step').id,img_elem:Ext.get(sg_find('img.initial_step',this.container.dom)),callback:{fn:this.on_set_step,scope:this}};this.pipeline_summary=this.new_component(SG.PipelineSummary,cfg);this.pipeline_summary.render();},render_tank_actions:function()
{if(!sg_tank_enabled())return;return this.templates.tank_action_menu.apply({});},read_data:function()
{if(!this.task)return;var spec={type:'Task',id:this.task.id,columns:["content","entity","step","image"],result:this.data_set}
if(sg_tank_enabled()){spec['columns'].push("project.Project.sg_storage");}
SG.Repo.find(spec);},on_data_load:function()
{this.loaded=true;this.record=this.data_set.get_record_by_id(this.task.id);this.entity=this.record.get('entity');this.initial_step=this.record.get('step');this.render_widget();},get_task_filters:function(step_id)
{var filters;if(step_id==0){filters={logical_operator:"and",conditions:[{path:"entity",relation:"is",values:[this.entity]}]};}else{filters={logical_operator:"and",conditions:[{path:"entity",relation:"is",values:[this.entity]},{path:"step",relation:"is",values:[{type:"Step",id:step_id,valid:"valid"}]}]};}
return filters;},on_set_step:function(step_id)
{this.tasks_grid.set_filters(this.get_task_filters(step_id));var ssf=sg_deep_copy(this.notes_widget.context.get('server_side_filters'));ssf.params.step_id=step_id;this.notes_widget.context.set('server_side_filters',ssf);this.notes_widget.render();},get_default_note:function(callback){var task_ds=this.tasks_grid.get_data_set();var task_ids=[];for(var i=0;i<task_ds.records.length;i++){task_ids.push(task_ds.records[i].id);}
var config={widget:this,record_ids:task_ids,data_set:task_ds,create_default_note_only:true,on_default_note_created:callback};new SG.util.AddNoteToSelected(config);},on_click:function(e){var target=Ext.get(e.getTarget());var tank_menu=target.findParent('div.tank_action_menu',this.container,true);if(tank_menu)
this.on_tank_action_menu(target);},on_tank_action_menu:function(e){var menu=SG.Menu.get_menu("assignment_tank_menu");if(!menu){var before_show_fn=function(menu){var a=new SG.TankActionMenu();var project_ids=[menu.self.record.get("project").id];menu.items=a.get_items("Task",[menu.self.record.get_id()],project_ids);menu.render();}
menu=new SG.Menu({id:"assignment_tank_menu",before_show:{fn:before_show_fn,scope:this}});}
menu.self=this;menu.position={dom_elem:e,elem_anchor:"bl",menu_anchor:"tl"};menu.show();}});SG.Widget.Graph=function(context,widget_spec,id){SG.Widget.Graph.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Graph,SG.Widget.Base,{default_settings:{entity_type:'Task',grouping:[{column:"project",direction:"asc",method:"exact"}],summary:{column:"content",type:'record_count',value:null},filters:{logical_operator:'and',conditions:[]},bar_color:'0,110,252',sort:"value_desc",show_total:false,group_count_limit:''},templates:{body:'{qb}<div class="gear_menu_nobg">&nbsp;</div>'+'<div class="graph">{graph}</div>',horizontal_bar_graph:'<div class="horizontal_bar_graph {two_groups_class} {right_value_width_class}">'+'{bars}</div>',horizontal_bar:'<table class="horizontal_bar" group_index="{group_index}"><tr>'+'<td class="info_icon"><div class="icon_info_dark">&nbsp;</div></td>'+'<td class="group_display_value">{group_display_value}</td>'+'<td class="summary_value {value_width_class}">{value}</td>'+'<td class="bar_cell"><div class="bar" style="width:{width}; background-color: {color};">'+'&nbsp;{right_value}</div></td>'+'<td class="right_margin">&nbsp;</td>'+'</table>',horizontal_bar_graph_total:'<table class="horizontal_bar total"><tr>'+'<td class="info_icon"></td>'+'<td class="group_display_value"></td>'+'<td class="summary_value {value_width_class}">{total}</td>'+'<td class="bar_cell"></td>'+'<td class="right_margin">&nbsp;</td>'+'</table>',horizontal_bar_graph_limited:'<div class="row_limit">{showing} of {total}: '+'<span class="show_all_rows">Show all</span></div>',horizontal_bar_graph_unlimited:'<div class="row_limit">'+'<span class="show_limited_rows">Show first {limit}</span></div>',group_value:'<div class="group_value" sg_tip="{value}" clip_tip="this_node">{value}</div>',summary_value:'<div class="summary_value_div" sg_tip="{value}" clip_tip="this_node">{value}</div>',bar_right_value:'<div class="bar_right_value">{right_value}%</div>',empty_graph:'<div class="empty_graph"><i>No matching {plural_entity_type} to graph.</i></div>',qb:'<div class="filters"></div>',},init_widget:function()
{this.summary_set=new SG.Data.SummarySet(this.get('entity_type'));this.add_event(this.summary_set,'load',this.on_summary_load);},destroy_widget:function()
{this.get_page().get_focus_window().close();if(this.qb_component)
this.qb_component.destroy();},on_first_render:function()
{this.add_event(this.get_container(),'click',this.on_click);this.fetch_data();},render_widget:function()
{var qb_html=this.render_query_builder();var body=this.templates.body.apply({qb:qb_html,graph:this.render_horizontal_bar_graph()});this.get_container().dom.innerHTML=body;if(qb_html!='')
this.construct_and_render_query_builder();},render_query_builder:function(){if(!this.context.get('edit_mode'))
return'';return this.templates.qb.apply();},construct_and_render_query_builder:function(){if(this.qb_component)
this.qb_component.destroy();var filters=this.get('filters');this.refresh_token_entities_in_filters(filters);var container=this.get_container();this.qb_component=new SG.Widget.EntityQuery.QueryBuilder({floating:false,filters:filters,container:container.child('div.filters'),entity_type:this.get('entity_type'),context_projects:this.context_projects(),widget:this,callback:{fn:this.condition_changed,scope:this}});this.qb_component.render();},condition_changed:function(new_filters){var filters=sg_deep_copy(new_filters);this.set('filters',filters);this.sorted_group_summaries=null;this.fetch_data();},render_horizontal_bar_graph:function()
{if(this.summary_set.group_summaries&&this.summary_set.group_summaries.length==0)
return this.templates.empty_graph.apply({plural_entity_type:SG.schema.entity_types[this.get('entity_type')].display_name_pluralized});if(!this.summary_set||!this.summary_set.group_summaries)
return'';var groups=this.get_sorted_group_summaries();var row_limit=Number(this.get('group_count_limit'));var max_rows=row_limit;if(this.show_rows_unlimited||isNaN(max_rows)||max_rows<=0||max_rows>groups.length)
max_rows=groups.length;var summary=this.get('summary');var schema_field=SG.schema.get_field(this.get('entity_type'),summary.column);var value;var min_value=-1;var max_value=0;var total=0;var group_fields=[];for(var i=0;i<groups.length;i++)
{value=Number(groups[i].summaries[0].value);if(summary.type=='status_percentage'&&value==-1)
value=0;total+=value;if(value>max_value)
max_value=groups[i].summaries[0].value;if(min_value==-1||value<min_value)
min_value=groups[i].summaries[0].value;}
if(max_value==0)
max_value=1;var value_width_class='';if(schema_field.data_type=='duration')
value_width_class='very_wide';else if(summary.type.indexOf('percent')>-1||(String(max_value).length>3))
value_width_class='wide';var right_of_bar_percent_value=(summary.type.indexOf('percent')==-1&&(schema_field.data_type!='percent'||summary.type.indexOf('count')>-1));var right_value_width_class=right_of_bar_percent_value?'right_value_wide':'';if(!right_of_bar_percent_value)
max_value=100;var bars=[];var width,right_value;for(var i=0;i<max_rows;i++)
{value=groups[i].summaries[0].value;if(summary.type=='status_percentage'&&value==-1)
value=0;if(value===null)
value=0;width=(value*100/max_value)+'%';right_value=right_of_bar_percent_value?Math.round(value*100/total):'';if(!right_of_bar_percent_value||isNaN(right_value))
right_value='';else
right_value=this.templates.bar_right_value.apply({right_value:right_value});bars.push(this.templates.horizontal_bar.apply({width:width,color:'rgb('+this.get('bar_color')+');',group_display_value:this.render_group_values(groups[i]),value:this.render_summary_value(summary,schema_field,value),group_index:i,right_value:right_value,value_width_class:value_width_class}));}
if(max_rows!=groups.length)
bars.push(this.templates.horizontal_bar_graph_limited.apply({showing:max_rows,total:groups.length}));if(this.get('show_total'))
{total=this.render_summary_value(summary,schema_field,total);bars.push(this.templates.horizontal_bar_graph_total.apply({value_width_class:value_width_class,total:total}));}
if(this.show_rows_unlimited&&!(isNaN(row_limit)||row_limit<=0||row_limit>groups.length))
bars.push(this.templates.horizontal_bar_graph_unlimited.apply({limit:row_limit}));return this.templates.horizontal_bar_graph.apply({bars:bars.join(''),two_groups_class:this.get('grouping').length==2?'two_groups':'',right_value_width_class:right_value_width_class});},render_group_values:function(group)
{var grouping=this.get('grouping');var display_values=[];var schema_field;for(var i=0;i<grouping.length;i++)
{schema_field=SG.schema.get_field(this.get('entity_type'),grouping[i].column);var value=group.display_values[i];if(schema_field.data_type=='status_list')
{var status=SG.schema.status_list[group.values[i]];if(status)
value=status.name;else
value=group.values[i];}
if(value==null||value=='')
value='(blank)';display_values.push(this.templates.group_value.apply({value:value}));}
return display_values.join(' ');},render_summary_value:function(summary,schema_field,value)
{if(["record_count","checked","unchecked"].indexOf(summary.type)>-1)
{if(SG.globals.preferences.format_float_fields_commas)
value=sg_comma_format_number(value);return value;}
if(summary.type=='status_percentage'||summary.type=='percentage')
{if(SG.globals.preferences.format_float_fields_commas)
value=sg_comma_format_number(value);return value+"%";}
var summary_renderer=SG.SummaryRenderers[summary.type];var field_renderer=SG.Renderers[SG.Renderers.renderer_defaults[schema_field.data_type]];var rendered_value=value;if(summary_renderer)
{rendered_value=summary_renderer(value,summary.value,schema_field,field_renderer);}
else if(!summary_renderer&&field_renderer)
rendered_value=field_renderer.render(value,schema_field);return this.templates.summary_value.apply({value:rendered_value});},fetch_data:function()
{this.show_loading_overlay();var summaries=[];if(this.get('summary'))
summaries.push(this.get('summary'));summaries.push({column:'id',type:'record_count'});var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);spec={type:this.get('entity_type'),filters:filters,grouping:this.get('grouping'),summaries:summaries,result:this.summary_set,result_key:'group_summaries'}
SG.Repo.summarize(spec);},order_by_value_types:["date","date_time","number","percent","currency","float","timecode","duration"],get_sorted_group_summaries:function()
{if(!this.sorted_group_summaries)
{this.sorted_group_summaries=sg_deep_copy(this.summary_set.group_summaries);var sort_fn;var me=this;var aa,bb;var sort=this.get('sort');var direction=sort.indexOf('asc')>-1?'asc':'desc';if(['name_asc','name_desc'].indexOf(sort)>-1)
{var grouping=this.get('grouping');var sort_keys=[];var schema_field;for(var i=0;i<grouping.length;i++)
{schema_field=SG.schema.get_field(this.get('entity_type'),grouping[i].column);if(this.order_by_value_types.indexOf(schema_field.data_type)>-1)
sort_keys.push('template_values');else
sort_keys.push('display_values');}
sort_fn=function(A,B){a=me.number_or_string(A[sort_keys[0]][0]);b=me.number_or_string(B[sort_keys[0]][0]);if(A.values.length==1)
return me.compare(direction,a,b);else
{aa=me.number_or_string(A[sort_keys[1]][1]);bb=me.number_or_string(B[sort_keys[1]][1]);return me.compare_2(direction,a,b,aa,bb);}};}
else if(['value_asc','value_desc'].indexOf(sort)>-1)
{sort_fn=function(A,B){a=me.number_or_string(A.summaries[0].value);b=me.number_or_string(B.summaries[0].value);if(A.summaries.length==1)
return me.compare(direction,a,b);else
{aa=me.number_or_string(A.summaries[1].value);bb=me.number_or_string(B.summaries[1].value);return me.compare_2(direction,a,b,aa,bb);}};}
if(sort_fn)
this.sorted_group_summaries.sort(sort_fn);}
return this.sorted_group_summaries;},number_or_string:function(str)
{if(str==null||str=='')
return'';var value=Number(str);if(isNaN(value))
return str;else
return value;},compare:function(direction,a,b)
{if(a!=b&&a==='')
return 1;else if(a!=b&&b==='')
return-1;else if(direction=='asc')
return a<b?-1:a>b?1:0;else
return a>b?-1:a<b?1:0;},compare_2:function(direction,a,b,aa,bb)
{if(a!=b&&a==='')
return 1;else if(a!=b&&b==='')
return-1;else if(a===b&&aa!=bb&&aa==='')
return 1;else if(a===b&&aa!=bb&&bb==='')
return-1;else if(direction=='asc')
return a<b?-1:a>b?1:aa<bb?-1:aa>bb?1:0;else
return a>b?-1:a<b?1:aa>bb?-1:aa<bb?1:0;},on_summary_load:function()
{this.render();this.hide_loading_overlay();},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.hasClass('gear_menu_nobg'))
{this.show_gear_menu(t.dom);return;}
if(t.hasClass('show_all_rows'))
{this.show_rows_unlimited=true;this.render();return;}
if(t.hasClass('show_limited_rows'))
{this.show_rows_unlimited=false;this.render();return;}
var container=this.get_container();var bar=t.findParent('table.horizontal_bar.total',container);if(bar){this.show_graph_focus_window();return;}
bar=t.findParent('table.horizontal_bar',container);if(bar){this.show_group_focus_window(Number(bar.getAttribute('group_index')));return;}},show_gear_menu:function(dom_elem)
{if(!this.gear_menu)
{this.gear_menu=new SG.Menu({item_selected:{fn:this.on_gear_menu,scope:this},});}
var grouping=this.get('grouping');var group_field_name=SG.schema.get_field(this.get('entity_type'),grouping[0].column).display_name;var sort=this.get('sort');this.gear_menu.items=[{html:"Sort by "+group_field_name+" - Ascending",sort:'name_asc',checked:sort=='name_asc',icon_name:'icon_menu_arrow_up'},{html:"Sort by "+group_field_name+" - Descending",sort:'name_desc',checked:sort=='name_desc',icon_name:'icon_menu_arrow_down'},{line:true},{html:"Sort by Value - Ascending",sort:'value_asc',checked:sort=='value_asc',icon_name:'icon_menu_arrow_up'},{html:"Sort by Value - Descending",sort:'value_desc',checked:sort=='value_desc',icon_name:'icon_menu_arrow_down'},{line:true},{html:"Show source data...",value:'show_source_data'},]
this.gear_menu.render();this.gear_menu.position={dom_elem:dom_elem};this.gear_menu.show();},on_gear_menu:function(menu,menu_item)
{if(menu_item.value=='show_source_data')
this.show_graph_focus_window();else if(menu_item.sort)
{this.set('sort',menu_item.sort);this.sorted_group_summaries=null;this.render();}},show_graph_focus_window:function()
{var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);this.show_focus_window(filters);},show_group_focus_window:function(group_index)
{var groups=this.get('grouping');var group_summaries=this.get_sorted_group_summaries()[group_index];var group_value_filters=SG.schema.filters_for_grouping(this.get('entity_type'),groups,group_summaries.template_values);var filters=sg_deep_copy(this.get('filters'));this.substitute_filter_tokens(filters);var last_index=filters.conditions.length-1;if(filters.conditions[last_index]&&filters.conditions[last_index].logical_operator=='and')
{if(filters.conditions[last_index].conditions.length==1&&filters.conditions[last_index].conditions[0].conditions.length==0)
filters.conditions[last_index].conditions[0]=group_value_filters;else
filters.conditions[last_index].conditions.push(group_value_filters);}
else
{filters.conditions.push(group_value_filters);}
this.show_focus_window(filters);},show_focus_window:function(filters)
{var context={title:'Graph Source Data',entity_type:this.get('entity_type'),filters:filters,grouping:this.get('grouping'),extra_columns:[SG.schema.get_identifier_field(this.get('entity_type')),this.get('summary').column],summaries:[this.get('summary')]};this.get_page().get_focus_window().open(context);}});SG.Widget.ColumnBrowser=function(context,widget_spec,id)
{SG.Widget.ColumnBrowser.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ColumnBrowser,SG.Widget.Base,{canvas_require_height:true,default_settings:{filters:{logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]},columns:[[null,null]],},templates:{column:'<div class="sgc_column" index="{index}" style="left:{left}px;"></div>',},init_widget:function()
{this.entity_type=this.get('entity_type');if(!this.entity_type)
{this.entity=this.context.get('entity');this.entity_type=this.entity.type;}},on_first_render:function()
{this.columns=[];this.container=this.get_container();this.container.update(this.templates.column.apply({index:0,left:0}));var first_column_container=this.container.child('div.sgc_column');var first_column=new SG.ColumnBrowserColumn({container:first_column_container,entity_type:this.entity_type,entity:this.entity,id:this.columns.length,entity_selected_callback:{fn:this.entity_selected,scope:this},widget:this});this.columns.push(first_column);},render_widget:function()
{},entity_selected:function(column_component,schema_field,entity)
{if(column_component.id<=(this.columns.length-1))
this.delete_columns(column_component.id+1);if(!entity)return;var index=this.columns.length;var new_column_container=Ext.DomHelper.append(this.container,this.templates.column.apply({index:index,left:index*500}),true);var new_column=new SG.ColumnBrowserColumn({container:new_column_container,entity_type:entity.type,entity:entity,id:index,entity_selected_callback:{fn:this.entity_selected,scope:this},widget:this});this.columns.push(new_column);},delete_columns:function(starting_at)
{var new_columns=[];for(var i=0;i<this.columns.length;i++)
{var column=this.columns[i];if(i>=starting_at)
column.destroy();else
new_columns.push(this.columns[i]);}
this.columns=new_columns;},});SG.Widget.Countdown=function(context,widget_spec,id)
{SG.Widget.Countdown.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Countdown,SG.Widget.Base,{default_settings:{event_date:'',event_name:'Deadline',},templates:{main:'<div class="count">{count}</div>'+'<div class="until">{days} until</div>'+'<div class="event">{event_name}</div>',},init_widget:function()
{var event_date=this.get('event_date');if(event_date=='')
{var today=new SG.Date();this.set_silent('event_date',today.data_store_format());}},on_first_render:function()
{this.container=this.get_container();},render_widget:function()
{var count=this.calc_days_to_event();this.container.update(this.templates.main.apply({count:count,days:Math.abs(count)!=1?'days':'day',event_name:this.get('event_name')}))},calc_days_to_event:function()
{var today=new SG.Date();var event_date=new SG.Date(this.get('event_date'));var days=Math.floor((event_date.getTime()-today.getTime())/(1000*24*60*60));return days;},});SG.Widget.MiniGrid=function(context,widget_spec,id){SG.Widget.MiniGrid.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.MiniGrid,SG.Widget.Base,{default_settings:{field_properties:[],sorts:[],required_columns:[]},templates:{body:'<div class="mini_grid_container"></div>',},init_children:function()
{},on_first_render:function()
{this.container=this.get_container();},render_widget:function()
{this.container.update(this.templates.body.apply());var filters=this.get('filters');this.substitute_filter_tokens(filters);if(!this.mini_grid)
{var cfg={widget:this,container:this.container.child('div.mini_grid_container'),entity_type:this.get('entity_type'),filters:filters,field_properties:this.get('field_properties'),required_columns:this.get('required_columns'),sorts:this.get('sorts')};this.mini_grid=this.new_component(SG.MiniGrid,cfg);}
this.mini_grid.render();},});SG.Widget.MiniThumbnailGrid=function(context,widget_spec,id){SG.Widget.MiniThumbnailGrid.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.MiniThumbnailGrid,SG.Widget.Base,{default_settings:{field_properties:[{field:'code'}],sorts:[],required_columns:[],thumb_size:1,},canvas_quickfilter:true,templates:{body:'<div class="mini_thumbnail_grid_container"></div>',},init_children:function()
{},on_first_render:function()
{this.container=this.get_container();},get_filters:function()
{var context_filters=this.context.get('filters');if(context_filters)
return sg_deep_copy(context_filters);else
return sg_deep_copy(this.get('filters'));},render_widget:function()
{this.container.update(this.templates.body.apply());var filters=this.get_filters();this.substitute_filter_tokens(filters);if(!this.mini_grid)
{var cfg={widget:this,container:this.container.child('div.mini_thumbnail_grid_container'),entity_type:this.get('entity_type'),filters:filters,field_properties:this.get('field_properties'),required_columns:this.get('required_columns'),sorts:this.get('sorts'),base_thumb_size:this.get('thumb_size')};this.mini_grid=this.new_component(SG.MiniThumbnailGrid,cfg);}
this.mini_grid.render();},enable_selection:function(){this.mini_grid.selection_enabled=true;},enable_multi_select:function(){this.mini_grid.multi_select_enabled=true;},get_selected_records:function(group_idx){return this.mini_grid.get_selected_records(group_idx);},});SG.Widget.Example=function(context,widget_spec,id)
{SG.Widget.Example.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Example,SG.Widget.Base,{default_settings:{columns:['subject','sg_status_list','note_links','content','updated_at'],},templates:{note:'<div class="note closed" record_id="{record_id}"><div class="subject"><div class="subject_text">{subject}'+'</div><div class="note_status">{note_status}</div></div><div class="note_links"></div>'+'<div class="note_body"></div></div>',},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.data_set=this.new_data_set('Note',this.on_load,this.on_change);this.fetch_notes();},on_click:function(e)
{var t=Ext.get(e.getTarget());var note_div=t.findParent('div.note',this.container,true);if(note_div)
{var note_body_div=note_div.child('div.note_body');if(note_div.hasClass('open'))
{note_body_div.update('');note_div.replaceClass('open','closed');}
else
{var record_id=Number(note_div.dom.getAttribute('record_id'));var record=this.data_set.get_record_by_id(record_id);var content=record.get('content');if(!content||content=='')
content='&nbsp;';note_body_div.update(content);note_div.replaceClass('closed','open');}}},on_load:function()
{this.hide_loading_overlay();this.render_widget();},on_change:function(changes)
{},render_widget:function()
{if(!this.data_set.is_loaded())return;var html='';for(var i=0;i<this.data_set.count();i++)
{var record=this.data_set.get_record(i);html+=this.render_note(record);}
this.container.update(html);},render_note:function(record)
{var subject=record.get('subject');return this.templates.note.apply({record_id:record.get_id(),subject:subject?subject:'',note_status:SG.Renderers.render_one_status_icon(record.get('sg_status_list'))});},get_columns:function()
{var cols=this.get('columns');var ret=[];for(var i=0;i<cols.length;i++)
{var column=cols[i];var schema_field=SG.schema.get_field('Note',column);if(schema_field)ret.push(column);}
return ret;},get_filters:function()
{var current_user=SG.globals.current_user.entity_hash;var filter={logical_operator:'and',conditions:[{path:"user",relation:"is",values:[current_user]}],};return filter;},fetch_notes:function()
{this.show_loading_overlay();if(this.current_page==undefined)
this.current_page=1;var spec={type:'Note',columns:this.get_columns(),sorts:[{column:'created_at',direction:'desc'}],filters:this.get_filters(),current_page:this.current_page,records_per_page:10,result:this.data_set};SG.Repo.query(spec);},});SG.TicketAndRevisionLinkParser=function(container)
{this.container=container;this.init();};Ext.extend(SG.TicketAndRevisionLinkParser,Ext.util.Observable,{init:function()
{this.revision_links=[];this.ticket_links=[];this.revision_set=new SG.Data.Set('Revision');this.revision_set.on('load',this.render_revision_links,this);this.ticket_set=new SG.Data.Set('Ticket');this.ticket_set.on('load',this.render_ticket_links,this);},begin_parse:function()
{this.revision_links=[];this.ticket_links=[];this.revision_set.destroy();this.ticket_set.destroy();},end_parse:function()
{var i,spec,conditions;if(this.revision_links.length>0)
{conditions=[];for(i=0;i<this.revision_links.length;i++)
{conditions.push({path:'code',relation:'is',values:[this.revision_links[i]]});}
spec={type:'Revision',columns:SG.schema.entity_types.Revision.fields_sorted_by_display_name,filters:{logical_operator:"or",conditions:conditions},result:this.revision_set};SG.Repo.query(spec);}
if(this.ticket_links.length>0)
{conditions=[];for(i=0;i<this.ticket_links.length;i++)
{conditions.push({path:'id',relation:'is',values:[this.ticket_links[i]]});}
var cols=SG.schema.entity_types.Ticket.fields_sorted_by_display_name;var idx=cols.indexOf("attachments");if(idx!==-1)
cols.splice(idx,1);spec={type:'Ticket',columns:cols,filters:{logical_operator:"or",conditions:conditions},result:this.ticket_set};SG.Repo.query(spec);}},parse_content:function(content)
{if(content==null)
content='';var me=this;var ticket_re=/(^|[^&|&amp;])#(\d+)\b/g;var revision_re=/\br(\d+)\b/g;var a=content.replace(revision_re,function(str,rev){me.revision_links.push(rev);var span='<span class="missing_ticket_or_revision_link revision_link" sg_tip="This link is not valid" '+'revision_code="'+rev+'">'+str+'</span>';return span;});var b=a.replace(ticket_re,function(str,pre,ticket){me.ticket_links.push(ticket);var span=pre+'<span class="missing_ticket_or_revision_link ticket_link" sg_tip="This link is not '+' valid" ticket_id="'+ticket+'">'+ticket+'</span>';return span;});return b;},turn_missing_links_red:function()
{if(!this.missing_links_are_red)
{var s='span.missing_ticket_or_revision_link { color: red; }';Ext.util.CSS.createStyleSheet(s,'shotgun_missing_links_styles');this.missing_links_are_red=true;}},render_revision_links:function()
{this.turn_missing_links_red();var ds=this.revision_set;for(var i=0;i<ds.count();i++)
{var r=ds.get_record(i);var code=r.get('code');var spans=Ext.DomQuery.select('span.revision_link[revision_code='+r.get('code')+']',this.container.dom);for(var j=0;j<spans.length;j++)
{var span=Ext.get(spans[j]);span.removeClass('missing_ticket_or_revision_link');span.dom.removeAttribute('sg_tip');var revision_entity={type:'Revision',id:r.get_id(),name:'r'+r.get('code')};var detail_link=SG.Renderers.render_one_detail_link(revision_entity);span.update(detail_link);}}},render_ticket_links:function()
{this.turn_missing_links_red();var ds=this.ticket_set;for(var i=0;i<ds.count();i++)
{var r=ds.get_record(i);var code=r.get('code');var spans=Ext.DomQuery.select('span.ticket_link[ticket_id='+r.get_id()+']',this.container.dom);var ticket_entity={type:'Ticket',id:r.get_id(),name:'#'+r.get_id()};var detail_link=SG.Renderers.render_one_detail_link(ticket_entity);var status_icon=SG.Renderers.status_list.render_nbsp(r.get('sg_status_list'));var tool_tip=this.render_ticket_tool_tip(r);for(var j=0;j<spans.length;j++)
{var span=Ext.get(spans[j]);span.removeClass('missing_ticket_or_revision_link');span.update(detail_link+'<span style="padding: 4px;"/>'+status_icon);span.dom.setAttribute('sg_tip',tool_tip);}}},render_ticket_tool_tip:function(record)
{var schema_fields=SG.schema.entity_fields['Ticket'];var tip='';var ticket_status=record.get('sg_status_list');var ticket_icon=SG.Renderers.status_list.render_nbsp(ticket_status);var ticket_title=record.get('title');var ticket_addressees=record.get('addressings_to');if(ticket_title)
tip+=schema_fields['title']['display_name']+': '+ticket_title+'[[br]]';if(ticket_addressees){tip+=schema_fields['addressings_to']['display_name']+': '+
ticket_addressees.map(function(a){return a.name;}).join(', ')+'[[br]]';}else{tip+=schema_fields['addressings_to']['display_name']+': [[br]]';}
if(ticket_status!=null)
{if(ticket_status!='')
{tip+=schema_fields['sg_status_list']['display_name']+': ';tip+=ticket_icon;tip+='  '+SG.schema.status_list[ticket_status].name+'[[br]]';}
else
tip+=schema_fields['sg_status_list']['display_name']+':[[br]]';}
return tip;}});SG.util.TaskTemplateDuplicator=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.TaskTemplateDuplicator,Ext.util.Observable,{init:function(){this.read_templates();},read_templates:function(){this.template_ds=new SG.Data.Set('TaskTemplate');this.template_ds.on('load',this.on_read_templates,this);this.new_template_ds=new SG.Data.Set('TaskTemplate');this.new_template_ds.on('change',this.on_add_templates,this);this.task_ds=new SG.Data.Set('Task');this.task_ds.on('load',this.on_read_tasks,this);this.new_task_ds=new SG.Data.Set('Task');this.new_task_ds.on('change',this.on_new_task_ds_change,this);var spec={type:'TaskTemplate',ids:this.template_ids,columns:this.get_fields('TaskTemplate'),result:this.template_ds};SG.Repo.find(spec);},on_read_templates:function(){var cols=this.get_fields('TaskTemplate');var reqs=[];var col,rec,new_rec,val;this.source_template_ids=[];this.dest_template_ids=[];for(var i=0;i<this.template_ds.count();i++){rec=this.template_ds.get_record(i);this.source_template_ids.push(rec.get_id());new_rec=this.new_template_ds.new_record();for(var j=0;j<cols.length;j++){col=cols[j];val=rec.get(col);if(val===null)continue;if(col==='code')
new_rec.set(col,val+" (Copy)");else
new_rec.set(col,val);}}
this.new_template_ds.commit();},on_add_templates:function(changes){var creates=0;for(var i=0;i<changes.length;i++){if(changes[i].type=='create'){creates++;this.dest_template_ids.push(changes[i].record.get_id());}}
if(creates==0)return;this.read_tasks();},read_tasks:function(){var spec={type:'Task',drafts:true,columns:this.get_fields('Task'),filters:{logical_operator:'or',conditions:[]},grouping:[{column:'task_template',method:'exact',direction:'asc'}],result:this.task_ds};var cond;for(var i=0;i<this.source_template_ids.length;i++){cond={path:'task_template',relation:'is',values:[{type:'TaskTemplate','id':this.source_template_ids[i],'valid':true}],active:"true"};spec.filters.conditions.push(cond);}
SG.Repo.query(spec);},on_read_tasks:function(){var tpl_val,rec_ids,rec,grp;var source_id,source_idx,dest_id;var reqs=[];for(var i=0;i<this.task_ds.group_count();i++){grp=this.task_ds.get_group(i);source_id=grp.template_values[0].id;source_idx=this.source_template_ids.indexOf(source_id);dest_id=this.dest_template_ids[source_idx];rec_ids=grp.ids;for(var j=0;j<rec_ids.length;j++){rec=this.task_ds.get_record_by_id(rec_ids[j]);this.get_duplicate_task_request(rec,dest_id);}}
this.new_task_ds.commit();},get_duplicate_task_request:function(task,template_id){var val,col,entity;var cols=this.get_fields('Task');var new_rec=this.new_task_ds.new_record();for(var i=0;i<cols.length;i++){col=cols[i];val=task.get(col);if(val===null)continue;if(col==="task_template"){new_rec.set('task_template',{"type":"TaskTemplate","id":template_id,"valid":"valid"});}else if(col==="upstream_tasks"){}else{new_rec.set(col,val);}}
new_rec.temp_src_task_id=task.get_id();},on_new_task_ds_change:function(changes){var mode,src_rec,rec,predecessors,i,j;var tasks_created=0;var dep_map={};for(i=0;i<changes.length;i++){if(changes[i].type=='update'&&changes[i].state=='server'&&mode!='create'){mode='update';}else if(changes[i].type=='create'){mode='create';tasks_created++;rec=changes[i].record;dep_map[rec.temp_src_task_id]=rec.get_id();}}
if(mode=='create'){this.tasks_created=tasks_created;this.link_predecessors(dep_map);}else if(mode=='update'){this.finish_up();}},link_predecessors:function(dep_map){var i,j,src_rec,update_rec,update_pres,update_pre,pres,pre;var any=false;for(i=0;i<this.task_ds.count();i++){src_rec=this.task_ds.get_record(i);pres=src_rec.get('upstream_tasks');update_id=dep_map[src_rec.get_id()];update_rec=this.new_task_ds.get_record_by_id(update_id);update_pres=[];for(j=0;j<pres.length;j++){pre=pres[j];if(dep_map.hasOwnProperty(pre.id)){update_pre={type:"Task",id:pre.id,valid:"valid"};update_pre.id=dep_map[pre.id];update_pres.push(update_pre);}else{}}
if(update_pres.length>0){any=true;update_rec.set('upstream_tasks',update_pres);}}
if(!any)
this.finish_up();else
this.new_task_ds.commit();},finish_up:function(){var template_creates=this.dest_template_ids.length;var template_display_name,task_display_name;if(this.tasks_created==0)
return;else if(this.tasks_created===1)
task_display_name=SG.schema.entity_types['Task'].display_name;else
task_display_name=SG.schema.entity_types['Task'].display_name_pluralized;if(template_creates===1)
template_display_name='Template';else
template_display_name='Templates';var html=template_creates+' '+template_display_name+' and ';html+=this.tasks_created+' '+task_display_name+' successfully duplicated.';SG.Message.show({html:html});if(this.callback&&typeof this.callback.fn=='function')
this.callback.fn.call(this.callback.scope);},get_fields:function(entity_type){var cols=[];var all_cols=SG.schema.entity_fields[entity_type];var schema_field;for(var col in all_cols){if(all_cols.hasOwnProperty(col)&&SG.schema.can_edit_field(entity_type,col)){schema_field=SG.schema.get_field(entity_type,col);if(col=='downstream_tasks')
continue;if(schema_field&&schema_field.data_type!='url'&&schema_field.data_type!='image')
cols.push(col);}}
return cols;}});SG.util.ProjectDuplicator=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.ProjectDuplicator,Ext.util.Observable,{init:function(){this.dupe_count=0;this.duplicate_projects();},duplicate_projects:function()
{for(var i=0;i<this.duplicate_project_ids.length;i++)
this.duplicate_project(this.duplicate_project_ids[i],this.duplicate_project_names[i]);},duplicate_project:function(project_id,project_name)
{var options={url:SG.globals.urls.duplicate_project,params:{duplicate_project_id:project_id,duplicate_project_name:project_name},callback:function(options,success,response){if(success){this.a_project_duplicated();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},a_project_duplicated:function()
{this.dupe_count++;if(this.dupe_count==this.duplicate_project_ids.length)
{if(this.callback&&typeof this.callback.fn=='function')
this.callback.fn.call(this.callback.scope);}},});SG.util.EntityDuplicator=function(config){Ext.apply(this,config);this.init();};SG.util.EntityDuplicator.prototype={help_link:'(<a target="_blank" href="'+SG.globals.help_urls.duplicate_selected+'">?</a>)',init:function(){this.entity_set=new SG.Data.Set(this.entity_type);this.entity_set.on('load',this.on_load,this);this.new_entity_set=new SG.Data.Set(this.entity_type);this.new_entity_set.on('change',this.on_change,this);this.fields=this.get_fields();var spec={type:this.entity_type,ids:this.selected_ids,columns:this.fields,result:this.entity_set}
if(this.entity_type=="Task"&&this.parent_entity&&this.parent_entity.type=="TaskTemplate")
spec.drafts=true;SG.Repo.find(spec);},on_load:function(){var rec,new_rec,field,field_val,i,j;var ident=SG.schema.get_identifier_field(this.entity_type);var schema_field;for(i=0;i<this.entity_set.count();i++){rec=this.entity_set.get_record(i);new_rec=this.new_entity_set.new_record();for(j=0;j<this.fields.length;j++){field=this.fields[j];field_val=rec.get(field);if(field_val===null)
continue;if(field===ident)
field_val+=" (Copy)"
if(this.entity_type=='HumanUser'&&field=='login')
field_val+="_"+Math.floor(Math.random()*1000);schema_field=SG.schema.get_field(this.entity_type,field);if(schema_field.data_type=='image')
field_val={type:'Document',id:field_val,valid:'valid'}
new_rec.set(field,field_val);}}
this.new_entity_set.commit();},on_change:function(changes){var display_name;var creates=0;for(var i=0;i<changes.length;i++){if(changes[i].type=='create')creates++;}
if(creates===0)
return;else if(creates===1)
display_name=SG.schema.entity_types[this.entity_type].display_name;else
display_name=SG.schema.entity_types[this.entity_type].display_name_pluralized;var html=creates+' '+display_name+' successfully duplicated.';html+='<sup sg_tip="<nobr>Learn more...</nobr>">'+this.help_link+'</sup>';SG.Message.show({html:html});if(this.callback&&typeof this.callback.fn=='function')
this.callback.fn.call(this.callback.scope);},get_fields:function(){var cols=[];var all_cols=SG.schema.entity_fields[this.entity_type];var schema_field;for(var col in all_cols){if(all_cols.hasOwnProperty(col)&&SG.schema.can_edit_field(this.entity_type,col)){schema_field=SG.schema.get_field(this.entity_type,col);if(this.entity_type=='Playlist'&&col=='notes')
continue;if(schema_field&&schema_field.data_type=='multi_entity'&&typeof schema_field.inverse_association=="string"){var res=schema_field.inverse_association.split('.');var sf=SG.schema.get_field(res[0],res[1]);if(sf&&sf.data_type=="entity")
continue;}
if(this.entity_type=='Task'&&schema_field&&schema_field.name=="task_template"){cols.push(col);continue;}
if(schema_field&&schema_field.data_type!=='url'&&schema_field.grid_column!==false)
cols.push(col);}}
return cols;}};SG.util.CreateUpdateDC=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.CreateUpdateDC,Ext.util.Observable,{init:function()
{var cfg={entity_type:this.entity_type,schema_field:this.schema_field?sg_deep_copy(this.schema_field):null,widget:this.widget,field_context_title_label:this.field_context_title_label,field_name_prefix:this.field_name_prefix||'',done_callback:{fn:this.on_dialog_submitted,scope:this}};var cfd=new SG.ConfigureField.Dialog(cfg);},on_dialog_submitted:function(dlg_options){this.dlg_options=dlg_options;if(dlg_options.removed_status_list&&dlg_options.removed_status_list.length>0)
{var removed_status_list=dlg_options.removed_status_list;var status_list_names=SG.schema.status_list;var condition_array=[];var html_msg='Removing statuses (';for(var i=0;i<removed_status_list.length;++i){condition_array.push({path:dlg_options.col_name,relation:'is',values:[removed_status_list[i]]});html_msg+=status_list_names[removed_status_list[i]].name;if(i!==removed_status_list.length-1){html_msg+=', ';}}
html_msg+=') from the field.&nbsp; ';var config={request_type:"summarize",type:this.entity_type,summaries:[{column:'id',type:'count'}],filters:{conditions:[{conditions:condition_array,logical_operator:'or'}],logical_operator:'and'}};var self=this;var pi=new SG.ProgressIndicator;var resp=new SG.ResponseHandler;resp.handle_response=function(response,request){pi.hide();if(response.status==='successful'){html_msg+='There are currently '+response.summaries[0].value+' '+response.type.pluralize()+' with these statuses and their statuses will be emptied.&nbsp; Continue?';var cd=new SG.ConfirmDialog({sg_dialog_header_text:'Confirm Status Removal',html_msg:html_msg});cd.on('dialog_submitted',self.on_confirm,self);}else{var sed=SG.server_error({html_msg:'Unexpected error occured while retrieving number of entities with the removed statuses.',connection_response:response});}};pi.show();var req=new SG.CrudRequest(config,resp);req.send();}else{this.on_confirm();}},on_confirm:function(){var dlg_options=this.dlg_options;delete dlg_options.removed_status_list;var pi=new SG.ProgressIndicator(null,'det','Configuring Field...');var options={url:SG.globals.urls.configure_dc,params:{dialog_params:dlg_options},callback:pi.start_updates,scope:pi};options.params.dialog_params=Ext.encode(options.params.dialog_params);pi.on_job_complete={fn:function(status){if(status.non_standard_field_code)
{var field=SG.schema.get_field(dlg_options.field_owner_entity_type,status.non_standard_field_code);var message='The field name you have chosen, "'+field.display_name+'", is already used by a retired field.  '+'These two fields can have the same "display name", but we have generated '+'the "field code" for this new field to be unique. '+'Here are the values for this new field:<br><br>'+'<table><tr><td>Display Name: </td>'+'<td style="padding-left: 5px;"><b>'+field.display_name+'</b></td></tr>'+'<tr><td>Field Code: </td>'+'<td style="padding-left: 5px;"><b>'+status.non_standard_field_code+'</b></td></tr></table>';var confirm_dlg=new SG.MessageDialog({html_msg:message,sg_dialog_header_text:'Non-standard Field Code Selected',sg_dialog_width:'500px',sg_dialog_html_height:'200px'});}
if(status.duplicates_prevent_unique_constraint)
{var message="This field can't be made unique because there are duplicate values.<br><br>"+'<span id="dupes_page" class="fake_link">View a new page showing the duplicates.</span>';var confirm_dlg=new SG.MessageDialog({html_msg:message,sg_dialog_header_text:"(!) Duplicate Field Values",sg_dialog_width:'500px',sg_dialog_html_height:'200px'});Ext.get(confirm_dlg.body).on('click',function(evt){var target=evt.target;if(target.id=='dupes_page')
{confirm_dlg.destroy();if(SG.globals.page&&SG.globals.page.root_widget)
SG.globals.page.root_widget.show_loading_overlay();if(message)
SG.Message.show({html:'<b>Creating new duplicates page...</b>'});window.location='/page/create_and_show_duplicate_values_page?'+'entity_type='+status.column.entity_type+'&field_name='+status.column.name;}},this);}
if(status.column_added){this.show_column(status.column_added,this.column_index);}
else if(status.column_removed){SG.schema.column_removed(status.column_removed.entity_type,status.column_removed.name);}
else if(status.column_changed){SG.schema.column_changed(status.column_changed.entity_type,status.column_changed.name);}},scope:this};pi.show();var conn=new Ext.data.Connection();conn.request(options);},show_column:function(col,col_index)
{if(this.show_column_callback){this.show_column_callback.fn.call(this.show_column_callback.scope,col,col_index);}}});SG.util.UpdateTasks=function(config){Ext.apply(this,config);this.init();};SG.util.UpdateTasks.prototype={init:function(){var dlg_config={record:this.record};var sgd=new SG.UpdateTasksDialog(dlg_config);sgd.on('dialog_submitted',this.find_tasks_to_update,this);},find_tasks_to_update:function(project_id){this.widget.show_loading_overlay();this.entity_type=this.record.get('entity_type');var update_tasks_ds=new SG.Data.Set(this.entity_type);update_tasks_ds.on('load',this.update_tasks,this);var task_template_hash={type:'TaskTemplate',id:this.record.get_id(),name:this.record.get('code')};var spec={type:this.entity_type,columns:['task_template'],filters:{logical_operator:'and',conditions:[{path:'task_template',relation:'is',values:[task_template_hash],active:"true"}]},result:update_tasks_ds}
if(project_id!=-1){var project_hash={type:'Project',id:project_id};var project_cond={path:'project',relation:'is',values:[project_hash],active:"true"};spec.filters.conditions.push(project_cond);}
SG.Repo.query(spec);},update_tasks:function(ds){var requests=[];var handler=new SG.ResponseHandler();var crud;this.widget.hide_loading_overlay();this.entity_count=ds.count();for(var i=0;i<ds.count();i++){var rec=ds.get_record(i);crud={request_type:'update',type:ds.get_type(),id:rec.get_id(),column:'task_template',value:null};requests.push(crud);crud={request_type:'update',type:ds.get_type(),id:rec.get_id(),column:'task_template',value:rec.get('task_template')};requests.push(crud);}
if(requests.length>0){var crud_req=new SG.CrudRequest(requests,handler,true,true);crud_req.on('completed',this.on_complete,this);crud_req.send();}},on_complete:function(){var display_name;if(this.entity_count===0)
return;else if(this.entity_count===1)
display_name=SG.schema.entity_types[this.entity_type].display_name;else
display_name=SG.schema.entity_types[this.entity_type].display_name_pluralized;var html=this.entity_count+' '+display_name+' successfully updated.';SG.Message.show({html:html});}};SG.UpdateTasksDialog=function(config){SG.UpdateTasksDialog.superclass.constructor.call(this,config);};Ext.extend(SG.UpdateTasksDialog,SG.ModalDialog,{sg_dialog_header_text:'Update Tasks',sg_dialog_submit_button_text:'Update',sg_dialog_focus:'#sgd_project',draw_body:function(){var html;var projects=SG.schema.projects;var tpl="\""+this.record.get('code')+"\"";html="<table><tr><td style='padding-top: 3px; padding-right: 10px'>";html+="Push new tasks to all entities using task template "+tpl+" in:</td></tr>";html+="<tr><td style='padding-top: 5px'><select id='sgd_project'>"
html+="<option value='-1'>All Projects</option>";for(var i=0;i<projects.length;i++){html+="<option value='"+projects[i].id+"'>"+projects[i].name+"</option>";}
html+="</select></td></tr></table>";this.body.update(html);this.project_id=Ext.DomQuery.selectNode('div.sg_dialog > div.body select#sgd_project');},submit_values:function(){this.fireEvent('dialog_submitted',Number(this.project_id.value));return true;}});SG.util.EntityFieldsMenuHelper=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.EntityFieldsMenuHelper,Ext.util.Observable,{setup:null,init:function(){if(this.setup){this.setup();}
if(typeof this.through_join_fields=="undefined")
this.through_join_fields=[];},get_fields_menu_items:function()
{var items=[];var categorized_fields=SG.schema.get_categorized_fields(this.entity_type,false,true);items=this.categorized_fields_menu_items(categorized_fields,this.entity_type);if(this.only_simple_fields==true)
return items;var entity_type_name=SG.schema.entity_types[this.entity_type].display_name;var parent_entity_type_name;if(this.parent_entity)
parent_entity_type_name=SG.schema.entity_types[this.parent_entity.type].display_name;var multiple_through_joins=(this.through_join_fields.length>1);for(var i=0;i<this.through_join_fields.length&&this.parent_entity;i++)
{var parent_entity_link_field=this.through_join_fields[i].parent_entity_link_field;var group_title=parent_entity_type_name.toUpperCase()+"-SPECIFIC FIELDS";if(multiple_through_joins)
group_title+=": for "+parent_entity_link_field.display_name;items.push({heading:group_title});items=items.concat(this.fields_items(this.through_join_fields[i].fields,this.entity_type,'join_fields'));if(this.add_create_join_fields_items)
{var through_join_entity_type=parent_entity_link_field.through_join_entity_type;var extra_dialog_params={field_name_prefix:parent_entity_link_field.name+'.'+through_join_entity_type+'.',field_context_title_label:entity_type_name+" in "+parent_entity_type_name,entity_type:through_join_entity_type};items.push({html:"Add New "+entity_type_name+"-in-"+parent_entity_type_name+" Field...",value:'create_update_dc',config:extra_dialog_params});}}
var bubble_submenu_items=[];for(var i=0;i<categorized_fields.association.length;i++)
{var association_field=categorized_fields.association[i];var bubble_fields=SG.schema.get_bubble_fields(association_field,true);if(bubble_fields)
{bubble_submenu_items.push({html:association_field.display_name,submenu:{association_field:association_field,bubble_fields:bubble_fields,before_first_render:{fn:this.on_linked_field_submenu_before_first_render,scope:this}},});}}
if(bubble_submenu_items.length>0)
{items.push({heading:'LINKED FIELDS'});items=items.concat(bubble_submenu_items);}
return items;},categorized_fields_menu_items:function(fields,entity_type,association_field,polymorphic)
{var items=[];if(fields.ordinary.length>0)
items=items.concat(this.fields_items(fields.ordinary,entity_type,null,association_field,polymorphic));if(!this.no_steps)
{var aet=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(aet.indexOf(this.entity_type)!=-1)
{items.push({heading:'PIPELINE'});var pipeline_items=[];if(fields.pivot_column_fields.length>0)
pipeline_items=this.create_pipeline_menu_items(entity_type)
var no_steps_yet=(pipeline_items.length==1&&pipeline_items[0].no_steps_yet);if(!association_field&&this.pivot_items_callback!=undefined)
{var more_items=this.pivot_items_callback.fn.call(this.pivot_items_callback.scope,no_steps_yet,this.pivot_items_callback.special_items);pipeline_items=pipeline_items.concat(more_items);}
if(this.filter_step_field_format){items=items.concat(pipeline_items);}else{items.push({html:"Steps",submenu:{items:pipeline_items}});}}
if(this.linked_pivot_items_callback!=undefined)
{var linked_pipeline_items=this.linked_pivot_items_callback.fn.call(this.linked_pivot_items_callback.scope,this.linked_pivot_items_callback.special_items);if(linked_pipeline_items.length>0)
{items.push({heading:'LINKED PIPELINES'});items=items.concat(linked_pipeline_items);}}}
if(entity_type=='Task')
{items.push({heading:'DEPENDENCIES'});items=items.concat(this.fields_items(fields.dependency,entity_type,null,association_field,polymorphic));}
if(fields.audit.length>0)
{items.push({heading:'AUDIT FIELDS'});items=items.concat(this.fields_items(fields.audit,entity_type,null,association_field,polymorphic));}
if(fields.smart_cut.length>0)
{items.push({heading:'SMART FIELDS'});items=items.concat(this.fields_items(fields.smart_cut,entity_type,null,association_field,polymorphic));}
return items;},fields_items:function(fields,entity_type,mode,association_field,polymorphic)
{fields=sg_deep_copy(fields)
for(var i=0;i<fields.length;i++)
{var relative_field_name;if(association_field)
relative_field_name=SG.schema.generate_field_reference_name({type:polymorphic?"bubblepoly":"bubble",base_field:association_field.name,bubble_source_entity_type:entity_type,bubbled_up_field:fields[i].name});else
relative_field_name=fields[i].field_reference_name||fields[i].name;fields[i].relative_field_name=relative_field_name;var dname=null;if(this.column_display_names)
dname=this.column_display_names[relative_field_name];if(!dname)
dname=fields[i].display_name;fields[i].local_display_name=dname;}
var sorted_fields;if(this.column_display_names)
var sorted_fields=fields.sort(function(a,b){if(a.absolute_sort_order!=undefined&&b.absolute_sort_order!=undefined)
{if(a.absolute_sort_order>b.absolute_sort_order)return 1;if(a.absolute_sort_order<b.absolute_sort_order)return-1;return 0;}
var da=a.local_display_name.toLowerCase();var db=b.local_display_name.toLowerCase();if(da>db)return 1;if(da<db)return-1;return 0;});else
sorted_fields=fields;var items=[];for(var i=0;i<sorted_fields.length;i++)
{var field=sorted_fields[i];if(field.grid_column==false)
continue;var field_name=(association_field||mode=='join_fields')?field.relative_field_name:field.name;var display_name=field.display_name;var local_display_name=field.local_display_name;var html;if(display_name==local_display_name)
html=display_name;else
html=local_display_name+" <span class='col_mngmt_menu_orig_field_name'>("+
display_name+")</span>";var item_config={html:html,field:field_name,checked:this.field_checked_callback.fn.call(this.field_checked_callback.scope,field,field_name),disabled:this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,field,field_name)};if(this.on_field)
item_config.item_selected={fn:this.on_field.fn,scope:this.on_field.scope};if(this.field_value_callback)
item_config.value=this.field_value_callback.fn.call(this.field_value_callback.scope,field,field_name);if(this.pivot_column_field)
item_config.pivot_column_field=this.pivot_column_field;items.push(item_config);}
return items;},create_pipeline_menu_items:function(entity_type)
{var steps=SG.schema.get_pipeline_order_steps(entity_type);var fields=SG.schema.get_pipeline_order_fields(entity_type);if(steps.length==1&&steps[0].id==0)
{return[{no_steps_yet:true,disabled:true,html:'<div style="color:#777; font-style: italic; padding-top: 8px; padding-bottom: 5px;">'+'No Task Pipeline Steps exist yet for <br>'+
SG.schema.entity_types[entity_type].display_name.pluralize(2)+'.  You can manage the Task Pipeline<br> by clicking on the link below.</div>'}];}
if(this.filter_step_field_format||this.show_pivot_column_summary_fields){var task_fields=SG.schema.get_categorized_fields('Task',false,true).ordinary;}
var items=[];for(var i=0;i<fields.length;i++)
{var field=fields[i];var step=steps[i];var item_config={icon_name:'transparent_step_color',icon_bg_color:step.color,html:field.display_name,field:field.name};if(this.show_pivot_column_summary_fields){var sub_menu_items=this.create_pivot_column_summary_field_items(field,task_fields);item_config.submenu={items:sub_menu_items};}else if(this.filter_step_field_format){var sub_menu_items=this.create_step_task_field_items(field,task_fields);item_config.submenu={items:sub_menu_items};}else{item_config.checked=this.field_checked_callback.fn.call(this.field_checked_callback.scope,field,field.name);item_config.disabled=this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,field,field.name);if(this.on_field)
item_config.item_selected={fn:this.on_field.fn,scope:this.on_field.scope};if(this.field_value_callback)
item_config.value=this.field_value_callback.fn.call(this.field_value_callback.scope,field,field.name);if(this.pivot_column_field)
item_config.pivot_column_field=this.pivot_column_field;}
items.push(item_config);}
return items;},create_pivot_column_summary_field_items:function(schema_field,task_fields)
{var items=[];for(var i=0;i<task_fields.length;i++)
{var task_schema_field=task_fields[i];var field_name=schema_field.name+'$'+task_schema_field.name;var item={html:task_schema_field.display_name,field:field_name,checked:this.field_checked_callback.fn.call(this.field_checked_callback.scope,task_schema_field,field_name),disabled:this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,task_schema_field,field_name),};if(this.on_field)
item.item_selected={fn:this.on_field.fn,scope:this.on_field.scope};if(this.field_value_callback)
item.value=this.field_value_callback.fn.call(this.field_value_callback.scope,task_schema_field,field_name);if(this.pivot_column_field)
item.pivot_column_field=this.pivot_column_field;items.push(item);}
return items;},create_step_task_field_items:function(schema_field,task_fields){var items=[];for(var i=0;i<task_fields.length;i++)
{var task_schema_field=task_fields[i];var field_path=schema_field.name+'.Task.'+task_schema_field.name;var item={html:task_schema_field.display_name,field:field_path,checked:this.field_checked_callback.fn.call(this.field_checked_callback.scope,task_schema_field,field_path),disabled:this.field_disabled_callback.fn.call(this.field_disabled_callback.scope,task_schema_field,field_path),};if(this.on_field)
item.item_selected={fn:this.on_field.fn,scope:this.on_field.scope};if(this.field_value_callback)
item.value=this.field_value_callback.fn.call(this.field_value_callback.scope,task_schema_field,field_path);if(this.pivot_column_field)
item.pivot_column_field=this.pivot_column_field;items.push(item);}
return items;},on_linked_field_submenu_before_first_render:function(menu)
{var real_no_steps=this.no_steps?'true':'false';this.no_steps=true;this.old_field_disabled_callback=this.field_disabled_callback;this.field_disabled_callback={fn:function(field_schema,field_name)
{var disabled=this.old_field_disabled_callback.fn.call(this.old_field_disabled_callback.scope,field_schema,field_name);return disabled;},scope:this};if(menu.bubble_fields.length==1)
{menu.items=this.categorized_fields_menu_items(menu.bubble_fields[0].fields,menu.bubble_fields[0].entity_type,menu.association_field,false);}
else
{var submenus=[];for(var j=0;j<menu.bubble_fields.length;j++)
{var entity_type=menu.bubble_fields[j].entity_type;var items=this.categorized_fields_menu_items(menu.bubble_fields[j].fields,entity_type,menu.association_field,true);if(items.length>0)
submenus.push({html:SG.schema.entity_types[entity_type].display_name,submenu:{items:items}});}
menu.items=submenus;}
this.field_disabled_callback=this.old_field_disabled_callback;this.no_steps=real_no_steps;},});SG.util.GroupingMenuHelper=function(config){SG.util.GroupingMenuHelper.superclass.constructor.call(this,config);};Ext.extend(SG.util.GroupingMenuHelper,SG.util.EntityFieldsMenuHelper,{setup:function()
{this.on_field=this.on_grouping_field;this.field_value_callback={fn:function(field_schema,field_reference_name){return{column:field_reference_name,method:"exact",direction:"asc"}},scope:this};this.field_checked_callback={fn:function(field_schema,field_reference_name){return this.grouping&&this.grouping.column==field_reference_name;},scope:this},this.field_disabled_callback={fn:function(field_schema,field_reference_name){return field_schema.no_grouping},scope:this};this.no_steps=true;},get_menu_items:function()
{var present_grouping=this.grouping_setting_callback.fn.call(this.grouping_setting_callback.scope);this.grouping=false;this.grouping_count=0;if(present_grouping)
{this.grouping_count=present_grouping.length;if(present_grouping.length==1)
this.grouping=present_grouping[0];}
var grouping=this.grouping;if(grouping&&grouping.column)
{if(!SG.schema.get_field(this.entity_type,grouping.column))
grouping=false;}
var items=[];if(!this.no_advanced){items.push({html:'Advanced Grouping...',item_selected:{fn:this.on_advanced_grouping_menuitem,scope:this},icon_name:'icon_nested_grouping',checked:this.grouping_count>1});}
items.push({html:'Ungroup',item_selected:{fn:this.on_grouping_field.fn,scope:this.on_grouping_field.scope},disabled:this.grouping_count==0,value:'__ungroup__'});if(!(grouping===false))
{items.push({line:true});items.push({html:'Sort Groups Ascending',item_selected:{fn:this.on_grouping_field.fn,scope:this.on_grouping_field.scope},value:{column:grouping.column,method:grouping.method,direction:"asc"},icon_name:'icon_menu_arrow_up',checked:grouping.direction=='asc',});items.push({html:'Sort Groups Descending',item_selected:{fn:this.on_grouping_field.fn,scope:this.on_grouping_field.scope},value:{column:grouping.column,method:grouping.method,direction:"desc"},icon_name:'icon_menu_arrow_down',checked:grouping.direction=='desc',});}
if(this.on_open_close_all_groups!=undefined&&this.grouping_count>0)
{if(this.grouping_count>1)
items.push({line:true});items.push({html:'Open All Groups',item_selected:{fn:this.on_open_close_all_groups.fn,scope:this.on_open_close_all_groups.scope},value:'open'});items.push({html:'Close All Groups',item_selected:{fn:this.on_open_close_all_groups.fn,scope:this.on_open_close_all_groups.scope},value:'closed'});}
if(!(grouping===false))
{items.push({html:'Grouping Options',submenu:{items:this.grouping_submenu_items(grouping)}});}
items.push({line:true});items=items.concat(this.get_fields_menu_items());return items;},on_advanced_grouping_menuitem:function()
{this.on_advanced_grouping.fn.call(this.on_advanced_grouping.scope,this.column_display_names);},grouping_submenu_items:function(grouping)
{var items=[];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);items.push({html:"By exact value",checked:(grouping.method=="exact"),value:{column:grouping.column,method:"exact",direction:grouping.direction},item_selected:{fn:this.on_grouping_field.fn,scope:this.on_grouping_field.scope}});var grouping_options=SG.schema.grouping_options[schema_field.data_type];if(typeof grouping_options=="string")
grouping_options=SG.schema.grouping_options[grouping_options];if(grouping_options)
{for(var i=0;i<grouping_options.length;i++)
{var method=grouping_options[i][0];if(method=="entitytype"&&(SG.schema.allowed_entity_types(schema_field).length==1))
continue;items.push({html:grouping_options[i][1],checked:(grouping.method==method),value:{column:grouping.column,method:method,direction:grouping.direction,no_ungrouping:true},item_selected:{fn:this.on_grouping_field.fn,scope:this.on_grouping_field.scope}});}}
return items;},});SG.util.SortingMenuHelper=function(config){SG.util.SortingMenuHelper.superclass.constructor.call(this,config);};Ext.extend(SG.util.SortingMenuHelper,SG.util.EntityFieldsMenuHelper,{setup:function()
{this.on_field={fn:this.on_sort_menu_selected,scope:this};this.no_steps=true;this.field_value_callback={fn:function(field_schema,field_reference_name){if(this.sorting.length==1&&this.sorting[0].column==field_reference_name)
return[];else
return[{column:field_reference_name,direction:"asc",no_unsort:false}];},scope:this};this.field_checked_callback={fn:function(field_schema,field_reference_name){return this.sorting.length==1&&this.sorting[0].column==field_reference_name;},scope:this},this.field_disabled_callback={fn:function(field_schema,field_reference_name){return field_schema.no_sorting},scope:this};},get_menu_items:function()
{this.sorting=this.get_sorts_callback.fn.call(this.get_sorts_callback.scope);var sorting=this.sorting;var items=[];var sort_col=[];var disabled=sorting.length!==1;if(!disabled)
sort_col=sorting[0].column;items.push({html:'Sort Ascending',disabled:disabled,checked:disabled?false:sorting[0].direction=='asc',icon_name:'icon_menu_arrow_up',value:disabled?[]:[{column:sort_col,direction:'asc'}],item_selected:{fn:this.on_sort_menu_selected,scope:this}});items.push({html:'Sort Descending',disabled:disabled,checked:disabled?false:sorting[0].direction=='desc',icon_name:'icon_menu_arrow_down',value:disabled?[]:[{column:sort_col,direction:'desc'}],item_selected:{fn:this.on_sort_menu_selected,scope:this}});if(!this.no_advanced)
{items.push({html:'Advanced Sorting...',checked:sorting.length>1,item_selected:{fn:this.on_sort_advanced,scope:this}});}
items.push({line:true});items=items.concat(this.get_fields_menu_items());return items;},on_sort_advanced:function()
{var helper=new SG.util.EntityFieldsMenuHelper({entity_type:this.entity_type,no_steps:true,field_value_callback:{fn:function(sf,name){return name},scope:this},field_checked_callback:{fn:function(){return false},scope:this},field_disabled_callback:{fn:function(sf,name){return sf.no_sorting},scope:this}});var mcd=new SG.AdvancedSortingDialog({entity_type:this.entity_type,sorts:this.sorting,menu_items:helper.get_fields_menu_items(),column_display_name_fn:this.column_display_name_callback});mcd.on('dialog_submitted',this.set_sorts_callback.fn,this.set_sorts_callback.scope);},on_sort_menu_selected:function(menu,item)
{this.set_sorts_callback.fn.call(this.set_sorts_callback.scope,item.value);}});SG.util.FieldsMenuHelper=function(config){SG.util.FieldsMenuHelper.superclass.constructor.call(this,config);};Ext.extend(SG.util.FieldsMenuHelper,SG.util.EntityFieldsMenuHelper,{get_menu_items:function()
{var items=this.get_fields_menu_items();return items;},});SG.util.URLResolver=function(config){Ext.apply(this,config);this.init();};SG.util.URLResolver.prototype={regex:/\{([\w\.]+)\}/g,init:function(){if(this.url===''){this.fire_callback();return;}
this.url=this.url.replace('{current_user.login}',SG.globals.current_user.login);this.url=this.url.replace('{current_user.id}',SG.globals.current_user.id);this.url=this.url.replace('{current_user.fullname}',SG.globals.current_user.display_name);var match;var fields=[];while((match=this.regex.exec(this.url))!==null){fields.push(match[1]);}
if(fields.length===0){this.fire_callback();return;}
var resolve_fields=[];var error_fields=[];var i,f;for(i=0;i<fields.length;i++){f=fields[i];if(SG.schema.get_field(this.entity.type,f))
resolve_fields.push(f);else
error_fields.push(f);}
if(error_fields.length>0){this.url='';this.fire_callback();return;}
this.entity_set=new SG.Data.Set(this.entity.type);this.entity_set.on('load',this.on_load,this);this.request_data(resolve_fields);},fire_callback:function(){this.callback.fn.call(this.callback.scope,this.url);if(this.entity_set){this.entity_set.un('load',this.on_load);this.entity_set.destroy();}},request_data:function(fields){var spec={type:this.entity.type,id:this.entity.id,columns:fields,result:this.entity_set};SG.Repo.find(spec);},on_load:function(){var rec=this.entity_set.get_record(0);var fields=rec.get_fields();var f;for(var i=0;i<fields.length;i++){f=fields[i];this.url=this.url.replace('{'+f+'}',this.get_url_value(f,rec.get(f)));}
this.fire_callback();},get_url_value:function(field,field_value){var sf=SG.schema.get_field(this.entity.type,field);if(sf.data_type=='entity'){return field_value?field_value.name:'';}else if(sf.data_type=='multi_entity'){var s='';for(var i=0;i<field_value.length;i++)
{if(i!=0)
s+=',';s+=field_value[i].name;}
return s;}else if(sf.data_type=='url'){return field_value?field_value.url:'';}else{return field_value;}}};SG.util.RowDragReorder=function(config)
{Ext.apply(this,config);SG.util.RowDragReorder.superclass.constructor.call(this,this.container,"layouts",{dragElId:this.drag_element_proxy_id,resizeFrame:false,scroll:false});};Ext.extend(SG.util.RowDragReorder,Ext.dd.DDProxy,{handleMouseDown:function(e){var target=Ext.get(e.getTarget());var drag_td=target.findParent(this.drag_handle_selector,this.container,true);if(!drag_td)return;this.layout_elem=drag_td.findParent(this.row_element_selector,this.container,true);if(this.row_proxy_name_selector==this.row_element_selector)
this.layout_name=this.layout_elem.dom.innerHTML;else
this.layout_name=this.layout_elem.child(this.row_proxy_name_selector).dom.innerHTML;this.layouts_dom=this.layout_elem.dom.parentNode;this.last_y=0;this.going_up=false;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y){this.cache_regions();this.drag_el=Ext.get(this.getDragEl());var left=this.layout_elem.getX();var top=this.layout_elem.getY();this.setDelta(x-left,y-top);if(this.layout_name.indexOf('<td')>-1&&this.layout_name.indexOf('<table')==-1)
{this.layout_name='<table>'+this.layout_name+'</table>';}
this.drag_el.update(this.layout_name);this.layout_elem.hide();Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);if(this.b4_start_drag_callback)
this.b4_start_drag_callback.fn.call(this.b4_start_drag_callback.scope,x,y);},cache_regions:function(){this.region_cache=[];var i,d;for(i=0;i<this.layouts_dom.childNodes.length;i++){d=this.layouts_dom.childNodes[i];this.region_cache.push({y:Ext.lib.Dom.getY(d),elem:d});}},find_elem:function(y){if(y<this.region_cache[0].y)
return this.region_cache[0].elem;for(var i=1;i<this.region_cache.length;i++){if(y<this.region_cache[i].y){return this.region_cache[i-1].elem}}
return this.region_cache[this.region_cache.length-1].elem;},onDrag:function(e)
{var y=e.getXY()[1];if(y<this.last_y){this.going_up=true;}else if(y>this.last_y){this.going_up=false;}
var target=this.find_elem(y);if(target){if(this.going_up){this.layouts_dom.insertBefore(this.layout_elem.dom,target);}else{this.layouts_dom.insertBefore(this.layout_elem.dom,target.nextSibling);}
this.cache_regions();}
this.last_y=y;},endDrag:function(e)
{this.layout_elem.show();this.reorder_callback.fn.call(this.reorder_callback.scope);}});SG.util.NotificationCenter=function(){this.init();};SG.util.NotificationCenter.prototype={init:function(){this.observers={};},add_observer:function(config){this.observers[config.uuid]=this.observers[config.uuid]||{};this.observers[config.uuid][config.name]=this.observers[config.uuid][config.name]||[];this.observers[config.uuid][config.name].push(config.callback);},remove_observer:function(config){if(config.uuid in this.observers&&config.name in this.observers[config.uuid]){var arr=this.observers[config.uuid][config.name]||[];var idx=null;for(var i=0;i<arr.length;i++){if(arr[i].fn===config.callback.fn&&arr[i].scope===config.callback.scope)
{idx=i;break;}}
if(idx!==null)
arr.splice(idx,1);}},post:function(config){if(config.uuid in this.observers&&config.name in this.observers[config.uuid]){var arr=this.observers[config.uuid][config.name]||[];for(var i=0;i<arr.length;i++){arr[i].fn.call(arr[i].scope,config.args,config.canvas_id);}}}};SG.NotificationCenter=new SG.util.NotificationCenter();SG.ImageButton={template:'<div {id} class="{extra_classes} {image}" sg_image_button="true" up_class="{up_class}" pressed_class="{pressed_class}" '+'selected_class="{selected_class}" button_state="{state}" extra_classes="{extra_classes}"></div>',render:function(config)
{if(typeof sg_render_image_button_initialized=='undefined')
{Ext.EventManager.on(document.body,'mousedown',this.on_image_button_mousedown);Ext.EventManager.on(document.body,'mouseup',this.on_image_button_mouseup);sg_render_image_button_initialized=true;this.template=new Ext.Template(this.template);this.template.disableFormats=true;this.template.compile();}
if(!config.state)
config.state='up';return this.template.apply({image:config[config.state],up_class:config.up,pressed_class:config.pressed,selected_class:config.selected,state:config.state,id:config.id?'id="'+config.id+'"':'',extra_classes:config.extra_classes?config.extra_classes:''});},on_image_button_mousedown:function(evt)
{var target=evt.getTarget();if(target.hasAttribute('sg_image_button'))
{target.className=target.getAttribute('extra_classes')+" "+target.getAttribute('pressed_class');}},on_image_button_mouseup:function(evt)
{var target=evt.getTarget();if(!target)
return;var is_image_button=(target.hasAttribute&&target.hasAttribute('sg_image_button'))||(target.parentNode&&(target=target.parentNode).hasAttribute('sg_image_button'))
if(is_image_button)
{target.className=target.getAttribute('extra_classes')+" "+
(target.getAttribute('button_state')=='up'?target.getAttribute('up_class'):target.getAttribute('selected_class'));}},toggle:function(dom_elem,state)
{if(!state)
state=(dom_elem.getAttribute('button_state')=='up'?'selected':'up');dom_elem.setAttribute('button_state',state);dom_elem.className=dom_elem.getAttribute('extra_classes')+" "+
(state=='up'?dom_elem.getAttribute('up_class'):dom_elem.getAttribute('selected_class'));},is_selected:function(dom_elem)
{return(dom_elem.getAttribute('button_state')=='selected');}};SG.util.TimeoutQueue=function(){this.timerID=0;this.items=[];}
SG.util.TimeoutQueue.prototype={start:function(){if(this.timerID)
return;this.run();},stop:function(){this.timerID=0;},run:function(){var items=this.items.splice(0,50);for(var i=0;i<items.length;i++){items[i]();}
if(this.items.length==0){this.stop();}else{var q=this;this.timerID=setTimeout(function(){q.run()},0);}},add:function(fn){this.items.push(fn);this.start();}};SG.TimeoutQueue=new SG.util.TimeoutQueue();SG.util.AddNoteToSelected=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.AddNoteToSelected,SG.Component,{init:function(){this.entity_type=this.data_set.get_type();this.create_new_linked_note();},create_new_linked_note:function()
{this.record=new SG.Data.Record('Note');if(!this.create_default_note_only){var nef_config={entity_type:'Note',single_project:this.widget.single_project_from_context(),all_projects:this.widget.context_projects(),tasks_without_link_entities:[],wait_for_source_record:true};this.dialog=sg_new_entity_dialog(nef_config);var me=this;this.add_event(me.dialog,"entity_created",function(){me.widget.reload_all_entities();});}
if(this.pivot_field)
this.handle_pivot_widget_tasks();else
this.handle_generic_entity();},handle_generic_entity:function()
{var recs=this.get_unique_selected_records();var parent_entities=[];var note_records=[];var grandparent_entities=[];for(var i=0;i<recs.length;i++)
{parent_entities.push(this.record_to_entity(recs[i]));note_records.push(new SG.Data.Record('Note'));if(this.context_entity)
grandparent_entities.push(this.context_entity);}
var config={entity_type:'Note',parent_entities:parent_entities,data_records:note_records,};if(grandparent_entities.length>0){config.grandparent_entities=grandparent_entities;this.grandparent_entity=grandparent_entities[0];}
if(parent_entities.length>0)
this.parent_entity_type=parent_entities[0].type;var factory=new SG.MultiEntityFactory(config);factory.on('done',this.on_create_notes,this);factory.create();},on_create_notes:function(note_records)
{note_records[0].copy_onto(this.record);var note_links=this.get_unique_entities(note_records,'note_links');var tasks=this.get_unique_entities(note_records,'tasks');var addressings_cc=this.get_unique_entities(note_records,'addressings_cc');this.record.set('note_links',note_links);this.record.set('tasks',tasks);this.record.set('addressings_cc',addressings_cc);if(note_links.length>0)
this.set_subject(note_links);if(this.create_default_note_only){this.on_default_note_created.fn.call(this.on_default_note_created.scope,this.record);}else{this.dialog.source_record_ready(this.record);}},set_subject:function(note_links)
{if(this.grandparent_entity&&this.grandparent_entity.type=='Playlist'&&this.parent_entity_type&&this.parent_entity_type=='Version'){var parser=SG.GridEditor.DateParser;var today_string=parser.format(parser.get_normalized_today(),' - F s');var subject=this.grandparent_entity.name+today_string;this.record.set('subject',subject);return;}
var names=SG.globals.current_user.entity_hash.name.split(' ');var subject=names[0]+"'s Note on";if(SG.globals.custom_for=="drd"||SG.globals.custom_for=="brownbag"){subject="";}
var total=note_links.length<6?note_links.length:3;for(var i=0;i<total;i++)
{if(i==(total-1)&&total>1){if(note_links.length>5)
subject+=', '+note_links[i].name+' and ';else
subject+=' and '}else{subject+=' '+note_links[i].name}
if((i+2)<total)
subject+=',';}
if(note_links.length<6&&note_links.length>1)
subject+=note_links[note_links.length-1].name;else if(note_links.length>5)
{var dn_plural=SG.schema.entity_types[note_links[0].type]['display_name_pluralized'];subject+=(note_links.length-3)+' more '+dn_plural;}
if(SG.globals.custom_for=="drd"){if(this.parent_entity_type!='Version'){subject=""}}else if(SG.globals.custom_for=="drd"){subject=""}
this.record.set('subject',subject);},handle_pivot_widget_tasks:function()
{var parent_entities=[];var note_records=[];var grandparent_entities=[];var entity_recs=this.get_unique_selected_records();var pivot_widget=this.widget.get_child(this.pivot_field);for(var i=0;i<entity_recs.length;i++)
{var entity_rec=entity_recs[i];var task_records=pivot_widget.get_task_records_for_entity(entity_rec.id);for(var j=0;j<task_records.length;j++)
{parent_entities.push(this.record_to_entity(task_records[j]));note_records.push(new SG.Data.Record('Note'));if(this.context_entity)
grandparent_entities.push(this.context_entity);}
if(task_records.length==0){parent_entities.push(this.record_to_entity(entity_rec));note_records.push(new SG.Data.Record('Note'));if(this.context_entity)
grandparent_entities.push(this.context_entity);}}
var config={entity_type:'Note',parent_entities:parent_entities,data_records:note_records};if(grandparent_entities.length>0)
config.grandparent_entities=grandparent_entities;var factory=new SG.MultiEntityFactory(config);factory.on('done',this.on_create_notes,this);factory.create();},get_unique_selected_records:function()
{var entity_map={};for(var i=0;i<this.record_ids.length;i++)
{var rec=this.data_set.get_record_by_id(this.record_ids[i]);entity_map[rec.id]=rec;}
var ret=[];for(var id in entity_map)
{if(!entity_map.hasOwnProperty(id))continue;ret.push(entity_map[id]);}
return ret;},record_to_entity:function(record)
{var ident_field=SG.schema.get_identifier_field(record.type);var name=record.get(ident_field);if(!name)name='';var ret={type:record.type,id:record.id,valid:'valid',name:name};var proj=record.get('project');if(proj)
ret.project_id=proj.id;return ret;},get_unique_entities:function(records,multi_entity_field_name)
{var entities=[];var entity_ids=[];for(var i=0;i<records.length;i++)
{var rec=records[i];var rec_entities=rec.get(multi_entity_field_name);if(!rec_entities)continue;for(var j=0;j<rec_entities.length;j++)
{var rec_entity=rec_entities[j];if(entity_ids.indexOf(rec_entity.id)==-1)
{entities.push(rec_entity);entity_ids.push(rec_entity.id);}}}
return entities;},});SG.util.AddTaskToSelected=function(config){Ext.apply(this,config);this.init();};Ext.extend(SG.util.AddTaskToSelected,SG.Component,{init:function(){this.entity_type=this.data_set.get_type();this.create_new_linked_tasks();},create_new_linked_tasks:function()
{var task_record,entity_record;if(this.pivot_field){var pivot_widget=this.widget.get_child(this.pivot_field);task_record=pivot_widget.get_new_entity_defaults_from_context();}else{task_record=new SG.Data.Record();}
var ident_field=SG.schema.get_identifier_field(this.entity_type);var entity_record=this.data_set.get_record_by_id(this.record_ids[0]);if(this.record_ids.length==1)
{task_record.set('entity',{type:this.entity_type,id:this.record_ids[0],valid:'valid',name:entity_record.get(ident_field)});}
else
{task_record.set('entity',{type:this.entity_type,id:0,valid:'valid',name:''});}
var single_project=entity_record.get('project');if(this.entity_type=="Project"){single_project={type:"Project",id:this.record_ids[0],valid:'valid',name:entity_record.get(ident_field)};}
var nef_config={entity_type:'Task',single_project:single_project,all_projects:this.widget.context_projects(),source_record:task_record,hide_project_selector:true};if(this.record_ids.length>1)
{nef_config.create_multiple_field='entity';nef_config.create_multiple_field_values=[];for(var i=0;i<this.record_ids.length;i++)
{var rec=this.data_set.get_record_by_id(this.record_ids[i]);var single_project=rec.get('project');if(this.entity_type=="Project"){single_project={type:"Project",id:this.record_ids[i],valid:'valid',name:rec.get(ident_field)};}
entity_record=this.data_set.get_record_by_id(this.record_ids[i]);nef_config.create_multiple_field_values.push({type:this.entity_type,id:this.record_ids[i],valid:'valid',name:rec.get(ident_field),project:single_project});}}
var me=this.widget;var nef=sg_new_entity_dialog(nef_config);this.add_event(nef,"entity_created",function(){me.reload_all_entities();});}});SG.util.PlayInRV=function(config){Ext.apply(this,config);this.init();};SG.util.PlayInRV.prototype={init:function(){var ordered_ids=this.ids.join(",");var method;if(this.mode=="play"){method="shotgun.sessionFromVersionIDs";}else if(this.mode=="compare"){method="shotgun.compareFromVersionIDs";}
var cmd=" -l -play";if(SG.globals.custom_for=="windmill_lane"){cmd=" -l";}
var hostname=window.location.protocol+'//'+window.location.host;cmd+=" -eval 'shotgun.theMode().setServerURLValue(\""+hostname+"\""+");"+method+"(int[] {"+ordered_ids+"});'";var baked_cmd="";for(var i=0,len=cmd.length;i<len;++i){baked_cmd+=cmd.charCodeAt(i).toString(16);}
document.location="rvlink://baked/"+baked_cmd;}};SG.util.PlayInCineSyncOnline=function(config){Ext.apply(this,config);this.init();};SG.util.PlayInCineSyncOnline.prototype={init:function(){var cineSyncUrl="http://www.cinesynconline.com/shotgun/session";var query=[];for(var i=0;i<this.versions.length;i++)
{var v=this.versions[i];if(v['name']){query.push("name"+i+"="+encodeURIComponent(v['name']));}
if(v['movie_path']){query.push("path"+i+"="+window.location.protocol+'//'+window.location.host+v['movie_path']);}
if(v['thumb_path']){query.push("thumbnail"+i+"="+window.location.protocol+'//'+window.location.host+v['thumb_path']);}}
window.open(cineSyncUrl+"?"+query.join("&"),"cineSyncWindow");}};SG.util.SummaryMenuHelper={};SG.util.SummaryMenuHelper.get_summary_calculation_menu_items=function(entity_type,current_summary,ignore_non_numeric)
{if(ignore_non_numeric)
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=true;var schema_field=SG.schema.get_field(entity_type,current_summary.column);var options=SG.schema.summary_options[schema_field.data_type]||[];var names=SG.schema.summary_display_names;var items=[];var opt;for(var i=0;i<options.length;i++){opt=options[i];if(this.summary_operator_to_ignore(opt))
continue;var option_name=names[opt];if(opt!=='percentage'&&opt!=='status_percentage'){var item={html:option_name,value:{column:schema_field.name,type:opt,value:null},checked:(current_summary.type===opt),};items.push(item);}else{items.push({html:names[opt],submenu:{items:this.get_percentage_summary_items(current_summary,schema_field)}});}}
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;return items;};SG.util.SummaryMenuHelper.get_percentage_summary_items=function(current_summary,schema_field)
{var items=[];var list=schema_field;var percentage_type=(schema_field.data_type==='status_list'?'status_percentage':'percentage');var i;if(schema_field.data_type==='status_list')
{list={values:[],display_values:[]};var status_list=SG.schema.status_list;var status_list_subset=schema_field.status_list_subset;for(i=0;i<status_list_subset.length;++i)
{list.values.push(status_list_subset[i]);list.display_values.push(status_list[status_list_subset[i]].name);}}
for(i=0;i<list.values.length;i++)
{var item={html:list.display_values[i],value:{column:schema_field.name,type:percentage_type,value:list.values[i]},checked:(current_summary.type==percentage_type&&current_summary.value==list.values[i]),};items.push(item);}
return items;};SG.util.SummaryMenuHelper.find_first_non_record_count_summary=function(entity_type,ignore_non_numeric)
{if(ignore_non_numeric)
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=true;var categorized_fields=SG.schema.get_categorized_fields(entity_type,false,true);var summary_options=SG.schema.summary_options;var schema_fields=categorized_fields['ordinary'];for(var i=0;i<schema_fields.length;i++)
{var schema_field=schema_fields[i];var summary_ops=summary_options[schema_field.data_type];if(!summary_ops)continue;for(j=0;j<summary_ops.length;j++)
{var summary_op=summary_ops[j];if(!this.summary_operator_to_ignore(summary_op))
{SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;return{column:schema_field.name,type:summary_op,value:null};}}}
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;};SG.util.SummaryMenuHelper.schema_field_has_other_summary_options=function(schema_field,ignore_non_numeric)
{if(schema_field.no_summary)
return false;var summary_options=SG.schema.summary_options;var summary_ops=summary_options[schema_field.data_type];if(!summary_ops)
return false;if(ignore_non_numeric)
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=true;for(var i=0;i<summary_ops.length;i++)
{var summary_op=summary_ops[i];if(!this.summary_operator_to_ignore(summary_op))
{SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;return true;}}
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;return false;};SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;SG.util.SummaryMenuHelper.summary_operator_to_ignore=function(summary_op)
{if(SG.util.SummaryMenuHelper.ignore_non_numeric_summaries)
return["none","record_count",'earliest','latest','status_list'].indexOf(summary_op)!=-1;else
return["none","record_count"].indexOf(summary_op)!=-1;};SG.util.SummaryMenuHelper.first_list_value=function(schema_field)
{if(schema_field.data_type==='status_list'&&schema_field.status_list_subset.length>0)
{return schema_field.status_list_subset[0];}
else if(schema_field.data_type=='list'&&schema_field.values.length>0)
{return schema_field.values[0];}
return null;};SG.util.SummaryMenuHelper.first_good_summary_operator=function(schema_field,ignore_non_numeric)
{if(ignore_non_numeric)
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=true;var summary_options=SG.schema.summary_options;var summary_ops=summary_options[schema_field.data_type];for(var i=0;i<summary_ops.length;i++)
{var summary_op=summary_ops[i];if(!SG.util.SummaryMenuHelper.summary_operator_to_ignore(summary_op))
{SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;return summary_op;}}
SG.util.SummaryMenuHelper.ignore_non_numeric_summaries=false;};SG.util.CanvasFieldRenderer=function(config){Ext.apply(this,config);this.init();};SG.util.CanvasFieldRenderer.prototype={init:function()
{this.images={};this.schema_fields={};this.loaded_images=[];this.image_render_queue={};for(var i=0;i<this.fields.length;i++)
{var field=this.fields[i];var schema_field=SG.schema.get_field(this.entity_type,field);this.schema_fields[field]=schema_field;}},render_fields:function(record,x,y,fields,alignment)
{if(this.is_ff_3)
return;this.ctx.font='11px Verdana, Arial, Helvetica, sans-serif';this.ctx.fillStyle="black";var w=0;var cur_x=x;for(var i=0;i<fields.length;i++)
{var field=fields[i];var schema_field=this.schema_fields[field];var value=record.get(field);if(this.is_no_value(value,schema_field)){this.ctx.font='italic 11px Verdana, Arial, Helvetica, sans-serif';this.ctx.fillStyle="gray";w=this.render_string(schema_field.display_name,cur_x,y,alignment);this.ctx.font='11px Verdana, Arial, Helvetica, sans-serif';this.ctx.fillStyle="black";}else if(schema_field.data_type=='status_list')
w=this.render_status(value,cur_x,y,alignment);else if(schema_field.data_type=='entity')
w=this.render_one_entity(value,cur_x,y,alignment);else if(schema_field.data_type=='multi_entity')
w=this.render_entities(value,cur_x,y,alignment);else if(schema_field.data_type=='currency')
w=this.render_currency(value,cur_x,y,alignment);else if(schema_field.data_type=='image')
w=this.render_thumbnail(value,cur_x,y,alignment);else if(schema_field.data_type=='footage')
w=this.render_footage(value,cur_x,y,alignment);else if(['duration','percent'].indexOf(schema_field.data_type)!=-1)
{var ren_name=SG.Renderers.renderer_defaults[schema_field.data_type];var str=SG.Renderers[ren_name].render(value);w=this.render_string(str,cur_x,y,alignment);}
else
{var ren_name=schema_field.renderer||SG.Renderers.renderer_defaults[schema_field.data_type]||"text";var str=SG.Renderers[ren_name].render_for_attribute(value,schema_field);w=this.render_string(str,cur_x,y,alignment);}
if(alignment=='right')
{cur_x+=w;if(i!=(fields.length-1))
cur_x+=this.render_string(', ',cur_x,y,alignment);}
else
{cur_x-=w;if(i!=(fields.length-1))
cur_x-=this.render_string(', ',cur_x,y,alignment);}}},is_no_value:function(value,schema_field){var no_value=false;if(value===null||value===undefined)
no_value=true;if((!no_value&&value.constructor==Array&&value.length==0)||(!no_value&&schema_field.data_type=='text'&&value=='')){no_value=true;}
return no_value;},render_string:function(str,x,y,alignment)
{var align=alignment=='right'?'left':'right';this.ctx.textAlign=align;this.ctx.fillText(str,x,y);var mt=this.ctx.measureText(str);return mt.width;},render_image:function(src,x,y,max_size)
{var img=this.get_image(src);if(this.loaded_images.indexOf(src)!=-1)
{if(max_size!=undefined)
this.render_image_with_aspect(img,x,y,max_size);else
this.ctx.drawImage(img,x,y);}
else
this.add_to_image_render_queue(src,x,y,max_size);},render_status:function(val,x,y,alignment)
{if(!val)return 0;var src;var status=SG.schema.status_list[val];if(status&&status.image)
src=status.icon;else
src='/images/status_list/icon_'+val+'.png';var xx=alignment=='right'?x:x-16;var yy=y-10;this.render_image(src,xx,yy);return 16;},render_one_entity:function(val,x,y,alignment)
{if(!val)return 0;var xx,w;var yy=y-12;var src='/images/icon_'+val.type+'.png';if(alignment=='right')
{xx=x;this.render_image(src,xx,yy);xx+=16;w=this.render_string(val.name,xx,y,alignment);}
else
{w=this.render_string(val.name,x,y,alignment);xx=x-w-16;this.render_image(src,xx,yy);}
return w+16;},render_entities:function(vals,x,y,alignment)
{if(!vals)return 0;var w;var cur_x=x;for(var i=0;i<vals.length;i++)
{var val=vals[i];w=this.render_one_entity(val,cur_x,y,alignment);if(alignment=='right')
{cur_x+=w;if(i!=(vals.length-1))
cur_x+=this.render_string(', ',cur_x,y,alignment);}
else
{cur_x-=w;if(i!=(vals.length-1))
cur_x-=this.render_string(', ',cur_x,y,alignment);}}
return Math.abs(x-cur_x);},get_image:function(src)
{if(!this.images[src])
{this.images[src]=new Image();this.images[src].src=src;var me=this;this.images[src].onload=function(e){me.on_image_load(src);};this.images[src].onerror=function(e){me.on_image_error(src);};}
return this.images[src];},on_image_error:function(src){if(this.missing_image_url){this.images[src].src=this.missing_image_url;}else{this.images[src].src="/images/missing_image.png";}},on_image_load:function(src)
{this.loaded_images.push(src);this.render_image_from_queue(src);},add_to_image_render_queue:function(src,x,y,max_size)
{if(this.image_render_queue[src])
this.image_render_queue[src].push({x:x,y:y,max_size:max_size});else
this.image_render_queue[src]=[{x:x,y:y,max_size:max_size}];},render_image_from_queue:function(src)
{var queue=this.image_render_queue[src];if(!queue)return;for(var i=0;i<queue.length;i++)
{var loc=queue[i];var img=this.get_image(src);if(loc.max_size!=undefined)
this.render_image_with_aspect(img,loc.x,loc.y,loc.max_size);else
this.ctx.drawImage(img,loc.x,loc.y);}
this.image_render_queue[src]=false;},render_image_with_aspect:function(img,x,y,max_size)
{if(img.height>img.width)
{var width=Math.round(max_size*(img.width/img.height));var offset=(max_size-width)/2;this.ctx.drawImage(img,x+offset,y,width,max_size);}else{var height=Math.round(max_size*(img.height/img.width));this.ctx.drawImage(img,x,y,max_size,height);}},render_currency:function(val,x,y,alignment)
{var str=SG.Renderers['currency'].render(val);str=str.replace(/&nbsp;/g,'');if(val<0&&SG.globals.preferences.format_currency_fields_negative_red)
this.ctx.fillStyle="red";var w=this.render_string(str,x,y,alignment);this.ctx.fillStyle="black";return w;},render_thumbnail:function(val,x,y,alignment)
{if(val==null)return 0;if(alignment=='left')
this.render_image('/thumbnail/image/'+val,x-18,y-10,16);else
this.render_image('/thumbnail/image/'+val,x+2,y-10,16);return 18;},render_footage:function(val,x,y,alignment)
{var str=SG.Renderers['footage'].render(val);var w=this.render_string(str,x,y,alignment);this.ctx.fillStyle="black";return w;},};SG.CheckboxManager=function(){this.events={'change':true};};Ext.extend(SG.CheckboxManager,Ext.util.Observable,{render:function(id,extra_classes,state,disabled,value,attributes)
{this.setup_listener();if(!state)
state='unchecked';else if(state===true)
state='checked';var image_class_name=state=='checked'?'checkbox_checked':state=='dashed'?'checkbox_dashed':'checkbox_cleared';if(disabled)
{image_class_name+='_disabled';disabled=' disabled="true"';}
else
disabled='';if(value)
value=' value="'+value+'"';else
value='';if(id)
id=' id="'+id+'" ';else
id='';if(!attributes)
attributes='';return['<div class="sg_checkbox ',image_class_name,' ',extra_classes?extra_classes:'','" checkbox_state="',state,'"',value,disabled,id,attributes,'></div>'].join('');},get_state:function(checkbox)
{if(typeof checkbox=='string')
{checkbox=document.getElementById(checkbox);}
return checkbox.getAttribute('checkbox_state');},is_disabled:function(checkbox)
{if(typeof checkbox=='string')
{checkbox=document.getElementById(checkbox);}
return(checkbox.getAttribute('disabled')=="true");},get_checkbox:function(checkbox_id)
{return document.getElementById(checkbox_id);},set_state:function(checkbox,state)
{if(typeof checkbox=='string')
checkbox=document.getElementById(checkbox);if(!state)
state='unchecked';else if(state===true)
state='checked';var current_state=checkbox.getAttribute('checkbox_state');if(current_state==state)
return;var elem=Ext.get(checkbox);var image_class_name=current_state=='checked'?'checkbox_checked':current_state=='dashed'?'checkbox_dashed':'checkbox_cleared';elem.removeClass(image_class_name);image_class_name=state=='checked'?'checkbox_checked':state=='dashed'?'checkbox_dashed':'checkbox_cleared';elem.addClass(image_class_name);checkbox.setAttribute('checkbox_state',state);},disable:function(checkbox)
{if(typeof checkbox=='string')
checkbox=document.getElementById(checkbox);var current_state=checkbox.getAttribute('checkbox_state');var from_class,to_class;if(current_state=='checked')
{from_class='checkbox_checked';to_class='checkbox_checked_disabled';}
else if(current_state=='unchecked')
{from_class='checkbox_cleared';to_class='checkbox_cleared_disabled';}
else
{from_class='checkbox_dashed';to_class='checkbox_dashed_disabled';}
var elem=Ext.get(checkbox);elem.replaceClass(from_class,to_class);checkbox.setAttribute('disabled',true);},undisable:function(checkbox)
{if(typeof checkbox=='string')
checkbox=document.getElementById(checkbox);if(!checkbox.hasAttribute('disabled'))
return;checkbox.removeAttribute('disabled');var current_state=checkbox.getAttribute('checkbox_state');var from_class,to_class;if(current_state=='checked')
{to_class='checkbox_checked';from_class='checkbox_checked_disabled';}
else if(current_state=='unchecked')
{to_class='checkbox_cleared';from_class='checkbox_cleared_disabled';}
else
{to_class='checkbox_dashed';from_class='checkbox_dashed_disabled';}
var elem=Ext.get(checkbox);elem.replaceClass(from_class,to_class);},toggle:function(checkbox)
{if(typeof checkbox=='string')
checkbox=document.getElementById(checkbox);var current_state=checkbox.getAttribute('checkbox_state');var new_state=current_state=='checked'?'unchecked':'checked';this.set_state(checkbox,new_state);},setup_listener:function()
{if(!this.setup)
{Ext.EventManager.addListener(document.body,'click',this.on_page_click,this);Ext.EventManager.addListener(document.body,'mousedown',this.on_page_mousedown,this);Ext.EventManager.addListener(document.body,'mouseup',this.on_page_mouseup,this);this.setup=true;}},on_page_mousedown:function(event)
{if(event.target.className.indexOf('sg_checkbox ')==0)
{if(event.target.getAttribute('disabled')=='true')
return;var elem=Ext.get(event.target);var state=elem.dom.getAttribute('checkbox_state');var image_class_name=state=='checked'?'checkbox_checked':state=='dashed'?'checkbox_dashed':'checkbox_cleared';elem.removeClass(image_class_name);image_class_name=state=='checked'?'checkbox_checked_onclick':state=='dashed'?'checkbox_dashed_onclick':'checkbox_cleared_onclick';elem.addClass(image_class_name);}},on_page_mouseup:function(event)
{if(event.target.className.indexOf('sg_checkbox ')==0)
{if(event.target.getAttribute('disabled')=='true')
return;var elem=Ext.get(event.target);var state=elem.dom.getAttribute('checkbox_state');var image_class_name=state=='checked'?'checkbox_checked_onclick':state=='dashed'?'checkbox_dashed_onclick':'checkbox_cleared_onclick';elem.removeClass(image_class_name);image_class_name=state=='checked'?'checkbox_checked':state=='dashed'?'checkbox_dashed':'checkbox_cleared';elem.addClass(image_class_name);}},on_page_click:function(event)
{if(event.target.className.indexOf('sg_checkbox ')==0)
{if(event.target.getAttribute('disabled')=='true')
return;this.__on_click_toggle__(event.target);return;}
var dom=event.target;for(var i=0;i<5;i++)
{if(!dom.hasAttribute)continue;if(dom.hasAttribute('sg_checkbox_label'))
{var checkbox=this.get_checkbox(dom.getAttribute('sg_checkbox_label'));if(checkbox.getAttribute('disabled')=='true')
return;this.__on_click_toggle__(checkbox);return;}
if(dom.parentNode)
dom=dom.parentNode;else
return;}},__on_click_toggle__:function(checkbox_dom_elem)
{var elem=Ext.get(checkbox_dom_elem);var state=elem.dom.getAttribute('checkbox_state');var image_class_name=state=='checked'?'checkbox_checked':state=='dashed'?'checkbox_dashed':'checkbox_cleared';elem.removeClass(image_class_name);if(state=='checked')
{elem.addClass('checkbox_cleared');elem.dom.setAttribute('checkbox_state','unchecked');}
else
{elem.addClass('checkbox_checked');elem.dom.setAttribute('checkbox_state','checked');}
this.fireEvent('change',elem.dom);}});SG.Checkbox=new SG.CheckboxManager();SG.util.DependencyActions=function(widget){this.widget=widget;var t='<div class="mode_button {left_class}" sg_tip="{left_tip}"></div>'+'<div class="mode_button {right_class}" sg_tip="{right_tip}"></div>';this.toolbar_tpl=new Ext.Template(t);this.toolbar_tpl.disableFormats=true;this.toolbar_tpl.compile();};SG.util.DependencyActions.prototype={get_menu_item:function()
{var sub_items=[];var selected_ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();sub_items.push({html:"Link Selected",disabled:!this.is_link_enabled(selected_ids),item_selected:{fn:this.connect_selected_tasks,scope:this}});sub_items.push({html:"Remove Links on Selected",disabled:!this.is_unlink_enabled(selected_ids),item_selected:{fn:this.disconnect_selected_tasks,scope:this}});sub_items.push({html:"Remove All Upstream and Downstream Links",disabled:!this.is_remove_all_enabled(selected_ids),item_selected:{fn:this.remove_all_dependencies_from_selected,scope:this}});sub_items.push({line:true});sub_items.push({html:"Pin Selected Tasks",disabled:!this.is_pin_enabled(selected_ids),item_selected:{fn:this.pin_selected_tasks,scope:this}});sub_items.push({html:"Unpin Selected Tasks",disabled:!this.is_unpin_enabled(selected_ids),item_selected:{fn:this.unpin_selected_tasks,scope:this}});sub_items.push({line:true});var disabled=true;if(selected_ids.length==1)
{var r=ds.get_record_by_id(selected_ids[0]);var pt=r.get('upstream_tasks');var st=r.get('downstream_tasks');if((pt instanceof Array&&pt.length>0)||(st instanceof Array&st.length>0))
disabled=false;}
sub_items.push({html:"Show Dependent Tasks...",disabled:disabled,item_selected:{fn:this.show_dependency_task_chain,scope:this}});var root_item={html:"Dependencies",submenu:{items:sub_items}};return root_item;},get_link_buttons_html:function(link_enabled,unlink_enabled)
{var html=this.toolbar_tpl.apply({left_class:link_enabled?'button_link_enabled':'button_link_disabled',right_class:unlink_enabled?'button_unlink_enabled':'button_unlink_disabled',left_tip:'Link Selected Tasks',right_tip:'UnLink Selected Tasks',});return html;},get_pinned_buttons_html:function(pin_enabled,unpin_enabled)
{html=this.toolbar_tpl.apply({left_class:pin_enabled?'button_pin_enabled':'button_pin_disabled',right_class:unpin_enabled?'button_unpin_enabled':'button_unpin_disabled',left_tip:'Pin Selected Tasks',right_tip:'UnPin Selected Tasks',});return html;},get_toolbar_items:function()
{var items=[];items.push({position:'left',html:this.get_link_buttons_html(false,false),disabled:false,toggle_on_entity_selection:true,render_callback:{fn:this.render_link_buttons_based_on_selection,scope:this},onclick:{fn:this.on_connect_or_disconnect_selected_tasks,scope:this}});items.push({position:'left',html:this.get_pinned_buttons_html(false,false),disabled:false,toggle_on_entity_selection:true,render_callback:{fn:this.render_pinned_buttons_based_on_selection,scope:this},onclick:{fn:this.on_pin_or_unpin_selected_tasks,scope:this}});return items;},is_pin_enabled:function(selected_entities)
{var sf=SG.schema.get_field("Task","pinned");var ds=this.widget.get_entity_data_store();var i,r,can_edit,unpinned_count=0;for(i=0;i<selected_entities.length;i++)
{r=ds.get_record_by_id(selected_entities[i]);can_edit=SG.schema.can_edit_field_on_record(r,sf,false);if(can_edit&&!r.get('pinned'))
unpinned_count++;}
return unpinned_count>0;},is_unpin_enabled:function(selected_entities)
{var sf=SG.schema.get_field("Task","pinned");var ds=this.widget.get_entity_data_store();var i,r,can_edit,pinned_count=0;for(i=0;i<selected_entities.length;i++)
{r=ds.get_record_by_id(selected_entities[i]);can_edit=SG.schema.can_edit_field_on_record(r,sf,true);if(can_edit&&r.get('pinned'))
pinned_count++;}
return pinned_count>0;},is_link_enabled:function(selected_entities)
{if(selected_entities.length<2)return false;var sf=SG.schema.get_field("Task","downstream_tasks");var ds=this.widget.get_entity_data_store();var i,r,can_edit_count=0;for(i=0;i<selected_entities.length;i++)
{r=ds.get_record_by_id(selected_entities[i]);if(SG.schema.can_edit_field_on_record(r,sf))
can_edit_count++;}
return can_edit_count==selected_entities.length;},is_unlink_enabled:function(selected_entities)
{var unlink_enabled=false;var sf=SG.schema.get_field("Task","upstream_tasks");var ds=this.widget.get_entity_data_store();for(var i=0;i<selected_entities.length;i++)
{var r=ds.get_record_by_id(selected_entities[i]);var upstream=r.get('upstream_tasks');for(var j=0;j<upstream.length;j++)
{if(selected_entities.indexOf(upstream[j].id)!=-1&&SG.schema.can_edit_field_on_record(r,sf))
{return true;}}}
return false;},is_remove_all_enabled:function(selected_entities)
{var i,r,enabled=false;var ds=this.widget.get_entity_data_store();var usf=SG.schema.get_field("Task","upstream_tasks");var dsf=SG.schema.get_field("Task","downstream_tasks");for(i=0;i<selected_entities.length;i++)
{r=ds.get_record_by_id(selected_entities[i]);if(r.get('upstream_tasks').length>0&&SG.schema.can_edit_field_on_record(r,usf))
{return true;}
if(r.get('downstream_tasks').length>0&&SG.schema.can_edit_field_on_record(r,dsf))
{return true;}}
return false;},render_pinned_buttons_based_on_selection:function(selected_entities)
{var pinned_enabled=this.is_pin_enabled(selected_entities);var unpinned_enabled=this.is_unpin_enabled(selected_entities);return this.get_pinned_buttons_html(pinned_enabled,unpinned_enabled);},render_link_buttons_based_on_selection:function(selected_entities)
{var link_enabled=this.is_link_enabled(selected_entities);var unlink_enabled=this.is_unlink_enabled(selected_entities);return this.get_link_buttons_html(link_enabled,unlink_enabled);},on_connect_or_disconnect_selected_tasks:function(e,toolbar_elem)
{var t=Ext.get(e.getTarget());if(t.hasClass('button_link_enabled'))
this.connect_selected_tasks();else
this.disconnect_selected_tasks();},on_pin_or_unpin_selected_tasks:function(e,toolbar_elem)
{var t=Ext.get(e.getTarget());if(t.hasClass('button_pin_enabled'))
this.pin_selected_tasks();else
this.unpin_selected_tasks();},connect_selected_tasks:function()
{var ids=this.get_selected_ids_in_page_order();var ds=this.widget.get_entity_data_store();ds.start_batch();var i,j,rec,task;var upstream_tasks,downstream_tasks,new_upstream,new_downstream;for(i=0;i<ids.length;i++)
{rec=ds.get_record_by_id(ids[i]);upstream_tasks=rec.get('upstream_tasks');downstream_tasks=rec.get('downstream_tasks');new_upstream=[];for(j=0;j<upstream_tasks.length;j++)
{task=upstream_tasks[j];if(ids.indexOf(task.id)==-1)
new_upstream.push(task);}
var new_downstream=[];for(j=0;j<downstream_tasks.length;j++)
{task=downstream_tasks[j];if(ids.indexOf(task.id)==-1)
new_downstream.push(task);}
if(i<(ids.length-1))
new_downstream.push({type:'Task',id:ids[i+1],name:''});if(i!=0)
new_upstream.push({type:'Task',id:ids[i-1],name:''});rec.multi_entity_set('upstream_tasks',new_upstream,'set');rec.multi_entity_set('downstream_tasks',new_downstream,'set');}
ds.end_batch();ds.commit();this.fire_selection_callback();},disconnect_selected_tasks:function()
{var ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();ds.start_batch();var i,j,rec,upstream,remove;for(i=0;i<ids.length;i++){rec=ds.get_record_by_id(ids[i]);upstream=rec.get('upstream_tasks');remove=[];for(j=0;j<upstream.length;j++){if(ids.indexOf(upstream[j].id)!=-1)
remove.push(upstream[j]);}
if(remove.length>0)
rec.multi_entity_set('upstream_tasks',remove,'remove');}
ds.end_batch();ds.commit();this.fire_selection_callback();},remove_all_dependencies_from_selected:function()
{var ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();var i,record;ds.start_batch();for(i=0;i<ids.length;i++){record=ds.get_record_by_id(ids[i]);record.set('upstream_tasks',[]);record.set('downstream_tasks',[]);}
ds.end_batch();ds.commit();},pin_selected_tasks:function()
{var ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();var i,record;ds.start_batch();for(i=0;i<ids.length;i++)
{var record=ds.get_record_by_id(ids[i]);record.set('pinned',true);}
ds.end_batch();ds.commit();this.fire_selection_callback();},unpin_selected_tasks:function()
{var ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();var i,record;ds.start_batch();for(i=0;i<ids.length;i++)
{var record=ds.get_record_by_id(ids[i]);record.set('pinned',false);}
ds.end_batch();ds.commit();this.fire_selection_callback();},show_dependency_task_chain:function()
{var ids=this.widget.get_selected_record_ids();var record=this.widget.get_entity_data_store().get_record_by_id(ids[0]);var entity_name=record.get('content');var filters={logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]};var page=this.widget.get_page();var focus_context={task_chain:true,entity:{type:'Task',id:ids[0],name:entity_name},entity_type:'Task',filters:filters,title:'Task Dependency Chain for: '+entity_name,reset_stack:(page.context.get('inside_window')!==true),server_side_filters:"task_dependency_chain",server_side_filters_params:{task_id:ids[0]},select_entities_on_first_load:ids,scroll_selection_into_view_on_load:true,callback:{fn:this.widget.reload_all_entities,scope:this.widget}};page.get_focus_window().open(focus_context);},get_selected_ids_in_page_order:function()
{var selected_ids=this.widget.get_selected_record_ids();var ds=this.widget.get_entity_data_store();var i,rec,sel_hash={},sel_ids=[];for(i=0;i<selected_ids.length;i++){sel_hash[selected_ids[i]]=true;}
for(i=0;i<ds.count();i++){rec=ds.get_record(i);if(sel_hash.hasOwnProperty(rec.get_id()))
sel_ids.push(rec.get_id());}
return sel_ids;},fire_selection_callback:function()
{var sel_man=this.widget.__get_selection_manager__();sel_man.fire_selection_callback();},};SG.Date=function(data_store_string){this.init(data_store_string);};SG.Date.create_from_time=function(time){var date=new Date(time);return new SG.Date(SG.GridEditor.DateParser.data_store_format(date));}
SG.Date.prototype={init:function(data_store_string)
{this.date_parser=SG.GridEditor.DateParser;if(data_store_string!=undefined)
{var parts=data_store_string.split('-');var year=Number(parts[0]);var month=Number(parts[1])-1;var day=Number(parts[2]);this.the_date=new Date(Date.UTC(year,month,day));}
else
this.the_date=this.date_parser.get_normalized_today();},clone:function()
{var new_sdate=new SG.Date();new_sdate.the_date=new Date(this.the_date.getTime());return new_sdate;},add:function(interval,value)
{var ret=this.clone();if(interval==Date.DAY)
this.date_parser.shift_date(ret.the_date,value);else if(interval==Date.MONTH)
this.date_parser.shift_month(ret.the_date,value);else if(interval==Date.YEAR)
this.date_parser.shift_year(ret.the_date,value);else if(interval==Date.SECOND)
this.date_parser.shift_second(ret.the_date,value);return ret;},format:function(format_string)
{return this.date_parser.format(this.the_date,format_string);},data_store_format:function()
{return this.date_parser.data_store_format(this.the_date);},getTime:function()
{return this.the_date.getTime();},get_year:function()
{return this.date_parser.get_year(this.the_date);},get_month:function()
{return this.date_parser.get_month(this.the_date);},get_day:function()
{return this.date_parser.get_date(this.the_date);},get_day_of_the_week:function()
{return this.the_date.getUTCDay();},same_date:function(another_shotgun_date)
{return this.date_parser.same_date(this.the_date,another_shotgun_date);},greater_than:function(another_shotgun_date){return this.the_date>another_shotgun_date.the_date;},less_than:function(another_shotgun_date){return this.the_date<another_shotgun_date.the_date;}};SG.util.DeleteAttachment=function(config){Ext.apply(this,config);SG.util.DeleteAttachment.superclass.constructor.call(this);};Ext.extend(SG.util.DeleteAttachment,SG.Component,{init_component:function(){this.entity_rec=this.entity_ds.get_record_by_id(this.entity_id);this.data_set=this.new_data_set('Attachment',this.on_load);this.request_attachment();},request_attachment:function()
{var spec={type:'Attachment',id:this.attachment_id,columns:['attachment_links'],result:this.data_set};SG.Repo.find(spec);},on_load:function()
{if(this.data_set.count()!=1)
{this.destroy();return;}
var attachment_rec=this.data_set.get_record(0);var attachment_links=attachment_rec.get('attachment_links');if(attachment_links.length==1){attachment_rec.retire();this.data_set.commit();}else{this.entity_rec.multi_entity_set('attachments',[{type:'Attachment',id:this.attachment_id}],'remove');this.entity_ds.commit();}
this.destroy();},});SG.util.NavChain=function(config)
{Ext.apply(this,config);SG.util.NavChain.superclass.constructor.call(this,config);};Ext.extend(SG.util.NavChain,SG.Component,{templates:{main:'<div class="sgc_nav_chain {extra}">{contents}</div>',grouping:'<div class="list">{list_contents}</div>'+'<div class="entities">{entity_contents}</div>',row:'<div class="row {selected} {extra}" id="{id}">{content}<div class="icon right_arrow"></div></div>',},init_component:function()
{SG.globals.NavChain+=1;this.id=SG.globals.NavChain;this.config=this.chain_config[this.chain_index];this.schema_field=SG.schema.get_field(this.config.entity_type,this.config.field_name);if(!this.column_div)
{var html=this.get_main_html(this.config);this.column_div=Ext.DomHelper.insertFirst(this.container,html,true);}
this.add_event(this.column_div,'click',this.on_click);if(this.selected_entity)
this.fetch_selected_entity();else
this.fetch_column_entities();},get_main_html:function(chain)
{var html='';if(chain.link_type=='grouping')
{html=this.templates.main.apply({extra:'grouping',contents:this.templates.grouping.apply({list_contents:'',entity_contents:''})});}
else
{html=this.templates.main.apply({extra:'',contents:''});}
return html;},get_selected_value:function()
{return this.selected_entity;},on_click:function(e)
{var t=Ext.get(e.getTarget());var row_div=t.findParent('div.row',this.container,true);if(row_div)
{this.destroy_downstream_chains();var id=row_div.dom.getAttribute('id');if(row_div.hasClass('list_value'))
{var last_selected_row=sg_find('div.row.list_value.selected',this.column_div.dom);if(last_selected_row)
{last_selected_row=Ext.get(last_selected_row);last_selected_row.removeClass('selected');}
row_div.addClass('selected');var entities_div=this.column_div.child('div.entities');entities_div.update('');var sel_value=this.schema_field.values[id];this.selected_entity_record.set(this.config.field_name,sel_value);this.fetch_column_entities();return;}
var rec=this.column_entities_data_set.get_record_by_id(id);this.selected_entity={valid:'valid',type:this.config.entity_type,name:rec.get(this.ident_field),id:rec.id};this.render();if(this.chain_index==0&&this.config.link_type!='recursive_parent_entity')
return;var next_index=this.config.link_type=='recursive_parent_entity'?this.chain_index:this.chain_index-1;var next_chain=this.chain_config[next_index];var html=this.get_main_html(next_chain);var new_column_div=Ext.DomHelper.append(this.container,html,true);var config={container:this.container,column_div:new_column_div,chain_config:this.chain_config,chain_index:next_index,project:this.project,upstream_chain:this,};this.downstream_chain=new SG.util.NavChain(config);if(next_chain.link_type=='grouping')
{this.downstream_chain.selected_entity=this.selected_entity;this.downstream_chain.fetch_selected_entity(true);}
else
this.downstream_chain.fetch_column_entities();}},destroy_downstream_chains:function()
{if(this.downstream_chain)
this.downstream_chain.destroy();this.downstream_chain=null;},render:function()
{var html='';if(this.config.link_type=='grouping')
html=this.render_as_grouping();else
html=this.render_column_entities();this.column_div.update(html);},render_as_grouping:function()
{var sel_value=null;if(this.selected_entity_record)
sel_value=this.selected_entity_record.get(this.config.field_name);var list_rows='';for(var i=0;i<this.schema_field.values.length;i++)
{var value=this.schema_field.values[i];list_rows+=this.templates.row.apply({selected:value==sel_value?'selected':'',id:i,content:value,extra:'list_value'});}
return this.templates.grouping.apply({list_contents:list_rows,entity_contents:this.render_column_entities(),});},render_column_entities:function()
{this.pi.hide();var rows='';for(i=0;i<this.column_entities_data_set.count();i++)
{var rec=this.column_entities_data_set.get_record(i);var value_hash={valid:'valid',type:this.config.entity_type,name:rec.get(this.ident_field),id:rec.id};rows+=this.templates.row.apply({selected:this.selected_entity&&this.selected_entity.id==rec.id?'selected':'',content:SG.Renderers.render_one_nodetail_entity(value_hash),id:rec.id,name:value_hash.name});}
return rows;},fetch_selected_entity:function(do_not_construct_upstream_chain)
{if(this.selected_entity_data_set)
{this.remove_event(this.selected_entity_data_set,'load',this.on_load_selected_entity_data_set);this.selected_entity_data_set.destroy();}
this.selected_entity_data_set=new SG.Data.Set(this.entity_type);this.do_not_construct_upstream_chain=do_not_construct_upstream_chain;this.add_event(this.selected_entity_data_set,'load',this.on_load_selected_entity_data_set);var spec={type:this.selected_entity.type,id:this.selected_entity.id,columns:[this.config.field_name],result:this.selected_entity_data_set};SG.Repo.find(spec);},on_load_selected_entity_data_set:function()
{this.selected_entity_record=this.selected_entity_data_set.get_record(0);if(this.do_not_construct_upstream_chain)
{this.do_not_construct_upstream_chain=undefined;this.fetch_column_entities();return;}
this.upstream_selected_entity=this.selected_entity_record.get(this.config.field_name);if(this.upstream_selected_entity!=null)
{if(this.schema_field.data_type=='multi_entity')
{if(this.upstream_selected_entity.length==0)
this.upstream_selected_entity=null;else
this.upstream_selected_entity=this.upstream_selected_entity[0];}}
if(this.upstream_selected_entity!=null&&this.config.link_type=='recursive_parent_entity')
{var config={container:this.container,chain_config:this.chain_config,chain_index:this.chain_index,project:this.project,selected_entity:this.upstream_selected_entity,downstream_chain:this};this.upstream_chain=new SG.util.NavChain(config);}
else if(this.upstream_selected_entity!=null&&this.config.link_type!='current_project')
{var next_chain_config=this.chain_config[this.chain_index+1];var selected_entity;if(next_chain_config.link_type=='grouping'||this.config.link_type=='grouping')
selected_entity=this.selected_entity;else
selected_entity=this.upstream_selected_entity;var config={container:this.container,chain_config:this.chain_config,chain_index:this.chain_index+1,project:this.project,selected_entity:selected_entity,downstream_chain:this};this.upstream_chain=new SG.util.NavChain(config);}
else if(this.upstream_selected_entity==null)
{var config={container:this.container,chain_config:this.chain_config,chain_index:this.chain_index+1,project:this.project,selected_entity:this.selected_entity,downstream_chain:this.downstream_chain};var new_upstream_chain=new SG.util.NavChain(config);if(this.downstream_chain)
this.downstream_chain.upstream_chain=new_upstream_chain;this.upstream_chain=null;this.downstream_chain=null;var me=this;setTimeout(function(){me.destroy();},0);return;}
this.fetch_column_entities();},get_upstream_selected_value:function()
{if(!this.upstream_chain)
return null;else
return this.upstream_chain.get_selected_value();},fetch_column_entities:function()
{if(!this.pi)
this.pi=new SG.ProgressIndicator(this.container);this.pi.show();if(this.column_entities_data_set)
{this.remove_event(this.column_entities_data_set,'load',this.on_load_selected_entity_data_set);this.column_entities_data_set.destroy();}
this.column_entities_data_set=new SG.Data.Set(this.entity_type);this.add_event(this.column_entities_data_set,'load',this.render);var filters={logical_operator:'and',conditions:[]};if(this.config.link_type=='current_project')
filters.conditions.push({path:'project',relation:'is',values:[this.project]});else
{if(this.config.link_type=='grouping')
{if(this.selected_entity_record)
{var selected_value=this.selected_entity_record.get(this.config.field_name);filters.conditions.push({path:this.config.field_name,relation:'is',values:[selected_value]});}}
else
{var upstream_value=this.get_upstream_selected_value();filters.conditions.push({path:this.config.field_name,relation:'is',values:[upstream_value]});}}
this.ident_field=SG.schema.get_identifier_field(this.config.entity_type);var spec={type:this.config.entity_type,filters:filters,columns:[this.ident_field],result:this.column_entities_data_set};SG.Repo.query(spec);},debug_name:function(chain)
{if(chain)
return chain.entity_type+"."+chain.field_name;else
return this.config.entity_type+"."+this.config.field_name;},destroy_component:function()
{if(this.selected_entity_data_set)
this.selected_entity_data_set.destroy();if(this.column_entities_data_set)
this.column_entities_data_set.destroy();if(this.downstream_chain)
this.downstream_chain.destroy();if(this.column_div)
this.column_div.remove();},});SG.globals.NavChain=0;SG.util.EntityQueryModeHelper=function(){this.init();}
SG.util.EntityQueryModeHelper.prototype={modes:['list','card','thumb','calendar','sched'],disabled:function(entity_type,mode){if(mode==='sched'){var aet=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(aet.indexOf(entity_type)===-1)
return true;}
var mode_index=this.modes.indexOf(mode);if(mode_index==-1)return false;var disabled_types=this.disabled_modes_by_type[entity_type];if(!disabled_types&&entity_type.match(/Connection$/))
disabled_types=[2,4];if(!disabled_types)
return false;if(SG.globals.custom_for=="hom"&&mode==='calendar'&&entity_type.match(/^CustomEntity/)){return false;}
if(disabled_types.indexOf(mode_index)!=-1)
return true;return false;},init:function(){if(SG.globals.custom_for=="pixomondovfx"){if(this.disabled_modes_by_type.HumanUser.indexOf(4)!=-1)
this.disabled_modes_by_type.HumanUser.splice(this.disabled_modes_by_type.HumanUser.indexOf(4),1);if(this.disabled_modes_by_type.CustomEntity07.indexOf(4)!=-1)
this.disabled_modes_by_type.CustomEntity07.splice(this.disabled_modes_by_type.CustomEntity07.indexOf(4),1);}
if(SG.globals.custom_for=="macguff"){if(this.disabled_modes_by_type.Task.indexOf(1)!=-1)
this.disabled_modes_by_type.Task.splice(this.disabled_modes_by_type.Task.indexOf(1),1);}
if(SG.globals.custom_for=="rsp"){if(this.disabled_modes_by_type.CustomEntity18.indexOf(3)!=-1)
this.disabled_modes_by_type.CustomEntity18.splice(this.disabled_modes_by_type.CustomEntity18.indexOf(3),1);}},disabled_modes_by_type:{Task:[1],PublishEvent:[1,2],Status:[1,2,3,4],Attachment:[],Version:[],HumanUser:[3],ApiUser:[1,2,3],CutItem:[3],Cut:[3],Note:[2,3],Delivery:[2],Ticket:[2],TimeLog:[2],Playlist:[1,3],TaskTemplate:[1,2,3,4],Deliveries:[1],EventLogEntry:[3],DisplayColumn:[3],Revision:[1,2,3],ShootDay:[1],CustomEntity01:[3],CustomEntity02:[3],CustomEntity03:[3],CustomEntity04:[3],CustomEntity05:[3],CustomEntity06:[3],CustomEntity07:[3],CustomEntity08:[3],CustomEntity09:[3],CustomEntity10:[3],CustomEntity11:[3],CustomEntity12:[3],CustomEntity13:[3],CustomEntity14:[3],CustomEntity15:[3],CustomEntity16:[3],CustomEntity17:[3],CustomEntity18:[3],CustomEntity19:[3],CustomEntity20:[3],CustomNonProjectEntity01:[3],CustomNonProjectEntity02:[3],CustomNonProjectEntity03:[3],CustomNonProjectEntity04:[3],CustomNonProjectEntity05:[3]},};SG.Widget.NewGrid=function(context,widget_spec,id)
{SG.Widget.NewGrid.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NewGrid,SG.Widget.EntityQueryMode,{default_settings:{columns:[],column_widths:{},column_display_names:{},column_header_colors:{},detail_link_columns:[],wrapped_columns:{},wrap_all_columns:false,sorts:[],records_per_page:25,wrap_column_header_text:false,summaries:{},summary_state:'hidden',select_first_record:false},templates:{toolbar_button:'<div class="toolbar_button">'+'<div class="left"></div>{label}<div class="dropdown_arrow_small"></div><div class="right"></div></div>',},init_widget:function(){this.entity_type=this.context.get('entity_type');this.data_set=this.new_data_set(this.entity_type,this.on_data_load,this.on_data_change);if(this.context.get('entity_type')=='Task'&&this.context.get('parent_entity')&&this.context.get('parent_entity').type=='TaskTemplate')
{this.data_set.drafts=true;}
this.current_page=1;this.summary_set=new SG.Data.SummarySet(this.entity_type);this.events={groups_toggled:true,body_rendered:true};this.init_pivot_columns();},init_children:function(){},init_subcomponents:function(){var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects(),get_fields_callback:{fn:this.get_columns,scope:this},background_color:'#D2D2D2',apply_row_rules:true};if(this.__get_entity_query_page__().get('formatting_rules'))
cell_config.page_formatting_rules=this.__get_entity_query_page__().get('formatting_rules');this.cell_manager=this.new_component(SG.CellManager,cell_config);this.grid_header=this.new_component(SG.GridHeader,{grid:this,container:this.header_container});this.grid_body=this.new_component(SG.GridBody,{grid:this,container:this.body_container});var dnd_config={grid:this,container:this.container};this.grid_heading_drag_zone=new SG.NewGridHeadingDragZone(dnd_config);this.grid_heading_drag_zone=new SG.NewGridSplitterDragZone(dnd_config);},update_formatting_rules:function(schema_field)
{var options={url:'/page/fetch_formatting_rules',params:{page_id:this.get_page().id,entity_type:this.entity_type,field_id:schema_field?schema_field.id:null},callback:function(options,success,response){if(success)
{var data=Ext.decode(response.responseText);if(data.global_field_rules)
{SG.schema.entity_fields[schema_field.entity_type][schema_field.name].formatting_rules=data.global_field_rules;}
if(data.global_row_rules)
{SG.schema.entity_types[this.entity_type].global_row_formatting_rules=data.global_row_rules;}
this.cell_manager.set_page_formatting_rules(this.__get_entity_query_page__().get('formatting_rules'));this.render();}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},on_data_load:function(something){if(typeof something=='object'&&something.length&&something.length===1&&something[0]=='grouped_summaries')
{return;}
if(this.current_page>1&&this.data_set.count()===0){this.current_page=1;this.request_data();}else{if(this.summaries_visible()){this.request_summaries();}
if(this.data_set.is_grouped()){this.request_group_counts(this.summary_set);}
else
this.clear_group_summaries();if(this.select_first){this.select_first_record();this.select_first=false;}
if(this.restore_scroll)
{this.restore_scroll=false;this.container.scrollTo('top',0,false);}
this.on_entities_loaded();this.render_widget();}},on_data_change:function(changes){var change;var retires=0;var revives=0;var summ,refresh_summaries=false;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type==='retire'){retires++;}else if(change.type==='revive'){revives++;}else if(change.type==='update'&&change.state==='server'){summ=this.get_summary(change.column);if(summ.type&&summ.type!=='none')
refresh_summaries=true;this.update_entity_formatting(change.record);if(change.column=='read_by_current_user')
this.update_read_status_icon(change.record);if(this.entity_type=='Task'&&change.column=='dependency_violation')
this.update_task_violation_icon(change.record);if(this.entity_type=='HumanUser'&&change.column=='sg_status_list')
this.update_disabled_user_icon(change.record);}}
if(this.data_set.count()===0||revives>0){this.request_data();}else if(retires>0){this.render_body();this.hide_loading_overlay();if(this.summaries_visible())
this.request_summaries();if(this.data_set.is_grouped())
this.request_group_counts(this.summary_set);}else if(refresh_summaries&&this.summaries_visible()){this.request_summaries();}},on_data_error:function(response){this.hide_loading_overlay();},request_data:function(){this.reset_any_summary_cells();this.summary_set.reset();this.display_loading_overlay();var spec={type:this.entity_type,filters:this.get_filters(),columns:this.get_required_columns(),sorts:this.get_sorts(),grouping:this.get_grouping(),current_page:this.current_page,records_per_page:this.get('records_per_page'),result:this.data_set};var parent_link_fields=this.get_parent_link_fields_from_context();if(parent_link_fields.length==1&&parent_link_fields[0]=="projects"&&this.context.get('page_project'))
{spec.parent_entity=this.context.get('page_project');}else{var parent_entity=this.context.get('parent_entity');if(parent_entity)spec.parent_entity=parent_entity;}
var server_side=this.context.get('server_side_filters');if(server_side)spec.server_side_filters=server_side;var server_side_params=this.context.get('server_side_filters_params');if(server_side_params)spec.server_side_filters_params=server_side_params;SG.Repo.query(spec);},display_loading_overlay:function()
{var p=this.get_parent();if(p.get('type')=='SG.Widget.EntityQuery.GanttWrapper')
this.show_loading_overlay(p.get_container());else
this.show_loading_overlay();},reset_any_summary_cells:function()
{var cols=this.get_columns();for(var i=0;i<cols.length;i++)
{var col=cols[i];var schema_field=SG.schema.get_field(this.entity_type,col);if(schema_field.data_type=='summary')
this.cell_manager.empty_cell_cache(col);}},request_csv_data:function(){var columns=sg_deep_copy(this.get_columns(true));if(SG.schema.entity_types[this.entity_type].has_projects&&columns.indexOf("project")==-1)
columns.push("project");var spec={type:this.entity_type,filters:this.get_filters(),columns:columns,column_display_names:this.get('column_display_names'),pivot_columns_hash:this.get_pivot_columns_hash(),summary_columns_hash:this.get_summary_columns_hash(),sorts:this.get_sorts(),grouping:this.get_grouping()};var parent_entity=this.context.get('parent_entity');if(parent_entity){spec.parent_entity=parent_entity;if(this.entity_type=="Task"&&parent_entity.type=="TaskTemplate")
spec.drafts=true;}
var server_side=this.context.get('server_side_filters');if(server_side)spec.server_side_filters=server_side;var server_side_params=this.context.get('server_side_filters_params');if(server_side_params)spec.server_side_filters_params=server_side_params;SG.Repo.query_csv(spec);},request_summaries:function(){var spec={type:this.entity_type,filters:this.get_filters(),summaries:this.get_summaries(),result:this.summary_set,result_key:'page'};var parent_entity=this.context.get('parent_entity');if(parent_entity)spec.parent_entity=parent_entity;var server_side=this.context.get('server_side_filters');if(server_side)spec.server_side_filters=server_side;var server_side_params=this.context.get('server_side_filters_params');if(server_side_params)spec.server_side_filters_params=server_side_params;SG.Repo.summarize(spec);if(this.data_set.is_grouped())
this.request_group_summaries();},request_group_summaries:function(){var group_count=this.data_set.group_count();if(group_count===0)return;var group,group_filters,spec,i;var grouping=this.get_grouping();var page_filters=this.get_filters();var server_side=this.context.get('server_side_filters');var server_side_params=this.context.get('server_side_filters_params');for(i=0;i<group_count;i++){group=this.data_set.get_group(i);group_filters=SG.schema.filters_for_grouping(this.entity_type,grouping,group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:this.get_summaries(),result:this.summary_set,result_key:'group_'+i};if(server_side)spec.server_side_filters=server_side;if(server_side_params)spec.server_side_filters_params=server_side_params;SG.Repo.summarize(spec);}
var synth_grping;for(i in this.data_set.synthetic_group_map)
{if(!this.data_set.synthetic_group_map.hasOwnProperty(i))
continue;group=this.data_set.synthetic_group_map[i];synth_grping=grouping.slice(0,group.depth+1);group_filters=SG.schema.filters_for_grouping(this.entity_type,synth_grping,group.template_values);spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:this.get_summaries(),result:this.summary_set,result_key:'synthetic_'+group.idx};if(server_side)spec.server_side_filters=server_side;if(server_side_params)spec.server_side_filters_params=server_side_params;SG.Repo.summarize(spec);}},on_summary_load:function(keys){if(keys.indexOf('page')!==-1)
this.render_header();},get_columns:function(include_pivot_columns){var cols=this.get('columns');var real_cols=[];var schema_field;if(include_pivot_columns&&SG.schema.entity_fields.Task&&SG.schema.entity_fields.Task.entity)
{var aet=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(aet.indexOf(this.entity_type)==-1)
include_pivot_columns=false;}
for(var i=0;i<cols.length;i++){schema_field=SG.schema.get_field(this.entity_type,cols[i]);if(this.is_pivot_column(cols[i])){if(include_pivot_columns)
real_cols.push(cols[i]);}
else if(schema_field){real_cols.push(cols[i]);}}
if(real_cols.length===0&&SG.schema.get_identifier_field(this.entity_type))
{real_cols=[SG.schema.get_identifier_field(this.entity_type)];}
return real_cols;},get_pivot_columns_hash:function()
{var ret_hash={};var cols=this.get_columns(true);var pivot_cols=[];for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_pivot_column(col))
{var pivot_widget=this.get_child(col);var pivot_cols=pivot_widget.get_columns();ret_hash[col]={mode:pivot_widget.get('mode'),columns:pivot_cols,column_display_names:pivot_widget.get_column_names_for_export(),summary_request:pivot_widget.get_export_summary_request(),summary_columns_hash:pivot_widget.get_export_summary_columns_hash()};}}
return ret_hash;},get_summary_columns_hash:function()
{var cm=this.get_cell_manager();var ret_hash={};var cols=this.get_columns();for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_summary_field(col))
{var cell=cm.get_cell(col);var cell_hash=cell.get_csv_export_hash();cell_hash.column_display_name=this.get_column_display_name(col);ret_hash[col]=cell_hash;}}
return ret_hash;},get_required_columns:function(){var columns=sg_deep_copy(this.get_columns());var parent=this.get_parent();if(parent&&parent.get_required_columns)
columns=columns.concat(parent.get_required_columns());if(this.__get_entity_query_page__().get('formatting_rules'))
SG.CellFormatting.extract_required_fields(this.__get_entity_query_page__().get('formatting_rules'),columns)
var field_info;for(var i=0;i<columns.length;i++)
{field_info=SG.schema.parse_field_name(this.entity_type,columns[i]);if(field_info.type=="bubble"||field_info.type=="bubblepoly"){if(columns.indexOf(field_info.base_field)===-1)
columns.push(field_info.base_field);}}
return columns;},get_summaries:function(){var cols=this.get_columns();var summaries=[];var sf,sum;for(var i=0;i<cols.length;i++){sf=SG.schema.get_field(this.entity_type,cols[i]);if(!sf||sf.data_type=='summary')
continue;sum=this.get_summary(cols[i]);if(sum&&sum.type&&sum.type!=='none')
summaries.push(sum);}
return summaries;},get_summary:function(col){var schema_field=SG.schema.get_field(this.entity_type,col);var summary_options=SG.schema.summary_options[schema_field.data_type];var summary_col=schema_field.data_type=='summary'?schema_field.summary_field:col;var summary_default=SG.schema.get_summary_default(schema_field);var setting;if(this.is_pivot_column(col))
return summary_default;else
{var settings=this.get('summaries');if(col in settings){setting=settings[col];if(schema_field.data_type=='summary'&&col.indexOf('$')!==-1)
return setting;else if(setting&&setting.type&&summary_options&&summary_options.indexOf(setting.type)!==-1)
return setting;else
return summary_default;}else if(!schema_field.no_summary&&this.get_column_index(col)===0){return{column:summary_col,type:'record_count',value:null};}else{return summary_default;}}},set_summary:function(col,summary){var settings=this.get('summaries');settings[col]=summary;this.set('summaries',settings);if(this.summaries_visible())
this.request_summaries();var schema_field=SG.schema.get_field(this.entity_type,col);if(schema_field.data_type=='summary')
{this.cell_manager.empty_cell_cache(col);this.render_widget();}},get_record_count:function(){return this.data_set.get_paging_info().record_count;},get_cell_manager:function(){return this.cell_manager;},get_cell_config:function(col){var config={detail_link:this.is_detail_link(col)};return config;},get_column_index:function(col){return this.get_columns(true).indexOf(col);},is_visible:function(col){var cols=this.get_columns();var idx=cols.indexOf(col);return(idx!==-1);},toggle_column:function(col,col_index){var columns=sg_deep_copy(this.get_columns(true));var idx=columns.indexOf(col);var pivot_column=this.is_pivot_column(col);var add_idx=col_index===undefined?columns.length:col_index;var setting_updates={};if(!pivot_column)
{var wrapped_columns=this.get('wrapped_columns');if(idx===-1){wrapped_columns[col]=this.get('wrap_all_columns');}else{delete wrapped_columns[col];}
setting_updates['wrapped_columns']=wrapped_columns;}
if(idx===-1){if(pivot_column)
this.create_task_step_pivot_column(col,add_idx);else
{columns.splice(add_idx,0,col);setting_updates['columns']=columns;this.set(setting_updates);}
if(this.is_summary_field(col))
this.render();else
this.request_data();}else{columns.splice(idx,1);if(columns.length!==0){if(pivot_column)
this.delete_pivot_column(col);setting_updates['columns']=columns;this.set(setting_updates);this.render();}}},change_columns:function(added,removed){var regular_to_add=[];var i;for(i=0;i<added.length;i++)
{if(this.is_pivot_column(added[i]))
this.create_task_step_pivot_column(added[i]);else
regular_to_add.push(added[i]);}
var columns=sg_deep_copy(this.get_columns(true));var idx;for(i=0;i<removed.length;i++)
{idx=columns.indexOf(removed[i]);if(idx!=-1){columns.splice(idx,1);}
if(this.is_pivot_column(removed[i]))
this.delete_pivot_column(removed[i]);}
columns=columns.concat(regular_to_add);this.set('columns',columns);var wrapped_columns=this.get('wrapped_columns');var wrap_all_columns=this.get('wrap_all_columns');for(i=0;i<added.length;++i){if(!this.is_pivot_column(added[i]))
wrapped_columns[added[i]]=wrap_all_columns;}
this.set('wrapped_columns',wrapped_columns);if(added.length>0)
this.request_data();else
this.render();},move_column:function(old_idx,new_idx){var cols=sg_deep_copy(this.get_columns(true));var move_col=cols[old_idx];cols.splice(old_idx,1);cols.splice(new_idx,0,move_col);this.set_silent('columns',cols);this.render();this.set('columns',cols);},resize_column:function(col,width){if(this.is_pivot_column(col))
{var pivot_widget=this.get_child(col);pivot_widget.resize_column_sum(width-10);this.render();}
else
{var widths=this.get('column_widths');widths[col]=width;this.set_silent('column_widths',widths);this.render();this.set('column_widths',widths);}},get_column_width:function(col){if(this.is_pivot_column(col)){var pivot_widget=this.get_child(col);return pivot_widget.get_column_width_sum();}else{var widths=this.get('column_widths');if(widths[col])
return widths[col];else
return 125;}},get_column_width_sum:function(){var cols=this.get_columns(true);var sum=0;for(var i=0;i<cols.length;i++){sum+=this.get_column_width(cols[i]);}
return sum;},get_column_display_name:function(col){var dnames=this.get('column_display_names');var name=dnames[col];if(!name){if(this.is_pivot_column(col))
{var pivot_widget=this.get_child(col);name=pivot_widget.get_pivot_grid_column_name();}
else
{name=SG.schema.get_field_display_name(this.entity_type,col);}}
return name;},set_column_display_name:function(col,name){var dnames=this.get('column_display_names');dnames[col]=name;this.set('column_display_names',dnames);this.render();this.__get_entity_query_page__().update_filter_panel(true);},get_tall_header:function(){return this.get('wrap_column_header_text');},set_tall_header:function(value){this.set('wrap_column_header_text',value);this.render_header();},get_column_header_color:function(col){var colors=this.get('column_header_colors');return colors[col];},set_column_header_color:function(col,color){var colors=this.get('column_header_colors');colors[col]=color;this.set('column_header_colors',colors);this.render_header();},is_sorted_by:function(col){var sort,sorts=this.get_sorts();for(var i=0;i<sorts.length;i++){sort=sorts[i];if(sort.column===col)
return sort.direction;}
return false;},is_primary_sort:function(col){var sorts=this.get_sorts();if(sorts[0]&&sorts[0].column===col)
return true;else
return false;},get_sorts:function(){var settings_sorts=this.get('sorts');if(!settings_sorts||settings_sorts.length==0){var context_sorts=this.context.get('sorts');if(context_sorts)
return sg_deep_copy(context_sorts);}
return settings_sorts;},set_sorts:function(new_sorts){this.set('sorts',new_sorts);this.request_data();},is_grouped:function(){return this.data_set.is_grouped();},is_grouped_by:function(col){var grouping=this.get_grouping();if(grouping&&grouping[0].column===col){return grouping[0].method;}else{return false;}},set_single_field_grouping:function(col,method,direction){var grouping;if(col===null){grouping=false;}else{method=method||'exact';direction=direction||'asc';grouping=[{column:col,method:method,direction:direction}];}
this.set_grouping(grouping);},ungroup:function(){this.set_grouping(false);},get_group_column:function(){var grouping=this.get_grouping();if(grouping){return grouping[0].column;}else{return false;}},get_group_offset:function(){return 16;},get_entity_icon_offset:function(){return 18;},is_detail_link:function(col){var dcols=this.get('detail_link_columns');var dcol;var found=false;for(var i=0;i<dcols.length;i++){dcol=dcols[i];if(dcol.column===col){found=true;break;}}
if(found)
return dcol.state;else if(SG.schema.is_identifier_field(this.entity_type,col)&&!this.context.get('no_auto_detail_link'))
return true;else
return false;},set_detail_link:function(col,state){var schema_field=SG.schema.get_field(this.entity_type,col);var dcols=this.get('detail_link_columns');var dcol;var found=false;for(var i=0;i<dcols.length;i++){dcol=dcols[i];if(dcol.column===col){found=true;break;}}
if(found){dcol.state=state;}else{dcols.push({column:col,state:state});}
this.set('detail_link_columns',dcols);this.get_cell_manager().empty_cell_cache();this.render_header();this.render_body();},is_wrapped:function(col){var wrapped=this.get('wrapped_columns');return wrapped[col]||false;},set_wrapped:function(col,state){var wrapped=this.get('wrapped_columns');wrapped[col]=state;this.set('wrapped_columns',wrapped);this.render_body();},toggle_wrap_all_columns:function(wrap){var wrap_all=this.get('wrap_all_columns');wrap_all=!wrap_all;this.set('wrap_all_columns',wrap_all);if(wrap_all){var cols=this.get_columns();var wrapped_columns={};for(var i=0;i<cols.length;++i){wrapped_columns[cols[i]]=true;}
this.set('wrapped_columns',wrapped_columns);}else{this.set('wrapped_columns',{});}
this.render_body();},summaries_visible:function(){return(this.get('summary_state')==='visible');},toggle_summaries_visible:function(){var state=(this.get('summary_state')==='visible')?'hidden':'visible';this.set('summary_state',state);this.render_widget();if(state==='visible'){this.request_summaries();var cols=this.get_columns(true);for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_pivot_column(col))
{var pivot_widget=this.get_child(col);pivot_widget.request_summaries();}}}},in_gantt_wrapper:function()
{return(this.get_parent()instanceof SG.Widget.EntityQuery.GanttWrapper);},_get_entity_type_and_filters_from_context:function()
{if(this.context.get('pivot_from_type'))
return{entity_type:this.context.get('entity_type'),filters:this.context.get('pivot_filters')};else
return{entity_type:this.context.get('entity_type'),filters:this.context.get('filters')};},set_data_store_max_records:function(num_recs){this.current_page=1;this.set('records_per_page',num_recs);this.request_data();},set_data_store_page:function(page_num){this.current_page=page_num;this.request_data();this.restore_scroll=true;},reload_all_entities:function(){this.request_data();var columns=this.get_columns(true);for(var i=0;i<columns.length;i++)
{if(this.is_pivot_column(columns[i]))
{var pivot_column=this.get_child(columns[i]);pivot_column.grid_reloaded();}}},get_entity_data_store:function(){return this.data_set;},get_toolbar_items:function(){var items=[];if(SG.schema.entity_fields.Task&&SG.schema.entity_fields.Task.entity)
{var aet=SG.schema.entity_fields.Task.entity.allowed_entity_types;if(aet.indexOf(this.entity_type)!=-1)
{items.push({position:'left',html:this.templates.toolbar_button.apply({label:'Pipeline'}),onclick:{fn:this.on_pipeline_toolbar_button,scope:this},oncontextmenu:{fn:this.on_pipeline_toolbar_button,scope:this},});}}
if(this.entity_type=='Task')
{var dependency_actions=new SG.util.DependencyActions(this);items=items.concat(dependency_actions.get_toolbar_items());}
return items;},on_pipeline_toolbar_button:function(e,toolbar_elem)
{if(!this.pipeline_menu)
{this.pipeline_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_pipeline_menu,scope:this},});}
this.pipeline_menu.position={dom_elem:toolbar_elem.dom,elem_anchor:'bl',menu_anchor:'tl'};this.pipeline_menu.show();},on_before_show_pipeline_menu:function(menu)
{var cols=this.get_columns(true);var entity_fields_menu_helper=new SG.util.EntityFieldsMenuHelper({field_checked_callback:{fn:function(field){return(cols.indexOf(field.name)!=-1)},scope:this},field_disabled_callback:{fn:function(){return false;},scope:this},on_field:{fn:function(menu,menu_item){this.toggle_column(menu_item.field);},scope:this}});var items=entity_fields_menu_helper.create_pipeline_menu_items(this.entity_type);var no_steps_yet=(items.length==1&&items[0].no_steps_yet);items=items.concat(this.grid_header.pivot_columns_menu_items(no_steps_yet,{step_column_show_hide_all_options:true,step_column_layout_options:true}));menu.items=items;menu.render();},get_action_menu_items:function(items,target_elem,xy)
{var i,disabled,item;items.mode.push({html:'Wrap Text',item_selected:{fn:this.toggle_wrap_all_columns,scope:this},checked:this.get('wrap_all_columns'),icon_name:'icon_wrap_text'});items.mode.push({html:"Format All Rows",submenu:{items:[{html:"Row Color...",rule_type:'static_row_rule',checked:this.get_cell_manager().has_static_row_rule(),item_selected:{fn:this.show_formatting_dialog,scope:this}},{html:"Change Row Color with Rules...",rule_type:'conditional_row_rules',checked:this.get_cell_manager().has_conditional_row_rule(),item_selected:{fn:this.show_formatting_dialog,scope:this}}]},icon_name:'icon_formatting'});items.mode.push({html:'Show Page (Column) Summaries',item_selected:{fn:this.toggle_summaries_visible,scope:this},checked:this.summaries_visible()});var pivot_field=null;var pivot_row=null;if(target_elem)
{var pivot_grid_elem=target_elem.findParent('td.pivot_grid');if(pivot_grid_elem)
pivot_field=pivot_grid_elem.getAttribute('field');pivot_row=target_elem.findParent('tr.pivot_row');var cell_td=target_elem.findParent('td.sg_cell');if(cell_td&&!pivot_row)
{var field=cell_td.getAttribute('field');if(this.can_edit_field_on_selected(this.entity_type,field))
{var sel_ids=this.get_selected_record_ids();var schema_field=SG.schema.get_field(this.entity_type,field);items.cell.push({html:'Edit <b>'+schema_field.display_name+'</b> on Selected...',item_selected:{fn:this.edit_field_on_selected,scope:this},field:field,cell_elem:cell_td,disabled:sel_ids.length==0});}}}
if(pivot_field){for(i=0;i<items.global_top.length;i++){item=items.global_top[i];if(["add_note_to_selected","add_task_to_selected"].indexOf(item.item_id)!==-1)
item.pivot_field=pivot_field;}
if(pivot_row&&SG.schema.can_retire_entity('Task')){disabled=(target_elem.findParent('td.sg_summary_cell')!=null);items.cell.push({html:'Delete Task...',record_id:Number(pivot_row.getAttribute('record_id')),item_selected:{fn:this.delete_pivot_column_task,scope:this},disabled:disabled});}}},delete_pivot_column_task:function(menu,menu_item)
{var pivot_row=this.container.child('tr.pivot_row[record_id="'+menu_item.record_id+'"]');if(!pivot_row)
return;var s="position:absolute;z-index: 1000; border: solid 2px red";var selection_div=Ext.DomHelper.append(document.body,{tag:'div',style:s},true);selection_div.setVisible(false);selection_div.setHeight(pivot_row.getHeight());selection_div.setWidth(pivot_row.getWidth());selection_div.setTop(pivot_row.getTop());selection_div.setLeft(pivot_row.getLeft());selection_div.setVisible(true);var conf_str='Delete the Task outlined in red?';if(!confirm(conf_str))
{selection_div.remove();return;}
selection_div.remove();var pivot_grid_td=pivot_row.findParent('td.pivot_grid',20);var child_widget_name=pivot_grid_td.getAttribute('field');var pivot_widget=this.get_child(child_widget_name);pivot_widget.delete_record(menu_item.record_id);},can_edit_field_on_selected:function(entity_type,field_name){var schema_field=SG.schema.get_field(entity_type,field_name);if(schema_field.entity_type=='HumanUser'&&['password_strength','password_proxy'].indexOf(schema_field.name)!=-1){return false;}
return SG.schema.can_edit_field(entity_type,field_name);},edit_field_on_selected:function(menu,menu_item)
{var click_cell=Ext.get(menu_item.cell_elem);var xy=click_cell.getXY();xy[0]+=Math.floor(click_cell.getWidth()*.5);xy[1]+=Math.floor(click_cell.getHeight()*.5);var config={field:menu_item.field,entity_type:this.entity_type,data_set:this.data_set,click_xy:xy,selected_ids:this.get_selected_record_ids(),projects:this.context_projects(),grid_widget:this,};var esfd=new SG.EditSelectedFieldDialog(config);},multi_edit_selected:function(){var i,w,col;var cols=this.get_columns(true);var sel_ids=this.get_selected_record_ids();var config={data_set:this.data_set,fields:cols,selected_entity_ids:sel_ids,projects:this.context_projects(),column_display_names:this.get('column_display_names'),pivot_columns:{}};for(i=0;i<cols.length;i++){col=cols[i];if(this.is_pivot_column(col)){w=this.get_child(col);config.pivot_columns[col]=w.get_multi_edit_config(sel_ids);}}
var esd=new SG.EditSelectedDialog(config);},on_first_render:function(){var dh=Ext.DomHelper;this.container=this.get_container();this.container.addClass('sg_scroll_container');this.container.addClass('seltarget');this.add_event(this.container,'scroll',this.on_scroll);this.header_container=dh.append(this.container,{tag:'div',cls:'header'},true);this.body_container=dh.append(this.container,{tag:'div',cls:'body'},true);this.resize_proxy=dh.append(this.container,{tag:'div',cls:'resize_proxy'},true);this.add_event(this,'context_changed',this.on_context_changed);this.init_subcomponents();var pivot_column_names=this.get_child_names();for(var i=0;i<pivot_column_names.length;i++)
{var child_widget=this.get_child(pivot_column_names[i]);child_widget.render();}
this.select_first=this.get('select_first_record');this.add_event(this.data_set,'error',this.on_data_error);this.add_event(SG.schema,'column_changed',this.on_schema_column_changed);this.add_event(SG.schema,'column_removed',this.on_schema_column_removed);this.add_event(SG.schema,'reloaded',this.on_schema_reloaded);this.add_event(this.summary_set,'load',this.on_summary_load);var grid=this;window.setTimeout(function(){grid.request_data();},1);},render_widget:function(){this.render_header();this.render_body();if(this.data_set.is_loaded())
this.hide_loading_overlay();},render_header:function(){this.grid_header.render();},render_body:function(){this.clear_summary_cell_cache();this.grid_body.render();this.fireEvent('body_rendered');},clear_summary_cell_cache:function()
{this.summary_cell_cache=null;},get_dom_elements_for_cell:function(field_name,record_id,record_type)
{if(!this.summary_cell_cache)
this.create_dom_element_cache_for_cell_manager();return this.summary_cell_cache[field_name][String(record_id)];},create_dom_element_cache_for_cell_manager:function()
{this.summary_cell_cache={};var sel='td.sg_summary_cell[cm_id="'+this.cell_manager.cell_manager_id+'"]';var cells=sg_find_all(sel,this.body_container.dom);var cell,field,record_id;for(var i=0;i<cells.length;i++){cell=cells[i];field=cell.getAttribute("field");record_id=cell.getAttribute("record_id");this.summary_cell_cache[field]=this.summary_cell_cache[field]||{};this.summary_cell_cache[field][record_id]=this.summary_cell_cache[field][record_id]||[];this.summary_cell_cache[field][record_id].push(cell);}},on_context_changed:function(key,value)
{if(key=="filters"||key=="pivot_filters"||key=="parent_entity"||key=="grouping")
{this.request_data();}},on_schema_column_changed:function(entity_type,col)
{this.cell_manager.empty_cell_cache();if(entity_type=='Task'&&this.entity_type!='Task')
{this.handle_task_column_schema_changed(col);return;}
this.request_data();},on_schema_column_removed:function(entity_type,col)
{if(entity_type=='Task'&&this.entity_type!='Task')
{this.handle_task_column_schema_removed(col);return;}
var grouping=this.get_grouping();if(grouping!==false)
{var new_grouping=[];for(var i=0;i<grouping.length;i++)
{var group=grouping[i];if(group.column!=col)
new_grouping.push(group);}
if(new_grouping.length!=grouping.length)
{if(new_grouping.length===0)
new_grouping=false;this.set_grouping(new_grouping);return;}}
this.render_widget(col);},handle_task_column_schema_changed:function(col)
{var pivot_column_names=this.get_child_names();for(var i=0;i<pivot_column_names.length;i++)
{var pivot_widget=this.get_child(pivot_column_names[i]);pivot_widget.get_cell_manager().empty_cell_cache();}
this.request_data();},handle_task_column_schema_removed:function(col)
{var need_to_render=false;var pivot_column_names=this.get_child_names();for(var i=0;i<pivot_column_names.length;i++)
{var pivot_widget=this.get_child(pivot_column_names[i]);var pivot_cols=sg_deep_copy(pivot_widget.get_columns(true));var idx=pivot_cols.indexOf(col);if(idx!=-1)
{pivot_cols.splice(idx,1);pivot_widget.set('columns',pivot_cols);need_to_render=true;}}
if(need_to_render)
this.render_widget();},on_scroll:function()
{this.header_container.setTop(this.container.dom.scrollTop);},update_read_status_icon:function(record)
{var read_status=record.get('read_by_current_user');var selector='div.row[record_id="'+record.get_id()+'"]';var row_elems=Ext.DomQuery.select(selector,this.container.dom);for(var i=0;i<row_elems.length;i++)
{var row=Ext.get(row_elems[i]);var img_div=row.child('div.row_entity_icon>div.sg_entity_icon_span');var new_cls='sg_entity_icon_span '+'icon_'+this.entity_type+'_'+read_status.toLowerCase();img_div.dom.setAttribute('class',new_cls);}},update_task_violation_icon:function(record)
{var violation=record.get('dependency_violation');var selector='div.row[record_id="'+record.get_id()+'"]';var row_elems=Ext.DomQuery.select(selector,this.container.dom);for(var i=0;i<row_elems.length;i++)
{var row=Ext.get(row_elems[i]);var img_div=row.child('div.row_entity_icon>div.sg_entity_icon_span');if(!violation&&img_div.hasClass('icon_Task_violation'))
img_div.replaceClass('icon_Task_violation','icon_Task');else if(violation&&img_div.hasClass('icon_Task'))
img_div.replaceClass('icon_Task','icon_Task_violation');}},update_disabled_user_icon:function(record)
{var status=record.get('sg_status_list');var icon_class=(status==='dis')?'icon_HumanUserDisabled':'icon_HumanUser';var selector='div.row[record_id="'+record.get_id()+'"]';var row_elems=Ext.DomQuery.select(selector,this.container.dom);for(var i=0;i<row_elems.length;i++)
{var row=Ext.get(row_elems[i]);var img_div=row.child('div.row_entity_icon>div.sg_entity_icon_span');var new_cls='sg_entity_icon_span '+icon_class;img_div.dom.setAttribute('class',new_cls);}},update_entity_formatting:function(record)
{var row_rule_styles=this.get_cell_manager().evaluate_row_rule_styles(record);var selector='div.row[record_id="'+record.get_id()+'"]';var row_elems=Ext.DomQuery.select(selector,this.container.dom);for(var i=0;i<row_elems.length;i++)
{var row=Ext.get(row_elems[i]);var icon_div=row.child('div.row_entity_icon');icon_div.dom.style.backgroundColor=row_rule_styles['background-color'];}},is_pivot_column:function(col_name)
{var schema_field=SG.schema.get_field(this.entity_type,col_name);return schema_field&&schema_field.data_type==='pivot_column';},is_summary_field:function(col_name)
{var schema_field=SG.schema.get_field(this.entity_type,col_name);return(schema_field.data_type=='summary');},show_all_task_pivot_columns:function(menu,menu_item)
{var steps=SG.schema.get_pipeline_order_steps(this.entity_type);var i;var step_cols=[];for(i=0;i<steps.length;i++)
{if(steps[i].id!=0)
step_cols.push('step_'+steps[i].id);}
var cols_to_add=[];var cols=this.get_columns(true);var created_a_task_column=false;for(i=0;i<steps.length;i++)
{var step=steps[i];if(step.id==0)
continue;var step_col_name='step_'+step.id;if(cols.indexOf(step_col_name)==-1)
{created_a_task_column=true;this.create_task_step_pivot_column(step_col_name);cols_to_add.push(step_col_name);}}
if(!created_a_task_column)
return;new_cols=cols.concat(cols_to_add);this.set('columns',new_cols);this.request_data();},hide_all_task_pivot_columns:function(menu,menu_item)
{var cols=this.get_columns(true);var new_cols=[];for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_pivot_column(col))
this.delete_pivot_column(col);else
new_cols.push(col);}
this.set_silent('columns',new_cols);this.render();this.set('columns',new_cols);},expand_all_task_pivot_columns:function(menu,menu_item)
{var cols=this.get_columns(true);for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_pivot_column(col))
{var pivot_column_widget=this.get_child(col);if(menu_item.expand)
pivot_column_widget.expand_column();else
pivot_column_widget.collapse_column();}}},set_mode_for_all_task_pivot_columns:function(menu,menu_item)
{var cols=this.get_columns(true);for(var i=0;i<cols.length;i++)
{var col=cols[i];if(this.is_pivot_column(col))
{var pivot_column_widget=this.get_child(col);pivot_column_widget.set_mode(menu_item.mode);}}},delete_pivot_column:function(pivot_column_name)
{var child_widget=this.get_child(pivot_column_name);this.destroy_child(child_widget);this.widget_spec.delete_child_spec(pivot_column_name,this);},create_task_step_pivot_column:function(col_name,column_index)
{var schema_field=SG.schema.get_field(this.entity_type,col_name);this.create_pivot_column(col_name,'Task','entity',schema_field.query.filters,column_index);},create_pivot_column:function(pivot_column_name,entity_type,pivot_field,filters,column_index)
{var default_settings=SG.globals.entity_field_prefs['default_step_column_layout']?SG.globals.entity_field_prefs['default_step_column_layout']['Task']:null;if(default_settings)
default_settings=sg_deep_copy(default_settings.settings);else
default_settings={};default_settings.entity_type=entity_type;default_settings.pivot_field=pivot_field;default_settings.filters=filters;default_settings.display_column=pivot_column_name;var widget_spec={type:'SG.Widget.PivotGrid',settings:default_settings,children:{}};this.widget_spec.create_child_spec(pivot_column_name,widget_spec,this);var pivot_column_context=this.context.clone();pivot_column_context.set('grid_data_set',this.data_set);var new_child=this.construct_child(pivot_column_name,pivot_column_context);new_child.render();var new_cols=this.get_columns(true);if(typeof column_index=='undefined'||column_index===null)
new_cols.push(pivot_column_name);else
new_cols.splice(column_index,0,pivot_column_name);this.set({columns:new_cols,wrap_column_header_text:true});this.render_widget();},init_pivot_columns:function()
{var pivot_column_names=this.get_child_names();for(var i=0;i<pivot_column_names.length;i++)
{var pivot_column_name=pivot_column_names[i];var schema_field=SG.schema.get_field(this.entity_type,pivot_column_name);if(schema_field)
{var pivot_column_context=new SG.Widget.Context();pivot_column_context.set('grid_data_set',this.data_set);this.construct_child(pivot_column_name,pivot_column_context);}
else
{this.widget_spec.delete_child_spec(pivot_column_name,this);}}},apply_defaults_to_all_step_columns:function()
{var settings=SG.globals.entity_field_prefs['default_step_column_layout']?SG.globals.entity_field_prefs['default_step_column_layout']['Task']:null;if(!settings)
return;settings=sg_deep_copy(settings.settings);var columns=this.get_columns(true);for(var i=0;i<columns.length;i++)
{if(this.is_pivot_column(columns[i]))
{var pivot_column=this.get_child(columns[i]);pivot_column.widget_spec.set_settings(this,settings);}}
this.render();},manage_pipeline_steps:function(menu,item)
{var entity_type=(item&&item.entity_type)?item.entity_type:this.entity_type;var config={entity_type:entity_type,context_projects:this.context_projects()};this.manage_steps_dialog=new SG.ManageStepsDialog(config);this.add_event(this.manage_steps_dialog,"dialog_submitted",this.on_manage_steps_dialog);},on_manage_steps_dialog:function(added,removed,changed)
{if(this.manage_steps_dialog.entity_type!=this.entity_type)
{this.render();return;}
for(var i=0;i<added.length;i++)
{var r=added[i];var step_column_name='step_'+r.get_id();this.create_task_step_pivot_column(step_column_name);}},show_formatting_dialog:function(menu,menu_item)
{var schema_field=null;var field_display_name=null;if(menu_item.field)
{schema_field=SG.schema.get_field(this.entity_type,menu_item.field);field_display_name=this.get_column_display_name(menu_item.field)}
var cfd=new SG.CellFormattingDialog({entity_type:this.entity_type,schema_field:schema_field,page_id:this.get_page().id,page_widget:this.__get_entity_query_page__(),rule_type:menu_item.rule_type.indexOf('static')==0?'static_rule':'conditional_rules',context_projects:this.context_projects(),field_display_name:field_display_name});cfd.on('dialog_submitted',this.on_formatting_dialog_submitted,this);},on_formatting_dialog_submitted:function(schema_field)
{this.update_formatting_rules(schema_field);},on_schema_reloaded:function()
{var re_render=false;var cols=this.get_columns(true);var child_names=this.get_child_names();for(var i=0;i<child_names.length;i++)
{var child_name=child_names[i];if(cols.indexOf(child_name)==-1)
{this.delete_pivot_column(child_name);re_render=true;}}
if(re_render)
this.render();},get_custom_external_action_columns:function()
{return this.get_columns();},get_custom_external_action_column_display_name:function(col)
{return this.get_column_display_name(col);},get_custom_external_action_sorts:function()
{return this.get_sorts();},});SG.GridHeader=function(config){Ext.apply(this,config);SG.GridHeader.superclass.constructor.call(this);};Ext.extend(SG.GridHeader,SG.Component,{templates:{header:'{header_table}{splitters}{summary_table}<div class="header_extention"></div>',header_table:'<table class="header_table sg_table_math" style="width:{width_sum}px">'+'<tr><td class="header_selector selectable seltarget selectall">&nbsp;</td>{headings}'+'<td class="column_management"><div class="button_add-column">&nbsp;</div></td>'+'</tr></table>',heading:'<td class="heading {extra_cls}" style="width: {width}px" field="{name}" {attributes}>'+'<div class="content">{sort_arrow}{display_name}</div></td>',splitter:'<div class="resize_splitter {extra_cls}" field="{name}">&nbsp;</div>',summary_table:'<table class="summary_table sg_table_math" style="width:{width_sum}px">'+'<tr><td class="spacer">&nbsp;</td>{summaries}'+'</tr></table>',summary:'<td class="summary {td_extra_cls}" style="width: {width}px" field="{name}">'+'<div class="content {extra_cls}">{value}</div></td>',page_favorite:'<div class="favorite_editor_button_selected"></div>',},init_component:function(){this.summary_set=this.grid.summary_set;this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'contextmenu',this.on_contextmenu);Ext.EventManager.onWindowResize(this.on_window_resize,this);},render:function(){var cols=this.grid.get_columns(true);var headings='';var splitters='';var summaries='';var i;if(this.grid.in_gantt_wrapper()||this.grid.get_tall_header())
this.container.addClass('double_height');else
this.container.removeClass('double_height');this.container.addClass('sgw_new_grid_header');for(i=0;i<cols.length;i++){var col=cols[i];if(this.grid.is_pivot_column(col))
{var column_widget=this.grid.get_child(col);headings+=column_widget.render_header(i===0);}
else
headings+=this.render_heading(col,i===0);splitters+=this.render_splitter(col,i===0);}
var width_sum=this.grid.get_column_width_sum();var width_with_pad=width_sum+17+this.grid.get_entity_icon_offset()+16;var grouping=this.grid.get_grouping();if(grouping)
width_with_pad+=grouping.length*this.grid.get_group_offset();var header_table_html=this.templates.header_table.apply({headings:headings,width_sum:width_with_pad});var summary_table_html='';if(this.grid.summaries_visible()){for(i=0;i<cols.length;i++){summaries+=this.render_summary(cols[i],i===0);}
summary_table_html=this.templates.summary_table.apply({summaries:summaries,width_sum:width_with_pad-16});}
var params={header_table:header_table_html,splitters:splitters,summary_table:summary_table_html};var header_html=this.templates.header.apply(params);this.container.update(header_html);var header_table=sg_find('table.header_table',this.container.dom);var table_width=Ext.fly(header_table).getWidth();var grid_width=this.grid.container.getWidth();if(table_width>grid_width)
this.container.setWidth(table_width);else
this.remove_width_from_grid_container();this.position_splitters();},remove_width_from_grid_container:function()
{this.container.dom.style.width='';},render_heading:function(col,first_column){var schema_field=SG.schema.get_field(this.grid.entity_type,col);var heading_params={extra_cls:''};var extra_width=0;if(first_column)
{var grouping=this.grid.get_grouping();if(grouping)
extra_width+=grouping.length*16;extra_width+=this.grid.get_entity_icon_offset();}
var display_name;if(this.grid.entity_type=='Page'&&col=='current_user_favorite'){display_name=this.templates.page_favorite.apply();}
else
display_name=this.grid.get_column_display_name(col);heading_params={name:col,display_name:display_name,width:this.grid.get_column_width(col)+extra_width};if(schema_field.no_sorting)
heading_params.attributes='sg_tip="Sorting is not available on this column"';else{var primary_sort=this.grid.is_primary_sort(col);if(primary_sort){heading_params.sort_arrow='<img src="'+Ext.BLANK_IMAGE_URL+'" class="sort_arrow">';}
var sorting=this.grid.is_sorted_by(col);if(sorting!==false)
heading_params.attributes='sorting="'+sorting+'"';}
var color=this.grid.get_column_header_color(col);if(color)heading_params.extra_cls+=" column_header_color"+color;var cm=this.grid.get_cell_manager();var cell=cm.get_cell(col,this.grid.get_cell_config(col));heading_params.extra_cls+=" "+cell.get_type_formatting_class();return this.templates.heading.apply(heading_params);},render_splitter:function(col,first_column){var extra_cls=first_column?'first_splitter':'';if(this.grid.is_pivot_column(col))
extra_cls+=' wide_splitter';return this.templates.splitter.apply({name:col,extra_cls:extra_cls});},position_splitters:function(){var origin_x=this.container.getLeft();var cols=this.grid.get_columns(true);for(var i=0;i<cols.length;i++)
{var col=cols[i];var splitter_el=this.container.child('div.resize_splitter[field="'+col+'"]:not(.pivot_grid_spliter)');var heading_el=this.container.child('td.heading[field="'+col+'"]');var offset=this.grid.is_pivot_column(col)?8:4;splitter_el.setLeft(heading_el.getRight()-origin_x-offset);}},render_summary:function(col,first_column){if(this.grid.is_pivot_column(col))
{var column_widget=this.grid.get_child(col);return column_widget.render_header_summary(first_column);}
var extra_width=0;if(first_column)
{var grouping=this.grid.get_grouping();if(grouping)
extra_width+=grouping.length*16;extra_width+=this.grid.get_entity_icon_offset()-1;}
if(this.grid.is_summary_field(col))
{var cm=this.grid.get_cell_manager();var cell=cm.get_cell(col,this.grid.get_cell_config(col));var summary=cell.render_page_summary();return this.templates.summary.apply({name:col,width:this.grid.get_column_width(col)+extra_width,value:summary.summary_content,extra_cls:summary.summary_classes});}
var val=this.summary_set.get('page',col);var render_sum={summary_content:'',summary_classes:''};if(val===null){render_sum.summary_content="&nbsp;";}else{var cm=this.grid.get_cell_manager();var cell=cm.get_cell(col,this.grid.get_cell_config(col));var sum=this.grid.get_summary(col);if(sum.type=='record_count')
val=this.grid.get_record_count();render_sum=cell.render_summary(sum.type,val,sum.value);}
if(first_column)
render_sum.summary_classes+=' first_column';var params={name:col,width:this.grid.get_column_width(col)+extra_width,value:render_sum.summary_content,extra_cls:render_sum.summary_classes};return this.templates.summary.apply(params);},toggle_sort:function(field){var schema_field=SG.schema.get_field(this.grid.entity_type,field);if(schema_field.no_sorting)
return;var sorted=this.grid.is_sorted_by(field);if(sorted=='asc')
this.grid.set_sorts([{column:field,direction:'desc'}]);else
this.grid.set_sorts([{column:field,direction:'asc'}]);},create_update_dc:function(config){if(config.field&&this.grid.is_pivot_column(config.field))
{var column_widget=this.grid.get_child(config.field);config.show_column_callback={fn:column_widget.toggle_column,scope:column_widget};}
else
config.show_column_callback={fn:this.grid.toggle_column,scope:this.grid};if(!config.widget)
config.widget=this.grid;var cudc=new SG.util.CreateUpdateDC(config);},on_create_update_pivot_dc:function(menu,menu_item)
{var pivot_widget=this.grid.get_child(menu_item.pivot_column_field);var config=menu_item.config;config.show_column_callback={fn:pivot_widget.toggle_column,scope:pivot_widget};if(!config.widget)
config.widget=pivot_widget;var cudc=new SG.util.CreateUpdateDC(config);},show_column_menu:function(field,elem){if(!this.column_menu){var hide_fn=function(menu){menu.hide_elem.removeClass('selected');};var config={item_selected:{fn:this.on_column_menu_selected,scope:this},after_hide:{fn:hide_fn,scope:this}};this.column_menu=this.new_component(SG.Menu,config);}
var col_idx=this.grid.get_column_index(field);var items;items=this.get_column_menu_items(field);elem.addClass('selected');this.column_menu.items=items;this.column_menu.position={dom_elem:elem,elem_anchor:"bl",menu_anchor:"tl"};this.column_menu.col_idx=col_idx;this.column_menu.render();this.column_menu.show();this.column_menu.hide_elem=elem;},get_column_menu_items:function(field){var schema_field=SG.schema.get_field(this.grid.entity_type,field);var can_update_field=SG.schema.can_edit_field("DisplayColumn","data_type");var sorted_by=this.grid.is_sorted_by(field);var col_index=this.grid.get_column_index(field);var items=[];if(!schema_field.no_sorting)
{items.push({html:'Sort Ascending',value:'sort',checked:(sorted_by==='asc'),field:field,direction:'asc',icon_name:'icon_menu_arrow_up'},{html:'Sort Descending',value:'sort',checked:(sorted_by==='desc'),field:field,direction:'desc',icon_name:'icon_menu_arrow_down'});}
items.push({html:'Advanced Sorting...',value:'sort_advanced',field:field},{line:true});items.push({html:'Wrap Text',value:'wrap_text',checked:this.grid.is_wrapped(field),field:field,icon_name:'icon_wrap_text'});if(!schema_field.no_grouping)
items.push({html:'Group',submenu:{items:this.get_grouping_items(field)}});if(!schema_field.no_summary)
items.push({html:'Summary',submenu:{items:this.get_summary_items(this.grid,field)}});items.push({html:'Format',submenu:{items:this.get_column_formatting_items(field)},icon_name:'icon_formatting'});items.push({line:true});items.push({html:'Insert Column',submenu:{before_first_render:{fn:this.get_insert_column_items,scope:this},item_selected:{fn:this.on_column_management_menu_selected,scope:this},column_index:col_index},icon_name:'button_add-column'});items.push({line:true});var manage_pipeline_tems=this.get_manage_pipeline_items(field);items=items.concat(manage_pipeline_tems);if(can_update_field){var config={entity_type:schema_field.entity_type,schema_field:schema_field,widget:this.grid};var field_info=SG.schema.parse_field_name(this.grid.entity_type,field);if(field_info.type=="join")
{config.field_name_prefix=field.replace(/\.\w+$/,"");config.field_context_title_label=SG.schema.entity_types[schema_field.entity_type].display_name;}
items.push({html:"Configure Field...",value:"create_update_dc",config:config,disabled:!schema_field.configurable});}
items.push({html:"Hide Column",value:"hide_column",disabled:(this.grid.get_columns().length===1),field:field});return items;},change_pivot_widget_sort:function(menu,menu_item)
{var pivot_widget=this.grid.get_child(menu_item.pivot_widget);pivot_widget.set_sort(menu_item.field,menu_item.direction);},toggle_pivot_field_wrap:function(menu,menu_item)
{var field=menu_item.field;var pivot_field=menu_item.pivot_field;var pivot_widget=this.grid.get_child(field);pivot_widget.set_wrapped(pivot_field,!menu_item.checked);},hide_pivot_column:function(menu,menu_item)
{this.grid.delete_pivot_column(menu_item.field);},get_insert_column_items:function(menu)
{menu.items=this.get_column_management_items({column_management_dialog:true});},get_grouping_items:function(field)
{var items=[];var grouped_by=this.grid.is_grouped_by(field);var grouping=this.grid.get_grouping();var options=SG.schema.get_grouping_options(this.grid.entity_type,field);var opt,i;for(i=0;i<options.length;i++){opt=options[i];items.push({html:opt.display_name,value:'group',checked:(grouped_by===opt.name),field:field,method:opt.name,direction:'asc'});}
items.push({line:true});items.push({html:grouping===false?'Advanced Grouping...':'Add to Advanced Grouping...',item_selected:{fn:this.on_show_advanced_grouping,scope:this},field:field});if(grouping!==false){items.push({line:true},{html:'Ungroup',value:'ungroup'});}
return items;},on_show_advanced_grouping:function(menu,menuitem)
{var grouping=this.grid.get_grouping();if(grouping===false)
grouping=[];grouping.push({column:menuitem.field,method:'exact',direction:'asc'});this.grid.set_grouping(grouping);this.grid.show_nested_grouping_dialog(this.grid.get('column_display_names'));},get_summary_items:function(widget,field,item_sel,skip_page_summaries)
{var schema_field=SG.schema.get_field(widget.entity_type,field);var current_summary=widget.get_summary(field);var summary_entity_type=widget.entity_type;if(schema_field.data_type=='summary')
{var summary_field=schema_field.summary_field;summary_entity_type=schema_field.query.entity_type;schema_field=SG.schema.get_field(schema_field.query.entity_type,summary_field);schema_field.summary_field=summary_field;}
var options=SG.schema.summary_options[schema_field.data_type]||[];var names=SG.schema.summary_display_names;var edn=SG.schema.entity_types[summary_entity_type]['display_name'];var items=[];var pct_items=[];var opt;var item;if(!skip_page_summaries)
{item={html:'Show Page (Column) Summaries',value:'display_summaries',checked:this.grid.summaries_visible()};if(item_sel)
item.item_selected=item_sel;items.push(item);items.push({line:true});}
for(var i=0;i<options.length;i++){opt=options[i];var option_name=names[opt];if(opt=='record_count')
option_name=option_name.replace('Entity',edn);if(opt!=='percentage'&&opt!=='status_percentage'){var item={html:option_name,value:'summary',checked:(current_summary.type===opt),field:field,summary_field:schema_field.summary_field?schema_field.summary_field:field,summary_type:opt,summary_value:null};if(item_sel)
item.item_selected=item_sel;items.push(item);}else{items.push({html:names[opt],submenu:{items:this.get_percentage_summary_items(current_summary,field,schema_field,item_sel)}});}}
return items;},get_percentage_summary_items:function(current_summary,field,schema_field,item_sel)
{var items=[];var list=schema_field;var percentage_type=(schema_field.data_type==='status_list'?'status_percentage':'percentage');var i;if(schema_field.data_type==='status_list')
{list={values:[],display_values:[]};var status_list=SG.schema.status_list;var status_list_subset=schema_field.status_list_subset;for(i=0;i<status_list_subset.length;++i)
{list.values.push(status_list_subset[i]);list.display_values.push(status_list[status_list_subset[i]].name);}}
for(i=0;i<list.values.length;i++)
{var item={html:list.display_values[i],value:'summary',checked:(current_summary.type==percentage_type&&current_summary.value==list.values[i]),field:field,summary_field:schema_field.summary_field?schema_field.summary_field:field,summary_type:percentage_type,summary_value:list.values[i]};if(item_sel)
item.item_selected=item_sel;items.push(item);}
return items;},get_pivot_column_formatting_items:function(field,pivot_field)
{var items=[];items.push({html:'Rename Column for this Page Only...',pivot_field:pivot_field,field:field,item_selected:{fn:this.show_rename_pivot_column_dialog,scope:this}});items.push({html:"Column Header Color...",pivot_field:pivot_field,field:field,item_selected:{fn:this.show_pivot_header_color_dialog,scope:this}});var schema_field=SG.schema.get_field('Task',pivot_field);if(schema_field.data_type==='text'||schema_field.data_type==='number'){var pivot_widget=this.grid.get_child(field);var is_detail_link=pivot_widget.is_detail_link(pivot_field);items.push({html:'Render As Link to Detail Page',checked:is_detail_link,field:field,pivot_field:pivot_field,item_selected:{fn:this.toggle_pivot_column_detail_link,scope:this}});}
return items;},toggle_pivot_column_detail_link:function(menu,menu_item)
{var field=menu_item.field;var pivot_field=menu_item.pivot_field;var pivot_widget=this.grid.get_child(field);pivot_widget.set_detail_link(pivot_field,!menu_item.checked);},get_column_formatting_items:function(field)
{var schema_field=SG.schema.get_field(this.grid.entity_type,field);var tall_header=this.grid.get_tall_header();var items=[];items.push({html:"Header Color...",value:'color_header',field:field,checked:this.grid.get_column_header_color(field)});items.push({html:"Cell Color...",field:field,rule_type:'static_rule',checked:this.grid.get_cell_manager().has_static_field_rule(field,schema_field),item_selected:{fn:this.grid.show_formatting_dialog,scope:this.grid}});items.push({html:"Change Cell Colors with Rules...",field:field,rule_type:'conditional_rules',checked:this.grid.get_cell_manager().has_conditional_field_rule(field,schema_field),item_selected:{fn:this.grid.show_formatting_dialog,scope:this.grid}});items.push({line:true});if(!this.grid.in_gantt_wrapper())
items.push({html:'Double Tall Header',value:'tall_header',checked:tall_header});items.push({html:'Rename Header...',value:'rename_column',field:field});if(schema_field.data_type==='text'||schema_field.data_type==='number')
{var is_detail_link=this.grid.is_detail_link(field);var type_display_name=SG.schema.entity_types[this.grid.entity_type].display_name;items.push({html:'Display Cell as Link to the '+type_display_name+' Detail Page',value:'detail_link',checked:is_detail_link,field:field});}
return items;},get_column_management_items:function(special_items,selected_fields,field_disabled_callback)
{if(typeof selected_fields=='undefined')
selected_fields=this.grid.get_columns(true);if(typeof field_disabled_callback=='undefined')
field_disabled_callback={fn:function(field_schema,field_name){},scope:this};var items=[];if(special_items.column_management_dialog)
{items.push({html:'Manage Columns...',value:'manage_columns'});if(this.grid.entity_type!="DisplayColumn"&&SG.schema.can_create_entity("DisplayColumn"))
{items.push({html:'Add New Field To '+
SG.schema.entity_types[this.grid.entity_type].display_name+"...",value:'create_update_dc',config:{entity_type:this.grid.entity_type,widget:this.grid}});}
items.push({line:true});}
var through_join_fields=this.grid.get_through_join_fields();var entity_fields_menu_helper=new SG.util.EntityFieldsMenuHelper({entity_type:this.grid.entity_type,field_value_callback:{fn:function(field_schema,field_name){return field_name;},scope:this},field_checked_callback:{fn:function(field_schema,field_name){return(selected_fields.indexOf(field_name)!=-1);},scope:this},field_disabled_callback:field_disabled_callback,through_join_fields:this.grid.get_through_join_fields(),parent_entity:this.grid.context.get('parent_entity'),add_create_join_fields_items:(special_items.column_management_dialog&&SG.schema.can_create_entity("DisplayColumn")),column_display_names:this.grid.get('column_display_names'),pivot_items_callback:{fn:this.pivot_columns_menu_items,scope:this,special_items:special_items},linked_pivot_items_callback:{fn:this.linked_pivot_columns_menu_items,scope:this,special_items:special_items},no_steps:special_items.no_steps});items=items.concat(entity_fields_menu_helper.get_fields_menu_items());return items;},linked_pivot_columns_menu_items:function(special_items)
{var items=[];var linked_pipelines=SG.schema.get_linked_pipeline_steps(this.grid.entity_type);var task_fields=SG.schema.get_categorized_fields('Task',false,true).ordinary;for(var i=0;i<linked_pipelines.length;i++)
{if(linked_pipelines[i].entity_types.length==1)
{var entity_type_info=linked_pipelines[i].entity_types[0];items.push({html:linked_pipelines[i].schema_field.display_name+' Steps',submenu:{items:this.get_linked_pipeline_summary_menu_items(linked_pipelines[i].schema_field,entity_type_info.entity_type,entity_type_info.steps,task_fields,special_items.step_column_show_hide_all_options)},icon_name:'icon_'+entity_type_info.entity_type});}
else
{var sub_items=[];for(var j=0;j<linked_pipelines[i].entity_types.length;j++)
{var entity_type_info=linked_pipelines[i].entity_types[j];sub_items.push({html:SG.schema.entity_types[entity_type_info.entity_type]['display_name']+' Steps',submenu:{items:this.get_linked_pipeline_summary_menu_items(linked_pipelines[i].schema_field,entity_type_info.entity_type,entity_type_info.steps,task_fields,special_items.step_column_show_hide_all_options)},icon_name:'icon_'+entity_type_info.entity_type});}
items.push({html:linked_pipelines[i].schema_field.display_name+' Steps',submenu:{items:sub_items},});}}
return items;},get_linked_pipeline_summary_menu_items:function(linked_schema_field,linked_entity_type,steps,task_schema_fields,pipeline_management_option)
{var cols=this.grid.get_columns();var i,j;var items=[];if(steps.length==1&&steps[0].id==0)
{items.push({no_steps_yet:true,disabled:true,html:'<div style="color:#777; font-style: italic; padding-top: 8px; padding-bottom: 5px;">'+'No Task Pipeline Steps exist yet for <br>'+
SG.schema.entity_types[linked_entity_type].display_name.pluralize(2)+'.  You can manage the Task Pipeline<br> by clicking on the link below.</div>'});}
else
{for(i=0;i<steps.length;i++)
{var step=steps[i];var step_dc_name='step_'+step.id;var task_items=[];var field_prefix=linked_schema_field.name+'.'+linked_entity_type+'.'+step_dc_name+'$';for(j=0;j<task_schema_fields.length;j++)
{var task_schema_field=task_schema_fields[j];var field_name=field_prefix+task_schema_field.name;task_items.push({html:task_schema_field.display_name,value:field_name,checked:cols.indexOf(field_name)!=-1});}
items.push({html:step.code,icon_name:'transparent_step_color',icon_bg_color:step.color,submenu:{items:task_items}});}}
if(pipeline_management_option)
{items.push({line:true});items.push({html:'Manage '+SG.schema.entity_types[linked_entity_type]['display_name']+' Pipeline...',entity_type:linked_entity_type,field_prefix:linked_schema_field.name+'.'+linked_entity_type+'.',item_selected:{fn:this.grid.manage_pipeline_steps,scope:this.grid},icon_name:'icon_preferences',disabled:!SG.schema.can_create_entity('Step')});}
return items;},pivot_columns_menu_items:function(no_steps_yet,special_items)
{var items=[];if(!no_steps_yet)
{if(special_items.step_column_show_hide_all_options)
{items.push({line:true});items.push({html:'Show all',item_selected:{fn:this.grid.show_all_task_pivot_columns,scope:this.grid},});items.push({html:'Hide all',item_selected:{fn:this.grid.hide_all_task_pivot_columns,scope:this.grid},});}
if(special_items.step_column_layout_options)
{var sub_items=[];sub_items.push({html:'Expand all',item_selected:{fn:this.grid.expand_all_task_pivot_columns,scope:this.grid},expand:true});sub_items.push({html:'Collapse all',item_selected:{fn:this.grid.expand_all_task_pivot_columns,scope:this.grid},expand:false});sub_items.push({line:true});sub_items.push({html:'Show Details Only for all',item_selected:{fn:this.grid.set_mode_for_all_task_pivot_columns,scope:this.grid},mode:'detail'});sub_items.push({html:'Show Summaries Only for all',item_selected:{fn:this.grid.set_mode_for_all_task_pivot_columns,scope:this.grid},mode:'summary'});sub_items.push({html:'Show Details and Summaries for all',item_selected:{fn:this.grid.set_mode_for_all_task_pivot_columns,scope:this.grid},mode:'both'});sub_items.push({line:true});sub_items.push({html:'Show Page (Column) Summaries',item_selected:{fn:this.grid.toggle_summaries_visible,scope:this.grid},checked:this.grid.summaries_visible()});sub_items.push({line:true});sub_items.push({html:'Revert all Steps to the Default Layout',item_selected:{fn:this.grid.apply_defaults_to_all_step_columns,scope:this.grid}});items.push({line:true});items.push({html:"Update Layout",submenu:{items:sub_items}});}}
if(special_items.step_column_show_hide_all_options)
{items.push({line:true});var entity_dn=SG.schema.entity_types[this.grid.entity_type]['display_name'];items.push({html:'Manage '+entity_dn+' Pipeline...',item_selected:{fn:this.grid.manage_pipeline_steps,scope:this.grid},icon_name:'icon_preferences',disabled:!SG.schema.can_create_entity('Step')});}
return items;},show_column_management_menu:function(elem){if(!this.column_management_menu){var hide_fn=function(menu){menu.hide_elem.removeClass('selected');};var config={item_selected:{fn:this.on_column_management_menu_selected,scope:this},after_hide:{fn:hide_fn,scope:this}};this.column_management_menu=this.new_component(SG.Menu,config);}
var items=this.get_column_management_items({column_management_dialog:true,step_column_show_hide_all_options:true});elem.addClass('selected');this.column_management_menu.items=items;this.column_management_menu.position={dom_elem:elem,elem_anchor:"br",menu_anchor:"tr"};this.column_management_menu.render();this.column_management_menu.show();this.column_management_menu.hide_elem=elem;},show_manage_columns_dialog:function(field){var widget=this.grid;if(field&&this.grid.is_pivot_column(field))
widget=this.grid.get_child(field);var mcd=new SG.ManageColumnsDialog({entity_type:widget.entity_type,columns:widget.get_columns(true),join_fields:widget.get_through_join_fields(),omit_identifier_field:false,column_display_names:widget.get('column_display_names'),pivot_columns:'fields'});mcd.on('dialog_submitted',widget.change_columns,widget);},show_rename_column_dialog:function(field){var crd=new SG.ColumnRenameDialog({field_name:field,old_column_display_name:this.grid.get_column_display_name(field),default_column_display_name:SG.schema.get_field(this.grid.entity_type,field).display_name});crd.on('dialog_submitted',this.on_rename_column_submit,this);},show_rename_pivot_column_dialog:function(menu,menu_item)
{var field=menu_item.field;var pivot_field=menu_item.pivot_field;var pivot_widget=this.grid.get_child(field);var crd=new SG.ColumnRenameDialog({pivot_column_field:field,field_name:pivot_field,old_column_display_name:pivot_widget.get_column_display_name(pivot_field),default_column_display_name:SG.schema.get_field('Task',pivot_field).display_name});crd.on('dialog_submitted',this.on_rename_pivot_column_submit,this);},on_rename_pivot_column_submit:function(field,new_name,pivot_column_field){var pivot_widget=this.grid.get_child(pivot_column_field);if(new_name.match(/^\s*$/))
new_name=SG.schema.get_field('Task',field).display_name;pivot_widget.set_column_display_name(field,new_name);},show_advanced_sorting_dialog:function(){var menu_items=this.get_column_management_items({no_steps:true},[],{fn:function(field_schema,field_name){return field_schema.no_sorting;},scope:this});var mcd=new SG.AdvancedSortingDialog({entity_type:this.grid.entity_type,sorts:this.grid.get_sorts(),menu_items:menu_items,column_display_name_fn:{fn:this.grid.get_column_display_name,scope:this.grid}});mcd.on('dialog_submitted',this.on_advanced_sorting_submit,this);},show_header_color_dialog:function(field){var chcd=new SG.ColumnHeaderColorDialog({column:field,color:this.grid.get_column_header_color(field)});chcd.on('dialog_submitted',this.on_header_color_submit,this);},show_pivot_header_color_dialog:function(menu,menu_item){var field=menu_item.field;var pivot_field=menu_item.pivot_field;var pivot_widget=this.grid.get_child(field);var chcd=new SG.ColumnHeaderColorDialog({pivot_column_field:field,column:pivot_field,color:pivot_widget.get_column_header_color(pivot_field)});chcd.on('dialog_submitted',this.on_pivot_header_color_submit,this);},on_pivot_header_color_submit:function(pivot_field,color,pivot_column_field)
{var pivot_widget=this.grid.get_child(pivot_column_field);pivot_widget.set_column_header_color(pivot_field,color);},on_click:function(e){var target=Ext.get(e.getTarget());var header=target.findParent('div.header');if(!header)return;if(e.ctrlKey)return;var heading=target.findParent('td.heading',header,true);if(heading){var field=heading.dom.getAttribute('field');if(!this.grid.is_pivot_column(field))
this.toggle_sort(field);}
var column_management=target.findParent('td.column_management',header,true);if(column_management){this.show_column_management_menu(column_management);}},on_contextmenu:function(e){var target=Ext.get(e.getTarget());var header=target.findParent('div.header');if(!header)return;var heading=target.findParent('td.heading',header,true);if(heading){e.stopEvent();var field=heading.dom.getAttribute('field');if(this.grid.is_pivot_column(field))
this.on_pivot_column_contextmenu(header,target,field);else
this.show_column_menu(field,heading);}
var column_management=target.findParent('td.column_management',header,true);if(column_management){e.stopEvent();this.show_column_management_menu(column_management);}},on_pivot_column_contextmenu:function(header,target,field)
{if(!this.pivot_column_menu)
{this.pivot_column_menu=this.new_component(SG.Menu,{after_hide:{fn:function(menu){menu.hide_elem.removeClass('selected');},scope:this}});}
var items=[];var elem=target.findParent('td.pivot_heading',header,true);if(elem)
{var pivot_field=elem.dom.getAttribute('field');var pivot_widget=this.grid.get_child(field);var gedn=SG.schema.entity_types[this.grid.entity_type].display_name;var sorts=pivot_widget.get_sorts();var pivot_schema_field=SG.schema.get_field(pivot_widget.entity_type,pivot_field);items.push({html:'Sort Tasks per '+gedn+' Ascending ',pivot_widget:field,field:pivot_field,direction:'asc',checked:sorts.length==1&&sorts[0].column==pivot_field&&sorts[0].direction=='asc',item_selected:{fn:this.change_pivot_widget_sort,scope:this},disabled:pivot_widget.get('mode')=='summary'||pivot_schema_field.no_sorting,icon_name:'icon_menu_arrow_up'});items.push({html:'Sort Tasks per '+gedn+' Descending ',pivot_widget:field,field:pivot_field,direction:'desc',checked:sorts.length==1&&sorts[0].column==pivot_field&&sorts[0].direction=='desc',item_selected:{fn:this.change_pivot_widget_sort,scope:this},disabled:pivot_widget.get('mode')=='summary'||pivot_schema_field.no_sorting,icon_name:'icon_menu_arrow_down'});items.push({line:true});items.push({html:'Wrap Text',field:field,pivot_field:pivot_field,item_selected:{fn:this.toggle_pivot_field_wrap,scope:this},checked:pivot_widget.is_wrapped(pivot_field)});var mode=pivot_widget.get('mode');var summary_items=[];summary_items.push({html:'Show Details Only',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='detail',mode:'detail',field:field});summary_items.push({html:'Show Summaries Only',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='summary',mode:'summary',field:field});summary_items.push({html:'Show Details and Summaries',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='both',mode:'both',field:field});summary_items.push({line:true});summary_items.push({html:'Show Page (Column) Summaries',item_selected:{fn:this.grid.toggle_summaries_visible,scope:this.grid},checked:this.grid.summaries_visible()});summary_items.push({heading:"SUMMARY CALCULATION"});var item_selected={fn:pivot_widget.on_summary_menu_selected,scope:pivot_widget};var summary_calc_items=this.get_summary_items(pivot_widget,pivot_field,item_selected,true);summary_items=summary_items.concat(summary_calc_items);items.push({html:'Summary',submenu:{items:summary_items}});items.push({html:'Column Formatting',submenu:{items:this.get_pivot_column_formatting_items(field,pivot_field)}});items.push({line:true});var col_index=pivot_widget.get_column_index(pivot_field);items.push({html:'Insert Column',submenu:{items:this.get_pivot_column_management_items(field,pivot_field),column_index:col_index,item_selected:{fn:this.on_toggle_pivot_column,scope:this},},icon_name:'button_add-column'});items.push({line:true});var schema_field=SG.schema.get_field('Task',pivot_field);var can_update_field=SG.schema.can_edit_field("DisplayColumn","data_type");if(schema_field.configurable&&can_update_field)
{var config={entity_type:schema_field.entity_type,schema_field:schema_field};items.push({html:'Configure Field... ',config:config,pivot_column_field:field,item_selected:{fn:this.on_create_update_pivot_dc,scope:this},});}
items.push({html:'Hide Column',pivot_column_field:field,field:pivot_field,item_selected:{fn:this.on_toggle_pivot_column,scope:this}});this.pivot_column_menu.column_index=col_index;;}
else
{elem=target.findParent('div.sg_color',header,true);var pivot_widget=this.grid.get_child(field);var edn=SG.schema.entity_types[this.grid.entity_type].display_name;items.push({html:'Expand',item_selected:{fn:pivot_widget.expand_column,scope:pivot_widget},checked:pivot_widget.get('open')});items.push({html:'Collapse',item_selected:{fn:pivot_widget.collapse_column,scope:pivot_widget},checked:!pivot_widget.get('open')});var mode=pivot_widget.get('mode');items.push({line:true});items.push({html:'Show Details Only',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='detail',mode:'detail',field:field});items.push({html:'Show Summaries Only',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='summary',mode:'summary',field:field});items.push({html:'Show Details and Summaries',item_selected:{fn:this.on_pivot_column_mode,scope:this},checked:mode=='both',mode:'both',field:field});items.push({line:true});items.push({html:'Show Page (Column) Summaries',checked:this.grid.summaries_visible(),item_selected:{fn:this.grid.toggle_summaries_visible,scope:this.grid}});items.push({line:true});if(SG.globals.current_user.admin)
{items.push({html:"Save This Layout as the Default",item_selected:{fn:pivot_widget.save_layout_as_default,scope:pivot_widget}});}
items.push({html:'Update all Steps to Match This Layout',item_selected:{fn:pivot_widget.synchronize_all_other_step_columns,scope:pivot_widget}});items.push({html:'Revert all Steps to the Default Layout',item_selected:{fn:this.grid.apply_defaults_to_all_step_columns,scope:this.grid}});items.push({line:true});items.push({html:'Manage '+edn+' Pipeline...',item_selected:{fn:this.grid.manage_pipeline_steps,scope:this.grid},icon_name:'icon_preferences',disabled:!SG.schema.can_create_entity('Step')});items.push({line:true});var col_index=this.grid.get_column_index(field);items.push({html:'Insert Column',submenu:{before_first_render:{fn:this.get_insert_column_items,scope:this},item_selected:{fn:this.on_column_management_menu_selected,scope:this},column_index:col_index},icon_name:'button_add-column'});items.push({line:true});items.push({html:'Hide Column',disabled:(this.grid.get_columns(true).length===1),field:field,value:'hide_column',item_selected:{fn:this.on_column_menu_selected,scope:this}});}
elem.addClass('selected');this.pivot_column_menu.items=items;this.pivot_column_menu.position={dom_elem:elem,elem_anchor:"bl",menu_anchor:"tl"};this.pivot_column_menu.render();this.pivot_column_menu.show();this.pivot_column_menu.hide_elem=elem;},on_pivot_column_mode:function(menu,menu_item)
{if(menu_item.checked)
return;var pivot_widget=this.grid.get_child(menu_item.field);pivot_widget.set_mode(menu_item.mode);},get_manage_pipeline_items:function(field_name)
{var items=[];if(this.grid.entity_type!='Task'||field_name!='step')
return items;var sub_items=[];var entities=SG.schema.leftnav_page_entity_types;for(var i=0;i<entities.length;i++)
{var entity_type=entities[i];var schema_field=SG.schema.get_field(entity_type,'tasks');if(!schema_field)
continue;var dnp=SG.schema.entity_types[entity_type]['display_name_pluralized'];sub_items.push({html:dnp,entity_type:entity_type,item_selected:{fn:this.on_manage_pipeline_for_entity,scope:this}});}
items.push({html:'Manage Pipeline',submenu:{items:sub_items},disabled:!SG.schema.can_create_entity('Step')});items.push({line:true});return items;},on_manage_pipeline_for_entity:function(menu,menu_item)
{var config={entity_type:menu_item.entity_type,context_projects:this.grid.context_projects()};var msd=new SG.ManageStepsDialog(config);msd.on("dialog_submitted",this.on_manage_steps_dialog,this);},on_manage_steps_dialog:function()
{this.grid.reload_all_entities();},get_pivot_column_management_items:function(field,pivot_field)
{var items=[];items.push({html:'Manage Columns...',field:field,item_selected:{fn:this.on_column_management_menu_selected,scope:this},value:'manage_columns'});var pivot_widget=this.grid.get_child(field);if(SG.schema.can_create_entity("DisplayColumn"))
{items.push({html:'Add New Field To '+SG.schema.entity_types['Task'].display_name+"...",value:'create_update_dc',config:{entity_type:'Task',field:field,widget:pivot_widget},item_selected:{fn:this.on_column_management_menu_selected,scope:this},});}
items.push({line:true});var selected_fields=pivot_widget.get_columns(true);var entity_fields_menu_helper=new SG.util.EntityFieldsMenuHelper({entity_type:'Task',field_checked_callback:{fn:function(field_schema,field_name){return(selected_fields.indexOf(field_name)!=-1);},scope:this},field_disabled_callback:{fn:function(field_schema,field_name){return false;},scoope:this},column_display_names:pivot_widget.get('column_display_names'),pivot_column_field:field});items=items.concat(entity_fields_menu_helper.get_fields_menu_items());return items;},on_toggle_pivot_column:function(menu,menu_item)
{var pivot_widget=this.grid.get_child(menu_item.pivot_column_field);pivot_widget.toggle_column(menu_item.field,menu.column_index);},on_window_resize:function()
{var header_table=sg_find('table.header_table',this.container.dom);var table_width=Ext.fly(header_table).getWidth();var grid_width=this.grid.container.getWidth();if(table_width>grid_width)
this.container.setWidth(table_width);else
this.remove_width_from_grid_container();},on_column_menu_selected:function(menu,item){switch(item.value){case"sort":this.grid.set_sorts([{column:item.field,direction:item.direction}]);break;case"sort_advanced":this.show_advanced_sorting_dialog();break;case"hide_column":this.grid.toggle_column(item.field);break;case"group":this.grid.set_single_field_grouping(item.field,item.method,item.direction);break;case"ungroup":this.grid.ungroup();break;case"open_close_all_groups":this.grid.open_close_all_groups(item.state);break;case"tall_header":this.grid.set_tall_header(!item.checked);break;case"rename_column":this.show_rename_column_dialog(item.field);break;case"color_header":this.show_header_color_dialog(item.field);break;case"create_update_dc":this.create_update_dc(item.config);break;case"detail_link":this.grid.set_detail_link(item.field,!item.checked);break;case"summary":var s={column:item.summary_field,type:item.summary_type,value:item.summary_value};this.grid.set_summary(item.field,s);break;case"wrap_text":this.grid.set_wrapped(item.field,!item.checked);break;case"display_summaries":this.grid.toggle_summaries_visible()
break;}},on_column_management_menu_selected:function(menu,item){switch(item.value){case"manage_columns":this.show_manage_columns_dialog(item.field);break;case"create_update_dc":if(menu.column_index)item.config.column_index=menu.column_index;this.create_update_dc(item.config);break;default:this.grid.toggle_column(item.value,menu.column_index);break;}},on_rename_column_submit:function(field,new_name){if(new_name.match(/^\s*$/)){new_name=SG.schema.get_field(this.grid.entity_type,field).display_name;}
this.grid.set_column_display_name(field,new_name);},on_advanced_sorting_submit:function(new_sorting){this.grid.set_sorts(new_sorting);},on_header_color_submit:function(field,color){this.grid.set_column_header_color(field,color);},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.on_window_resize,this);}});SG.GridBody=function(config){Ext.apply(this,config);SG.GridBody.superclass.constructor.call(this);};Ext.extend(SG.GridBody,SG.Component,{templates:{group:'<div class="group {selected} selectable {summaries_visible} {state} {synthetic}" '+'group_idx="{group_idx}">'+'<div class="row_selector seltarget selectable {synthetic}" group_idx="{group_idx}">&nbsp;</div>'+'<div class="group_header notseltarget" depth="{depth}" count="{count}" style="left:{left}px">'+'{group_header_table}</div><div class="group_contents">{contents}</div></div>',group_header_table:'<table class="group_header_table sg_table_math" style="width: {width_sum}px"><tr>'+'<td class="group_header_cell first" style="width: {width}px;" sg_tip="{sg_tip}">'+'<span class="group_tip_content">'+'<span class="group_tip">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="group_title">{display_name}</span>&nbsp;'+'<span class="group_count">({count})</span></span></td>'+'{cells}</tr></table>',group_cell:'<td class="group_header_cell" style="width: {width}px">'+'<div class="content {extra_cls}">{content}</div></td>',group_summary_cell:'<td class="group_header_cell group_summary_cell sg_cell" '+'style="width: {width}px" field="{field}" group_idx="{group_idx}">'+'<div class="content {extra_cls}">{content}</div></td>',row:'<div class="row {even_odd} {selected} selectable seltarget" record_id="{record_id}" '+'group_idx="{group_idx}"><div class="row_selector">&nbsp;</div>'+'<div class="row_entity_icon" style="left:{icon_left}px; background-color: {icon_background_color};">'+'<div class="sg_entity_icon_span {icon_class}"></div></div>'+'<div class="row_wrapper" style="left:{row_left}px;">'+'<table class="row_table sg_table_math" style="width: {width_sum}px">'+'<tr>{cells}</tr></table></div></div>',cell:'<td class="{cell_classes} {shaded}" style="{cell_styles} width: {width}px; {whitespace}"'+' {cell_attributes}>{cell_content}</td>'},init_component:function(){this.data_set=this.grid.data_set;this.summary_set=this.grid.summary_set;this.add_event(this.summary_set,'load',this.on_summary_load);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'dblclick',this.on_dblclick);},render:function(){var rec,group,i;var html='';if(this.data_set.is_loaded()&&this.data_set.count()===0){this.grid.render_empty_message(this.grid.entity_type,this.container);return;}
if(this.data_set.is_grouped()){this.grouping=this.grid.get_grouping();SG.GridBody.__row_count__=0;html+=this.recursively_render_groups(this.data_set.groups,0);}else{for(i=0;i<this.data_set.count();i++){rec=this.data_set.get_record(i);html+=this.render_row({record:rec,entity_idx:i,depth:-1});}}
this.container.update(html);},render_row:function(config){var cell_html=this.render_cells(config);var width_sum=this.grid.get_column_width_sum();var rec_id=config.record.get_id();var row_rule_styles=this.grid.get_cell_manager().evaluate_row_rule_styles(config.record);var group_idx=(config.group_idx===undefined)?-1:config.group_idx;var row_params={cells:cell_html,record_id:rec_id,width_sum:width_sum,even_odd:(config.entity_idx%2===0)?"row_even":"row_odd",group_idx:group_idx,row_left:35+((config.depth+1)*16),icon_left:17+((config.depth+1)*16),icon_class:this.get_row_entity_class(config.record),icon_background_color:row_rule_styles['background-color']};if(this.grid.in_selection_cache(group_idx,rec_id)){row_params.selected='selected';}
return this.templates.row.apply(row_params);},render_cells:function(config){var cm=this.grid.get_cell_manager();var cols=this.grid.get_columns(true);var html='';var col,cell,cell_params,width;for(var i=0;i<cols.length;i++){col=cols[i];if(this.grid.is_pivot_column(col)){var pivot_widget=this.grid.get_child(col);html+=pivot_widget.render_pivot_grid(config.record.get_id());}else{cell=cm.get_cell(col,this.grid.get_cell_config(col));cell_params=cell.render(config.record,config.group_idx);width=this.grid.get_column_width(col);cell_params.width=width;if(this.grid.is_wrapped(col))
cell_params.whitespace='white-space: pre-wrap; word-wrap: break-word';html+=this.templates.cell.apply(cell_params);}}
return html;},recursively_render_groups:function(groups,depth){var html='';for(var i=0;i<groups.length;i++){var group=groups[i];if(group.synthetic){var row_count=SG.GridBody.__row_count__;var content_html=this.recursively_render_groups(group.groups,depth+1);var entity_count=SG.GridBody.__row_count__-row_count;var selected=this.grid.in_selection_cache(group.idx)?'selected':'';var state=this.grid.get_group_state(group);html+=this.templates.group.apply({group_idx:group.idx,selected:selected,summaries_visible:this.grid.summaries_visible()?'summaries_visible':'',group_header_table:this.render_synthetic_group_header_table(group,entity_count,depth),depth:depth,count:entity_count,left:17+(depth*16),contents:content_html,synthetic:'synthetic',state:state});}
else
html+=this.render_group(group,depth);}
return html;},render_group:function(group,depth){var config={group_idx:group.idx};config.summaries_visible=this.grid.summaries_visible()?'summaries_visible':'';config.state=this.grid.get_group_state(group);config.group_header_table=this.render_group_header_table(group,depth);if(config.state=="open")
config.contents=this.render_group_rows(group,depth);SG.GridBody.__row_count__+=group.ids.length;if(this.grid.in_selection_cache(group.idx))config.selected='selected';config.synthetic='';config.depth=depth;config.left=17+(depth*16);return this.templates.group.apply(config);},render_group_header_table:function(group,depth){var cols=this.grid.get_columns();var count=String(group.ids.length);var sum;if(group.idx===0){sum=this.summary_set.get('first_group_count','id');}else if(group.idx===this.data_set.group_count()-1){sum=this.summary_set.get('last_group_count','id');}
if(sum&&sum>0&&count!=sum)count=count+" of "+sum;var extra_width=this.grid.get_entity_icon_offset();extra_width+=16;var grouping=this.grid.get_grouping();var schema_field=SG.schema.get_field(this.grid.entity_type,grouping[depth].column);var field_display_name=this.grid.get_column_display_name(grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,grouping,schema_field,field_display_name)
if(typeof display_name==='string')
display_name=display_name.replace('"','&#34;','g');var params={display_name:display_name,count:count,width_sum:this.grid.get_column_width_sum()+extra_width,width:this.grid.get_column_width(cols[0])+extra_width,cells:this.render_group_summaries(group.idx),sg_tip:this.grid.render_group_header_tooltip(group,depth,this.grid.get('column_display_names'))};return this.templates.group_header_table.apply(params);},render_group_summaries:function(group_idx){var params,html='';var cols=this.grid.get_columns(true);var cm=this.grid.get_cell_manager();var val,col,cell,sum,content;var sum_render;var sum_vis=this.grid.summaries_visible();for(var i=1;i<cols.length;i++){col=cols[i];if(this.grid.is_pivot_column(col)){var column_widget=this.grid.get_child(col);html+=column_widget.render_group_summaries(group_idx);continue;}
if(sum_vis&&this.grid.is_summary_field(col)){cell=cm.get_cell(col,this.grid.get_cell_config(col));var summary=cell.render_group_summary(group_idx);html+=this.templates.group_summary_cell.apply({width:this.grid.get_column_width(col),field:col,group_idx:group_idx,extra_cls:summary.summary_classes,content:summary.summary_content});continue;}
sum_render={summary_content:"&nbsp",summary_classes:''};if(sum_vis){cell=cm.get_cell(col,this.grid.get_cell_config(col));sum=this.grid.get_summary(col);val=this.summary_set.get('group_'+group_idx,col);if(val!==null)
sum_render=cell.render_summary(sum.type,val,sum.value);}
params={width:this.grid.get_column_width(cols[i]),content:sum_render.summary_content,extra_cls:sum_render.summary_classes};html+=this.templates.group_cell.apply(params);}
return html;},render_synthetic_group_header_table:function(group,count,depth){var parts=group.idx.split('_');var low_idx=Number(parts[0]);var high_idx=Number(parts[1]);var sum;if(low_idx===0)
sum=this.summary_set.get('first_group_count_'+group.idx,'id');else if(high_idx===this.data_set.group_count()-1)
sum=this.summary_set.get('last_group_count_'+group.idx,'id');if(sum&&count!=sum){if(Number(count)>sum){sum=count;}
count=count+" of "+sum;}
var grouping=this.grid.get_grouping();var cols=this.grid.get_columns();var extra_width=this.grid.get_entity_icon_offset();extra_width+=(grouping.length-depth)*16;var schema_field=SG.schema.get_field(this.grid.entity_type,grouping[depth].column);var col_display_name=this.grid.get_column_display_name(grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,grouping,schema_field,col_display_name)
if(typeof display_name==='string')
display_name=display_name.replace('"','&#34;','g');var params={display_name:display_name,count:count,width_sum:this.grid.get_column_width_sum()+extra_width,width:this.grid.get_column_width(cols[0])+extra_width,cells:this.render_synthetic_group_summaries(group,count,depth),sg_tip:this.grid.render_group_header_tooltip(group,depth,this.grid.get('column_display_names'))};return this.templates.group_header_table.apply(params);},render_synthetic_group_summaries:function(group,count,depth){var params,html='';var cols=this.grid.get_columns(true);var cm=this.grid.get_cell_manager();var val,col,cell,sum,content;var sum_render;var sum_vis=this.grid.summaries_visible();for(var i=1;i<cols.length;i++){col=cols[i];if(this.grid.is_pivot_column(col)){var column_widget=this.grid.get_child(col);html+=column_widget.render_synthetic_group_summaries(group);continue;}
if(this.grid.is_summary_field(col)){cell=cm.get_cell(col,this.grid.get_cell_config(col));var summary=cell.render_group_summary(group.idx);html+=this.templates.group_summary_cell.apply({width:this.grid.get_column_width(col),field:col,group_idx:group.idx,extra_cls:summary.summary_classes,content:summary.summary_content});continue;}
sum_render={summary_content:"&nbsp",summary_classes:''};if(sum_vis){cell=cm.get_cell(col,this.grid.get_cell_config(col));sum=this.grid.get_summary(col);val=this.summary_set.get('synthetic_'+group.idx,col);if(val!==null)
sum_render=cell.render_summary(sum.type,val,sum.value);}
params={width:this.grid.get_column_width(cols[i]),content:sum_render.summary_content,extra_cls:sum_render.summary_classes};html+=this.templates.group_cell.apply(params);}
return html;},render_group_rows:function(group,depth){var html='';var rec,i;for(i=0;i<group.ids.length;i++){rec=this.data_set.get_record_by_id(group.ids[i]);html+=this.render_row({record:rec,entity_idx:i,group_idx:group.idx,depth:depth});}
return html;},update_group_header_table:function(group_idx){var group=this.data_set.get_group(group_idx);var sel='div.group[group_idx="'+group_idx+'"] div.group_header';var header_elem=sg_find(sel,this.container.dom);if(!header_elem)return;var depth=Number(header_elem.getAttribute('depth'));Ext.fly(header_elem).update(this.render_group_header_table(group,depth));},update_synthetic_group_header_table:function(group_idx){var group=this.data_set.get_synthetic_group(group_idx);var sel='div.group[group_idx="'+group_idx+'"] div.group_header';var header_elem=sg_find(sel,this.container.dom);if(!header_elem)return;var depth=Number(header_elem.getAttribute('depth'));var count=Number(header_elem.getAttribute('count'));Ext.fly(header_elem).update(this.render_synthetic_group_header_table(group,count,depth));},on_summary_load:function(keys){var match;var regex_real_group=/group_(\d+)/;var regex_synth_group=/synthetic_(\d+)_(\d+)_(\d+)/;var regex_first_synth=/first_group_count_(\d+)_(\d+)_(\d+)/;var regex_last_synth=/last_group_count_(\d+)_(\d+)_(\d+)/;var key,i;var updates={};var synthetic_group_updates={};for(i=0;i<keys.length;i++){key=keys[i];if(key==='first_group_count')
updates[0]=true;else if(key==='last_group_count')
updates[this.data_set.group_count()-1]=true;else{match=key.match(regex_real_group);if(match){updates[parseInt(match[1],10)]=true;}else{match=key.match(regex_synth_group)||key.match(regex_first_synth)||key.match(regex_last_synth);if(match)
synthetic_group_updates[match[1]+'_'+match[2]+'_'+match[3]]=true;}}}
for(i in updates){if(updates.hasOwnProperty(i))
this.update_group_header_table(parseInt(i,10));}
for(i in synthetic_group_updates){if(synthetic_group_updates.hasOwnProperty(i))
this.update_synthetic_group_header_table(i);}},on_click:function(e){var target=Ext.get(e.getTarget());var group_tip=target.findParent('span.group_tip_content',this.container,true);if(group_tip){var group=group_tip.findParent('div.group',this.container,true);if(group){this.on_click_group(group,target,e);}
return;}
var dep_violation_icon=target.findParent('div.icon_Task_violation',this.container,true);if(!dep_violation_icon)
dep_violation_icon=target.findParent('div.violation_editor_button_selected',this.container,true);if(dep_violation_icon){if(this.dependency_violation_dialog)this.dependency_violation_dialog.destroy();var row_elem=target.findParent('div.row.selectable',this.container);var record_id=Number(row_elem.getAttribute('record_id'));this.dependency_violation_dialog=new SG.DependencyViolationDialog({data_set:this.data_set,record:this.data_set.get_record_by_id(record_id),grid_widget:this.grid,click_xy:e.xy,launch_button_elem:dep_violation_icon});}},on_dblclick:function(e){var target=Ext.get(e.getTarget());var cell_td=target.findParent('td.sg_cell');if(cell_td)return;var pivot_td=target.findParent('td.pivot_grid');if(pivot_td){var row_div=target.findParent('div.row.selectable');var record_id=Number(row_div.getAttribute('record_id'));var field=pivot_td.getAttribute('field');this.grid.create_new_linked_task([record_id],field);}},open_group:function(group_elem){var group_idx=group_elem.dom.getAttribute('group_idx');var group;if(group_elem.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.grid.get_group_state(group);if(old_state=='open')
return;group_elem.replaceClass('closed','open');var group_contents=group_elem.child('div.group_contents');if(group_contents.dom.firstChild===null&&!group_elem.hasClass('synthetic')){var grouping=this.grid.get_grouping();group_contents.update(this.render_group_rows(group,grouping.length-1));}
this.grid.set_group_state(group,'open');},close_group:function(group_elem){var group_idx=group_elem.dom.getAttribute('group_idx');var group;if(group_elem.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.grid.get_group_state(group);if(old_state=='closed')
return;group_elem.replaceClass('open','closed');this.grid.set_group_state(group,'closed');},on_click_group:function(group_elem,target,e){var group_header=target.findParent('div.group_header',group_elem,true);if(!group_header)return;var group_idx=group_elem.dom.getAttribute('group_idx');var group=this.data_set.get_group(group_idx);var dom_event=e.browserEvent;if(group_elem.hasClass('open')){if(dom_event.altKey)
this.grid.toggle_all_groups('closed');else
this.close_group(group_elem);}else{if(dom_event.altKey)
this.grid.toggle_all_groups('open');else
this.open_group(group_elem);}
this.grid.fireEvent('groups_toggled');},get_row_entity_class:function(record){var status;if(SG.schema.get_field(record.type,'read_by_current_user')){status=record.get('read_by_current_user');return'icon_'+this.grid.entity_type+'_'+status.toLowerCase();}else if(record.type==='HumanUser'){status=record.get('sg_status_list');return(status==='dis')?'icon_HumanUserDisabled':'icon_HumanUser';}else if(record.type=='Attachment'){return record.get("this_file").icon_class;}
else if(record.type=='Status')
return'';else if(record.type=='Task'&&record.get('dependency_violation'))
return'icon_Task_violation';else if(record.type=='Page'&&record.get('entity_type')){return SG.schema.entity_icon_name(record.get('entity_type'));}else{return SG.schema.entity_icon_name(this.grid.entity_type);}}});SG.NewGridHeadingDragZone=function(config)
{Ext.apply(this,config);this.header=this.grid.header_container;this.arrow=Ext.DomHelper.append(document.body,{tag:"div",cls:"col-move-top",html:"&#160;"},true);SG.NewGridHeadingDragZone.superclass.constructor.call(this,this.header,"headings",{dragElId:"sg_grid_heading_proxy",resizeFrame:false,scroll:false});this.setHandleElId(this.header);};Ext.extend(SG.NewGridHeadingDragZone,Ext.dd.DDProxy,{handleMouseDown:function(e){if(e.ctrlKey)return;if(SG.GridEditor.showing_editor)
{var blur_func=function(){SG.globals.active_editor.blur();};window.setTimeout(blur_func,0);}
var target=Ext.get(e.getTarget());var heading=target.findParent('td.heading',this.header,true);if(!heading)return;var splitter=target.findParent('div.resize_splitter');if(splitter)return;this.heading=heading;this.is_pivot_heading=false;this.widget=this.grid;var field=heading.dom.getAttribute('field');if(this.grid.is_pivot_column(field))
{var pivot_heading=target.findParent('td.pivot_heading',this.header,true);if(pivot_heading)
{this.is_pivot_heading=true;this.pivot_headings=target.findParent('table.pivot_headers',this.header,true);this.heading=pivot_heading;this.widget=this.grid.get_child(field);}}
Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y){var field=this.heading.dom.getAttribute('field');var display_name=this.widget.get_column_display_name(field);if(this.widget.is_pivot_column&&this.widget.is_pivot_column(field))
{if(this.widget.get_child(field).get('open'))
display_name='<center>'+display_name+'<center>';}
this.start_index=this.widget.get_column_index(field);this.cache_regions();var drag_el=Ext.get(this.getDragEl());this.resetConstraints();var y=this.is_pivot_heading?16:0;this.setYConstraint(y,y);this.arrow_y=this.heading.getTop()-10;drag_el.setWidth(this.heading.getWidth());drag_el.update(display_name);Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e){var drop_index=this.find_valid_drop_index(e);if(drop_index!==false){var region=this.find_col_by_idx(drop_index);if(this.start_index<drop_index){this.arrow.setLeftTop(region.right-5,this.arrow_y);}else{this.arrow.setLeftTop(region.left-5,this.arrow_y);}
this.arrow.show();}else{this.arrow.setLeftTop(-100,-100);this.arrow.hide();}},endDrag:function(e){var drop_index=this.find_valid_drop_index(e);if(drop_index!==false){this.widget.move_column(this.start_index,drop_index);}
this.arrow.setLeftTop(-100,-100);this.arrow.hide();},cache_regions:function(){this.region_cache={};var headings;if(this.is_pivot_heading)
headings=this.pivot_headings.query('td.pivot_heading');else
headings=this.header.query('td.heading');var el,column_name,region,idx;for(var i=0;i<headings.length;i++){el=Ext.get(headings[i]);column_name=el.dom.getAttribute("field");region=el.getRegion();this.region_cache[column_name]={idx:i,left:region.left,right:region.right};}},find_col_by_position:function(x){var col_entry;for(var col in this.region_cache){if(!this.region_cache.hasOwnProperty(col))continue;col_entry=this.region_cache[col];if(x>col_entry.left&&x<=col_entry.right){return col_entry;}}
return false;},find_col_by_idx:function(idx){var col_entry;for(var col in this.region_cache){if(!this.region_cache.hasOwnProperty(col))continue;col_entry=this.region_cache[col];if(col_entry.idx===idx){return col_entry;}}
return false;},find_valid_drop_index:function(e){var x=e.getPageX();var col=this.find_col_by_position(x);if(col){var end_index=col.idx;if(x-col.left>=(col.right-col.left)/2){end_index++;}
if(this.start_index<end_index){end_index--;}
if(this.start_index!=end_index){return end_index;}}
return false;},autoOffset:function(){this.setDelta(0,0);}});SG.NewGridSplitterDragZone=function(config)
{Ext.apply(this,config);this.header=this.grid.header_container;this.proxy=this.grid.resize_proxy;SG.NewGridSplitterDragZone.superclass.constructor.call(this,this.header,"splitters",{dragElId:this.proxy,resizeFrame:false,scroll:false});this.setHandleElId(this.header);};Ext.extend(SG.NewGridSplitterDragZone,Ext.dd.DDProxy,{min_column_width:7,handleMouseDown:function(e){if(e.ctrlKey)return;var t=Ext.get(e.getTarget());if(t.hasClass("resize_splitter")){this.pivot_grid_spliiter=t.hasClass('pivot_grid_spliter');if(this.pivot_grid_spliiter){var grid_header_td=t.findParent('td.heading',this.header,true);this.col_name=t.dom.getAttribute('field');this.col_cell=grid_header_td.child('td.pivot_heading[field='+this.col_name+']');this.col_width=this.col_cell.getWidth();this.first_col=t.hasClass('first_splitter');this.header_table=grid_header_td.child('table.pivot_headers');this.header_width=this.header_table.getWidth();this.pivot_grid_name=grid_header_td.dom.getAttribute('field');}
else
{this.col_name=t.dom.getAttribute('field');this.col_cell=this.header.child('td.heading[field='+this.col_name+']');this.col_width=this.col_cell.getWidth();this.first_col=t.hasClass('first_splitter');this.header_table=this.header.child('table.header_table');this.header_width=this.header_table.getWidth();}
Ext.dd.DDProxy.prototype.handleMouseDown.apply(this,arguments);}},b4StartDrag:function(x,y){this.proxy.setHeight(this.container.getHeight());this.resetConstraints();this.setYConstraint(0,0);this.startPos=x;Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e){var endX=Ext.lib.Event.getPageX(e);var diff=endX-this.startPos;if(this.col_width+diff<this.min_column_width)
diff=this.grid.get_entity_icon_offset()-this.col_width;this.col_cell.setWidth(this.col_width+diff);this.header_table.setWidth(this.header_width+diff);},endDrag:function(e){var endX=Ext.lib.Event.getPageX(e);var diff=endX-this.startPos;var new_width=this.col_width+diff;if(this.first_col)
{new_width-=this.grid.get_entity_icon_offset();var grouping=this.grid.get_grouping();if(grouping)
new_width-=grouping.length*16;}
if(new_width<this.min_column_width)
new_width=this.min_column_width;if(this.pivot_grid_spliiter)
{var child_widget=this.grid.get_child(this.pivot_grid_name);child_widget.resize_column(this.col_name,new_width);}
else
this.grid.resize_column(this.col_name,new_width);},autoOffset:function(){this.setDelta(0,0);}});SG.Widget.PivotGrid=function(context,widget_spec,id)
{SG.Widget.PivotGrid.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.PivotGrid,SG.Widget.Base,{default_settings:{columns:['sg_status_list','content','task_assignees','start_date','due_date','duration'],column_widths:{sg_status_list:50,content:110,task_assignees:115,start_date:80,due_date:80,duration:70},open:false,column_display_names:{},detail_link_columns:[],summaries:{},wrapped_columns:{},column_header_colors:{},mode:'detail',sorts:[]},templates:{grid_header:'<td class="heading" style="width: {width}px" field="{name}">'+'<div class="content pivot_column {extra_class}">'+'<div class="pivot_headers sg_color" {color} field="{name}"><center>{display_name}</center></div>'+'<div class="pivot_headers minor_header">{header_table}</div>'+'<div class="header_collapse {state}" sg_tip="{sg_tip}" top_tip="true"></div>'+'{splitters}</div></td>',minor_header_cell:'<td class="pivot_heading {extra_cls}" style="width: {width}px" field="{name}"><div class="pivot_content">'+'{display_name}</div></td>',header_sorting_arrow:'<img class="sort_arrow" src="{src}">',minor_header:'<table class="pivot_headers minor_header sg_table_math" style="width: {width}px;"><tr>'+'<td class="pivot_bar" {color} field="{name}"></td>{cells}'+'<td class="pivot_bar" {color} field="{name}"></td>'+'</tr></table>',cell:'<td class="{cell_classes} {shaded}" style="{cell_styles} width: {width}px; {whitespace}"'+' {cell_attributes}>{cell_content}</td>',grid:'<td class="pivot_bar" {color} field="{field}"></td>'+'<td style="width:{total_width}px;" class="pivot_grid" field="{field}" '+'record_id="{record_id}">{grid_content}</td>'+'<td class="pivot_bar right" {color} field="{field}"></td>',grid_content:'<div class="pivot_column {extra_class}">'+'<table class="row_table sg_table_math" style="width:{width}px;">{grid_rows}</table></div>',row:'<tr class="pivot_row {row_line}" record_id="{record_id}">{cells}</tr>',waiting_for_data:'<tr><td class="pivot_grid_no_data"></td></tr>',splitter:'<div class="resize_splitter pivot_grid_spliter" field="{name}" pivot_grid="{pivot_grid}" '+'style="left:{left}px;">&nbsp;</div>',summary:'<td class="summary" style="width: {width}px" field="{name}">'+'<div class="content {extra_cls}">{value}</div></td>',summary_table:'<td class="pivot_bar" {color} field="{name}"></td>'+'<td class="summary" style="width: {width}px" field="{name}">{summary_table_content}'+'<td class="pivot_bar right" {color} field="{name}"></td>',summary_table_content:'<table class="summary_table sg_table_math" style="width: {width}px">{summaries}</table></td>',group_summary_table:'<td class="pivot_bar" {color} field="{name}"></td>'+'<td class="group_header_cell pivot_group_summary" field="{name}" group_idx="{group_idx}" '+'style="width: {width}px">{group_summary_table_content}'+'</td><td class="pivot_bar right" {color} field="{name}"></td>',group_summary_table_content:'<table class="summary_table sg_table_math" style="width: {width}px">{summaries}</table>',group_summary_cell:'<td class="group_header_cell" style="width: {width}px">'+'<div class="content {extra_cls}">{content}</div></td>',color:'style="background-color: rgb({rgb});color:{text_color};"',},on_first_render:function()
{this.entity_type=this.get('entity_type');this.pivot_field=this.get('pivot_field');this.data_set=this.new_data_set(this.entity_type,this.on_data_load,this.on_data_change);this.summary_set=new SG.Data.SummarySet(this.entity_type);this.add_event(this.summary_set,'load',this.on_summary_load);this.id_map={};this.grid=this.parent;this.grid_data_set=this.context.get('grid_data_set');this.add_event(this.grid_data_set,'load',this.on_grid_data_set_load);this.add_event(this.grid.header_container,'click',this.on_header_click);this.add_event(this.grid.header_container,'dblclick',this.on_header_dblclick);if(this.grid_data_set.is_loaded()&&this.grid.data_set.count()>0)
this.request_data();},grid_reloaded:function()
{var cm=this.get_cell_manager();cm.empty_cell_cache();var scm=this.get_summary_cell_manager();scm.empty_cell_cache();this.clear_dom_cell_cache();},render_widget:function()
{},on_grid_data_set_load:function()
{this.clear_dom_cell_cache();if(this.grid.data_set.count()==0)
return;this.request_data();if(this.grid.summaries_visible())
this.request_summaries();},on_header_dblclick:function(e)
{var t=Ext.get(e.getTarget());var header=t.findParent('td.heading[field="'+this.__name_in_parent__+'"]');if(!header)
return;var dom_event=e.browserEvent;if(dom_event.altKey)
this.grid.expand_all_task_pivot_columns(null,{expand:!this.get('open')});else
{if(this.get('open'))
this.collapse_column();else
this.expand_column();}},on_header_click:function(e)
{var t=Ext.get(e.getTarget());var header=t.findParent('td.heading[field="'+this.__name_in_parent__+'"]');if(!header)
return;if(t.hasClass("header_collapse"))
{var dom_event=e.browserEvent;if(dom_event.altKey)
this.grid.expand_all_task_pivot_columns(null,{expand:!this.get('open')});else
{if(this.get('open'))
this.collapse_column();else
this.expand_column();return;}}},expand_column:function()
{this.set_width_related_setting_and_rerender('open',true);},collapse_column:function()
{this.set_width_related_setting_and_rerender('open',false);},set_width_related_setting_and_rerender:function(setting_name,setting_value,render_blank)
{var before_width=this.get_column_width_sum(true);this.set_silent(setting_name,setting_value);var after_width=this.get_column_width_sum(true);this.grid.render_header();var delta=after_width-before_width;var blank=render_blank;var me=this;setTimeout(function(){me.adjust_grid_row_tables_and_rerender(delta,blank);},0);this.set(setting_name,setting_value);},adjust_grid_row_tables_and_rerender:function(delta,blank)
{var container=this.grid.get_container();var me=this;var tds=sg_find_all('td.pivot_grid[field="'+this.__name_in_parent__+'"]',container.dom);setTimeout(function(){me.batch_adjust_row_table_tds(tds,delta,blank);},0);var group_idx_done={};var group_tds=sg_find_all('td.pivot_group_summary[field="'+this.__name_in_parent__+'"]',container.dom);setTimeout(function(){me.batch_adjust_group_summary_table_tds(group_idx_done,group_tds,0,delta,blank);},0);},batch_adjust_row_table_tds:function(tds,delta,blank)
{if(tds.length==0)return;var me=this;var td=Ext.get(tds[0]);var table=td.findParent('table.row_table',20,true);var current_td_width,current_table_width;if(!table.isVisible(true)){current_td_width=Number(td.dom.style.width.replace('px',''));current_table_width=Number(table.dom.style.width.replace('px',''));}else{current_td_width=td.getWidth();current_table_width=table.getWidth();}
var td_func=function(td_dom){var func=function(){var td=Ext.get(td_dom);td.update('');td.dom.style.width='';var table=td.findParent('table.row_table',20,true);table.dom.style.width=(current_table_width+delta)+'px';td.dom.style.width=(current_td_width+delta)+'px';if(!blank)
{var record_id=Number(td.dom.getAttribute('record_id'));td.update(me.render_pivot_grid_content(record_id));}}
SG.TimeoutQueue.add(func);};for(var i=0;i<tds.length;i++){td_func(tds[i]);}},batch_adjust_group_summary_table_tds:function(group_idx_done,group_tds,start_index,delta,blank)
{var batch_amount=5;var end_index=(start_index+batch_amount)>=group_tds.length?group_tds.length:(start_index+batch_amount);for(var i=start_index;i<end_index;i++)
{var group_td=Ext.get(group_tds[i]);var group_idx=group_td.dom.getAttribute('group_idx');if(!group_idx_done[group_idx])
{this.adjust_grid_row_table_width(group_td,'table.group_header_table',delta);group_idx_done[group_idx]=true;if(this.grid.summaries_visible()&&!blank)
{if(group_idx.indexOf('_')==-1)
{var content=this.render_group_summary_content(group_idx,false);group_td.update(content.html);}
else
{var content=this.render_group_summary_content(group_idx,true);group_td.update(content.html);}}}}
var me=this;setTimeout(function(){me.batch_adjust_group_summary_table_tds(group_idx_done,group_tds,end_index,delta,blank);},0);},adjust_grid_row_table_width:function(td_elem,table_selector,delta)
{td_elem.update('');var td_width=td_elem.getWidth();td_elem.dom.style.width='';var table=td_elem.findParent(table_selector,20,true);table.setWidth(table.getWidth()+delta);td_elem.setWidth(td_width+delta+1);},get_cell_manager:function()
{if(!this.cell_manager)
{this.grid=this.get_parent();var cell_config={container:this.grid.container,data_set:this.data_set,projects:this.context_projects(),get_fields_callback:{fn:this.get_columns,scope:this},step_column:this.get('display_column'),apply_row_rules:true};this.cell_manager=this.new_component(SG.CellManager,cell_config);}
return this.cell_manager;},get_summary_cell_manager:function()
{if(!this.summary_cell_manager)
{this.grid=this.get_parent();var cell_config={container:this.grid.container,data_set:this.grid.data_set,projects:this.context_projects(),get_fields_callback:{fn:this.get_summary_columns,scope:this},step_column:this.get('display_column'),summary_setting_callback:{fn:this.get_summary,scope:this}};this.summary_cell_manager=this.new_component(SG.CellManager,cell_config);}
return this.summary_cell_manager;},render_header:function(first_column)
{var extra_width=0;var extra_class='';if(first_column)
{var grouping=this.grid.get_grouping();if(grouping)
extra_width+=grouping.length*16;extra_width+=this.grid.get_entity_icon_offset();extra_class='first_column';}
var state=this.get('open');var sg_tip;if(state)
sg_tip='Click to collapse (Option or Alt + Click to collapse all)';else
sg_tip='Click to expand (Option or Alt + Click to expand all)';return this.templates.grid_header.apply({width:this.get_column_width_sum()+extra_width,name:this.__name_in_parent__,display_name:this.get_pivot_grid_column_name(),header_table:this.render_header_columns(),color:this.get_color_style(),state:state?'pivot_header_close':'pivot_header_open',sg_tip:sg_tip,splitters:this.render_header_spliiters(),extra_class:extra_class});},get_pivot_grid_column_name:function()
{var dc=this.get('display_column');if(this.get('open'))
{var schema_field=SG.schema.get_field(this.grid.entity_type,dc);return schema_field.display_name;}
else
{var step=SG.schema.get_step_entity(this.grid.entity_type,dc);return step.short_name;}},get_color_style:function()
{var color=this.get_color();var parts=color.split(',');var text_color='black';if(parts.length==3)
{var bw=(Number(parts[0])+Number(parts[1])+Number(parts[2]))/3.0;if(bw<127)
text_color='white';}
return this.templates.color.apply({rgb:color,text_color:text_color});},get_color:function()
{var step=SG.schema.get_step_entity(this.grid.entity_type,this.get('display_column'));return step.color;},render_header_summary_content:function(first_column)
{var extra_width=0;if(first_column)
{var grouping=this.grid.get_grouping();if(grouping)
extra_width+=grouping.length*16;extra_width+=this.grid.get_entity_icon_offset();}
var summaries='';var cols=this.get_columns();for(var i=0;i<cols.length;i++)
summaries+=this.render_summary(cols[i],first_column,i==0);var width=this.get_column_width_sum(true)+extra_width;return{width:width,html:this.templates.summary_table_content.apply({width:width,summaries:summaries})};},render_header_summary:function(first_column)
{var content_hash=this.render_header_summary_content(first_column);return this.templates.summary_table.apply({color:this.get_color_style(),name:this.__name_in_parent__,summary_table_content:content_hash.html,width:content_hash.width});},render_summary:function(col,first_column_in_grid,first_column_in_pivot_grid){var val=this.summary_set.get('page',col);var render_sum={summary_content:'',summary_classes:''};var extra_width=0;if(first_column_in_grid)
{var grouping=this.grid.get_grouping();if(grouping)
extra_width+=grouping.length*16;extra_width+=this.grid.get_entity_icon_offset();}
if(first_column_in_pivot_grid)extra_width--;if(val===null){render_sum.summary_content="&nbsp;";}else{var cm=this.get_cell_manager();var cell=cm.get_cell(col,this.grid.get_cell_config(col));var sum=this.get_summary(col);if(sum.type=='record_count')
val=this.get_record_count();render_sum=cell.render_summary(sum.type,val,sum.value);}
var params={name:col,width:this.get_column_width(col)+extra_width,value:render_sum.summary_content,extra_cls:render_sum.summary_classes};return this.templates.summary.apply(params);},render_header_spliiters:function()
{var html='';var cols=this.get_columns();var left=0;for(var i=0;i<cols.length-1;i++)
{var col=cols[i];var w=this.get_column_width(col);if(i==0)w--;left+=w;html+=this.templates.splitter.apply({name:col,pivot_grid:this.__name_in_parent__,left:left});}
return html;},render_header_columns:function()
{var cells='';var cols=this.get_columns();var sorts=this.get_sorts();var width_sum=0;for(var i=0;i<cols.length;i++)
{var col=cols[i];var width=this.get_column_width(col);width_sum+=width;if(i==0)width--;var display_name=this.get_column_display_name(col);var schema_field=SG.schema.get_field(this.entity_type,col);var extra_cls='';var color=this.get_column_header_color(col);if(color)
extra_cls+=" column_header_color"+color;if(sorts.length==1&&sorts[0].column==col)
{extra_cls+=" sorting";var src=sorts[0].direction=='asc'?'/images/column_header_sortarrow_up.png':'/images/column_header_sortarrow_down.png';display_name+=this.templates.header_sorting_arrow.apply({src:src});}
cells+=this.templates.minor_header_cell.apply({width:width,name:col,display_name:display_name,extra_cls:extra_cls});}
return this.templates.minor_header.apply({width:width_sum+10,cells:cells,color:this.get_color_style(),name:this.__name_in_parent__});},render_pivot_grid:function(record_id)
{return this.templates.grid.apply({total_width:this.get_column_width_sum(true),field:this.__name_in_parent__,grid_content:this.render_pivot_grid_content(record_id),record_id:record_id,color:this.get_color_style(),});},render_pivot_grid_content:function(record_id)
{var mode=this.get('mode');var grid_content;if(mode=='summary')
grid_content=this.render_pivot_grid_summary_content(record_id);else if(mode=='detail')
grid_content=this.render_pivot_grid_detail_content(record_id);else
{grid_content=this.render_pivot_grid_summary_content(record_id);grid_content+=this.render_pivot_grid_detail_content(record_id);}
return grid_content;},render_pivot_grid_detail_content:function(record_id)
{var grid_rows='';var extra_class='';if(this.data_set.is_loaded())
{var recs=this.id_map[record_id];if(!recs)
{return'';}
else
{for(var i=0;i<recs.length;i++)
{var r=recs[i];grid_rows+=this.templates.row.apply({cells:this.render_cells(r),row_line:i>0?'pivot_row_line':'',record_id:r.get_id()});}}}
else
grid_rows=this.templates.waiting_for_data.apply();return this.templates.grid_content.apply({width:this.get_column_width_sum(true),grid_rows:grid_rows,extra_class:extra_class});},render_pivot_grid_summary_content:function(record_id)
{var summary_row=this.templates.row.apply({cells:this.render_summary_cells(record_id),row_line:''});return this.templates.grid_content.apply({grid_rows:summary_row,extra_class:''});},get_cell_config:function(col){var config={detail_link:this.is_detail_link(col)};return config;},render_summary_cells:function(record_id)
{var cm=this.get_summary_cell_manager();var summary_cols=this.get_summary_columns();var record=this.grid.data_set.get_record_by_id(record_id);var html='';for(var i=0;i<summary_cols.length;i++){var summary_col=summary_cols[i];var parts=summary_col.split('$');var cell=cm.get_cell(summary_col);cell_params=cell.render(record,-1);var width=this.get_column_width(parts[1]);if(i==0)width--;cell_params.width=width;html+=this.templates.cell.apply(cell_params);}
return html;},render_cells:function(record)
{var cm=this.get_cell_manager();var cols=this.get_columns();var html='';for(var i=0;i<cols.length;i++){var col=cols[i];var cell=cm.get_cell(col,this.get_cell_config(col));cell_params=cell.render(record,-1);var width=this.get_column_width(col);if(i==0)width--;cell_params.width=width;if(this.is_wrapped(col))
cell_params.whitespace='white-space: pre-wrap';if(!this.get('open'))
cell_params.cell_attributes=this.swap_in_row_tooltip(cell_params,record);html+=this.templates.cell.apply(cell_params);}
return html;},get_columns:function(ignore_state)
{var cols=this.get('columns');var ret=[];var schema_field;if(cols.length>0){ret=[];for(var i=0;i<cols.length;i++){schema_field=SG.schema.get_field(this.entity_type,cols[i]);if(schema_field)
ret.push(cols[i]);}}else{if(this.entity_type=='Task')
ret=['sg_status_list','task_assignees','start_date','due_date'];else
ret=[SG.schema.get_identifier_field(this.entity_type)];}
if(!ignore_state&&!this.get('open'))
return[ret[0]];else
return ret;},get_column_width:function(col){var widths=this.get('column_widths');var w;if(widths[col])
w=widths[col];else
w=125;return w;},get_column_width_sum:function(do_not_include_color_bars)
{var cols=this.get_columns();var sum=0;for(var i=0;i<cols.length;i++){sum+=this.get_column_width(cols[i]);}
if(do_not_include_color_bars)
return sum;else
return(sum+11);},on_data_load:function()
{this.id_map={};for(var i=0;i<this.data_set.count();i++){var rec=this.data_set.get_record(i);var pivot_field_value=rec.get(this.pivot_field);if(pivot_field_value.id in this.id_map)
{var recs=this.id_map[pivot_field_value.id];recs.push(rec);}
else
this.id_map[pivot_field_value.id]=[rec];}
this.render_loaded_data();},on_data_change:function(changes)
{var change,revives=0,retires=0;var summ,refresh_summaries=false;for(var i=0;i<changes.length;i++)
{change=changes[i];if(change.type==='update'&&change.state==='server'){summ=this.get_summary(change.column);if(summ.type&&summ.type!=='none')
refresh_summaries=true;}else if(change.type=='retire'){retires++;refresh_summaries=true;}else if(change.type=='revive'){revives++;refresh_summaries=true;}}
if(refresh_summaries&&this.grid.summaries_visible())
this.request_summaries();if(revives>0||retires>0){this.render_loading();this.request_data();}},request_data:function()
{if(this.get('mode')=='summary')
return;var spec={type:this.entity_type,filters:this.get_filters(),columns:this.get_required_columns(),result:this.data_set,sorts:this.get_sorts(),use_loading_banner:true};SG.Repo.query(spec);},get_sorts:function()
{var sorts=this.get('sorts');if(sorts.length==0&&this.__name_in_parent__=='step_0')
return[{column:'step',direction:'desc'}];else
return sorts;},get_filters:function()
{var i;var grid_ids=[];for(i=0;i<this.grid_data_set.count();i++){var grid_rec=this.grid_data_set.get_record(i);var id=grid_rec.get_id();if(grid_ids.indexOf(id)==-1)
grid_ids.push(id);}
var entities=[];for(i=0;i<grid_ids.length;i++){entities.push({type:this.grid.entity_type,id:grid_ids[i]})}
var filters={logical_operator:'and',conditions:[{path:this.pivot_field,relation:'in',values:entities},this.get_clean_filters()]};return filters;},get_clean_filters:function()
{var new_conditions=[];var filters=this.get('filters');for(var i=0;i<filters.conditions.length;i++)
{var c=filters.conditions[i];if(c.path!='entity')
new_conditions.push(c);}
return{logical_operator:'and',conditions:new_conditions};},resize_column:function(col,width){var widths=sg_deep_copy(this.get('column_widths'));widths[col]=width;this.set_width_related_setting_and_rerender('column_widths',widths);},resize_column_sum:function(width)
{var cols=this.get_columns();var col_widths=[];var total=0;var i;for(i=0;i<cols.length;i++)
{var w=this.get_column_width(cols[i]);total+=w;col_widths.push(w);}
for(i=col_widths.length-1;i>=0;i--)
{var new_w=col_widths[i]+(width-total);if(new_w<7)new_w=7;total=total+(new_w-col_widths[i]);col_widths[i]=new_w;}
var widths_hash={};for(i=0;i<cols.length;i++)
widths_hash[cols[i]]=col_widths[i];this.set('column_widths',widths_hash);},request_summaries:function()
{var spec={type:this.entity_type,filters:this.get_summary_filters(),summaries:this.get_summaries(),result:this.summary_set,result_key:'page',use_loading_banner:true};SG.Repo.summarize(spec);var pivot_record_count_summary={column:SG.schema.get_identifier_field(this.entity_type),type:'record_count',value:null};spec={type:this.entity_type,filters:this.get_summary_filters(),summaries:[pivot_record_count_summary],result:this.summary_set,result_key:'pivot_record_count',use_loading_banner:true};SG.Repo.summarize(spec);if(this.grid.data_set.is_grouped())
this.request_group_summaries();},get_summary_filters:function()
{var grid_filters=sg_deep_copy(this.grid.get_filters());grid_filters=sg_pivot_condition_hash(this.grid.entity_type,this.pivot_field,grid_filters);var filters={logical_operator:'and',conditions:[grid_filters,this.get_clean_filters()]};return filters;},request_group_summaries:function()
{var group_count=this.grid.data_set.group_count();if(group_count===0)return;var group,group_filters,spec,i;var grouping=this.grid.get_grouping();var page_filters=this.get_summary_filters();for(i=0;i<group_count;i++){group=this.grid.data_set.get_group(i);group_filters=SG.schema.filters_for_grouping(this.grid.entity_type,grouping,group.template_values);var conditions=[];var grp_conditions=group_filters.conditions;for(var j=0;j<grp_conditions.length;j++)
{var cond=grp_conditions[j];cond.path=this.pivot_field+'.'+this.grid.entity_type+'.'+cond.path;conditions.push(cond);}
group_filters.conditions=conditions;spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:this.get_summaries(),result:this.summary_set,result_key:'group_'+i,use_loading_banner:true};SG.Repo.summarize(spec);}
var synth_grping;for(i in this.grid.data_set.synthetic_group_map)
{if(!this.grid.data_set.synthetic_group_map.hasOwnProperty(i))
continue;group=this.grid.data_set.synthetic_group_map[i];synth_grping=grouping.slice(0,group.depth+1);group_filters=SG.schema.filters_for_grouping(this.grid.entity_type,synth_grping,group.template_values);var conditions=[];var grp_conditions=group_filters.conditions;for(var j=0;j<grp_conditions.length;j++)
{var cond=grp_conditions[j];cond.path=this.pivot_field+'.'+this.grid.entity_type+'.'+cond.path;conditions.push(cond);}
group_filters.conditions=conditions;spec={type:this.entity_type,filters:{logical_operator:'and',conditions:[page_filters,group_filters]},summaries:this.get_summaries(),result:this.summary_set,result_key:'synthetic_'+group.idx,use_loading_banner:true};SG.Repo.summarize(spec);}},get_summaries:function(){var cols=this.get_columns(true);var summaries=[];var sum;for(var i=0;i<cols.length;i++){sum=this.get_summary(cols[i]);if(sum&&sum.type&&sum.type!=='none')
summaries.push(sum);}
return summaries;},get_summary:function(col){if(col.indexOf('$')!=-1)
{var summary_schema_field=SG.schema.get_field(this.grid.entity_type,col);return this.get_summary(summary_schema_field.summary_field);}
var settings=this.get('summaries');var schema_field=SG.schema.get_field(this.entity_type,col);var type=schema_field.summary_default?schema_field.summary_default:'none';var summary_default=SG.schema.get_summary_default(schema_field);if(col in settings){return settings[col]||summary_default;}else{return summary_default;}},get_summary_columns:function()
{var summary_cols=[];var cols=this.get_columns();for(var i=0;i<cols.length;i++)
{var summary_col=this.__name_in_parent__+'$'+cols[i];summary_cols.push(summary_col);}
return summary_cols;},set_summary:function(col,summary){var settings=this.get('summaries');settings[col]=summary;this.set('summaries',settings);if(this.grid.summaries_visible())
this.request_summaries();var mode=this.get('mode');if(mode=='summary'||mode=='both')
{var cm=this.get_summary_cell_manager();cm.empty_cell_cache(this.__name_in_parent__+'$'+col);this.render_loaded_data();}},get_column_index:function(col){return this.get_columns(true).indexOf(col);},on_summary_load:function(keys)
{var match;var regex_real_group=/group_(\d+)/;var regex_synth_group=/synthetic_(\d+)_(\d+)_(\d+)/;for(var i=0;i<keys.length;i++)
{var key=keys[i];if(key=='page')
this.update_header_summary();else if(match=key.match(regex_real_group))
{var group_idx=parseInt(match[1]);this.update_group_summaries(group_idx);}
else if(match=key.match(regex_synth_group))
{var group_idx=match[1]+'_'+match[2]+'_'+match[3];this.update_synthetic_group_summaries(group_idx);}}},set_wrapped:function(col,state){var wrapped=this.get('wrapped_columns');wrapped[col]=state;this.set('wrapped_columns',wrapped);this.render_loaded_data();},is_wrapped:function(col){var wrapped=this.get('wrapped_columns');return wrapped[col]||false;},get_column_display_name:function(col)
{var dnames=this.get('column_display_names');var name=dnames[col];if(!name)
name=SG.schema.get_field_display_name(this.entity_type,col);return name;},set_column_display_name:function(col,name){var dnames=this.get('column_display_names');dnames[col]=name;this.set('column_display_names',dnames);this.update_header();},get_column_header_color:function(col){var colors=this.get('column_header_colors');return colors[col];},set_column_header_color:function(col,color){var colors=this.get('column_header_colors');colors[col]=color;this.set('column_header_colors',colors);this.update_header();},toggle_column:function(col,col_index){var columns=sg_deep_copy(this.get_columns(true));var idx=columns.indexOf(col);var add_idx=col_index===undefined?columns.length:col_index;if(idx===-1){columns.splice(add_idx,0,col);this.set_width_related_setting_and_rerender('columns',columns);this.request_data();if(this.grid.summaries_visible())
this.request_summaries();}else{columns.splice(idx,1);if(columns.length!==0){this.set_width_related_setting_and_rerender('columns',columns);}}},is_detail_link:function(col){var dcols=this.get('detail_link_columns');var dcol;var found=false;for(var i=0;i<dcols.length;i++){dcol=dcols[i];if(dcol.column===col){found=true;break;}}
if(found)
return dcol.state;else if(SG.schema.is_identifier_field(this.entity_type,col))
return true;else
return false;},set_detail_link:function(col,state){var schema_field=SG.schema.get_field(this.entity_type,col);var dcols=this.get('detail_link_columns');var dcol;var found=false;for(var i=0;i<dcols.length;i++){dcol=dcols[i];if(dcol.column===col){found=true;break;}}
if(found){dcol.state=state;}else{dcols.push({column:col,state:state});}
this.set('detail_link_columns',dcols);this.get_cell_manager().empty_cell_cache();this.render_loaded_data();},move_column:function(old_idx,new_idx){var cols=sg_deep_copy(this.get_columns(true));var move_col=cols[old_idx];cols.splice(old_idx,1);cols.splice(new_idx,0,move_col);this.set_silent('columns',cols);this.render_loaded_data();this.update_header();if(this.grid.summaries_visible())
this.grid.render_header();this.set('columns',cols);},get_required_columns:function()
{var toolip_fields=['content','sg_status_list','task_assignees','start_date','due_date'];var cols=sg_deep_copy(this.get_columns(true));if(cols.indexOf(this.pivot_field)==-1)
cols.push(this.pivot_field);for(var i=0;i<toolip_fields.length;i++)
{if(cols.indexOf(toolip_fields[i])==-1)
cols.push(toolip_fields[i]);}
return cols;},swap_in_row_tooltip:function(cell_params,record)
{var tooltip=this.render_row_tooltip(record);var sg_tip_re=/sg_tip=".*"/;var cell_attributes=cell_params.cell_attributes.replace(sg_tip_re,'sg_tip="'+tooltip+'"');return cell_attributes;},render_row_tooltip:function(record)
{var s_date=record.get('start_date');var e_date=record.get('due_date');var start_date,end_date;if(s_date==''||s_date==null)
start_date=null;else
start_date=Date.parseDate(s_date,'Y-m-d');if(e_date==''||e_date==null)
end_date=null;else
end_date=Date.parseDate(e_date,'Y-m-d');var task_name=record.get('content');var task_status=record.get('sg_status_list');var assigned=record.get('task_assignees');var schema_fields=SG.schema.entity_fields['Task'];var tip='[[b]]'+task_name+'[[/b]][[br]]';if(task_status!=null)
{if(task_status!='')
{var status_icon=SG.Renderers.status_list.render_nbsp(task_status);tip+=schema_fields['sg_status_list']['display_name']+': ';tip+=status_icon
tip+='  '+SG.schema.status_list[task_status].name+'[[br]]';}
else
tip+=schema_fields['sg_status_list']['display_name']+':[[br]]';}
if(assigned!=null)
{var s='';for(var i=0;i<assigned.length;i++)
{if(i!=0)
s+=','+assigned[i].name;else
s+=assigned[i].name;}
tip+=schema_fields['task_assignees']['display_name']+': '+s+'[[br]]';}
if(start_date)
tip+=schema_fields['start_date']['display_name']+': '+start_date.format('D, M j y')+'[[br]]';else
tip+=schema_fields['start_date']['display_name']+':[[br]]';if(end_date)
tip+=schema_fields['due_date']['display_name']+': '+end_date.format('D, M j y')+'[[br]]';else
tip+=schema_fields['due_date']['display_name']+':[[br]]';return Ext.util.Format.htmlEncode(tip);},_get_entity_type_and_filters_from_context:function()
{return{entity_type:this.get('entity_type'),filters:this.get('filters')};},get_record_count:function(){var ident_field=SG.schema.get_identifier_field(this.entity_type);var val=this.summary_set.get('pivot_record_count',ident_field);if(!val)
return'...';else
return val;},on_summary_menu_selected:function(menu,item)
{if(item.value=='display_summaries'){this.grid.toggle_summaries_visible();}else{var s={column:item.field,type:item.summary_type,value:item.summary_value};this.set_summary(item.field,s);}},render_group_summaries:function(group_idx)
{var content_hash=this.render_group_summary_content(group_idx,false);return this.templates.group_summary_table.apply({width:content_hash.width,color:this.get_color_style(),group_summary_table_content:content_hash.html,name:this.__name_in_parent__,group_idx:group_idx});},render_group_summary_content:function(group_idx,synthetic)
{var summaries='';if(this.grid.summaries_visible())
{var cm=this.get_cell_manager();var cols=this.get_columns();for(var i=0;i<cols.length;i++)
summaries+=this.render_group_summary_cell(i==0,group_idx,cols[i],synthetic);}
var width=this.get_column_width_sum(true);return{width:width,html:this.templates.group_summary_table_content.apply({width:width,summaries:summaries})};},render_synthetic_group_summaries:function(group)
{var content_hash=this.render_group_summary_content(group.idx,true);return this.templates.group_summary_table.apply({width:content_hash.width,color:this.get_color_style(),group_summary_table_content:content_hash.html,name:this.__name_in_parent__,group_idx:group.idx});},render_group_summary_cell:function(first_column,group_idx,col,synthetic)
{var cm=this.get_cell_manager();var sum_render={summary_content:"&nbsp",summary_classes:''};var cell=cm.get_cell(col,this.get_cell_config(col));var sum=this.get_summary(col);var key=synthetic?'synthetic_'+group_idx:'group_'+group_idx;var val=this.summary_set.get(key,col);if(val!==null)
sum_render=cell.render_summary(sum.type,val,sum.value);var width=this.get_column_width(col);if(first_column)width--;var params={width:width,content:sum_render.summary_content,extra_cls:sum_render.summary_classes};return this.templates.group_summary_cell.apply(params);},render_loading:function()
{var grid_container=this.grid.get_container();var grid_content=this.templates.grid_content.apply({grid_rows:this.templates.waiting_for_data.apply(),extra_class:''});var grids=sg_find_all('td.pivot_grid[field="'+this.__name_in_parent__+'"]',grid_container.dom);for(var i=0;i<grids.length;i++)
{var grid=Ext.get(grids[i]);grid.update(grid_content);}},render_loaded_data:function()
{var grid_container=this.grid.get_container();var grids=sg_find_all('td.pivot_grid[field="'+this.__name_in_parent__+'"]',grid_container.dom);for(var i=0;i<grids.length;i++)
{var grid=Ext.get(grids[i]);var record_id=Number(grid.dom.getAttribute('record_id'));var html=this.render_pivot_grid_content(record_id);grid.update(html);}},update_header:function()
{var grid_container=this.grid.get_container();var header_td=sg_find('td.heading[field="'+this.__name_in_parent__+'"]',grid_container.dom);header_td=Ext.get(header_td);var pivot_headers_div=header_td.child('div.pivot_headers:not(.sg_color)');pivot_headers_div.update(this.render_header_columns());},set_mode:function(mode)
{var old_mode=this.get('mode');this.set('mode',mode);this.render_loaded_data();if(old_mode=='summary')
this.request_data();},set_sort:function(field,direction)
{this.set('sorts',[{column:field,direction:direction}]);this.render_loading();this.grid.render_header();this.request_data();},get_multi_edit_config:function(parent_ids)
{var i,j,recs;var config={data_set:this.data_set,columns:this.get_columns(),column_display_names:this.get('column_display_names'),ids:[]};for(i=0;i<parent_ids.length;i++){recs=this.id_map[parent_ids[i]];if(!recs)continue;for(j=0;j<recs.length;j++){config.ids.push(recs[j].get_id());}}
return config;},change_columns:function(added,removed){var cols=this.get_columns(true);var new_cols=[];for(var i=0;i<cols.length;i++)
{var col=cols[i];if(removed.indexOf(col)==-1)
new_cols.push(col);}
if(added.length>0)
{new_cols=new_cols.concat(added);this.set_width_related_setting_and_rerender('columns',new_cols,false);this.request_data();if(this.grid.summaries_visible())
this.request_summaries();}
else
this.set_width_related_setting_and_rerender('columns',new_cols);},delete_record:function(record_id)
{var record=this.data_set.get_record_by_id(record_id);if(!record)
return;record.retire();this.data_set.commit();},transferable_settings_keys:['columns','column_widths','open','mode','summaries','column_display_names','detail_link_columns','wrapped_columns','column_header_colors','sorts'],get_transferable_settings:function()
{var settings={};for(var i=0;i<this.transferable_settings_keys.length;i++)
settings[this.transferable_settings_keys[i]]=sg_deep_copy(this.get(this.transferable_settings_keys[i]));return settings;},save_layout_as_default:function()
{var existing=SG.globals.entity_field_prefs['default_step_column_layout']?SG.globals.entity_field_prefs['default_step_column_layout'][this.entity_type]:null;var current_settings=this.get_transferable_settings();this.grid.show_loading_overlay();if(existing)
{var update_config={request_type:"update",type:"EntityFieldPref",id:existing.id,column:'settings',value:Ext.encode(current_settings)};var update_request=new SG.CrudRequest(update_config,null);update_request.on("completed",function(){existing.settings=current_settings;this.grid.hide_loading_overlay();this.show_default_step_updated_message();},this);update_request.send();}
else
{var create_config={request_type:'create',type:'EntityFieldPref',columns:['entity_type','settings'],field_values:[{column:'entity_type',value:this.entity_type},{column:'pref_type',value:'default_step_column_layout'},{column:'settings',value:Ext.encode(current_settings)}]};var request=new SG.CrudRequest(create_config,null);request.on("completed",function(responses){var response=responses[0];if(response.status=="successful")
{if(!SG.globals.entity_field_prefs['default_step_column_layout'])
SG.globals.entity_field_prefs['default_step_column_layout']={};SG.globals.entity_field_prefs['default_step_column_layout'][this.entity_type]={id:response.row[0],settings:current_settings};this.grid.hide_loading_overlay();this.show_default_step_updated_message();}},this);request.send();}},show_default_step_updated_message:function()
{SG.Message.show({html:'The default Step layout has been saved. '+'<a href="javascript:" update_steps="true">Update All Visible Steps</a>',close_x:true,click_fn:{fn:this.default_step_update_message_clicked,scope:this}});},default_step_update_message_clicked:function(e)
{var target=e.getTarget();if(target&&target.tagName==='A'&&target.hasAttribute('update_steps'))
{SG.Message.hide();this.grid.apply_defaults_to_all_step_columns();}},synchronize_all_other_step_columns:function()
{var settings=this.get_transferable_settings();var grid_summaries_visible=this.grid.summaries_visible();var columns=this.grid.get_columns(true);for(var i=0;i<columns.length;i++)
{if(this.grid.is_pivot_column(columns[i]))
{var other_pivot_column=this.grid.get_child(columns[i]);if(this!=other_pivot_column)
{other_pivot_column.widget_spec.set_settings(this,settings);if(grid_summaries_visible)
other_pivot_column.request_summaries();}}}
this.grid.render();},update_header_summary:function()
{var container=this.grid.header_container;var td=sg_find('td.summary[field="'+this.__name_in_parent__+'"]',container.dom);td=Ext.get(td);var content_hash=this.render_header_summary_content(false);td.update(content_hash.html);},update_group_summaries:function(group_idx)
{var td=this.find_group_summary_td(group_idx);var content=this.render_group_summary_content(group_idx,false);td.update(content.html);},update_synthetic_group_summaries:function(group_idx)
{var td=this.find_group_summary_td(group_idx);var content=this.render_group_summary_content(group_idx,true);td.update(content.html);},find_group_summary_td:function(group_idx)
{var container=this.grid.container;var field_sel='[field="'+this.__name_in_parent__+'"]';var group_sel='[group_idx="'+group_idx+'"]';var td=sg_find('td.pivot_group_summary'+field_sel+group_sel,container.dom);return Ext.get(td);},get_through_join_fields:function()
{return[];},get_export_summary_request:function()
{var mode=this.get('mode');if(mode=='detail')
return{};var cols=this.get_summary_columns();var summaries=[];for(var i=0;i<cols.length;i++)
{var summary=this.get_summary(cols[i]);if(summary.type!="none")
summaries.push(summary);}
var cell_manager=this.get_summary_cell_manager();var cell=cell_manager.get_cell(cols[0]);return{type:this.entity_type,summaries:summaries,filters:cell.get_filters(-1,false)};},get_export_summary_columns_hash:function()
{var cm=this.get_cell_manager();var ret_hash={};var cols=this.get_columns();for(var i=0;i<cols.length;i++)
{var col=cols[i];var schema_field=SG.schema.get_field(this.entity_type,col);if(schema_field.data_type=='summary')
{var cell=cm.get_cell(col);var cell_hash=cell.get_csv_export_hash();cell_hash.column_display_name=this.get_column_display_name(col);ret_hash[col]=cell_hash;}}
return ret_hash;},get_dom_elements_for_cell:function(field_name,record_id,record_type)
{if(!this.dom_cell_cache)
this.create_dom_element_cache_for_cell_manager();var td=this.dom_cell_cache[Number(record_id)];if(!td)return false;var cell=sg_find('.sg_cell[field="'+field_name+'"]',td.dom);return[cell];},create_dom_element_cache_for_cell_manager:function()
{this.dom_cell_cache={};var container=this.grid.get_container();var tds=sg_find_all('td.pivot_grid[field="'+this.__name_in_parent__+'"]',container.dom);for(var i=0;i<tds.length;i++)
{var td=Ext.get(tds[i]);var record_id=Number(td.dom.getAttribute('record_id'));this.dom_cell_cache[record_id]=td;}},clear_dom_cell_cache:function()
{this.dom_cell_cache=null;},get_task_records_for_entity:function(entity_record_id)
{var recs=this.id_map[entity_record_id];if(recs)
return recs;else
return[];},get_new_entity_defaults_from_context:function()
{var filters=this.get('filters');var conditions=filters['conditions'];if(conditions&&conditions.length==2)
{step_cond=conditions[1];var step=SG.schema.get_step_entity(this.grid.entity_type,this.get('display_column'));step_cond.values=[{id:step.id,name:step.code,type:'Step',valid:'valid'}];filters.conditions[1]=step_cond;this.set('filters',filters);}
return SG.Widget.Base.prototype.get_new_entity_defaults_from_context.call(this);},get_column_names_for_export:function()
{var ret={};var cols=this.get_columns();var column_display_names=this.get('column_display_names');for(var i=0;i<cols.length;i++)
{var col=cols[i];var schema_field=SG.schema.get_field('Task',col);if(column_display_names[col])
ret[col]=column_display_names[col];else
ret[col]=this.get_column_display_name(col);}
return ret;},});SG.Importer=function(config)
{Ext.apply(this,config);SG.Importer.superclass.constructor.call(this);};Ext.extend(SG.Importer,SG.Component,{templates:{header:'<div class="header_text"><center>{text}</center></div>',footer:'<div class="controls"><span class="cancel">Cancel</span>'+'<input type="button" class="continue" value="Continue" disabled="true"/></div>',step:'<span class="step {active} {done}" index="{index}">Step {step_num}: {description}</span>',steps:'<div>{steps}</div>',import_successful:'<div class="success_header">Your {entities} Have Been Imported Successfully</div>'+'<div class="return_to_page"><img class="success_icon" src="/images/icon_arrow_thin_left.png"/>'+'<span class="success_choice">Go back to the page where you started.</span></div>'+'<div class="new_page"><img class="success_icon" src="/images/icon_new_page.png"/>'+'<span class="success_choice">Or view a new page with the imported data.</span></div>'},step_components:['SG.Importer.GetData','SG.Importer.MapFields','SG.Importer.PickIdFields','SG.Importer.EntityPreview'],step_descriptions:['Provide the data for import','Map Fields','Specify ID fields','Preview'],init_component:function()
{this.step_index=0;this.on_first_render();if(this.parent_entity&&this.parent_entity.type=='TaskTemplate'&&this.entity_type=='Task')
{this.single_project=undefined;this.parent_entity.valid='valid';}},destroy_component:function()
{this.container.remove();this.mask.remove();},on_first_render:function(){this.dh=Ext.DomHelper;this.mask=this.dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.container=this.dh.append(this.mask,{tag:'div',cls:'sgc_importer'},true);this.header_div=this.dh.append(this.container,{tag:'div',cls:'header'},true);this.step_links_div=this.dh.append(this.container,{tag:'div',cls:'steps ready'},true);this.body_div=this.dh.append(this.container,{tag:'div',cls:'body'},true);this.help_div=this.dh.append(this.container,{tag:'div',cls:'help'},true);this.footer_div=this.dh.append(this.container,{tag:'div',cls:'footer ready'},true);this.add_event(this.footer_div,'click',this.on_footer_click);this.add_event(this.step_links_div,'click',this.on_step_links_click);this.construct_active_step();this.render();},render:function()
{this.render_header();this.render_step_links();this.render_footer();this.render_active_step();},render_active_step:function()
{this.current_step.render();},render_step_links:function()
{var steps_html='';for(var i=0;i<this.step_descriptions.length;i++)
{steps_html+=this.templates.step.apply({active:i==this.step_index?'active':'',index:i,step_num:i+1,done:i<this.step_index?'done':'',description:this.step_descriptions[i]});}
this.step_links_div.update(this.templates.steps.apply({steps:steps_html}));},render_header:function()
{var text='Bulk '+SG.schema.entity_types[this.entity_type]['display_name']+' Import';this.header_div.update(this.templates.header.apply({text:text}));},render_footer:function()
{this.footer_div.update(this.templates.footer.apply());},on_footer_click:function(e)
{if(!this.footer_div.hasClass('ready'))
return;var target=Ext.get(e.getTarget());var cancel=target.findParent('span.cancel',this.footer_div);if(cancel)
{this.destroy();return;}
var continue_button=target.findParent('input.continue',this.footer_div);if(continue_button)
{if(this.current_step.validate_data())
{this.step_index++;this.construct_active_step();this.render();}
return;}},step_ready:function(continue_button_display_name)
{this.step_links_div.addClass('ready');this.footer_div.addClass('ready');var continue_button=this.footer_div.child('input.continue');if(continue_button_display_name)
continue_button.dom.value=continue_button_display_name;continue_button.dom.removeAttribute('disabled');},step_busy:function()
{this.step_links_div.removeClass('ready');this.footer_div.removeClass('ready');var continue_button=this.footer_div.child('input.continue');if(continue_button)
continue_button.dom.setAttribute('disabled',true);},on_step_links_click:function(e)
{if(!this.step_links_div.hasClass('ready'))
return;var target=Ext.get(e.getTarget());var step_span=target.findParent('span.step',this.step_links_div,true);if(step_span&&step_span.hasClass('done'))
{this.step_index=Number(step_span.dom.getAttribute('index'));this.construct_active_step();this.render();return;}},construct_active_step:function()
{var config={container:this.body_div,help_container:this.help_div,entity_type:this.entity_type,importer:this};if(this.current_step)
{config.step_data=this.current_step.get_step_data();this.current_step.destroy();}
else
config.step_data=new SG.Importer.StepData(this.column_display_names);if(this.single_project)
config.single_project=this.single_project;if(this.parent_entity)
config.parent_entity=this.parent_entity;var str='this.current_step = new '+this.step_components[this.step_index]+'(config);';eval(str);this.step_busy();},import_successful:function(import_entity_ids,columns)
{this.import_entity_ids=import_entity_ids;this.import_columns=columns;this.remove_event(this.footer_div,'click',this.on_footer_click);this.remove_event(this.step_links_div,'click',this.on_step_links_click);var db=Ext.get(document.body);var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];this.container.addClass('success');this.container.update(this.templates.import_successful.apply({entities:entities}));this.container.setWidth(500);this.container.setHeight(125);this.container.center();this.add_event(this.container,'click',this.on_success_click);var shadow=new Ext.Shadow({offset:5,mode:'frame'});shadow.show(this.container);},on_success_click:function(e)
{var target=Ext.get(e.getTarget());var return_to_page=target.findParent('div.return_to_page',this.container);if(return_to_page)
{var descendants=[SG.globals.page.root_widget];SG.globals.page.root_widget.get_all_descendents(SG.globals.page.root_widget,descendants);var widget;for(var i=0;i<descendants.length;i++)
{widget=descendants[i];if(typeof widget.reload_all_entities=='function'&&widget.entity_type===this.entity_type){widget.reload_all_entities();}}
this.destroy();return;}
var new_page=target.findParent('div.new_page',this.container);if(new_page)
{this.pi=new SG.ProgressIndicator();this.pi.show();var now=new Date();var options={url:'/page/create_import_page',params:{entity_type:this.entity_type,import_ids:Ext.encode(this.import_entity_ids),columns:Ext.encode(this.import_columns),client_timestamp:now.format('M d, Y g:i A')},callback:function(options,success,response){if(success){var page_id=Ext.decode(response.responseText).page_id;var current_url=window.location;var new_url=current_url.protocol+'//'+current_url.host+'/page/'+page_id;window.location=new_url;}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}},data_is_all_summary_rows:function()
{var message='Oops.  The data you are trying to import contains columns with calculated Task '+'<span style="font-weight:bold;">summaries</span>.'+'  These are the ones that have an "id" that says "SUMMARY_ROW".  Because the summaries '+'are calculated on the fly when you load a Shotgun page, they can not be imported into the '+'database.  Instead, you can import values into the Task detail fields, which will have a '+'numeric "id" such as "12345". You can learn more about how to import into the Task fields '+'<a target="_blank" href="'+SG.globals.help_urls.import_tasks+'">here</a>.<br><br>'+'Pressing ok will take you back to the first step so that you might resolve this. You can fix '+'the issue in your spreadsheet and paste back into Step 1, or you can skip the offending '+'columns in Step 2.';var smd=new SG.MessageDialog({sg_dialog_header_text:'Import Error',html_msg:message});this.add_event(smd,'dialog_submitted',function(){this.step_index=0;this.construct_active_step();this.render();});}});SG.Importer.Step=function(config)
{Ext.apply(this,config);SG.Importer.Step.superclass.constructor.call(this);};Ext.extend(SG.Importer.Step,SG.Component,{templates:{help:'<div class="title">{title}</div>{help}',splitter:'<div class="resize_splitter" index="{index}" style="left:{left}px;">&nbsp;</div>',},validate_data:function()
{return false;},render:function()
{if(!this.__rendered__)
{this.on_first_render();this.__rendered__=true;}
this.render_step();},on_first_render:function()
{},render_step:function()
{},on_change:function(e)
{},on_click:function(e)
{},get_step_data:function()
{return this.step_data;},help_link:function()
{return'<a href="'+SG.globals.help_urls.importer+'" target="_blank">here</a>';},get_column_width:function(field_name)
{var key=String(field_name);if(!this._column_widths_)
{this._column_widths_={};return 100;}
if(!this._column_widths_[key])
return 100;else
return this._column_widths_[key];},set_column_width:function(field_name,width)
{var key=String(field_name);if(!this._column_widths_)
this._column_widths_={};this._column_widths_[key]=width;},get_all_column_widths:function()
{if(!this._column_widths_)
return{};else
return this._column_widths_;},sel_all_column_widths:function(widths_hash)
{this._column_widths_=widths_hash;},});SG.Importer.StepData=function(column_display_names){this.init();if(!column_display_names)
this.column_display_names={};else
this.column_display_names=column_display_names;};SG.Importer.StepData.prototype={init:function()
{this.raw_input='';this.header_row=[];this.header_map=[];this.pivot_column_map=[];this.rows=[];},get_raw_input:function()
{if(!this.raw_input)
return'';else
return this.raw_input;},set_raw_input:function(input)
{this.raw_input=input;},set_header_row:function(row)
{this.header_row=row;},get_header_row:function()
{return this.header_row;},add_row:function(row)
{this.rows.push(row);},get_rows:function()
{return this.rows;},set_rows:function(rows)
{this.rows=rows;},set_header_map:function(map)
{this.header_map=map;},get_column_display_names:function()
{return this.column_display_names;},get_header_map:function()
{return this.header_map;},set_pivot_column_map:function(map)
{this.pivot_column_map=map;},get_pivot_column_map:function()
{return this.pivot_column_map;},set_id_fields:function(fields)
{this.id_fields=fields;},get_id_fields:function(entity_type)
{if(!this.id_fields)
return[];else
{if(!entity_type)
return this.id_fields;var ret=[];for(var i=0;i<this.id_fields.length;i++)
{if(this.id_fields[i].entity_type==entity_type)
ret.push(this.id_fields[i]);}
return ret;}},set_project:function(single_project)
{this.single_project=single_project;},get_project:function()
{return this.single_project;},};SG.Importer.GetData=function(config)
{Ext.apply(this,config);SG.Importer.GetData.superclass.constructor.call(this);};Ext.extend(SG.Importer.GetData,SG.Importer.Step,{templates:{body:'<div class="get_data_title">Paste in data from Excel</div>'+'<div class="input_pad">{project_selector}<textarea cols="10" rows="{rows}">{input_text}</textarea></div>',project_selector:'<div class="project_selector"><table style="width:300px"><tr>'+'<td style="width: 130px;"><div>Attach to project</div></td>'+'<td style="width: 170px;"><select class="project_selector" name="project">{options}</select>'+'</td></tr></table></div>',},validate_data:function()
{var textarea=this.container.child('textarea');var input_text=textarea.dom.value;var lines=input_text.split('\n');if(input_text.length==0||lines.length<2)
{alert('Excel data must contain at least 2 rows, one row for the headers and one row of data');return false;}
return this.process_input_text(input_text);},on_first_render:function()
{this.add_event(this.container,'change',this.on_change);var step_project=this.step_data.get_project();if(step_project!=undefined)
this.single_project=step_project;Ext.EventManager.onWindowResize(this.on_window_resize,this);},render_step:function()
{var rows=Math.floor((this.container.getHeight()-100)/15);this.container.update(this.templates.body.apply({input_text:this.step_data.get_raw_input(),project_selector:this.render_project_selector(),rows:rows}));this.render_help();this.importer.step_ready();},on_change:function(e)
{var target=Ext.get(e.getTarget());var project_selector=target.findParent('select.project_selector',this.container);if(project_selector)
{if(project_selector.value=='multiple')
this.step_data.set_project(null);else
this.step_data.set_project({type:'Project',id:Number(project_selector.value)});}},render_project_selector:function()
{if(SG.schema.entity_types[this.entity_type].has_projects===false)
return'';if(this.parent_entity&&this.parent_entity.type=='TaskTemplate'&&this.entity_type=='Task')
{this.single_project=undefined;return'';}
var list=SG.schema.projects;var options='';var project_found=false;for(var i=0;i<list.length;i++)
{if(this.single_project&&this.single_project.id==list[i].id)
{project_found=true;options+='<option selected="selected" value="'+list[i].id+'">'+list[i].name+'</option>';this.step_data.set_project(this.single_project);}
else
options+='<option value="'+list[i].id+'">'+list[i].name+'</option>';}
if(!project_found)
options+='<option selected="selected" value="multiple">Multiple Projects</option>';else
options+='<option value="multiple">Multiple Projects</option>';return this.templates.project_selector.apply({options:options});},process_input_text:function(input)
{var sd=this.step_data;sd.init();sd.set_raw_input(input);var header_info=this.process_header(sd,input);if(!header_info.success)
return false;var i=header_info.i;var inside_quotes=false;var start=i;var line_number=1;while(i<input.length)
{var c=input.charAt(i);if(c=='"'&&!/\d+\'\d+\"/.test(input))
inside_quotes=!inside_quotes;else if(c=='\n')
{if(!inside_quotes)
{this.add_input_line(sd,input.substr(start,(i-start)),header_info.raw_column_count,line_number);line_number++;start=i+1;}}
i++;}
if(start<input.length)
this.add_input_line(sd,input.substr(start,(input.length-start)),header_info.raw_column_count);return true;},process_header:function(step_data,input)
{var j,header;var i=input.search('\n');var top_header=input.substr(0,i).split('\t');var has_task_columns=false;for(j=0;j<top_header.length;j++)
{header=top_header[j];if(header.length==0)
{has_task_columns=true;break;}}
i+=1;if(has_task_columns)
{j=input.indexOf('\n',i);var bottom_header=input.substr(i,j-i).split('\t');if(top_header.length!=bottom_header.length)
{alert('Looks like the input data contains Task columns and the number columns in the two row'+' header is not the same. Can not continue with import, please fix the input data and retry.');return{success:false};}
var header_row=[];i=j+1;for(j=0;j<bottom_header.length;j++)
{var top=top_header[j];var bottom=bottom_header[j];if(top.length==0)
header_row.push({name:bottom,pivot_column_name:null});else
header_row.push({name:bottom,pivot_column_name:top});}
step_data.set_header_row(header_row);}
else
{var header_row=[];for(j=0;j<top_header.length;j++)
header_row.push({name:top_header[j],pivot_column_name:null});step_data.set_header_row(header_row);}
return{i:i,raw_column_count:top_header.length,success:true};},add_input_line:function(step_data,line,header_length,line_number)
{var c,clean;var row=[];var i=0;var inside_quotes=false;var start=i;while(i<line.length)
{c=line.charAt(i);if(c=='"'&&!/\d+\'\d+\"/.test(line))
inside_quotes=!inside_quotes;else if(c=='\t')
{if(!inside_quotes)
{clean=this.strip_quotes(line.substr(start,i-start));row.push(clean);start=i+1;}}
i++;}
if(start<=line.length)
{clean=this.strip_quotes(line.substr(start,line.length-start));row.push(line.substr(start,(line.length-start)));}
if(row.length<header_length)
{var num_blanks=header_length-row.length;for(i=0;i<num_blanks;i++)
row.push('');}
var all_blank=true;for(i=0;i<row.length;i++)
{if(row[i].length>0)
{all_blank=false;break;}}
if(!all_blank)
step_data.add_row(row);},strip_quotes:function(str)
{if(str.length==0)
return'';if(str.charAt(0)=='"'&&str.charAt(str.length-1)=='"')
{if(str.length==2)
return'';else
return str.substr(1,str.length-2);}
else
return str;},render_help:function()
{var entity=SG.schema.entity_types[this.entity_type]['display_name_pluralized'].toLowerCase();var title='Step 1: Provide the data for import';var help='<p>Bulk import lets you create and update many shots at once.</p><br>';help+='<p>You have to paste tab delimited data into the text area. The easiest way to do '+'this is copy and paste from Excel.</p><br>';help+='<p>Make sure the column names are in the first row, with the data you want to import '+'in the following rows. Remove any blank rows.</p><br>';help+='<p>You can have Shotgun create new records for each row you import or we can match existing records, '+'or both. To update existing records you will need to specify what fields to use for us to find '+'existing '+entity+' in the next step.</p><br>';help+='<p>Read more about importing or watch a tutorial video '+this.help_link()+'.</p>';this.help_container.update(this.templates.help.apply({title:title,help:help}));},on_window_resize:function()
{var textarea=this.container.child('textarea');var input_text=textarea.dom.value;this.step_data.set_raw_input(input_text);this.render_step();},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.on_window_resize,this);},});SG.Importer.MapFields=function(config)
{Ext.apply(this,config);SG.Importer.MapFields.superclass.constructor.call(this);};Ext.extend(SG.Importer.MapFields,SG.Importer.Step,{templates:{main:'<div class="sgc_importer_map_fields">'+'<div class="header"><div>Map the columns in your data to Shotgun columns</div></div>'+'<div class="left"><table><tr><td><div>Your Column</div></td></tr><tr><td><div>Shotgun Column</div></td>'+'<tr><td><div>Data Preview</div></td></tr></table></div><div class="right"><div class="table_data">'+'<div class="header"></div><div class="data"></div><div class="resize_proxy"></div>'+'</div></div><div class="bottom"><div>'+'<table><tr><td>Make sure you scroll to the right if needed to map all columns '+'before continuing.</td></tr></table></div></div></div>',header_table:'<table class="header" style="width:{table_width}px;"><tr>{columns}</tr></table>',data_table:'<table class="data" style="width:{table_width}px;">{rows}</table>',cell:'<td style="width:{width}px;" index="{index}"><div class="column {mapped}">{value}</div></td>',sg_cell:'<td style="width:{width}px;" index="{index}">'+'<div class="column {mapped} sg_field" index="{index}">{value}'+'<img class="double_arrow" src="/images/dropdown_doubleArrow.png"></div></td>',},validate_data:function()
{var pivot_column_map=this.step_data.get_pivot_column_map();var header_map=this.step_data.get_header_map();var found_project=false;for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null||pivot_schema_field!=null)
continue;if(schema_field.data_type=='entity'&&schema_field.name=='project')
{found_project=true;break;}}
if(this.parent_entity&&this.parent_entity.type=='TaskTemplate'&&this.entity_type=='Task')
return true;var project=this.step_data.get_project();if(project==null)
{if(SG.schema.entity_types[this.entity_type].has_projects&&!found_project)
{var dnp=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];var dp=SG.schema.entity_types[this.entity_type]['display_name'];alert('In order to import '+dnp+' into Multiple Projects you must provide a Project '+'for each '+dp+'.');return false;}}
return true;},on_first_render:function()
{this.container.update(this.templates.main.apply());this.table_div=this.container.child('div.right');this.resize_proxy=this.container.child('div.resize_proxy');this.table_header_div=this.table_div.child('div.header');this.table_data_div=this.table_div.child('div.data');this.add_event(this.table_div,'click',this.on_click);this.add_event(this.table_div,'scroll',this.on_table_div_scroll);this.construct_header_map();Ext.EventManager.onWindowResize(this.on_table_div_scroll,this,true);var drag_container=this.table_div.child('div.table_data');var dnd_config={step:this,container:this.container,proxy:this.resize_proxy};this.grid_heading_drag_zone=new SG.Importer.SplitterDragZone(dnd_config);},render_step:function()
{this.table_header_div.update(this.render_headers());this.table_data_div.update(this.render_data());this.render_help();this.data_div=this.table_div.child('div.data');this.on_table_div_scroll();this.importer.step_ready();},construct_header_map:function()
{var schema_fields=SG.schema.entity_fields[this.entity_type];var column_display_names=this.step_data.get_column_display_names();var schema_map={};var s;for(s in schema_fields)
{if(!schema_fields.hasOwnProperty(s))
continue;var schema_field=schema_fields[s];if(schema_field.grid_column==false)
continue;schema_map[schema_field.display_name.toLowerCase()]=schema_field;if(column_display_names[schema_field.name])
{var dn=column_display_names[schema_field.name].toLowerCase();schema_map[dn]=schema_field;}}
var pivot_schema_fields=SG.schema.entity_fields['Task'];var pivot_schema_map={};for(s in pivot_schema_fields)
{if(!pivot_schema_fields.hasOwnProperty(s))
continue;var schema_field=pivot_schema_fields[s];if(schema_field.grid_column==false)
continue;pivot_schema_map[schema_field.display_name.toLowerCase()]=schema_field;}
var map,schema_field;var header_row=this.step_data.get_header_row();var header_map=[];var pivot_column_map=[];for(var i=0;i<header_row.length;i++)
{var header_map_value,pivot_column_map_value;var header=header_row[i];map=header.pivot_column_name?pivot_schema_map:schema_map;header_display_name=header.name.toLowerCase();if(map.hasOwnProperty(header_display_name))
{schema_field=map[header_display_name];if(!this.not_supported_field(schema_field))
header_map_value=schema_field;else
header_map_value=null;}
else
header_map_value=null;if(header.pivot_column_name!=null)
{header_display_name=header.pivot_column_name.toLowerCase();schema_field=schema_map[header_display_name];if(schema_field&&schema_field.data_type=='pivot_column')
pivot_column_map_value=schema_field;else
pivot_column_map_value=null;}
else
pivot_column_map_value=null;if(header.pivot_column_name!=null&&pivot_column_map_value==null)
header_map_value=null;if(header_map_value!=null)
header_map_value=sg_deep_copy(header_map_value);if(pivot_column_map_value!=null)
pivot_column_map_value=sg_deep_copy(pivot_column_map_value);header_map.push(header_map_value);pivot_column_map.push(pivot_column_map_value);}
this.step_data.set_header_map(header_map);this.step_data.set_pivot_column_map(pivot_column_map);},on_click:function(e)
{var target=Ext.get(e.getTarget());var sg_field_div=target.findParent('div.sg_field',this.table_div);if(sg_field_div)
{this.last_sg_field_div=sg_field_div;if(!this.fields_menu)
{this.fields_menu=new SG.Menu({before_show:{fn:this.on_before_show_fields_menu,scope:this},});}
this.fields_menu.show();}},not_supported_field:function(schema_field)
{var unsupported_data_types=['url','image'];if(schema_field.read_only||schema_field.create_only)
return schema_field.name!='id';else if(unsupported_data_types.indexOf(schema_field.data_type)!=-1)
return true;else if(this.parent_entity&&this.parent_entity.type=='TaskTemplate'&&this.entity_type=='Task'&&schema_field.name=='project')
{return true;}
else if(schema_field.data_type=='entity'&&schema_field.name=='project')
{if(schema_field.entity_type!=this.entity_type)
return true;var project=this.step_data.get_project();return(project!=null);}
else if(!SG.schema.can_edit_field(schema_field.entity_type,schema_field.name))
return true;else if(schema_field.no_filtering)
{var smart_fields=['smart_head_in','smart_head_out','smart_head_duration','smart_cut_in','smart_cut_out','smart_cut_duration','smart_tail_in','smart_tail_out','smart_tail_duration'];return(smart_fields.indexOf(schema_field.name)==-1)}
return false;},on_before_show_fields_menu:function(menu)
{var clicked_index=Number(this.last_sg_field_div.getAttribute('index'));var items=this.get_entity_menu_items(clicked_index);menu.position={dom_elem:this.last_sg_field_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items;menu.render();},find_step_entity:function(pivot_schema_field)
{var steps=SG.globals.steps[this.entity_type];if(!steps)
return null;for(var i=0;i<steps.length;i++)
{var step=steps[i];var dc_name='step_'+step.id;if(dc_name==pivot_schema_field.name)
return step;}
return null;},get_entity_menu_items:function(clicked_index)
{var pivot_column_map=this.step_data.get_pivot_column_map();var header_map=this.step_data.get_header_map();var pivot_schema_field=pivot_column_map[clicked_index];var entity_schema_field=header_map[clicked_index];var fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:this.entity_type,only_simple_fields:true,column_display_names:this.step_data.get_column_display_names(),field_disabled_callback:{fn:this.not_supported_field,scope:this},field_checked_callback:{fn:function(schema_field,field_name){if(field_name.indexOf('$')!=-1)
{var parts=field_name.split('$');return(pivot_schema_field&&entity_schema_field&&pivot_schema_field.name==parts[0]&&entity_schema_field.name==parts[1]);}
return(entity_schema_field&&entity_schema_field.entity_type==schema_field.entity_type&&entity_schema_field.name==schema_field.name);},scope:this},on_field:{fn:this.on_column_field,scope:this},show_pivot_column_summary_fields:true});var items=[];if(entity_schema_field!=null)
{items.push({html:'Do not import',item_selected:{fn:this.no_import_column,scope:this},});items.push({line:true});}
items=items.concat(fields_menu_helper.get_menu_items());return items;},no_import_column:function(menu,menuitem)
{var index=Number(this.last_sg_field_div.getAttribute('index'));var header_map=this.step_data.get_header_map();header_map[index]=null;this.step_data.set_header_map(header_map);var me=this;setTimeout(function(){me.render_step();},0);},on_column_field:function(menu,menuitem)
{if(menuitem.checked)
return this.no_import_column();var index=Number(this.last_sg_field_div.getAttribute('index'));var pivot_column_map=this.step_data.get_pivot_column_map();var header_map=this.step_data.get_header_map();var field_name=menuitem.field;if(field_name.indexOf('$')!=-1)
{var parts=field_name.split('$');var pivot_schema_field=SG.schema.get_field(this.entity_type,parts[0]);var entity_type=pivot_schema_field.query.entity_type;var schema_field=SG.schema.get_field(entity_type,parts[1]);pivot_column_map[index]=pivot_schema_field;header_map[index]=schema_field;}
else
{var schema_field=SG.schema.get_field(this.entity_type,field_name);header_map[index]=schema_field;}
this.step_data.set_header_map(header_map);this.step_data.set_pivot_column_map(pivot_column_map);var me=this;setTimeout(function(){me.render_step();},0);},render_headers:function()
{var sd=this.step_data;var header_row=sd.get_header_row();var pivot_column_map=sd.get_pivot_column_map();var header_map=sd.get_header_map();var column_display_names=this.step_data.get_column_display_names();var import_columns='';var sg_columns='';var splitters='';var table_width=0;var schema_field;var mapped;for(var i=0;i<header_row.length;i++)
{var sg_col;var schema_field=header_map[i];if(schema_field!=null)
{if(schema_field.entity_type==this.entity_type)
{if(column_display_names[schema_field.name])
sg_col=column_display_names[schema_field.name];else
sg_col=schema_field['display_name'];mapped='mapped';}
else
{if(pivot_column_map[i]!=null)
{sg_col=pivot_column_map[i]['display_name']+'->'+schema_field['display_name'];mapped='mapped';}
else
{sg_col='Do not import';mapped='';}}}
else
{sg_col='Do not import';mapped='';}
var w=this.get_column_width(i);table_width+=w;var import_col;if(header_row[i].pivot_column_name)
import_col=header_row[i].pivot_column_name+'->'+header_row[i].name;else
import_col=header_row[i].name;import_columns+=this.templates.cell.apply({width:w,mapped:mapped,value:import_col,index:i});sg_columns+=this.templates.sg_cell.apply({width:w,mapped:mapped,value:sg_col,index:i});splitters+=this.templates.splitter.apply({left:table_width-4,index:i});}
var h=this.templates.header_table.apply({columns:import_columns,table_width:table_width});h+=this.templates.header_table.apply({columns:sg_columns,table_width:table_width});h+=splitters;return h;},render_data:function()
{var rows=this.step_data.get_rows();var header_map=this.step_data.get_header_map();var row_html='';var i,j;var max=rows.length;if(rows.length>100)
max=100;var table_width;for(i=0;i<max;i++)
{var columns='';var a_row=rows[i];var table_width=0;for(j=0;j<a_row.length;j++)
{var mapped=header_map[j];if(mapped!=null)
mapped='mapped';else
mapped='';var w=this.get_column_width(j);table_width+=w;columns+=this.templates.cell.apply({width:w,mapped:mapped,value:a_row[j]});}
row_html+='<tr>'+columns+'</tr>';}
return this.templates.data_table.apply({rows:row_html,table_width:table_width});},render_help:function()
{var title='Step 2: Map Columns';var help='<p>Match the column headers we found in your data to the correct Shotgun columns. Or '+'you can tell us to ignore some of your columns for this import.</p><br>';help+="<p>You can add columns to Shotgun that don't yet exist on a Shot page if you have permission. "+"Learn how to do that "+'<a href="'+SG.globals.help_urls.create_field+'" target="_blank">here</a>.';help+="</p><br>Read more about importing or watch a tutorial video "+this.help_link()+".";this.help_container.update(this.templates.help.apply({title:title,help:help}));},on_table_div_scroll:function(e)
{var w=this.table_div.getWidth();this.data_div.setWidth(this.table_div.dom.scrollLeft+w-2);},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.on_table_div_scroll,this);this.grid_heading_drag_zone.destroy();},});SG.Importer.SplitterDragZone=function(config)
{Ext.apply(this,config);SG.Importer.SplitterDragZone.superclass.constructor.call(this,this.container,"splitters");this.scroll=false;this.setDragElId(this.proxy);};Ext.extend(SG.Importer.SplitterDragZone,Ext.dd.DD,{handleMouseDown:function(e){var t=Ext.get(e.getTarget());this.splitter=null;if(t.hasClass("resize_splitter"))
{this.splitter=t;Ext.dd.DDProxy.prototype.handleMouseDown.apply(this,arguments);}},b4StartDrag:function(x,y)
{if(!this.splitter)
return;var left=this.splitter.getX();var top=this.splitter.getY();this.setDelta(x-left-4,y-top);this.start_x=x;this.splitter_index=this.splitter.dom.getAttribute('index');this.headers=Ext.DomQuery.select('td[index="'+this.splitter_index+'"]',this.container.dom);this.tables=Ext.DomQuery.select('table.header',this.container.dom);this.start_table_width=Ext.fly(this.tables[0]).getWidth();this.start_header_width=Ext.fly(this.headers[0]).getWidth();this.resetConstraints();this.setYConstraint(0,0);this.proxy.setVisible(true);},onDrag:function(e){var diff=e.xy[0]-this.start_x;if(this.start_header_width+diff<20)
diff=20-this.start_header_width;for(var i=0;i<this.headers.length;i++)
{Ext.fly(this.headers[i]).setWidth(this.start_header_width+diff);Ext.fly(this.tables[i]).setWidth(this.start_table_width+diff);}},endDrag:function(e)
{this.proxy.setVisible(false);var end_x=Ext.lib.Event.getPageX(e);var diff=end_x-this.start_x;if(this.start_header_width+diff<20)
diff=20-this.start_header_width;this.step.set_column_width(this.splitter_index,this.start_header_width+diff);this.step.render_step();},});SG.Importer.PickIdFields=function(config)
{Ext.apply(this,config);SG.Importer.PickIdFields.superclass.constructor.call(this);};Ext.extend(SG.Importer.PickIdFields,SG.Importer.Step,{templates:{main:'<div class="sgc_importer_pick_id_fields"><div class="contents"></div></div>',header_message:'<div class="header_message">'+'If you would like us to update {entity} that already exist, tell us what column(s) we should use to '+'look them up.  Leave everything unchecked if you want to create all new {entity}.</div>',disabled_fields_message:'<div class="header_message">'+'The following fields can not be selected because they were not included for all Steps in your '+'import data.</div>',row:'<tr><td class="check"><div class="check"><input class="id" type="checkbox" {disabled} {checked} '+'index="{index}"></div></td><td><div class="column_name">{column}</div></td></tr>',table:'<div class="column_table">'+'<table><tr class="header"><td class="check"><div class="id">Use as id</div></td>'+'<td><div class="column_name">Column</div></td></tr>{rows}</table></div>',},on_first_render:function()
{this.container.update(this.templates.main.apply());this.contents_div=this.container.child('div.contents');this.add_event(this.contents_div,'click',this.on_click);this.construct_schema_field_lists();},render_step:function()
{this.contents_div.update(this.render_contents());this.render_help();this.set_id_fields();this.importer.step_ready();},render_contents:function()
{var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var html='';if(this.entity_schema_fields.length>0)
{var dnp=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];html+=this.templates.header_message.apply({entity:dnp});var column_display_names=this.step_data.get_column_display_names();html+=this.render_table(this.entity_schema_fields,column_display_names,false);}
if(this.pivot_schema_fields.length>0)
{var dnp=SG.schema.entity_types['Task']['display_name_pluralized'];html+=this.templates.header_message.apply({entity:dnp});html+=this.render_table(this.pivot_schema_fields,{},false);}
if(this.disabled_pivot_schema_fields.length>0)
{html+=this.templates.disabled_fields_message.apply();var column_display_names={};html+=this.render_table(this.disabled_pivot_schema_fields,{},true);}
return html;},is_schema_field_used_for_id:function(schema_field)
{var id_schema_fields=this.step_data.get_id_fields();for(var i=0;i<id_schema_fields.length;i++)
{var id_schema_field=id_schema_fields[i];if(id_schema_field.entity_type==schema_field.entity_type&&id_schema_field.name==schema_field.name)
return true;}
return false;},render_table:function(schema_fields,column_display_names,all_disabled)
{var rows='';for(var i=0;i<schema_fields.length;i++)
{var schema_field=schema_fields[i];var checked=this.is_schema_field_used_for_id(schema_field)?'checked':'';var disabled=all_disabled?'disabled':'';var display_name;if(column_display_names&&column_display_names[schema_field.name])
display_name=column_display_names[schema_field.name]+' ('+schema_field.display_name+')';else
display_name=schema_field.display_name;rows+=this.templates.row.apply({disabled:disabled,checked:checked,column:display_name,index:schema_field.index});}
return this.templates.table.apply({rows:rows});},set_id_fields:function()
{var header_map=this.step_data.get_header_map();var id_fields=[];var inputs=Ext.DomQuery.select('input.id',this.contents_div.dom);for(var i=0;i<inputs.length;i++)
{var check=inputs[i];if(!check.disabled&&check.checked)
{var index=Number(check.getAttribute('index'));var entity_schema_field=header_map[index];id_fields.push(entity_schema_field);}}
this.step_data.set_id_fields(id_fields);},on_click:function(e)
{var target=Ext.get(e.getTarget());var id_input=target.findParent('input.id',this.contents_div);if(id_input)
{var me=this;setTimeout(function(){me.set_id_fields();},1);}},validate_data:function()
{return true;},construct_schema_field_lists:function()
{var id_fields=[];this.entity_schema_fields=[];this.pivot_schema_fields=[];this.disabled_pivot_schema_fields=[];var i;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var pivot_column_names_map={};for(i=0;i<header_map.length;i++)
{var entity_schema_field=header_map[i];if(entity_schema_field==null)
continue;entity_schema_field.index=i;var pivot_schema_field=pivot_column_map[i];if(pivot_schema_field==null)
{this.entity_schema_fields.push(entity_schema_field);if(entity_schema_field.name=='id')
id_fields.push(entity_schema_field);}
else
{if(pivot_column_names_map[pivot_schema_field.name])
{var col_name_array=pivot_column_names_map[pivot_schema_field.name];col_name_array.push(entity_schema_field.name);}
else
{var col_name_array=[];col_name_array.push(entity_schema_field.name);pivot_column_names_map[pivot_schema_field.name]=col_name_array;}}}
for(i=0;i<header_map.length;i++)
{var pivot_schema_field=pivot_column_map[i];var entity_schema_field=header_map[i];if(entity_schema_field==null||pivot_schema_field==null)
continue;entity_schema_field.index=i;var in_all_pivot_columns=true;for(var pivot_col_name in pivot_column_names_map)
{if(!pivot_column_names_map.hasOwnProperty(pivot_col_name))
continue;var col_name_array=pivot_column_names_map[pivot_col_name];if(col_name_array.indexOf(entity_schema_field.name)==-1)
{in_all_pivot_columns=false;break;}}
if(in_all_pivot_columns)
{var already_in=false;for(var j=0;j<this.pivot_schema_fields.length;j++)
{var existing_pivot_schema_field=this.pivot_schema_fields[j];if(existing_pivot_schema_field.name==entity_schema_field.name)
{already_in=true;break;}}
if(!already_in)
{this.pivot_schema_fields.push(entity_schema_field);if(entity_schema_field.name=='id')
id_fields.push(entity_schema_field);}}
else
{var already_in=false;for(var j=0;j<this.disabled_pivot_schema_fields.length;j++)
{var existing_pivot_schema_field=this.disabled_pivot_schema_fields[j];if(existing_pivot_schema_field.name==entity_schema_field.name)
{already_in=true;break;}}
if(!already_in)
this.disabled_pivot_schema_fields.push(entity_schema_field);}}
this.step_data.set_id_fields(id_fields);},render_help:function()
{var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'].toLowerCase();var entity=SG.schema.entity_types[this.entity_type]['display_name'].toLowerCase();var title='Step 3: Specify ID columns';var help='<p>Choose one or more columns to use as a unique ID so we can find any existing '+
entities+' in your project.</p><br>';help+="<p>If we find a single match, we'll update that "+entity+" with the data you are importing. "+"If we find multiple "+entities+", you will have to fix your data and retry the import. "+"If we don't find a match, we'll create a new shot.</p><br>";help+="<p>If you are importing data you exported from Shotgun, choose the Id column, which is the unique "+"Shotgun Id for each "+entity+".</p><br>";help+="<p>If you don't want to update existing "+entities+" and want to create all new "+
entities+", uncheck all columns."+"</p><br>";help+='<p>Read more about importing or watch a tutorial video '+this.help_link()+'.</p>';this.help_container.update(this.templates.help.apply({title:title,help:help}));},});SG.Importer.Preview=function(config)
{Ext.apply(this,config);SG.Importer.Preview.superclass.constructor.call(this);};Ext.extend(SG.Importer.Preview,SG.Importer.Step,{templates:{cell:'<td class="{cell_classes}" style="{cell_styles};width:{width}px;" {cell_attributes}>'+'<div class="cutter">{cell_content}</div></td>',summary:'<div class="summary_line {error}"><table><tr><td style="width:14px;"><div class="swatch"></div></td>'+'<td><div class="text">{text}</div></td></tr></table></div>',},set_record_data:function(schema_field,record,row_data)
{if(schema_field.data_type=='date')
{var parsed=SG.GridEditor.DateParser.parse(row_data);if(parsed!=null)
{var ds_format=SG.GridEditor.DateParser.data_store_format(parsed);record.set(schema_field.name,ds_format);}
else
record.set(schema_field.name,row_data);}
else if(schema_field.data_type=='date_time')
{var parsed=SG.GridEditor.DateTimeParser.parse(row_data);if(parsed!=null)
{var ds_format=SG.GridEditor.DateTimeParser.data_store_format(parsed);record.set(schema_field.name,ds_format);}
else
record.set(schema_field.name,row_data);}
else if(schema_field.data_type=='duration')
{var duration_editor=new SG.GridEditor.Duration();var parsed=duration_editor.parse_duration_string_into_minutes(row_data);record.set(schema_field.name,parsed);}
else if(schema_field.data_type=='checkbox')
{if(row_data.toLowerCase()=='x')
record.set(schema_field.name,1);else
record.set(schema_field.name,0);}
else if(schema_field.data_type=='entity')
{var val=this.trim_ws(row_data);if(val.length==0)
record.set(schema_field.name,{});else
record.set(schema_field.name,{name:val,valid:'autocomplete'});}
else if(schema_field.data_type=='multi_entity')
{var new_ens=[];var ens=row_data.split(',');for(var z=0;z<ens.length;z++)
{var val=this.trim_ws(ens[z]);if(val.length>0)
new_ens.push({name:ens[z],valid:'autocomplete'});}
record.set(schema_field.name,new_ens);}
else if(schema_field.data_type=='timecode')
{var val=this.trim_ws(row_data);if(val==='')
record.set(schema_field.name,'');else
{var tc_editor=new SG.GridEditor.Timecode();tc_editor.record=record;tc_editor.column_name=schema_field.name;var status=tc_editor.validate(val);if(status!="valid")
tc_editor.put_value_in_data_store(val,"invalid_entry",status);else
tc_editor.put_value_in_data_store(val);}}
else
record.set(schema_field.name,row_data);},trim_ws:function(str)
{var s=str.replace(/^\s+|\s+$/g,'');return s;},get_project_id_for_record:function(record)
{if(this.step_data.get_project())
return this.step_data.get_project().id;else
{var project_value=record.get('project');if(project_value&&project_value.id!=undefined)
return project_value.id;else
{if(!project_value)
return-1;if(this.project_id_map==undefined)
this.construct_project_id_map();if(!this.project_id_map[project_value.name])
return-1;else
return this.project_id_map[project_value.name];}}},construct_project_id_map:function()
{this.project_id_map={};var list=SG.schema.projects;for(var i=0;i<list.length;i++)
{var project=list[i];this.project_id_map[project.name]=project.id;}},replace_entity_field_in_record:function(entity_type,schema_field,record)
{var row_project_id=this.get_project_id_for_record(record);if(schema_field.data_type=='entity')
{var map_key=entity_type+"."+schema_field.name;if(this.entity_map[map_key])
{var map=this.entity_map[map_key];var current_value=record.get(schema_field.name);if(current_value&&current_value.name!=undefined)
{var key=current_value.name.toLowerCase()+'_'+row_project_id;if(map[key])
{record.set(schema_field.name,map[key]);return;}}
record.set(schema_field.name,'');}}
else if(schema_field.data_type=='multi_entity')
{var map_key=entity_type+"."+schema_field.name;if(this.entity_map[map_key])
{var map=this.entity_map[map_key];var current_value=record.get(schema_field.name);if(!current_value)
{record.set(schema_field.name,[]);return;}
var new_value=[];for(var j=0;j<current_value.length;j++)
{var key=undefined;var cv=current_value[j];if(cv!=undefined&&cv.name)
key=this.trim_ws(cv.name.toLowerCase())+'_'+row_project_id;if(key!=undefined&&map[key])
new_value.push(map[key]);else
new_value.push(cv);}
record.set(schema_field.name,new_value);}}},render_count_summaries:function(count_map,is_pivot_preview)
{var create=count_map['create'];var update=count_map['update'];var error_row_not_unique=count_map['error_row_not_unique'];var duplicate_row_in_import_data=count_map['duplicate_row_in_import_data'];var entity=SG.schema.entity_types[this.entity_type]['display_name'];var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];var h='';if(create&&create>0)
{var entity_name=create==1?entity:entities;var text=create+' '+entity_name+' will be Created.';h+=this.templates.summary.apply({error:'created',text:text});}
if(update&&update>0)
{var entity_name=update==1?entity:entities;var text=update+' '+entity_name+' will be Updated.';h+=this.templates.summary.apply({error:'updated',text:text});}
if(duplicate_row_in_import_data&&duplicate_row_in_import_data>0)
{var entity_name=duplicate_row_in_import_data==1?entity:entities;var text=duplicate_row_in_import_data+' '+entity_name+' are duplicates in the import data and '+'will be not be included in the import.';h+=this.templates.summary.apply({error:'duplicate',text:text});}
if(error_row_not_unique&&error_row_not_unique>0)
{var entity_name=error_row_not_unique==1?entity+' has':entities+' have';var end_message='(please fix before continuing)';if(is_pivot_preview)
end_message='(you need to provide an id column in the import data to differentiate Tasks)';var text=error_row_not_unique+' '+entity_name+' more than more match. '+end_message;h+=this.templates.summary.apply({error:'not_unique',text:text});}
return h;},});SG.Importer.EntityPreview=function(config)
{Ext.apply(this,config);SG.Importer.EntityPreview.superclass.constructor.call(this);};Ext.extend(SG.Importer.EntityPreview,SG.Importer.Preview,{templates:{main:'<div class="sgc_importer_preview {pivot_columns}">'+'<div class="summary"></div>'+'<div class="preview"><div class="header"></div>'+'<div class="data"></div><div class="resize_proxy"></div></div>'+'<div class="pagination sgc_footer"></div></div>',header_cell:'<td style="width:{width}px;" index="{index}"><div class="cutter header_cell">{value}</div></td>',pivot_header_cell:'<td style="width:{width}px;">'+'<div style="background-color:rgb({color});color:{text_color};" class="cutter header_cell">'+'<center>{value}</center></div></td>',row:'<div class="row {extra}"><table style="width:{table_width}px;" class="{table_class}"><tr>'+'<td class="row_status" style="width:20px;"><div>{row_status}</div></td>{cells}</tr></table></div>',status_cell:'<td class="row_status {row_status}" style="width:20px;"><div>&nbsp</div></td>',empty_cell:'<td style="width:{width}px;" index="{index}">&nbsp</td>',error_cell:'<td style="width:{width}px;" index="{index}"><div class="cell_error_menu_pad">'+'<div class="cell_error_menu" index="{index}"><div class="text">{error_count} errors</div>'+'<div class="swatch"></div><img src="/images/dropdown_arrow_small.png"/></div></div></td>',row_filter_menu:'<div class="row_filter_menu"><img src="/images/dropdown_arrow_small.png"/></div>',paging_controls:'<div class="paging_controls">'+'<img src="/images/left_arrow_{prev_enabled}.png" class="arrow {prev_enabled}" page="{prev_page}"/>'+'<span class="page">Page</span>'+'<input type="text" name="paging_input" class="entity_list_paging_input {input_enabled}" '+' value="{current_page}" page_count="{page_count}" onFocus="this.select();" '+'style="width:{width}px;"/>'+'<span class="page_count"> / {page_count}</span>'+'<img src="/images/right_arrow_{next_enabled}.png" page="{next_page}" '+'class="arrow {next_enabled}"/></div>',non_unique_error:'<br>The value already in use is: <span style="color:red">{value}</span><br><br>',},init_component:function()
{this.data_filter='_rows_all_';this.current_page=1;},on_first_render:function()
{var pivot_preview_config={entity_preview:this,container:this.container,step_data:this.step_data};this.pivot_preview=new SG.Importer.PivotPreview(pivot_preview_config);var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];this.container.update(this.templates.main.apply({entities:entities,pivot_columns:this.pivot_preview.has_pivot_columns()?'pivot_columns':''}));this.summary_div=this.container.child('div.summary');this.preview_div=this.container.child('div.preview');this.pagination_div=this.container.child('div.pagination');this.table_header_div=this.preview_div.child('div.header');this.table_data_div=this.preview_div.child('div.data');this.resize_proxy=this.container.child('div.resize_proxy');this.add_event(this.preview_div,'scroll',this.on_preview_div_scroll);this.add_event(this.preview_div,'click',this.on_preview_div_click);this.add_event(this.pagination_div,'click',this.on_pagination_div_click);this.add_event(this.pagination_div,'change',this.on_pagination_div_change);Ext.EventManager.onWindowResize(this.on_preview_div_scroll,this,true);var row_count=this.remove_summary_row_data();if(row_count==0)
{this.importer.data_is_all_summary_rows();return;}
this.construct_data_set();var step_project=this.step_data.get_project();var projects;if(!step_project)
projects=SG.schema.projects;else
projects=[step_project];var cell_config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:projects,autocommit:false,edit_applied_callback:{fn:this.on_cell_manager_edit,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.validate_rows();var dnd_config={step:this,container:this.container,proxy:this.resize_proxy};this.grid_heading_drag_zone=new SG.Importer.SplitterDragZone(dnd_config);this.render_help();},validate_data:function()
{this.importer.step_busy();var row_errors=0;if(this.status_counts['error_row_not_unique'])
row_errors+=this.status_counts['error_row_not_unique'];row_errors+=this.pivot_preview.get_row_error_count();var total_errors=row_errors+this.cell_error_count;if(total_errors>0)
{var error=total_errors==1?'error':'errors';alert('The import data contains '+total_errors+' '+error+' that must be resolved before import'+' can be done.');this.importer.step_ready('Import');return false;}
else if(this.cell_error_count>0)
{this.render_step();if(this.cell_error_count>0)
{var error=this.cell_error_count==1?'error':'errors';alert('The import data contains '+this.cell_error_count+' '+error+' that must be resolved before import can be done.');this.importer.step_ready('Import');return false;}}
else
{var count=this.check_for_blank_identifier_fields();if(count>0)
{var ident_field=SG.schema.get_identifier_field(this.entity_type);var ident_field_dn=SG.schema.entity_fields[this.entity_type][ident_field]['display_name'];var dn=SG.schema.entity_types[this.entity_type]['display_name'];var dnp,rows,last;if(count==1)
{rows='row';dnp=dn;last=' That '+dn+' must be fixed before an import can be done.';}
else
{rows='rows';dnp=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];last=' Those '+dnp+' must be fixed before an import can be done.';}
alert('The import data contains '+count+' '+rows+' where the identifier field '+'('+ident_field_dn+') for the '+dn+' is blank.'+last);this.importer.step_ready('Import');return false;}
count=this.pivot_preview.check_for_blank_identifier_fields();if(count>0)
{var entity_type=this.pivot_preview.entity_type;var ident_field=SG.schema.get_identifier_field(entity_type);var ident_field_dn=SG.schema.entity_fields[entity_type][ident_field]['display_name'];var dn=SG.schema.entity_types[entity_type]['display_name'];var dnp,rows,last;if(count==1)
{rows='row';dnp=dn;last=' That '+dn+' must be fixed before an import can be done.';}
else
{rows='rows';dnp=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];last=' Those '+dnp+' must be fixed before an import can be done.';}
alert('The import data contains '+count+' '+rows+' where the identifier field '+'('+ident_field_dn+') for the '+dn+' is blank.'+last);this.importer.step_ready('Import');return false;}}
this.data_filter='_rows_all_';this.render_preview();if(this.entity_type=='Booking')
this.set_project_for_booking_entity();this.send_import_request();return false;},set_project_for_booking_entity:function(){var project=SG.schema.projects[0];for(var i=0;i<this.data_set.count();i++){var rec=this.data_set.get_record(i);if(!rec.get('vacation'))continue;rec.set('project',project);}},check_for_blank_identifier_fields:function()
{var i;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var ident_field=null;for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null||pivot_schema_field!=null)
continue;if(schema_field.identifier_column)
{ident_field=schema_field;break;}}
if(ident_field==null||ident_field.name=='id')
return 0;var count=0;for(i=0;i<this.data_set.count();i++)
{var record=this.data_set.get_record(i);var value=record.get(ident_field.name);if(value!=null)
value=this.trim_ws(value);if(value==null||value.length==0)
count++;}
return count;},render_step:function()
{if(this.data_loaded)
{this.render_preview();this.render_summary();}},on_cell_manager_edit:function(field,record,cell)
{var me=this;setTimeout(function(){me.render_step();},1);},render_summary:function()
{this.cell_error_count=0;this.status_counts={};for(var i=0;i<this.row_statuses.length;i++)
{var row_status=this.row_statuses[i];if(!this.status_counts[row_status])
this.status_counts[row_status]=1;else
this.status_counts[row_status]+=1;}
var h='';if(this.summary_data_has_been_removed)
{h+=this.templates.summary.apply({error:'warning',text:'It looks as though the input data contained rows that were summaries, those have been removed.'});}
h+=this.render_count_summaries(this.status_counts);h+=this.pivot_preview.render_summary();for(var field_name in this.cell_errors)
{if(!this.cell_errors.hasOwnProperty(field_name))
continue;var count=this.cell_errors[field_name];this.cell_error_count+=count;}
if(this.cell_error_count>0)
{var text=this.cell_error_count+' cell errors. (please fix before continuing)';h+=this.templates.summary.apply({error:'cell_error',text:text});}
this.summary_div.update(h);},render_preview:function()
{this.cell_errors={};var i;var data='';var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var visible_records=this.get_filtered_records(header_map,pivot_column_map);this.render_pagination(visible_records);var start=(this.current_page-1)*50;var end=this.current_page*50;end=end>visible_records.length?visible_records.length:end;for(i=start;i<end;i++)
{record=visible_records[i];data+=this.render_row(record._row_index_,record,header_map,pivot_column_map);}
this.table_header_div.update(this.render_header());this.table_data_div.update(data);this.on_preview_div_scroll();},render_header:function()
{var html='';var header_cells='';var splitters='';var table_width=20;var column_display_names=this.step_data.get_column_display_names();var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var is_pivot_columns=this.pivot_preview.has_pivot_columns();for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field!=null)
{var w=this.get_column_width(i);table_width+=w;if(this.is_pivot_column_left_edge(i,pivot_column_map))
{header_cells+=this.templates.empty_cell.apply({width:20,index:-1});table_width+=20;}
var display_name;if(pivot_schema_field==null&&column_display_names[schema_field.name])
display_name=column_display_names[schema_field.name];else
display_name=schema_field.display_name;header_cells+=this.templates.header_cell.apply({value:display_name,width:w,index:i});splitters+=this.templates.splitter.apply({index:i,left:table_width});}}
var header=this.templates.row.apply({extra:'header',table_width:table_width,cells:header_cells,table_class:'header',row_status:''});header+=splitters;var error_cells='';var table_width=20;for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field!=null)
{var w=this.get_column_width(i);table_width+=w;if(this.is_pivot_column_left_edge(i,pivot_column_map))
{error_cells+=this.templates.empty_cell.apply({width:20,index:-1});table_width+=20;}
var error_count=this.cell_errors[i];if(error_count)
error_cells+=this.templates.error_cell.apply({width:w,error_count:error_count,index:i});else
error_cells+=this.templates.empty_cell.apply({width:w,index:i});}}
var error_header=this.templates.row.apply({extra:'header menu',table_width:table_width,cells:error_cells,table_class:'header',row_status:this.templates.row_filter_menu.apply()});var pivot_column_header=is_pivot_columns?this.render_pivot_column_header():'';return error_header+pivot_column_header+header;},is_pivot_column_left_edge:function(i,pivot_column_map)
{if(i==0&&pivot_column_map[i]!=null)
return true;else if(i==0)
return false;if(pivot_column_map[i]!=null)
{if(pivot_column_map[i-1]==null||pivot_column_map[i-1].name!=pivot_column_map[i].name)
return true;}
return false;},render_pivot_column_header:function()
{var html;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var i;var header_schema_fields=[];var widths=[];for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null)
continue;var w=this.get_column_width(i);if(pivot_schema_field==null)
{header_schema_fields.push(schema_field);widths[schema_field.name]=w;}
else
{if(widths[pivot_schema_field.name])
widths[pivot_schema_field.name]+=w;else
{widths[pivot_schema_field.name]=w;header_schema_fields.push(pivot_schema_field);}}}
var header_cells='';var table_width=20;for(i=0;i<header_schema_fields.length;i++)
{var schema_field=header_schema_fields[i];var w=widths[schema_field.name];table_width+=w;if(schema_field.data_type!='pivot_column')
header_cells+=this.templates.empty_cell.apply({width:w,index:i});else
{var step=SG.schema.get_step_entity(this.entity_type,schema_field.name);var parts=step.color.split(',');var avg=(Number(parts[0])+Number(parts[0])+Number(parts[0]))/3;var text_color=avg<127?'white':'black';w+=20;table_width+=20;header_cells+=this.templates.pivot_header_cell.apply({value:schema_field.display_name,width:w,color:step.color,text_color:text_color});}}
return this.templates.row.apply({extra:'header',table_width:table_width,cells:header_cells,table_class:'header',row_status:''});},render_row:function(row_index,record,header_map,pivot_column_map)
{var cell_html='';var table_width=20;for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null)
continue;var w=this.get_column_width(i);table_width+=w;if(this.is_pivot_column_left_edge(i,pivot_column_map))
{var pivot_row_status=this.pivot_preview.get_row_status(pivot_schema_field.name,row_index);cell_html+=this.templates.status_cell.apply({row_status:pivot_row_status});table_width+=20;}
if(pivot_schema_field==null)
{var cell=this.cell_manager.get_cell(schema_field.name);var cell_params=cell.render(record);cell_params.width=w;cell_html+=this.templates.cell.apply(cell_params);}
else
cell_html+=this.pivot_preview.render_cell(row_index,w,record,schema_field,pivot_schema_field);}
return this.templates.row.apply({extra:this.row_statuses[row_index],table_width:table_width,cells:cell_html,table_class:'data',row_status:''});},validate_row_cells:function(rec,header_map,pivot_column_map,clear_this_field)
{var cell_manager,record;var row_cell_errors=[];for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null)
continue;if(pivot_schema_field==null)
{record=rec;cell_manager=this.cell_manager;}
else
{record=this.pivot_preview.fetch_record(pivot_schema_field.name,rec._row_index_);cell_manager=this.pivot_preview.get_cell_manager();}
if(!record)
continue;var cell=cell_manager.get_cell(schema_field.name);var validate;if(schema_field.data_type=='timecode')
{validate=record.get_status(schema_field.name);if(validate!='valid')
{var error=record.get_error(schema_field.name);validate=error.description||validate;}}
else
validate=cell.validate(record);if(validate!='valid')
{if(clear_this_field&&i==clear_this_field)
this.clear_field(record,schema_field);else
{var error={type:"invalid_entry",description:validate};record.set(schema_field.name,record.get(schema_field.name),error);if(this.cell_errors[i])
this.cell_errors[i]++;else
this.cell_errors[i]=1;row_cell_errors.push(schema_field.name);}}}
return row_cell_errors;},clear_field:function(record,schema_field)
{if(schema_field.data_type=='multi_entity')
record.set(schema_field.name,[]);else
record.set(schema_field.name,'');},remove_summary_row_data:function()
{var i,j;var header_schema_field;var header_map=this.step_data.get_header_map();var remove_summary_rows=false;for(j=0;j<header_map.length;j++)
{header_schema_field=header_map[j];if(header_schema_field!=null&&header_schema_field.name=="id")
{remove_summary_rows=true;break;}}
if(!remove_summary_rows)
return;var new_rows=[];var rows=this.step_data.get_rows();for(i=0;i<rows.length;i++)
{var remove_row=false;var row=rows[i];for(j=0;j<header_map.length;j++)
{header_schema_field=header_map[j];if(header_schema_field==null)
continue;if(header_schema_field.name=='id')
{if(row[j]=="SUMMARY_ROW")
{remove_row=true;break;}}}
if(!remove_row)
new_rows.push(row);}
if(new_rows.length!=rows.length)
{this.summary_data_has_been_removed=true;this.step_data.set_rows(new_rows);return new_rows.length;}
else
return rows.length;},construct_data_set:function()
{var pivot_column_map=this.step_data.get_pivot_column_map();var header_map=this.step_data.get_header_map();var rows=this.step_data.get_rows();this.data_set=this.new_data_set(this.entity_type);var require_project=this.is_project_data_required();var set_task_template=this.has_task_template_as_parent_entity();var i,j;for(i=0;i<rows.length;i++)
{var row=rows[i];var record=this.data_set.new_record();record._row_index_=i;for(j=0;j<header_map.length;j++)
{var header_schema_field=header_map[j];var pivot_schema_field=pivot_column_map[j];if(header_schema_field==null||pivot_schema_field!=null)
continue;if(require_project&&header_schema_field.name=='project')
{if(!row[j]||row[j]=='')
row[j]='_Invalid_Project_';}
this.set_record_data(header_schema_field,record,row[j]);}
if(set_task_template)
record.set('task_template',this.parent_entity);}
this.pivot_preview.construct_data_set();if(set_task_template)
{var schema_field=SG.schema.get_field('Task','task_template');header_map.push(schema_field);this.step_data.set_header_map(header_map);}},validate_rows:function()
{this.pi=new SG.ProgressIndicator();this.pi.show();var i;this.row_statuses=[];this.cell_errors={};this.id_map={};var rows=this.step_data.get_rows();for(i=0;i<rows.length;i++)
this.row_statuses.push('create');this.weed_out_duplicate_input_rows();var id_fields=this.step_data.get_id_fields();if(id_fields.length==0)
{this.validate_entity_fields();return;}
id_fields=this.step_data.get_id_fields(this.entity_type);if(id_fields.length==0)
{this.required_load_count=0;this.load_count=0;this.pivot_preview.validate_rows(true);return;}
for(i=0;i<id_fields.length;i++)
{var id_field=id_fields[i];if(id_field.name=='id')
{id_fields=[id_field];break;}}
var id_indexes=[];var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();for(i=0;i<id_fields.length;i++)
{for(var j=0;j<header_map.length;j++)
{var schema_field=header_map[j];var pivot_schema_field=pivot_column_map[j];if(schema_field==null||pivot_schema_field!=null)
continue;if(schema_field.name==id_fields[i].name)
{id_indexes.push(j);break;}}}
var project=this.step_data.get_project();var spec;SG.Repo.start_batch();for(i=0;i<rows.length&&id_fields.length>0;i++)
{var row=rows[i];var conditions=[];var columns=[];for(var j=0;j<id_fields.length;j++)
{var id_field=id_fields[j];var index=['entity','multi_entity'].indexOf(id_field.data_type);var relation=index==-1?'is':'name_is';conditions.push({path:id_field.name,relation:relation,values:[row[id_indexes[j]]]});columns.push(id_field.name);}
if(project)
conditions.push({path:'project',relation:"is",values:[project]});var data_set=new SG.Data.Set(this.entity_type);data_set.import_row_index=i;this.add_event(data_set,'load',this.on_validate_row);spec={type:this.entity_type,columns:columns,filters:{logical_operator:"and",conditions:conditions},result:data_set};SG.Repo.query(spec);}
this.pivot_preview.validate_rows();SG.Repo.end_batch();this.required_load_count=rows.length;this.load_count=0;},on_validate_row:function(data_set)
{var count=data_set.count();var row_index=data_set.import_row_index;this.load_count++;if(count==1)
{var found_rec=data_set.get_record(0);if(this.id_map[found_rec.id]==undefined)
{var record=this.data_set.get_record(row_index);this.row_statuses[row_index]='update';delete this.data_set.id_map[record.id];record.id=found_rec.get_id();this.data_set.id_map[record.id]=record;this.id_map[record.id]=true;}
else
{this.row_statuses[row_index]='duplicate_row_in_import_data';}}
else if(count>1)
this.row_statuses[row_index]='error_row_not_unique';if(this.done_validating_rows()&&this.pivot_preview.done_validating_rows())
this.validate_entity_fields();},done_validating_rows:function()
{return(this.load_count>=this.required_load_count);},validate_entity_fields:function()
{var valid_types=['entity','multi_entity'];this.entity_map={};var requests=[];var project_id=null;if(this.step_data.get_project())
project_id=this.step_data.get_project().id;var i;var all_project_ids=[];for(i=0;i<SG.schema.projects.length;i++)
all_project_ids.push(SG.schema.projects[i].id);this.autocomplete_filter_fields=[];var header_map=this.step_data.get_header_map();for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field==null||valid_types.indexOf(schema_field.data_type)==-1)
continue;if(schema_field.autocomplete_entity_filters!=undefined||this.check_for_task_field_on_notes(schema_field,header_map)||this.check_for_step_field_on_tasks(schema_field,header_map))
{this.autocomplete_filter_fields.push(schema_field);continue;}
if(this.entity_type=='Task'&&schema_field.name=='task_template')
continue;var is_multi_entity=schema_field.data_type=='multi_entity';var unique_data=this.get_unique_values_from_columns(i,is_multi_entity,project_id);for(var j=0;j<unique_data.length;j++)
{var data=unique_data[j];var value={name:data.name,valid:"autocomplete"};var req={request_type:"validate",type:schema_field.entity_type,id:-1,column:schema_field.name,project_id:data.project_id?data.project_id:-1};if(data.project_id!=-1)
value.project_ids=[data.project_id];else
value.project_ids=all_project_ids;if(is_multi_entity)
req.value=[value];else
req.value=value;requests.push(req);}}
var me=this;var handler=new SG.ResponseHandler;handler.handle_response=function(response,request)
{if(response.status==='successful')
{if(response.value instanceof Array)
{var vals=response.value;for(var i=0;i<vals.length;i++)
{var v=vals[i];var map_key=request.type+'.'+request.column;if(!me.entity_map[map_key])
me.entity_map[map_key]={};if(v&&v.name)
{var entity_key=v.name.toLowerCase()+'_'+request.project_id;me.entity_map[map_key][entity_key]=v;}}}
else
{var map_key=request.type+'.'+request.column;if(!me.entity_map[map_key])
me.entity_map[map_key]={};if(response.value&&response.value.name)
{var entity_key=response.value.name.toLowerCase()+'_'+request.project_id;me.entity_map[map_key][entity_key]=response.value;}}}};if(requests.length==0)
this.all_validation_done();else
{var request=new SG.CrudRequest(requests,handler,true);this.add_event(request,"completed",this.all_validation_done,this);request.send();}},check_for_task_field_on_notes:function(schema_field,header_map)
{if(schema_field.entity_type!='Note')
return false;if(schema_field.name!='tasks')
return false;if(this.check_for_task_field_on_notes_result==undefined)
{var note_links_found=false;for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field==null)continue;if(schema_field.name=='note_links')
{note_links_found=true;break;}}
this.check_for_task_field_on_notes_result=note_links_found;}
return this.check_for_task_field_on_notes_result;},check_for_step_field_on_tasks:function(schema_field,header_map)
{if(schema_field.entity_type!='Task')
return false;if(schema_field.name!='step')
return false;if(this.check_for_step_field_on_tasks_result==undefined)
{var link_field_found=false;for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field==null)continue;if(schema_field.name=='entity')
{link_field_found=true;break;}}
this.check_for_step_field_on_tasks_result=link_field_found;}
return this.check_for_step_field_on_tasks_result;},validate_autocomplete_filter_fields:function()
{var requests=[];var project_ids=[];if(this.step_data.get_project()){project_ids.push(this.step_data.get_project().id);}
for(var i=0;i<this.autocomplete_filter_fields.length;i++)
{var schema_field=this.autocomplete_filter_fields[i];for(var j=0;j<this.data_set.count();j++)
{var record=this.data_set.get_record(j);if(schema_field.entity_type=='Note'&&schema_field.name=='tasks')
{var req=this.generate_autocomplete_filters_for_note_tasks(record,project_ids);requests.push(req);continue;}
if(schema_field.entity_type=='Task'&&schema_field.name=='step')
{var req=this.generate_autocomplete_filters_for_task_step(record,project_ids);if(!req)
record.set(schema_field.name,null);else
requests.push(req);continue;}
var req_value=record.get(schema_field.name);if(schema_field.data_type=='entity')
{if(!req_value||!req_value.name)
{record.set(schema_field.name,null);continue;}}
else
{if(!req_value||(req_value.constructor==Array&&req_value.length==0))
{record.set(schema_field.name,[]);continue;}}
var types_and_filters=sg_deep_copy(schema_field.autocomplete_entity_filters);for(var t in types_and_filters)
{if(!types_and_filters.hasOwnProperty(t))
continue;this.substitute_filter_tokens(project_ids,record,types_and_filters[t]);}
req_value.project_ids=project_ids;var req={request_type:"validate",type:schema_field.entity_type,id:-1,column:schema_field.name,value:req_value,filters:types_and_filters,record_id:record.id,};requests.push(req);}}
var me=this;var handler=new SG.ResponseHandler;handler.handle_response=function(response,request)
{if(response.status==='successful')
{var record=me.data_set.get_record_by_id(request.record_id);record.set(response.column,response.value);}};if(requests.length==0)
this.autocomplete_filter_validation_done();else
{var request=new SG.CrudRequest(requests,handler,true);this.add_event(request,"completed",this.autocomplete_filter_validation_done,this);request.send();}},generate_autocomplete_filters_for_note_tasks:function(record,project_ids)
{var note_links=record.get('note_links');if(!note_links||note_links.length==0)
return null;var tasks=record.get('tasks');if(!tasks||tasks.length==0)
return null;tasks.sort(function(a,b){return a.name.localeCompare(b.name);});var tasks_no_dupes=[];var last_name="";for(var i=0;i<tasks.length;i++)
{var task=tasks[i];if(task.name!=last_name)
{tasks_no_dupes.push(task);last_name=task.name;}}
var conds=[];tasks.project_ids=project_ids;for(var i=0;i<note_links.length;i++)
{var link=note_links[i];var cond={path:"entity",relation:"is",values:[link]};conds.push(cond);}
var filter={logical_operator:'or',conditions:conds};var req={request_type:"validate",type:'Note',id:-1,column:'tasks',value:tasks_no_dupes,filters:{Task:filter},record_id:record.id,return_all:true};return req;},generate_autocomplete_filters_for_task_step:function(record,project_ids)
{var link_entity=record.get('entity');var link_entity_type=link_entity?link_entity.type:null;var filter={logical_operator:'and',conditions:[{path:"entity_type",relation:"is",values:[link_entity_type]}]};var req={request_type:"validate",type:'Task',id:-1,column:'step',value:record.get('step'),filters:{Step:filter},record_id:record.id,};return req;},autocomplete_filter_validation_done:function()
{this.data_loaded=true;this.render_step();this.importer.step_ready('Import');this.pi.hide();},all_validation_done:function()
{this.replace_entity_fields_in_data_set();if(this.autocomplete_filter_fields&&this.autocomplete_filter_fields.length>0)
{this.validate_autocomplete_filter_fields();return;}
this.data_loaded=true;this.render_step();this.importer.step_ready('Import');this.pi.hide();},replace_entity_fields_in_data_set:function()
{var header_map=this.step_data.get_header_map();for(var k=0;k<this.data_set.count();k++)
{var record=this.data_set.get_record(k);for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field==null||schema_field.entity_type!=this.entity_type)
continue;this.replace_entity_field_in_record(this.entity_type,schema_field,record);}}
this.pivot_preview.entity_map=this.entity_map;this.pivot_preview.replace_entity_fields_in_data_set(this.entity_map);},get_unique_values_from_columns:function(column_index,is_multi_entity,project_id)
{var rows=this.step_data.get_rows();var col_data=[];var i;for(i=0;i<rows.length;i++)
{var row=rows[i];var row_project_id=this.get_project_id_from_row_data(row,project_id);if(is_multi_entity)
{var entities=row[column_index].split(',');for(var j=0;j<entities.length;j++)
{var val=this.trim_ws(entities[j]);if(val.length>0)
col_data.push({name:val,project_id:row_project_id});}}
else
col_data.push({name:row[column_index],project_id:row_project_id});}
if(col_data.length==0)
return[];var unique_data=[];var sorted_data=col_data.sort(function(a,b){return a.name.localeCompare(b.name);});var last=sorted_data[0];unique_data.push(last);for(i=1;i<sorted_data.length;i++)
{if(sorted_data[i].name==last.name&&sorted_data[i].project_id==last.project_id)
continue;unique_data.push(sorted_data[i]);last=sorted_data[i];}
return unique_data;},get_project_id_from_row_data:function(row,project_id)
{if(project_id!=null)
return project_id;if(this.project_column_index==undefined)
{var header_map=this.step_data.get_header_map();for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(!schema_field)continue;if(schema_field.name=='project')
{this.project_column_index=i;break;}}}
if(this.project_column_index==undefined)
return-1;if(this.project_id_map==undefined)
this.construct_project_id_map();return this.project_id_map[row[this.project_column_index]];},send_import_request:function()
{this.row_ids={};this.import_errors=[];this.import_entity_ids=[];var requests=[];var project=this.step_data.get_project();var i,j;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();for(i=0;i<this.row_statuses.length;i++)
{var row_status=this.row_statuses[i];var record=this.data_set.get_record(i);if(row_status=='create')
{var columns=[];var values=[];for(j=0;j<header_map.length;j++)
{var schema_field=header_map[j];var pivot_schema_field=pivot_column_map[j];if(schema_field==null||pivot_schema_field!=null||schema_field.name=='id')
continue;columns.push(schema_field.name);values.push({column:schema_field.name,value:record.get(schema_field.name)});}
if(project)
{columns.push('project');values.push({column:'project',value:project});}
requests.push({request_type:'create',type:this.entity_type,columns:columns,field_values:values,row_index:i,});}
else if(row_status=='update')
{var id=record.get_id();for(j=0;j<header_map.length;j++)
{var schema_field=header_map[j];var pivot_schema_field=pivot_column_map[j];if(schema_field==null||pivot_schema_field!=null||schema_field.name=='id')
continue;requests.push({request_type:'update',type:this.entity_type,id:Number(id),column:schema_field.name,value:record.get(schema_field.name)});}
this.row_ids[i]=id;for(var k=i+1;k<this.row_statuses.length;k++)
{var row_status=this.row_statuses[k];if(row_status!='duplicate_row_in_import_data')
break;this.row_ids[k]=id;}}}
var me=this;var handler=new SG.ResponseHandler;handler.handle_response=function(response,request)
{if(response.status==='successful')
{if(response.request_type=='update')
{if(me.import_entity_ids.indexOf(response.id)==-1)
me.import_entity_ids.push(response.id);}
else
{var cols=response.columns;var vals=response.row;var index=cols.indexOf('id');var id=vals[index];me.row_ids[request.row_index]=id;me.import_entity_ids.push(id);for(var k=request.row_index+1;k<me.row_statuses.length;k++)
{var row_status=me.row_statuses[k];if(row_status!='duplicate_row_in_import_data')
break;me.row_ids[k]=id;}}}
else
me.import_errors.push(response);};var request=new SG.CrudRequest(requests,handler,true,true);this.add_event(request,"completed",this.all_entity_imports_done,this);request.send();},all_entity_imports_done:function()
{if(this.import_errors.length==0)
{if(this.pivot_preview.has_pivot_columns())
this.send_pivot_import_request();else
this.all_imports_done();}
else
{var html='There was a problem with the import; <br><br>';var unique_html='There was a problem with the import: ';var unique_field_error_count=0;for(var i=0;i<this.import_errors.length;i++)
{var error=this.import_errors[i];if(error.reason_code==61||error.reason_code==51)
{unique_field_error_count++;unique_html+=error.reason_description;var problem_value=this.extract_unique_constraint_error_field_value(error.raw_error);unique_html+=this.templates.non_unique_error.apply({value:problem_value});}
html+=error.reason_description+'<br>';}
if(unique_field_error_count>0)
{unique_html+=' Please go back and fix before continuing with the import.';new SG.NewDialog({title:"Import Error",body:unique_html,actions:[{label:'OK',callback:{fn:this.on_non_unique_server_error_dialog_closed,scope:this}}]});return;}
else
{html+='<br>Contact your shotgun administrator.';new SG.NewDialog({title:"Import Error",body:html,actions:[{label:'OK',callback:{fn:this.on_server_error_dialog_closed,scope:this}}]});return;}}},extract_unique_constraint_error_field_value:function(error)
{var i=error.indexOf(']');var problem_field=error.substr(1,i-1);i=error.indexOf('SET');var j=error.indexOf('WHERE');var update_string=error.slice(i+3,j);var parts=update_string.split(',');for(i=0;i<parts.length;i++)
{var vals=parts[i].split('=');j=vals[0].indexOf(problem_field);if(j!=-1)
{var problem_value=vals[1].replace(/\'/g,"");return problem_value;}}
return'';},on_non_unique_server_error_dialog_closed:function()
{this.importer.step_ready();},send_pivot_import_request:function()
{var requests=[];this.import_errors=[];for(var row_index in this.row_ids)
{if(!this.row_ids.hasOwnProperty(row_index))
continue;var record_id=this.row_ids[row_index];this.pivot_preview.add_import_requests(requests,record_id,row_index);}
var me=this;var handler=new SG.ResponseHandler;handler.handle_response=function(response,request)
{if(response.status!='successful')
me.import_errors.push(response);};var request=new SG.CrudRequest(requests,handler,true,true);this.add_event(request,"completed",this.all_pivot_imports_done,this);request.send();},all_pivot_imports_done:function()
{if(this.import_errors.length==0)
this.all_imports_done();else
{var html='There was a problem with the import; <br><br>';for(var i=0;i<this.import_errors.length;i++)
{var error=this.import_errors[i];html+=error.reason_description+'<br>';}
html+='<br>Contact your shotgun administrator.';new SG.NewDialog({title:"Import Error",body:html,actions:[{label:'OK',callback:{fn:this.on_server_error_dialog_closed,scope:this}}]});return;}},all_imports_done:function()
{var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var columns=[];for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null)
continue;if(pivot_schema_field!=null)
{if(columns.indexOf(pivot_schema_field.name)==-1)
columns.push(pivot_schema_field.name);}
else
columns.push(schema_field.name);}
var me=this;setTimeout(function(){me.importer.import_successful(me.import_entity_ids,columns);},1);},on_server_error_dialog_closed:function()
{var me=this;setTimeout(function(){me.importer.destroy();},1);},on_preview_div_scroll:function()
{var w=this.preview_div.getWidth();this.table_data_div.setWidth(this.preview_div.dom.scrollLeft+w-2);},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.on_preview_div_scroll,this);},on_preview_div_click:function(e)
{var target=Ext.get(e.getTarget());var row_filter_menu_div=target.findParent('div.row_filter_menu',this.preview_div);if(row_filter_menu_div)
{this.last_menu_div=row_filter_menu_div;if(!this.row_filter_menu)
{this.row_filter_menu=new SG.Menu({before_show:{fn:this.on_before_show_row_filter_menu,scope:this},item_selected:{fn:this.on_filter_menu_item_selected,scope:this}});}
this.row_filter_menu.show();}
var cell_error_menu_div=target.findParent('div.cell_error_menu',this.preview_div);if(cell_error_menu_div)
{this.last_menu_div=cell_error_menu_div;if(!this.cell_error_menu)
{this.cell_error_menu=new SG.Menu({before_show:{fn:this.on_before_show_cell_error_menu,scope:this},item_selected:{fn:this.on_filter_menu_item_selected,scope:this}});}
this.cell_error_menu.index=Number(cell_error_menu_div.getAttribute('index'));this.cell_error_menu.show();}},on_before_show_row_filter_menu:function(menu)
{var items=[];items.push({html:'Show all rows',checked:this.data_filter=='_rows_all_',value:'_rows_all_'});var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'];if(this.status_counts['create']&&this.status_counts['create']>0)
{var count=this.status_counts['create'];items.push({html:'Only show the '+count+' '+entities+' that will be created.',checked:this.data_filter=='_rows_created_',value:'_rows_created_',icon_name:'importer_swatch_green'});}
if(this.status_counts['update']&&this.status_counts['update']>0)
{var count=this.status_counts['update'];items.push({html:'Only show the '+count+' '+entities+' that will be updated.',checked:this.data_filter=='_rows_updated_',value:'_rows_updated_',icon_name:'importer_swatch_blue'});}
if(this.status_counts['error_row_not_unique']&&this.status_counts['error_row_not_unique']>0)
{var count=this.status_counts['error_row_not_unique'];items.push({html:'Only show the '+count+' '+entities+' that have more than one match.',checked:this.data_filter=='_rows_not_unique_',value:'_rows_not_unique_',icon_name:'importer_swatch_orange'});}
if(this.cell_error_count!=0)
{items.push({html:'Only show the rows with errors in any of the cells',checked:this.data_filter=='_rows_cell_errors_',value:'_rows_cell_errors_',icon_name:'importer_swatch_red'});}
menu.position={dom_elem:this.last_menu_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items;menu.render();},on_before_show_cell_error_menu:function(menu)
{var items=[];items.push({html:'Show all rows',checked:this.data_filter=='_rows_all_',value:'_rows_all_'});items.push({html:'Only show the '+this.cell_errors[menu.index]+' rows with errors.',checked:this.data_filter==menu.index,value:menu.index,icon_name:'importer_swatch_red'});items.push({line:true});items.push({html:'Clear values in cells with error',value:menu.index,item_selected:{fn:this.clear_cell_errors,scope:this}});items.push({html:'Do not import this column',value:menu.index,item_selected:{fn:this.remove_field_from_import,scope:this}});menu.position={dom_elem:this.last_menu_div,elem_anchor:'bl',menu_anchor:'tl'};menu.items=items;menu.render();},remove_field_from_import:function(menu,menu_item)
{var header_map=this.step_data.get_header_map();for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field!=null&&i==menu_item.value)
{header_map[i]=null;break;}}
this.step_data.set_header_map(header_map);var me=this;setTimeout(function(){me.render_step();},0);},clear_cell_errors:function(menu,menu_item)
{var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();for(var i=0;i<this.data_set.count();i++)
{var record=this.data_set.get_record(i);this.validate_row_cells(record,header_map,pivot_column_map,menu_item.value);}
this.data_filter='_rows_all_';var me=this;setTimeout(function(){me.render_step();},0);},on_filter_menu_item_selected:function(menu,menu_item)
{var value=menu_item.value;if(menu_item.checked)
this.data_filter='_rows_all_';else
this.data_filter=value;this.current_page=1;var me=this;setTimeout(function(){me.render_step();},0);},render_help:function()
{var entities=SG.schema.entity_types[this.entity_type]['display_name_pluralized'].toLowerCase();var entity=SG.schema.entity_types[this.entity_type]['display_name'].toLowerCase();var title='Step 4: Preview';var help='<p>This is the data you are about to import.</p><br>';help+="<p>Any errors will be listed in red and must be addressed before you can continue. You can edit "+"the data in the grid to the left. There are menu's above each column to help you find and fix the "+"errors.</p><br>";help+='<p>Read more about importing or watch a tutorial video '+this.help_link()+'.</p>';this.help_container.update(this.templates.help.apply({title:title,help:help}));},render_pagination:function(visible_records)
{var page_count=Math.ceil(visible_records.length/50.0);if(page_count<2)
{this.pagination_div.update('');return;}
var prev_enabled=(this.current_page>1)?'enabled':'disabled';var next_enabled=(this.current_page!=page_count)?'enabled':'disabled';var input_enabled=(page_count>1)?'enabled':'disabled';var paging_controls=this.templates.paging_controls.apply({prev_enabled:prev_enabled,input_enabled:input_enabled,next_enabled:next_enabled,current_page:this.current_page,page_count:sg_comma_format_number(page_count),prev_page:(this.current_page-1),next_page:(this.current_page+1),width:Math.floor(10*((Math.log(page_count)/Math.log(10))+1))});this.pagination_div.update(paging_controls);},on_pagination_div_click:function(e)
{var t=Ext.get(e.getTarget());var prev_next=t.findParent('img.arrow',this.container,true);if(prev_next&&prev_next.hasClass('enabled'))
{this.current_page=Number(prev_next.dom.getAttribute('page'));var me=this;setTimeout(function(){me.render_step();},1);}},on_pagination_div_change:function(e)
{var t=Ext.get(e.getTarget());var page_input=t.findParent('input.entity_list_paging_input',this.container);if(page_input)
{var page_count=page_input.getAttribute('page_count');var page=Number(page_input.value);if(page>page_count||page<1)
{alert("Page "+page+" is out of range.");return;}
else
{this.current_page=page;var me=this;setTimeout(function(){me.render_step();},1);}}},get_filtered_records:function(header_map,pivot_column_map)
{var data_filter_str=String(this.data_filter);var is_cell_error_filter=data_filter_str.indexOf('_rows')==-1;var filtered_records=[];var i,record;for(i=0;i<this.data_set.count();i++)
{record=this.data_set.get_record(i);record._row_index_=i;var cell_errors=this.validate_row_cells(record,header_map,pivot_column_map);if(is_cell_error_filter)
{var schema_field=header_map[this.data_filter];if(cell_errors.indexOf(schema_field.name)!=-1)
filtered_records.push(record);}
else
{var add_row=false;if(this.data_filter=='_rows_all_')
add_row=true;else if(this.data_filter=='_rows_created_'&&this.row_statuses[i]=='create')
add_row=true;else if(this.data_filter=='_rows_cell_errors_'&&cell_errors.length>0)
add_row=true;else if(this.data_filter=='_rows_updated_'&&this.row_statuses[i]=='update')
add_row=true;else if(this.data_filter=='_rows_not_unique_'&&this.row_statuses[i]=='error_row_not_unique')
add_row=true;if(add_row)filtered_records.push(record);}}
if(filtered_records.length==0)
{this.data_filter='_rows_all_';for(i=0;i<this.data_set.count();i++)
filtered_records.push(this.data_set.get_record(i));}
return filtered_records;},is_project_data_required:function()
{if(this.entity_type=='Booking'){return false;}else{var project=this.step_data.get_project();return(project==null&&SG.schema.entity_types[this.entity_type].has_projects);}},weed_out_duplicate_input_rows:function()
{if(!this.pivot_preview.has_pivot_columns())
return;var rows=this.step_data.get_rows();if(rows.length==1)return;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();for(var i=1;i<rows.length;i++)
{var last_row=rows[i-1];var this_row=rows[i];var row_same_as_last=true;for(var j=0;j<header_map.length;j++)
{var schema_field=header_map[j];var pivot_schema_field=pivot_column_map[j];if(schema_field==null||pivot_schema_field!=null)
continue;if(last_row[j]!=this_row[j])
{row_same_as_last=false;break;}}
if(row_same_as_last)
this.row_statuses[i]='duplicate_row_in_import_data';}},find_record_with_row_index:function(row_index)
{for(var i=0;i<this.data_set.count();i++)
{var record=this.data_set.get_record(i);if(record._row_index_==row_index)
return record;}
return null;},substitute_filter_tokens:function(projects,record,condition_hash)
{var single_project_id=projects.length===1?projects[0]:null;var i,j;if(condition_hash.path)
{for(i=0;i<condition_hash.values.length;i++)
{if(condition_hash.values[i])
{if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="logged_in_user_token")
{condition_hash.values[i]=SG.globals.current_user.entity_hash;}
else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="parent_entity_token")
{if(condition_hash.values[i].type===record.get_type())
condition_hash.values[i]={type:record.get_type(),id:record.get_id()};else if(this.parent_entity&&condition_hash.values[i].type===this.parent_entity.type)
condition_hash.values[i]=this.parent_entity;}
else if(condition_hash.values[i].valid&&condition_hash.values[i].valid=="project_token")
{var allp=SG.schema.projects;for(var j=0;j>allp.length;j++){if(allp[j].id===single_project_id){condition_hash.values[i]=allp[j];break;}}}
else if(condition_hash.values[i].date_token)
{condition_hash.values[i]=Date.sg_date_for_token(condition_hash.values[i]);}
else if(condition_hash.values[i].valid=="record_value_token")
{var rf=condition_hash.values[i].field;var sf=SG.schema.get_field(record.get_type(),rf);if(sf&&sf.data_type=="entity")
condition_hash.values[i]=record.get(rf);else
throw"Invalid record_value_token";}}}}
else if(condition_hash.conditions)
{var conditions=condition_hash.conditions;for(var i=0;i<conditions.length;i++)
this.substitute_filter_tokens(projects,record,conditions[i]);}},has_task_template_as_parent_entity:function()
{return(this.entity_type=='Task'&&this.parent_entity&&this.parent_entity.type=='TaskTemplate');},});SG.Importer.PivotPreview=function(config)
{Ext.apply(this,config);SG.Importer.PivotPreview.superclass.constructor.call(this);};Ext.extend(SG.Importer.PivotPreview,SG.Importer.Preview,{templates:{no_record_cell:'<td class="no_record_data" style="width:{width}px;">'+'<div style="background-color:rgb(240,240,240);">&nbsp</div></td>'},init_component:function()
{this.entity_type='Task';this.have_pivot_columns=false;var pivot_column_map=this.step_data.get_pivot_column_map();var header_map=this.step_data.get_header_map();this.pivot_columns={};for(var i=0;i<header_map.length;i++)
{var header_schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(header_schema_field==null||pivot_schema_field==null)
continue;header_schema_field.index=i;this.have_pivot_columns=true;if(this.pivot_columns[pivot_schema_field.name])
{var schema_array=this.pivot_columns[pivot_schema_field.name].columns;schema_array.push(header_schema_field);}
else
{var schema_array=[];schema_array.push(header_schema_field);this.pivot_columns[pivot_schema_field.name]={schema_field:pivot_schema_field,columns:schema_array};}}},construct_data_set:function()
{if(!this.have_pivot_columns)
return;this.record_map={};this.data_set=this.new_data_set(this.entity_type);var rows=this.step_data.get_rows();var i,j;for(i=0;i<rows.length;i++)
{var row=rows[i];for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var pivot_column_hash=this.pivot_columns[pivot_column_name];var pivot_column_schema_fields=pivot_column_hash.columns;if(this.data_all_blank(row,pivot_column_schema_fields))
continue;var record=this.data_set.new_record();record._row_status='create';record._row_index_=i;var step=SG.schema.get_step_entity(this.entity_preview.entity_type,pivot_column_hash.schema_field.name);record.set('step',{type:'Step',id:step.id,name:pivot_column_hash.schema_field.display_name,valid:'valid'});this.add_to_record_map(pivot_column_name,i,record);for(j=0;j<pivot_column_schema_fields.length;j++)
{var schema_field=pivot_column_schema_fields[j];this.set_record_data(schema_field,record,row[schema_field.index]);}
record.set('entity',{type:this.entity_preview.entity_type,name:'',id:0,valid:'valid'});}}},add_to_record_map:function(pivot_column_name,row_index,record)
{if(!this.record_map[pivot_column_name])
this.record_map[pivot_column_name]={};var map=this.record_map[pivot_column_name];map[row_index]=record.get_id();},fetch_record:function(pivot_column_name,row_index)
{var map=this.record_map[pivot_column_name];if(!map)
return null;var value=map[row_index];if(!value)
return null
return this.data_set.get_record_by_id(value);},fix_pivot_column_record_map:function(pivot_column_name,record_id,new_record_id)
{var map=this.record_map[pivot_column_name];for(var k in map)
{if(!map.hasOwnProperty(k))
continue;var value=map[k];if(value==record_id)
{map[k]=new_record_id;return;}}},get_row_status:function(pivot_column_name,row_index)
{var record=this.fetch_record(pivot_column_name,row_index);if(record==null)
return'no_record';else
return record._row_status;},data_all_blank:function(row,schema_fields)
{for(var i=0;i<schema_fields.length;i++)
{var schema_field=schema_fields[i];if(row[schema_field.index]!='')
return false;}
return true;},replace_entity_fields_in_data_set:function(entity_map)
{if(!this.have_pivot_columns)
return;var header_map=this.step_data.get_header_map();for(var k=0;k<this.data_set.count();k++)
{var record=this.data_set.get_record(k);for(var i=0;i<header_map.length;i++)
{var schema_field=header_map[i];if(schema_field==null||schema_field.entity_type!=this.entity_type)
continue;this.replace_entity_field_in_record(this.entity_type,schema_field,record);}}},has_pivot_columns:function()
{return this.have_pivot_columns;},render_cell:function(row_index,width,record,schema_field,pivot_schema_field)
{var task_record=this.fetch_record(pivot_schema_field.name,row_index);if(task_record==null)
return this.templates.no_record_cell.apply({width:width});var cm=this.get_cell_manager();var cell=this.cell_manager.get_cell(schema_field.name);var cell_params=cell.render(task_record);cell_params.width=width;return this.templates.cell.apply(cell_params);},get_cell_manager:function()
{if(!this.cell_manager)
{var step_project=this.step_data.get_project();var projects;if(!step_project)
projects=SG.schema.projects;else
projects=[step_project];var cell_config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:projects,autocommit:false,edit_applied_callback:{fn:this.on_cell_manager_edit,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);}
return this.cell_manager;},validate_rows:function(do_repository_batch)
{if(!this.have_pivot_columns)
return;this.id_map={};var id_fields=this.step_data.get_id_fields(this.entity_type);if(id_fields.length==0)
{this.load_count=0;this.required_load_count=0;return;}
var i;for(i=0;i<id_fields.length;i++)
{var id_field=id_fields[i];if(id_field.name=='id')
{id_fields=[id_field];break;}}
var project=this.step_data.get_project();if(do_repository_batch)
SG.Repo.start_batch();for(i=0;i<this.data_set.count();i++)
{var conditions=[];var columns=[];var record=this.data_set.get_record(i);for(var j=0;j<id_fields.length;j++)
{var id_field=id_fields[j];var index=['entity','multi_entity'].indexOf(id_field.data_type);var relation=index==-1?'is':'name_is';conditions.push({path:id_field.name,relation:relation,values:[record.get(id_field.name)]});columns.push(id_field.name);}
if(project)
conditions.push({path:'project',relation:"is",values:[project]});if(id_fields.length>0)
{var entity_id_fields=this.get_entity_preview_id_fields();var entity_record=this.entity_preview.find_record_with_row_index(record._row_index_);for(var j=0;j<entity_id_fields.length;j++)
{var id_field=entity_id_fields[j];var index=['entity','multi_entity'].indexOf(id_field.data_type);var relation=index==-1?'is':'name_is';var field_name='entity.'+this.entity_preview.entity_type+'.'+id_field.name;conditions.push({path:field_name,relation:relation,values:[entity_record.get(id_field.name)]});}}
var data_set=new SG.Data.Set(this.entity_type);data_set.import_record_id=record.get_id();this.add_event(data_set,'load',this.on_validate_row);spec={type:this.entity_type,columns:columns,filters:{logical_operator:"and",conditions:conditions},result:data_set};SG.Repo.query(spec);}
if(do_repository_batch)
SG.Repo.end_batch();this.required_load_count=this.data_set.count();this.load_count=0;},get_entity_preview_id_fields:function()
{var id_fields=this.step_data.get_id_fields(this.entity_preview.entity_type);var i;for(i=0;i<id_fields.length;i++)
{var id_field=id_fields[i];if(id_field.name=='id')
{id_fields=[id_field];break;}}
return id_fields;},on_validate_row:function(data_set)
{var count=data_set.count();var record=this.data_set.get_record_by_id(data_set.import_record_id);this.load_count++;if(count==0)
record._row_status='create';else if(count==1)
{var found_rec=data_set.get_record(0);if(this.id_map[found_rec.id]==undefined)
{var step=record.get('step');this.fix_pivot_column_record_map('step_'+step.id,record.id,found_rec.get_id());record._row_status='update';delete this.data_set.id_map[record.id];record.id=found_rec.get_id();this.data_set.id_map[record.id]=record;this.id_map[record.id]=true;}
else
{record._row_status='duplicate_row_in_import_data';}}
else
record._row_status='error_row_not_unique';if(this.done_validating_rows()&&this.entity_preview.done_validating_rows())
this.entity_preview.validate_entity_fields();},done_validating_rows:function()
{if(!this.have_pivot_columns)
return true;else
return(this.load_count>=this.required_load_count);},render_summary:function()
{if(!this.have_pivot_columns)
return'';this.status_counts={};for(var i=0;i<this.data_set.count();i++)
{var r=this.data_set.get_record(i);var row_status=r._row_status;if(!this.status_counts[row_status])
this.status_counts[row_status]=1;else
this.status_counts[row_status]+=1;}
return this.render_count_summaries(this.status_counts,true);},get_row_error_count:function()
{if(!this.have_pivot_columns)
return 0;if(this.status_counts['error_row_not_unique'])
return this.status_counts['error_row_not_unique'];else
return 0;},check_for_blank_identifier_fields:function()
{if(!this.have_pivot_columns)
return 0;var i;var header_map=this.step_data.get_header_map();var pivot_column_map=this.step_data.get_pivot_column_map();var ident_field=null;for(i=0;i<header_map.length;i++)
{var schema_field=header_map[i];var pivot_schema_field=pivot_column_map[i];if(schema_field==null||pivot_schema_field==null)
continue
if(schema_field.identifier_column)
{ident_field=schema_field;break;}}
if(ident_field==null||ident_field.name=='id')
return 0;var count=0;for(i=0;i<this.data_set.count();i++)
{var record=this.data_set.get_record(i);var value=record.get(ident_field.name);if(value!=null)
value=this.trim_ws(value);if(value==null||value.length==0)
count++;}
return count;},add_import_requests:function(requests,entity_record_id,row_index)
{var project=this.step_data.get_project();for(var pivot_column_name in this.pivot_columns)
{if(!this.pivot_columns.hasOwnProperty(pivot_column_name))
continue;var record=this.fetch_record(pivot_column_name,row_index);if(!record)
continue;var pivot_column_hash=this.pivot_columns[pivot_column_name];var schema_fields=pivot_column_hash.columns;var step=SG.schema.get_step_entity(this.entity_preview.entity_type,pivot_column_hash.schema_field.name);if(record._row_status=='create')
{var columns=[];var values=[];columns.push('entity');values.push({column:'entity',value:{type:this.entity_preview.entity_type,id:entity_record_id,valid:'valid',}});if(step.id!=0)
{columns.push('step');values.push({column:'step',value:{type:'Step',id:step.id,valid:'valid'}});}
for(var i=0;i<schema_fields.length;i++)
{var schema_field=schema_fields[i];if(schema_field.name=='id')
continue;columns.push(schema_field.name);values.push({column:schema_field.name,value:record.get(schema_field.name)});}
if(project)
{columns.push('project');values.push({column:'project',value:project});}
else if(this.entity_preview.is_project_data_required())
{var ds=this.entity_preview.data_set;var entity_record=this.entity_preview.find_record_with_row_index(row_index);columns.push('project');values.push({column:'project',value:entity_record.get('project')});}
requests.push({request_type:'create',type:this.entity_type,columns:columns,field_values:values,});}
else if(record._row_status=='update')
{var id=Number(record.get_id());requests.push({request_type:'update',type:this.entity_type,id:id,column:'entity',value:{type:this.entity_preview.entity_type,id:entity_record_id,valid:'valid',}});if(step.id!=0)
{requests.push({request_type:'update',type:this.entity_type,id:id,column:'step',value:{type:'Step',id:step.id,valid:'valid'}});}
for(var i=0;i<schema_fields.length;i++)
{var schema_field=schema_fields[i];if(schema_field.name=='id')
continue;requests.push({request_type:'update',type:this.entity_type,id:id,column:schema_field.name,value:record.get(schema_field.name)});}}}},on_cell_manager_edit:function(field,record,cell)
{var me=this;setTimeout(function(){me.entity_preview.render_step();},1);},});SG.Widget.Canvas.Page=function(context,widget_spec,id){SG.Widget.Canvas.Page.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Canvas.Page,SG.Widget.Base,{default_settings:{layouts:[{name:"body",display_name:"Default"}],hide_header:false},templates:{page:'<div class="contents {hide_header} {has_tabs}">'+'<div class="canvas_header">'+'<div id="{title_id}" class="title {title_class}"></div>'+'<div class="canvas_tabs"></div></div>'+'<div class="body"></div>'+'</div>'+'<div class="pane" style="display: none;"><div></div></div>',body:'<div id="{body_id}" class="body sg_scroll_container {body_class}"></div>',permissions:'<div class="canvas_tab_permissions"><table><td class="prompt">'+'Who can <b>See</b> this tab:</td><td>{roles}</td></table></div>',permission_role:'<span class="role"><input type="checkbox" id="role_{code}" {checked_attr} {disabled_attr} />'+'<label for="role_{code}">{display_name}</label></span> ',},empty_page_spec:{type:"SG.Widget.Canvas.Body",settings:{"rows":["row_1"]},children:{"row_1":{"type":"SG.Widget.Canvas.Row"}}},init_widget:function(){var layouts=this.get('layouts');if(layouts.length==1&&layouts[0].display_name=='Default'&&!layouts[0].allowed_permission_group_codes)
{layouts[0].allowed_permission_group_codes=[];for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
layouts[0].allowed_permission_group_codes.push(SG.globals.human_user_permission_groups[i].code);layouts[0].denied_permission_group_codes=[];}
this.has_tabs=this.context.get('design_mode')||layouts.length>1;},init_children:function(){this.child_context=this.context.clone();if(!this.context.get('design_mode')&&this.get('empty'))
this.child_context.set('empty',true);this.title_widget=this.construct_child('title',this.child_context);if(this.widget_spec.get_child_spec('detail_pane')&&this.context.get('in_pane')!==true)
{var context=this.context.clone();context.delete_key('entity');this.detail_pane=this.construct_child('detail_pane',context);}},on_first_render:function()
{this.container=this.get_container();this.page=this.get_page();var html=this.templates['page'].apply({title_id:this.title_widget.get_container_id(),title_class:this.title_widget.get_css_class_name(),hide_header:this.get('hide_header')?'hide_header':'',has_tabs:this.has_tabs?'has_tabs':''});Ext.DomHelper.append(this.container,html,true);this.contents=this.container.child('div.contents');this.tabs_elem=this.container.child('div.canvas_tabs');if(this.has_tabs){var cfg={canvas_page:this,container:this.tabs_elem};this.tabs_component=this.new_component(SG.Widget.Canvas.Tabs,cfg);}
this.add_event(this.container,'click',this.on_click);var design_page_on_load=getCookie('design_page_on_load');if(design_page_on_load){var page=this.get_page();if(page.id!==0&&design_page_on_load==page.id){setCookie('design_page_on_load',0,365);this.design_page(true);}}},get_child_context:function(layout)
{var context=this.child_context.clone();var spec=this.widget_spec.get_child_spec(layout);return context;},render_widget:function()
{if(this.body_widget)
this.destroy_child(this.body_widget);var selected_layout=this.get_selected_layout();this.body_widget=this.construct_child(selected_layout,this.get_child_context(selected_layout));this.contents.child('div.body').remove();var body_html=this.templates['body'].apply({body_id:this.body_widget.get_container_id(),body_class:this.body_widget.get_css_class_name()});Ext.DomHelper.append(this.contents,body_html);this.title_widget.render();if(this.has_tabs)
{this.tabs_elem.setDisplayed(true);this.tabs_component.render(this.tabs_elem);}
else
this.tabs_elem.setDisplayed(false);this.render_detail_pane();if(this.pane_container_showing==true&&!this.content_rendered)
return;this.body_widget.render();this.content_rendered=true;},render_detail_pane:function()
{if(this.detail_pane)
{var container=this.get_container();this.pane_container=container.child('.pane');this.pane_container.enableDisplayMode();this.pane_container.hide();this.pane_container_showing=false;this.pane_container.dom.firstChild.id=this.detail_pane.get_container_id();this.pane_container.dom.firstChild.className=this.detail_pane.get_css_class_name();if(this.context.get('in_pane')!==true)
{var detail_entity=SG.entity_in_hash();if(detail_entity)
this.show_entity_detail(detail_entity.type,detail_entity.id,detail_entity.name);}
this.detail_pane.render();}},show_entity_detail:function(entity_type,entity_id,entity_name)
{if(this.detail_pane)
{this.pane_container.show();this.pane_container_showing=true;this.detail_pane.context.set('entity',{type:entity_type,id:entity_id,name:entity_name});}},get_layout:function(name)
{var layouts=this.get('layouts');for(var i=0;i<layouts.length;i++){if(name===layouts[i].name)
return layouts[i];}
return null;},get_layouts:function(apply_permissions)
{if(this.context.get('design_mode')&&!apply_permissions)
return sg_deep_copy(this.get('layouts'));else
{var layouts=sg_deep_copy(this.get('layouts'));var allowed_layouts=[];for(var i=0;i<layouts.length;i++)
if(this.allowed_layout(layouts[i]))
allowed_layouts.push(layouts[i]);return allowed_layouts;}},get_allowed_layout:function(name,apply_permissions)
{var layouts=this.get('layouts');if(this.context.get('design_mode')&&!apply_permissions)
return this.get_layout(name);for(var i=0;i<layouts.length;i++){if(name===layouts[i].name&&this.allowed_layout(layouts[i]))
return layouts[i];}
return null;},allowed_layout:function(layout_hash,permission_rule_set_code)
{if(!layout_hash)
layout_hash=this.get_layout(this.get_selected_layout());if(!layout_hash.allowed_permission_group_codes&&!layout_hash.denied_permission_group_codes)
return true;if(!permission_rule_set_code)
permission_rule_set_code=SG.globals.current_user.permission_rule_set.rule_set_code;if(layout_hash.allowed_permission_group_codes&&layout_hash.allowed_permission_group_codes.indexOf(permission_rule_set_code)>-1)
{return true;}
if(layout_hash.denied_permission_group_codes&&layout_hash.denied_permission_group_codes.indexOf(permission_rule_set_code)>-1)
{return false;}
var parent_rule_set_code=this.find_rule_set_parent_code(permission_rule_set_code);if(parent_rule_set_code)
{return this.allowed_layout(layout_hash,parent_rule_set_code);}
return false;},find_rule_set_parent_code:function(rule_set_code)
{if(!this.permission_groups_by_code)
{this.permission_groups_by_id={};this.permission_groups_by_code={};for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
{this.permission_groups_by_id[SG.globals.human_user_permission_groups[i].id]=SG.globals.human_user_permission_groups[i];this.permission_groups_by_code[SG.globals.human_user_permission_groups[i].code]=SG.globals.human_user_permission_groups[i];}}
if(this.permission_groups_by_code[rule_set_code].parent_set_id)
return this.permission_groups_by_id[this.permission_groups_by_code[rule_set_code].parent_set_id].code;else
return null;},set_current_layout_permissions:function(permission_rule_set_code,checked)
{var layouts=this.get_layouts();var layout=null
for(var i=0;i<layouts.length;i++){if(this.get_selected_layout()===layouts[i].name)
layout=layouts[i];}
if(!layout.allowed_permission_group_codes)
layout.allowed_permission_group_codes=[];if(!layout.denied_permission_group_codes)
layout.denied_permission_group_codes=[];for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
{var set_code=SG.globals.human_user_permission_groups[i].code;if(layout.allowed_permission_group_codes.indexOf(set_code)==-1&&layout.denied_permission_group_codes.indexOf(set_code)==-1)
{var allowed=this.allowed_layout(layout,set_code);if(allowed)
layout.allowed_permission_group_codes.push(set_code);else
layout.denied_permission_group_codes.push(set_code);}}
var index=layout.allowed_permission_group_codes.indexOf(permission_rule_set_code);if(!checked&&index>-1)
layout.allowed_permission_group_codes.splice(index,1);else if(checked&&index==-1)
layout.allowed_permission_group_codes.push(permission_rule_set_code);index=layout.denied_permission_group_codes.indexOf(permission_rule_set_code);if(checked&&index>-1)
layout.denied_permission_group_codes.splice(index,1);else if(!checked&&index==-1)
layout.denied_permission_group_codes.push(permission_rule_set_code);this.set('layouts',layouts);if(permission_rule_set_code==SG.globals.current_user.permission_rule_set.rule_set_code)
this.render();},get_selected_layout:function()
{if(this.selected_layout&&this.get_allowed_layout(this.selected_layout))
return this.selected_layout;var cookie=getCookie("detail_layout_"+this.get_page().id)
if(cookie&&this.get_allowed_layout(cookie,true))
return cookie;var layouts=this.get_layouts(true);if(layouts.length>0)
return layouts[0].name;layouts=this.get('layouts');return layouts[0].name;},set_selected_layout:function(name)
{setCookie("detail_layout_"+this.get_page().id,name,365);this.selected_layout=name;this.render_widget();this.update_canvas_designer();},update_canvas_designer:function(){var designer=this.get_page().canvas_designer;if(designer&&designer.canvas_tools)
designer.canvas_tools.render();},design_page:function(no_save_as)
{var page=this.get_page();var cfg={page:this.page,page_title:this.context.get('title'),no_save_as:no_save_as};var dp=new SG.Widget.Canvas.Designer(cfg);},get_canvas_rows:function()
{if(this.body_widget.get_row_widgets)
return this.body_widget.get_row_widgets();else
return false;},add_row:function()
{this.body_widget.add_row();},reorder_rows:function(new_order)
{this.body_widget.reorder_rows(new_order);},delete_row:function(row_widget_name)
{this.body_widget.delete_row(row_widget_name);},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.dom.nodeName=='INPUT'&&t.dom.id.indexOf('role_')>-1)
{var me=this;setTimeout(function(){me.set_current_layout_permissions(t.dom.id.substring(5),t.dom.checked)},0);}},prepare_any_pending_settings:function(){this.save_any_pending_qb_settings(this);},save_any_pending_qb_settings:function(widget){var children=widget.get_child_widgets();if(!children)return;for(var i=0;i<children.length;i++){var child=children[i];if(['SG.Widget.EntityQuery.EntityQueryPage','SG.Widget.Collection'].indexOf(child.get('type'))!=-1){if(child.query_builder)
child.query_builder.set_filters();}
this.save_any_pending_qb_settings(child);}},rename_selected_layout:function(new_name){var selected_td=this.tabs_elem.child('td.tab_cell.selected');var tab_idx=Number(selected_td.dom.getAttribute('tab_idx'));var new_layouts=sg_deep_copy(this.get('layouts'));new_layouts[tab_idx]['display_name']=new_name;this.set('layouts',new_layouts);this.tabs_component.render();},});SG.Widget.Canvas.Body=function(context,widget_spec,id){SG.Widget.Canvas.Body.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Canvas.Body,SG.Widget.Base,{default_settings:{rows:[]},templates:{row:'<div class="{widget_cls}" id="{widget_id}"></div>',empty_can_save:'<div class="empty">This is an empty canvas! '+'<span class="canvas_design_mode">Enter design mode</span> to add and arrange widgets.</div>',empty:'<div class="empty">This is an empty canvas!</div>',forbidden:'<div class="empty">Sorry, you do not have permission to view this tab. '+'Please contact your admin to request a change in permissions. '+'If you believe this is an error, please contact support at support@shotgunsoftware.com.</div>'},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_click);var canvas_height_drag=new SG.Widget.Canvas.WidgetDragResize({container:this.container});},render_widget:function()
{if(!this.context.get('design_mode')&&this.context.get('empty'))
{var page=this.get_page();if(page.user_can_save())
this.container.update(this.templates.empty_can_save.apply());else
this.container.update(this.templates.empty.apply());return;}
var parent=this.get_parent();if(parent.allowed_layout&&!parent.allowed_layout())
{this.container.update(this.templates.forbidden.apply());return;}
var html='';var wrapper_widget_count=0;var rows=this.get('rows');var row_widgets=[];var i,w;for(i=0;i<rows.length;i++){w=this.get_child(rows[i]);if(!w){w=this.construct_warning_message("Error: Couldn't find row named "+rows[i]);}
wrapper_widget_count+=w.count_child_widgets();w.canvas_row_idx=i;html+=this.templates.row.apply({widget_cls:w.get_css_class_name(),widget_id:w.get_container_id()});row_widgets.push(w);}
if(wrapper_widget_count==0&&!this.context.get('design_mode'))
{var page=this.get_page();if(page.user_can_save())
html=this.templates.empty.apply()+html;}
this.container.update(html);for(i=0;i<row_widgets.length;i++){row_widgets[i].render();}},on_click:function(e)
{var t=Ext.get(e.getTarget());var canvas_design_mode=t.findParent('span.canvas_design_mode',this.container);if(canvas_design_mode)
{var page=this.get_page();page.root_widget.design_page();return;}},get_row_widgets:function()
{var rows=this.get('rows');var row_widgets=[];var i,w;for(i=0;i<rows.length;i++)
{w=this.get_child(rows[i]);if(w)
{row_widgets.push(w);}}
return row_widgets;},add_row:function()
{var row_widgets=this.get_row_widgets();var row_name=this.generate_new_child_name('row');var row_spec={type:'SG.Widget.Canvas.Row',children:{},settings:{}};this.widget_spec.create_child_spec(row_name,row_spec,this);var ctx=this.context.clone();var row_widget=this.construct_child(row_name,ctx);var rows=sg_deep_copy(this.get('rows'));rows.push(row_name);this.set('rows',rows);var html=this.templates.row.apply({widget_cls:row_widget.get_css_class_name(),widget_id:row_widget.get_container_id()});Ext.DomHelper.append(this.container,html);row_widget.canvas_row_idx=row_widgets.length;row_widget.render();},reorder_rows:function(new_order)
{var detached_rows=[];var old_rows=this.get('rows');var row_divs=sg_find_all('div.sgw_canvas_row',this.container.dom);for(var i=0;i<row_divs.length;i++)
{var row_div=Ext.get(row_divs[i]);var p=row_div.dom.parentNode;var keep=p.removeChild(row_div.dom);detached_rows.push(keep);}
var index;for(var i=0;i<new_order.length;i++)
{for(j=0;j<old_rows.length;j++)
{if(new_order[i]==old_rows[j])
{index=j;break;}}
this.container.dom.appendChild(detached_rows[index]);}
this.set('rows',new_order);for(var i=0;i<new_order.length;i++)
{var row_widget=this.get_child(new_order[i]);row_widget.canvas_row_idx=i;row_widget.update_title();}},delete_row:function(row_widget_name)
{var new_rows=[];var rows=this.get('rows');var i;for(i=0;i<rows.length;i++)
{if(rows[i]!=row_widget_name)
new_rows.push(rows[i])}
this.set('rows',new_rows);var w=this.get_child(row_widget_name);var widget_container=w.get_container();this.widget_spec.delete_child_spec(row_widget_name,this);this.destroy_child(w);widget_container.remove();var row_widgets=this.get_row_widgets();var rw;for(i=0;i<row_widgets.length;i++){rw=row_widgets[i];rw.canvas_row_idx=i;rw.update_title();}
if(row_widgets.length==0)
this.add_row();}});SG.Widget.Canvas.WidgetDragResize=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetDragResize.superclass.constructor.call(this,this.container,"layouts",{resizeFrame:false,scroll:false});};Ext.extend(SG.Widget.Canvas.WidgetDragResize,Ext.dd.DDProxy,{handleMouseDown:function(e)
{var target=Ext.get(e.getTarget());var height_drag_bar=target.findParent('div.height_drag_bar',this.container,true);if(height_drag_bar)
this.height_drag_bar=height_drag_bar;else
return;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y)
{this.canvas_wrapper_div=this.height_drag_bar.findParent('div.sgw_canvas_wrapper',this.container,true);var widget_id=Number(this.canvas_wrapper_div.dom.id.split('_')[1]);this.canvas_widget=SG.Widget.get_instance_by_id(widget_id);var canvas_widget_container=this.canvas_widget.get_container();this.height_container=canvas_widget_container.child('div.body');this.iframe_wrapper=canvas_widget_container.child('div.iframe_wrapper');if(this.iframe_wrapper)
this.iframe_wrapper.setDisplayed(false);this.offset=y-this.height_drag_bar.getTop();Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e)
{var x=e.getXY()[0];var y=e.getXY()[1];var top=this.height_container.getTop();var height=y-top-this.offset;this.height_container.setHeight(height);},endDrag:function(e)
{var x=e.getXY()[0];var y=e.getXY()[1];var top=this.height_container.getTop();var height=y-top-this.offset;this.canvas_widget.set('height',height);if(this.iframe_wrapper)
this.iframe_wrapper.setDisplayed(true);},});SG.Widget.Canvas.Row=function(context,widget_spec,id){SG.Widget.Canvas.Row.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Canvas.Row,SG.Widget.Base,{default_settings:{num_columns:2,column_layout:'percent',column_widths:[50,50],column_widgets:[[],[]],padding:[10,10,10,10],collapsable:false,collapsed:true,},templates:{tip:'<div class="tip {tip_icon}"></div>',title:'<div class="title">{title}</div>',body:'<div class="body"></div>',row:'<table class="row {layout}" style="{width}"><tr>{columns}</tr></table>',column:'<td class="row_column {extra_cls}" style="width: {width};" canvas_col="{canvas_col}">{widgets}</td>',widget:'<div class="{widget_cls}" child_code="{child_code}" id="{widget_id}"></div>',add_to_column_drag_target:'<div class="add_to_column_drag_target" col_index="{col}" '+'widget_id="{widget_id}"></div>',drag_message:'<div class="drag_message">You can drag and drop widgets onto this row from the pane on the left '+'or from other rows.</div>'},init_widget:function()
{this.rendered_body_once=false;this.collapsed=this.get('collapsed');},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_click);var html='';if(this.context.get('design_mode'))
{html+=this.templates.title.apply({title:"Row "+(this.canvas_row_idx+1)});var child_count=this.count_child_widgets();if(child_count==0)
html+=this.templates.drag_message.apply();}
var collapsable=this.get('collapsable');if(collapsable){var tip_icon=this.collapsed?'arrow_closed_dark':'arrow_open_dark';html+=this.templates.tip.apply({tip_icon:tip_icon});}
html+=this.templates.body.apply();this.container.setStyle({padding:this.get('padding').join('px ')+'px'});this.container.update(html);this.body=this.container.down('div.body');if(collapsable&&this.collapsed)
this.body.setDisplayed(false);},render_widget:function()
{if(this.get('collapsable')&&this.collapsed)
return;if(!this.rendered_body_once)
this.rendered_body_once=true;var cols,widgets,widget_html,w,i,j;var num_cols=this.get('num_columns');var col_widths=this.get('column_widths');var col_widgets=this.get('column_widgets');var layout=this.get('column_layout');var width_type=(layout==='percent')?'%':'px';var total_width=0;widgets=[];cols='';for(i=0;i<num_cols;i++){widget_html='';for(j=0;j<col_widgets[i].length;j++){w=this.get_child(col_widgets[i][j]);if(!w){w=this.construct_warning_message("Error: Couldn't find child named "+col_widgets[i][j]);};widget_html+=this.templates.widget.apply({widget_cls:w.get_css_class_name(),widget_id:w.get_container_id(),child_code:col_widgets[i][j]});widgets.push(w);}
if(this.context.get('design_mode'))
{widget_html+=this.templates.add_to_column_drag_target.apply({col:i,widget_id:this.get_widget_id()});}
total_width+=col_widths[i];cols+=this.templates.column.apply({width:col_widths[i]+width_type,widgets:widget_html,canvas_col:i,extra_cls:col_widgets[i].length==0?'empty':''});}
var tpl={columns:cols,layout:layout,width:(layout==='fixed')?'width: '+total_width+'px;':''};this.body.update(this.templates.row.apply(tpl));for(i=0;i<widgets.length;i++){widgets[i].render();}},count_child_widgets:function()
{var num_cols=this.get('num_columns');var col_widgets=this.get('column_widgets');var count=0;for(var i=0;i<num_cols;i++){for(var j=0;j<col_widgets[i].length;j++){count++;}}
return count;},on_click:function(e)
{var t=Ext.get(e.getTarget());tip=t.findParent('div.tip',2,true);if(!tip)
return;e.stopEvent();var collapsed=this.get('collapsed');if(this.collapsed){this.collapsed=false;this.set('collapsed',false);tip.replaceClass('arrow_closed_dark','arrow_open_dark');this.body.setDisplayed(true);if(!this.rendered_body_once)
this.render_widget();}else{this.collapsed=true;this.set('collapsed',true);tip.replaceClass('arrow_open_dark','arrow_closed_dark');this.body.setDisplayed(false);}},remove_wrapper:function(w)
{var col_widgets=sg_deep_copy(this.get('column_widgets'));var name=w.get_name_in_parent();var i,idx,found_col;for(i=0;i<col_widgets.length;i++){idx=col_widgets[i].indexOf(name);if(idx!==-1){found_col=i;col_widgets[i].splice(idx,1);}}
this.set('column_widgets',col_widgets);this.widget_spec.delete_child_spec(name,this);var cont=w.get_container();this.destroy_child(w);cont.remove();this.update_empty_row_columns();},replace_wrapper:function(w,spec_hash)
{var name=w.get_name_in_parent();this.widget_spec.replace_child_spec(name,spec_hash,this);var old_widget=this.get_child(name);var old_widget_container=old_widget.get_container();old_widget_container.setDisplayed(false);var ctx=this.context.clone();var new_widget=this.construct_child(name,ctx);this.insert_and_render_widget(old_widget_container,new_widget);this.destroy_child(old_widget);old_widget_container.remove();},change_column_widths:function(column_widths)
{this.set('column_widths',column_widths);var columns=sg_find_all('td.row_column',this.container.dom);for(var i=0;i<columns.length;i++)
{var col_elem=Ext.get(columns[i]);var canvas_col=Number(col_elem.dom.getAttribute('canvas_col'));var new_width=column_widths[canvas_col];col_elem.dom.style.width=new_width+'%';}
var me=this;setTimeout(function(){me.widgets_update_dynamically_detected_positions();},0);},widgets_update_dynamically_detected_positions:function()
{var columns=sg_find_all('td.row_column',this.container.dom);for(var i=0;i<columns.length;i++)
{var wrapper_divs=sg_find_all('div.sgw_canvas_wrapper',columns[i]);for(var j=0;j<wrapper_divs.length;j++)
{var wrapper_div=Ext.get(wrapper_divs[j]);var parts=wrapper_div.dom.id.split('_');var widget=SG.Widget.get_instance_by_id(Number(parts[1]));if(!widget||!widget.child_widget)
continue;if(widget.child_widget&&widget.child_widget.update_dynamically_detected_positions)
widget.child_widget.update_dynamically_detected_positions();}}},insert_wrapper:function(spec,above_this_widget)
{var num_cols=this.get('num_columns');var col_widgets=this.get('column_widgets');var new_widget_name=this.generate_new_child_name("child");var new_col_widgets=[];for(var i=0;i<num_cols;i++)
{var new_column=[];var a_column=col_widgets[i];for(var j=0;j<a_column.length;j++)
{var col_widget_name=a_column[j];if(above_this_widget.__name_in_parent__==col_widget_name)
new_column.push(new_widget_name);new_column.push(col_widget_name);}
new_col_widgets.push(new_column);}
this.set('column_widgets',new_col_widgets);var new_widget=this.construct_new_wrapper_widget(new_widget_name,spec);var above_container=above_this_widget.get_container();this.insert_and_render_widget(above_container,new_widget);this.update_empty_row_columns();},add_wrapper_to_column:function(spec,col)
{var col_widgets=this.get('column_widgets');var new_widget_name=this.generate_new_child_name("child");col_widgets[col].push(new_widget_name);this.set('column_widgets',col_widgets);var new_widget=this.construct_new_wrapper_widget(new_widget_name,spec);var above_container=Ext.get(sg_find('div.add_to_column_drag_target[col_index="'+col+'"]',this.container.dom));this.insert_and_render_widget(above_container,new_widget);this.update_empty_row_columns();},update_empty_row_columns:function()
{var wrapper_count=0;var column_tds=sg_find_all('td.row_column',this.container.dom);for(var i=0;i<column_tds.length;i++)
{var column_td=Ext.get(column_tds[i]);var a_wrapper=column_td.child('div.sgw_canvas_wrapper');if(a_wrapper&&column_td.hasClass('empty'))
column_td.removeClass('empty');else if(!a_wrapper&&!column_td.hasClass('empty'))
column_td.addClass('empty');if(a_wrapper)wrapper_count++;}
var drag_message=this.container.child('div.drag_message');if(wrapper_count>0)
{if(drag_message)drag_message.remove();}
else
{if(!drag_message)
{var title_div=this.container.child('div.title');Ext.DomHelper.insertAfter(title_div,this.templates.drag_message.apply());}}},construct_new_wrapper_widget:function(name,spec)
{this.widget_spec.create_child_spec(name,spec,this);var ctx=this.context.clone();var new_widget=this.construct_child(name,ctx);return new_widget;},insert_and_render_widget:function(above_container,widget)
{var html=this.templates.widget.apply({widget_cls:widget.get_css_class_name(),widget_id:widget.get_container_id(),});Ext.DomHelper.insertBefore(above_container,html);widget.render();},update_title:function()
{var el=sg_find('div.title',this.container.dom);el.innerHTML="Row "+(this.canvas_row_idx+1);},move_widget:function(widget_to_move,above_this_widget)
{if(widget_to_move.get_widget_id()==above_this_widget.get_widget_id())return;var widget_to_move_parent=widget_to_move.get_parent();if(widget_to_move_parent.get_widget_id()!=this.get_widget_id())
{var spec=widget_to_move.widget_spec.to_hash();widget_to_move_parent.remove_wrapper(widget_to_move);this.insert_wrapper(spec,above_this_widget);}
else
{var container=widget_to_move.get_container();var p=container.dom.parentNode;var keep=p.removeChild(container.dom);var before_container=above_this_widget.get_container();p=before_container.dom.parentNode;p.insertBefore(keep,before_container.dom);var num_cols=this.get('num_columns');var col_widgets=this.get('column_widgets');var new_col_widgets=[];for(var i=0;i<num_cols;i++)
{var new_column=[];var a_column=col_widgets[i];for(var j=0;j<a_column.length;j++)
{var col_widget_name=a_column[j];if(above_this_widget.get_name_in_parent()==col_widget_name)
new_column.push(widget_to_move.get_name_in_parent());if(col_widget_name!=widget_to_move.get_name_in_parent())
new_column.push(col_widget_name);}
new_col_widgets.push(new_column);}
this.set('column_widgets',new_col_widgets);this.update_empty_row_columns();}
if(widget_to_move.child_widget&&widget_to_move.child_widget.update_dynamically_detected_positions)
widget_to_move.child_widget.update_dynamically_detected_positions();},move_widget_to_this_column:function(widget_to_move,col)
{var widget_to_move_parent=widget_to_move.get_parent();if(widget_to_move_parent.get_widget_id()!=this.get_widget_id())
{var spec=widget_to_move.widget_spec.to_hash();widget_to_move_parent.remove_wrapper(widget_to_move);this.add_wrapper_to_column(spec,col);widget_to_move_parent.update_empty_row_columns();}
else
{var container=widget_to_move.get_container();var p=container.dom.parentNode;var keep=p.removeChild(container.dom);var column_td=Ext.get(sg_find('td.row_column[canvas_col="'+col+'"]',this.container.dom));var before_container=column_td.child('div.add_to_column_drag_target');column_td.dom.insertBefore(keep,before_container.dom);var num_cols=this.get('num_columns');var col_widgets=this.get('column_widgets');var new_col_widgets=[];for(var i=0;i<num_cols;i++)
{var new_column=[];var a_column=col_widgets[i];for(var j=0;j<a_column.length;j++)
{var col_widget_name=a_column[j];if(col_widget_name!=widget_to_move.get_name_in_parent())
new_column.push(col_widget_name);}
if(i==col)
new_column.push(widget_to_move.get_name_in_parent());new_col_widgets.push(new_column);}
this.set('column_widgets',new_col_widgets);this.update_empty_row_columns();}
if(widget_to_move.child_widget&&widget_to_move.child_widget.update_dynamically_detected_positions)
widget_to_move.child_widget.update_dynamically_detected_positions();},change_column_count:function(new_column_count)
{var old_column_count=this.get('num_columns');if(new_column_count==old_column_count)return;if(new_column_count>old_column_count)
{var column_widgets=this.get('column_widgets');var sel='td.row_column[canvas_col="'+(old_column_count-1)+'"]';var last_column_td=Ext.get(sg_find(sel,this.container.dom));var tr_elem=Ext.get(last_column_td.dom.parentNode);for(var i=old_column_count;i<new_column_count;i++)
{var w=this.templates.add_to_column_drag_target.apply({col:i,widget_id:this.get_widget_id()});var html=this.templates.column.apply({width:'0%',canvas_col:i,widgets:w});Ext.DomHelper.append(tr_elem,html);column_widgets.push([]);}
if(new_column_count==2)
this.change_column_widths([50,50]);else if(new_column_count==3)
this.change_column_widths([33,33,34]);else if(new_column_count==4)
this.change_column_widths([25,25,25,25]);this.set('num_columns',new_column_count);this.set('column_widgets',column_widgets);}
else
{var to_remove=[];for(var i=new_column_count;i<old_column_count;i++)
{var sel='td.row_column[canvas_col="'+i+'"]';var column_td=Ext.get(sg_find(sel,this.container.dom));to_remove.push(column_td);var wrapper_divs=sg_find_all('div.sgw_canvas_wrapper',column_td.dom);for(var j=0;j<wrapper_divs.length;j++)
{var wrapper_div=Ext.get(wrapper_divs[j]);var parts=wrapper_div.dom.id.split('_');var widget=SG.Widget.get_instance_by_id(Number(parts[1]));this.move_widget_to_this_column(widget,(new_column_count-1));}}
for(var i=0;i<to_remove.length;i++)
to_remove[i].remove();if(new_column_count==1)
this.change_column_widths([100]);if(new_column_count==2)
this.change_column_widths([50,50]);else if(new_column_count==3)
this.change_column_widths([33,33,34]);this.set('num_columns',new_column_count);}},});SG.Widget.Canvas.Wrapper=function(context,widget_spec,id){SG.Widget.Canvas.Wrapper.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.Canvas.Wrapper,SG.Widget.Base,{default_settings:{show_title:true,show_border:true,collapsable:false,collapsed:true,title:'New Widget',title_bg_color:'234,234,234',title_text_color:'24,24,24',height:300,bind_entity:null,show_icon:false,variation_display_name:'',maximizable:true,configurable:true,show_controls:true},templates:{title:'<div class="title {state}" style="{style}" title_text="{title}" '+'widget_id="{widget_id}"><table style="{style}"><tr>'+'<td class="title_text"><span class="tip_target">{tip}{drag_icon}{entity_icon}{title}</span></td>'+'{quick_filter}{quick_filter_input}{action_menu}{edit}{refresh_button}{trash}{zoom_button}</tr>'+'</table></div>',tip:'<div class="icon tip {tip_icon}"></div>',entity_icon:'<div class="icon entity {entity_icon}"></div>',drag_icon:'<div class="icon_drag_drop_handle"></div>',trash:'<td class="trash"><div class="remove trash"></div></td>',edit:'<td class="edit"><div class="icon_edit"></div><span>Edit</span></td>',action_menu:'<td class="control action"><div class="target"><div class="dropdown_arrow_small"></div></div></td>',quick_filter_button:'<td class="quick_filter_button" id="{quick_filter_button_id}"></td>',quick_filter_input:'<td class="quick_filter_input_cell"><div id="{quick_filter_container_id}"></div></td>',body:'<div class="body {border}" style="{bgcolor}"></div>',zoom_button:'<td class="control zoom"><div class="widget_zoom_dark zoom_button"></div></td>',refresh_button:'<td class="control refresh"><div class="refresh_button refresh {extra_cls}"></div></td>',refresh_button_no_td:'<div class="refresh_button refresh {extra_cls}"></div>',child:'<div class="{widget_cls}" id="{widget_id}"></div>',drag_target:'<div class="widget_drag_target"></div>',not_configured:'<table><tr><td class="no_config">'+'<img class="widget_box" src="/images/icon_widget_{widget_variation}.png"></td>'+'<td class="no_config" style="width: 80%">{configure_message}</td></tr></table>',config_message:'<div class="config_message">This widget has not been configured.<span class="configure">'+'Configure widget</span>.</div>',config_message_with_entity_type_selector:'<div class="config_message">This widget has not been configured. Choose an entity type to begin.'+'<br><span class="menu_label">{widget} of</span>'+'{entity_type_menu}<span class="configure">Configure</span></div>',entity_type_menu:'<div class="entity_type_menu" entity_type="{entity_type}"><div class="{entity_icon} icon entity_icon">'+'</div><div class="menu_label">{label}</div><div class="dropdown_arrow_small icon"></div></div>',zoomed:'<div class="sgw_canvas_wrapper_fullsize">'+'<div class="header" style="color: rgb({text_color});background-color: rgb({bg_color});">'+'<div class="title">{title}</div>'+'<div class="zoom_widget_close close_button"></div></div>'+'<div class="zoom_body">{child}</div></div>',height_drag_bar:'<div class="height_drag_bar {border}" {height_drag_style}></div>',toolbar_title_tip:'<span class="tip_target">{tip}{entity_icon}{title}</span>',},init_widget:function()
{this.design_mode=this.context.get('design_mode');this.child_widget=null;this.entity=null;this.collapsed=this.get('collapsed');this.rendered_body_once=false;this.selection_length=0;this.binding=this.get('bind_entity');if(this.binding===null){this.binding_cfg=null;this.entity=this.context.get('entity');}else{this.binding_cfg={uuid:this.binding,name:'selection_changed',callback:{fn:this.on_selection_changed,scope:this}}
SG.NotificationCenter.add_observer(this.binding_cfg);}
if(this.context.get('edit_mode'))
this.add_event(this,'settings_changed',this.on_settings_changed);},init_children:function()
{},destroy_widget:function()
{if(this.binding_cfg!==null)
SG.NotificationCenter.remove_observer(this.binding_cfg);if(this.widget_editor)
this.widget_editor.destroy();},on_selection_changed:function(selection,canvas_id)
{if(canvas_id!==this.get_canvas().get_widget_id())
return;this.selection_length=selection.length;this.selected_entities=selection;if(this.selection_length>0)
this.entity=selection[0];else
this.entity=null;var collapsable=this.get('collapsable');if(collapsable&&this.collapsed)
this.rendered_body_once=false;else
this.render_widget();},on_first_render:function()
{this.container=this.get_container();this.render_empty=!this.child_widget_has_enabled_entity_type();if(this.render_empty)
{this.container.update('');return;}
this.add_event(this.container,'click',this.on_click);this.quick_filter_button_id='quick_filter_button_'+this.get_widget_id();this.quick_filter_container_id='quick_filter_'+this.get_widget_id();var html=this.render_title();html+=this.render_body();this.container.update(html);this.body=this.container.down('div.body');if(this.get('collapsable')&&this.collapsed)
this.body.setDisplayed(false);},child_widget_is_divider:function()
{return(this.widget_spec.child_specs.child&&this.widget_spec.child_specs.child.type=='SG.Widget.Divider')},render_widget:function()
{if(this.render_empty)
{this.container.update('');return;}
if(this.get('configured')==false)
{this.body.update(this.render_not_configured());if(!this.container.hasClass('not_configured'))
this.container.addClass('not_configured');return;}
else if(this.container.hasClass('not_configured'))
this.container.removeClass('not_configured');var name=this.get_child_names()[0];if(!name){w=this.construct_warning_message("Error: Wrapper has no children.");};if(!this.context.get('edit_mode')&&this.get('collapsable')&&this.collapsed)
return;this.rendered_body_once=true;if(this.child_widget!==null){this.destroy_child(this.child_widget);}
if(this.entity===null){this.body.update('<div class="no_selection">No selection.</div>');return;}
if(this.selection_length>1&&!this.get('supports_multiple_selection'))
{this.body.update('<div class="no_selection">Multiple selection.</div>');return;}
var ctx=this.context.clone();ctx.set('entity',this.entity);ctx.set('selected_entities',this.selected_entities);this.child_widget=this.construct_child(name,ctx);var child_cfg={widget_cls:this.child_widget.get_css_class_name(),widget_id:this.child_widget.get_container_id()};this.body.update(this.templates.child.apply(child_cfg));var height_drag_bar_elem=this.container.child('div.height_drag_bar');if(this.child_widget.canvas_require_height&&!height_drag_bar_elem){this.body.setHeight(this.get('height'));var height_drag_style=(this.get('collapsable')&&this.collapsed)?'style="display:none;"':'';Ext.DomHelper.append(this.container,this.templates.height_drag_bar.apply({border:this.get('show_border')?'border':'',height_drag_style:height_drag_style}));}
this.child_widget.render();if(!this.design_mode&&this.child_widget.canvas_quickfilter&&!this.collapsed)
this.re_render_title_and_construct_quickjump();},render_not_configured:function()
{if(this.get('entity_type_varies')){var entity_type_menu='';if(this.wrapped_widget_accepts_current_entity()){var context_entity=this.context.get('entity');var context_entity_type=context_entity.type;var edn=SG.schema.entity_types[context_entity_type].display_name;entity_type_menu=this.templates.entity_type_menu.apply({entity_type:'current_entity',entity_icon:'icon_'+context_entity_type,label:'Current '+edn,});}else{var entity_type=SG.schema.leftnav_page_entity_types[0];var edn=SG.schema.entity_types[entity_type].display_name;entity_type_menu=this.templates.entity_type_menu.apply({entity_type:entity_type,entity_icon:'icon_'+entity_type,label:edn,});}
var message=this.templates.config_message_with_entity_type_selector.apply({widget:this.get('variation_display_name'),entity_type_menu:entity_type_menu});var html=this.templates.not_configured.apply({widget_variation:this.get('variation'),configure_message:message,});return html;}else{var html=this.templates.not_configured.apply({widget_variation:this.get('variation'),configure_message:this.templates.config_message.apply()});return html;}},on_click:function(e)
{var t=Ext.get(e.getTarget());var remove_target=t.findParent('div.remove',true);if(remove_target){this.get_parent().remove_wrapper(this);return;}
var edit_target=t.findParent('td.edit',true);if(edit_target){this.edit_widget();return;}
var configure_target=t.findParent('span.configure',true);if(configure_target){this.edit_widget();return;}
var zoom_button=t.findParent('div.zoom_button',true);if(zoom_button){this.zoom_to_full_screen();return;}
var refresh_button=t.findParent('div.refresh_button',true);if(refresh_button){this.refresh_child_widget();return;}
var action_menu_td=t.findParent('td.action',true);if(action_menu_td){this.show_action_menu(action_menu_td);return;}
var entity_type_menu=t.findParent('div.entity_type_menu',this.container,true);if(entity_type_menu){this.show_entity_type_menu(entity_type_menu)
return;}
var tip_target=t.findParent('span.tip_target',5,true);if(!tip_target)
return;var tip=tip_target.child('div.tip');var title_div=this.container.child('div.title');if(!title_div)
title_div=this.container.child('div.sgc_toolbar');e.stopEvent();if(!this.get('collapsable'))
return;if(this.collapsed){this.collapsed=false;this.set('collapsed',false);tip.replaceClass('arrow_closed_dark','arrow_open_dark');this.body.setDisplayed(true);if(!this.rendered_body_once)
this.render_widget();else if(this.child_widget.update_dynamically_detected_positions)
this.child_widget.update_dynamically_detected_positions();title_div.removeClass('closed');if(this.child_widget&&this.child_widget.canvas_require_height){var height_drag_bar=this.container.child('div.height_drag_bar');height_drag_bar.setDisplayed(true);}}else{this.collapsed=true;this.set('collapsed',true);tip.replaceClass('arrow_open_dark','arrow_closed_dark');this.body.setDisplayed(false);title_div.addClass('closed');if(this.child_widget)
this.recursively_hide_widget_loading_overlay(this.child_widget);if(this.child_widget.canvas_require_height){var height_drag_bar=this.container.child('div.height_drag_bar');height_drag_bar.setDisplayed(false);}}},refresh_child_widget:function()
{if(!this.child_widget)return;this.destroy_child(this.child_widget);var ctx=this.context.clone();ctx.set('entity',this.entity);this.child_widget=this.construct_child('child',ctx);var child_cfg={widget_cls:this.child_widget.get_css_class_name(),widget_id:this.child_widget.get_container_id()};this.body.update(this.templates.child.apply(child_cfg));this.child_widget.render();},child_widget_has_enabled_entity_type:function()
{var entity_type=this.child_widget_entity_type();if(entity_type)
return SG.schema.entity_types[entity_type].enabled;return true;},child_widget_entity_type:function()
{if(this.widget_spec.child_specs)
{var name=this.get_child_names()[0];if(name&&this.widget_spec.child_specs[name])
{var child_spec=this.widget_spec.child_specs[name];if(child_spec.settings&&child_spec.settings['entity_type'])
{var entity_type=child_spec.settings['entity_type'];return entity_type;}}}
return null;},recursively_hide_widget_loading_overlay:function(widget)
{widget.hide_loading_overlay();var children=widget.get_child_widgets();for(var i=0;i<children.length;i++)
this.recursively_hide_widget_loading_overlay(children[i]);},edit_widget:function()
{var cfg={source:this};if(this.get('entity_type_varies')&&this.get('configured')==false){var menu_div=this.container.child('div.entity_type_menu');cfg.root_widget_entity_type=menu_div.dom.getAttribute('entity_type');}
this.widget_editor=new SG.Widget.Canvas.WidgetEditor(cfg);},zoom_to_full_screen:function()
{this.zoomed=true;var ctx=this.context.clone();ctx.set('entity',this.entity);this.zoom_child_widget=this.construct_child('child',ctx);var zoom_child_container_html=this.templates.child.apply({widget_cls:this.zoom_child_widget.get_css_class_name(),widget_id:this.zoom_child_widget.get_container_id()});var dh=Ext.DomHelper;var page_elem=this.container.findParent('div.sg_page');var html=this.templates.zoomed.apply({title:this.get('show_title')?this.get('title'):'',text_color:this.get('title_text_color'),bg_color:this.get('title_bg_color'),child:zoom_child_container_html});this.zoom_container=dh.append(page_elem,html,true);this.add_event(this.zoom_container,'click',this.on_click_zoom_container);this.shadow=new Ext.Shadow({offset:5,mode:'frame'});this.shadow.show(this.zoom_container);this.shadow.setZIndex(null);this.zoom_child_widget.render();},return_from_zoom:function()
{this.zoomed=false;this.remove_event(this.zoom_child_widget,'settings_changed',this.on_zoom_child_widget_settings_changed);this.destroy_child(this.zoom_child_widget);this.remove_event(this.zoom_container,'click',this.on_click_zoom_container);this.shadow.hide();this.zoom_container.remove();this.refresh_child_widget();},on_click_zoom_container:function(e){var t=Ext.get(e.getTarget());var close_button=t.findParent('div.close_button',true);if(close_button){var me=this;setTimeout(function(){me.return_from_zoom();},0);return;}},show_action_menu:function(action_menu_td)
{if(!this.action_menu)
{this.action_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_action_menu,scope:this}});this.action_menu.render();}
this.action_menu.positon_elem=action_menu_td;this.action_menu.show();},on_before_show_action_menu:function(menu)
{var items=[];if(this.design_mode)
{items.push({html:'Duplicate Widget',item_selected:{fn:this.duplicate_widget,scope:this},disabled:!this.get('configured')});}
menu.position={dom_elem:menu.positon_elem,elem_anchor:"br",menu_anchor:"tr"};menu.items=items;menu.render();},duplicate_widget:function()
{var spec=sg_deep_copy(this.widget_spec.to_hash());spec.settings.title=this.get('title')+' (Copy)';var row_widget=this.get_parent();if(this.container.dom.nextSibling&&Ext.fly(this.container.dom.nextSibling).hasClass('sgw_canvas_wrapper'))
{var id=this.container.dom.nextSibling.getAttribute('id');var below_widget_id=Number(id.split('_')[1]);var below_widget=SG.Widget.get_instance_by_id(below_widget_id);row_widget.insert_wrapper(spec,below_widget);}
else
{var row_td=this.container.findParent('td.row_column');var col=Number(row_td.getAttribute('canvas_col'));row_widget.add_wrapper_to_column(spec,col);}
SG.Message.show({html:"Widget has been duplicated",close_x:true});},render_body:function()
{var bgcolor=this.get('bgcolor');return this.templates.body.apply({border:this.get('show_border')?'border':'',bgcolor:bgcolor?'background-color: '+bgcolor+';':''});},render_title:function()
{if(!this.design_mode&&!this.get('show_title'))
return'';var collapsable=this.get('collapsable');var html='';if(this.design_mode)
html+=this.templates.drag_target.apply();var quick_filter_input=this.templates.quick_filter_input.apply({quick_filter_container_id:this.quick_filter_container_id});html+=this.templates.title.apply({state:this.render_state(),style:this.render_style(),title:this.render_title_text(),widget_id:this.get_widget_id(),tip:this.render_tip(),drag_icon:this.design_mode?this.templates.drag_icon.apply():'',entity_icon:this.render_entity_icon(),quick_filter:this.render_quick_filter_button(),action_menu:this.render_action_menu(),edit:this.render_edit(),refresh_button:this.render_refresh_button(),trash:this.design_mode?this.templates.trash.apply():'',zoom_button:this.render_zoom_button(),quick_filter_input:quick_filter_input});return html;},render_quick_filter_button:function(){if(!(this.child_widget&&this.child_widget.canvas_quickfilter))
return'';return this.templates.quick_filter_button.apply({quick_filter_button_id:this.quick_filter_button_id});},render_edit:function()
{if(!this.design_mode)return'';if(this.get('configurable')===false)
return'';else
return this.templates.edit.apply();},render_zoom_button:function()
{if(this.design_mode||!this.get('maximizable')||!this.get('show_controls'))
return'';else
return this.templates.zoom_button.apply();},render_style:function()
{var style='color: rgb('+this.get('title_text_color')+');';if(this.design_mode&&this.default_settings.title_bg_color==this.get('title_bg_color'))
{}
else
style+='background-color: rgb('+this.get('title_bg_color')+');';return style;},render_action_menu:function()
{if(this.child_widget_is_divider()||!this.design_mode||!this.get('show_controls'))
return'';else
return this.templates.action_menu.apply();},render_refresh_button:function(for_toolbar)
{if(this.child_widget_is_divider()||!this.get('show_controls'))return'';var extra_cls;if(this.design_mode)
extra_cls='design_mode';else
extra_cls=this.get('maximizable')?'':'alone';var template=for_toolbar?this.templates.refresh_button_no_td:this.templates.refresh_button;return template.apply({extra_cls:extra_cls});},render_entity_icon:function()
{var entity_type=this.child_widget_entity_type();if(entity_type&&this.get('show_icon'))
return this.templates.entity_icon.apply({entity_icon:'icon_'+entity_type});else
return'';},render_state:function()
{var collapsable=this.get('collapsable');var state=collapsable&&this.collapsed?'closed':'';if(this.design_mode&&this.get('show_border'))
state+=' bottom_border';if(this.design_mode)
state+=' widget_drag';if(this.design_mode&&this.default_settings.title_bg_color==this.get('title_bg_color'))
state+=' header_gradient';return state;},render_title_text:function()
{var entity_type=this.child_widget_entity_type();if(entity_type)
return this.replace_entity_name_in_static_text(entity_type,this.get('title'));else
return this.get('title');},render_tip:function()
{var collapsable=this.get('collapsable');if(!collapsable)return'';var tip_icon=this.collapsed?'arrow_closed_dark':'arrow_open_dark';return this.templates.tip.apply({tip_icon:tip_icon});},re_render_title_and_construct_quickjump:function()
{var title_div=this.container.child('div.title');title_div.update(this.render_title());var quick_filter_config={button_id:this.quick_filter_button_id,container_id:this.quick_filter_container_id,widget:this,entity_type:this.child_widget_entity_type(),quick_filter_callback:{fn:this.on_quick_filter,scope:this},after_toggle_show:{fn:this.on_quick_filter_toggle,scope:this}};this.quick_filter=this.new_component(SG.QuickFilter,quick_filter_config);this.quick_filter.render();},on_quick_filter:function(quick_filters)
{if(this.child_widget&&this.child_widget.on_quick_filter){this.child_widget.on_quick_filter(quick_filters);return;}
var filters=sg_deep_copy(this.child_widget.get('filters'));if(quick_filters)
filters.conditions.push(quick_filters);this.context.set('filters',filters);this.refresh_child_widget();},on_quick_filter_toggle:function(showing){var container_cell=Ext.get(sg_find('td.quick_filter_input_cell',this.container.dom));if(showing){container_cell.addClass('showing');}else{container_cell.removeClass('showing');}},show_entity_type_menu:function(menu_div_elem)
{var cur_entity_type=menu_div_elem.dom.getAttribute('entity_type');if(!this.entity_type_menu)
{this.entity_type_menu=new SG.Menu({item_selected:{fn:this.on_entity_type_menu,scope:this}});}
var entity_types=SG.schema.leftnav_page_entity_types;var items=[];if(this.wrapped_widget_accepts_current_entity()){var context_entity=this.context.get('entity');var context_entity_type=context_entity.type;var edn=SG.schema.entity_types[context_entity_type].display_name;items.push({html:'Current '+edn,entity_type:'current_entity',icon_name:'icon_'+context_entity_type,checked:(!cur_entity_type)});}
for(var i=0;i<entity_types.length;i++)
{var entity_type=entity_types[i];edn=SG.schema.entity_types[entity_type]['display_name'];items.push({html:edn,entity_type:entity_type,icon_name:'icon_'+entity_type,checked:cur_entity_type==entity_type});}
this.entity_type_menu.items=items;this.entity_type_menu.position={dom_elem:menu_div_elem,elem_anchor:'bl',menu_anchor:'tl'};this.entity_type_menu.render();this.entity_type_menu.show();},wrapped_widget_accepts_current_entity:function(){var variation=this.get('variation');if(['Thumbnail','NewFields'].indexOf(variation)!=-1){return true;}else{return false;}},on_entity_type_menu:function(menu,menu_item)
{var entity_type=menu_item.entity_type;var menu_div=this.container.child('div.entity_type_menu');var prev_sibling=menu_div.dom.previousSibling;var icon,label;if(entity_type=='current_entity'){var context_entity=this.context.get('entity');var context_entity_type=context_entity.type;var edn=SG.schema.entity_types[context_entity_type].display_name;label='Current '+edn;icon='icon_'+context_entity_type;}else{icon='icon_'+entity_type,label=SG.schema.entity_types[entity_type]['display_name'];}
var html=this.templates.entity_type_menu.apply({entity_type:entity_type,entity_icon:icon,label:label,});setTimeout(function(){menu_div.remove();Ext.DomHelper.insertAfter(prev_sibling,html);},0);},on_settings_changed:function(change_hash,source_widget){var change;var change_keys=[];for(var change in change_hash){if(change_hash.hasOwnProperty(change))
change_keys.push(change);}
var re_render_title=false;var title_keys=['show_title','collapsable','title','title_bg_color','title_text_color'];for(var i=0;i<change_keys.length;i++){change=change_keys[i];if(change=='show_border'){var height_drag_bar=this.container.child('div.height_drag_bar');var body=this.container.child('div.body');var value=change_hash[change];if(value){body.addClass('border');if(height_drag_bar)height_drag_bar.addClass('border');}else{body.removeClass('border');if(height_drag_bar)height_drag_bar.removeClass('border');}}else if(title_keys.indexOf(change)!=-1){re_render_title=true;}}
if(re_render_title){var body=this.container.child('div.body');var html=this.render_title();var title_div=this.container.child('div.title');title_div.remove();Ext.DomHelper.insertBefore(body,html);}},});SG.Widget.Canvas.Designer=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.Designer.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.Designer,SG.Component,{templates:{header:'<center><div class="title">DESIGN MODE - {title}</div></center>'+'<div class="controls">'+'<a target="_blank" href="'+SG.globals.help_urls.canvas_design+'">'+'<div class="icon_help_balloon_sm" sg_tip="View Documentation on Canvas Design"></div></a>'+'<span class="cancel">Cancel</span>&nbsp;&nbsp;{save_as}'+'<input class="save" type="button" value="Save">'+'</div>',save_as:'<span class="save_as">Save As...</span>&nbsp;&nbsp;'},init_component:function(){sg_close_all_floating_windows();this.dirty=this.page.dirty;this.render();},destroy_component:function(){this.container.remove();},render:function(){var dh=Ext.DomHelper;this.container=dh.append(document.body,{tag:'div',cls:'sgc_canvas_designer'},true);this.header_elem=dh.append(this.container,{tag:'div',cls:'sgc_canvas_designer_header'},true);this.add_event(this.header_elem,'click',this.on_header_click);this.tools_elem=dh.append(this.container,{tag:'div',cls:'sgc_canvas_designer_tools'},true);this.page_elem=dh.append(this.container,{tag:'div',cls:'sgc_canvas_designer_page sg_page',id:'sg_page_'+this.page.id},true);this.add_event(this.page_elem,'click',this.on_page_click);this.render_header();this.render_page();this.render_tools();dh.append(this.container,{tag:'div',id:'sgc_canvas_designer_drag_proxy'});var widget_dnd=new SG.Widget.Canvas.WidgetDrag({container:this.container,drag_element_proxy_id:'sgc_canvas_designer_drag_proxy',canvas_designer:this});},render_header:function(){this.header_elem.update(this.templates.header.apply({title:this.page_title,save_as:this.no_save_as?'':this.templates.save_as.apply()}));},render_tools:function(){if(this.canvas_tools)
this.canvas_tools.destroy();this.canvas_tools=new SG.Widget.Canvas.DesignerTools({container:this.tools_elem,page:this.design_page});},render_page:function(){var context=sg_deep_copy(this.page.context.settings);context.design_mode=true;context.block_navigation=true;var settings=sg_deep_copy(this.page.spec.to_hash());var cfg={id:this.page.id,canvas_designer_page:true};this.design_page=new SG.Page(cfg,context,settings);this.design_page.canvas_designer=this;},on_header_click:function(e){var t=Ext.get(e.getTarget());var cancel=t.findParent('span.cancel',this.container,true);if(cancel){this.design_page.destroy_root_widget();this.destroy();return;}
var save=t.findParent('input.save',this.container,true);if(save){this.save_page();return;}
var save_as=t.findParent('span.save_as',this.container);if(save_as){this.save_page_as();}},save_page:function(){if(!this.page_ready_to_save())return;this.canvas_tools.prepare_for_page_save({fn:this.on_canvas_tools_page_save,scope:this});},page_ready_to_save:function(){var config=this.count_configured_canvas_wrappers();if(config.count==0){alert('The canvas page can not be saved without any widgets.');return false;}
if(config.count!=config.configured){var total=config.count-config.configured;var message='The page can not be saved until all widgets have been configured. ';if(total==1)
message+='There is 1 widget that has not been configured. ';else
message+='There are '+total+' widgets that have not been configured. ';message+=' The following tabs contain unconfigured widgets: '+config.tabs.join(', ');alert(message);return false;}
if(this.design_page.check_for_filter_panels_with_active_custom_filters())
return false;return true;},save_page_as:function(){if(!this.page_ready_to_save())return;var config={page:this.design_page,data_set:this.canvas_tools.page_data_set,on_create_page:{fn:this.on_create_saved_page,scope:this}};var dialog=new SG.SavePageAsDialog(config);},on_create_saved_page:function(record){this.design_page.settings_save_as(record,true);},on_canvas_tools_page_save:function(page_name)
{this.design_page.root_widget.set('empty',false);this.design_page.root_widget.prepare_any_pending_settings();this.page.name=page_name;this.page.context.set('title',page_name);this.page.set_spec(new SG.Widget.Spec(this.page,this.design_page.spec.to_hash()));this.page.canvas_designer_page=true;this.page.set_dirty(true);this.page.destroy_root_widget();this.page.construct_root_widget();this.page.settings_save();this.page.canvas_designer_page=false;this.design_page.destroy_root_widget();this.destroy();},count_configured_canvas_wrappers:function()
{var spec=this.design_page.spec.to_hash();var layouts=spec.settings.layouts;if(!layouts)
layouts=[{name:"body",display_name:"Default"}];var wrapper_count=0;var wrapper_configured=0;var tabs_unconfigured=[];for(var i=0;i<layouts.length;i++){var layout=layouts[i];var layout_spec=spec.children[layout.name];var row_names=layout_spec.settings.rows;if(!row_names){wrapper_count++;wrapper_configured++;continue;}
for(var j=0;j<row_names.length;j++){var row_name=row_names[j];var row_spec=layout_spec.children[row_name];for(var child in row_spec.children){if(!row_spec.children.hasOwnProperty(child))continue;wrapper_count++;var child_spec=row_spec.children[child];if(child_spec.settings.configured==undefined||child_spec.settings.configured==true){wrapper_configured++;}else{if(tabs_unconfigured.indexOf(layout.display_name)==-1)
tabs_unconfigured.push(layout.display_name);}}}}
return{count:wrapper_count,configured:wrapper_configured,tabs:tabs_unconfigured};},get_default_widget_spec:function(widget_variation){var widget_types=SG.Widget.Canvas.widget_types;var settings={};for(var i=0;i<widget_types.length;i++){var widget_type=widget_types[i];if(widget_type.variation==widget_variation){variation_display_name=widget_type.display_name;maximizable=widget_type.maximizable;settings=sg_deep_copy(widget_type.settings);settings.entity_type_varies=widget_type.entity_type_varies;settings.variation=widget_variation;settings.variation_display_name=widget_type.display_name;settings.title='New '+variation_display_name+' Widget';if(settings.configured==undefined)settings.configured=false;if(settings.collapsable==undefined)settings.collapsable=true;if(settings.collapsed==undefined)settings.collapsed=false;break;}}
var s={type:"SG.Widget.Canvas.Wrapper",settings:settings,};if(widget_variation=="Divider"){s.settings.show_title=false;s.settings.title="Divider";s.settings.show_border=false;s.settings.collapsable=false;s.settings.configured=true;s.settings.configurable=false;s.settings.maximizable=false;s.children={child:{type:"SG.Widget.Divider",settings:{mode:"hr"}}};}
return s;},on_page_click:function(e){var target=Ext.get(e.getTarget());var header_div=target.findParent('div.sg_detail_widgets_edit_header');if(header_div){var edit_div=target.findParent('div.edit');if(!edit_div)return;var widget_id=Number(header_div.getAttribute('widget_id'));var entity_type=header_div.getAttribute('entity_type');var widget=SG.Widget.get_instance_by_id(widget_id);widget.edit_widget(entity_type);}},});SG.Widget.Canvas.WidgetDrag=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetDrag.superclass.constructor.call(this,this.container,"layouts",{dragElId:this.drag_element_proxy_id,resizeFrame:false,scroll:false});};Ext.extend(SG.Widget.Canvas.WidgetDrag,Ext.dd.DDProxy,{handleMouseDown:function(e)
{var target=Ext.get(e.getTarget());var new_widget_box=target.findParent('div.widget_box',this.container,true);if(!new_widget_box)
{var sel='div.title.widget_drag';var canvas_wrapper_title_div=target.findParent(sel,this.container,true);if(!canvas_wrapper_title_div)return;this.dragging_new_widget=false;this.start_drag_elem=canvas_wrapper_title_div;}
else
{this.dragging_new_widget=true;this.start_drag_elem=new_widget_box;}
Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},b4StartDrag:function(x,y)
{this.drag_el=Ext.get(this.getDragEl());var left=this.start_drag_elem.getX();var top=this.start_drag_elem.getY();this.drag_el.removeClass('divider');if(this.dragging_new_widget)
{var widget_variation=this.start_drag_elem.dom.getAttribute('widget_variation');if(widget_variation=='Divider')
{this.drag_el.setStyle('background','white');this.drag_el.update('<div class="divider_line"></div>');this.drag_el.addClass('divider');}
else
{this.drag_el.update('');this.drag_el.setStyle('background','url(/images/icon_widget_'+widget_variation+'.png)');}
this.setDelta(x-left,y-top);this.drag_el.removeClass('wide');}
else
{var diff=this.start_drag_elem.getWidth()-this.drag_el.getWidth();var title_text=this.start_drag_elem.dom.getAttribute('title_text');this.drag_el.setStyle('background','white');this.drag_el.update('<div class="title">'+title_text+'</div>');this.drag_el.addClass('wide');this.setDelta(40,10);}
this.cache_drag_targets();Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},onDrag:function(e)
{var x=e.getXY()[0];var y=e.getXY()[1];var target=this.find_drag_target(x,y);if(!target)
{if(this.last_target)
{this.last_target.removeClass('widget_drag_over');this.last_target=null;}
return;}
target.addClass('widget_drag_over');if(this.last_target&&this.last_target!=target)
this.last_target.removeClass('widget_drag_over');this.last_target=target;},endDrag:function(e)
{if(!this.last_target)return;this.last_target.removeClass('widget_drag_over');if(this.dragging_new_widget)
{var widget_variation=this.start_drag_elem.dom.getAttribute('widget_variation');var spec=this.canvas_designer.get_default_widget_spec(widget_variation);if(this.last_target.hasClass('add_to_column_drag_target'))
{var widget_id=Number(this.last_target.dom.getAttribute('widget_id'));var canvas_row=SG.Widget.get_instance_by_id(widget_id);canvas_row.add_wrapper_to_column(spec,Number(this.last_target.dom.getAttribute('col_index')));}
else
{var parts=this.last_target.dom.id.split('_');var canvas_wrapper_widget=SG.Widget.get_instance_by_id(Number(parts[1]));var canvas_row=canvas_wrapper_widget.get_parent();canvas_row.insert_wrapper(spec,canvas_wrapper_widget);}}
else
{var drag_widget_id=Number(this.start_drag_elem.dom.getAttribute('widget_id'));var drag_widget=SG.Widget.get_instance_by_id(drag_widget_id);if(this.last_target.hasClass('add_to_column_drag_target'))
{var widget_id=Number(this.last_target.dom.getAttribute('widget_id'));var canvas_row=SG.Widget.get_instance_by_id(widget_id);var col=Number(this.last_target.dom.getAttribute('col_index'));canvas_row.move_widget_to_this_column(drag_widget,col);}
else
{var parts=this.last_target.dom.id.split('_');var above_this_widget=SG.Widget.get_instance_by_id(Number(parts[1]));var canvas_row=above_this_widget.get_parent();canvas_row.move_widget(drag_widget,above_this_widget);}}},find_drag_target:function(x,y)
{for(var i=0;i<this.target_cache.length;i++)
{var target=this.target_cache[i];if(x>target.left&&x<target.right&&y>target.top&&y<target.bottom)
return target.elem;}
return null;},cache_drag_targets:function()
{var left,right,top,bottom,middle,width,height;this.target_cache=[];var canvas_rows=sg_find_all('div.sgw_canvas_row',this.container.dom)
for(var k=0;k<canvas_rows.length;k++)
{var canvas_row=Ext.get(canvas_rows[k]);var tds=sg_find_all('td.row_column',canvas_row.dom);for(var i=0;i<tds.length;i++)
{var td=Ext.get(tds[i]);var add_to_column_elem=td.child('div.add_to_column_drag_target');var wrappers=sg_find_all('div.sgw_canvas_wrapper',td.dom);var lowest=0;for(var j=0;j<wrappers.length;j++)
{var div=Ext.get(wrappers[j]);left=div.getLeft();top=div.getTop();width=div.getWidth();height=div.getHeight();bottom=top+height;right=left+width;middle=(top+bottom)/2;this.target_cache.push({left:left,top:top,right:right,bottom:middle,elem:div});this.target_cache.push({left:left,top:middle,right:right,bottom:bottom,elem:(j<wrappers.length-1)?Ext.get(wrappers[j+1]):add_to_column_elem});if(bottom>lowest)lowest=bottom;}
left=td.getLeft();top=td.getTop();width=td.getWidth();height=td.getHeight();bottom=top+height;right=left+width;if(k==canvas_rows.length-1)
{var container_top=this.container.getTop();var container_height=this.container.getHeight();var container_bottom=container_top+container_height;if(container_bottom>bottom)
bottom=container_bottom;}
this.target_cache.push({left:left,top:lowest,right:right,bottom:bottom,elem:add_to_column_elem});}}},});SG.Widget.Canvas.widget_types=[{variation:'Grid',display_name:'Grid',help_entry:184915,sg_tip:'A spreadsheet-like list of details for a filtered set of records',entity_type_varies:true,settings:{maximizable:true,}},{variation:'Gantt',display_name:'Task & Gantt',help_entry:184918,sg_tip:'A list of filtered Tasks with the Gantt pane enabled',settings:{maximizable:true,}},{variation:'ThumbnailGrid',display_name:'Thumbnails',help_entry:184919,sg_tip:'Displays the thumbnails for a filtered group of records',entity_type_varies:true,settings:{maximizable:true,}},{variation:'Thumbnail',display_name:'Single Thumbnail',help_entry:184920,sg_tip:"Displays one thumbnail for a single record, such as a Project or Person.  Commonly used "+"on a record's detail page",entity_type_varies:true,settings:{maximizable:true,}},{variation:'NewFields',display_name:'Fields',help_entry:184921,sg_tip:'A list of fields and values for a single record, such as a Project or Person.',entity_type_varies:true,settings:{maximizable:true,}},{variation:'Iframe',display_name:'Web Page',help_entry:184922,sg_tip:'An embedded webpage from an URL',settings:{maximizable:true,}},{variation:'Graph',display_name:'Graph',help_entry:184923,sg_tip:'A bar chart for a filtered group of records',entity_type_varies:true,settings:{maximizable:true,}},{variation:'Assignments',display_name:'Task Assignment Cards',help_entry:184925,sg_tip:'Cards containing all the information an Artist needs to see about their assigned Tasks, including '+'the linked Entity (Shot, Asset, etc.), related Tasks by Pipeline Step, and related Notes',settings:{maximizable:true,show_border:false,}},{variation:'TaskActivity',display_name:'My Task History',help_entry:184926,sg_tip:'Shows the last 5 changes to Tasks assigned to the person viewing the page',settings:{maximizable:true,}},{variation:'Countdown',display_name:'Countdown',help_entry:-1,sg_tip:'Count down the number of days to an event',settings:{maximizable:true,show_border:false,collapsable:false,show_title:false,}},];SG.Widget.Canvas.DesignerTools=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.DesignerTools.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.DesignerTools,SG.Component,{templates:{body:'<div class="tabs">'+'<div class="tab page_tab {page_active}"><span>Page</span></div>'+'<div class="tab layout_tab {layout_active}"><span>Tab</span></div>'+'<div class="tab widgets_tab {widgets_active}"><span>Widgets</span></div>'+'</div><div class="controls">{controls}</div>'+'<div id="sgc_canvas_designer_row_drag_proxy"></div>',widget_table:'<div class="widget_row"><table class="widget_table"><tr><td class="widget">{first}</td>'+'<td class="widget">{second}</td></tr></table></div>',widget:'<div class="widget_box" widget_variation="{widget_variation}" widget_name="{widget_name}" '+'style="background: url(/images/icon_widget_{widget_variation}.png);" sg_tip="{sg_tip}"></div>'+'<div class="widget_label"><center>{widget_name}</center></div>',divider:'<div class="widget_row">'+'<div class="widget_box divider" widget_variation="Divider" widget_name="Divider" '+'sg_tip="A horizontal rule">'+'<div class="divider_line"></div></div>'+'<div class="widget_label"><center>Divider</center></div></div>',row:'<div class="row">{row_header}'+'<div class="row_controls">{column_buttons}{column_layouts}</div></div>',row_header:'<div class="row_header"><span>Row {row_num_display}</span>'+'<div class="field_prop_drag_handle"></div>'+'<div class="trash" row_widget_name="{row_widget_name}"></div></div>',column_button:'<td><div class="column_button {selected}" cols="{num}" row_widget_name="{row_widget_name}">'+'<center>{num}</center></div></td>',column_buttons:'<div class="column_buttons">'+'<table><tr>{buttons}<td><div class="columns_label">Columns</div></td></tr></table></div>',layout_box:'<td style="width:{width}%"><div class="layout_box" width="{width}"></div></td>',layout_box_table:'<div class="layout_choice {selected}" col_index="{col_index}" choice_index="{choice_index}" '+'row_widget_name="{row_widget_name}"><table><tr>{boxes}</tr></table></div>',add_row_button:'<div class="add_row_button"><center>Add Row</center></div>',message:'<div class="message">{message}</div>',setting_row:'<div class="setting_row"><table class="fixed"><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value {extra}">{value}</div></td></tr></table></div>',permissions:'<div class="page_permissions">{sharing}<div class="title">Who can see this <span class="bold">'+'page</span>:</div><div class="page_permission_toggles">{toggles}</div></div>',share_menu:'<div class="fake_menu fake_input" value="{menu_value}" ><div class="menu_label">{label}</div>'+'<img class="drop_down_small" src="/images/dropdown_arrow_small.png"></div>',text_input:'<input type="text" setting="{setting}" value="{value}">',tag:'<div class="tag">{tag_name}</div>',permission_role:'<div class="role">{checkbox}<span class="role_name">{display_name}</span></div>',page_settings:'<div class="page_settings">{settings}</div>',tab_permissions:'<div class="title">Who can see this <span class="bold">tab</span>:</div>',field_value:'<div class="field_value {cell_classes}" {cell_attributes}>{cell_content}</div>',},column_layouts:[[[100]],[[30,70],[50,50],[70,30]],[[33,33,34],[25,50,25],[50,25,25],[25,25,50]],[[25,25,25,25],[40,20,20,20],[20,40,20,20],[20,20,40,20],[20,20,20,40]],],init_component:function()
{this.mode='page';this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);this.add_event(SG.Checkbox,'change',this.on_checkbox_change);this.render();var dz_cfg={container:this.container,reorder_callback:{fn:this.reorder_rows,scope:this},drag_handle_selector:'div.field_prop_drag_handle',row_element_selector:'div.row',row_proxy_name_selector:'div.row_header',drag_element_proxy_id:'sgc_canvas_designer_row_drag_proxy',b4_start_drag_callback:{fn:this.b4_reorder_rows_drag,scope:this}};var dz=new SG.util.RowDragReorder(dz_cfg);},b4_reorder_rows_drag:function(x,y)
{var add_row_button=this.container.child('div.add_row_button');add_row_button.setVisible(false);},reorder_rows:function()
{var trash_divs=sg_find_all('div.trash',this.container.dom);var new_order=[];for(var i=0;i<trash_divs.length;i++)
{var div=Ext.get(trash_divs[i]);if(div.dom.parentNode.id!='sgc_canvas_designer_row_drag_proxy')
new_order.push(div.dom.getAttribute('row_widget_name'));}
this.page.root_widget.reorder_rows(new_order);this.render();},on_click:function(e)
{var t=Ext.get(e.getTarget());var tab_div=t.findParent('div.tab',this.container,true);if(tab_div)
{if(tab_div.hasClass('page_tab'))
this.mode='page';else if(tab_div.hasClass('layout_tab'))
this.mode='layout';else
this.mode='add_widget';this.render();return;}
if(this.mode=='add_widget')
return;var row_trash=t.findParent('div.trash',this.container);if(row_trash)
{var q="Are you sure you want to delete the row and all its widgets?";if(confirm(q)){this.page.root_widget.delete_row(row_trash.getAttribute('row_widget_name'));this.render();}}
var column_button=t.findParent('div.column_button',this.container);if(column_button)
{var row_widget_name=column_button.getAttribute('row_widget_name');var num_cols=Number(column_button.getAttribute('cols'));var row_widgets=this.page.root_widget.get_canvas_rows();for(var i=0;i<row_widgets.length;i++)
{var row_widget=row_widgets[i];if(row_widget.get_name_in_parent()==row_widget_name)
{row_widget.change_column_count(num_cols);this.render();return;}}
return;}
var layout_choice_div=t.findParent('div.layout_choice',this.container);if(layout_choice_div)
{var col_index=Number(layout_choice_div.getAttribute('col_index'));var choice_index=Number(layout_choice_div.getAttribute('choice_index'));var column_layout=this.column_layouts[col_index];var column_widths=column_layout[choice_index];var row_widget_name=layout_choice_div.getAttribute('row_widget_name');var row_widgets=this.page.root_widget.get_canvas_rows();for(var i=0;i<row_widgets.length;i++)
{var row_widget=row_widgets[i];if(row_widget.get_name_in_parent()==row_widget_name)
{row_widget.change_column_widths(column_widths);this.render();return;}}
return;}
var add_row_button=t.findParent('div.add_row_button',this.container);if(add_row_button)
{this.page.root_widget.add_row();this.render();return;}
if(this.mode!='page')
return;var fake_menu=t.findParent('div.fake_menu',this.container,true);if(fake_menu)
this.show_page_sharing_menu(fake_menu);},on_change:function(e){var t=e.getTarget();if(t.getAttribute("type")=="text")
{var setting=t.getAttribute('setting');if(!setting)return;if(setting=='tab_name'){this.page.root_widget.rename_selected_layout(t.value);}}},show_page_sharing_menu:function(page_sharing_menu_div)
{if(!this.page_sharing_menu){this.page_sharing_menu=new SG.Menu({item_selected:{fn:this.on_page_sharing_menu,scope:this}});}
var current_value=page_sharing_menu_div.dom.getAttribute('value');var project=this.find_page_in_design_project();var items=[];items.push({html:'No one',value:'no_one',checked:current_value=='no_one',disabled:(project!==null)});if(project){items.push({html:project.name+' Project',value:'project',checked:current_value=='project'});}else{items.push({html:'Everyone',value:'everyone',checked:current_value=='everyone'});}
this.page_sharing_menu.items=items;this.page_sharing_menu.render();this.page_sharing_menu.position={dom_elem:page_sharing_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.page_sharing_menu.show();},on_page_sharing_menu:function(menu,menu_item)
{this.page_sharing_mode=menu_item.value;var record=this.page_data_set.get_record(0);if(menu_item.value=='no_one'){record.set('shared',false);}else{record.set('shared',true);}
var me=this;setTimeout(function(){me.re_render_page_sharing_controls()},0);},re_render_page_sharing_controls:function()
{var fake_menu_div=this.container.child('div.fake_menu');if(!fake_menu_div)return;var parent_div=Ext.get(fake_menu_div.dom.parentNode);var html=this.templates.share_menu.apply({label:this.get_page_sharing_label(),menu_value:this.page_sharing_mode});parent_div.update(html);this.re_render_page_permissions();},render:function()
{if(this.mode=='page'){this.fetch_page_data();this.construct_cell_manager();}
var cntrl_html='';if(this.mode=='page')
cntrl_html=this.render_page_controls();else if(this.mode=='layout')
cntrl_html=this.render_tab_controls();else
cntrl_html=this.render_add_widget_controls();this.container.update(this.templates.body.apply({widgets_active:this.mode=='add_widget'?'active':'',layout_active:this.mode=='layout'?'active':'',page_active:this.mode=='page'?'active':'',controls:cntrl_html}));},get_page_in_design:function()
{return this.page.canvas_designer.page;},find_page_in_design_project:function()
{var page=this.get_page_in_design();if(!page.project_id)return null;for(var i=0;i<SG.schema.projects.length;i++){var project=SG.schema.projects[i];if(project.id==page.project_id)
return project;}
return null;},render_page_controls:function()
{var the_page=this.get_page_in_design();var record=this.page_data_set.get_record(0);var cell=this.cell_manager.get_cell('name');var html=this.templates.setting_row.apply({label:'Name:',extra:'name_field',value:record?this.templates.field_value.apply(cell.render(record)):'',});var project_name='';if(record){project=record.get('project');if(project)
project_name=project.name;}
html+=this.templates.setting_row.apply({label:'Project:',extra:'project_field',value:project_name});cell=this.cell_manager.get_cell('tag_list');html+=this.templates.setting_row.apply({label:'Tags:',extra:'tag_list_field',value:record?this.templates.field_value.apply(cell.render(record)):'',});cell=this.cell_manager.get_cell('folder');html+=this.templates.setting_row.apply({label:'Folder:',extra:'folder_field',value:record?this.templates.field_value.apply(cell.render(record)):'',});var folder_text='Create nested folders by separating folder names with -> ( Example: Reports->Client )';html+=this.templates.setting_row.apply({label:'',value:folder_text,});if(!this.is_a_landing_page()){html+=this.templates.permissions.apply({sharing:this.templates.setting_row.apply({label:'Share with:',value:this.templates.share_menu.apply({label:this.get_page_sharing_label(),menu_value:this.page_sharing_mode})}),toggles:this.permissions?this.render_page_permissions():'',});}
return this.templates.page_settings.apply({settings:html});},is_a_landing_page:function(){var page=this.get_page_in_design();return(['global_report','project'].indexOf(page.ui_category)!=-1||page.type=='home'||(page.type=='detail'&&page.entity_type=='Project'));},page_sharing_labels:{no_one:'No one',everyone:'Everyone',project:'Project'},get_page_sharing_label:function(){if(this.page_sharing_mode=='project'){var project=this.find_page_in_design_project();return project.name+' Project';}
return this.page_sharing_labels[this.page_sharing_mode];},construct_cell_manager:function(){if(this.cell_manager)
return;var project=this.find_page_in_design_project();var config={container:this.container,data_set:this.page_data_set,projects:project?[project]:[],in_form:true,get_fields_callback:{fn:this.get_page_fields,scope:this},};this.cell_manager=new SG.CellManager(config);},get_page_fields:function(){return['name','tag_list','folder','shared','ui_category'];},fetch_page_data:function(){if(this.page_data_set)
return
var page=this.get_page_in_design();this.page_data_set=new SG.Data.Set('Page');this.add_event(this.page_data_set,'load',this.on_page_data_set_load);this.add_event(this.page_data_set,'change',this.on_page_data_set_change);var spec={type:'Page',id:page.id,columns:this.get_page_fields(),result:this.page_data_set};SG.Repo.find(spec);var project=this.find_page_in_design_project();this.page_sharing_mode=project?'project':'everyone';if(SG.globals.current_user.can_set_permissions){var params={page_ids:[page.id]};params.page_ids=JSON.stringify(params.page_ids);var options={url:SG.globals.urls.get_page_permissions,params:params,callback:function(options,success,response){if(success){response=Ext.decode(response.responseText);this.permissions={denied:response.page_denied_permission_rule_sets};this.saved_permissions={denied:sg_deep_copy(response.page_denied_permission_rule_sets)};this.re_render_page_permissions();}
else
{}},scope:this};Ext.Ajax.request(options);}},render_page_permissions:function()
{var html='';if(this.page_sharing_mode!='no_one'&&SG.globals.current_user.can_set_permissions)
{for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
{var role=SG.globals.human_user_permission_groups[i];var checkbox_id="page_permissions_"+role.id;var state=this.get_permission_state(role.id);disabled=(state=='checked'&&role.code==SG.globals.current_user.permission_rule_set.rule_set_code);html+=this.templates.permission_role.apply({code:role.code,display_name:role.display_name,checkbox:SG.Checkbox.render(checkbox_id,'page_permissions_checkbox',state,disabled,role.code)});}}
return html;},re_render_page_permissions:function(){var html=this.render_page_permissions();var toggles_div=this.container.child('div.page_permission_toggles');if(!toggles_div)return;toggles_div.update(html);},get_permission_state:function(role_id)
{var page=this.get_page_in_design();var denials=0;if(this.permissions.denied[page.id].indexOf(role_id)>-1)
denials++;if(denials==0)
return"checked";else if(denials==1)
return"unchecked";else
return"dashed";},on_page_data_set_load:function()
{var div=this.container.child('div.name_field');if(!div)return;var td=Ext.get(div.dom.parentNode);var record=this.page_data_set.get_record(0);var cell=this.cell_manager.get_cell('name');var html=this.templates.field_value.apply(cell.render(record));td.update(html);div=this.container.child('div.project_field');td=Ext.get(div.dom.parentNode);var project=record.get('project');html='';if(project)html=project.name;td.update(html);div=this.container.child('div.tag_list_field');td=Ext.get(div.dom.parentNode);cell=this.cell_manager.get_cell('tag_list');html=this.templates.field_value.apply(cell.render(record));td.update(html);div=this.container.child('div.folder_field');td=Ext.get(div.dom.parentNode);cell=this.cell_manager.get_cell('folder');html=this.templates.field_value.apply(cell.render(record));td.update(html);var shared=record.get('shared');if(!shared){this.page_sharing_mode='no_one';this.re_render_page_sharing_controls();}},render_add_widget_controls:function()
{if(this.page.root_widget.get_canvas_rows()==false)
return this.templates.message.apply({message:'Widgets can not be added to this layout just yet.'});var widget_types=SG.Widget.Canvas.widget_types;var h='';for(var i=0;i<widget_types.length;i+=2)
{var widget_type=widget_types[i];var first=this.templates.widget.apply({widget_name:widget_type.display_name,widget_variation:widget_type.variation,sg_tip:widget_type.sg_tip});var second='';if(i+1<widget_types.length)
{widget_type=widget_types[i+1];second=this.templates.widget.apply({widget_name:widget_type.display_name,widget_variation:widget_type.variation,sg_tip:widget_type.sg_tip});}
h+=this.templates.widget_table.apply({first:first,second:second});}
h+=this.templates.divider.apply();return h;},render_tab_controls:function()
{var selected_layout=this.page.root_widget.get_selected_layout();var layouts=this.page.root_widget.get_layouts();var layout_name='';for(var i=0;i<layouts.length;i++){if(layouts[i].name==selected_layout){layout_name=layouts[i].display_name;break;}}
var h=this.templates.setting_row.apply({label:'Name:',extra:'',value:this.templates.text_input.apply({setting:'tab_name',value:layout_name})});var row_widgets=this.page.root_widget.get_canvas_rows();if(row_widgets!=false)
{for(var i=0;i<row_widgets.length;i++)
{var row_widget=row_widgets[i];var row_widget_name=row_widget.__name_in_parent__;var num_columns=Number(row_widget.get('num_columns'));var column_widths=row_widget.get('column_widths');var buttons='';for(var j=1;j<=4;j++)
{buttons+=this.templates.column_button.apply({selected:num_columns==j?'selected':'',num:j,row_widget_name:row_widget_name});}
var column_buttons=this.templates.column_buttons.apply({buttons:buttons,selected:''})
var column_layouts='';var column_layout=this.column_layouts[num_columns-1];for(var k=0;k<column_layout.length;k++)
{var layout_boxes='';var box_widths=column_layout[k];var widths_match=true;for(var ii=0;ii<box_widths.length;ii++)
{if(Number(box_widths[ii])!=Number(column_widths[ii]))widths_match=false;layout_boxes+=this.templates.layout_box.apply({width:box_widths[ii]});}
column_layouts+=this.templates.layout_box_table.apply({boxes:layout_boxes,col_index:num_columns-1,choice_index:k,selected:widths_match?'selected':'',row_widget_name:row_widget_name});}
h+=this.templates.row.apply({row_header:this.templates.row_header.apply({row_widget_name:row_widget_name,row_num_display:(i+1)}),column_buttons:column_buttons,column_layouts:column_layouts});}
h+=this.templates.add_row_button.apply();}
h+=this.templates.tab_permissions.apply();var roles=[];var checked;for(var i=0;i<SG.globals.human_user_permission_groups.length;i++){var role=SG.globals.human_user_permission_groups[i];checked=this.page.root_widget.allowed_layout(null,role.code);disabled=(checked&&role.code==SG.globals.current_user.permission_rule_set.rule_set_code);var checkbox_id="tab_permissions_"+role.code;h+=this.templates.permission_role.apply({code:role.code,display_name:role.display_name,checkbox:SG.Checkbox.render(checkbox_id,'tab_permissions_checkbox',checked,disabled,role.code)});}
return h;},on_checkbox_change:function(checkbox){if(!this.container.contains(checkbox))return;var id=checkbox.getAttribute('id');if(id.indexOf('tab_permission')!=-1){var checked=checkbox.getAttribute('checkbox_state')=='checked';var canvas_page=this.page.root_widget;var role_id=id.substring(16);setTimeout(function(){canvas_page.set_current_layout_permissions(role_id,checked)},0);}else{var state=checkbox.getAttribute('checkbox_state');var role_id=Number(id.substring(17));this.set_permission_rule_set_permissions(role_id,(state=="unchecked"));}},prepare_for_page_save:function(done_callback){this.page_save_callback=done_callback;if(SG.globals.current_user.can_set_permissions){var page=this.get_page_in_design();var options={url:SG.globals.urls.set_page_permissions,params:{page_id:page.id,page_denied_permission_rule_sets:Ext.encode(this.permissions.denied)},callback:function(options,success,response){if(success){if(response.responseText=='successful')
this.commit_page_data();else
new SG.ServerErrorHandler().notify_user(response);}else{new SG.ServerErrorHandler().notify_user(response);}},scope:this};Ext.Ajax.request(options);}else{this.commit_page_data();}},set_permission_rule_set_permissions:function(role_id,denied)
{var page=this.get_page_in_design();var role_id_index=this.permissions.denied[page.id].indexOf(role_id);if(denied&&(role_id_index==-1))
this.permissions.denied[page.id].push(role_id);else if(!denied&&(role_id_index>-1))
this.permissions.denied[page.id].splice(role_id_index,1);},on_page_data_set_change:function(changes){var update_found=false;for(var i=0;i<changes.length;i++){change=changes[i];if(change.type=="update"&&change.state=="server")
update_found=true;}
if(update_found)
this.fire_page_save_callback();},commit_page_data:function(){var dirty_count=this.page_data_set.count_status('dirty');if(dirty_count==0)
this.fire_page_save_callback();else
this.page_data_set.commit(true);},fire_page_save_callback:function(){var rec=this.page_data_set.get_record(0);this.page_save_callback.fn.call(this.page_save_callback.scope,rec.get('name'));},});SG.Widget.Canvas.Tabs=function(cfg)
{Ext.apply(this,cfg);SG.Widget.Canvas.Tabs.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.Tabs,SG.Component,{templates:{tab_cell:'<td class="tab_cell {selected} {last}" tab_idx="{tab_idx}" name="{tab_name}">'+'<div>{tab_display_name}{menu}</div></td>',tab_cell_menu:'<img class="menu" src="/images/dropdown_arrow_small.png">',new_tab_cell:'<td class="new_tab_cell"><span style="font-weight:bold">+</span> New Tab</td>',tab_edge:'<td class="tab_edge"><div>&nbsp</div></td>',tabs:'<div class="tab_wrap">'+'<table class="tab_strip"><colgroup span="{num_tabs}" width="0*"/>'+'<colgroup span="1" width="100%"/><tr>{cells}</tr></table></div>'+'<div class="scroll_button left_scroll enabled"><</div>'+'<div class="scroll_button right_scroll enabled">></div>'},init_component:function()
{this.design_mode=this.canvas_page.context.get('design_mode');this.add_event(this.container,'click',this.on_click);if(this.design_mode)
this.add_event(this.container,'contextmenu',this.on_context_click);Ext.EventManager.onWindowResize(this.update_scroll_buttons,this);},render:function(){var cell_params,layout;var tab_cells="";var selected_layout=this.canvas_page.get_selected_layout();var layouts=this.canvas_page.get_layouts();var allowed_layouts=0;var last_visible_tab_index=this.find_next_visible_to_left(layouts.length);if(last_visible_tab_index==-1)
last_visible_tab_index=layouts.length-1;for(var i=0;i<layouts.length;i++)
{layout=layouts[i];if(this.design_mode&&!this.canvas_page.allowed_layout(layout))
continue;allowed_layouts+=1;cell_params={last:''};cell_params.tab_name=layout.name;cell_params.tab_display_name=layout.display_name;cell_params.tab_idx=i;if(selected_layout==layout.name)
cell_params.selected="selected";if(i==last_visible_tab_index)
cell_params.last='last';if(this.design_mode)
cell_params.menu=this.templates.tab_cell_menu.apply();tab_cells+=this.templates.tab_cell.apply(cell_params);}
if(this.design_mode)
tab_cells+=this.templates.new_tab_cell.apply();tab_cells+=this.templates.tab_edge.apply();var h='';var num_layouts=this.design_mode?allowed_layouts+1:allowed_layouts;h=this.templates.tabs.apply({cells:tab_cells,num_tabs:num_layouts});this.container.update(h);this.restore_scroll();this.update_scroll_buttons();},restore_scroll:function()
{var cookie=getCookie("canvas_tab_scroll_"+this.get_page().id);if(cookie)
{var tab_wrap=this.container.child('div.tab_wrap');tab_wrap.scroll('left',Number(cookie),false);}},update_scroll_buttons:function()
{var tab_wrap=this.container.child('div.tab_wrap');if(!tab_wrap)return;var tab_edge=this.container.child('td.tab_edge');var left_scroll_button=this.container.child('div.left_scroll');var right_scroll_button=this.container.child('div.right_scroll');var pos_w=Ext.lib.Dom.getXY(tab_wrap.dom);var pos_e=Ext.lib.Dom.getXY(tab_edge.dom);var width=tab_wrap.getWidth();var o=parseInt(tab_wrap.dom.scrollLeft,10)||0;if(o===0)
left_scroll_button.replaceClass('enabled','disabled');else
left_scroll_button.replaceClass('disabled','enabled');if(pos_e[0]<(pos_w[0]+width))
right_scroll_button.replaceClass('enabled','disabled');else
right_scroll_button.replaceClass('disabled','enabled');},on_click:function(e){var t=Ext.get(e.getTarget());var new_tab_cell=t.findParent('td.new_tab_cell',this.container,true);if(new_tab_cell){this.new_tab();return;}
var tab_cell=t.findParent('td.tab_cell',this.container,true);if(tab_cell){var img_menu=t.findParent('img.menu',this.container);if(img_menu){this.show_menu(tab_cell);return;}
var name=tab_cell.dom.getAttribute('name');this.select_tab(name);return;}
var left_scroll=t.findParent('div.left_scroll',this.container,true);if(left_scroll&&!left_scroll.hasClass('disabled'))
{this.scroll_left();return;}
var right_scroll=t.findParent('div.right_scroll',this.container,true);if(right_scroll&&!right_scroll.hasClass('disabled'))
{this.scroll_right();return;}},scroll_left:function()
{var tab_wrap=this.container.child('div.tab_wrap');tab_wrap.scroll('right',100,true);var me=this;setTimeout(function(){me.update_scroll_buttons();},500);},scroll_right:function()
{var tab_wrap=this.container.child('div.tab_wrap');tab_wrap.scroll('left',100,true);var me=this;setTimeout(function(){me.update_scroll_buttons();},500);},on_context_click:function(e)
{var t=Ext.get(e.getTarget());var tab_cell=t.findParent('td.tab_cell',this.container,true);if(tab_cell){e.stopEvent();this.show_menu(tab_cell);return;}},show_menu:function(tab_elem){if(this.tab_menu===undefined){this.tab_menu=this.new_component(SG.Menu,{icon_width:11,item_selected:{fn:this.on_menu_selected,scope:this},before_show:{fn:this.on_before_show_menu,scope:this}});}
this.tab_menu.tab_elem=tab_elem;this.tab_menu.position={dom_elem:tab_elem,elem_anchor:"bl",menu_anchor:"tl"};this.tab_menu.show();},on_before_show_menu:function(menu){var items=[];var tab_idx=Number(menu.tab_elem.dom.getAttribute("tab_idx"));var layouts=this.canvas_page.get_layouts();var layout_name=menu.tab_elem.dom.getAttribute("name");var allowed_layout=this.canvas_page.allowed_layout(this.canvas_page.get_layout(layout_name));items.push({icon_name:'move_left',html:'Move Tab Left',value:'move_tab_left',disabled:(this.find_next_visible_to_left(tab_idx)==-1)});items.push({icon_name:'move_right',html:'Move Tab Right',value:'move_tab_right',disabled:(this.find_next_visible_to_right(tab_idx)==-1)});items.push({line:true});items.push({html:'Duplicate Tab',value:'duplicate_tab',disabled:(!allowed_layout)});items.push({html:'Rename Tab...',value:'rename_tab',disabled:(!allowed_layout)});items.push({html:'Insert New Tab...',value:'insert_tab'});var tab_spec=this.canvas_page.widget_spec.get_child_spec(layout_name);if(SG.globals.current_user.admin&&tab_spec.type=='SG.Widget.EntityQuery.EntityQueryPage'){items.push({line:true});items.push({html:'Revert Tab To Global Default',value:'revert_tab_to_global_default',disabled:(!allowed_layout),icon_name:'icon_revert'});items.push({html:'Save Tab As Global Default',value:'warn_and_save_tab_as_global_default',disabled:(!allowed_layout),icon_name:'icon_save'});}
items.push({line:true});items.push({icon_name:'trash',html:'Delete Tab',value:'delete_tab',disabled:(!allowed_layout)||layouts.length===1});menu.items=items;menu.render();},on_menu_selected:function(menu,item){var tab_idx=Number(menu.tab_elem.dom.getAttribute("tab_idx"));this[item.value].call(this,tab_idx);},select_tab:function(name){if(!SG.Page.unsaved_data.confirm_proceed())
return;if(this.canvas_page.context.get('design_mode'))
this.canvas_page.prepare_any_pending_settings();var tab_wrap=this.container.child('div.tab_wrap');setCookie("canvas_tab_scroll_"+this.get_page().id,tab_wrap.dom.scrollLeft,365);this.canvas_page.set_selected_layout(name);},delete_tab:function(tab_idx){var layouts=this.canvas_page.get_layouts();var layout=layouts[tab_idx];this.canvas_page.widget_spec.delete_child_spec(layout.name,this.canvas_page);layouts.splice(tab_idx,1);this.canvas_page.set('layouts',layouts);this.canvas_page.render_widget();this.canvas_page.update_canvas_designer();},duplicate_tab:function(tab_idx)
{var i;var layouts=this.canvas_page.get_layouts();var layout=layouts[tab_idx];var new_layout={name:this.canvas_page.generate_new_child_name('layout'),display_name:layout.display_name+" (Copy)",allowed_permission_group_codes:[]};for(i=0;i<SG.globals.human_user_permission_groups.length;i++)
new_layout.allowed_permission_group_codes.push(SG.globals.human_user_permission_groups[i].code);this.canvas_page.widget_spec.clone_child_spec(layout.name,new_layout.name,this.canvas_page);var new_layouts=[];for(i=0;i<layouts.length;i++)
{new_layouts.push(layouts[i]);if(i==tab_idx)
new_layouts.push(new_layout);}
this.canvas_page.set('layouts',new_layouts);this.canvas_page.set_selected_layout(new_layout.name);this.canvas_page.render_widget();},insert_tab:function(tab_idx){var on_create_tab_fn=function(new_name,spec){this.on_new_tab(new_name,spec);var layouts=this.canvas_page.get('layouts');var new_layout=layouts[layouts.length-1];var new_layouts=[];for(i=0;i<layouts.length-1;i++){new_layouts.push(layouts[i]);if(i==tab_idx)
new_layouts.push(new_layout);}
this.canvas_page.set('layouts',new_layouts);this.canvas_page.set_selected_layout(new_layout.name);};var page=this.canvas_page.get_page().canvas_designer.page;var nctd=new SG.NewCanvasTabDialog({title:'Insert New Tab',on_create_tab:{fn:on_create_tab_fn,scope:this},project:this.canvas_page.single_project_from_context(),context_entity:this.canvas_page.context.get('entity'),page:page});},find_next_visible_to_left:function(tab_idx)
{var layouts=this.canvas_page.get_layouts();var next_visible=-1;tab_idx-=1;while(tab_idx>-1&&next_visible==-1)
{if(this.canvas_page.allowed_layout(layouts[tab_idx]))
next_visible=tab_idx;tab_idx-=1;}
return next_visible;},find_next_visible_to_right:function(tab_idx)
{var layouts=this.canvas_page.get_layouts();var next_visible=-1;tab_idx+=1;while(tab_idx<layouts.length&&next_visible==-1)
{if(this.canvas_page.allowed_layout(layouts[tab_idx]))
next_visible=tab_idx;tab_idx+=1;}
return next_visible;},move_tab_left:function(tab_idx){var next_idx=this.find_next_visible_to_left(tab_idx);if(next_idx==-1)
return;var layouts=this.canvas_page.get_layouts();var removed=layouts.splice(tab_idx,1)[0];layouts.splice(next_idx,0,removed);this.canvas_page.set('layouts',layouts);this.render();},move_tab_right:function(tab_idx){var next_idx=this.find_next_visible_to_right(tab_idx);if(next_idx==-1)
return;var layouts=this.canvas_page.get_layouts();var removed=layouts.splice(tab_idx,1)[0];layouts.splice(next_idx,0,removed);this.canvas_page.set('layouts',layouts);this.render();},rename_tab:function(tab_idx){var layouts=this.canvas_page.get_layouts();var layout=layouts[tab_idx];var rename_fn=function(new_name){layout.display_name=new_name;this.canvas_page.set('layouts',layouts);this.canvas_page.update_canvas_designer();this.render();};var cfg={old_tab_name:layout.display_name,callback:{fn:rename_fn,scope:this}};var rtd=new SG.RenameTabDialog(cfg);},new_tab:function(){var page=this.canvas_page.get_page().canvas_designer.page;var nctd=new SG.NewCanvasTabDialog({on_create_tab:{fn:this.on_new_tab,scope:this},project:this.canvas_page.single_project_from_context(),context_entity:this.canvas_page.context.get('entity'),page:page});},on_new_tab:function(new_name,spec){var layouts=this.canvas_page.get_layouts();var new_layout={name:this.canvas_page.generate_new_child_name('layout'),display_name:new_name,allowed_permission_group_codes:[]};for(var i=0;i<SG.globals.human_user_permission_groups.length;i++)
new_layout.allowed_permission_group_codes.push(SG.globals.human_user_permission_groups[i].code);this.canvas_page.widget_spec.create_child_spec(new_layout.name,spec,this.canvas_page);layouts.push(new_layout);this.canvas_page.set('layouts',layouts);this.canvas_page.set_selected_layout(new_layout.name);},revert_tab_to_global_default:function(tab_idx){var layouts=this.canvas_page.get_layouts();var layout_name=layouts[tab_idx].name;var widget_spec=this.get_widget_spec_for_tab(tab_idx);this.replace_layout_name=layout_name;var params={widget_type:"SG.Widget.EntityQuery.EntityQueryPage",entity_type:this.canvas_page.context.get('entity').type,embedded_entity_type:widget_spec.get_setting('entity_type')};var project=this.canvas_page.single_project_from_context();if(project)
params.project_id=project.id;var options={url:SG.globals.urls.tab_widget_spec,params:params,callback:this.on_revert_to_global_default,scope:this};this.canvas_page.show_loading_overlay();var conn=new Ext.data.Connection();conn.request(options);},warn_and_save_tab_as_global_default:function(tab_idx){var widget_spec=this.get_widget_spec_for_tab(tab_idx);var entity_type=widget_spec.settings.entity_type;var edn=SG.schema.entity_types[entity_type]['display_name_pluralized'];var index=tab_idx;new SG.NewDialog({title:"Save Tab as Global Default",body:"You are about to save the settings for this Tab as the global defaults for "+edn+". You cannot undo this action. Do you want to continue?",actions:[{label:'Cancel',type:'link'},{label:'Save Tab As Global Default',callback:{fn:function(){this.save_tab_as_global_default(index);},scope:this}}]});},get_widget_spec_for_tab:function(tab_idx){var layouts=this.canvas_page.get_layouts();var layout_name=layouts[tab_idx].name;var widget_spec=this.canvas_page.widget_spec.get_child_spec(layout_name);return widget_spec;},save_tab_as_global_default:function(tab_idx){var widget_spec=this.get_widget_spec_for_tab(tab_idx);var params={entity_type:widget_spec.settings.entity_type,widget_spec:Ext.encode(widget_spec.to_hash())};var options={url:'/page/save_page_tab_as_global_default',params:params,callback:this.on_save_tab_as_global_default,scope:this};this.canvas_page.show_loading_overlay();var conn=new Ext.data.Connection();conn.request(options);},on_save_tab_as_global_default:function(options,success,response){if(success){this.canvas_page.hide_loading_overlay();}},on_revert_to_global_default:function(options,success,response){if(success){var spec={};var str='spec = '+response.responseText+';';eval(str);spec.settings.embedded=false;this.canvas_page.widget_spec.replace_child_spec(this.replace_layout_name,spec,this.canvas_page);this.canvas_page.set_selected_layout(this.replace_layout_name);this.replace_layout_name=null;this.canvas_page.hide_loading_overlay();}},destroy_component:function()
{Ext.EventManager.removeResizeListener(this.update_scroll_buttons,this);}});SG.Widget.Canvas.WidgetEditor=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor,SG.Component,{templates:{main:'<div class="left_pane">{left_pane}</div><div class="right_pane">'+'{save_cancel_controls}<div class="preview_pane"></div></div>',left_pane:'<div class="header"><div class="fake_tab">Widget</div></div>'+'<div class="options">{title}{wrapper_options}<div class="widget_properties"></div></div>',text_input:'<div class="row"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"><div class="value"><input type="text" setting="{setting}" value="{value}"></div></td>'+'</tr></table></div>',section_title:'<div class="row"><table><tr><td class="label"><div class="label">{label}</div></td>'+'<td class="value"></td></tr></table></div>',color_swatch:'<div class="row"><table><tr><td class="label">'+'<div class="color_swatch" color="{color}" style="{style}" setting="{setting}"></div>'+'</td><td><div class="label">{label}</div></td></tr></table></div>',setting_checkbox:'<div class="row"><table><tr><td class="label">'+'<div class="check_wrapper"><input type="checkbox" setting="{setting}" {checked}></div>'+'</td><td><div class="label">{label}</div></td></tr></table></div>',save_cancel:'<div class="save_cancel_controls"><span class="cancel">Cancel</span>&nbsp;&nbsp;'+'<input class="save" type="button" value="Save"></div>'},init_component:function()
{this.selected_tab="widget_info";this.pi=new SG.ProgressIndicator(this.container);if(this.source.get('configured')===false){var cfg={variation:this.source.get('variation')};if(this.root_widget_entity_type)
cfg.entity_type=this.root_widget_entity_type;var parent_entity=this.source.context.get('entity');if(parent_entity&&parent_entity.type){cfg.parent_entity_type=parent_entity.type;};var proj=this.source.context.get('page_project');if(proj)
cfg.project_id=proj.id;this.get_spec(cfg);}else{var source_spec;if(this.source.get('type')!='SG.Widget.Canvas.Wrapper')
source_spec=this.get_source_spec_for_detail_page_widget();else
source_spec=sg_deep_copy(this.source.widget_spec.to_hash());this.construct_page(source_spec);}
this.toggle_canvas_designer_controls(true);},destroy_component:function()
{this.toggle_canvas_designer_controls(false);if(this.widget_editor)
this.widget_editor.destroy();this.destroy_page();this.container.remove();},toggle_canvas_designer_controls:function(hide)
{if(!this.container)return;var parent_elem=Ext.get(this.container.dom.parentNode);var canvas_designer_elem=parent_elem.child('div.sgc_canvas_designer');var controls=canvas_designer_elem.child('div.controls');controls.setVisible(!hide);},get_spec:function(params)
{this.pi.show();params=params||{};var options={url:SG.globals.urls.canvas_widget_spec,params:params,callback:function(options,success,response){if(success){var source_spec=this.widget?sg_deep_copy(this.widget.widget_spec.to_hash()):sg_deep_copy(this.source.widget_spec.to_hash());source_spec.settings.configured=true;source_spec.children={child:JSON.parse(response.responseText)};this.construct_page(source_spec);this.pi.hide();this.toggle_canvas_designer_controls(true);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},construct_page:function(source_spec)
{this.destroy_page();var design_page=this.source.get_page();var settings={"type":"SG.Widget.Canvas.Page","settings":{"layouts":[{"name":"default","display_name":"Default"}],"hide_header":true},"children":{"title":{"type":"SG.Widget.PageTitle"},"default":{"type":"SG.Widget.Canvas.Body","settings":{"rows":["row_1"]},"children":{"row_1":{"type":"SG.Widget.Canvas.Row","settings":{"num_columns":1,"column_widths":[100],"column_widgets":[["edit"]]},"children":{"edit":source_spec}}}}}};this.page_dom=document.createElement("div");this.page_dom.id="sg_page_"+design_page.id;this.page_dom.className="sg_page";this.page_dom.style.display="none";document.body.appendChild(this.page_dom);var context=sg_deep_copy(design_page.context.settings);context.design_mode=false;context.edit_mode=true;var cfg={id:design_page.id,canvas_designer_page:true};this.preview_page=new SG.Page(cfg,context,settings);this.preview_page.block_sending_settings=true;this.widget=this.preview_page.root_widget.get_child("default").get_child("row_1").get_child("edit");if(this.widget_editor){var child_name=this.widget.get_child_names()[0];var widget=this.widget.get_child(child_name);this.widget_editor.widget=widget;}
if(this.container)
this.render_preview();else
this.render();},destroy_page:function()
{if(this.preview_page){this.preview_page.destroy_root_widget();Ext.fly(this.page_dom).remove();this.preview_page=null;}},render:function()
{var dh=Ext.DomHelper;this.container=dh.append(document.body,{tag:'div',cls:'sgc_canvas_widget_editor'},true);var html=this.templates.main.apply({left_pane:this.render_left_pane(),save_cancel_controls:this.templates.save_cancel.apply({})});this.container.update(html);this.render_right_pane();this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);var save_cancel_controls=this.container.child('div.save_cancel_controls');this.add_event(save_cancel_controls,'click',this.on_click_save_cancel_controls);},render_left_pane:function(){var widget_title=this.widget.get('title');var title=this.templates.text_input.apply({label:'Name:',value:widget_title,setting:'title'});var html=this.templates.left_pane.apply({title:title,wrapper_options:this.render_widget_wrapper_options()});return html;},render_widget_wrapper_options:function()
{var html=this.templates.section_title.apply({label:'Options:'});html+=this.templates.setting_checkbox.apply({label:'Collapsible',setting:'collapsable',checked:this.widget.get('collapsable')?'checked':''});html+=this.templates.setting_checkbox.apply({label:'Outline',setting:'show_border',checked:this.widget.get('show_border')?'checked':''});html+=this.templates.section_title.apply({label:'Colors:'});var text_color=this.widget.get('title_text_color');html+=this.templates.color_swatch.apply({setting:'title_text_color',color:text_color,style:'background-color:rgb('+text_color+');',label:'Title Text'});var bg_color=this.widget.get('title_bg_color');html+=this.templates.color_swatch.apply({setting:'title_bg_color',color:bg_color,style:'background-color:rgb('+bg_color+');',label:'Title Background'});return html;},render_right_pane:function(){var wiget_properties_div=this.container.child('div.widget_properties');var cfg={container:wiget_properties_div,wrapper:this.widget,variation:this.widget.get('variation'),parent:this};this.widget_editor=SG.Widget.Canvas.WidgetEditorFactory(cfg);this.render_preview();},render_preview:function()
{var preview_pane=this.container.child('div.preview_pane');preview_pane.update("");preview_pane.dom.appendChild(this.page_dom);this.page_dom.style.display="block";this.preview_page.destroy_root_widget();this.preview_page.construct_root_widget();this.widget=this.preview_page.root_widget.get_child("default").get_child("row_1").get_child("edit");},on_click:function(e)
{var t=Ext.get(e.getTarget());var color_swatch=t.findParent('div.color_swatch',this.container,true);if(color_swatch)
{var config={container:this.container,cell_element:color_swatch,initial_value:color_swatch.dom.getAttribute('color'),edit_callback:{fn:this.on_color_picked,scope:this}};var cp=new SG.ColorPicker(config);return;}},on_color_picked:function(color,cell_element)
{var setting=cell_element.dom.getAttribute('setting');cell_element.dom.setAttribute('style','background-color:rgb('+color+');');this.set_widget_setting(setting,color,true);},set_widget_setting:function(setting,value,for_wrapper)
{if(for_wrapper){this.widget.set(setting,value);}else{var child=this.widget.get_child('child');child.set(setting,value);this.set_filters_on_child(child);var spec=sg_deep_copy(this.widget.widget_spec.to_hash());this.construct_page(spec);}},set_filters_on_child:function(child){if(child.qb_component&&child.qb_component.set_filters){child.qb_component.set_filters();}},set_title_focus:function()
{var input=this.container.child('input[type="text"]');input.dom.select();input.dom.focus();},on_change:function(e)
{var t=e.getTarget();if(t.getAttribute("type")=="checkbox")
{var setting=t.getAttribute('setting');if(!setting)return;this.set_widget_setting(setting,t.checked,true);}
else if(t.getAttribute("type")=="text")
{var setting=t.getAttribute('setting');if(!setting)return;this.set_widget_setting(setting,t.value,true);}},on_click_save_cancel_controls:function(e)
{var t=Ext.get(e.getTarget());var cancel=t.findParent('.cancel',this.container);if(cancel){this.destroy();return;}
var save=t.findParent('.save',this.container);if(save){this.save();return;}},save:function()
{this.preview_page.root_widget.prepare_any_pending_settings();var child=this.widget.get_child('child');this.set_filters_on_child(child);var new_spec=sg_deep_copy(this.widget.widget_spec.to_hash());this.source.get_parent().replace_wrapper(this.source,new_spec);this.destroy();},get_source_spec_for_detail_page_widget:function()
{var spec=this.source.widget_spec.to_hash();var variation;switch(this.source.get('type')){case'SG.Widget.Thumbnail':variation='Thumbnail';title='Thumbnail';break;case'SG.Widget.NewFields':variation='NewFields';title='Fields';break;case'SG.Widget.TextFields':variation='TextFields';title='Text Fields';break
case'SG.Widget.PivotFields':variation='PivotFields';title='Pivot Fields';break
default:break;}
var source_spec={type:'SG.Widget.Canvas.Wrapper',settings:{collabsable:false,collapsed:false,configured:true,entity_type_varies:false,maximizable:false,title:title,variation:variation,variation_display_name:title},children:{child:spec}};return source_spec;},});SG.Widget.Canvas.WidgetEditorFactory=function(cfg){var k,child_name=cfg.wrapper.get_child_names()[0];cfg.widget=cfg.wrapper.get_child(child_name);switch(cfg.variation){case'NewFields':k=SG.Widget.Canvas.WidgetEditor.Fields;break;case'TextFields':k=SG.Widget.Canvas.WidgetEditor.Fields;break;case'PivotFields':k=SG.Widget.Canvas.WidgetEditor.Fields;break;case'Grid':k=SG.Widget.Canvas.WidgetEditor.Grid;break;case'Gantt':k=SG.Widget.Canvas.WidgetEditor.Grid;break;case'ThumbnailGrid':k=SG.Widget.Canvas.WidgetEditor.Grid;break;case'Graph':k=SG.Widget.Canvas.WidgetEditor.Graph;break;case'Assignments':k=SG.Widget.Canvas.WidgetEditor.Assignments;break;case'Countdown':k=SG.Widget.Canvas.WidgetEditor.Countdown;break;default:k=SG.Widget.Canvas.WidgetEditor.NotImplemented;break;}
return new k(cfg);};SG.Widget.Canvas.WidgetEditor=SG.Widget.Canvas.WidgetEditor||{};SG.Widget.Canvas.WidgetEditor.Base=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Base.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Base,SG.Component,{templates:{},});SG.Widget.Canvas.WidgetEditor=SG.Widget.Canvas.WidgetEditor||{};SG.Widget.Canvas.WidgetEditor.NotImplemented=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.NotImplemented.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.NotImplemented,SG.Widget.Canvas.WidgetEditor.Base,{init_component:function(){this.render();},render:function(){this.container.update("");}});SG.Widget.Canvas.WidgetEditor.Iframe=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Iframe.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Iframe,SG.Widget.Canvas.WidgetEditor.Base,{templates:{row:'<div class="row">'+'<table class="row"><tr><td class="label">{label}</td><td class="control">{control}</td></tr></table>'+'</div>',body:'{url}{show_toolbar}',url:'<input type="text" setting="url" value="{url}">',show_toolbar:'<input type="checkbox" setting="show_toolbar" {checked}>'},init_component:function(){this.container.addClass('sgc_widget_editor_iframe');this.add_event(this.container,'change',this.on_change);this.render();},render:function(){var cfg={url:this.render_url(),show_toolbar:this.render_show_toolbar(),};this.container.update(this.templates.body.apply(cfg));},render_url:function(){var cfg={label:'URL:',control:this.templates.url.apply({url:this.widget.get('url')})};return this.templates.row.apply(cfg);},render_show_toolbar:function(){var checked=this.widget.get('show_toolbar')?'checked':'';var cfg={label:'Show Toolbar:',control:this.templates.show_toolbar.apply({checked:checked})};return this.templates.row.apply(cfg);},on_change:function(e){var t=e.getTarget();var setting=t.getAttribute("setting");switch(setting){case"show_toolbar":this.widget.set('show_toolbar',t.checked);break;case"url":this.widget.set('url',t.value);break;}}});SG.Widget.Canvas.WidgetEditor=SG.Widget.Canvas.WidgetEditor||{};SG.Widget.Canvas.WidgetEditor.Fields=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Fields.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Fields,SG.Widget.Canvas.WidgetEditor.Base,{templates:{body:'{field_properties}{display_type}',row:'<div class="row">'+'<table class="row"><tr><td class="label">{label}</td><td class="control">{control}</td></tr></table>'+'</div>',field_properties_control:'<div class="fields_label">Fields:</div>'+'<div class="field_properties_control"></div>',display_control:'<div class="fields_label">Display:</div>'+'<form><div class="display_toggle"><input class="display" type="radio" name="display_type" '+'value="side_by_side" {side_by_side_checked} />&nbsp;Side by Side</div>'+'<div class="example side_by_side"><span class="label">Label:</span>Value<br>'+'<span class="label">Label:</span>Value<br></div>'+'<div class="display_toggle"><input class="display" type="radio" name="display_type" value="stacked" '+'{stacked_checked} />&nbsp;Stacked</div>'+'<div class="example stacked"><span class="label">Label:</span><br>Value<br>'+'<span class="label">Label:</span><br>Value<br></div>'+'<div class="display_toggle"><input class="display" type="radio" name="display_type" value="One Line" '+'{one_line_checked} />&nbsp;One Line</div>'+'<div class="example one_line"><span class="label">Label:</span>Value'+'<span class="label">Label:</span>Value</div>',},init_component:function()
{this.get_field_properties();this.container.addClass('sgc_widget_editor_fields');this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);this.entity_type=this.widget.get('entity_type');this.render();},on_click:function(e)
{var t=Ext.get(e.getTarget());var entity_menu_div=t.findParent('div.entity_menu',this.container,true);if(entity_menu_div)
{this.show_entity_menu(entity_menu_div);return;}},on_change:function(e)
{var t=Ext.get(e.getTarget());var display_input=t.findParent('input.display',this.container);if(display_input)
{var display_inputs=sg_find_all('input.display',this.container.dom);for(var i=0;i<display_inputs.length;i++)
{var input=Ext.get(display_inputs[i]);if(input.dom.checked)
{if(input.dom.value=='side_by_side')
this.parent.set_widget_setting('mode','default');else if(input.dom.value=='stacked')
this.parent.set_widget_setting('mode','pivot');else
this.parent.set_widget_setting('mode','one_line');}}}},render:function()
{var html=this.templates.body.apply({field_properties:this.templates.field_properties_control.apply(),display_type:this.render_display_type(),});this.container.update(html);this.construct_and_render_field_properties();},construct_and_render_field_properties:function()
{if(this.field_properties_component)
this.field_properties_component.destroy();var field_properties=this.get_field_properties();var config={container:this.container.child('div.field_properties_control'),entity_type:this.entity_type?this.entity_type:this.widget.context.get('entity').type,field_properties_schema:this.widget.field_properties_schema,field_settings:field_properties,join_fields:this.widget.get_through_join_fields(),pivot_columns:'summary',properties_changed_callback:{fn:this.field_properties_changed,scope:this},display_property_callback:{fn:this.display_property_for_field,scope:this},field_disabled_callback:{fn:this.field_disabled_callback,scope:this}};this.field_properties_component=new SG.MiniFieldProperties(config);if(field_properties.length==0)
this.field_properties_component.display_manage_columns_dialog();},render_display_type:function()
{var mode=this.widget.get('mode');var side_by_side_checked='';var stacked_checked='';var one_line_checked='';if(mode=='default')
side_by_side_checked='checked="true"';else if(mode=='pivot')
stacked_checked='checked="true"';else
one_line_checked='checked="true"';return this.templates.display_control.apply({side_by_side_checked:side_by_side_checked,stacked_checked:stacked_checked,one_line_checked:one_line_checked});},get_field_property_name:function(){var field_property_name='field_properties';var widget_type=this.widget.get('type');if(widget_type=='SG.Widget.TextFields'||widget_type=='SG.Widget.PivotFields')
field_property_name='columns';return field_property_name;},get_field_properties:function(){var field_property_name=this.get_field_property_name();return this.widget.get(field_property_name);},set_field_properties:function(new_properties){var field_property_name=this.get_field_property_name();this.parent.set_widget_setting(field_property_name,new_properties);},field_properties_changed:function(new_properties)
{this.set_field_properties(new_properties);},display_property_for_field:function(schema_field,field_property)
{var widget_mode=this.widget.get('mode');if(widget_mode!='one_line'&&field_property.property_name=='position')
return false;return true;},field_disabled_callback:function(schema_field){if(this.widget.get('type')=='SG.Widget.TextFields')
return schema_field.data_type!='text';else
return false;}});SG.Widget.Canvas.WidgetEditor.Grid=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Grid.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Grid,SG.Widget.Canvas.WidgetEditor.Base,{templates:{Grid:'{show_toolbar}',ThumbnailGrid:'{show_toolbar}',Gantt:'{show_toolbar}',row:'<div class="row">'+'<table class="row"><tr><td class="label">{label}</td><td class="control">{control}</td></tr></table>'+'</div>',show_toolbar:'<input type="checkbox" setting="show_toolbar" {checked}>',},init_component:function(){this.container.addClass('sgc_widget_editor_grid');this.add_event(this.container,'change',this.on_change);this.render();},destroy_component:function(){if(this.qb_component)
this.qb_component.destroy();},render:function(){var cfg={show_toolbar:this.render_show_toolbar(),};this.container.update(this.templates[this.variation].apply(cfg));},render_show_toolbar:function()
{var checked=this.widget.get('show_toolbar')?'checked':'';return this.templates.row.apply({label:'Show Toolbar:',control:this.templates.show_toolbar.apply({checked:checked})});},on_change:function(e){var t=e.getTarget();if(t.getAttribute("setting")=="show_toolbar")
this.widget.set("show_toolbar",t.checked);},});SG.Widget.Canvas.WidgetEditor.Graph=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Graph.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Graph,SG.Widget.Canvas.WidgetEditor.Base,{templates:{body:'{grouping}{summary}{group_count_limit}{show_total}{color}',row:'<div class="row">'+'<table class="row"><tr><td class="label {label_extra_class}">{label}</td>'+'<td class="control">{control}</td></tr></table></div>',option:'<div class="fields_label">{label}</div>'+'<div class="fields_property_control">{control}</div>',filters:'<div class="filters"></div>',grouping:'<table class="grouping_table"><tr><td class="graph_by_label">'+'<div class="graph_by_label">Graph:</div></td><td>'+'<div class="group_field_menu widget_editor_dropdown" group_index="0">'+'<span class="group_field_display_name">{group_field_display_name}</span>'+'<div class="dropdown_arrow_small"></div></div></td></tr>'+'<tr><td class="graph_by_label"><div class="graph_by_label">by:</div></td><td>'+'<div class="group_method_menu widget_editor_dropdown" group_index="0">'+'<span class="group_field_display_name">{group_method_display_name}</span>'+'<div class="dropdown_arrow_small"></div></div>'+'</td></tr></table>',old_grouping:'<table class="grouping_table"><tr><td>'+'<div class="group_field_menu widget_editor_dropdown" group_index="0">'+'<span class="group_field_display_name">{group_field_display_name}</span>'+'<div class="dropdown_arrow_small"></div><div>'+'</td><td>'+'<div class="group_field_menu widget_editor_dropdown" group_index="1">'+'<span class="group_field_display_name">{group_field_display_name_2}</span>'+'<div class="dropdown_arrow_small"></div><div>'+'</td></tr></table>',summary:'<form><div class="count_summary">'+'<input class="multi_choice" type="radio" name="choice" id="summary_is_count" value="count" '+'{count_checked} /><label for="summary_is_count">Count</label></div>'+'<div class="summarize_summary">'+'<input class="multi_choice" type="radio" name="choice" id="summary_is_other" value="summarize"'+' {summarize_checked} />'+'<label for="summary_is_other">Summarize field:</label></div>'+'<div class="summary_field_menu widget_editor_dropdown">'+'<span class="summary_field_display_name">{summary_field_display_name}</span>'+'<div class="dropdown_arrow_small"></div></div>'+'<div class="summarize_heading">Calculation:</div>'+'<div class="summary_operator_menu widget_editor_dropdown">'+'<span class="summary_operator">{summary_operator}</span>'+'<div class="dropdown_arrow_small"></div></div>',color:'<div class="color" setting="{setting}" style="background-color: rgb({color});">&nbsp;</div>',show_total:'<input type="checkbox" setting="show_total" {checked}>',group_count_limit:'<input type="text" setting="group_count_limit" value="{group_count_limit}">',group_count_message:'<div class="group_count_limit_prompt">'+'Limits number of graph bars to be displayed. Use blank for no limit.</div>',},init_component:function(){this.container.addClass('sgc_widget_editor_graph');this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.on_change);this.group_field_menus=[];this.render();},render:function(){var cfg={grouping:this.render_grouping(),summary:this.render_summary(),color:this.render_color('bar_color'),show_total:this.render_show_total(),group_count_limit:this.render_group_count_limit()};this.container.update(this.templates.body.apply(cfg));},render_grouping:function()
{var grouping=this.widget.get('grouping');var group_field=SG.schema.get_field(this.widget.get('entity_type'),grouping[0].column);var group_field=group_field.display_name;var options=SG.schema.get_grouping_options(this.widget.get('entity_type'),grouping[0].column);var group_method_display_name=null;for(var i=0;i<options.length;i++)
{if(grouping[0].method==options[i].name)
group_method_display_name=options[i].display_name;}
return this.templates.grouping.apply({group_field_display_name:group_field,group_method_display_name:group_method_display_name});},old_render_grouping:function()
{var grouping=this.widget.get('grouping');var group_field=SG.schema.get_field(this.widget.get('entity_type'),grouping[0].column);var group_field=group_field.display_name;group_field_2='&nbsp;';if(grouping[1])
{var group_field_2=SG.schema.get_field(this.widget.get('entity_type'),grouping[1].column);group_field_2=group_field_2.display_name;}
var menu=this.templates.grouping.apply({group_field_display_name:group_field,group_field_display_name_2:group_field_2});return this.templates.row.apply({label:'Graph by:',control:menu});},render_summary:function()
{var displayed_summary=this.widget.get('summary');var record_count=(displayed_summary.type=='record_count');if(record_count)
displayed_summary=SG.util.SummaryMenuHelper.find_first_non_record_count_summary(this.widget.get('entity_type'),true);var summary_field=SG.schema.get_field(this.widget.get('entity_type'),displayed_summary.column);var summary_operator=SG.schema.summary_display_names[displayed_summary.type];if(displayed_summary.type.indexOf('percent')>-1)
{var value=displayed_summary.value;if(displayed_summary.type=='status_percentage')
{var status=SG.schema.status_list[value];if(status)
value=status.name;}
summary_operator+=" ("+value+")";}
var menu=this.templates.summary.apply({summary_field_display_name:summary_field.display_name,summary_operator:summary_operator,count_checked:record_count?'checked':'',summarize_checked:record_count?'':'checked'});return this.templates.option.apply({label:'Display:',control:menu});},render_color:function(setting)
{return this.templates.row.apply({label:setting=='bar_color'?'Bar Color:':'Background Color:',label_extra_class:setting=='bar_color'?'wide':'',control:this.templates.color.apply({setting:setting,color:this.widget.get(setting)}),});},render_show_total:function()
{var checked=this.widget.get('show_total')?'checked':'';return this.templates.row.apply({label:'Show Total:',label_extra_class:'wide',control:this.templates.show_total.apply({checked:checked})});},render_group_count_limit:function(){var cfg={label:'Maximum Rows:',label_extra_class:'wide',control:this.templates.group_count_limit.apply({group_count_limit:this.widget.get('group_count_limit')})};return this.templates.row.apply(cfg)+this.templates.group_count_message.apply();},on_click:function(e){var t=Ext.get(e.getTarget());var menu_div=t.findParent('div.widget_editor_dropdown',this.container,true);if(menu_div)
{if(menu_div.hasClass('entity_menu')){this.show_entity_menu(menu_div);return;}
else if(menu_div.hasClass('group_field_menu')){this.show_group_field_menu(menu_div,Number(menu_div.dom.getAttribute('group_index')));return;}
else if(menu_div.hasClass('group_method_menu')){this.show_group_method_menu(menu_div,Number(menu_div.dom.getAttribute('group_index')));return;}
else if(menu_div.hasClass('summary_field_menu')){this.show_summary_field_menu(menu_div);return;}
else if(menu_div.hasClass('summary_operator_menu')){this.show_summary_operator_menu(menu_div);return;}}
var color=t.findParent('div.color',this.container,true);if(color)
{this.show_color_picker(t);}},on_change:function(e){var t=e.getTarget();if(t.value=='count')
{var me=this;setTimeout(function(){me.set_to_default_record_count_summary();},0);}
else if(t.value=='summarize')
{var me=this;setTimeout(function(){me.set_to_default_non_record_count_summary();},0);}
else if(t.getAttribute("setting")=="show_total")
{this.parent.set_widget_setting("show_total",t.checked);}
else if(t.getAttribute("setting")=="group_count_limit")
{this.parent.set_widget_setting("group_count_limit",t.value);}},show_group_field_menu:function(group_field_menu_div,group_index)
{var cur_entity_type=this.widget.get('entity_type');var cur_group=this.widget.get('grouping')[0];var menu=this.group_field_menus[group_index];if(!menu)
{menu=new SG.Menu({item_selected:{fn:this.on_group_field_menu,scope:this}});menu.group_index=group_index;this.group_field_menus[group_index]=menu;}
var config={entity_type:cur_entity_type,field_disabled_callback:{fn:function(schema_field){return schema_field.no_grouping;},scope:this},field_checked_callback:{fn:function(){return false;},scope:this},on_field:{fn:this.on_group_field_menu,scope:this},no_steps:true};var fields_menu_helper=new SG.util.FieldsMenuHelper(config);menu.items=fields_menu_helper.get_menu_items();if(group_index==1)
menu.items.splice(0,0,{html:'(none)',field:null});menu.position={dom_elem:group_field_menu_div,elem_anchor:'bl',menu_anchor:'tl'};menu.render();menu.show();},on_group_field_menu:function(menu,menu_item)
{var group_index=menu.root_menu.group_index;var grouping=sg_deep_copy(this.widget.get('grouping'));if(menu_item.field==null)
grouping.splice(group_index,1);else
grouping[group_index]={column:menu_item.field,direction:"asc",method:"exact"};this.parent.set_widget_setting("grouping",grouping);this.render();},show_group_method_menu:function(group_method_menu_div,group_index)
{if(!this.group_method_menu)
{this.group_method_menu=new SG.Menu({item_selected:{fn:this.on_group_method_menu,scope:this}});this.group_method_menu.group_index=group_index;}
var field=this.widget.get('grouping')[0].column;var method=this.widget.get('grouping')[0].method;var options=SG.schema.get_grouping_options(this.widget.get('entity_type'),field);var opt,i;var items=[];for(i=0;i<options.length;i++){opt=options[i];items.push({html:opt.display_name,checked:method==opt.name,value:{column:field,method:opt.name,direction:'asc'}});}
this.group_method_menu.items=items;this.group_method_menu.position={dom_elem:group_method_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.group_method_menu.render();this.group_method_menu.show();},on_group_method_menu:function(menu,menu_item)
{var grouping=sg_deep_copy(this.widget.get('grouping'));grouping[menu.group_index]=menu_item.value;this.parent.set_widget_setting("grouping",grouping);this.render();},show_summary_field_menu:function(summary_field_menu_div)
{var cur_entity_type=this.widget.get('entity_type');var cur_summary=this.widget.get('summary');if(!this.summary_field_menu)
{this.summary_field_menu=new SG.Menu({item_selected:{fn:this.on_summary_field_menu,scope:this}});}
var fields=SG.schema.get_categorized_fields(cur_entity_type,false,true).ordinary;this.summary_field_menu.items=[];for(var i=0;i<fields.length;i++)
this.summary_field_menu.items.push({html:fields[i].display_name,schema_field:fields[i],checked:(fields[i].name==cur_summary.column),disabled:!SG.util.SummaryMenuHelper.schema_field_has_other_summary_options(fields[i],true)});this.summary_field_menu.position={dom_elem:summary_field_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.summary_field_menu.render();this.summary_field_menu.show();},on_summary_field_menu:function(menu,menu_item)
{var summary_operator=SG.util.SummaryMenuHelper.first_good_summary_operator(menu_item.schema_field,true);var summary_value=SG.util.SummaryMenuHelper.first_list_value(menu_item.schema_field);this.parent.set_widget_setting('summary',{column:menu_item.schema_field.name,type:summary_operator,value:summary_value});this.render();},show_summary_operator_menu:function(summary_operator_menu_div)
{if(!this.summary_operator_menu)
{this.summary_operator_menu=new SG.Menu({item_selected:{fn:this.on_summary_operator_menu,scope:this}});}
this.summary_operator_menu.items=SG.util.SummaryMenuHelper.get_summary_calculation_menu_items(this.widget.get('entity_type'),this.widget.get('summary'),true);this.summary_operator_menu.position={dom_elem:summary_operator_menu_div,elem_anchor:'bl',menu_anchor:'tl'};this.summary_operator_menu.render();this.summary_operator_menu.show();},on_summary_operator_menu:function(menu,menu_item)
{this.parent.set_widget_setting('summary',menu_item.value);this.render();},set_to_default_record_count_summary:function()
{var ident_field=SG.schema.get_identifier_field(this.widget.get('entity_type'));this.parent.set_widget_setting('summary',{column:ident_field,type:'record_count',value:null});this.render();},set_to_default_non_record_count_summary:function()
{this.parent.set_widget_setting('summary',SG.util.SummaryMenuHelper.find_first_non_record_count_summary(this.widget.get('entity_type')));this.render();},show_color_picker:function(el)
{var parent_container=this.parent.container;this.active_picker=new SG.ColorPicker({container:parent_container,cell_element:el,edit_callback:{fn:this.on_color_picked,scope:this}});},on_color_picked:function(color)
{var el=this.active_picker.cell_element;var setting=el.dom.getAttribute('setting');this.parent.set_widget_setting(setting,color);el.dom.style.cssText="background-color: rgb("+color+")";this.active_picker.destroy();},});SG.Widget.Canvas.WidgetEditor.Assignments=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Assignments.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Assignments,SG.Widget.Canvas.WidgetEditor.Base,{templates:{body:'{results}{field_properties}{notes_statuses}',option:'<div class="fields_label">{label}</div>'+'<div class="fields_property_control">{control}</div>',results:'<select setting="records_per_page">'+'<option value="1" {selected1}>1</option>'+'<option value="5" {selected5}>5</option>'+'<option value="10" {selected10}>10</option>'+'<option value="15" {selected15}>15</option>'+'</select>',filters:'<div class="filters"></div>',field_properties:'<div class="field_properties"></div>',message:'<div class="message">In addition to the filters below, this Assignment widget filters for Tasks '+'where the Link and Pipeline step has been assigned.</div>',},init_component:function(){this.container.addClass('sgc_widget_editor_assignments');this.add_event(this.container,'change',this.on_change);this.render();},render:function(){var cfg={results:this.render_results(),field_properties:this.render_field_properties(),notes_statuses:this.render_notes_statuses()};this.container.update(this.templates.body.apply(cfg));this.construct_field_properties();},render_results:function()
{var cur=this.widget.get('records_per_page');var cfg={selected1:cur==1?"selected":"",selected5:cur==5?"selected":"",selected10:cur==10?"selected":"",selected15:cur==15?"selected":""};return this.templates.option.apply({label:'Results Per Page:',control:this.templates.results.apply(cfg)});},render_field_properties:function()
{return this.templates.option.apply({label:'Task List Fields:',control:this.templates.field_properties.apply()});},render_notes_statuses:function()
{var widget=this.get_assignment_widget();var h="<div class='hide_notes'>";var hide=widget.get("hide_notes_with_statuses");var statuses=SG.schema.get_field("Note","sg_status_list").status_list_subset;var s,c;for(var i=0;i<statuses.length;i++){s=statuses[i];c="";if(hide.indexOf(s)===-1)
c="checked";h+='<table><tr><td width="10"><input type="checkbox" value="'+s+'" '+c+'></td>';h+='<td width="20"><center>'+SG.Renderers.render_one_status_icon(s)+'</center></td>';h+='<td>'+s+'</td></tr></table>';}
return this.templates.option.apply({label:'Show Notes With Statuses:',control:h+"</div>"});},get_assignment_widget:function()
{var w=this.widget.get_child("prototype");if(!w)
{var context=this.widget.context.clone();context.set('entity',null);w=this.widget.construct_child('prototype',context);}
else if(Ext.type(w)=="array")
return w[0];else
return w;return w;},construct_field_properties:function()
{var widget=this.get_assignment_widget();var cfg={container:this.container.child('div.field_properties'),entity_type:'Task',field_properties_schema:widget.field_properties_schema,field_settings:widget.get('field_properties'),join_fields:widget.get_through_join_fields(),pivot_columns:'summary',properties_changed_callback:{fn:this.field_properties_changed,scope:this},field_disabled_callback:{fn:this.field_supported,scope:this}};this.field_properties_component=new SG.MiniFieldProperties(cfg);},field_supported:function(schema_field)
{if(schema_field.data_type=='summary'&&schema_field.entity_type!='Task')
return true;else
return false;},field_properties_changed:function(new_properties)
{var widget=this.get_assignment_widget();widget.set('field_properties',new_properties);var spec=sg_deep_copy(this.parent.widget.widget_spec.to_hash());this.parent.construct_page(spec);},on_change:function(e)
{var t=e.getTarget();if(t.getAttribute("setting")=="records_per_page")
this.parent.set_widget_setting("records_per_page",Number(t.value));var p=Ext.get(t).findParent("div.hide_notes")
if(p){var checks=sg_find_all('input',p);var new_val=[];for(var i=0;i<checks.length;i++){if(!checks[i].checked)
new_val.push(checks[i].value)}
this.parent.set_widget_setting('hide_notes_with_statuses',new_val);}}});SG.Widget.Canvas.WidgetEditor.Countdown=function(config)
{Ext.apply(this,config);SG.Widget.Canvas.WidgetEditor.Countdown.superclass.constructor.call(this);};Ext.extend(SG.Widget.Canvas.WidgetEditor.Countdown,SG.Widget.Canvas.WidgetEditor.Base,{templates:{row:'<div class="row">'+'<table class="row"><tr><td class="label">{label}</td><td class="control">{control}</td></tr></table>'+'</div>',body:'{event_name}{event_date}',event_name:'<input type="text" setting="event_name" value="{event_name}">',event_date:'<div class="row">'+'<table class="row"><tr><td class="label">{label}</td>'+'<td class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'<div class="sg_cell_content">{cell_content}</div></td></tr></table>'+'</div>',},init_component:function(){this.container.addClass('sgc_widget_editor_countdown');this.add_event(this.container,'change',this.on_change);this.data_set=this.new_data_set('Task',this.on_data_set_load,this.on_data_set_change);var record=this.data_set.new_record();record.set('start_date',this.widget.get('event_date'));var cell_config={container:this.container,edit_container:this.container.findParent('div.sgc_widget_editor',10,true),data_set:this.data_set,projects:this.widget.context_projects(),in_form:true,};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.render();},on_data_set_load:function(){},on_data_set_change:function(){var record=this.data_set.get_record(0);this.parent.set_widget_setting('event_date',record.get('start_date'));},render:function(){var cfg={event_name:this.render_event_name(),event_date:this.render_event_date(),};this.container.update(this.templates.body.apply(cfg));},render_event_name:function(){var cfg={label:'Event:',control:this.templates.event_name.apply({event_name:this.widget.get('event_name')})};return this.templates.row.apply(cfg);},render_event_date:function()
{var record=this.data_set.get_record(0);var cell=this.cell_manager.get_cell('start_date',{type:SG.FakeInputCell});var config=cell.render(record);config.label='Event Date:';return this.templates.event_date.apply(config);},on_change:function(e){var t=e.getTarget();var setting=t.getAttribute("setting");switch(setting){case"event_name":this.parent.set_widget_setting('event_name',t.value);break;}}});SG.util.WorkingDays=function(config){Ext.apply(this,config);this.init();};SG.util.WorkingDays.prototype={init:function()
{this.new_data_set();this.with_entities=this.entity_type&&this.entity_ids&&this.entity_ids.length>0;this.date_parser=SG.GridEditor.DateParser;},new_data_set:function()
{this.data_set=new SG.Data.Set('WorkDayRule');this.data_set.on('load',this.on_data_set_loaded,this);this.data_set.on('change',this.on_data_set_change,this);},destroy:function()
{if(this.data_set)
this.data_set.destroy();},is_dirty:function()
{return(this.data_set.count_status('clean','compliment')>0);},save:function(update_field,callback)
{this.update_callback=callback;this.data_set.field_to_recalculate_on_task_schedule_changes=update_field;this.data_set.commit(true);},on_data_set_change:function(changes)
{if(this.update_callback)
{var callback=this.update_callback;this.update_callback=false;callback.fn.call(callback.scope);}},fetch:function()
{this.data_set.destroy();this.new_data_set();var filters={logical_operator:'and',conditions:[]};if(this.with_entities)
{var path=this.entity_type=='Project'?'project':'user';var entity_conditions=[];entity_conditions.push({path:path,relation:'is',values:[null]});for(var i=0;i<this.entity_ids.length;i++)
entity_conditions.push({path:path,relation:'is',values:[{type:this.entity_type,id:this.entity_ids[i]}]});filters.conditions.push({logical_operator:'or',conditions:entity_conditions});var other_path=this.entity_type=='Project'?'user':'project';filters.conditions.push({path:other_path,relation:'is',values:[null]});}
else
{filters.conditions.push({path:'project',relation:'is',values:[null]});filters.conditions.push({path:'user',relation:'is',values:[null]});}
filters.conditions.push({logical_operator:'and',conditions:[{logical_operator:'or',conditions:[{path:'start_date',relation:'is',values:[null]},{path:'start_date',relation:'less_than_or_equal',values:[this.string_date(this.end_date)]}]},{logical_operator:'or',conditions:[{path:'end_date',relation:'is',values:[null]},{path:'end_date',relation:'greater_than_or_equal',values:[this.string_date(this.start_date)]}]}]});var sorts=[{column:'precedence',direction:'desc'},{column:'user',direction:'desc'},{column:'project',direction:'desc'},{column:'start_date',direction:'desc'},{column:'end_date',direction:'asc'},]
var spec={type:'WorkDayRule',filters:filters,sorts:sorts,columns:['day_of_week','working','precedence','start_date','end_date','project','user','description'],result:this.data_set};SG.Repo.query(spec);},on_data_set_loaded:function()
{if(this.changes)
{for(var i=0;i<this.changes.length;i++)
this.set_state_for_entities(this.changes[i][0],this.changes[i][1],this.changes[i][2],true);}
if(this.on_data_loaded)
this.on_data_loaded.fn.call(this.on_data_loaded.scope);},reset_and_reload:function()
{this.changes=null;this.fetch();},string_date:function(date)
{return this.date_parser.data_store_format(date);},working_day:function(date,exceptions)
{if(!exceptions)
exceptions=false;var entity_field_name=this.entity_type=='Project'?'project':'user';var str_date=this.string_date(date);var day_of_week=this.date_parser.get_day(date);if(str_date<this.string_date(this.start_date)||str_date>this.string_date(this.end_date))
throw"WorkingDays.working_day() was called with a date that is out of range: "+str_date;var site_working=null;var entity_values=[];for(var i=this.data_set.count()-1;i>=0;i--)
{var rule=this.data_set.get_record(i);if(rule.get_state()=='retired')
continue;if(day_of_week!=rule.get('day_of_week'))
continue;var start=rule.get('start_date');if(start&&start>str_date)
continue;var end=rule.get('end_date');if(end&&end<str_date)
continue;if(!exceptions&&rule.get('precedence')>0)
continue;if(!rule.get('user')&&!rule.get('project'))
{site_working=rule.get('working')?'on':'off';entity_values=[];}
else
{var entity_id_index=this.entity_ids.indexOf(rule.get(entity_field_name).id);var entity_working=rule.get('working')?'on':'off';entity_values[entity_id_index]=entity_working;}}
if(entity_values.length==0)
return site_working;var on=0;var off=0;for(var i=0;i<this.entity_ids.length;i++)
{var value=entity_values[i]||site_working;if(value=='on')
on++;else if(value=='off')
off++;}
if(on>0&&off>0)
return'mixed';else if(on>0)
return'on';else if(off>0)
return'off';else
return site_working;},find_applicable_work_day_rules:function(date,exceptions)
{if(!exceptions)
exceptions=false;var str_date=this.string_date(date);var day_of_week=date.getUTCDay();if(str_date<this.string_date(this.start_date)||str_date>this.string_date(this.end_date))
throw"WorkingDays.working_day() was called with a date that is out of range: "+str_date;var entity_rules=[];for(var i=this.data_set.count()-1;i>=0;i--)
{var rule=this.data_set.get_record(i);if(rule.get_state()=='retired')
continue;if(day_of_week!=rule.get('day_of_week'))
continue;var start=rule.get('start_date');if(!start||start>str_date)
continue;var end=rule.get('end_date');if(end&&end<str_date)
continue;if(this.with_entities&&!rule.get('user')&&!rule.get('project'))
continue;if(exceptions!=(rule.get('precedence')!=0))
continue;entity_rules.push(rule);}
return entity_rules;},set_state_for_entities:function(date,state,exception,__reapply)
{if(!exception)
exception=false;var str_date=this.string_date(date);var rules_at_same_level=this.find_applicable_work_day_rules(date,exception);if(!__reapply)
{if(!this.changes)
this.changes=[]
this.changes.push([date,state,exception]);}
for(var i=0;i<rules_at_same_level.length;i++)
{if(rules_at_same_level[i].get('start_date')==str_date)
rules_at_same_level[i].retire();}
var insert_at=this.get_new_rule_insert_index(date,exception);var ret=[];if(this.with_entities)
{for(var i=0;i<this.entity_ids.length;i++)
{var rec=this.data_set.insert_new_record(insert_at);rec.set('start_date',str_date);if(exception)
{rec.set('end_date',str_date);rec.set('precedence',1);}
else
rec.set('precedence',0);rec.set('day_of_week',this.date_parser.get_day(date));rec.set('working',state=='on'?true:false);if(this.entity_type=='Project')
rec.set('project',{type:'Project',id:this.entity_ids[i]});else if(this.entity_type=='HumanUser')
rec.set('user',{type:'HumanUser',id:this.entity_ids[i]});ret.push(rec);}}
else
{var rec=this.data_set.insert_new_record(insert_at);rec.set('start_date',str_date);if(exception)
{rec.set('end_date',str_date);rec.set('precedence',1);}
else
rec.set('precedence',0);rec.set('day_of_week',this.date_parser.get_day(date));rec.set('working',state=='on'?true:false);ret.push(rec);}
return ret;},clear_exceptions:function(date)
{var rules=this.find_applicable_work_day_rules(date,true);for(var i=0;i<rules.length;i++)
{var rule=rules[i];if(rule.get('precedence')==1)
rule.retire();}},get_new_rule_insert_index:function(date,exception)
{var precedence=exception?1:0;var entity_field_name=this.entity_type=='Project'?'project':'user';var str_date=this.string_date(date);var insert_at=this.data_set.count();for(var i=this.data_set.count()-1;i>=0;i--)
{var rule=this.data_set.get_record(i);if(rule.get('precedence')<precedence)
{insert_at=i;}
else if(this.with_entities&&rule.get('precedence')==precedence&&!rule.get(entity_field_name))
{insert_at=i;}
else if(rule.get('precedence')==precedence&&(!rule.get('start_date')||rule.get('start_date')<=str_date))
{insert_at=i;}
else
{insert_at=i+1;break;}}
return insert_at;},dump_rules:function()
{console.log(Ext.encode(this.entity_ids));for(var i=0;i<this.data_set.count();i++)
{var rec=this.data_set.get_record(i);console.log(i+": "+rec.get_state()+" => "+Ext.encode(rec.row?rec.row.data:rec.local_data));}}}
SG.Widget.WorkWeekEditor=function(context,widget_spec,id)
{SG.Widget.WorkWeekEditor.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.WorkWeekEditor,SG.Widget.Base,{default_settings:{mode:'work_week',},templates:{main:'{tabs}<div class="tab_contents">{contents}</div>',tabs:'<div class="header"><table class="tabs"><tr>'+'<td class="work_week {work_week_selected}"><div class="tab_label">Normal Work Week</div></td>'+'<td class="exceptions {exceptions_selected}"><div class="tab_label">{exceptions_tab_text}</div></td>'+'<td class="filler"><div class="tab_filler">&nbsp</div></td>'+'</tr></table></div>',work_week_normal:'<div class="work_week"><div class="work_week_title">{title}</div>'+'<table class="work_week"><tr>{days}</tr></table>'+'<div class="default_schedule_changes_note">'+'Changes to this schedule will only apply to dates <b>after</b> today, because if older '+'tasks moved around they would no longer match what really happened.  Previous weeks '+'will still use the default schedule in effect at that time.</div>'+'</div><div class="work_week_history"></div>',work_week_exceptions:'<div class="work_week">'+'<table style="table-layout: fixed;"><tr><td class="work_week_editor_table">'+'<table class="work_week"><tr>{days}</tr></table></td><td>'+'<div class="clear_exceptions">'+'<span class="clear_exceptions" start_of_week="{start_of_week}">{clear_label}</span>'+'</div></td></tr></table></div>',work_day_normal:'<td class="work_day {state}" date="{date}" state="{state}">'+'<div class="check_icon {check_icon_class}"></div>'+'<div class="day_label">{day}</div></td>',work_day_exception:'<td class="work_day {state}" date="{date}" state="{state}">'+'<div class="day_label">{day}<div class="{exception}">*</div>'+'</div><div class="date">{month_day}</div></td>',exception_tab:'<div class="exceptions"><table><tr><td class="calendar">'+'<div class="calendar">{calendar}'+'<div class="selected_week_overlay display_none"></div></div></td>'+'<td class="selected_work_week"><div class="week_exceptions">{exceptions_work_week}</div>'+'<div class="comments"></div></td><td></td></tr></table></div>',calendar_header:'<table class="header"><tr>'+'<td class="go_prev_month"><div class="left_arrow"></div></td>'+'<td class="go_next_month"><div class="right_arrow"></div></td>'+'<td class="go_today" colspan="2"><span class="go_today">Today</span></td>'+'<td class="month_year" colspan="3">{month_year}<img src="/images/dropdown_doubleArrow.png">'+'</td></tr></table>',calendar_day:'<td class="day {off_month} {state} {weekend} {today}"><div class="day">{day_number}</div></td>',calendar_day_exception:'<td class="day {off_month} {state} {weekend} {today}"><div class="day">{day_number}'+'<div class="exception">*</div></div></td>',calendar_week:'<div class="week {selected}" start="{start_of_week}" end="{end_of_week}">'+'<table><tr>{days}</tr></table></div>',calendar_week_header:'<table><tr><td class="day header"><div>S</div></td><td class="day header"><div>M</div></td>'+'<td class="day header"><div>T</div></td><td class="day header"><div>W</div></td>'+'<td class="day header"><div>T</div></td><td class="day header"><div>F</div></td>'+'<td class="day header"><div>S</div></td></tr></table>',exception_comment:'<div class="comment_body">'+'<div class="radio_buttons">{button_controls}</div>'+'<div class="description_label">Description:</div>'+'<textarea rows="2" cols="40">{description}</textarea>'+'<div class="create_exception_div">'+'<input type="button" value="Create Exceptions" class="create_exceptions" {create_disabled}>'+'<span class="cancel_create_exceptions fake_link">Cancel</span>'+'<span class="clear_exceptions selected" start_of_week="{start_of_week}">{clear_label}</span>'+'</div></div>',working_radio_buttons:'<form><input type="radio" name="work_state" value="working" {working_checked} '+'id="work_state_working"/>'+'<label for="work_state_working"><span class="radio_label">Working</span></label>'+'<input type="radio" name="work_state" value="not_working" {not_working_checked} '+'id="work_state_not_working"/>'+'<label for="work_state_not_working"><span class="radio_label">Not Working</span></label></form>',},month_names:['January','Febuary','March','April','May','June','July','August','September','October','November','December'],init_widget:function()
{this.date_parser=SG.GridEditor.DateParser;if(this.get('exceptions_date'))
this.current_date=this.date_parser.parse(this.get('exceptions_date'));else
this.current_date=this.date_parser.get_normalized_today();if(this.get("mode")=='exceptions')
{this.select_current_date_now=true;}
this.set_selected_week();},set_selected_week:function()
{date=this.current_date.clone();while(this.date_parser.get_day(date)>0)
this.date_parser.shift_date(date,-1);this.selected_week=date;},on_first_render:function()
{this.entity_type=this.context.get('entity_type');this.entity_ids=[];var selected=this.context.get('selected_entities');if(selected)
for(var i=0;i<selected.length;i++)
this.entity_ids.push(selected[i].id);this.container=this.get_container();this.add_event(this.container,'click',this.on_click);},on_load_work_day_rules:function()
{this.hide_loading_overlay();this.rules_loaded=true;this.render();SG.NotificationCenter.post({uuid:'work_schedule_editor',name:'work_schedule_changed',args:this.working_days.is_dirty(),canvas_id:null});},is_dirty:function()
{return(this.working_days&&this.working_days.is_dirty());},render_widget:function()
{var html=this.templates.main.apply({tabs:this.render_tabs(),contents:(this.get('mode')=='work_week')?this.render_work_week():this.render_exceptions()});this.container.update(html);if(!this.rules_loaded)
this.fetch_work_day_rules();if(this.get('mode')!='work_week'&&this.selected_week)
this.render_selected_week_overlay();else if(this.get('mode')=='work_week'&&this.rules_loaded)
{this.create_and_render_history();}
if(this.rules_loaded&&this.select_current_date_now)
{this.select_current_date_now=false;var selector='td.work_week_editor_table td.work_day[date="'+
this.date_parser.data_store_format(this.current_date)+'"]';var date_td=sg_find(selector,this.container.dom);if(date_td)
{date_td=Ext.get(date_td);this.select_work_day(date_td);this.render_comment();}}},rerender_history:function()
{if(this.get('mode')=='work_week'&&this.rules_loaded)
{this.create_and_render_history();}},create_and_render_history:function()
{var history_div=this.container.child('div.work_week_history');this.work_week_history=new SG.util.WorkWeekHistory({container:history_div,entity_type:this.entity_type,entity_ids:this.entity_ids,data_set:this.working_days.data_set});},render_tabs:function()
{var mode=this.get('mode');var h=this.templates.tabs.apply({work_week_selected:mode=='work_week'?'selected':'',exceptions_selected:mode!='work_week'?'selected':'',exceptions_tab_text:this.entity_type=='HumanUser'?'Vacation and Exceptions':'Exceptions'});return h;},render_work_week:function(start_of_week)
{if(!this.rules_loaded)
return'';var date=start_of_week?start_of_week.clone():this.get_week(this.date_parser.get_normalized_today())[0];var days_html='';var total_week_exceptions=0;for(var i=0;i<7;i++)
{var state=this.working_day(date);var exceptions=this.get_exceptions(date);total_week_exceptions+=exceptions.length;if(!start_of_week)
{days_html+=this.templates.work_day_normal.apply({state:state,day:this.date_parser.get_short_day_name(date),date:this.date_parser.data_store_format(date),check_icon_class:state=='on'?'checkbox_checked':state=='off'?'checkbox_cleared':'checkbox_disabled',});}
else
{days_html+=this.templates.work_day_exception.apply({state:state,day:this.date_parser.get_short_day_name(date),date:this.date_parser.data_store_format(date),month_day:(this.date_parser.get_month(date)+1)+'/'+this.date_parser.get_date(date),exception:exceptions.length>0?'exception':'',});}
this.date_parser.shift_date(date,1);}
if(!start_of_week)
{return this.templates.work_week_normal.apply({title:'Work days',days:days_html});}
else
{return this.templates.work_week_exceptions.apply({clear_label:total_week_exceptions>0?'Remove All Exceptions':'',start_of_week:this.date_parser.data_store_format(start_of_week),days:days_html});}},render_exceptions:function()
{if(!this.rules_loaded)
return'';return this.templates.exception_tab.apply({calendar:this.render_calendar(),exceptions_work_week:this.render_work_week(this.selected_week)});},render_calendar:function()
{var html=this.templates.calendar_header.apply({month_year:(this.date_parser.get_short_month_name(this.current_date))+' '+
this.date_parser.get_year(this.current_date)});var today=this.date_parser.get_normalized_today();var day=this.current_date.clone();this.date_parser.set_date(day,1);var first_day_day_of_week=this.date_parser.get_day(day);this.date_parser.shift_date(day,-first_day_day_of_week);var state,exceptions,day_of_week,day_template,i,week;var days_html='';var weeks_html=this.templates.calendar_week_header.apply();;for(i=0;i<first_day_day_of_week;i++)
{state=this.working_day(day);exceptions=this.get_exceptions(day);day_of_week=this.date_parser.get_day(day);day_template;if(exceptions.length>0)
day_template=this.templates.calendar_day_exception;else
day_template=this.templates.calendar_day;days_html+=day_template.apply({off_month:'off_month',state:state,day_number:this.date_parser.get_date(day),weekend:day_of_week==0||day_of_week==6?'weekend':''});this.date_parser.shift_date(day,1);}
while(this.date_parser.get_month(day)==this.date_parser.get_month(this.current_date))
{state=this.working_day(day);exceptions=this.get_exceptions(day);day_of_week=this.date_parser.get_day(day);day_template;if(exceptions.length>0)
day_template=this.templates.calendar_day_exception;else
day_template=this.templates.calendar_day;days_html+=day_template.apply({state:state,day_number:this.date_parser.get_date(day),weekend:day_of_week==0||day_of_week==6?'weekend':'',today:this.date_parser.same_date(today,day)?'today':'',});if(this.date_parser.get_day(day)==6)
{week=this.get_week(day);weeks_html+=this.templates.calendar_week.apply({days:days_html,start_of_week:this.date_parser.data_store_format(week[0]),end_of_week:this.date_parser.data_store_format(week[1]),selected:this.date_parser.same_date(week[0],this.selected_week)?'selected':''});days_html='';}
this.date_parser.shift_date(day,1);}
day_of_week=this.date_parser.get_day(day);if(day_of_week>0)
{for(i=day_of_week;i<7;i++)
{state=this.working_day(day);exceptions=this.get_exceptions(day);day_of_week=this.date_parser.get_day(day);day_template;if(exceptions.length>0)
day_template=this.templates.calendar_day_exception;else
day_template=this.templates.calendar_day;days_html+=day_template.apply({off_month:'off_month',state:state,day_number:this.date_parser.get_date(day),weekend:day_of_week==0||day_of_week==6?'weekend':''});if(i==6)
week=this.get_week(day);this.date_parser.shift_date(day,1);}}
weeks_html+=this.templates.calendar_week.apply({days:days_html,start_of_week:this.date_parser.data_store_format(week[0]),end_of_week:this.date_parser.data_store_format(week[1]),selected:this.date_parser.same_date(week[0],this.selected_week)?'selected':''});return html+weeks_html;},render_selected_week_overlay:function()
{var selected_week_div=this.container.child('div.week.selected');var selected_week_overlay=this.container.child('div.selected_week_overlay');if(selected_week_div)
{selected_week_overlay.removeClass('display_none');selected_week_overlay.alignTo(selected_week_div,'tl-tl');}
else if(selected_week_overlay)
selected_week_overlay.addClass('display_none');},working_day:function(date)
{return this.working_days.working_day(date,this.get('mode')=='exceptions');},get_exceptions:function(date)
{return this.working_days.find_applicable_work_day_rules(date,true)},on_click:function(e)
{var t=Ext.get(e.getTarget());var work_day_td=t.findParent('td.work_day',this.container,true);if(work_day_td)
{if(this.get('mode')=='exceptions')
{var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;this.select_work_day(work_day_td,ctrl_click,dom_event.shiftKey);this.render_comment();}
else
{var date=work_day_td.dom.getAttribute("date");var state=work_day_td.dom.getAttribute("state");this.set_state(date,(state=='on'?'off':'on'));}
return;}
var work_week_td=t.findParent('td.work_week',this.container,true);if(work_week_td)
{if(work_week_td.hasClass('selected'))return;this.set('mode','work_week');this.fetch_work_day_rules();return;}
var exceptions_td=t.findParent('td.exceptions',this.container,true);if(exceptions_td)
{if(exceptions_td.hasClass('selected'))return;this.set('mode','exceptions');this.fetch_work_day_rules();return;}
var today_span=t.findParent('span.go_today',this.container);if(today_span)
{this.current_date=this.date_parser.get_normalized_today();this.set_selected_week();this.fetch_work_day_rules();return;}
var prev_month=t.findParent('td.go_prev_month',this.container);if(prev_month)
{this.shift_month(-1);return;}
var next_month=t.findParent('td.go_next_month',this.container);if(next_month)
{this.shift_month(1);return;}
var month_elem=t.findParent('td.month_year',this.container);if(month_elem)
{this.show_month_menu(month_elem);return;}
var week_div=t.findParent('div.week',this.container,true);if(week_div)
{this.select_week(week_div);return;}
var work_state_radio=t.findParent('input[name="work_state"]',this.container,true);if(work_state_radio)
{var comment_body=work_state_radio.findParent('div.comment_body',this.container,true);var create_button=comment_body.child('input.create_exceptions');if(create_button.dom.hasAttribute('disabled'))
create_button.dom.removeAttribute('disabled');return;}
var create_exceptions=t.findParent('input.create_exceptions',this.container,true);if(create_exceptions)
{var comment_body=create_exceptions.findParent('div.comment_body',this.container,true);var working_radio=comment_body.child('input[value="working"]');var state=working_radio.dom.checked?'on':'off';var selected_dates=this.get_selected_work_day_exception_dates();var description_textarea=comment_body.child('textarea');var description=description_textarea.dom.value;for(var i=0;i<selected_dates.length;i++)
{var date=selected_dates[i];var recs=this.set_state(this.date_parser.data_store_format(date),state,(i!=(selected_dates.length-1)));if(description.length>0)
{for(var j=0;j<recs.length;j++)
recs[j].set('description',description);}}
return;}
var cancel_create_exceptions=t.findParent('.cancel_create_exceptions',this.container,true);if(cancel_create_exceptions)
{this.render();return;}
var clear_exceptions=t.findParent('span.clear_exceptions',this.container)
if(clear_exceptions)
{if(Ext.get(clear_exceptions).hasClass('selected'))
{var selected_dates=this.get_selected_work_day_exception_dates();if(selected_dates.length>0)
{for(var i=0;i<selected_dates.length;i++)
{this.working_days.clear_exceptions(selected_dates[i]);}}}
else
{var start_date=this.date_parser.parse(clear_exceptions.getAttribute('start_of_week'));for(var i=0;i<7;i++)
{this.working_days.clear_exceptions(start_date);this.date_parser.shift_date(start_date,1);}}
this.render();SG.NotificationCenter.post({uuid:'work_schedule_editor',name:'work_schedule_changed',args:this.working_days.is_dirty(),canvas_id:null});}},select_work_day:function(work_day_td,ctrl_click,shift_click)
{if(shift_click&&this.last_work_day_td)
{var low=this.last_work_day_td.getLeft();var high=work_day_td.getLeft();if(low>high)
{var temp=low;low=high;high=temp;}
var work_day_tds=sg_find_all('td.work_day',this.container.dom);for(var i=0;i<work_day_tds.length;i++)
{var td=Ext.get(work_day_tds[i]);var l=td.getLeft();if(l>=low&&l<=high&&!td.hasClass('selected'))
td.addClass('selected');}
this.last_work_day_td=work_day_td;}
else
{if(!ctrl_click)this.clear_work_day_selection();if(work_day_td.hasClass('selected')&&ctrl_click)
work_day_td.removeClass('selected');else if(!work_day_td.hasClass('selected'))
{work_day_td.addClass('selected');this.last_work_day_td=work_day_td;}}},clear_work_day_selection:function()
{var work_day_tds=sg_find_all('td.work_day',this.container.dom);for(var i=0;i<work_day_tds.length;i++)
{var td=Ext.get(work_day_tds[i]);if(td.hasClass('selected'))
td.removeClass('selected');}},get_selected_work_day_exception_dates:function()
{var work_day_tds=sg_find_all('td.work_day',this.container.dom);var sel_dates=[];for(var i=0;i<work_day_tds.length;i++)
{var td=Ext.get(work_day_tds[i]);if(td.hasClass('selected'))
{var date=this.date_parser.parse(td.dom.getAttribute('date'));sel_dates.push(date);}}
return sel_dates;},show_month_menu:function(month_elem)
{var menu=this.new_component(SG.Menu,{position:{dom_elem:month_elem,elem_anchor:"r",menu_anchor:"l"}});for(var i=-12;i<13;i++)
{if(i==0||i==1)
menu.items.push({line:true});var menu_date=this.current_date.clone();this.date_parser.shift_month(menu_date,i);menu.items.push({html:this.month_names[this.date_parser.get_month(menu_date)]+" "+
this.date_parser.get_year(menu_date),checked:(i==0),date_str:this.date_parser.data_store_format(menu_date),date:menu_date,item_selected:{fn:this.on_month_menu_select,scope:this}});}
menu.render();menu.show();},on_month_menu_select:function(menu,menu_item)
{this.current_date=menu_item.date;this.set_selected_week();this.fetch_work_day_rules();},select_week:function(week_div)
{this.selected_week=this.date_parser.parse(week_div.dom.getAttribute('start'));this.render();},shift_month:function(amount)
{this.date_parser.shift_month(this.current_date,amount);this.set_selected_week();this.fetch_work_day_rules();},get_week:function(date_in_week)
{var week_start=date_in_week.clone();var current_day_of_week=this.date_parser.get_day(week_start);if(current_day_of_week!=0)
this.date_parser.shift_date(week_start,-current_day_of_week);var week_end=week_start.clone();this.date_parser.shift_date(week_end,6);return[week_start,week_end];},fetch_work_day_rules:function()
{if(!this.working_days)
{this.working_days=new SG.util.WorkingDays({entity_type:this.entity_type,entity_ids:this.entity_ids,on_data_loaded:{fn:this.on_load_work_day_rules,scope:this}});}
if(this.get('mode')=='work_week')
{var current_week=this.get_week(this.date_parser.get_normalized_today());var range_start=current_week[0];var range_end=current_week[1];}
else
{var range_start=this.current_date.clone();this.date_parser.set_date(range_start,1);var range_end=range_start.clone();this.date_parser.shift_month(range_end,1);this.date_parser.shift_date(range_end,-1);range_start=this.get_week(range_start)[0];range_end=this.get_week(range_end)[1];}
var original_start=this.working_days.start_date;var original_end=this.working_days.end_date;if(!this.working_days.start_date||this.working_days.start_date>range_start)
this.working_days.start_date=range_start;if(!this.working_days.end_date||this.working_days.end_date<range_end)
this.working_days.end_date=range_end;if(original_start!=this.working_days.start_date||original_end!=this.working_days.end_date)
{this.show_loading_overlay();this.working_days.fetch();}
else
this.render();},set_state:function(date,state,surpress_render)
{var date_as_date_obj=this.date_parser.parse(date);var recs=this.working_days.set_state_for_entities(date_as_date_obj,state,(this.get('mode')=='exceptions'));if(!surpress_render)
this.render();SG.NotificationCenter.post({uuid:'work_schedule_editor',name:'work_schedule_changed',args:this.working_days.is_dirty(),canvas_id:null});return recs;},reset:function()
{this.working_days.reset_and_reload();},save_work_day_rules:function(callback)
{if(this.working_days.is_dirty())
{var dialog=new SG.NewDialog({css_class:'sgd_work_schedule_update_dialog',width:'450px',title:'Update Work Schedule',body:'<div class="choose_prompt">Any existing Tasks that span the work days you '+'just changed will need to be updated. You have two choices:</div>'+'<table><tr>'+'<td><input id="sgd_work_schedule_due_date" type="radio" name="sgd_work_schedule_radio" '+'checked></td>'+'<td><label for="sgd_work_schedule_due_date">'+'Keep the Task duration the same. Recalculate the End date based on the number '+'of working days after the Start date.</label></td>'+'</tr><tr>'+'<td><input id="sgd_work_schedule_duration" type="radio" name="sgd_work_schedule_radio"></td>'+'<td><label for="sgd_work_schedule_duration">'+'Don\'t touch the End date! Instead, change the Task duration to be the number of '+'working days between the Start and End date.</label></div></td>'+'</tr></table>',actions:[{label:"Cancel",type:'link'},{label:'Update',dont_close:true,callback:{fn:this.on_confirm_save,scope:this}}]});dialog.callback=callback;}
else
{callback.fn.call(callback.scope);}},on_confirm_save:function(dialog)
{var duration_button=dialog.container.child('input#sgd_work_schedule_duration');var update_field=duration_button.dom.checked?"duration":"due_date";dialog.destroy();if(!this.__destroyed)
this.show_loading_overlay();this.working_days.save(update_field,{fn:function(){if(!this.__destroyed)
this.hide_loading_overlay();if(dialog.callback)
dialog.callback.fn.call(dialog.callback.scope);},scope:this});},render_comment:function()
{var sel_dates=this.get_selected_work_day_exception_dates();var comment_div=this.container.child('div.comments');if(sel_dates.length==0)
{comment_div.update('');return;}
var exceptions=[];for(var i=0;i<sel_dates.length;i++)
{var e=this.get_exceptions(sel_dates[i]);exceptions=exceptions.concat(e);}
var working_checked='';var not_working_checked='';var description='';if(exceptions.length==1&&sel_dates.length==1)
{var e=exceptions[0];if(e.get('working'))
working_checked='checked="true"';else
not_working_checked='checked="true"';var d=e.get('description');if(d)
description=d;}
var button_controls=this.templates.working_radio_buttons.apply({working_checked:working_checked,not_working_checked:not_working_checked});comment_div.update(this.templates.exception_comment.apply({button_controls:button_controls,description:d,create_disabled:'disabled="true"',clear_label:exceptions.length>0?'Remove Selected Exceptions':'',start_of_week:this.date_parser.data_store_format(this.selected_week),}));},});SG.Widget.WorkSchedule=function(context,widget_spec,id)
{SG.Widget.WorkSchedule.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.WorkSchedule,SG.Widget.Base,{default_settings:{},templates:{widget:'<div class="sgw_work_schedule"><div class="work_schedule_title">Work Schedules</div>'+'<div class="work-schedule_page_info">Manage the default work schedule for all Projects or create '+'custom schedules and overrides for specific Project or People. For example, you may set '+'the default work schedule to be Monday to Friday with Saturday and Sunday off, along with some '+'company-wide holidays off. Then you can override that schedule for a specific project that needs '+'to work 6 days a week for a few weeks. Or you can define a person\'s vacation schedule. '+'<a target="_blank" href="'+SG.globals.help_urls.work_schedule+'">Read more about work schedules.</a></div>'+'<div>{controls}</div>{work_schedule}<div>{controls}</div></div>',work_schedule:'<div class="work_schedule {selected_schedule}"><table>'+'<td id="choices"><div class="work_schedule_choices">'+'<div id="default_schedule" class="choice"><div class="sg_entity_icon_span">'+'<div class="icon_WorkSchedule"></div></div>Default</div>'+'<div id="menu_heading">CUSTOM WORK SCHEDULES</div>'+'<div id="project_schedule" class="choice"><div class="sg_entity_icon_span">'+'<div class="icon_Project"></div></div>Projects</div>'+'<div id="user_schedule" class="choice"><div class="sg_entity_icon_span">'+'<div class="icon_HumanUser"></div></div>People</div>'+'</div></td>'+'<td id="schedule"><div class="wrapper">'+'<div class="{grid_exists_class}"><div id="{grid_id}" class="{grid_class}"></div></div>'+'<div class="schedule_editor_container">'+'<div id="{schedule_editor_id}" class="{schedule_editor_class}"></div></div>'+'<div class="splitter_drag {grid_exists_class}"></div></div></td>'+'</table></div>',controls:'<div class="controls">'+'<input class="save" type="button" value="Save Changes" {disabled_attr}>{cancel}{schedule_modified}</div>',schedule_modified:'<span class="schedule_modified">'+'The Work Schedule has been modified. Save by clicking the Save Changes button or '+'<span class="reset">Clear your changes</span>.</span>',cancel:'<span class="cancel">Cancel</span>',no_selected_entities:'<div class="no_selected_entities">No {entity_plural} selected.  Select 1 or more '+'{entity_plural} from the list above to view or edit the Work Schedule.</div>',unsaved_changes:'<b>Save changes to the work schedule?</b> If you don\'t save the changes, they will be lost.'},init_widget:function()
{this.context.set('inside_work_schedule_editor',true);var grid=this.get_child('grid');if(grid)
grid.set('show_toolbar_buttons',false);},before_init:function()
{this.context.set('no_auto_detail_link',true);},on_first_render:function()
{this.add_event(this.get_container(),'click',this.on_click);},render_widget:function()
{var selected_schedule=this.get('selected_schedule');var grid=this.get_child('grid');var schedule_editor=this.get_child('work_week_editor');this.container=this.get_container();this.container.update(this.templates['widget'].apply({controls:this.render_controls(false),work_schedule:this.templates['work_schedule'].apply({selected_schedule:selected_schedule,grid_exists_class:grid?'grid_exists':'',grid_id:grid?grid.get_container_id():'',grid_class:grid?grid.get_css_class_name():'',schedule_editor_id:schedule_editor.get_container_id(),schedule_editor_class:schedule_editor.get_css_class_name()})}));if(grid)
{grid.render();this.grid_notification_binding={uuid:'work_schedule_page_grid',name:'selection_changed',callback:{fn:this.on_selection_changed,scope:this}}
SG.NotificationCenter.add_observer(this.grid_notification_binding);this.splitter_drag_div=this.container.child('div.splitter_drag');this.height_drag_zone=new SG.HeightDragZone(this.splitter_drag_div,this,this.resize_grid_height);}
this.editor_notification_binding={uuid:'work_schedule_editor',name:'work_schedule_changed',callback:{fn:this.on_work_schedule_changed,scope:this}}
SG.NotificationCenter.add_observer(this.editor_notification_binding);if(!this.context.get('entity_type')||this.context.get('selected_entities'))
schedule_editor.render();},resize_grid_height:function()
{var t=this.splitter_drag_div.getTop(true);if(t<150)t=150;var grid_container=this.container.child('div.wrapper>div.grid_exists');grid_container.setHeight(t);this.splitter_drag_div.setTop(t);},render_controls:function(schedule_dirty)
{return this.templates['controls'].apply({cancel:this.inside_overlay?this.templates['cancel'].apply({}):'',schedule_modified:schedule_dirty?this.templates['schedule_modified'].apply({}):'',disabled_attr:schedule_dirty?'':'disabled'})},rerender_controls:function(schedule_dirty)
{var controls=this.render_controls(schedule_dirty);var elements=sg_find_all('div.controls',this.get_container().dom);for(i=0;i<elements.length;i++)
{Ext.get(elements[i].parentNode).update(controls);}},render_no_selection:function(schedule_editor_container_ext_elem)
{schedule_editor_container_ext_elem.update(this.templates['no_selected_entities'].apply({entity_plural:SG.schema.entity_types[this.context.get('entity_type')].display_name.pluralize()}));},on_selection_changed:function(selection)
{var old_schedule_editor=this.get_child('work_week_editor');if(old_schedule_editor&&old_schedule_editor.is_dirty())
{var dialog=new SG.NewDialog({title:'Unsaved Changes',body:this.templates.unsaved_changes.apply({}),actions:[{label:"Don't Save",margin_right:'115px',callback:{fn:this.on_confirm_selection_change,scope:this}},{label:"Cancel",margin_right:'8px',callback:{fn:this.on_cancel_selection_change,scope:this}},{label:'Save',callback:{fn:this.on_confirm_save,scope:this}}]});dialog.old_schedule_editor=old_schedule_editor;dialog.old_selection=this.context.get('selected_entities');dialog.selection=selection;return;}
this.selection_changed(selection,old_schedule_editor);},selection_changed:function(selection,old_schedule_editor)
{var schedule_editor_container=old_schedule_editor.get_container();this.destroy_child(old_schedule_editor);if(selection.length==0)
{this.context.set('selected_entities',null);var schedule_editor=this.construct_child('work_week_editor',this.context.clone());schedule_editor_container.dom.id=schedule_editor.get_container_id();this.render_no_selection(schedule_editor_container)}
else
{this.context.set('selected_entities',selection);var schedule_editor=this.construct_child('work_week_editor',this.context.clone());schedule_editor_container.dom.id=schedule_editor.get_container_id();schedule_editor.render();}},on_confirm_selection_change:function(dialog)
{this.selection_changed(dialog.selection,dialog.old_schedule_editor);},on_cancel_selection_change:function(dialog)
{var unselected_ids=[];for(var i=0;i<dialog.selection.length;i++)
unselected_ids.push(dialog.selection[i].id);var selected_ids=[];for(var i=0;i<dialog.old_selection.length;i++)
selected_ids.push(dialog.old_selection[i].id);var entity_query_page=this.get_child('grid');entity_query_page.select_entities_by_id(unselected_ids,true);entity_query_page.select_entities_by_id(selected_ids);entity_query_page.on_entities_selected(selected_ids,true);},on_confirm_save:function(dialog)
{var me=this;dialog.old_schedule_editor.save_work_day_rules({fn:function(){me.selection_changed(dialog.selection,dialog.old_schedule_editor);},scope:me});},on_work_schedule_changed:function(schedule_dirty)
{this.rerender_controls(schedule_dirty);},on_click:function(evt)
{var target=Ext.get(evt.target);var schedule_choice=target.findParent('div.choice',this.get_container());if(schedule_choice)
{if(schedule_choice.id=='default_schedule')
{this.on_change_schedule_type(null);return;}
if(schedule_choice.id=='project_schedule')
{this.on_change_schedule_type('Project');return;}
if(schedule_choice.id=='user_schedule')
{this.on_change_schedule_type('HumanUser');return;}}
if(target.hasClass('save'))
{var work_week_editor=this.get_child('work_week_editor');if(work_week_editor)
work_week_editor.save_work_day_rules({fn:this.on_work_day_rules_saved,scope:this});else
throw("Error: save clicked with no work week editor created.");return;}
if(target.hasClass('reset'))
{var work_week_editor=this.get_child('work_week_editor');if(work_week_editor)
work_week_editor.reset();else
throw("Error: reset clicked with no work week editor created.");return;}
if(target.hasClass('cancel'))
{this.destroy();this.inside_overlay.destroy();return;}},on_work_day_rules_saved:function()
{if(this.inside_overlay)
{if(this.inside_overlay.entity_query_page)
{var widget=this.inside_overlay.entity_query_page.get_content_widget();setTimeout(function(){widget.work_schedule_changed()},10);}
this.destroy();this.inside_overlay.destroy();}
else
{this.rerender_controls();if(!this.context.get('entity_type')||this.context.get('selected_entities'))
this.get_child('work_week_editor').rerender_history();}},destroy_widget:function()
{if(this.grid_notification_binding)
SG.NotificationCenter.remove_observer(this.grid_notification_binding);if(this.editor_notification_binding)
SG.NotificationCenter.remove_observer(this.editor_notification_binding);},on_change_schedule_type:function(entity_type)
{var schedule_editor=this.get_child('work_week_editor');if(schedule_editor&&schedule_editor.is_dirty())
{var dialog=new SG.NewDialog({title:'Unsaved Changes',body:this.templates.unsaved_changes.apply({}),actions:[{label:"Don't Save",margin_right:'115px',callback:{fn:this.on_confirm_change_schedule_type,scope:this}},{label:"Cancel",margin_right:'8px'},{label:'Save',callback:{fn:this.on_confirm_save_before_change_schedule_type,scope:this}}]});dialog.schedule_editor=schedule_editor;dialog.entity_type=entity_type;return;}
this.change_schedule_type(entity_type);},on_confirm_change_schedule_type:function(dialog)
{this.change_schedule_type(dialog.entity_type);},on_confirm_save_before_change_schedule_type:function(dialog)
{var me=this;dialog.schedule_editor.save_work_day_rules({fn:function(){me.change_schedule_type(dialog.entity_type);},scope:me});},change_schedule_type:function(entity_type)
{this.cache_page_settings();var inside_overlay=this.inside_overlay;if(SG.globals.work_schedule_pages&&SG.globals.work_schedule_pages[entity_type])
{var settings=SG.globals.work_schedule_pages[entity_type];var page=this.get_page();page.set_spec(new SG.Widget.Spec(page,settings));page.context.set('entity_type',entity_type);page.context.set('selected_entities',null);page.context.set('select_entities_on_first_load',[1]);page.destroy_root_widget();page.construct_root_widget();if(inside_overlay)
page.root_widget.inside_overlay=inside_overlay;return;}
var options={url:"/page/work_schedule",params:{entity_type:entity_type,selected_entities:null},callback:function(options,success,response){if(success){var page=this.get_page();page.set_spec(new SG.Widget.Spec(page,Ext.decode(response.responseText).settings));page.context.set('entity_type',entity_type);page.context.set('selected_entities',null);page.context.set('select_entities_on_first_load',[1]);page.destroy_root_widget();page.construct_root_widget();if(inside_overlay)
page.root_widget.inside_overlay=inside_overlay;}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},cache_page_settings:function()
{var entity_type=this.context.get('entity_type');if(!entity_type)return;var page=this.get_page();if(!SG.globals.work_schedule_pages)SG.globals.work_schedule_pages={};SG.globals.work_schedule_pages[entity_type]=page.spec.to_hash();},});SG.WorkScheduleOverlay=function(config)
{Ext.apply(this,config);SG.WorkScheduleOverlay.superclass.constructor.call(this);this.selected_entities=this.selected_entities||[];};Ext.extend(SG.WorkScheduleOverlay,SG.Component,{templates:{main:'{page}',page:'<div id="sg_page_0" class="sgc_work_schedule_overlay_page sg_page"></div>'},init_component:function(){sg_close_all_floating_windows();this.render();},destroy_component:function(){this.container.remove();},render:function(){var dh=Ext.DomHelper;this.container=dh.append(document.body,{tag:'div',cls:'sgc_work_schedule_overlay'},true);this.container.update(this.templates.main.apply({page:this.templates.page.apply(),}));this.render_page();},render_page:function()
{var me=this;var options={url:'/page/work_schedule',params:{entity_type:this.entity_type,selected_entities:Ext.encode(this.selected_entities)},callback:function(options,success,response){if(success){var page;eval("page = "+response.responseText);me.init_page(page);}}};if(this.exceptions_date)
options.params.exceptions_date=this.exceptions_date;var conn=new Ext.data.Connection();conn.request(options);},init_page:function(page_config)
{if(this.selected_entities)
page_config.context['select_entities_on_first_load']=this.selected_entities;this.page=new SG.Page(page_config.config,page_config.context,page_config.settings);this.page.root_widget.inside_overlay=this;},});SG.util.WorkWeekHistory=function(config)
{Ext.apply(this,config);SG.util.WorkWeekHistory.superclass.constructor.call(this);};Ext.extend(SG.util.WorkWeekHistory,SG.Component,{templates:{main:'<div class="title">Schedule History</div>{weeks}',day:'<span class="day {working}">{day}{comma}</span>',week:'<div class="week" record_id="{record_id}">{days}<span class="start_date">{start_date}</span>'+'<span class="user"></span><span class="description">( {description} )</span></div>',},init_component:function()
{this.container.addClass('sgc_work_week_history');this.date_parser=SG.GridEditor.DateParser;this.setup_week_dates();this.wd_util=new SG.util.WorkingDays({entity_type:this.entity_type,entity_ids:this.entity_ids,start_date:this.week_start,end_date:this.week_end});var i;var default_rules=[];var history_rules=[];for(i=0;i<this.data_set.count();i++)
{var r=this.data_set.get_record(i);if(r.get_state()=='new')continue;if(r.get('precedence')==1)continue;var user=r.get('user');var project=r.get('project');var start_date=r.get('start_date');var type='history';if(user==null&&project==null)
{if(start_date)
history_rules.push(r);else
default_rules.push(r);}
else
history_rules.push(r);}
default_rules.reverse();history_rules.reverse();this.request_event_log_entries(history_rules);var c=0;var weeks=[];for(i=0;i<history_rules.length;i++)
{if(i!=0)
this.working_data_set.destroy();this.working_data_set=this.new_data_set('WorkDayRule');this.wd_util.data_set=this.working_data_set;var r=history_rules[i];c=1;this.push_record_into_working_data_set(r,c);for(j=i-1;j>=0;j--)
{c+=1;this.push_record_into_working_data_set(history_rules[j],c);}
for(j=0;j<default_rules.length;j++)
{c+=1;this.push_record_into_working_data_set(default_rules[j],c);}
weeks.push(this.render_week_history(r));}
weeks.reverse();var html='';if(weeks.length>0)
html=this.templates.main.apply({weeks:weeks.join('')});this.container.update(html);},setup_week_dates:function()
{this.week_start=this.date_parser.get_normalized_today();var current_day_of_week=this.date_parser.get_day(this.week_start);if(current_day_of_week!=0)
this.date_parser.shift_date(this.week_start,-current_day_of_week);this.week_end=this.week_start.clone();this.date_parser.shift_date(this.week_end,6);},render_week_history:function(r)
{var cur_date=this.week_start.clone();var days_html='';var day=['S','M','T','W','T','F','S'];var day_long=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];for(var i=0;i<7;i++)
{days_html+=this.templates.day.apply({working:this.wd_util.working_day(cur_date,false),day:day[i],comma:i!=6?',':''});this.date_parser.shift_date(cur_date,1);}
var start_date=new SG.Date(r.get('start_date'));var working=r.get('working')?'on':'off';var description;if(this.entity_type&&!r.get('project')&&!r.get('user'))
description=day_long[r.get('day_of_week')]+' '+working+' in the Default Schedule';else
description=day_long[r.get('day_of_week')]+' '+working
return this.templates.week.apply({days:days_html,start_date:start_date.format('M j, Y'),record_id:r.id,description:description});},push_record_into_working_data_set:function(r,id)
{var new_record=this.working_data_set.new_record(id);new_record.set('start_date',r.get('start_date'));new_record.set('end_date',r.get('end_date'));new_record.set('user',r.get('user'));new_record.set('project',r.get('project'));new_record.set('day_of_week',r.get('day_of_week'));new_record.set('working',r.get('working'));new_record.set('description',r.get('description'));new_record.set('precedence',r.get('precedence'));},request_event_log_entries:function(rules)
{if(rules.length==0)return;this.event_data_set=this.new_data_set('EventLogEntry',this.on_event_data_load);var conditions=[];for(var i=0;i<rules.length;i++)
{conditions.push({path:'entity',relation:'is',values:[{type:'WorkDayRule',id:rules[i].id}]});}
var spec={type:'EventLogEntry',filters:{logical_operator:'or',conditions:conditions},columns:['user','entity','event_type'],result:this.event_data_set};SG.Repo.query(spec);},on_event_data_load:function()
{for(var i=0;i<this.event_data_set.count();i++)
{var r=this.event_data_set.get_record(i);var event_type=r.get('event_type');if(event_type=='Shotgun_WorkDayRule_New')
{var entity=r.get('entity');var week_div=this.container.child('div[record_id="'+entity.id+'"]');var user_span=week_div.child('span.user');var user_html='created by '+SG.Renderers.render_one_nodetail_entity(r.get('user'));user_span.update(user_html);}}},});SG.Widget.ManageApps=function(context,widget_spec,id)
{SG.Widget.ManageApps.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ManageApps,SG.Widget.Base,{templates:{main:'<div class="sgw_manage_apps">'+'<div class="title">Shotgun Apps</div>'+'<div class="apps">{apps}</div>'+'</div>',app:'<div class="app" app_code="{code}">'+'<div class="icon"><div class="{icon}"></div></div>'+'<div class="info">'+'<div class="name">{name}</div>'+'<div class="author">by {author}</div>'+'<div class="description">{description}</div>'+'</div>'+'<div class="version">{version}</div>'+'<div class="activation">{activation}</div>'+'</div>',on_off:'<div class="on_off {state} {disabled}" {attributes}>'+'<div class="on"><div class="switch_large_on"></div></div>'+'<div class="off"><div class="switch_large_off"></div></div>'+'</div>',join_private_beta:'<a href="{url}" target="_blank"><div class="button_join_private_beta"></div></a>'},apps:[{code:'notes',icon:'app_review_notes_large_shad',name:'Review Notes',author:'Shotgun',description:"Review Notes allows you to take notes during a review session and then send them out "+"to all the right people at the studio.  It's built for speed, so you can quickly add notes, "+"access important information about each thing you're reviewing, and automatically send a "+"summary email to any email address after the review.",version:"3.0"},{code:'crew',icon:'app_crew_planning_large_shad',name:'Crew Planning<span class="beta">BETA</span>',author:'Shotgun',description:"Crew Planning lets you manage and share who's working on what projects, and when "+"they're on vacation.  You can sort and filter for people by their availability, department, "+"or name, then quickly add or adjust bookings through drag and drop.",version:"0.1"},{code:'revolver',icon:'app_revolver_large_shad',name:'Revolver<span class="beta">PRIVATE BETA</span>',author:'Shotgun',description:"Revolver makes reviewing media simple and fast.  It allows anyone to playback "+"submitted media, either in the browser or an integrated review package, then add notes, "+"annotate frames, and send those notes back to the people doing the work.",version:"0.5",join_url:'http://www.shotgunsoftware.com/revolver'},{code:'tank',icon:'app_tank_large_shad',name:'Tank<span class="beta">PRIVATE BETA</span>',author:'Shotgun',description:"Tank is an asset management system that makes it easy for people to open, "+"version, and publish their work in applications like Maya, Nuke, and Houdini.  Tank "+"keeps the file system organized, and it's fully customizable to fit your pipeline.",version:"0.10",join_url:'http://www.shotgunsoftware.com/tank'}],init_widget:function(){},on_first_render:function(){this.container=this.get_container();this.add_event(this.container.dom,"click",this.on_click);},render_widget:function(){var apps=[];for(var i=0;i<this.apps.length;i++){if(this.apps[i].code=='notes'){this.apps[i].activation=this.templates.on_off.apply({state:'on',disabled:'disabled',attributes:'sg_tip="Configuration coming soon!"'});}else if(this.apps[i].code=='crew'){var state=SG.globals.preferences.crew_planning_app_active?'on':'off';this.apps[i].activation=this.templates.on_off.apply({state:state,disabled:'enabled'});}else if(this.apps[i].code=='revolver'&&SG.globals.preferences.enable_revolver){this.apps[i].activation=this.templates.on_off.apply({state:'on',disabled:'disabled',attributes:'sg_tip="Configuration coming soon!"'});}else if(this.apps[i].code=='tank'&&SG.globals.preferences.enable_tank_integration){this.apps[i].activation=this.templates.on_off.apply({state:'on',disabled:'disabled',attributes:'sg_tip="Configuration coming soon!"'});}else{this.apps[i].activation=this.templates.join_private_beta.apply({url:this.apps[i].join_url});}
apps.push(this.templates.app.apply(this.apps[i]));}
this.container.dom.innerHTML=this.templates.main.apply({apps:apps.join('')});},on_click:function(e){var target=Ext.get(e.getTarget());var elem=target.findParent('div.on_off');if(elem&&elem.className.indexOf('disabled')==-1){var app_elem=Ext.get(elem).findParent('div.app');this.toggle_activation(app_elem.getAttribute('app_code'),elem);return;}
elem=target.findParent('div.app');if(elem){this.configure_app(elem.getAttribute('app_code'));return;}},configure_app:function(app_code){if(app_code!='crew'){return;}
var dialog=new SG.ManageCrewPlanning();this.add_event(dialog,'close',this.on_config_dialog_close);},on_config_dialog_close:function(){puts('reloading!');this.show_loading_overlay();this.reload_prefs();},toggle_activation:function(app_code,on_off_elem){if(app_code!='crew')
return;this.show_loading_overlay();var new_val=!SG.globals.preferences.crew_planning_app_active;on_off_elem=Ext.get(on_off_elem);on_off_elem.removeClass('off');on_off_elem.removeClass('on');on_off_elem.addClass(new_val?'on':'off');var prefs_hash={pref_type:'site',crew_planning_app_active:new_val?'yes':'no'}
var options={url:'/preferences/update_prefs',params:prefs_hash,callback:function(options,success,response){if(success){var response_obj=response.responseText.strip();if(response_obj.length>0){response_obj=Ext.decode(response_obj);if(response_obj.error){this.feedback=response_obj.error;this.reload_prefs();SG.server_error({html_msg:response_obj.error,connection_response:response});return;}
var job=response_obj;var pi=new SG.ProgressIndicator(null,'det','Updating...');if(pi.add_job(job)===false){this.update_failed(response);}else{this.hide_loading_overlay();pi.show();var me=this;pi.set_post_completion(job,function(){me.update_successful();});pi.start_updates(null,true,response);}}else{this.update_successful();}}
else
this.update_failed(response);},scope:this};var conn=new Ext.data.Connection();conn.request(options);},update_successful:function(){this.reload_prefs();},update_failed:function(response){this.reload_prefs();SG.server_error({connection_response:response});},reload_prefs:function(){var options={url:'/preferences/get_prefs',params:{},callback:function(options,success,response){if(success)
this.load_prefs(response.responseText);else
SG.server_error({connection_response:response});},scope:this};var conn=new Ext.data.Connection();conn.request(options);},load_prefs:function(data_json)
{this.hide_loading_overlay();var prefs=Ext.decode(data_json).prefs;SG.globals.preferences.crew_planning_app_active=prefs.crew_planning_app_active.value=='yes'?true:false;this.render();}});SG.ManageCrewPlanning=function(config)
{Ext.apply(this,config);SG.ManageCrewPlanning.superclass.constructor.call(this);};Ext.extend(SG.ManageCrewPlanning,SG.NewDialog,{templates:{dialog_container:'<div class="sg_dialog_mask sg_new_dialog {dialog_class}"><div></div></div>',dialog:'<div class="sg_dialog manage_crew_planning">'+'<div class="header">'+'<div class="icon"><div class="{icon}"></div></div>'+'<div class="title">Crew Planning<span class="beta">BETA</span></div>'+'<div class="release_info">'+'<span class="datum">Version: 0.1</span>'+'<span class="datum">Status: Beta</span>'+'<span class="datum">Released: 28 July 2012</span>'+'<span class="datum">By: Shotgun</span>'+'</div>'+'<div class="on_off {state}">'+'<div class="on"><div class="switch_large_on"></div></div>'+'<div class="off"><div class="switch_large_off"></div></div>'+'</div>'+'<div class="close">x</div>'+'</div>'+'{tabs}'+'<div class="overlay hidden"></div>'+'</div>',tabs:'<div class="tabs {selected}">'+'<div class="tab overview">OVERVIEW</div>'+'<div class="tab configure">CONFIGURE</div>'+'<div class="tab_spacer"></div>'+'<div class="tab_container">{content}</div>'+'</div>',overview_tab:'<div class="description">'+'<div class="main_description">'+"Crew Planning lets you manage and share who's working on what projects, and when "+"they're on vacation.  You can sort and filter for people by their availability, department, "+"or name, then quickly add or adjust bookings through drag and drop."+'</div>'+'<div class="more_info"><a target="_blank" href="https://support.shotgunsoftware.com/entries/21655662">'+'View a video tour and read the documentation</a></div></div>'+'<div class="screenshot"><img src="/images/crew_planning_app_screenshot.png"></img></div>',configure_tab:'<div class="configure_heading">Permissions</div>'+'<div class="permissions_subheading">Who can see the full app?</div>'+'{full_app_permissions}'+'<div class="permissions_subheading">Who can see the read-only project view '+'(if added to the project navigation bar)?</div>'+'{project_brick_permissions}'+'<div class="permissions_subheading">Who can edit bookings?</div>'+'{booking_edit_permissions}'+'<div class="configure_heading">Actions</div>'+'<div class="action_buttons">'+'<div class="action_button" action="add"><span class="symbol">+</span>'+'Add Read-only View to all Project Navigation Bars</div>'+'<div class="action_button" action="remove"><span class="symbol">x</span>'+'Remove Read-only View from all Project Navigation Bars</div>'+'</div>',permission_row:'<div class="permission_row">{checkbox}'+'<span class="permission_rule_set_name" sg_checkbox_label="{checkbox_id}">'+'{permission_set_name}</span>'+'</div>',checkbox_attributes:'rule_set_code="{rule_set_code}" rule_type="{rule_type}"'},init_dialog:function()
{this.events={close:true};this.css_class='sgd_manage_crew_planning';this.selected_tab='overview';this.simple_rule_type_index={};this.project_brick_rule_index=null;this.request_permissions();this.add_event(SG.Checkbox,"change",this.on_checkbox_change,this);},render:function(){if(!this.container)
{this.container=this.templates.dialog_container.append(document.body,{dialog_class:this.css_class});this.container=Ext.get(this.container);}
var tab_content=(this.selected_tab=='overview')?this.render_overview_tab():this.render_configure_tab();var content=this.templates.dialog.apply({state:SG.globals.preferences.crew_planning_app_active?'on':'off',icon:'app_crew_planning_large_shad',tabs:this.templates.tabs.apply({selected:this.selected_tab,content:tab_content})});this.container.dom.innerHTML=content;this.dialog=Ext.get(this.container.dom.firstChild);this.body_dom=this.dialog.dom.firstChild.nextSibling;this.center_dialog();},render_overview_tab:function(){return this.templates.overview_tab.apply({});},render_configure_tab:function(){return this.templates.configure_tab.apply({full_app_permissions:this.render_full_app_permissions(),project_brick_permissions:this.render_project_brick_permissions(),booking_edit_permissions:this.render_booking_edit_permissions()});},destroy_dialog:function(){SG.KeyboardShortcutsDialog.is_showing=null;},center_dialog:function(){this.dialog.setXY(this.dialog.getCenterXY(true));},show_loading_overlay:function(){var overlay=sg_find('div.overlay',this.container.dom);Ext.get(overlay).removeClass('hidden');},hide_loading_overlay:function(){var overlay=sg_find('div.overlay',this.container.dom);Ext.get(overlay).addClass('hidden');},on_click:function(e){var t=Ext.get(e.target);if(t.findParent("div.close",this.container)){this.close();}
var elem=t.findParent('div.tab');if(elem){elem=Ext.get(elem);if(elem.hasClass('spacer'))
return;var clicked_tab=elem.hasClass('overview')?'overview':'configure';if(clicked_tab!==this.selected_tab){this.selected_tab=clicked_tab;this.render();}
return;}
var elem=t.findParent('div.action_button');if(elem){this.update_all_project_nav_bars(elem.getAttribute('action'));}
var elem=t.findParent('div.on_off');if(elem){this.toggle_activation('crew',elem);return;}},on_keydown:function(e){if(e.browserEvent.keyCode==Ext.EventObject.ESC)
this.close();},close:function(){this.destroy();this.fireEvent('close');},request_permissions:function(){var options={url:'/page/permissions_for_entity_type',params:{entity_type:'Booking'},callback:function(options,success,response){if(success){this.booking_permissions=Ext.decode(response.responseText);this.after_permissions_load();}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);options={url:'/page/simple_global_permissions',params:{},callback:function(options,success,response){if(success){this.simple_permissions=Ext.decode(response.responseText);this.after_permissions_load();}else{var sed=SG.server_error({connection_response:response});}},scope:this};conn=new Ext.data.Connection();conn.request(options);},after_permissions_load:function(){if(this.current_tab=="configure"&&this.simple_permissions&&this.booking_permissions){this.render();}},render_permission_groups_for_rule_type:function(rule_type){if(!this.simple_permissions)
return'<div>Not loaded yet.</div>';if(this.simple_rule_type_index[rule_type]===undefined){var set=this.simple_permissions[0];for(var i=0;i<set.permissions.length;i++){if(set.permissions[i].rule_type==rule_type){this.simple_rule_type_index[rule_type]=i;break;}}}
var html=[];for(var i=0;i<this.simple_permissions.length;i++){var checkbox_id=rule_type+'_'+this.simple_permissions[i].set_id;var attributes=this.templates.checkbox_attributes.apply({rule_set_code:this.simple_permissions[i].code,rule_type:rule_type});var allow=this.simple_permissions[i].permissions[this.simple_rule_type_index[rule_type]].allow;html.push(this.templates.permission_row.apply({permission_set_name:this.simple_permissions[i].display_name,checkbox:SG.Checkbox.render(checkbox_id,'manage_crew_planning_cb',allow?'checked':'unchecked',false,null,attributes),checkbox_id:checkbox_id}));}
return html.join('');},render_full_app_permissions:function(){return this.render_permission_groups_for_rule_type('see_full_crew_app_menu_item');},render_project_brick_permissions:function(){return this.render_permission_groups_for_rule_type('see_project_bar_crew_app_brick');},render_booking_edit_permissions:function(){if(!this.booking_permissions)
return'<div>Not loaded yet.</div>';var html=[];for(var i=0;i<this.booking_permissions.length;i++){var checkbox_id='create_'+this.booking_permissions[i].set_id;var attributes=this.templates.checkbox_attributes.apply({rule_set_code:this.booking_permissions[i].code,rule_type:'create'});var allow=this.booking_permissions[i].create;html.push(this.templates.permission_row.apply({permission_set_name:this.booking_permissions[i].display_name,checkbox:SG.Checkbox.render(checkbox_id,'manage_crew_planning_cb',allow?'checked':'unchecked',false,null,attributes)}));}
return html.join('');},on_checkbox_change:function(checkbox){if(checkbox.className.indexOf('manage_crew_planning_cb')==-1)
return;SG.Checkbox.disable(checkbox);var rule_type=checkbox.getAttribute('rule_type');var allow=(SG.Checkbox.get_state(checkbox)=='checked');var rule_changes=[{permission_rule_set_code:checkbox.getAttribute('rule_set_code'),rule_type:rule_type,allow:allow}];if(rule_type=='create'){rule_changes[0].entity_type='Booking';rule_changes.push({permission_rule_set_code:checkbox.getAttribute('rule_set_code'),rule_type:'retire',entity_type:'Booking',allow:allow});rule_changes.push({permission_rule_set_code:checkbox.getAttribute('rule_set_code'),rule_type:'update_field_generic',entity_type:'Booking',allow:allow});}
options={url:'/page/set_permissions',params:{'permission_changes':JSON.stringify(rule_changes)},callback:function(options,success,response){if(success){var result=Ext.decode(response.responseText);if(result.error_message){SG.server_error({connection_response:result.error_message});this.request_permissions();}else{this.on_rule_updated(rule_changes);}}else{var sed=SG.server_error({connection_response:response});this.request_permissions();}},scope:this};conn=new Ext.data.Connection();conn.request(options);},on_rule_updated:function(rule_changes){for(var i=0;i<rule_changes.length;i++){if(rule_changes[i].rule_type=='see_full_crew_app_menu_item'||rule_changes[i].rule_type=='see_project_bar_crew_app_brick')
{var rule_index=this.simple_rule_type_index[rule_changes[i].rule_type];for(var j=0;j<this.simple_permissions.length;j++){if(this.simple_permissions[j].code==rule_changes[i].permission_rule_set_code){this.simple_permissions[j].permissions[rule_index].allow=rule_changes[i].allow;break;}}}
else if(rule_changes[i].rule_type=='create'){for(var j=0;j<this.booking_permissions.length;j++){if(this.booking_permissions[j].code==rule_changes[i].permission_rule_set_code){this.booking_permissions[j].create=rule_changes[i].allow;break;}}}}
this.render();},update_all_project_nav_bars:function(action){this.show_loading_overlay();this.pending_project_nav_bar_action=action;if(!this.entity_field_pref_ds){this.entity_field_pref_ds=this.new_data_set('EntityFieldPref',this.on_load_entity_field_prefs,this.on_entity_field_prefs_ds_change);}
var spec={type:'EntityFieldPref',filters:{logical_operator:'and',conditions:[{path:'pref_type',relation:'is',values:['nav_bar']},{path:'entity_type',relation:'is',values:['Project']}]},columns:['settings','settings_serialized'],result:this.entity_field_pref_ds};SG.Repo.query(spec);},on_load_entity_field_prefs:function(ds){var rec,settings,updated=false;for(var i=0;i<ds.records.length;i++){rec=ds.records[i];settings=sg_deep_copy(rec.get('settings_serialized'));var index=-1;for(var j=0;j<settings.length&&index==-1;j++){if(settings[j].app_name=='resource_planning_app')
index=j;}
if(index>-1&&this.pending_project_nav_bar_action=='remove'){settings.splice(index,1);rec.set('settings_serialized',settings);updated=true;}else if(index==-1&&this.pending_project_nav_bar_action=='add'){settings=settings.concat([{"app_name":"resource_planning_app","display_name":"Crew"}]);rec.set('settings_serialized',settings);updated=true;}}
if(updated){ds.commit(true);}else{this.hide_loading_overlay();}},on_entity_field_prefs_ds_change:function(changes){var real_change=false;for(var i=0;i<changes.length;i++){if(!(changes[i].type=='update'&&changes[i].state=='pending'))
real_change=true;}
if(real_change)
this.hide_loading_overlay();},toggle_activation:function(app_code,on_off_elem){if(app_code!='crew')
return;this.show_loading_overlay();var new_val=!SG.globals.preferences.crew_planning_app_active;on_off_elem=Ext.get(on_off_elem);on_off_elem.removeClass('off');on_off_elem.removeClass('on');on_off_elem.addClass(new_val?'on':'off');var prefs_hash={pref_type:'site',crew_planning_app_active:new_val?'yes':'no'}
var options={url:'/preferences/update_prefs',params:prefs_hash,callback:function(options,success,response){if(success){var response_obj=response.responseText.strip();if(response_obj.length>0){response_obj=Ext.decode(response_obj);if(response_obj.error){this.feedback=response_obj.error;this.reload_prefs();SG.server_error({html_msg:response_obj.error,connection_response:response});return;}
var job=response_obj;var pi=new SG.ProgressIndicator(null,'det','Updating...');if(pi.add_job(job)===false){this.update_failed(response);}else{this.hide_loading_overlay();pi.show();var me=this;pi.set_post_completion(job,function(){me.update_successful();});pi.start_updates(null,true,response);}}else{this.update_successful();}}
else
this.update_failed(response);},scope:this};var conn=new Ext.data.Connection();conn.request(options);},update_successful:function(){this.reload_prefs();},update_failed:function(response){this.reload_prefs();SG.server_error({connection_response:response});},reload_prefs:function(){var options={url:'/preferences/get_prefs',params:{},callback:function(options,success,response){if(success)
this.load_prefs(response.responseText);else
SG.server_error({connection_response:response});},scope:this};var conn=new Ext.data.Connection();conn.request(options);},load_prefs:function(data_json)
{this.hide_loading_overlay();var prefs=Ext.decode(data_json).prefs;SG.globals.preferences.crew_planning_app_active=prefs.crew_planning_app_active.value=='yes'?true:false;this.render();}});SG.NotesApp={show:function(config)
{if(SG.globals.page&&SG.Page.unsaved_data.has_unsaved_data())
return;if(SG.globals.page&&SG.globals.page.root_widget)
SG.globals.page.root_widget.show_loading_overlay();SG.Message.show({html:'<b>Launching the Review Notes App...</b>'});window.location='/page/notes_app?playlist_id='+config.playlist_id;}}
SG.Widget.NotesApp=function(context,widget_spec,id)
{SG.Widget.NotesApp.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NotesApp,SG.Widget.Base,{default_settings:{sorts:[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}],version_fields:[],},templates:{loading:'<div>Loading...</div>',main:'<div id="sgw_notes_app" class="hide_warning">{title}'+'<div id="other_user_updates"></div>'+'<div id="top_line">'+'<div class="right_floater">'+'<button id="publish_drafts">Preview and Publish</button>'+'<div id="refresh" class="refresh_normal refresh_button inline_icon"></div>'+'<div id="action_menu" class="gear_menu_nobg inline_icon"></div>'+'</div>'+'<button id="add_version">+ Add Version</button>'+'<button id="remove_versions"><div class="trash inline_icon"></div> Remove</button>'+'<span id="sort_versions">{sort} '+'<div class="dropdown_arrow_small inline_icon"></div></span>'+'<span id="version_fields">Fields'+'<div class="dropdown_arrow_small inline_icon"></div></span>'+'</div>'+'<div id="sgw_notes_app_left_pane" style="width: {divider_position}px;">'+'<div id="sgc_notes_app_drafts"></div>'+'</div>'+'<div id="sgw_notes_app_divider" style="left: {divider_position}px;"></div>'+'<div id="sgw_notes_app_right_pane" style="left: {right_pane_left}px;">'+'<div id="sgc_notes_app_version_pane"></div>'+'</div>'+'<div id="sgw_notes_app_footer">'+'<div class="version_count"></div>'+'<div class="icon_info_dark"></div>'+'<div class="keyboard_shortcuts">Keyboard shortcuts</div>'+'</div>'+'</div>',main_no_body:'<div id="sgw_notes_app" class="hide_warning">{title}</div>',title:'<div id="title"><div class="logo"></div><div class="app_logo"></div>'+'<div class="app_title">Review Notes</div>'+'<div class="project">{project_name}</div><div class="divider {hide_divider}">|</div>'+'<div class="playlist"><a class="playlist_detail_link" href="{playlist_detail_url}">'+'{playlist_name}</a></div><input type="button" class="open_playlist" value="Open" />'+'<input type="button" class="new_playlist" value="New" /></div>',no_sort:'Sort by',sort:'Sort by {name} <div class="inline_icon icon_arrow_thin_{direction}"></div>',other_user_updates_warning:'Warning, this playlist is also being edited by: {other_user_names}.'+'<span class="fake_link other_user_updates_warning_details">Show Details</span>'+'<div class="other_user_updates_close_x close_overlay_x"></div>',empty_right_pane:'<div class="empty_right_pane">{message}</div>',keyboard_help_dialog:'<div class="header">Review Notes Keyboard shortcuts ({platform})'+'<div class="keyboard_shortcut_close">'+'<span class="keyboard_shortcut_close">Close</span> (esc)</div></div>'+'<div class="main">{shortcuts}</div>',keyboard_shortcut:'<table><tr><td class="shortcut"><div class="shortcut">{key}</div></td>'+'<td class="description"><div class="description">{description}</div></td></tr></table>',layout_row:'<div class="layout_row" page_id="{page_id}"><table><tr><td class="input">'+'<input type="text" name="layout_name" value="{name}"></td><td class="trash">'+'<div class="trash"></div></td></tr></table></div>',},divider_stowed:false,divider_position:600,divider_width:9,playlist_change_scan_interval:30000,init_widget:function(){this.playlist=this.context.get('playlist');if(!this.playlist){this.show_playlist_overlay();return;}
this.version_data_set=this.new_data_set('Version',this.on_version_load);this.orphan_version_data_set=this.new_data_set('Version',this.on_orphan_version_load);this.draft_data_set=this.new_data_set('Note',this.on_draft_load,this.on_draft_data_set_change);this.draft_data_set.drafts=true;this.event_data_set=this.new_data_set('EventLogEntry',this.on_event_load);document.title="Review Notes: "+this.playlist.name;this.set_selected_version_pane_page_id();Ext.EventManager.onWindowResize(this.on_window_resize,this);this.playlist_change_request_count=0;this.playlist_change_load_count=0;SG.Page.unsaved_data.add(this);},has_unsaved_data:function(){return SG.CellManager.globally_any_error_cells();},set_selected_version_pane_page_id:function(){var record=null;var url_layout_name=this.get_layout_name_from_url();if(url_layout_name!=""){for(var i=0;i<SG.globals.note_app_layout_pages.count();i++){var r=SG.globals.note_app_layout_pages.get_record(i);if(r.get('name')==url_layout_name){record=r;break;}}}
var cookie=cookie=getCookie('sg_note_app_version_pane_page_id');if(!record&&cookie){record=SG.globals.note_app_layout_pages.get_record_by_id(cookie);}
if(!record)
record=SG.globals.note_app_layout_pages.get_record(0);this.selected_version_pane_page_id=record.id;setCookie('sg_note_app_version_pane_page_id',record.id);this.set_layout_name_url(record.get('name'));},get_layout_name_from_url:function(){var layout_name=location.href.split("#")[1]||"";return layout_name;},set_layout_name_url:function(layout_name){location.hash='#'+layout_name;},init_children:function(){},on_first_render:function()
{if(!this.playlist)return;this.drafts_component=new SG.NotesApp.Drafts({widget:this,playlist:this.playlist,version_data_set:this.version_data_set,draft_data_set:this.draft_data_set,width:this.divider_position,version_fields:this.get('version_fields')});this.add_event(this.get_container(),'click',this.on_click,this);var doc=Ext.get(document);this.add_event(doc,'keydown',this.on_keydown);},render_widget:function()
{if(!this.playlist){var title=this.templates.title.apply({playlist_detail_url:'',playlist_name:'',project_name:'',hide_divider:'hide'});var html=this.templates.main_no_body.apply({title:title});var container=this.get_container();container.update(html);this.add_event(container,'click',this.on_click,this);this.make_open_playlist_button_active();return;}
var playlist_detail_url=window.location.protocol+'//'+window.location.host+'/detail/Playlist/'+
this.playlist.id;if(!this.version_data_set.loaded)
{var project=this.context.get('entity_project');var title=this.templates.title.apply({playlist_detail_url:playlist_detail_url,playlist_name:this.playlist.name,project_name:project.name});this.get_container().update(this.templates.main.apply({divider_position:this.divider_position,right_pane_left:(this.divider_position+this.divider_width),sort:this.render_sorts(),title:title}));this.fetch_data();return;}
var project=this.context.get('entity_project');var title=this.templates.title.apply({playlist_detail_url:playlist_detail_url,playlist_name:this.playlist.name,project_name:project.name});this.get_container().update(this.templates.main.apply({divider_position:this.divider_position,right_pane_left:(this.divider_position+this.divider_width),sort:this.render_sorts(),save_button_text:'Saved',save_button_disabled:'sg_disabled',title:title}));this.drafts_component.render();this.hide_loading_overlay();this.left_pane=this.get_container().child("div#sgw_notes_app_left_pane");this.right_pane=this.get_container().child("div#sgw_notes_app_right_pane");this.drag_div=this.get_container().child("div#sgw_notes_app_divider");this.drag_zone=new SG.NotesApp.DividerDragZone(this.drag_div,this);this.add_event(this.drag_div,"dblclick",this.on_divider_double_click);if(!this.timers_started)
{this.timers_started=true;this.start_timers();}
var me=this;setTimeout(function(){me.update_footer();me.refresh_version_pane();},0);},render_sorts:function()
{var sorts=this.get_sorts();if(sorts.length==0)
return this.templates.no_sort.apply({});var name;if(sorts.length==1&&sorts[0].column=='playlists.PlaylistVersionConnection.sg_sort_order')
name='Custom Order';else
name=SG.schema.get_field('Version',sorts[0].column).display_name;return this.templates.sort.apply({name:name,direction:sorts[0].direction=='asc'?'down':'up'});},start_timers:function()
{var me=this;setTimeout(function(){me.scan_for_playlist_changes();},this.playlist_change_scan_interval);},is_shared_header_rec:function(rec)
{return(rec.get("content")=="__SHARED_HEADERS_DRAFT__");},fetch_data:function()
{this.show_loading_overlay();SG.Repo.start_batch();if(!this.event_data_set.loaded)
interval_seconds=60*60*2;else
interval_seconds=(this.playlist_change_scan_interval+1000)/1000;this.fetch_other_user_playlist_changes(interval_seconds);var filters={logical_operator:'and',conditions:[{path:'playlists',relation:'is',values:[this.playlist]}]};var spec={type:'Version',filters:filters,columns:this.get_version_field_names(),sorts:this.get_sorts(),result:this.version_data_set,parent_entity:this.playlist};SG.Repo.query(spec);filters={logical_operator:'and',conditions:[{path:'playlist',relation:'is',values:[this.playlist]}]};spec={type:'Note',filters:filters,columns:SG.schema.entity_types.Note.fields_sorted_by_display_name,result:this.draft_data_set};SG.Repo.query(spec);this.versions_loaded=false;this.drafts_loaded=false;this.loading_versions_only=false;SG.Repo.end_batch();},load_versions_only:function()
{var filters={logical_operator:'and',conditions:[{path:'playlists',relation:'is',values:[this.playlist]}]};var spec={type:'Version',filters:filters,columns:this.get_version_field_names(),sorts:this.get_sorts(),result:this.version_data_set,parent_entity:this.playlist};SG.Repo.query(spec);this.versions_loaded=false;this.loading_versions_only=true;},load_orphan_versions_only:function(orphaned_version_ids)
{var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:orphaned_version_ids}]};var spec={type:'Version',filters:filters,columns:this.get_version_field_names(),sorts:this.get_sorts(),result:this.orphan_version_data_set,parent_entity:this.playlist};SG.Repo.query(spec);this.versions_loaded=false;this.loading_versions_only=true;},scan_for_playlist_changes:function()
{var me=this;setTimeout(function(){me.scan_for_playlist_changes();},this.playlist_change_scan_interval);var seconds=(this.playlist_change_scan_interval+1000)/1000;var dialog=sg_find('div.sgd_server_error_dialog');if(dialog){dialog=Ext.get(dialog);if(dialog.isVisible()){return;}}
if(this.playlist_change_request_count!=this.playlist_change_load_count)
return;this.fetch_other_user_playlist_changes(seconds);},fetch_other_user_playlist_changes:function(interval_seconds)
{filters={logical_operator:'and',conditions:[SG.NotesApp.PlaylistHistory.get_filters(this.playlist),{path:'user',relation:'is_not',values:[SG.globals.current_user.entity_hash]},{path:'created_at',relation:'in_last',values:[interval_seconds,'SECOND']}]};spec={type:'EventLogEntry',filters:filters,columns:['entity','created_at','user','description','event_type','attribute_name','user.HumanUser.image','meta'],sorts:[{column:'created_at',direction:'desc'}],result:this.event_data_set};SG.Repo.query(spec);this.playlist_change_request_count++;},on_version_load:function()
{this.versions_loaded=true;this.version_data_set.fast_removed=[];if(this.drafts_loaded||this.loading_versions_only)
this.on_all_loaded();},on_orphan_version_load:function()
{this.drafts_component.spot_rerender_version_data(this.orphan_version_data_set);},on_draft_load:function()
{this.drafts_loaded=true;if(this.versions_loaded)
this.on_all_loaded();},on_all_loaded:function()
{if(this.loading_versions_only)
this.drafts_component.spot_rerender_version_data(this.version_data_set);else
this.render();},on_event_load:function()
{this.playlist_change_load_count++;if(this.event_data_set.count()>0)
this.other_user_updates_warning=true;var me=this;setTimeout(function(){me.update_other_user_updates_warning();},1000);},update_other_user_updates_warning:function()
{var container=Ext.get(sg_find("div#sgw_notes_app"));var other_user_updates_div=container.child("div#other_user_updates");if(this.event_data_set.count()>0)
{this.other_user_names=[];var name;for(var i=0;i<this.event_data_set.records.length;i++)
{name=this.event_data_set.records[i].get('user').name;if(this.other_user_names.indexOf(name)==-1)
this.other_user_names.push(name);}}
if(this.other_user_updates_warning)
{other_user_updates_div.dom.innerHTML=this.templates.other_user_updates_warning.apply({other_user_names:this.other_user_names.join(', '),});container.removeClass("hide_warning");}
else
{container.addClass("hide_warning");other_user_updates_div.dom.innerHTML='';}},get_version_field_names:function()
{var fields=['code','image','entity','project','sg_task','user','sg_department_link','playlists.PlaylistVersionConnection.sg_sort_order','sg_uploaded_movie'];if(SG.globals.custom_for=="drd")
fields.push('sg_tasks');var version_fields=this.get('version_fields');for(var i=0;i<version_fields.length;i++){var col=version_fields[i];if(fields.indexOf(col)==-1)
fields.push(col);}
return fields;},on_draft_data_set_change:function(changes)
{var data_saved=false;var record_deleted=false;var record_error=false;var created_records=[];for(var i=0;i<changes.length;i++)
{if(changes[i].type=='update'&&changes[i].state=='pending')
{if(this.update_error){record_error=true;}}
else if(changes[i].type=='create')
{data_saved=true;created_records.push(changes[i].record);this.hide_loading_overlay();}
else if(changes[i].type=='create_failed')
{record_error=true;this.hide_loading_overlay();}
else if(changes[i].type=='update'&&changes[i].state=='server')
{if(changes[i].record.get_error(changes[i].column)){record_error=true;}else{data_saved=true;}}
else if(changes[i].type=='retire')
{record_deleted=true;}}
this.update_error=record_error;if(created_records.length>0)
this.drafts_component.update_rendered_record_ids(created_records);if(created_records.length==1)
this.drafts_component.edit_draft(created_records[0].id);},on_click:function(e)
{var t=Ext.get(e.getTarget());this.drafts_component_has_focus=t.findParent('#sgc_notes_app_drafts',20);if(t.hasClass('playlist_detail_link')&&!is_ctrl_click(e)){e.stopEvent();setTimeout(function(){document.location=t.dom.getAttribute('href');},200);}
if(t.id=='publish_drafts'&&t.dom.parentNode.className.indexOf('tools_disabled')==-1)
{this.prepare_to_publish();return;}
if(t.id=='action_menu')
{if(this.action_menu&&this.action_menu.is_showing())
{this.action_menu.destroy();this.action_menu=null;}
else
this.show_action_menu(t);return;}
var container=this.get_container();var sort_versions=t.findParent('span#sort_versions',container);if(sort_versions)
{if(this.sort_menu&&this.sort_menu.showing)
this.sort_menu.hide();else
this.show_sort_menu(sort_versions);return;}
var version_fields=t.findParent('span#version_fields',container,true);if(version_fields){this.show_version_fields_menu(version_fields);return;}
if(t.id=='add_version')
{this.add_version();return;}
var remove_versions=t.findParent('#remove_versions',container);if(remove_versions){this.unlink_selected_versions();}
if(t.id=='refresh'&&!t.dom.hasAttribute('disabled'))
{this.refresh();return;}
if(t.hasClass('close_overlay_x'))
{this.other_user_updates_warning=false;this.update_other_user_updates_warning();return;}
if(t.hasClass('other_user_updates_warning_details'))
{this.show_history();return;}
if(t.hasClass('icon_info_dark'))
{this.on_divider_double_click();return;}
if(t.hasClass('keyboard_shortcuts'))
{this.display_keyboard_shortcut_help();return;}
if(t.hasClass('open_playlist')){this.show_playlist_overlay();return;}
if(t.hasClass('new_playlist')){this.hide_playlist_overlay();this.show_new_playlist_dialog();return;}
if(t.hasClass('logo')){this.show_loading_overlay();window.location='/user/home';return;}},show_new_playlist_dialog:function(){var entity_type='Playlist';var factory_context={entity_type:entity_type,data_record:new SG.Data.Record(entity_type)};var factory=new SG.EntityFactory(factory_context);factory.on("done",function(record){var nef_config={entity_type:entity_type,single_project:this.single_project_from_context(),all_projects:this.context_projects(),source_record:record,hide_creation_banner:true,ignore_unsaved_data:true};var nef=sg_new_entity_dialog(nef_config);nef.on('entity_created',this.on_new_playlist,this);},this);factory.create();},on_new_playlist:function(recs){this.on_playlist_picked(recs[0]);},show_version_fields_menu:function(anchor_elem){if(!this.version_fields_menu){this.version_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_version_fields_menu,scope:this},});this.version_fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return field_schema.data_type=='image';},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get('version_fields');return cols.indexOf(field_name)>-1;},scope:this},on_field:{fn:this.toggle_version_field,scope:this}});}
this.version_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.version_fields_menu.show();},on_before_show_version_fields_menu:function(menu){menu.items=this.version_fields_menu_helper.get_menu_items();menu.render();},toggle_version_field:function(menu,item){this.toggle_version_checked=item.checked;this.toggle_version_field_todo=item.field;this.toggle_version_field_for_real();},toggle_version_field_for_real:function(){var cols=sg_deep_copy(this.get('version_fields'));if(this.toggle_version_checked){var idx=cols.indexOf(this.toggle_version_field_todo);cols.splice(idx,1);}else{cols.push(this.toggle_version_field_todo);}
this.set('version_fields',cols);this.drafts_component.version_fields=cols;this.fetch_data();this.toggle_version_field_todo=undefined;this.toggle_version_checked=undefined;},add_version:function()
{var left_pane=this.get_container().child('div#sgw_notes_app_left_pane');var add_version_button=sg_find('button#add_version',this.get_container().dom);new SG.QuickLink({widget:this,entity_type:'Version',parent_entity:this.playlist,link_field_to_parent:'playlists',on_link:{fn:this.on_version_linked_to_playlist,scope:this},on_multi_link:{fn:this.on_multiple_versions_linked_to_playlist,scope:this},reset_after_linking:true,overlay_container:left_pane,align_to:{dom_elem:add_version_button,elem_anchor:"bl",dialog_anchor:"tl"},on_link_no_undo:true}).show();return;},on_multiple_versions_linked_to_playlist:function()
{this.refresh();},on_version_linked_to_playlist:function(entity_hash)
{var removed_index=this.version_data_set.fast_removed.indexOf(entity_hash.id);if(removed_index>-1)
{this.version_data_set.fast_removed.splice(removed_index,1);}
var version_rec=this.version_data_set.get_record_by_id(entity_hash.id);if(version_rec)
{this.version_data_set.remove(version_rec);}
else
{version_rec=this.version_data_set.new_record(entity_hash.id);version_rec.set('code',entity_hash.name);if(entity_hash.project_id){version_rec.set('project',SG.schema.project_by_id(entity_hash.project_id));}
version_rec.state='clean';this.version_data_set.remove(version_rec);}
var inserted=false;var selected=false;for(var i=0;i<this.version_data_set.records.length&&!inserted;i++)
{var rec=this.version_data_set.get_record(i);if(this.drafts_component.is_selected(rec.id))
{selected=true;}
else if(selected)
{this.version_data_set.insert_record(version_rec,i);inserted=true;}
else
{selected=false;}}
if(!inserted)
{this.version_data_set.append_record(version_rec);}
for(var i=0;i<this.version_data_set.records.length;i++)
{var rec=this.version_data_set.get_record(i);rec.set('playlists.PlaylistVersionConnection.sg_sort_order',i+1);}
this.version_data_set.commit(true);this.set_sorts([{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}],true);this.drafts_component.render();this.load_versions_only();this.update_footer();},version_selection_changed:function(version_ids)
{if(version_ids.length==0)
{this.selected_version_id=null;var container=this.get_container();var version_pane_div=container.child('#sgc_notes_app_version_pane');version_pane_div.update(this.templates.empty_right_pane.apply({message:'No Versions selected'}));}
else if(version_ids.length==1)
{if(this.selected_version_id!=version_ids[0])
{this.selected_version_id=version_ids[0];this.refresh_version_pane();}}
else
{this.selected_version_id=null;var container=this.get_container();var version_pane_div=container.child('#sgc_notes_app_version_pane');version_pane_div.update(this.templates.empty_right_pane.apply({message:version_ids.length+' Versions Selected'}));}},refresh_version_pane:function()
{if(!this.selected_version_id)
return;var version_rec=this.version_data_set.get_record_by_id(this.selected_version_id);if(!version_rec)
return;if(this.divider_position>=this.get_divider_rightmost_position())
{this.version_pane_is_stale=true;return;}
this.version_pane_is_stale=false;if(!this.version_pane_component)
{this.version_pane_component=new SG.NotesApp.VersionPane({widget:this,playlist:this.playlist,layout_id:this.selected_version_pane_page_id,});}
this.version_pane_component.version_id=version_rec.id;this.version_pane_component.project=version_rec.get('project');this.version_pane_component.version_linked_entity=version_rec.get('entity');this.version_pane_component.load();},update_footer:function()
{var footer_count_elem=sg_find('div#sgw_notes_app_footer > div.version_count',this.get_container().dom);var version_count=0;for(var i=0;i<this.version_data_set.records.length;i++)
{var version=this.version_data_set.records[i];if(version.state!='retired'&&this.version_data_set.fast_removed.indexOf(version.id)==-1)
version_count++;}
var version_type_name=(version_count==1)?SG.schema.entity_types.Version.display_name:SG.schema.entity_types.Version.display_name_pluralized;footer_count_elem.innerHTML=version_count+" "+version_type_name;},refresh:function(){this.fetch_data();},prepare_to_publish:function()
{if(SG.CellManager.globally_any_error_cells()){SG.server_error({html_msg:'Page contains errors'});return;}
this.show_loading_overlay();this.drafts_component.set_custom_sort_order_on_versions();var me=this;setTimeout(function(){me.go_to_preview_and_publish();},200);},draft_data_set_has_negative_ids:function(){for(var i=0;i<this.draft_data_set.count();i++){var r=this.draft_data_set.get_record(i);if(Number(r.id)<0){return true;}}
return false;},has_content:function(rec)
{return(rec.get('content')&&rec.get('content').strip());},go_to_preview_and_publish:function()
{var url='/page/notes_app?playlist_id='+this.playlist.id+'&publish=true';var url_layout_name=this.get_layout_name_from_url();if(url_layout_name!="")
url+='#'+url_layout_name;window.location=url;},reset_divider_position:function()
{this.left_pane.setWidth(this.divider_position);this.drag_div.setLeft(this.divider_position);this.right_pane.setLeft(this.divider_position+this.divider_width);this.drag_div.dom.style.top=null;if(SG.globals.version_pane_header_widget&&this.divider_position==this.get_divider_rightmost_position())
{SG.globals.version_pane_header_widget.hide_version_widget_loading_overlay();}
if(this.version_pane_is_stale)
this.refresh_version_pane();},on_divider_moved:function()
{this.saved_divider_position=null;this.divider_stowed=false;var new_divider_position=this.drag_div.getLeft(true);var rightmost_position=this.get_divider_rightmost_position();if(new_divider_position>rightmost_position)
this.divider_position=rightmost_position;else
this.divider_position=new_divider_position;this.reset_divider_position();SG.NotificationCenter.post({uuid:'_sg_sidenav_',name:'sidenav_changed',args:null,canvas_id:null});},on_divider_double_click:function()
{if(this.saved_divider_position)
{this.divider_position=this.saved_divider_position;this.saved_divider_position=null;this.divider_stowed=false;}
else
{this.saved_divider_position=this.divider_position;this.divider_position=this.get_divider_rightmost_position();this.divider_stowed=true;}
this.reset_divider_position();},get_divider_rightmost_position:function()
{var container_width=this.get_container().getWidth();return(container_width-this.divider_width)},show_sort_menu:function(sort_dom)
{if(this.sort_menu)
this.sort_menu.destroy();var sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'Version',no_advanced:true,get_sorts_callback:{fn:this.get_sorts,scope:this},set_sorts_callback:{fn:this.set_sorts,scope:this}});this.sort_menu=this.new_component(SG.Menu,{position:{dom_elem:sort_dom,elem_anchor:'bl',menu_anchor:'tl'},items:sorting_menu_helper.get_menu_items()});this.sort_menu.render();this.sort_menu.show();},get_sorts:function()
{var sorts=this.get('sorts');return sorts;},set_sorts:function(new_sorts,custom_sort)
{if(new_sorts.length==0)
this.set('sorts',[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}]);else
this.set('sorts',new_sorts);if(!custom_sort){this.fetch_data();}
if(this.sort_menu)
this.sort_menu.destroy();this.sort_menu=null;if(custom_sort)
{var sort_span=this.get_container().child("span#sort_versions");sort_span.update(this.render_sorts());}},show_action_menu:function(button_ext_elem)
{if(this.action_menu)
this.action_menu.destroy();var items=[];var version_pane_not_loaded=!(this.version_pane_component&&this.version_pane_component.page)||!this.selected_version_id;var version_pane_page_id=null;if(this.version_pane_component&&this.version_pane_component.page)
version_pane_page_id=this.version_pane_component.page.id;items.push({html:'Select All',value:'select_all'});items.push({html:'Remove Selected Versions',value:'remove_selected_versions',disabled:(!this.drafts_component.selected_versions||this.drafts_component.selected_versions.length==0)});items.push({line:true});var sub_items=[];sub_items.push({heading:'SAVED LAYOUTS'});var records=this.get_sorted_note_app_layout_pages();for(var i=0;i<records.length;i++){var record=records[i];sub_items.push({html:record.get('name'),page_id:record.id,checked:record.id==version_pane_page_id,item_selected:{fn:this.change_layout,scope:this},disabled:version_pane_not_loaded});}
sub_items.push({line:true});sub_items.push({html:'Edit List...',icon_name:'icon_edit',item_selected:{fn:this.edit_layout_list,scope:this},});sub_items.push({html:'Revert Layout',value:'revert_layout_to_global_default',disabled:version_pane_not_loaded||!(this.version_pane_component&&this.version_pane_component.page.revertable_now()),item_selected:{fn:this.revert_current_layout,scope:this},icon_name:'icon_revert',});sub_items.push({html:'Save Changes to Current Layout',icon_name:'icon_save',item_selected:{fn:this.save_current_layout,scope:this},disabled:version_pane_not_loaded||!(this.version_pane_component&&this.version_pane_component.page.revertable_now()),});sub_items.push({html:'Save As New Layout...',item_selected:{fn:this.save_as_new_layout,scope:this},disabled:version_pane_not_loaded,icon_name:'icon_plus'});items.push({html:'Right Pane Layout',submenu:{items:sub_items}});items.push({line:true});items.push({html:'Show Page History...',value:'history',disabled:!SG.schema.can_see_entity_type('EventLogEntry')});if(SG.globals.preferences.enable_cinesync_online_integration){items.push({html:'Open in cineSync Online...',value:'create_cinesync_online_session'});}
this.action_menu=this.new_component(SG.Menu,{position:{dom_elem:button_ext_elem.dom,elem_anchor:'br',menu_anchor:'tr'},items:items,item_selected:{fn:this.action_menu_item_selected,scope:this}});for(var i=0;i<SG.globals.action_menu_items.length;i++)
{item=SG.globals.action_menu_items[i];if(item.entity_type=='Playlist')
{this.action_menu.items.push({html:item.title,url:item.url,order:item.order||1,item_selected:{fn:this.on_custom_external_action,scope:this}});}}
this.action_menu.render();this.action_menu.show();},edit_layout_list:function(menu,item){var body_html='';var records=this.get_sorted_note_app_layout_pages();for(var i=0;i<records.length;i++){var rec=records[i];body_html+=this.templates.layout_row.apply({page_id:rec.id,name:rec.get('name'),});}
var dialog=new SG.NewDialog({title:"Edit List",css_class:'sg_notes_app_edit_layouts_dialog',body:body_html,actions:[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Save',dont_close:true,callback:{fn:this.edit_layouts,scope:this},key_code:Ext.EventObject.RETURN}],dialog_click:{fn:this.on_edit_layout_list_dialog_click,scope:this}});},on_edit_layout_list_dialog_click:function(dialog,e){var target=Ext.get(e.target);var trash=target.findParent('div.trash',dialog.container.dom,true);if(trash){var layout_rows=sg_find_all('div.layout_row',dialog.container.dom)
if(layout_rows.length==1){alert('You must have at least one layout.');return;}
var layout_row=trash.findParent('div.layout_row',dialog.container.dom,true);layout_row.remove();}},edit_layouts:function(dialog){var retired_ids=[];var changed_recs=[];var layout_names=[];for(var i=0;i<SG.globals.note_app_layout_pages.count();i++){var rec=SG.globals.note_app_layout_pages.get_record(i);var row=dialog.container.child('div.layout_row[page_id="'+rec.id+'"]');if(!row){rec.retire();changed_recs.push(rec);retired_ids.push(rec.id);}else{var input=row.child('input');var input_value=input.dom.value;var layout_name=input_value.replace(/^\s+|\s+$/g,"");if(layout_names.indexOf(layout_name)!=-1){var msg='Oops. Looks like you have more than one layout named "'+layout_name+'". Layout names must all be unique.';alert(msg);return;}
layout_names.push(layout_name);if(rec.get('name')!=layout_name){rec.set('name',layout_name);changed_recs.push(rec)}}}
if(changed_recs.length>0){SG.Repo.start_batch();for(var i=0;i<changed_recs.length;i++)
changed_recs[i].commit(true);SG.Repo.end_batch();}
dialog.destroy();if(retired_ids.indexOf(this.selected_version_pane_page_id)!=-1){for(var i=0;i<SG.globals.note_app_layout_pages.count();i++){var rec=SG.globals.note_app_layout_pages.get_record(i);if(rec.state=='retired')continue;if(retired_ids.indexOf(rec.id)==-1){this.set_version_pane_page_id(rec.id);return;}}}},get_sorted_note_app_layout_pages:function(){var recs=[];for(var i=0;i<SG.globals.note_app_layout_pages.count();i++){var rec=SG.globals.note_app_layout_pages.get_record(i);if(rec.state=='retired')continue;recs.push(rec);}
recs.sort(function(a,b){var aa=a.get('name');var bb=b.get('name');if(!aa)aa='';if(!bb)bb='';return aa.localeCompare(bb);});return recs;},save_current_layout:function(menu,item){this.version_pane_component.page.settings_save('Layout has been saved.');},set_version_pane_page_id:function(new_id){this.selected_version_pane_page_id=new_id;setCookie('sg_note_app_version_pane_page_id',new_id);if(this.version_pane_component){this.version_pane_component.destroy();this.version_pane_component=null;}
this.refresh_version_pane();},save_as_new_layout:function(menu,item){var focus_input=function(dialog){var input=dialog.container.child('input[name=layout_name]');input.focus();};var dialog=new SG.NewDialog({title:"Save Layout",body:'Name: <input type="text" name="layout_name" style="width:323px;">',actions:[{label:'Cancel',type:'link',key_code:Ext.EventObject.ESC},{label:'Save',dont_close:true,callback:{fn:this.create_new_layout,scope:this},key_code:Ext.EventObject.RETURN}],after_render_callback:{fn:focus_input,scope:this}});},create_new_layout:function(dialog){var new_page_name=sg_find("input[name=layout_name]",dialog.container.dom).value;var page=this.version_pane_component.page;if(new_page_name){dialog.destroy();var options={url:SG.globals.urls.page_save_as,params:{id:page.id,user_ps_id:page.user_ps_id,name:new_page_name,page_type:'notes_app_version_pane',settings:Ext.encode(page.spec.to_hash()),ui_category:'app',shared:true},callback:function(options,success,response){if(success){var pattern=/[0-9]+/g;var matches=response.responseText.match(pattern);var page_id=Number(matches[0]);this.reload_globals_note_app_layout_pages(page_id);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);}else{dialog.body='Please enter a layout name!<input type="text" name="layout_name">';dialog.render();}},reload_globals_note_app_layout_pages:function(save_as_page_id){this.save_as_page_id=save_as_page_id;this.show_loading_overlay();if(this.globals_note_app_layout_pages)
this.globals_note_app_layout_pages.destroy();this.globals_note_app_layout_pages=new SG.Data.Set('Page');this.add_event(this.globals_note_app_layout_pages,'load',this.on_load_globals_note_app_layout_pages);var filters={logical_operator:"and",conditions:[{path:"page_type",relation:"is",values:["notes_app_version_pane"]},]};var spec={type:'Page',filters:filters,columns:["id","name"],sorts:[{column:"name",direction:"asc"}],current_page:1,records_per_page:100,result:this.globals_note_app_layout_pages};SG.Repo.query(spec);},on_load_globals_note_app_layout_pages:function(){this.hide_loading_overlay();SG.globals.note_app_layout_pages=this.globals_note_app_layout_pages;this.set_version_pane_page_id(this.save_as_page_id);this.save_as_page_id=null;},change_layout:function(menu,item){if(item.checked){this.revert_current_layout();return;}
this.set_version_pane_page_id(item.page_id);},action_menu_item_selected:function(menu,item)
{if(item.value=='history')
{this.show_history();return;}
else if(item.value=='remove_selected_versions')
{this.unlink_selected_versions();return;}
else if(item.value=='select_all')
{this.drafts_component.select_all();return;}
else if(item.value=='create_cinesync_online_session')
{this.on_menu_cinesync_session();return;}},revert_current_layout:function(menu,item){this.version_pane_component.page.settings_revert({fn:this.on_done_reverting_layout,scope:this});},on_done_reverting_layout:function(){this.refresh_version_pane();},on_custom_external_action:function(menu,item)
{SG.Widget.NotesApp.superclass.on_custom_external_action.call(this,this.playlist,item.url);},on_menu_cinesync_session:function()
{var paths=[];var data_store=this.drafts_component.version_data_set;for(var i=0;i<data_store.count();i++)
{var rec=data_store.get_record(i);paths.push({'name':rec.get('code'),'movie_path':rec.get('sg_uploaded_movie')?rec.get('sg_uploaded_movie').url:"",'thumb_path':"/thumbnail/image/"+rec.get('image')});}
var p=new SG.util.PlayInCineSyncOnline({'versions':paths});},show_history:function()
{new SG.NotesApp.PlaylistHistory({playlist:this.playlist});},unlink_selected_versions:function()
{var selected_versions=this.drafts_component.get_selected_versions();var version_recs=[];for(var i=0;i<selected_versions.length;i++)
{var rec=this.version_data_set.get_record_by_id(selected_versions[i]);if(rec&&rec.state!='retired')
version_recs.push(rec);}
this.drafts_component.unlink_versions(version_recs);},get_summary:null,on_keydown:function(e)
{if(SG.globals.active_editor)return;if(sg_find('div.sgc_review_app_overlay_mask',document.body))return;var key_id=e.getKey();var shift_key=is_shift_click(e);var ctrl_key=is_ctrl_click(e);var alt_key=is_alt_click(e);var in_versions_textarea=false;if(document.activeElement&&document.activeElement.tagName.toLowerCase()=='textarea')
{var parent_elem=Ext.get(document.activeElement.parentNode);if(parent_elem.hasClass('draft_content')||parent_elem.hasClass('sg_cell_textarea'))
in_versions_textarea=true;}
if(!shift_key&&alt_key&&ctrl_key&&(key_id==78||key_id==192))
{this.blur_active_element();this.add_version();e.stopEvent();return;}
if(alt_key&&ctrl_key&&shift_key&&key_id==78)
{this.blur_active_element();this.add_drafts_to_selected_versions();e.stopEvent();return;}
if(ctrl_key&&key_id==73)
{this.on_divider_double_click();e.stopEvent();return;}
if(ctrl_key&&key_id==Ext.EventObject.BACKSPACE)
{var version_div=this.drafts_component.get_last_selected_version_div();var next_id=null;if(version_div&&version_div.nextSibling)
next_id=version_div.nextSibling.getAttribute('record_id');this.unlink_selected_versions();if(next_id!=null)
{var sel='div.version[record_id="'+next_id+'"]';var next_div=sg_find(sel,this.left_pane.dom);next_div=Ext.get(next_div);this.drafts_component.row_drag_reorder.clear_selection();this.drafts_component.row_drag_reorder.select_version_div(next_div);this.drafts_component.scroll_into_view(next_div);}
e.stopEvent();return;}
if(this.drafts_component_has_focus&&!in_versions_textarea&&!ctrl_key&&key_id==Ext.EventObject.UP)
{this.drafts_component.select_previous_version(!shift_key);e.stopEvent();return;}
if(this.drafts_component_has_focus&&!in_versions_textarea&&!ctrl_key&&key_id==Ext.EventObject.DOWN)
{this.drafts_component.select_next_version(!shift_key);e.stopEvent();return;}
if(this.drafts_component_has_focus&&!in_versions_textarea&&ctrl_key&&shift_key&&key_id==Ext.EventObject.UP)
{this.drafts_component.select_first_version();e.stopEvent();return;}
if(this.drafts_component_has_focus&&!in_versions_textarea&&ctrl_key&&shift_key&&key_id==Ext.EventObject.DOWN)
{this.drafts_component.select_last_version();e.stopEvent();return;}
if(in_versions_textarea&&key_id==Ext.EventObject.TAB)
{if(shift_key)
this.drafts_component.select_previous_textarea();else
this.drafts_component.select_next_textarea();e.stopEvent();return;}
if(ctrl_key&&shift_key&&key_id==65)
{this.drafts_component.select_all();e.stopEvent();return;}
if(ctrl_key&&key_id==191)
{this.blur_active_element();this.display_keyboard_shortcut_help();e.stopEvent();return;}
if(key_id==Ext.EventObject.ESC&&this.keyboard_help_container)
this.destroy_keyboard_help_overlay();if(key_id==Ext.EventObject.ESC&&this.playlist_overlay){this.hide_playlist_overlay();this.on_playlist_overlay_canceled();}},blur_active_element:function(){if(document.activeElement)
document.activeElement.blur();},destroy_keyboard_help_overlay:function()
{if(!this.keyboard_help_container)return;this.keyboard_help_container.remove();this.keyboard_help_mask.remove();this.keyboard_help_container=null;this.keyboard_help_mask=null;},display_keyboard_shortcut_help:function()
{if(this.keyboard_help_mask)
{var me=this;setTimeout(function(){me.destroy_keyboard_help_overlay();},0);return;}
var shortcuts=[{key:'<command> alt n',description:"Add new Version",},{key:'<command> alt shift n',description:"Add new Note on selected Version",},{key:'tab',description:"Go to next version and select text area",},{key:'shift tab',description:"Go to previous version and select text area",},{key:'up arrow',description:"Select previous",},{key:'down arrow',description:"Select next",},{key:'shift up arrow',description:"Grow selection upwards",},{key:'shift down arrow',description:"Grow selection downwards",},{key:'<command> shift up arrow',description:"Go to top of the list",},{key:'<command> shift down arrow',description:"Go to bottom of the list",},{key:'<command> shift a',description:"Select all",},{key:'<command> delete',description:"Remove selected Versions",},{key:'<command> i',description:"Toggle right pane",},{key:'<command> /',description:"Open shortcut legend",},];var dh=Ext.DomHelper;this.keyboard_help_mask=dh.append(document.body,{tag:'div',cls:'sg_dialog_mask'},true);this.keyboard_help_container=dh.append(this.keyboard_help_mask,{tag:'div',cls:'sg_dialog sgc_notes_app_keyboard_help'},true);var shortcuts_html='';for(var i=0;i<shortcuts.length;i++)
{var shortcut=shortcuts[i];shortcuts_html+=this.templates.keyboard_shortcut.apply({key:this.process_shortcut(shortcut.key),description:shortcut.description});}
var platform=Ext.isMac?'Mac':Ext.isLinux?'Linux':'PC';this.keyboard_help_container.update(this.templates.keyboard_help_dialog.apply({shortcuts:shortcuts_html,platform:platform,}));this.keyboard_help_container.setXY(this.keyboard_help_container.getCenterXY());var me=this;this.add_event(this.keyboard_help_container,'click',function(e){var t=Ext.get(e.getTarget());if(t.hasClass('keyboard_shortcut_close'))
me.destroy_keyboard_help_overlay();});},process_shortcut:function(key)
{if(Ext.isMac)
t0=key.replace("<command>","&#x2318;");else
t0=key.replace("command","Ctrl");var t1=t0.replace(/</g,"&lt;");var t2=t1.replace(/>/g,"&gt;");if(Ext.isMac)
t2=t2.replace(' alt ',' option ');var new_key='';var parts=t2.split(' ');for(var i=0;i<parts.length;i++)
{var part=parts[i];if(part[0]=='*')
new_key+='<span class="key">'+part.substr(1,part.length-1)+'</span>';else
new_key+=part;if(i!=parts.length-1)
new_key+=" ";}
return new_key;},add_drafts_to_selected_versions:function()
{var selected_versions=this.drafts_component.get_selected_versions();for(var i=0;i<selected_versions.length;i++)
{var sel='div.version[record_id="'+selected_versions[i]+'"]';var version_div=sg_find(sel,this.left_pane.dom);var drafts=sg_find_all('div.draft_add',version_div);var last_draft_id=drafts[drafts.length-1].getAttribute('draft_id');this.drafts_component.add_draft(last_draft_id);}},get_notes_widget_for_version:function(version_id){if(!this.note_widgets)
this.note_widgets={};if(this.note_widgets[version_id]){return this.note_widgets[version_id];}
var context=this.context.clone();var version={name:"Version",type:'Version',id:version_id,valid:'valid'};var filters={logical_operator:'and',conditions:[]};context.set('filters',filters);var server_side_filters={type:'playlist_version_notes',params:{version:version,playlist:this.playlist}};context.set('server_side_filters',server_side_filters);var widget=this.construct_child('notes',context);this.note_widgets[version_id]=widget;return this.note_widgets[version_id];},destroy_notes_widget_for_version:function(version_id){if(!this.note_widgets||!this.note_widgets[version_id])
return;var widget=this.note_widgets[version_id];this.destroy_child(widget);this.note_widgets[version_id]=null;},render_all_note_widgets:function(){if(!this.note_widgets)return;var notes_app_container=this.get_container();for(var version_id in this.note_widgets){if(!this.note_widgets.hasOwnProperty(version_id))continue;if(!this.note_widget_containers||!this.note_widget_containers[version_id]){var widget=this.note_widgets[version_id];widget.render();}else{var widget=this.note_widgets[version_id];var container=sg_find('#'+widget.container_id,notes_app_container.dom);if(container){var new_container=container.parentNode.appendChild(this.note_widget_containers[version_id]);Ext.fly(container).remove();}}}},loft_all_note_widget_containers:function(){if(!this.note_widgets)return;this.note_widget_containers={};for(var version_id in this.note_widgets){if(!this.note_widgets.hasOwnProperty(version_id))continue;var widget=this.note_widgets[version_id];if(widget.__container__){var container=widget.__container__.dom;var p=container.parentNode;if(p){var keep=p.removeChild(container);this.note_widget_containers[version_id]=keep;}}}},on_window_resize:function(){if(this.divider_stowed){this.divider_position=this.get_divider_rightmost_position();this.reset_divider_position();}else{var container_width=this.get_container().getWidth();if(container_width-this.divider_width<this.divider_position){this.divider_position=this.get_divider_rightmost_position();this.reset_divider_position();}}},destroy_widget:function(){Ext.EventManager.removeResizeListener(this.on_window_resize,this);SG.Page.unsaved_data.remove(this);},show_playlist_overlay:function(){this.make_open_playlist_button_active();this.hide_playlist_overlay();var cfg={playlist_picked_callback:{fn:this.on_playlist_picked,scope:this},overlay_hidden_callback:{fn:this.on_playlist_overlay_canceled,scope:this},selected_playlist_id:this.playlist?this.playlist.id:null,};this.playlist_overlay=new SG.PlaylistOverlay(cfg);},make_open_playlist_button_active:function(){var container=this.get_container();if(container){var input_button=container.child('input.open_playlist');if(!input_button.hasClass('active'))
input_button.addClass('active');}},on_playlist_overlay_canceled:function(){var container=this.get_container();var input_button=container.child('input.open_playlist');input_button.removeClass('active');this.playlist_overlay=null;},hide_playlist_overlay:function(){if(this.playlist_overlay){this.playlist_overlay.destroy();this.playlist_overlay=null;}},on_playlist_picked:function(playlist_record){var project=playlist_record.get('project');var playlist={id:playlist_record.id,type:playlist_record.type,name:playlist_record.get('code'),valid:'valid'};var me=this;setTimeout(function(){var page=me.get_page();page.destroy_root_widget();window.location='/page/notes_app?playlist_id='+playlist.id;},0);},});SG.NotesApp.DividerDragZone=function(drag_div,drafts_component)
{this.drag_div=drag_div;this.drafts_component=drafts_component;var config={resizeFrame:false,scroll:false};SG.NotesApp.DividerDragZone.superclass.constructor.call(this,this.drag_div,"rows",config);this.setYConstraint(0,0);};Ext.extend(SG.NotesApp.DividerDragZone,Ext.dd.DD,{b4StartDrag:function(x,y)
{SG.NotesApp.DividerDragZone.superclass.b4StartDrag.call(this,x,y);this.drag_div.addClass('dragging');},endDrag:function(e)
{SG.NotesApp.DividerDragZone.superclass.endDrag.apply(this,arguments);this.drag_div.removeClass('dragging');this.drafts_component.on_divider_moved();},});SG.Widget.NotesAppPublish=function(context,widget_spec,id)
{SG.Widget.NotesAppPublish.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.NotesAppPublish,SG.Widget.Base,{templates:{loading:"<div>Loading...</div>",main:'<div id="sgw_notes_app_publish">'+'<div id="top_line">'+'<span>&lt;&lt;</span> '+'<span id="back_to_drafts" class="fake_link">Back</span>'+'<span id="page_name">&nbsp;&nbsp;Note Import Preview: </span>'+'<div class="icon_Playlist inline_icon"></div> '+'<a class="playlist_detail_link" href="{playlist_detail_url}">{playlist_name}</a>'+'<div class="right_floater">'+'<button id="publish_drafts">Publish</button>'+'<div id="refresh" class="refresh_normal inline_icon"></div>'+'<div id="action_menu" class="gear_menu_nobg inline_icon"></div>'+'</div></div>'+'<div id="instructions"><div class="title">Instructions</div>'+"These are the saved note drafts you're about to import. If you'd like, you "+"can close out of your browser, and come back to this URL. Shotgun will save "+"all of these drafts for later.<br><br>"+"The <b>Note Defaults</b> section at the top lets you see and modify the Type and Subject. If you'd "+"like to apply additional attributes, just click 'More Fields'.<br><br>"+"If you'd like to share this page with anyone, just send them the page URL "+"and they'll end up right here.<br><br>"+"To override any of the note defaults, or to make changes in the note content for "+"individual drafts, just double-click the drafts you'd like to edit. You can also "+"bring all drafts into edit mode by using the 'Edit All' link. When you're done, just click 'Publish'."+'</div>'+'<div id="import_overview"></div>'+'<div id="scroll_area">'+'<div id="shared_headers">{headers}</div>'+'<div id="summary_email">{summary_email_controls}</div>'+'<div class="drafts">'+'<div id="edit_all" class="fake_link">Edit all</div>'+'{drafts}</div></div></div>',import_overview:'<div class="created_message">{created_message}</div>'+'<div class="ignored_message">{ignored_message}</div>',import_overview_check_all_ignored:'<span class="ignored_message_prompt">(actually, '+'<span class="check_all_ignored">include in the import</span>).</span>',headers:'<div class="headers"><div class="headers_title">Note Defaults</div>'+'<table class="headers">{header_fields}</table>'+'<div class="more_fields_links">{more_fields_links}</div>'+'</div>',header_field:'<tr><td class="field_name">{display_name}:</td><td style="{cell_styles}" '+'class="sg_widget_fields_cell {cell_classes}" {cell_attributes}>{cell_content}</td>',field_link:'<span class="field_link" field="{field}">{field_name}</span>',drafts:'<table class="drafts">'+'<col class="checkbox"/><col class="order_num"/><col class="thumb"/><col class="content"/>'+'<col class="spacer"/>'+'{drafts}</table>',draft:'<tbody class="{disabled}">{other_author}'+'<tr class="version">'+'<td class="checkbox">{checkbox}</td><td class="order_num">{order_num}</td>'+'<td colspan=2 class="version_code">{code}</td>'+'<td></td>'+'</tr>'+'<tr class="body">'+'<td></td><td></td><td class="version_thumb">{thumb}</td>'+'<td class="content draft_edit_zone" draft_id="{draft_id}"><div draft_edit_container>'+'<div class="summary">{summary}'+'<div class="edit" draft_id="{draft_id}"><div class="icon_edit"></div>'+'<span>Edit</span></div></div>'+'<div>{content}</div></div></td>'+'<td></td>'+'</tr>'+'<tr class="spacer"><td colspan=5></td></tr>'+'</tbody>',other_author:'<tr class="other_author"><td colspan=5 class="other_author">Written by {other_author}</td></tr>',draft_addressing_summary:'<span class="steps">{steps}</span><span class="cc">{cc}</span>',after_publish:'<div id="sgw_notes_app_publish" class="after_publish">'+'<div class="after_publish">'+'<div class="heading">{heading}</div>'+'{summary_email}'+'<div class="go_playlist_detail_page">Go to the Playlist Detail Page</div>'+'<div class="new_page_with_data">Or view a new page with the imported data.</div>'+'</div>',summary_email_message:'<div class="go_view_summary_email" eventlog_entry_id="{id}">View the Summary Email</div>',summary_email_toggle:'<table class="summary_email"><tr><td class="checkbox">{checkbox}</td>'+'<td class="summary_email_checkbox_label">Create Summary Email</td></tr></table>',include_old_notes_toggle:'<table class="old_notes"><tr><td class="checkbox">{checkbox}</td>'+'<td class="include_old_notes_label">Include any previous Notes created on Versions in this Playlist</td>'+'</tr></table><div class="old_note_count"></div>',summary_email_fields:'<table class="summary_email_fields">{fields}</table>',},playlist_change_scan_interval:10000,check_for_changes_interval:2000,init_widget:function()
{this.playlist=this.context.get('playlist');this.version_data_set=this.new_data_set('Version',this.on_version_load);this.draft_data_set=this.new_data_set('Note',this.on_draft_load,this.on_draft_data_set_change);this.draft_data_set.drafts=true;this.task_data_set=this.new_data_set('Task',this.on_task_load);document.title="Review Notes: "+this.playlist.name;this.selection_state={};this.more_fields=[];this.published_note_ids=[];this.send_summary_email=false;this.send_old_notes=true;SG.Page.unsaved_data.add(this);},has_unsaved_data:function(){return SG.CellManager.globally_any_error_cells();},on_first_render:function()
{var cell_config={container:this.get_container(),data_set:this.draft_data_set,projects:this.context_projects(),get_fields_callback:{fn:this.get_header_field_names,scope:this},autocommit:true,in_form:true};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.get_container(),'click',this.on_click,this);this.add_event(this.get_container(),'dblclick',this.on_double_click,this);this.add_event(SG.Checkbox,"change",this.on_checkbox_change);},render_widget:function()
{if(!this.version_data_set.loaded)
{this.show_loading_overlay();var html=this.templates.loading.apply({});this.get_container().update(html);this.fetch_data();return;}
var headers=this.render_shared_headers();var summary_email_controls=this.render_summary_email_controls();var drafts=this.render_drafts();var playlist_detail_url=window.location.protocol+'//'+window.location.host+'/detail/Playlist/'+
this.playlist.id;this.get_container().update(this.templates.main.apply({playlist_name:this.playlist.name,headers:headers,summary_email_controls:summary_email_controls,drafts:drafts,playlist_detail_url:playlist_detail_url,original_page_url:this.context.get('from_url'),original_page_title:this.context.get('from_title'),}));this.hide_loading_overlay();if(!this.timers_started)
{this.timers_started=true;this.start_timers();}
this.update_import_overview();},start_timers:function()
{var me=this;setTimeout(function(){me.check_for_changes();},this.check_for_changes_interval);},render_shared_headers:function()
{var shared_header_rec=null;for(var i=0;i<this.draft_data_set.records.length;i++)
{if(this.is_shared_header_rec(this.draft_data_set.records[i]))
{shared_header_rec=this.draft_data_set.records[i];break;}}
if(!shared_header_rec)
throw"notes_app_publish.js: Application error - should generate a shared header record on load.";var header_fields=this.get_header_field_names().concat(this.more_fields);var header_html=[];for(var i=0;i<header_fields.length;i++)
{var schema_field=SG.schema.get_field('Note',header_fields[i]);var cell=this.cell_manager.get_cell(schema_field.name);cell.autocommit=true;var cell_hash=cell.render(shared_header_rec);cell_hash.display_name=schema_field.display_name;header_html.push(this.templates.header_field.apply(cell_hash));}
return this.templates.headers.apply({header_fields:header_html.join(''),more_fields_links:this.render_more_fields_controls()});},render_summary_email_controls:function(){var state=this.send_summary_email?'checked':'unchecked';var toggle=this.templates.summary_email_toggle.apply({checkbox:SG.Checkbox.render('summary_email_toggle',null,state,null,'summary_email'),});var email_fields='';var old_note_toggle='';if(this.send_summary_email){email_fields=this.render_summary_email_fields();var state=this.send_old_notes?'checked':'unchecked';old_note_toggle=this.templates.include_old_notes_toggle.apply({checkbox:SG.Checkbox.render('old_notes_toggle',null,state,null,'old_notes'),});}
return toggle+email_fields+old_note_toggle;},re_render_summary_email_controls:function(){var summary_email_div=this.get_container().child('div#summary_email');summary_email_div.update(this.render_summary_email_controls());},render_summary_email_fields:function(){this.summary_email_fields=['addressings_to','cc_external','subject','content'];if(!this.summary_email_cell_manager){SG.schema.entity_fields.Note.cc_external={configurable:false,data_type:'text',display_name:'Cc Email',field_type:'permanent',grid_column:false,id:0,name:'cc_external',summary_default:'none',};this.summary_email_data_set=this.new_data_set('Note');var rec=this.summary_email_data_set.new_record();var shared_header_rec=this.get_shared_header_rec();if(shared_header_rec){rec.set('subject',shared_header_rec.get('subject'));}
var cell_config={container:this.get_container(),data_set:this.summary_email_data_set,projects:this.context_projects(),get_fields_callback:{fn:function(){return this.summary_email_fields;},scope:this},autocommit:false,in_form:true};this.summary_email_cell_manager=this.new_component(SG.CellManager,cell_config);}
var record=this.summary_email_data_set.get_record(0);var fields_html='';for(var i=0;i<this.summary_email_fields.length;i++){var field=this.summary_email_fields[i];var schema_field=SG.schema.get_field('Note',field);var cell;if(field=='content')
cell=this.summary_email_cell_manager.get_cell(field,{type:SG.LargeTextAreaCell});else
cell=this.summary_email_cell_manager.get_cell(field);var cfg=cell.render(record);if(field=='content')
cfg.display_name='Note';else
cfg.display_name=schema_field.display_name;if(field=='cc_external'&&!record.get('cc_external')){var message='<span class="message">Any email addresses, separated by commas</span>';cfg.cell_content=cfg.cell_content.replace('&nbsp;',message);}
fields_html+=this.templates.header_field.apply(cfg);}
return this.templates.summary_email_fields.apply({fields:fields_html});},render_more_fields_controls:function()
{var links_html=[];var link_fields=["addressings_cc"];for(var i=0;i<link_fields.length;i++)
{if(this.more_fields.indexOf(link_fields[i])==-1)
links_html.push(this.templates.field_link.apply({field:link_fields[i],field_name:SG.schema.get_field('Note',link_fields[i]).display_name}));}
links_html.push(this.templates.field_link.apply({field:'__more_fields__',field_name:'More fields...'}));return links_html.join('');},rerender_shared_headers:function()
{var container=this.get_container().child('div#shared_headers');container.dom.innerHTML=this.render_shared_headers();},render_drafts:function()
{var version_rec,draft_rec,draft_html,i,j;var drafts_by_version={};for(i=0;i<this.draft_data_set.records.length;i++)
{draft_rec=this.draft_data_set.records[i];if(!this.has_content(draft_rec))
continue;var note_links=draft_rec.get('note_links');if(!note_links)
continue;for(j=0;j<note_links.length;j++)
{if(note_links[j].type=='Version')
{if(!drafts_by_version[note_links[j].id])
drafts_by_version[note_links[j].id]=[draft_rec];else
drafts_by_version[note_links[j].id].push(draft_rec);}}}
var drafts=[];var draft_html=[];this.rendered_drafts=[];for(i=0;i<this.version_data_set.count();i++)
{version_rec=this.version_data_set.get_record(i);drafts=drafts_by_version[version_rec.id]||[];for(j=0;j<drafts.length;j++)
{draft_rec=drafts[j];var selected_state=this.get_selected_state(draft_rec);var updated_by=draft_rec.get('updated_by');var other_author=(updated_by&&updated_by.id!=SG.globals.current_user.id)?this.templates.other_author.apply({other_author:updated_by.name}):'';draft_html.push(this.templates.draft.apply({code:version_rec.get('code'),thumb:SG.Renderers.image.render(version_rec.get('image')),other_author:other_author,checkbox:SG.Checkbox.render("draft_"+draft_rec.id,null,selected_state,null,draft_rec.id,'draft_checkbox'),order_num:i+1,summary:this.render_draft_addressing_summary(draft_rec),content:SG.Renderers.text.render(draft_rec.get('content')),disabled:(selected_state=='unchecked')?'disabled':'',draft_id:draft_rec.id}));this.rendered_drafts.push(draft_rec);}}
return this.templates.drafts.apply({drafts:draft_html.join("")});},render_draft_addressing_summary:function(draft_rec)
{var tasks=draft_rec.get('tasks');var task_summary=[];for(var i=0;i<tasks.length;i++)
{var task_rec=this.task_data_set.get_record_by_id(tasks[i].id);var step_code=task_rec.get('step.Step.short_name');if(step_code)
task_summary.push(step_code);}
var cc=draft_rec.get('addressings_cc');var cc_summary=[];for(var i=0;i<cc.length;i++)
cc_summary.push(cc[i].name);var task_summary_spacer='';if(task_summary.length>0)
task_summary_spacer='&nbsp;&nbsp;&nbsp;';var cc_summary_spacer='';if(cc_summary.length>0)
cc_summary_spacer='Cc: ';return this.templates.draft_addressing_summary.apply({steps:task_summary.join(', ')+task_summary_spacer,cc:cc_summary_spacer+cc_summary.join(', ')});},get_selected_state:function(draft_rec)
{if(!this.selection_state[draft_rec.id])
{var updated_by=draft_rec.get('updated_by');this.selection_state[draft_rec.id]=(updated_by&&updated_by.id!=SG.globals.current_user.id)?'unchecked':'checked';}
return this.selection_state[draft_rec.id];},set_selected:function(draft_rec,state)
{this.selection_state[draft_rec.id]=state;},fetch_data:function()
{SG.Repo.start_batch();var sorts=[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}];var filters={logical_operator:'and',conditions:[{path:'playlists',relation:'is',values:[this.playlist]}]};var spec={type:'Version',filters:filters,columns:this.get_version_field_names(),sorts:sorts,result:this.version_data_set,parent_entity:this.playlist};SG.Repo.query(spec);filters={logical_operator:'and',conditions:[{path:'playlist',relation:'is',values:[this.playlist]}]};spec={type:'Note',filters:filters,columns:SG.schema.entity_types.Note.fields_sorted_by_display_name,result:this.draft_data_set};SG.Repo.query(spec);this.versions_loaded=false;this.drafts_loaded=false;this.tasks_loaded=false;SG.Repo.end_batch();},on_version_load:function(ds)
{this.versions_loaded=true;this.on_all_loaded();},on_draft_load:function()
{this.drafts_loaded=true;var task_ids=[];var draft_rec,tasks,i,j;for(i=0;i<this.draft_data_set.records.length;i++)
{draft_rec=this.draft_data_set.records[i];tasks=draft_rec.get('tasks');for(j=0;j<tasks.length;j++)
task_ids.push(tasks[j].id);}
var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:task_ids}]};var spec={type:'Task',filters:filters,columns:['step','step.Step.short_name'],result:this.task_data_set};SG.Repo.query(spec);},on_task_load:function()
{this.tasks_loaded=true;this.on_all_loaded();},on_all_loaded:function()
{if(!(this.drafts_loaded&&this.versions_loaded&&this.tasks_loaded))
return;var shared_header_rec=this.get_shared_header_rec();if(!shared_header_rec)
{shared_header_rec=this.draft_data_set.new_record();shared_header_rec.set('content','__SHARED_HEADERS_DRAFT__');shared_header_rec.set('playlist',this.playlist);shared_header_rec.set('project',this.context.get('entity_project'));var note_type_field=SG.schema.get_field("Note","sg_note_type");if(note_type_field&&note_type_field.data_type=='list'&&note_type_field.values.length>0)
shared_header_rec.set('sg_note_type',note_type_field.values[0]);parser=SG.GridEditor.DateParser;var today_string=parser.format(parser.get_normalized_today(),' - F s');shared_header_rec.set('subject',this.playlist.name+today_string);setTimeout(function(){shared_header_rec.commit();});}
this.render();},is_shared_header_rec:function(rec)
{return(rec.get("content")=="__SHARED_HEADERS_DRAFT__");},get_shared_header_rec:function(){var shared_header_rec=null;for(var i=0;i<this.draft_data_set.records.length;i++){if(this.is_shared_header_rec(this.draft_data_set.records[i])){shared_header_rec=this.draft_data_set.records[i];break;}}
return shared_header_rec;},get_version_field_names:function()
{return['code','image','entity','playlists.PlaylistVersionConnection.sg_sort_order'];},get_header_field_names:function()
{if(!this.header_fields)
{var header_fields=['sg_note_type','subject'];this.header_fields=[];for(var i=0;i<header_fields.length;i++)
if(SG.schema.get_field('Note',header_fields[i]))
this.header_fields.push(header_fields[i]);}
return this.header_fields;},on_draft_data_set_change:function(changes)
{var data_saved=false;for(var i=0;i<changes.length;i++)
{var change=changes[i];if(change.type=='create'&&change.record.get('content')=='__SHARED_HEADERS_DRAFT__'){this.rerender_shared_headers();}else if(change.type=='update'&&change.state=='pending'){}else if(change.type=='create'||(change.type=='update'&&change.state=='server')){data_saved=true;}else if(change.type=='retire'){data_retired=true;}}
if(this.waiting_on_removal_commit_after_publish&&data_retired)
this.publish_complete();},on_click:function(e)
{var t=Ext.get(e.getTarget());var me=this;if(t.id=='back_to_drafts')
{setTimeout(function(){me.prepare_to_return_to_drafts();});return;}
if(t.id=='edit_all')
{this.edit_all();return;}
if(t.id=='publish_drafts')
{setTimeout(function(){me.prepare_to_publish();});return;}
if(t.id=='refresh')
{setTimeout(function(){me.refresh();});return;}
if(t.id=='action_menu')
{if(this.action_menu&&this.action_menu.is_showing())
{this.action_menu.destroy();this.action_menu=null;}
else
this.show_action_menu(t);return;}
var edit_div=t.findParent('div.edit',this.get_container());if(edit_div)
{this.edit_draft(Number(edit_div.getAttribute('draft_id')));return;}
if(t.hasClass('field_link'))
{var field=t.dom.getAttribute('field');if(field=='__more_fields__')
this.show_more_fields_menu(t.dom);else
this.add_header_field(null,{field:field});}
if(t.hasClass('check_all_ignored'))
{this.check_all_ignored();}
var new_page_link=t.findParent('div.new_page_with_data',this.get_container());if(new_page_link)
{this.show_new_page_with_imported_notes();}
new_page_link=t.findParent('div.go_playlist_detail_page',this.get_container());if(new_page_link)
{this.goto_playlist_detail_page();}
new_page_link=t.findParent('div.go_view_summary_email',this.get_container());if(new_page_link){var eventlog_entry_id=new_page_link.getAttribute('eventlog_entry_id');this.goto_summary_email_preview(eventlog_entry_id);}},on_double_click:function(e)
{var t=Ext.get(e.getTarget());var draft_zone=t.findParent('td.draft_edit_zone',this.get_container(),true);if(draft_zone)
{var new_note_dialog_div=draft_zone.child('div.sgc_new_note_dialog');if(new_note_dialog_div)return;this.edit_draft(Number(draft_zone.dom.getAttribute('draft_id')));return;}},prepare_to_return_to_drafts:function()
{if(SG.CellManager.globally_any_error_cells()){SG.server_error({html_msg:'Page contains errors'});return;}
this.return_to_drafts();},return_to_drafts:function()
{var url='/page/notes_app?playlist_id='+this.playlist.id;var url_layout_name=this.get_layout_name_from_url();if(url_layout_name!="")
url+='#'+url_layout_name;window.location=url;},get_layout_name_from_url:function(){var layout_name=location.href.split("#")[1]||"";return layout_name;},publish_complete:function()
{if(this.send_summary_email){var config={email_field_record:this.summary_email_data_set.get_record(0),published_note_ids:this.published_note_ids,finished_callback:{fn:this.show_publish_complete_options,scope:this},playlist:this.playlist,include_old_notes_on_versions:this.send_old_notes};var email=this.new_component(SG.NotesApp.SummaryEmail,config);}else{this.hide_loading_overlay();this.show_publish_complete_options();}},show_publish_complete_options:function(eventlog_entry_id){if(eventlog_entry_id!==undefined)
this.hide_loading_overlay();var summary_email_msg='';var heading=' Your Notes Have Been Imported Successfully';if(this.send_summary_email){summary_email_msg=this.templates.summary_email_message.apply({id:eventlog_entry_id});heading+=' and a Summary Email Has Been Sent';}
this.hide_loading_overlay();this.get_container().update(this.templates.after_publish.apply({heading:heading,summary_email:summary_email_msg}));},goto_playlist_detail_page:function()
{window.location=window.location.protocol+'//'+window.location.host+'/detail/Playlist/'+
this.playlist.id;},goto_summary_email_preview:function(eventlog_entry_id){window.location=window.location.protocol+'//'+window.location.host+'/notes_app_summary_email/'+
eventlog_entry_id;},show_new_page_with_imported_notes:function()
{var now=new Date();var options={url:'/page/create_import_page',params:{entity_type:'Note',import_ids:Ext.encode(this.published_note_ids),columns:Ext.encode(['subject','content','note_links','addressings_cc','tasks']),client_timestamp:now.format('M d, Y g:i A')},callback:function(options,success,response){if(success){var page_id=Ext.decode(response.responseText).page_id;var current_url=window.location;var new_url=current_url.protocol+'//'+current_url.host+'/page/'+page_id;window.location=new_url;}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},prepare_to_publish:function()
{if(SG.CellManager.globally_any_error_cells()){SG.server_error({html_msg:'Page contains errors'});return;}
if(this.send_summary_email){var record=this.summary_email_data_set.get_record(0);var email_str=record.get('cc_external');var emails=[];if(email_str)
emails=email_str.split(',');for(var i=0;i<emails.length;i++){var email=emails[i];if(!this.validate_email_address(email)){var msg='Looks like you have an invalid email entered into the Cc Email field for the summary '+'email: '+email+" Can't publish until this is fixed.";alert(msg);return;}}}
this.show_loading_overlay();this.publish();},check_for_changes:function()
{var me=this;setTimeout(function(){me.check_for_changes();},this.check_for_changes_interval);},refresh:function()
{this.fetch_data();},has_content:function(rec)
{return(rec.get('content')&&rec.get('content').strip());},publish:function()
{var dont_publish=[];var dont_delete_these_drafts=[];var header_rec;for(var i=0;i<this.draft_data_set.records.length;i++)
{var draft_rec=this.draft_data_set.records[i];if((!this.has_content(draft_rec)||this.get_selected_state(draft_rec)=='unchecked')&&!this.is_shared_header_rec(draft_rec))
{dont_publish.push(draft_rec);var updated_by=draft_rec.get('updated_by');if(this.has_content(draft_rec)||!updated_by||updated_by.id!=SG.globals.current_user.id){dont_delete_these_drafts.push(draft_rec)}}
if(this.is_shared_header_rec(this.draft_data_set.records[i]))
header_rec=this.draft_data_set.records[i];}
if(dont_delete_these_drafts.length>0){this.draft_data_set.remove(dont_delete_these_drafts);}
var count=0;for(var i=0;i<this.draft_data_set.records.length;i++){var record=this.draft_data_set.records[i];if(this.is_shared_header_rec(record))
continue;else if(dont_publish.indexOf(record)>-1)
continue;count++;}
if(count==0){this.publish_complete();return;}
var new_note_data_set=new SG.Data.Set(this.draft_data_set.type);var new_rec;for(var i=0;i<this.draft_data_set.records.length;i++)
{if(dont_publish.indexOf(this.draft_data_set.records[i])>-1)
continue;if(this.draft_data_set.records[i].state!='retired')
{new_rec=new_note_data_set.new_record();this.draft_data_set.records[i].copy_onto(new_rec);new_rec.revert('uuid');}}
this.add_event(new_note_data_set,'change',this.on_new_note_data_set_change);this.__data_sets__.push(new_note_data_set);var i,j,m,n,index,copied_header_rec;var header_fields=this.get_header_field_names().concat(this.more_fields);for(var i=0;i<new_note_data_set.records.length;i++)
{if(this.is_shared_header_rec(new_note_data_set.records[i]))
{copied_header_rec=new_note_data_set.records[i];continue;}
for(var j=0;j<header_fields.length;j++)
{var value=header_rec.get(header_fields[j]);if(value==null||typeof value=='undefined')
continue;var schema_field=SG.schema.get_field('Note',header_fields[j]);if(schema_field.data_type=='multi_entity')
{var note_value=new_note_data_set.records[i].get(header_fields[j])||[];for(var m=0;m<value.length;m++)
{var index=-1;for(var n=0;n<note_value.length;n++)
if(note_value[n].type===value[m].type&&note_value[n].id===value[m].id)
index=n;if(index==-1)
note_value.push(value[m]);}
new_note_data_set.records[i].set(header_fields[j],note_value);}
else if(!new_note_data_set.records[i].get(header_fields[j]))
new_note_data_set.records[i].set(header_fields[j],header_rec.get(header_fields[j]));}}
new_note_data_set.remove(copied_header_rec);new_note_data_set.commit();},on_new_note_data_set_change:function(changes)
{var data_saved=false;for(var i=0;i<changes.length;i++)
{if(changes[i].type=='create')
{data_saved=true;if(this.published_note_ids.indexOf(changes[i].record.id)==-1)
this.published_note_ids.push(changes[i].record.id);}}
if(data_saved)
{for(var i=0;i<this.draft_data_set.records.length;i++)
this.draft_data_set.records[i].retire();this.waiting_on_removal_commit_after_publish=true;this.draft_data_set.commit(true);}},on_checkbox_change:function(checkbox,no_overview_update)
{if(!this.get_container().contains(checkbox))return;if(checkbox.hasAttribute('draft_checkbox'))
{var rec=this.draft_data_set.get_record_by_id(Number(checkbox.getAttribute('value')));var state=SG.Checkbox.get_state(checkbox);this.set_selected(rec,state);var draft_dom=Ext.get(checkbox).findParent('tbody',this.get_container(),true);if(state=='unchecked')
draft_dom.addClass('disabled');else
draft_dom.removeClass('disabled');if(!no_overview_update)
this.update_import_overview();}else if(checkbox.getAttribute('id')=='summary_email_toggle'){var state=SG.Checkbox.get_state(checkbox);this.send_summary_email=state=='checked';this.re_render_summary_email_controls();this.update_import_overview();}else if(checkbox.getAttribute('id')=='old_notes_toggle'){var state=SG.Checkbox.get_state(checkbox);this.send_old_notes=state=='checked';this.update_import_overview();}},edit_draft:function(draft_id)
{var draft_rec=this.draft_data_set.get_record_by_id(draft_id);var edit_div_ext_elem=this.get_container().child('td.draft_edit_zone[draft_id='+draft_id+']');if(!edit_div_ext_elem)
return;edit_div_ext_elem=Ext.get(edit_div_ext_elem.dom.firstChild);var config={entity_type:'Note',single_project:draft_rec.get('project'),all_projects:[draft_rec.get('project')],container:edit_div_ext_elem,source_record:draft_rec,visible_fields:['note_links','tasks','content'],hide_project_selector:true,hide_fields_with_default_values:false,edit_source_record_mode:true,source_record_data_set:this.draft_data_set,no_attachments:true,autocommit:true}
new SG.NewNoteDialog(config);},show_more_fields_menu:function(dom_elem)
{if(!this.more_fields_menu)
{this.more_fields_menu=new SG.Menu({item_selected:{fn:this.add_header_field,scope:this}});}
var items=[];var fields=SG.schema.get_categorized_fields('Note').ordinary;for(i=0;i<fields.length;i++)
{var schema_field=fields[i];if(schema_field.grid_column==false)continue;items.push({html:schema_field.display_name,field:schema_field.name,checked:this.more_fields.indexOf(schema_field.name)>-1,disabled:this.more_fields_disabled(schema_field)});}
this.more_fields_menu.items=items;this.more_fields_menu.render();this.more_fields_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},more_fields_disabled:function(field_schema)
{var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','system_task_type','list','timecode','date_time','url'];if(field_schema.read_only)
return true;else if(supported_data_types.indexOf(field_schema.data_type)==-1)
return true;else if(field_schema.name==='attachments'&&field_schema.data_type==='multi_entity')
return true;else if(['sg_note_type','subject','content','tasks','project'].indexOf(field_schema.name)!=-1)
return true;return false;},add_header_field:function(menu,item)
{var index=this.more_fields.indexOf(item.field);if(index>-1)
this.more_fields.splice(index,1);else
this.more_fields.push(item.field);var me=this;setTimeout(function(){me.rerender_shared_headers();},0);},update_import_overview:function()
{var overview_elem=this.get_container().child('div#import_overview');var draft,state;var imports=[];var ignored_by_me=[];var ignored_by_others=[];for(var i=0;i<this.rendered_drafts.length;i++)
{draft=this.rendered_drafts[i];state=this.get_selected_state(draft);if(state=='checked')
imports.push(draft);else
{var updated_by=draft.get('updated_by');var by_me=(updated_by&&updated_by.id==SG.globals.current_user.id);if(by_me)
ignored_by_me.push(draft);else
ignored_by_others.push(draft);}}
var ignored_message='';var total=ignored_by_me.length+ignored_by_others.length;if(total>0)
{ignored_message=total+" "+"Note".pluralize(total)+" written by "+
(ignored_by_me.length>0?"you ":'')+
(ignored_by_me.length>0&&ignored_by_others.length>0?"and ":'')+
(ignored_by_others.length>0?"others ":'')+"will be ignored "+
this.templates.import_overview_check_all_ignored.apply({});}
overview_elem.dom.innerHTML=this.templates.import_overview.apply({created_message:imports.length+" "+"Note".pluralize(imports.length)+" will be created by this import.",ignored_message:ignored_message});var publish_button=sg_find("button#publish_drafts");if((imports.length==0&&!this.send_summary_email)||(imports.length==0&&this.send_summary_email&&!this.send_old_notes)){publish_button.setAttribute('disabled',true);}else{publish_button.removeAttribute('disabled');}},check_all_ignored:function()
{var draft,state,checkbox;for(var i=0;i<this.rendered_drafts.length;i++)
{draft=this.rendered_drafts[i];state=this.get_selected_state(draft);if(state=='unchecked')
{checkbox=SG.Checkbox.get_checkbox("draft_"+draft.id);SG.Checkbox.set_state(checkbox,"checked");this.on_checkbox_change(checkbox,true);}}
this.update_import_overview();},show_action_menu:function(button_ext_elem)
{if(this.action_menu)
this.action_menu.destroy();this.action_menu=this.new_component(SG.Menu,{position:{dom_elem:button_ext_elem.dom,elem_anchor:'br',menu_anchor:'tr'},items:[{html:'Edit All Notes',value:'edit_all'},],item_selected:{fn:this.action_menu_item_selected,scope:this}});this.action_menu.render();this.action_menu.show();},action_menu_item_selected:function(menu,item)
{if(item.value=='edit_all')
{this.edit_all();return;}},edit_all:function()
{var draft_edit_zones=sg_find_all("td.draft_edit_zone",this.get_container().dom);for(var i=(draft_edit_zones.length-1);i>-1;i--)
{var draft_id=Number(draft_edit_zones[i].getAttribute('draft_id'));this.edit_draft(draft_id);}
var me=this;setTimeout(function(){var scroll_area=sg_find("div#scroll_area",me.get_container().dom);scroll_area.scrollTop=0;},100);},validate_email_address:function(email){var re_part1=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@/;var re_part2=/((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;var re=new RegExp(re_part1.source+re_part2.source);return re.test(email);},destroy_widget:function(){SG.Page.unsaved_data.remove(this);},});SG.NotesApp.Drafts=function(config)
{Ext.apply(this,config);SG.NotesApp.Drafts.superclass.constructor.call(this);};Ext.extend(SG.NotesApp.Drafts,SG.Component,{templates:{drafts:'<div class="drafts sg_scroll_container">{drafts}</div>'+'<div id="sgc_notes_app_drafts_drag_proxy"></div>',version:'<div class="version selectable {extra_classes}" record_id="{version_id}" group_idx="-1">'+'<table class="draft"><tr>'+'<td class="thumb"><div class="handle_and_version">{reorder_handle}'+'<div class="version_code" sg_tip="{code}" clip_tip="this_node">{code}</div></div>'+'<div class="version_thumb">{thumb}</div></td>'+'<td class="drafts">{drafts}</td></tr>{notes_widget}'+'</table></div>',version_with_fields:'<div class="version selectable {extra_classes}" record_id="{version_id}" group_idx="-1">'+'<table class="draft"><tr>'+'<td class="thumb"><div class="handle_and_version">{reorder_handle}'+'<div class="version_code" sg_tip="{code}" clip_tip="this_node">{code}</div></div>'+'<div class="version_thumb">{thumb}</div></td>'+'<td class="version_fields">{fields}</td>'+'<td class="drafts">{drafts}</td></tr>{notes_widget}'+'</table></div>',notes_widget:'<tr><td>&nbsp;</td><td><div id="{widget_id}" class="{widget_class} noselect"></div></td></tr>',notes_widget_with_fields:'<tr><td>&nbsp;</td><td></td><td><div id="{widget_id}" class="{widget_class} noselect"></div></td></tr>',reorder_handle:'<div class="drag_reorder_grip">{order}</div>',draft:'<div class="draft_controls" draft_id="{draft_id}">{draft_buttons}</div>'+'<div class="draft_content_wrapper" draft_id="{draft_id}">'+'<div class="draft_content field_value {cell_classes}" {cell_attributes} record_id={draft_id}>'+'{cell_content}</div>'+'<div draft_id="{draft_id}" class="noselect sgc_note_addressings" style="margin-right:{right}px;"></div>'+'<div class="arrow_closed_dark" draft_id="{draft_id}"></div>'+'</div>',draft_content_wrapper:'<div class="draft_content_wrapper" draft_id="{draft_id}">'+'<div class="draft_content field_value {cell_classes}" {cell_attributes} record_id={draft_id}>'+'{cell_content}</div>'+'<div draft_id="{draft_id}" class="noselect sgc_note_addressings" style="margin-right:{right}px;"></div>'+'<div class="arrow_closed_dark" draft_id="{draft_id}"></div>'+'</div>',draft_content_wrapper_empty:'<div class="draft_content_wrapper" draft_id="{draft_id}"></div>',draft_by_other_author:'<div class="draft_controls other_author" draft_id="{draft_id}">{author_name}, {elapsed_time_phrase}:'+'<span style="float: right;">{draft_buttons}</span></div>'+'<div class="draft_content_wrapper" draft_id="{draft_id}">'+'<div class="draft_content field_value {cell_classes}" {cell_attributes} record_id={draft_id}>'+'{cell_content}</div>'+'<div draft_id="{draft_id}" class="noselect sgc_note_addressings" style="margin-right:{right}px;"></div>'+'<div class="arrow_closed_dark" draft_id="{draft_id}"></div>'+'</div>',draft_buttons:'<div draft_id="{draft_id}" class="noselect draft_add" sg_tip="New Note">+</div>'+'<div draft_id="{draft_id}" class="noselect draft_actions inline_icon gear_menu_nobg" '+'{alone}></div>',no_versions:'<div class="no_versions">This Playlist has no Versions.</div>',orphaned_drafts_header:'<div class="orphaned_drafts_heading">Notes on removed Versions</div>',dragging_multi_message:'<div class="multi_version_drag_message">{count} Versions</div>',thumb:'<div class="thumbnail {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>',empty_thumb:'<div class="empty_thumb">&nbsp;</div>',field:'<div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div>',no_data:'<span class="missing_field_data">{field_name}</span>',note_form_decoration:'<div class="note_form_decoration_left"></div>'+'<div class="note_form_decoration_right" style="right:{right}px;"></div>'+'<div class="note_form_decoration_bottom"></div>'+'<div class="arrow_open_dark" draft_id="{draft_id}"></div>',},col_1_width:82,init_component:function()
{var cell_config={container:this.widget.get_container(),data_set:this.draft_data_set,projects:this.widget.context_projects(),get_fields_callback:{fn:this.get_editable_field_names,scope:this.widget},autocommit:true,in_form:true,on_cell_edit:{fn:this.on_cell_edit,scope:this},select_all_in_text_areas:true};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.widget.get_container(),'click',this.on_click,this);if(!this.version_data_set.fast_removed)
this.version_data_set.fast_removed=[];},get_editable_field_names:function()
{return['content'];},construct_drag_components:function(container)
{var container_id=container.dom.getAttribute('container_id');if(container_id&&container_id==this.container_id)
return;if(this.row_drag_reorder)
this.row_drag_reorder.destroy();var config={container:container,reorder_callback:{fn:this.reorder_versions,scope:this},drag_element_proxy_id:'sgc_notes_app_drafts_drag_proxy',b4_start_drag_callback:{fn:this.before_drag_reorder,scope:this},selection_callback:{fn:this.on_entities_selected,scope:this},drag_proxy_callback:{fn:this.generate_drag_proxy,scope:this},};this.row_drag_reorder=new SG.NotesApp.Selection(config);this.container_id=Math.floor(Math.random()*1000000);container.dom.setAttribute('container_id',this.container_id);},before_drag_reorder:function()
{var dragging_div=this.row_drag_reorder.get_drag_elem();var selected_versions=this.get_selected_versions();if(selected_versions.length<2)
{this.dragging_order=[selected_versions[0]];return;}
var dragging_id=Number(dragging_div.dom.getAttribute('record_id'));this.dragging_order=[];var container=this.get_container();var version_divs=sg_find_all('div.version.selected',container.dom);for(var i=0;i<version_divs.length;i++)
{var div=Ext.get(version_divs[i]);var id=Number(div.dom.getAttribute('record_id'));if(id==dragging_id)
{this.dragging_order.push(id);continue;}
this.dragging_order.push(id);div.hide();}},generate_drag_proxy:function()
{var len=0;var selected_versions=this.get_selected_versions();if(selected_versions)
len=selected_versions.length;if(len==1)
{var dragging_div=this.row_drag_reorder.get_drag_elem();var thumb_td=dragging_div.child('td.thumb');html=thumb_td.dom.innerHTML;}
else
html=this.templates.dragging_multi_message.apply({count:len});return html;},is_selected:function(version_id)
{var selected_versions=this.get_selected_versions();return(selected_versions.indexOf(version_id)!=-1);},reorder_versions:function()
{var dragging_div=this.row_drag_reorder.get_drag_elem();var div_before=dragging_div.dom.previousSibling;var insert_after_id=-1;if(div_before)
insert_after_id=Number(div_before.getAttribute('record_id'));var i;var to_insert=[];for(i=0;i<this.dragging_order.length;i++)
to_insert.push(this.version_data_set.get_record_by_id(this.dragging_order[i]));var records=[];if(insert_after_id==-1)
records=to_insert;for(i=0;i<this.version_data_set.records.length;i++)
{var rec=this.version_data_set.records[i];if(this.dragging_order.indexOf(rec.id)==-1)
records.push(rec);if(insert_after_id==rec.id)
{for(var j=0;j<to_insert.length;j++)
records.push(to_insert[j]);}}
this.version_data_set.records=records;var me=this;setTimeout(function(){me.render(true);},0);this.set_custom_sort_order_on_versions();this.widget.set_sorts([{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}],true);},set_custom_sort_order_on_versions:function(){this.version_data_set.start_batch();for(i=0;i<this.version_data_set.records.length;i++)
{var rec=this.version_data_set.get_record(i);rec.set('playlists.PlaylistVersionConnection.sg_sort_order',i+1);}
this.version_data_set.end_batch();this.version_data_set.commit(true);},on_entities_selected:function(selection)
{this.selected_versions=sg_deep_copy(selection);var me=this;setTimeout(function(){me.widget.version_selection_changed(me.selected_versions);},0);},get_selected_versions:function()
{if(!this.selected_versions)
return[];else
return this.selected_versions;},select_previous_version:function(clear_selection)
{var version_div=this.get_last_selected_version_div();if(!version_div)return;if(!version_div.previousSibling)return;if(clear_selection)
this.row_drag_reorder.clear_selection(true);var previous_div=Ext.get(version_div.previousSibling);this.row_drag_reorder.select_version_div(previous_div);this.scroll_into_view(previous_div);},get_last_selected_version_div:function()
{var selected_versions=this.get_selected_versions();if(selected_versions.length==0)return null;var last_id=selected_versions[selected_versions.length-1];var container=this.get_container();var version_div=sg_find('div.version[record_id="'+last_id+'"]',container.dom);return version_div;},select_next_version:function(clear_selection)
{var version_div=this.get_last_selected_version_div();if(!version_div)return;if(!version_div.nextSibling)return;if(clear_selection)
this.row_drag_reorder.clear_selection(true);var next_div=Ext.get(version_div.nextSibling);this.row_drag_reorder.select_version_div(next_div);this.scroll_into_view(next_div);},select_next_textarea:function(){var container=this.get_container();var all_textareas=sg_find_all('textarea',container.dom);for(var i=0;i<all_textareas.length;i++){var textarea=Ext.get(all_textareas[i]);if(textarea.dom==document.activeElement){if(i+1==all_textareas.length){var target=Ext.get(all_textareas[0]);var me=this;setTimeout(function(){target.focus();me.scroll_into_view(target);},1);}else{var me=this;var target=Ext.get(all_textareas[i+1]);setTimeout(function(){target.focus();me.scroll_into_view(target);},1);}
return;}}},select_previous_textarea:function(){var container=this.get_container();var all_textareas=sg_find_all('textarea',container.dom);for(var i=0;i<all_textareas.length;i++){var textarea=Ext.get(all_textareas[i]);if(textarea.dom==document.activeElement){if(i==0){var target=Ext.get(all_textareas[all_textareas.length-1]);var me=this;setTimeout(function(){target.focus();me.scroll_into_view(target);},1);}else{var me=this;var target=Ext.get(all_textareas[i-1]);setTimeout(function(){target.focus();me.scroll_into_view(target);},1);}
return;}}},select_first_version:function()
{var container=this.get_container();var version_divs=sg_find_all('div.version',container.dom);if(!version_divs||version_divs.length==0)return;var version_div=Ext.get(version_divs[0]);this.row_drag_reorder.clear_selection(true);this.row_drag_reorder.select_version_div(version_div);this.scroll_into_view(version_div);},select_last_version:function()
{var container=this.get_container();var version_divs=sg_find_all('div.version',container.dom);if(!version_divs||version_divs.length==0)return;var version_div;for(var i=version_divs.length-1;i>=0;i--)
{var version_div=Ext.get(version_divs[i]);if(version_div.hasClass('no_version_in_playlist'))
version_div=null;else
break;}
if(!version_div)return;this.row_drag_reorder.clear_selection(true);this.row_drag_reorder.select_version_div(version_div);this.scroll_into_view(version_div);},scroll_into_view:function(version_div)
{var container=this.get_container();if(container.dom.scrollHeight<=container.dom.clientHeight)return;var ver_top=version_div.getTop()+container.dom.scrollTop-container.getTop();var height=container.getHeight();var ver_height=version_div.getHeight();var to_middle=Math.floor((height-ver_height)/2.0);var y=ver_top-to_middle;if(y>container.dom.scrollHeight)y=container.dom.scrollHeight;container.scrollTo('top',y,true);},edit_last_selected_version:function()
{var version_div=this.get_last_selected_version_div();if(!version_div)return;version_div=Ext.get(version_div);var content_cell=version_div.child('textarea');content_cell.dom.focus();},edit_draft:function(draft_id){var container=this.get_container();var draft_content_div=sg_find('div.draft_content_wrapper[draft_id="'+draft_id+'"]',container.dom);if(!draft_content_div)return;draft_content_div=Ext.get(draft_content_div);var content_cell=draft_content_div.child('textarea');content_cell.dom.focus();},get_container:function()
{var container=this.widget.get_container().child("div#sgc_notes_app_drafts");return container;},render:function(dont_construct_note_addressings)
{this.widget.loft_all_note_widget_containers();this.loft_all_note_forms();this.widget.now_rendering_drafts=true;var version_rec,draft_rec,draft_html,i,j;var container=this.get_container();this.construct_drag_components(container);this.add_event(container,'scroll',this.on_scroll,this);if(this.version_data_set.records.length==0)
{container.dom.innerHTML=this.templates.no_versions.apply({});this.widget.now_rendering_drafts=false
return;}
this.cell_manager.record_tab_order=[];this.cell_manager.record_tab_order_skip=[];var drafts_by_version={};var orphaned_drafts=[];for(i=0;i<this.draft_data_set.records.length;i++)
{draft_rec=this.draft_data_set.records[i];if(draft_rec.state=="retired")
continue;var note_links=draft_rec.get('note_links');if(!note_links)
{if(!this.widget.is_shared_header_rec(draft_rec))
orphaned_drafts.push(draft_rec);continue;}
var found_parent_version=false;var parent_version;for(j=0;j<note_links.length;j++)
{if(note_links[j].type=='Version')
{if(!drafts_by_version[note_links[j].id])
drafts_by_version[note_links[j].id]=[draft_rec];else
drafts_by_version[note_links[j].id].push(draft_rec);if(parent_version=this.version_data_set.get_record_by_id(note_links[j].id))
{if(this.version_data_set.fast_removed.indexOf(parent_version.id)==-1)
found_parent_version=true;}}}
if(!found_parent_version&&!this.widget.is_shared_header_rec(draft_rec))
orphaned_drafts.push(draft_rec);}
var versions=[];var draft_recs_rendered={};var new_dummy_draft_recs=[];var dummy_draft_parent_versions=[];var drafts,version_hash;for(i=0;i<this.version_data_set.records.length;i++)
{version_rec=this.version_data_set.records[i];if(this.version_data_set.fast_removed.indexOf(version_rec.id)>-1)
continue;drafts=drafts_by_version[version_rec.id];versions.push(this.render_version(i+1,version_rec,drafts,this.cell_manager.record_tab_order,this.cell_manager.record_tab_order_skip,new_dummy_draft_recs,dummy_draft_parent_versions,draft_recs_rendered));}
var orphaned_version_ids=[];container.update(this.templates.drafts.apply({drafts:versions.join('')}));if(this.last_scroll_top)
{container.dom.scrollTop=this.last_scroll_top;this.last_scroll_top=container.dom.scrollTop;}
if(new_dummy_draft_recs.length>0){var widget=this.widget;setTimeout(function(){widget.show_loading_overlay();},0);this.create_dummy_drafts(new_dummy_draft_recs,dummy_draft_parent_versions);}
else
this.widget.now_rendering_drafts=false;if(orphaned_version_ids.length>0)
this.widget.load_orphan_versions_only(orphaned_version_ids);this.widget.render_all_note_widgets();this.replace_all_lofted_note_forms();if(!dont_construct_note_addressings)
this.construct_and_render_all_note_addressings();else
this.re_render_all_note_addressings();},re_render_all_note_addressings:function(){for(var draft_id in this.note_addressings){if(!this.note_addressings.hasOwnProperty(draft_id))continue;var na=this.note_addressings[draft_id];na.render();}},construct_and_render_all_note_addressings:function(){var container=this.get_container();var draft_adressings_divs=sg_find_all('div.sgc_note_addressings',container.dom);for(var i=0;i<draft_adressings_divs.length;i++){var div=Ext.get(draft_adressings_divs[i]);var draft_id=Number(div.dom.getAttribute('draft_id'));this.construct_and_render_note_addressing_for_draft(draft_id);}},construct_and_render_note_addressing_for_draft:function(draft_id){if(Number(draft_id)<0)return;if(!this.note_addressings)this.note_addressings={};var summary_mode=false;if(this.note_addressings[draft_id]){var na=this.note_addressings[draft_id];summary_mode=na.summary_mode;na.destroy();delete this.note_addressings[draft_id];}
var rec=this.draft_data_set.get_record_by_id(draft_id);var new_na=new SG.NoteAdressings({owner:this,container_selector:'div.sgc_note_addressings[draft_id="'+draft_id+'"]',summary_mode:summary_mode,owner_data_set:this.draft_data_set,record_id:draft_id});new_na.set_tasks(rec.get('tasks'),rec.get('addressings_to'));this.note_addressings[draft_id]=new_na;},destroy_all_note_addressings:function(){if(!this.note_addressings)return;for(var draft_id in this.note_addressings){if(!this.note_addressings.hasOwnProperty(draft_id))continue;var na=this.note_addressings[draft_id];na.destroy();}},render_notes_widget:function(version_id){var widget=this.widget.get_notes_widget_for_version(version_id);var are_version_fields=this.version_fields&&this.version_fields.length>0;var template=are_version_fields?this.templates.notes_widget_with_fields:this.templates.notes_widget;return template.apply({widget_id:widget.get_container_id(),widget_class:widget.get_css_class_name()});},render_thumb:function(version_rec)
{if(version_rec.get('image')){if(!this.version_cell_manager)
this.construct_version_cell_manager();var cell=this.version_cell_manager.get_cell('image');cell.render_contextmenu_overlay=false;cfg=cell.render(version_rec);return this.templates.thumb.apply(cfg);}else{return this.templates.empty_thumb.apply({});}},spot_rerender_version_data:function(version_data_set)
{var container=this.get_container();for(var i=0;i<version_data_set.records.length;i++)
{var version_rec=version_data_set.records[i];version=Ext.get(container.child('div.version[record_id='+version_rec.id+']'));if(!version){continue;}
var version_code=version.child('div.version_code');version_code.dom.innerHTML=version_rec.get('code');var version_thumb=version.child('div.version_thumb');version_thumb.dom.innerHTML=this.render_thumb(version_rec);}},render_version:function(order_number,version_rec,drafts,draft_ids,draft_id_skips,new_dummy_draft_recs,dummy_draft_parent_versions,draft_recs_rendered)
{other_user_draft_ids=[];other_user_draft_id_skips=[];var my_drafts_count=0;if(drafts)
{for(var j=0;j<drafts.length;j++)
{if(!drafts[j].get('updated_by')||drafts[j].get('updated_by').id==SG.globals.current_user.id)
my_drafts_count++;}}
else
drafts=[];if(my_drafts_count==0)
{var version_hash={type:'Version',id:version_rec.id,name:version_rec.get('code')};draft_rec=this.draft_data_set.new_record();draft_rec.set('playlist',this.playlist);draft_rec.set('project',version_rec.get('project'));draft_rec.set('note_links',[version_hash]);drafts.push(draft_rec);my_drafts_count=1;new_dummy_draft_recs.push(draft_rec);dummy_draft_parent_versions.push(version_hash);}
draft_html=[];other_author_draft_html=[];for(j=0;j<drafts.length;j++)
{if(draft_recs_rendered[drafts[j].id])
{continue;}
else
{draft_recs_rendered[drafts[j].id]=true;}
draft_rec=drafts[j];cell_type=SG.LargeTextAreaCell;cell=this.cell_manager.get_cell('content',{type:cell_type});cell.autocommit=true;cell_hash=cell.render(draft_rec);cell_hash.right=Ext.isGecko?13:14;cell_hash.draft_id=draft_rec.id;cell_hash.draft_buttons=this.templates.draft_buttons.apply({draft_id:draft_rec.id,alone:(my_drafts_count==1)?'alone':''});var updated_by=draft_rec.get('updated_by');if(updated_by&&updated_by.id!=SG.globals.current_user.id)
{if(this.widget.has_content(draft_rec)){cell_hash.author_name=updated_by.name;var updated=Date.sgParseDateTime(draft_rec.get('updated_at'));cell_hash.elapsed_time_phrase=elapsed_time_phrase(updated);other_author_draft_html.push(this.templates.draft_by_other_author.apply(cell_hash));other_user_draft_ids.push(draft_rec.id);other_user_draft_id_skips.push(false);}else{draft_ids.push(draft_rec.id);draft_id_skips.push(true);}}
else
{draft_html.push(this.templates.draft.apply(cell_hash));draft_ids.push(draft_rec.id);draft_id_skips.push(false);}}
for(var i=0;i<other_user_draft_ids.length;i++)
{draft_ids.push(other_user_draft_ids[i]);draft_id_skips.push(other_user_draft_id_skips[i]);}
var are_version_fields=this.version_fields&&this.version_fields.length>0;var template=are_version_fields?this.templates.version_with_fields:this.templates.version;return template.apply({reorder_handle:this.templates.reorder_handle.apply({order:order_number}),extra_classes:this.is_selected(version_rec.id)?'selected':'',version_id:version_rec.id,code:version_rec.get('code'),thumb:version_rec?this.render_thumb(version_rec):'',drafts:draft_html.join('')+other_author_draft_html.join(''),notes_widget:this.render_notes_widget(version_rec.id),fields:are_version_fields?this.render_version_fields(version_rec.id):'',});},render_version_fields:function(version_id){if(!this.version_cell_manager)
this.construct_version_cell_manager();var rec=this.version_data_set.get_record_by_id(version_id);var html='';for(var i=0;i<this.version_fields.length;i++){var col=this.version_fields[i];var cell=this.version_cell_manager.get_cell(col);var cfg=cell.render(rec);html+=this.templates.field.apply(cfg);}
return html;},construct_version_cell_manager:function(){var cell_config={container:this.widget.get_container(),data_set:this.version_data_set,projects:this.widget.context_projects(),field_property_callback:{fn:this.get_version_field_property,scope:this}};this.version_cell_manager=this.new_component(SG.CellManager,cell_config);},get_version_field_property:function(schema_field){return{show_label:false};},update_rendered_record_ids:function(records)
{var selector;for(var i=0;i<records.length;i++)
{if(records[i].pre_commit_id<0&&records[i].id>0)
{selector='div.draft_content[record_id="'+records[i].pre_commit_id+'"]';draft_dom=sg_find(selector,this.get_container().dom);if(draft_dom)
draft_dom.setAttribute('record_id',records[i].id);selector='div[draft_id="'+records[i].pre_commit_id+'"]';doms=sg_find_all(selector,this.get_container().dom);for(var j=0;j<doms.length;j++)
{doms[j].setAttribute('draft_id',records[i].id);}
var tab_order=this.cell_manager.record_tab_order;var index=tab_order.indexOf(records[i].pre_commit_id);if(index>-1)
tab_order[index]=records[i].id;var old_id=records[i].pre_commit_id;var new_id=records[i].id;this.construct_and_render_note_addressing_for_draft(new_id);}}},on_scroll:function(e)
{if(e.target.id=='sgc_notes_app_drafts')
this.last_scroll_top=e.target.scrollTop;},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.hasClass('draft_actions'))
{var draft_id=Number(t.dom.getAttribute('draft_id'));if(draft_id<0)return;this.show_draft_action_menu(draft_id,t.dom);return;}
if(t.hasClass('draft_add'))
{this.add_draft(t.dom.getAttribute('draft_id'));return;}
var container=this.get_container();var note_addressings=t.findParent('div.sgc_note_addressings',container.dom);if(!note_addressings)
note_addressings=t.findParent('div.arrow_closed_dark',container.dom);if(note_addressings&&note_addressings.hasAttribute('draft_id')){var draft_id=note_addressings.getAttribute('draft_id');if(Number(draft_id)<0)return;this.toggle_new_note_form_for_draft(draft_id);return;}
var close_note_form=t.findParent('div.arrow_open_dark',container.dom);if(close_note_form){var draft_id=Number(close_note_form.getAttribute('draft_id'));this.toggle_new_note_form_for_draft(draft_id);return;}},show_draft_action_menu:function(draft_id,dom_elem)
{if(this.draft_action_menu&&this.draft_action_menu.is_showing()&&this.draft_action_menu.draft_id==draft_id)
{this.draft_action_menu.hide();return;}
var draft_rec=this.draft_data_set.get_record_by_id(draft_id);var alone=dom_elem.hasAttribute('alone');var no_content=!draft_rec.get('content');var other_author=Ext.get(dom_elem).findParent('div.other_author');var items=[{html:"Send Note now...",value:'send_note',disabled:no_content,draft_id:draft_id,item_selected:{fn:this.on_send_note_now,scope:this}}];if(alone&&!other_author)
{items.push({html:"Clear Note",value:'clear_note',disabled:no_content});}
else
{items.push({html:"Delete Note",value:'delete_note'});}
var container=this.get_container();var version_row=Ext.get(dom_elem).findParent('tr.no_version_in_playlist',container);items.push({html:"Remove Version",value:'remove_version',disabled:(version_row!=null)});this.draft_action_menu=new SG.Menu({draft_id:draft_id,items:items,position:{dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'},item_selected:{fn:this.on_draft_action_selected,scope:this}});this.draft_action_menu.render();this.draft_action_menu.show();},on_send_note_now:function(menu,item)
{var draft_record=this.draft_data_set.get_record_by_id(item.draft_id);var record=new SG.Data.Record('Note');draft_record.copy_onto(record);var container=this.get_container();var draft_div=sg_find('div.draft_content_wrapper[draft_id="'+item.draft_id+'"]',container.dom)
draft_div=Ext.get(draft_div);var version_div=draft_div.findParent('div.version',container.dom);var version_id=Number(version_div.getAttribute('record_id'));var version_rec=this.version_data_set.get_record_by_id(version_id);var version={type:'Version',id:version_rec.id,name:version_rec.get('code'),valid:'valid'};var config={entity_type:'Note',parent_entity:version,grandparent_entity:this.playlist,data_record:record,};this.send_note_now_draft_id=item.draft_id;this.send_note_now_version_id=version_rec.id;var factory=new SG.EntityFactory(config);this.add_event(factory,"done",this.display_new_note_dialog_for_send_note_now);factory.create();},display_new_note_dialog_for_send_note_now:function(data_record)
{var draft_record=this.draft_data_set.get_record_by_id(this.send_note_now_draft_id);this.copy_tasks_and_add_project(draft_record,data_record);var config={entity_type:'Note',single_project:this.widget.single_project_from_context()||data_record.get('project'),all_projects:this.widget.context_projects(),source_record:data_record,parent_entity:this.playlist,};var dialog=new SG.NewNoteDialog(config);this.add_event(dialog,"entity_created",this.on_send_note_now_created);},copy_tasks_and_add_project:function(source_record,dest_record){var proj=this.widget.single_project_from_context();var tasks=source_record.get('tasks');var new_tasks=[];for(var i=0;i<tasks.length;i++){var task=tasks[i];task.project_id=proj.id;new_tasks.push(task);}
dest_record.set('tasks',new_tasks);},on_send_note_now_created:function(new_records)
{var draft_record=this.draft_data_set.get_record_by_id(this.send_note_now_draft_id);draft_record.retire();var notes_widget=this.widget.get_notes_widget_for_version(this.send_note_now_version_id);notes_widget.notes_set.prepend_record(new_records[0]);notes_widget.render_widget();this.render();draft_record.commit();},on_draft_action_selected:function(menu,item)
{var draft_rec=this.draft_data_set.get_record_by_id(menu.draft_id);if(item.value=='send_note')
{alert("Coming soon!");}
else if(item.value=='clear_note'||item.value=='delete_note')
{var word=item.value=='clear_note'?' clear ':' delete ';var message="Are you sure you want to"+word+"this note ?";if(!confirm(message))return;this.delete_any_note_addressings_and_note_forms_for_draft(draft_rec.id);draft_rec.retire();this.render();draft_rec.commit();}
else if(item.value=='remove_version')
{this.unlink_versions_for_drafts([draft_rec]);}},add_draft:function(draft_id)
{var draft_rec=this.draft_data_set.get_record_by_id(draft_id);var version_rec=this.get_version_rec_for_draft(draft_rec);if(!version_rec)return;var version_hash={type:'Version',id:version_rec.id,name:version_rec.get('code')};var new_draft_rec=this.draft_data_set.new_record();new_draft_rec.set('playlist',this.playlist);new_draft_rec.set('project',draft_rec.get('project'));new_draft_rec.set('note_links',[version_hash]);this.render(true);var widget=this.widget;setTimeout(function(){widget.show_loading_overlay();},0);this.create_dummy_drafts([new_draft_rec],[version_hash]);},get_version_rec_for_draft:function(draft_rec)
{var note_links=draft_rec.get('note_links');if(!note_links)
return null;var version_rec,version_hash;for(var j=0;j<note_links.length&&!version_rec;j++)
{if(note_links[j].type=='Version')
{version_hash=note_links[j];version_rec=this.version_data_set.get_record_by_id(version_hash.id);}}
if(version_rec)
return version_rec;else
return null;},unlink_versions_for_drafts:function(draft_recs)
{var version_recs=[];for(var i=0;i<draft_recs.length;i++)
{draft_rec=draft_recs[i];var version_rec=this.get_version_rec_for_draft(draft_rec);if(version_rec)
version_recs.push(version_rec);}
this.unlink_versions(version_recs);},unlink_versions:function(draft_versions)
{var draft_rec,selected_index;for(var i=0;i<draft_versions.length;i++)
{draft_versions[i].multi_entity_set('playlists',[this.playlist],'remove');this.version_data_set.fast_removed.push(draft_versions[i].id);if(this.selected_versions){selected_index=this.selected_versions.indexOf(draft_versions[i].id);if(selected_index>-1)
this.selected_versions.splice(selected_index,1);}}
this.version_data_set.commit(true);for(var i=0;i<draft_versions.length;i++)
{for(var j=0;j<this.draft_data_set.records.length;j++)
{draft_rec=this.draft_data_set.records[j];var version_rec_for_draft=this.get_version_rec_for_draft(draft_rec);if(version_rec_for_draft&&draft_versions[i].id==version_rec_for_draft.id)
{var updated_by=draft_rec.get('updated_by');if(!updated_by||updated_by.id==SG.globals.current_user.id)
{draft_rec.retire();}}}}
this.render();this.draft_data_set.commit(true);this.widget.update_footer();if(this.selected_versions)
this.on_entities_selected(this.selected_versions);},on_cell_edit:function(cell_edit_context)
{var cell=Ext.get(cell_edit_context.cell_elem);var version_div=cell.findParent('div.version',this.widget.get_container(),true);if(version_div)
{this.row_drag_reorder.clear_selection(true);this.row_drag_reorder.select_version_div(version_div);return;}},create_dummy_drafts:function(new_dummy_draft_recs,dummy_draft_parent_versions)
{var grandparent_entities=[];for(var i=0;i<new_dummy_draft_recs.length;i++)
grandparent_entities.push(this.playlist);var factory=new SG.MultiEntityFactory({entity_type:'Note',data_records:new_dummy_draft_recs,parent_entities:dummy_draft_parent_versions,grandparent_entities:grandparent_entities,});factory.on('done',this.update_dummy_drafts,this);factory.create();},update_dummy_drafts:function(records)
{for(var i=0;i<records.length;i++)
{var draft_rec=records[i];var note_links=sg_deep_copy(draft_rec.get('note_links'));draft_rec.set('note_links',note_links);draft_rec.set('subject','');if(!draft_rec.get('content'))
draft_rec.set('content','');draft_rec.commit(true);}},select_all:function()
{this.row_drag_reorder.select_all();},toggle_new_note_form_for_draft:function(draft_id){var container=this.get_container();var draft_record=this.draft_data_set.get_record_by_id(draft_id);var draft_content_div=sg_find('div.draft_content_wrapper[draft_id="'+draft_id+'"]');draft_content_div=Ext.get(draft_content_div);if(this.note_forms&&this.note_forms[draft_id]){var form=this.note_forms[draft_id];form.destroy();delete this.note_forms[draft_id];var draft_controls=sg_find('div.draft_controls[draft_id="'+draft_id+'"]');var cell=this.cell_manager.get_cell('content',{type:SG.LargeTextAreaCell});var cfg=cell.render(draft_record);cfg.draft_id=draft_id;cfg.right=Ext.isGecko?13:14;var html=this.templates.draft_content_wrapper.apply(cfg);Ext.DomHelper.insertAfter(draft_controls,html);if(this.note_addressings&&this.note_addressings[draft_id]){var na=this.note_addressings[draft_id];na.set_summary_mode(false);}
return;}
draft_content_div.remove();this.construct_note_form_for_draft(draft_id);if(this.note_addressings&&this.note_addressings[draft_id]){var na=this.note_addressings[draft_id];na.set_summary_mode(true);}},loft_all_note_forms:function(){if(!this.note_forms)return;this.note_form_containers={};var count=0;for(var draft_id in this.note_forms){if(!this.note_forms.hasOwnProperty(draft_id))continue;var form=this.note_forms[draft_id];if(!form)continue;var container=form.container.dom;var p=container.parentNode;if(p){var keep=p.removeChild(container);this.note_form_containers[draft_id]=keep;}else{console.log('PROBLEM ! no container for note_form %d',draft_id);}
count++;}},replace_all_lofted_note_forms:function(){if(!this.note_form_containers)return;var to_remove=[];for(var draft_id in this.note_form_containers){if(!this.note_form_containers.hasOwnProperty(draft_id))continue;var draft_content_div=sg_find('div.draft_content_wrapper[draft_id="'+draft_id+'"]');if(!draft_content_div){to_remove.push(draft_id);}else{draft_content_div=Ext.get(draft_content_div);var note_form_container=this.note_form_containers[draft_id];var p=draft_content_div.dom.parentNode;p.insertBefore(note_form_container,draft_content_div.dom);draft_content_div.remove();}}
for(var i=0;i<to_remove.length;i++){var draft_id=to_remove[i];var form=this.note_forms[draft_id];form.destroy();delete this.note_forms[draft_id];delete this.note_form_containers[draft_id];if(this.note_addressings&&this.note_addressings[draft_id]){var na=this.note_addressings[draft_id];na.destroy();delete this.note_addressings[draft_id];}}},delete_any_note_addressings_and_note_forms_for_draft:function(draft_id){if(this.note_forms&&this.note_forms[draft_id]){var form=this.note_forms[draft_id];form.destroy();delete this.note_forms[draft_id];}
if(this.note_addressings&&this.note_addressings[draft_id]){var na=this.note_addressings[draft_id];na.destroy();delete this.note_addressings[draft_id];}},construct_note_form_for_draft:function(draft_id){var draft_controls=sg_find('div.draft_controls[draft_id="'+draft_id+'"]');var html=this.templates.draft_content_wrapper_empty.apply({draft_id:draft_id});var container=Ext.DomHelper.insertAfter(draft_controls,html,true);var config={entity_type:'Note',single_project:this.widget.single_project_from_context(),all_projects:this.widget.context_projects(),container:container,source_record:this.draft_data_set.get_record_by_id(draft_id),visible_fields:['tasks','content'],hide_project_selector:true,hide_fields_with_default_values:false,edit_source_record_mode:true,source_record_data_set:this.draft_data_set,no_attachments:true,autocommit:true,notes_app_layout:true};var form=new SG.NewNoteDialog(config);if(!this.note_forms)this.note_forms={};this.note_forms[draft_id]=form;Ext.DomHelper.append(container,this.templates.note_form_decoration.apply({draft_id:draft_id,right:Ext.isGecko?-1:0}));},});SG.NotesApp.VersionPane=function(config){Ext.apply(this,config);SG.NotesApp.VersionPane.superclass.constructor.call(this);};Ext.extend(SG.NotesApp.VersionPane,SG.Component,{templates:{page_container:'<div class="sg_page inside_pane" id="{default_page_id}"></div>',loading:'<div class="loading">Loading...</div>',},init_component:function(config)
{},load:function()
{if(this.page)
this.page.destroy_root_widget();if(!this.container_id)
this.container_id='sgc_notes_app_version_pane';this.show_loading();var options={url:'/page/notes_app_version_pane',params:{page_id:this.layout_id},callback:function(options,success,response){if(success){var page;eval("page = "+response.responseText);page.config.parent_page=this.widget.get_page();page.context.in_pane=true;page.context.entity=this.version_linked_entity;page.context.entity_project=this.project;page.context.title_options={skip_add_note:true,version_filter_playlist:this.playlist};var header=page.settings.children.body.children.row_1.children.header;header.settings.version_id=this.version_id;this.init_page(page);}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},init_page:function(page_config)
{var container=this.widget.get_container().child("div#"+this.container_id);container.dom.innerHTML=this.templates.page_container.apply({default_page_id:'sg_page_'+page_config.config.id});this.page=new SG.Page(page_config.config,page_config.context,page_config.settings);this.page.enable_detail_links=true;if(this.page_init_callback)
this.page_init_callback.fn.call(this.page_init_callback.scope);},show_loading:function()
{var container=this.widget.get_container().child("div#"+this.container_id);container.dom.innerHTML=this.templates.loading.apply({});}});SG.NotesApp.PlaylistHistory=function(config)
{Ext.apply(this,config);SG.NotesApp.PlaylistHistory.superclass.constructor.call(this);};SG.NotesApp.PlaylistHistory.get_filters=function(playlist_hash)
{filters={logical_operator:'or',conditions:[{logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[playlist_hash]},{path:'attribute_name',relation:'is_not',values:['notes']}]},{logical_operator:'and',conditions:[{path:'entity.PlaylistVersionConnection.playlist',relation:'is',values:[playlist_hash]},{path:'attribute_name',relation:'is',values:['sg_sort_order']}]},]};return filters;};Ext.extend(SG.NotesApp.PlaylistHistory,SG.Component,{templates:{container:'<div class="sgw_playlist_history" style="height: {height}px; width: {width}px;">'+'<div class="header">Playlist History'+'<div class="right_controls">'+'<div class="refresh_button"></div>'+'<div class="close_overlay_x"></div></div>'+'</div>'+'<div class="header_shadow"></div>'+'<div class="body"><div class="loading">Loading...</div></div>'+'<div class="footer"><div class="footer_shadow"></div></div>'+'</div>',events:'<div class="table"><table>{events}</table></div>',event:'<tr class="event {first}"><td class="user_thumb">{user_thumb}</td>'+'<td class="info"><div class="user_name">{user_name}</div>'+'<div><span class="event_type {event_type_class}">{event_type}</span>{description}</div></td>'+'<td class="time">{time}</td></tr>'},init_component:function()
{this.event_data_set=this.new_data_set('EventLogEntry',this.on_event_load);this.render_container();this.render();this.add_event(this.container,'click',this.on_click);},hide:function()
{if(this.container)
this.container.hide();if(this.shadow)
this.shadow.hide();},render_container:function()
{var height=Math.min(700,Ext.lib.Dom.getViewHeight()-100);var width=Math.min(550,Ext.lib.Dom.getViewWidth()-80);this.container=this.templates.container.append(document.body,{playlist_name:this.playlist.name,height:height,width:width},true);this.body=this.container.child('div.body');this.header=this.container.dom.firstChild;var dd=new Ext.dd.DDProxy(this.container,"playlist_history",{scroll:false});dd.setHandleElId(this.header);dd.playlist_history=this;dd.startDrag=function()
{this.constrainTo(Ext.get(document.body));var drag_elem=this.getDragEl();Ext.fly(drag_elem).setStyle({border:'2px solid rgb(150,150,150)','z-index':'10001',});this.playlist_history.shadow.hide();};dd.afterDrag=function(){this.playlist_history.shadow.show(this.playlist_history.container);};var resizer=new Ext.Resizable(this.container,{handles:'se',minWidth:width,minHeight:height,width:width,height:height,pinned:true});},render:function()
{if(!this.container)
this.render_container();if(this.event_data_set.loaded)
{this.body.dom.innerHTML=this.render_contents();}
else
{this.fetch_data();}
if(!this.rendered_once)
this.center_dialog();this.rendered_once=true;if(!this.shadow&&!this.non_volatile)
this.shadow=new Ext.Shadow({mode:'sides'});if(this.shadow)
this.shadow.show(this.container);this.container.show();this.hide_loading_overlay();},center_dialog:function()
{this.container.setXY(this.container.getCenterXY(true));},render_contents:function()
{var events=[];this.prev=null;for(var i=0;i<this.event_data_set.records.length;i++)
{var rec=this.event_data_set.records[i];events.push(this.render_event(rec,(i==0)));}
return this.templates.events.apply({events:events.join('')});},render_event:function(rec,is_first)
{var user_name=rec.get('user').name;var entity=rec.get('entity');var event_type=rec.get('event_type');var field=rec.get('attribute_name');var meta=rec.get('meta');var date=Date.sgParseDateTime(rec.get('created_at'));date=SG.GridEditor.DateTimeParser.friendly(date);var event_type_class='';var event_type_desc='';var description='';var arr;if(event_type=='Shotgun_Playlist_Change'&&field=='versions')
{if(meta.added&&meta.added.length>0)
{event_type_desc='Added Version: ';event_type_class='add';arr=[];for(var i=0;i<meta.added.length;i++)
arr.push(meta.added[i].name);description+=arr.join(', ');}
if(meta.removed&&meta.removed.length>0)
{event_type_desc='Removed Version: ';event_type_class='remove';arr=[];for(var i=0;i<meta.removed.length;i++)
arr.push(meta.removed[i].name);description+=arr.join(', ');}}
else if(event_type=='Shotgun_PlaylistVersionConnection_Change'&&field=='sg_sort_order')
{if(this.prev&&this.prev.event_type==event_type&&this.prev.field==field&&this.prev.user_name==user_name&&this.prev.date==date)
return'';event_type_desc='Changed Custom Sort Order ';event_type_class='sort';description='';}
else
{description=rec.get('description');}
this.prev={event_type:event_type,field:field,user_name:user_name,date:date}
return this.templates.event.apply({user_thumb:SG.Renderers.image.render(rec.get('user.HumanUser.image')),user_name:user_name,description:description,event_type:event_type_desc,event_type_class:event_type_class,time:date,first:(is_first?'first':'')});},on_event_load:function()
{this.render();},fetch_data:function()
{this.show_loading_overlay();var filters=SG.NotesApp.PlaylistHistory.get_filters(this.playlist);spec={type:'EventLogEntry',filters:filters,columns:['entity','created_at','user','description','event_type','attribute_name','user.HumanUser.image','meta'],sorts:[{column:'created_at',direction:'desc'}],result:this.event_data_set};SG.Repo.query(spec);},on_click:function(e)
{var t=Ext.get(e.getTarget());if(t.hasClass('close_overlay_x'))
{this.hide();this.destroy();}
else if(t.hasClass('refresh_button'))
{this.fetch_data();}},show_loading_overlay:function()
{var id="playlist_history_loading_overlay";if(!this.__overlay_template_div__&&!(this.__overlay_template_div__=Ext.get('playlist_history_loading_overlay')))
{var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(Ext.get(document.body),overlay_html,true);}
this.__overlay_template_div__.alignTo(this.container,"tl-tl");this.__overlay_template_div__.setWidth(this.container.getWidth());this.__overlay_template_div__.setHeight(this.container.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function()
{if(this.__overlay_template_div__)
{this.__overlay_template_div__.hide();}},});SG.NotesApp.VersionPaneHeader=function(context,widget_spec,id){SG.NotesApp.VersionPaneHeader.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.VersionPaneHeader,SG.Widget.Base,{default_settings:{version_id:1,columns:['user.HumanUser.image','image','code','description','user','created_at'],user_columns:['user.HumanUser.name'],state:'small',},small_columns:['user.HumanUser.image','image','code','description'],read_only_columns:['user.HumanUser.image','image','code','description','user.HumanUser.name'],templates:{main:'<div class="sgw_version_pane_header {state}">'+'<table class="main"><tr><td class="version_thumb"><div class="wrapper">{version_image}'+'<div class="expand"></div></div></td>'+'<td class="center_fields"><div class="fields">{fields}</div>'+'<div class="more_fields"><span class="more_fields">More fields...</span></div></td>'+'<td class="created_by_thumb">{created_by_image}{user_fields}'+'<div class="more_fields"><span class="more_user_fields">More fields...</span></div>'+'</td></tr></table></div>',field:'<div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div>',field_with_label:'<table class="center_field"><tr><td class="field_label">'+'<div class="field_label" sg_tip="{field_label}" clip_tip="this_node" >{field_label}'+'</div></td><td class="field_value"><div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div></td></tr></table>',loading:'<div class="loading">Loading...</div>',default_user_image:'<div class="sg_cell"><div class="sg_cell_content">'+'<img class="thumb" src="/images/default_user_thumb.png"></div></div>',missing_thumb_image:'<div class="sg_cell"><div class="sg_cell_content">'+'<img class="thumb" src="/images/missing_image.png"></div></div>',no_data:'<span class="missing_field_data" >{field_name}</span>',},get_summary:null,init_widget:function()
{this.data_set=this.new_data_set('Version',this.on_data_load);},on_first_render:function()
{this.container=this.get_container();var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects(),field_property_callback:{fn:this.get_version_field_property,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,'click',this.on_click);SG.globals.version_pane_header_widget=this;var me=this;this.load_proxy=function(e){me.post_resized.call(me,e)};this.container.dom.addEventListener('load',this.load_proxy,true);},get_version_field_property:function(schema_field){return{show_label:false};},hide_version_widget_loading_overlay:function()
{var version_fields_widget=this.get_child('version_fields');if(version_fields_widget)
{version_fields_widget.hide_loading_overlay();}},render_widget:function()
{if(!this.data_set.is_loaded()){this.container.update(this.templates.loading.apply({}));this.request_data();return;}
var record=this.data_set.records[0];var columns=this.get('columns');var cell,cfg,version_image,created_by_image;var fields='';var user_fields='';for(var i=0;i<columns.length;i++)
{var col=columns[i];if(this.read_only_columns.indexOf(col)>-1)
cell=this.cell_manager.get_cell(col,{read_only:true});else
cell=this.cell_manager.get_cell(col)
cfg=cell.render(record);if(col=='user.HumanUser.image'){var val=record.get('user.HumanUser.image');if(val)
created_by_image=this.templates.field.apply(cfg);else
created_by_image=this.templates.default_user_image.apply();}
else if(col=='image'){if(this.get('state')==='small')
cfg.cell_classes+=' no_overlay';var val=record.get('image');if(!val||val==518)
version_image=this.templates.missing_thumb_image.apply();else
version_image=this.templates.field.apply(cfg);}
else{if(this.small_columns.indexOf(col)==-1){if(!cfg.cell_classes)
cfg.cell_classes='not_small';else
cfg.cell_classes+=' not_small';}
if(this.read_only_columns.indexOf(col)==-1){cfg.field_label=SG.schema.get_field_display_name('Version',col);fields+=this.templates.field_with_label.apply(cfg);}else{fields+=this.templates.field.apply(cfg);}}}
columns=this.get('user_columns');for(var i=0;i<columns.length;i++){var col=columns[i];if(this.read_only_columns.indexOf(col)>-1)
cell=this.cell_manager.get_cell(col,{read_only:true});else
cell=this.cell_manager.get_cell(col)
cfg=cell.render(record);if(this.small_columns.indexOf(col)==-1){if(!cfg.cell_classes)
cfg.cell_classes='not_small';else
cfg.cell_classes+=' not_small';}
user_fields+=this.templates.field.apply(cfg);}
var html=this.templates.main.apply({state:this.get('state'),version_image:version_image,fields:fields,created_by_image:created_by_image,user_fields:user_fields});this.container.update(html);this.post_resized();this.size_field_name_divs();},size_field_name_divs:function(){if(this.get('state')==='small')return;var divs=sg_find_all('div.field_label',this.container.dom);var largest=0;for(var i=0;i<divs.length;i++){var div=Ext.get(divs[i]);if(div.dom.scrollWidth>div.dom.clientWidth){if(largest<div.dom.scrollWidth)
largest=div.dom.scrollWidth}}
if(largest==0)return;largest=largest+10;if(largest>180)largest=180;var tds=sg_find_all('td.field_label',this.container.dom);for(var i=0;i<tds.length;i++){var td=Ext.get(tds[i]);td.setWidth(largest);}},request_data:function()
{var columns=this.get('columns')
var user_columns=this.get('user_columns');var both=columns.concat(user_columns);var spec={type:'Version',id:this.get('version_id'),columns:both,result:this.data_set};SG.Repo.find(spec);},on_data_load:function()
{this.hide_loading_overlay();this.render();},on_click:function(e)
{var t=Ext.get(e.getTarget());var expand=t.findParent('td.version_thumb',this.container.dom);var overlay=t.findParent('div.launch_movie_overlay.displayed',this.container.dom);var thumb_cell=Ext.get(t.findParent('.sg_cell',this.container.dom));var play_button_clicked=overlay&&!thumb_cell.hasClass('no_overlay')&&t.hasClass('play_button');if(expand&&!play_button_clicked){var main_div=this.container.child('div.sgw_version_pane_header');var cell=this.cell_manager.get_cell('image');if(main_div.hasClass('small')){this.set('state','big');main_div.replaceClass('small','big');thumb_cell.removeClass('no_overlay');}else{this.set('state','small');main_div.replaceClass('big','small');thumb_cell.addClass('no_overlay');}
cell.hide_canvas(thumb_cell);this.post_resized();return;}
var more_fields=t.findParent('span.more_fields',this.container.dom,true);if(more_fields){this.show_more_fields_menu(more_fields);return;}
var more_user_fields=t.findParent('span.more_user_fields',this.container.dom,true);if(more_user_fields){this.show_more_user_fields_menu(more_user_fields);return;}},destroy_widget:function()
{if(SG.globals.version_pane_header_widget==this)
SG.globals.version_pane_header_widget=null;},show_more_fields_menu:function(anchor_elem){if(!this.more_fields_menu){this.more_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return this.read_only_columns.indexOf(field_name)>-1;},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get('columns');return cols.indexOf(field_name)>-1;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
this.more_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_before_show_fields_menu:function(menu){menu.items=this.fields_menu_helper.get_menu_items();menu.render();},toggle_field:function(menu,item){var cols=sg_deep_copy(this.get('columns'));if(item.checked){var idx=cols.indexOf(item.field);cols.splice(idx,1);}else{cols.push(item.field);}
this.set('columns',cols);var center_td=this.container.child('td.center_fields');this.show_loading_overlay(center_td);this.request_data();},show_more_user_fields_menu:function(anchor_elem){if(!this.more_user_fields_menu){this.more_user_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_user_fields_menu,scope:this},});this.user_fields_menu_helper=new SG.util.FieldsMenuHelper({only_simple_fields:true,entity_type:'HumanUser',field_disabled_callback:{fn:function(field_schema,field_name){var fname='user.HumanUser.'+field_name;return(field_name=='image'||this.read_only_columns.indexOf(fname)>-1);},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get('user_columns');var fname='user.HumanUser.'+field_name
return cols.indexOf(fname)>-1;},scope:this},on_field:{fn:this.toggle_user_field,scope:this}});}
this.more_user_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_user_fields_menu.show();},on_before_show_user_fields_menu:function(menu){menu.items=this.user_fields_menu_helper.get_menu_items();menu.render();},toggle_user_field:function(menu,item){var fname='user.HumanUser.'+item.field;var cols=sg_deep_copy(this.get('user_columns'));if(item.checked){var idx=cols.indexOf(fname);cols.splice(idx,1);}else{cols.push(fname);}
this.set('user_columns',cols);var created_by_td=this.container.child('td.created_by_thumb');this.show_loading_overlay(created_by_td);this.request_data();},post_resized:function(){SG.NotificationCenter.post({uuid:'_sg_notes_app_header_resized_',name:'sg_notes_app_header_resized',args:null,canvas_id:null});},});SG.NotesApp.Selection=function(config)
{Ext.apply(this,config);SG.NotesApp.Selection.superclass.constructor.call(this,this.container,"layouts",{dragElId:this.drag_element_proxy_id,resizeFrame:false,scroll:false});this.selected_ids=[];this.last_clicked_version_id=null;this.drag_handle_selector='div.drag_reorder_grip';this.row_element_selector='div.version';this.row_proxy_name_selector='div.version';};Ext.extend(SG.NotesApp.Selection,Ext.dd.DDProxy,{handleMouseDown:function(e)
{var target=Ext.get(e.getTarget());if('textarea'!=target.dom.tagName.toLowerCase())
{if(document.activeElement&&document.activeElement.tagName.toLowerCase()=='textarea')
document.activeElement.blur();}
var was_selection=this.handle_mouse_down_selection(e,target);if(!was_selection)return;this.drag_handle=target.findParent(this.drag_handle_selector,this.container,true);if(this.drag_handle)
{this.last_y=0;this.going_up=false;}
else if(this.select_only_target(target))
{return;}
this.start_y=e.xy[1];this.version_div=target.findParent(this.row_element_selector,this.container,true);this.versions_container=this.version_div.dom.parentNode;this.ctrl_click=this.is_ctrl_click(e);this.shift_click=this.is_shift_click(e);Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},test_for_overlap:function(y,target)
{var top=Math.min(y,this.start_y);var bottom=Math.max(y,this.start_y);return(target.top>bottom||target.bottom<top);},select_only_target:function(target)
{if(['textarea','input'].indexOf(target.dom.tagName.toLowerCase())!==-1)
return true;var draft_controls=target.findParent('.noselect',this.container);if(draft_controls)
return true;return false;},b4StartDrag:function(x,y)
{if(this.drag_handle)
this.b4StartDrag_reorder(x,y);else
this.b4StartDrag_selection(x,y);},b4StartDrag_selection:function(x,y)
{this.drag_el=Ext.get(this.getDragEl());this.drag_el.addClass('selection_drag');this.drag_el.update('');this.cache_selection_targets();Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},cache_selection_targets:function()
{this.targets=[];var elems=sg_find_all('div.version.selectable',this.container.dom);var mod_key=this.ctrl_click||this.shift_click;for(var i=0;i<elems.length;i++)
{var elem=Ext.get(elems[i]);if(!mod_key||(mod_key&&!elem.hasClass('selected')))
{var t={top:elem.getTop(),bottom:elem.getBottom(),elem:elem,selected:false};this.targets.push(t);}}},b4StartDrag_reorder:function(x,y)
{this.cache_regions();this.drag_el=Ext.get(this.getDragEl());this.drag_el.addClass('drag_reorder');var left=this.version_div.getX();var top=this.version_div.getY();this.setDelta(x-left,y-top);var drag_proxy_html=this.drag_proxy_callback.fn.call(this.drag_proxy_callback.scope);this.drag_el.update(drag_proxy_html);this.version_div.hide();Ext.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);if(this.b4_start_drag_callback)
this.b4_start_drag_callback.fn.call(this.b4_start_drag_callback.scope,x,y);},is_scrolling:function()
{return(this.container.dom.clientHeight!=this.container.dom.scrollHeight&&this.container.dom.scrollTop!=0);},get_drag_elem:function()
{return this.version_div;},cache_regions:function(){this.region_cache=[];var i,d;for(i=0;i<this.versions_container.childNodes.length;i++){d=this.versions_container.childNodes[i];this.region_cache.push({y:Ext.lib.Dom.getY(d),elem:d});}},find_elem:function(y){if(y<this.region_cache[0].y)
return this.region_cache[0].elem;for(var i=1;i<this.region_cache.length;i++){if(y<this.region_cache[i].y){return this.region_cache[i-1].elem}}
return this.region_cache[this.region_cache.length-1].elem;},onDrag:function(e)
{if(this.drag_handle)
this.onDrag_reorder(e);else
this.onDrag_selection(e);},onDrag_selection:function(e)
{this.last_y=e.getXY()[1];this.select_under_y(this.last_y);this.check_for_auto_scroll();},select_under_y:function(y)
{for(var i=0;i<this.targets.length;i++)
{var target=this.targets[i];if(this.test_for_overlap(y,target))
{if(target.selected)
{this.unselect_version_div(target.elem,true);target.selected=false;}}
else
{if(!target.selected)
{this.select_version_div(target.elem,true);target.selected=true;}}}},onDrag_reorder:function(e)
{var y=e.getXY()[1];this.check_for_auto_scroll();if(y<this.last_y){this.going_up=true;}else if(y>this.last_y){this.going_up=false;}
var target=this.find_elem(y);if(target){if(this.going_up){this.versions_container.insertBefore(this.version_div.dom,target);}else{this.versions_container.insertBefore(this.version_div.dom,target.nextSibling);}
this.cache_regions();}
this.last_y=y;},check_for_auto_scroll:function()
{if(this.drag_handle)
{var scroll_top=this.container.getTop();var scroll_bottom=scroll_top+this.container.getHeight();var y=this.drag_el.getTop();if(y<scroll_top+30)
{this.drag_el.addClass('scrolling')
this.auto_scroll(true);}
else if(y+this.drag_el.getHeight()>scroll_bottom-30)
{this.drag_el.addClass('scrolling')
this.auto_scroll(false);}
else if(this.drag_el.hasClass('scrolling'))
this.drag_el.removeClass('scrolling');}
else
{if(this.last_y==undefined)return;var scroll_top=this.container.getTop();var scroll_bottom=scroll_top+this.container.getHeight();if(this.container.dom.scrollTop>0&&this.last_y<scroll_top+30)
{this.auto_scroll(true);}
else if(this.container.dom.scrollTop+this.container.getHeight()<this.container.dom.scrollHeight&&this.last_y>scroll_bottom-30)
{this.auto_scroll(false);}}},auto_scroll:function(up)
{var delta=up?-10:10;this.container.dom.scrollTop+=delta;this.start_y-=delta;var me=this;setTimeout(function(){if(!me.drag_handle)
{me.cache_selection_targets();me.select_under_y(me.last_y);}
me.check_for_auto_scroll();},200);},endDrag:function(e)
{if(this.drag_handle)
this.endDrag_reorder(e);else
this.endDrag_selection(e);},endDrag_selection:function(e)
{this.last_y=undefined;this.drag_el.removeClass('selection_drag');this.fire_selection_callback();},endDrag_reorder:function(e)
{this.drag_el.removeClass('drag_reorder');this.version_div.show();this.reorder_callback.fn.call(this.reorder_callback.scope);},clear_selection:function(do_not_fire_selection_callback)
{var all_selected=sg_find_all('.selectable.selected',this.container.dom);for(var i=0;i<all_selected.length;i++)
{var fly=Ext.fly(all_selected[i]);fly.removeClass('selected');}
this.selected_ids=[];if(!do_not_fire_selection_callback)
this.fire_selection_callback();},fire_selection_callback:function()
{this.selection_callback.fn.call(this.selection_callback.scope,this.selected_ids);},handle_mouse_down_selection:function(e,target)
{var version_div=target.findParent('.selectable',10,true);if(!version_div)
return false;var reorder_drag_handle=target.findParent('div.drag_reorder_grip');var ctrl_click=this.is_ctrl_click(e);var shift_click=this.is_shift_click(e);var right_click=this.is_right_click(e);if((!right_click&&!ctrl_click&&!shift_click&&!reorder_drag_handle)||(reorder_drag_handle&&!version_div.hasClass('selected'))||(!this.ignore_right_clicks_for_selection&&right_click))
this.clear_selection(true);if(shift_click)
{this.handle_shift_select(version_div);return true;}
else if(ctrl_click)
{if(version_div.hasClass('selected'))
{this.unselect_version_div(version_div);return false;}
else
{this.select_version_div(version_div);return true;}}
else if(!right_click||!this.ignore_right_clicks_for_selection)
{this.select_version_div(version_div);return true;}
else if(this.ignore_right_clicks_for_selection&&!version_div.hasClass('selected')){this.clear_selection(true);this.select_version_div(version_div);return true;}},select_version_div:function(version_div,do_not_fire_selection_callback)
{version_div.addClass('selected');var record_id=Number(version_div.dom.getAttribute('record_id'));if(this.selected_ids.indexOf(record_id)==-1)
this.selected_ids.push(record_id);if(!do_not_fire_selection_callback)
this.fire_selection_callback();this.last_clicked_version_id=Number(version_div.dom.getAttribute('record_id'));},unselect_version_div:function(version_div,do_not_fire_selection_callback)
{version_div.removeClass('selected');var record_id=Number(version_div.dom.getAttribute('record_id'));var index=this.selected_ids.indexOf(record_id);this.selected_ids.splice(index,1);if(!do_not_fire_selection_callback)
this.fire_selection_callback();this.last_clicked_version_id=null;},is_ctrl_click:function(e)
{var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac||sg_is_in_rv())
ctrl_click=dom_event.ctrlKey;return ctrl_click;},is_shift_click:function(e)
{var dom_event=e.browserEvent;return dom_event.shiftKey;},is_right_click:function(e)
{var dom_event=e.browserEvent;return(dom_event.button==2);},handle_shift_select:function(version_div,do_not_fire_selection_callback)
{if(!this.last_clicked_version_id)
{this.select_version_div(version_div);return;}
var last_div=sg_find('.selectable[record_id="'+this.last_clicked_version_id+'"]');last_div=Ext.get(last_div);var top=Math.min(last_div.getTop(),version_div.getTop());var bottom=Math.max(last_div.getBottom(),version_div.getBottom());var elems=sg_find_all('.selectable',this.container.dom);for(var i=0;i<elems.length;i++)
{var fly=Ext.get(elems[i]);var fly_middle=(fly.getTop()+fly.getBottom())/2.0;var fly_height=fly.getHeight();if(fly_middle>bottom||fly_middle<top)
continue;if(fly_height!=0&&!fly.hasClass('selected'))
this.select_version_div(fly,false);}
if(!do_not_fire_selection_callback)
this.fire_selection_callback();},select_all:function()
{var elems=sg_find_all('.selectable',this.container.dom);for(var i=0;i<elems.length;i++)
{var fly=Ext.get(elems[i]);this.select_version_div(fly,false);}
this.fire_selection_callback();},});SG.NotesApp.ModeSwitcher=function(context,widget_spec,id){SG.NotesApp.ModeSwitcher.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.ModeSwitcher,SG.Widget.Base,{default_settings:{mode:'versions',},templates:{main:'<div class="mode_switcher">'+'<div class="mode_switcher_button versions {versions_selected}" mode="versions">'+'<div class="arrow"></div></div>'+'<div class="mode_switcher_button notes {notes_selected}" mode="notes"><div class="arrow"></div></div>'+'<div class="mode_switcher_button tasks {tasks_selected}" mode="tasks"><div class="arrow"></div></div>'+'</div>'+'<div class="mode_title">{mode_title}</div>'+'<div class="child_widget_content">{child_widget}</div>',child_widget:'<div id="{child_id}" class="{child_class}"></div>',},init_widget:function(){},init_children:function(){},on_first_render:function(){this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.child_widget=this.construct_child(this.get('mode'),this.get_child_context());},render_widget:function(){var mode=this.get('mode');var mode_title='Related Versions';if(mode=='notes')
mode_title='Related Notes';else if(mode=='tasks')
mode_title='Related Tasks';var html=this.templates.main.apply({versions_selected:mode=='versions'?'selected':'',tasks_selected:mode=='tasks'?'selected':'',notes_selected:mode=='notes'?'selected':'',mode_title:mode_title,child_widget:this.templates.child_widget.apply({child_id:this.child_widget.get_container_id(),child_class:this.child_widget.get_css_class_name(),}),});this.container.update(html);this.child_widget.render();},on_click:function(e){var t=Ext.get(e.getTarget());var mode_switcher_button=t.findParent('div.mode_switcher_button',this.container.dom,true);if(mode_switcher_button){var new_mode=mode_switcher_button.dom.getAttribute('mode');var selected_button=this.container.child('div.mode_switcher>div.mode_switcher_button.selected');selected_button.removeClass('selected');mode_switcher_button.addClass('selected');this.set_mode(new_mode);}},set_mode:function(mode){this.child_widget.destroy();this.set('mode',mode);var mode_title_div=this.container.child('div.mode_title');if(mode=='versions')
mode_title_div.update('Related Versions');else if(mode=='notes')
mode_title_div.update('Related Notes');else
mode_title_div.update('Related Tasks');this.child_widget=this.construct_child(mode,this.get_child_context());var html=this.templates.child_widget.apply({child_id:this.child_widget.get_container_id(),child_class:this.child_widget.get_css_class_name(),});var child_container=this.container.child('div.child_widget_content');child_container.update(html);this.child_widget.render();},get_child_context:function(){var child_context=this.context.clone();if(this.get('mode')=='versions'){child_context.set('entity_type','Version');}
return child_context;},destroy_widget:function(){},});SG.NotesApp.VersionCards=function(context,widget_spec,id){SG.NotesApp.VersionCards.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.VersionCards,SG.Widget.EntityQueryMode,{default_settings:{columns:['image','code','user','description','sg_status_list'],records_per_page:25,sorts:[{column:'created_at',direction:'desc'}],notes_filter_mode:'all'},templates:{group_tip:'<div class="group_tip notseltarget" sg_tip="{sg_tip}">'+'<span class="group_tip">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="group_type">{group_type}:</span>'+'<span class="group_name">{group}</span>'+'<span class="group_total">({total})</span></div>',group:'<div class="group {state} {synthetic}" group_idx="{group_idx}">'+'<div class="group_tip_div" count="{count}" depth="{depth}" >{tip}</div>'+'<div class="group_contents">{contents}</div></div>',loading:'<div class="loading">Loading...</div>',version_card:'<div class="version_card" record_id="{record_id}">'+'<table><tr><td class="thumb">{thumbnail}</td><td class="fields">{fields}</td>'+'<td class="notes"><div id="{notes_id}" class="{notes_class}"></div></td></tr></table></div>',field:'<div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div>',toolbar_item:'<div class="notes_filter_mode {selected}" mode="{mode}" >{label}</div>',toolbar_fields_menu:'<span class="label">Fields</span><div class="dropdown_arrow_small"></div>',no_data:'<span class="missing_field_data" >{field_name}</span>',},init_widget:function(){this.entity_type='Version';this.current_page=1;this.data_set=this.new_data_set('Version',this.on_data_load);this.note_widgets=[];},on_first_render:function()
{this.container=this.get_container();var cell_config={container:this.container,data_set:this.data_set,projects:this.context_projects(),field_property_callback:{fn:this.get_version_field_property,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);this.add_event(this.container,'click',this.on_click);this.add_event(this,'context_changed',this.on_context_changed);this.request_data();},get_version_field_property:function(schema_field){return{show_label:false};},render_widget:function()
{if(!this.data_set.is_loaded()){this.container.update(this.templates.loading.apply({}));return;}
var html='';this.grouping=this.get_grouping();if(this.grouping){SG.NotesApp.VersionCards.__card_count__=0;html=this.recursively_render_grouped_cards(this.data_set.groups,0);}else{html=this.render_ungrouped();}
this.container.update(html);this.render_note_widgets();},recursively_render_grouped_cards:function(groups,depth)
{var html='';for(var i=0;i<groups.length;i++){var group=groups[i];if(group.synthetic){var card_count=SG.NotesApp.VersionCards.__card_count__;var content_html=this.recursively_render_grouped_cards(group.groups,depth+1);var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,group.depth,this.grouping,schema_field,schema_field.display_name)
var total=SG.NotesApp.VersionCards.__card_count__-card_count;var tip=this.templates.group_tip.apply({group:display_name,total:total,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'synthetic',group_idx:group.idx,count:total,depth:depth});}else{var content_html='';var grp_recs=group.ids;for(var j=0;j<grp_recs.length;j++){content_html+=this.render_version_card(this.data_set.get_record_by_id(grp_recs[j]));SG.NotesApp.VersionCards.__card_count__++;}
var schema_field=SG.schema.get_field(this.entity_type,this.grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,this.grouping,schema_field,schema_field.display_name)
var tip=this.templates.group_tip.apply({group:display_name,total:grp_recs.length,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'',group_idx:group.idx,count:grp_recs.length,depth:depth});}}
return html;},render_ungrouped:function(){var html='';for(var i=0;i<this.data_set.count();i++){html+=this.render_version_card(this.data_set.get_record(i));}
return html;},render_note_widgets:function(){for(var i=0;i<this.note_widgets.length;i++){var widget=this.note_widgets[i];widget.render();}},render_version_card:function(rec){var notes_id='';var notes_class='';var mode=this.get('notes_filter_mode');if(mode!='none'){var note_context=this.context.clone();note_context.set('filters',this.get_note_widget_filters());note_context.set('entity',{type:'Version',id:rec.id,valid:'valid'});var note_widget=this.construct_child('notes',note_context);this.note_widgets.push(note_widget);notes_id=note_widget.get_container_id();notes_class:note_widget.get_css_class_name();}
var cell=this.cell_manager.get_cell('image',{read_only:true});var cfg=cell.render(rec);var thumbnail=this.templates.field.apply(cfg);var html=this.templates.version_card.apply({thumbnail:thumbnail,fields:this.render_fields(rec),notes_id:notes_id,notes_class:notes_class,record_id:rec.id});return html;},render_fields:function(rec){var fields='';var cell;var columns=this.get('columns');for(var i=0;i<columns.length;i++){var col=columns[i];if(col=='image')continue;cell=this.cell_manager.get_cell(col);var cfg=cell.render(rec);fields+=this.templates.field.apply(cfg);}
return fields;},re_render_fields:function(){for(var i=0;i<this.data_set.count();i++){var record=this.data_set.get_record(i);var version_div=sg_find('div.version_card[record_id="'+record.id+'"]');if(!version_div){var me=this;setTimeout(function(){me.on_data_load();},0);return;}
version_div=Ext.get(version_div);var fields_td=version_div.child('td.fields');fields_td.update(this.render_fields(record));}},get_note_widget_filters:function(){var filters={logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:[{name:'Current Entity',type:'None',id:0,valid:'parent_entity_token'}],active:'true'}]};var mode=this.get('notes_filter_mode');if(mode=='open'){var cond={path:'sg_status_list',relation:'is_not',values:['clsd'],active:true};filters.conditions.push(cond);}else if(mode=='closed'){var cond={path:'sg_status_list',relation:'is',values:['clsd'],active:true};filters.conditions.push(cond);}
return filters;},on_data_load:function(){this.on_entities_loaded();this.hide_loading_overlay();if(this.only_re_render_fields){this.re_render_fields();this.only_re_render_fields=false;return;}
if(this.note_widgets){for(var i=0;i<this.note_widgets.length;i++){var widget=this.note_widgets[i];widget.destroy();}}
this.note_widgets=[];this.render();},on_context_changed:function(key,value){if(key=="filters"||key=="parent_entity"||key=="grouping")
{this.request_data();}},request_data:function(){this.show_loading_overlay();var spec={type:'Version',filters:this.get_filters(),columns:this.get('columns'),sorts:this.get_sorts(),grouping:this.get_grouping(),current_page:this.current_page,records_per_page:this.get('records_per_page'),result:this.data_set};SG.Repo.query(spec);},get_sorts:function(){var settings_sorts=this.get('sorts');if(!settings_sorts||settings_sorts.length==0){var context_sorts=this.context.get('sorts');if(context_sorts)
return sg_deep_copy(context_sorts);}
return settings_sorts;},set_sorts:function(new_sorts){this.set('sorts',new_sorts);this.request_data();},set_data_store_max_records:function(num_recs)
{this.set('records_per_page',num_recs);this.request_data();},set_data_store_page:function(page_num)
{this.current_page=page_num;this.request_data();},reload_all_entities:function()
{this.request_data();},get_entity_data_store:function()
{return this.data_set;},render_note_filter_toolbar_item:function(a,toolbar_item){var mode=this.get('notes_filter_mode');return this.templates.toolbar_item.apply({label:toolbar_item.value,selected:mode==toolbar_item.value.toLowerCase()?'selected':'',mode:toolbar_item.value.toLowerCase(),});},on_note_filter_toolbar_item:function(e,toolbar_div){var div=toolbar_div.child('div.notes_filter_mode');var mode=div.dom.getAttribute('mode');if(mode=='notes:')return;var old_mode=this.get('notes_filter_mode');if(old_mode==mode)return;this.set('notes_filter_mode',mode);this.re_render_toolbar();this.request_data();},re_render_toolbar:function(){var me=this;setTimeout(function(){var parent=me.get_parent();parent.toolbar.render();},0);},get_toolbar_items:function()
{var values=['None','All','Closed','Open','Notes:'];var items=[];var mode=this.get('notes_filter_mode');for(var i=0;i<values.length;i++){var cls='versions_card';if(values[i]=='None')
cls='pad_far_right versions_card hover_state';else if(values[i]!='Notes:')
cls='versions_card hover_state';items.push({position:'right',render_callback:{fn:this.render_note_filter_toolbar_item,scope:this},onclick:{fn:this.on_note_filter_toolbar_item,scope:this},value:values[i],visible_when_small:true,cls:cls});}
items.push({position:'left',html:this.templates.toolbar_sorting_menu.apply(),onclick:{fn:this.on_sort_menu_click,scope:this},oncontextmenu:{fn:this.on_sort_menu_click,scope:this},cls:'action_menu',visible_when_small:true,sg_tip:'Sorting Options'});items.push({position:'left',html:this.templates.toolbar_fields_menu.apply(),onclick:{fn:this.on_click_fields_toolbar_item,scope:this},visible_when_small:true,cls:'action_menu'});return items;},on_sort_menu_click:function(e,toolbar_elem)
{this.sort_menu_toolbar_div=toolbar_elem;if(!this.sort_menu)
{this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this},});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'Version',through_join_fields:this.get_through_join_fields(),parent_entity:this.context.get('parent_entity'),get_sorts_callback:{fn:this.on_get_sorts,scope:this},set_sorts_callback:{fn:this.on_set_sorts,scope:this},});}
this.sort_menu.show();},on_get_sorts:function()
{return this.get('sorts');},on_set_sorts:function(new_sorts)
{this.set('sorts',new_sorts);this.request_data();},on_before_show_sort_menu:function(menu)
{menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=this.sorting_menu_helper.get_menu_items();menu.render();},on_click_fields_toolbar_item:function(e,toolbar_div){this.show_more_fields_menu(toolbar_div);},get_action_menu_items:function(items,target_elem,xy)
{return[];},multi_edit_selected:function()
{alert(this.get('type')+' has not implemented multi_edit_selected()');},on_click:function(e)
{var t=Ext.get(e.getTarget());var group_tip=t.findParent('div.group_tip',this.cards_div,true);if(group_tip)
{var group_div=group_tip.findParent('div.group',this.cards_div,true);var dom_event=e.browserEvent;if(dom_event.altKey)
{if(group_div.hasClass('open'))
this.toggle_all_groups('closed');else
this.toggle_all_groups('open');}
else
{if(group_div.hasClass('open'))
this.close_group(group_div);else
this.open_group(group_div);}}},open_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='open')
return;group_div.replaceClass('closed','open');this.set_group_state(group,'open');},close_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='closed')
return;group_div.replaceClass('open','closed');this.set_group_state(group,'closed');},destroy_widget:function(){},show_more_fields_menu:function(anchor_elem){if(!this.more_fields_menu){this.more_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return field_schema.data_type=='image';},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get('columns');return cols.indexOf(field_name)>-1;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
this.more_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_before_show_fields_menu:function(menu){menu.items=this.fields_menu_helper.get_menu_items();menu.render();},toggle_field:function(menu,item){var cols=sg_deep_copy(this.get('columns'));if(item.checked){var idx=cols.indexOf(item.field);cols.splice(idx,1);}else{cols.push(item.field);}
this.set('columns',cols);var center_td=this.container.child('td.center_fields');this.only_re_render_fields=true;this.request_data();},});SG.NotesApp.VersionPaneBody=function(context,widget_spec,id){SG.NotesApp.VersionPaneBody.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.VersionPaneBody,SG.Widget.Base,{default_settings:{},templates:{main:'<div class="wrapper">{header}{mode_switcher}</div>',widget:'<div id="{widget_id}" class="{widget_css_class}"></div>',},on_first_render:function(){this.container=this.get_container();SG.NotificationCenter.add_observer({uuid:'_sg_notes_app_header_resized_',name:'sg_notes_app_header_resized',callback:{fn:this.on_header_widget_resized,scope:this}});},render_widget:function(){var header_widget=this.get_child('header');var switcher_widget=this.get_child('switcher');var header_html=this.templates.widget.apply({widget_id:header_widget.get_container_id(),widget_css_class:header_widget.get_css_class_name()});var switcher_html=this.templates.widget.apply({widget_id:switcher_widget.get_container_id(),widget_css_class:switcher_widget.get_css_class_name()});var html=this.templates.main.apply({header:header_html,mode_switcher:switcher_html});this.container.update(html);header_widget.render();switcher_widget.render();},on_header_widget_resized:function(){var header_widget=this.get_child('header');var switcher_widget=this.get_child('switcher');var header_height=header_widget.get_container().getHeight();var switcher_container=switcher_widget.get_container();switcher_container.setTop(header_height);},count_child_widgets:function(){return 2;},destroy_widget:function(){SG.NotificationCenter.remove_observer({uuid:'_sg_notes_app_header_resized_',name:'sg_notes_app_header_resized',callback:{fn:this.on_header_widget_resized,scope:this}});},});SG.NotesApp.GroupedNotes=function(context,widget_spec,id){SG.NotesApp.GroupedNotes.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.GroupedNotes,SG.Widget.EntityQueryMode,{default_settings:{columns:['id'],records_per_page:25,notes_filter_mode:'all',},templates:{group_tip:'<div class="group_tip notseltarget" sg_tip="{sg_tip}">'+'<span class="group_tip">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="group_type">{group_type}:</span>'+'<span class="group_name">{group}</span>'+'<span class="group_total">({total})</span></div>',group:'<div class="group {state} {synthetic}" group_idx="{group_idx}">'+'<div class="group_tip_div" count="{count}" depth="{depth}" >{tip}</div>'+'<div class="group_contents">{contents}</div></div>',loading:'<div class="loading">Loading...</div>',toolbar_item:'<div class="notes_filter_mode {selected}" mode="{mode}" >{label}</div>',notes_widget:'<div class="note_group"><div id="{notes_id}" class="{notes_class}"></div></div>',},init_widget:function(){this.entity_type='Note';this.current_page=1;this.data_set=this.new_data_set('Note',this.on_data_load,this.on_data_change);this.note_widgets=[];},on_data_change:function(){},on_first_render:function()
{this.container=this.get_container();this.add_event(this.container,'click',this.on_click);this.add_event(this,'context_changed',this.on_context_changed);this.request_data();},render_widget:function()
{if(!this.data_set.is_loaded()){this.container.update(this.templates.loading.apply({}));return;}
var html='';this.grouping=this.get_grouping();if(this.grouping){SG.NotesApp.GroupedNotes.__card_count__=0;html=this.recursively_render_grouped_notes(this.data_set.groups,0);}else{html=this.render_ungrouped();}
this.container.update(html);this.render_note_widgets();},recursively_render_grouped_notes:function(groups,depth)
{var html='';for(var i=0;i<groups.length;i++){var group=groups[i];if(group.synthetic){var card_count=SG.NotesApp.GroupedNotes.__card_count__;var content_html=this.recursively_render_grouped_notes(group.groups,depth+1);var grouping=this.grouping[depth];var schema_field=SG.schema.get_field(this.entity_type,grouping.column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,group.depth,this.grouping,schema_field,schema_field.display_name)
var total=SG.NotesApp.GroupedNotes.__card_count__-card_count;var tip=this.templates.group_tip.apply({group:display_name,total:total,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'synthetic',group_idx:group.idx,count:total,depth:depth});}else{var grp_recs=group.ids;var content_html=this.render_note_widget_for_group(group.ids);SG.NotesApp.GroupedNotes.__card_count__+=group.ids.length;var schema_field=SG.schema.get_field(this.entity_type,this.grouping[depth].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,depth,this.grouping,schema_field,schema_field.display_name)
var tip=this.templates.group_tip.apply({group:display_name,total:grp_recs.length,group_type:schema_field.display_name,sg_tip:this.render_group_header_tooltip(group,depth)});var state=this.get_group_state(group);html+=this.templates.group.apply({tip:tip,contents:content_html,state:state,synthetic:'',group_idx:group.idx,count:grp_recs.length,depth:depth});}}
return html;},render_note_widget_for_group:function(group_rec_ids){var filters=this.get_note_widget_filters(group_rec_ids);var note_context=this.context.clone();note_context.set('filters',filters);var note_widget=this.construct_child('notes',note_context);this.note_widgets.push(note_widget);return this.templates.notes_widget.apply({notes_id:note_widget.get_container_id(),notes_class:note_widget.get_css_class_name()});},render_note_widgets:function(){for(var i=0;i<this.note_widgets.length;i++){var widget=this.note_widgets[i];widget.render();}},render_ungrouped:function(){var note_context=this.context.clone();var note_widget=this.construct_child('notes',note_context);this.note_widgets.push(note_widget);var notes_id=note_widget.get_container_id();var notes_class=note_widget.get_css_class_name();return this.templates.notes_widget.apply({notes_id:notes_id,notes_class:notes_class});},get_note_widget_filters:function(group_rec_ids){var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:group_rec_ids}],};var mode=this.get('notes_filter_mode');if(mode=='open'){var cond={path:'sg_status_list',relation:'is_not',values:['clsd'],active:true};filters.conditions.push(cond);}else if(mode=='closed'){var cond={path:'sg_status_list',relation:'is',values:['clsd'],active:true};filters.conditions.push(cond);}
return filters;},on_data_load:function(){this.on_entities_loaded();this.destroy_all_note_widgets();this.note_widgets=[];this.hide_loading_overlay();this.render();},destroy_all_note_widgets:function(){if(this.note_widgets){for(var i=0;i<this.note_widgets.length;i++){var widget=this.note_widgets[i];widget.destroy();}}
this.note_widgets=[];},on_context_changed:function(key,value){if(key=="filters"||key=="parent_entity"||key=="grouping"){this.request_data();}},request_data:function(){this.show_loading_overlay();var spec={type:'Note',filters:this.get_local_filters(),grouping:this.get_grouping(),columns:this.get('columns'),current_page:this.current_page,records_per_page:this.get('records_per_page'),result:this.data_set};SG.Repo.query(spec);},get_local_filters:function(){return this.get_filters();if(this.grouped_by_versions()){var filters=sg_deep_copy(this.get_filters());var version_cond={path:"note_links",relation:'type_is',values:['Version'],active:true};filters.conditions.push(version_cond);return filters;}else{return this.get_filters();}},grouped_by_versions:function(){var grouping=this.get_grouping();return(grouping&&grouping.length==1&&grouping[0].column=='note_links')},set_data_store_max_records:function(num_recs)
{this.set('records_per_page',num_recs);this.request_data();},set_data_store_page:function(page_num)
{this.current_page=page_num;this.request_data();},reload_all_entities:function()
{this.request_data();},get_entity_data_store:function()
{return this.data_set;},on_grouping_toolbar_item_click:function(e,toolbar_div){var t=Ext.get(e.getTarget());var ungroup=t.findParent('div.ungroup',this.container,true);if(ungroup){var grouped_by_version_div=ungroup.findParent('div.grouped_by_version',this.container,true);grouped_by_version_div.removeClass('grouped');this.set('grouped',false);this.render_widget();return;}
var label=t.findParent('div.label',this.container,true);if(label){var grouped_by_version_div=label.findParent('div.grouped_by_version',this.container,true);if(grouped_by_version_div.hasClass('grouped'))return;grouped_by_version_div.addClass('grouped');this.set('grouped',true);this.request_data();return;}
var sorting_menu=t.findParent('div.sorting_menu',this.container,true);if(sorting_menu){if(!this.get('grouped'))return;this.show_sort_menu(sorting_menu);}},render_note_filter_toolbar_item:function(a,toolbar_item){var mode=this.get('notes_filter_mode');return this.templates.toolbar_item.apply({label:toolbar_item.value,selected:mode==toolbar_item.value.toLowerCase()?'selected':'',mode:toolbar_item.value.toLowerCase(),});},on_note_filter_toolbar_item:function(e,toolbar_div){var div=toolbar_div.child('div.notes_filter_mode');var mode=div.dom.getAttribute('mode');if(mode=='status:')return;var old_mode=this.get('notes_filter_mode');if(old_mode==mode)return;this.set('notes_filter_mode',mode);this.re_render_toolbar();if(this.get('grouped'))
this.request_data();else
this.render_widget();},re_render_toolbar:function(){var me=this;setTimeout(function(){var parent=me.get_parent();parent.toolbar.render();},0);},get_toolbar_items:function(){return[];},show_sort_menu:function(anchor_elem)
{this.sort_menu_toolbar_div=anchor_elem;if(!this.sort_menu)
{this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this},});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'Version',through_join_fields:this.get_through_join_fields(),parent_entity:this.context.get('parent_entity'),get_sorts_callback:{fn:this.on_get_sorts,scope:this},set_sorts_callback:{fn:this.on_set_sorts,scope:this},});}
this.sort_menu.show();},on_get_sorts:function()
{return this.get('sorts');},on_set_sorts:function(new_sorts)
{this.set('sorts',new_sorts);this.request_data();},on_before_show_sort_menu:function(menu)
{menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl'};menu.items=this.sorting_menu_helper.get_menu_items();menu.render();},on_click_fields_toolbar_item:function(e,toolbar_div){this.show_more_fields_menu(toolbar_div);},get_action_menu_items:function(items,target_elem,xy)
{return[];},multi_edit_selected:function()
{alert(this.get('type')+' has not implemented multi_edit_selected()');},on_click:function(e)
{var t=Ext.get(e.getTarget());var group_tip=t.findParent('div.group_tip',this.cards_div,true);if(group_tip)
{var group_div=group_tip.findParent('div.group',this.cards_div,true);var dom_event=e.browserEvent;if(dom_event.altKey)
{if(group_div.hasClass('open'))
this.toggle_all_groups('closed');else
this.toggle_all_groups('open');}
else
{if(group_div.hasClass('open'))
this.close_group(group_div);else
this.open_group(group_div);}}},open_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='open')
return;group_div.replaceClass('closed','open');this.set_group_state(group,'open');},close_group:function(group_div)
{var group_idx=group_div.dom.getAttribute('group_idx');var group;if(group_div.hasClass('synthetic'))
group=this.data_set.get_synthetic_group(group_idx);else
group=this.data_set.get_group(group_idx);var old_state=this.get_group_state(group);if(old_state=='closed')
return;group_div.replaceClass('open','closed');this.set_group_state(group,'closed');},destroy_widget:function(){},show_more_fields_menu:function(anchor_elem){if(!this.more_fields_menu){this.more_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return field_schema.data_type=='image';},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get('columns');return cols.indexOf(field_name)>-1;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
this.more_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_before_show_fields_menu:function(menu){menu.items=this.fields_menu_helper.get_menu_items();menu.render();},toggle_field:function(menu,item){var cols=sg_deep_copy(this.get('columns'));if(item.checked){var idx=cols.indexOf(item.field);cols.splice(idx,1);}else{cols.push(item.field);}
this.set('columns',cols);var center_td=this.container.child('td.center_fields');this.show_loading_overlay();this.request_data();},});SG.NotesApp.SummaryEmail=function(config){Ext.apply(this,config);SG.NotesApp.SummaryEmail.superclass.constructor.call(this);};Ext.extend(SG.NotesApp.SummaryEmail,SG.Component,{templates:{body:'<div style="width:100%;background-color:#F2F2F2;padding-top:20px;">'+'<div style="width:600px;margin-left:auto;margin-right:auto;'+'border-style:solid;border-color:#DADADA;border-width:1px;">'+'<table cellspacing="0" cellpadding="0" border="0" style="table-layout:fixed;"><tr>'+'<td bgcolor="#FFFFFF" style="width:600px;">'+'{body}</td></tr></table></div>'+'<div style="width:100%;padding-top:8px; padding-bottom:8px;">'+'<center><img src="http://www.shotgunsoftware.com/images/shotgun_logo_email.png" width="84" '+'height="13" alt="Shotgun logo" id="shotgun_logo"></center></div>'+'</div>',heading:'<table cellspacing="0" cellpadding="0" border="0" width="100%"><tr>'+'<td style="background-color:#2B2B2B;" >'+'<div style="margin-left:16px;margin-top:24px;font-size:20px;color:#FFFFFF;">{title}</div>'+'<div style="margin-left:16px;margin-right:16px;margin-top:6px;font-size:14px;'+'margin-bottom:24px;color:#CCCCCC">{note_body}</div>'+'</td></tr></table>',version:'<div style="margin-left:10px;margin-right:10px;padding-top:6px;padding-bottom:6px;'+'border-top-width:1px;border-top-style:solid;border-top-color:#cccccc;" >'+'<table cellspacing="0" cellpadding="0" border="0" width="100%" style="margin-bottom:4px;">'+'<tr><td style="width:170px;vertical-align:top;padding-top:4px;">{version_info}</td>'+'<td style="width:410px;vertical-align:top;padding-top:4px;">{notes}</td></tr></table></div>',summary:'<table cellspacing="0" cellpadding="0" border="0" style="table-layout:fixed;" width="100%"><tr>'+'<td style="padding:10px;font-size:15px;color:#7f7f7f">{summary}</td></tr></table>',note_table:'<table cellspacing="0" cellpadding="0" border="0" style="table-layout:fixed;" width="100%"><tr>'+'<td style="padding-bottom:6px;font-size:12px">{content}</td></tr></table>',note:'<div style="margin-bottom:12px;">{to}{body}</div>',version_info:'<table cellspacing="0" cellpadding="0" border="0" style="table-layout:fixed;" width="100%">'+'<tr><td style="width:20px;color:#7f7f7f;">{order}</td><td style="width:150px;font-size:12px;'+'font-weight:bold;color:#333333;overflow:hidden;">{version_name}</td></tr>'+'<tr><td style="width:20px;">&nbsp;</td><td style="width:150px;font-size:12px;">{entity_link}</td></tr>'+'<tr><td style="width:20px;">&nbsp;</td><td style="width:150px;font-size:12px;">{thumbnail}</td></tr>'+'</table>',},init_component:function(){this.versions_data_set=this.new_data_set('Version',this.on_versions_load);this.notes_data_set=this.new_data_set('Note',this.on_notes_load);this.fetch_notes();},on_notes_load:function(){if(this.notes_data_set.count()==0)
this.assemble_email();else
this.fetch_versions();},on_versions_load:function(){this.version_map={};for(var i=0;i<this.versions_data_set.count;i++){var record=this.versions_data_set.get_record(i);this.version_map[record.id]=record;}
this.create_note_addressings();},create_note_addressings:function(){this.note_addressings={};this.note_addressings_loaded_count=0;var note_records=this.get_note_records();this.note_record_count=note_records.length;for(var i=0;i<note_records.length;i++){var record=note_records[i];var check=this.notes_data_set.get_record_by_id(record.id);var ds=check?this.notes_data_set:this.old_notes_data_set;var cfg={owner_data_set:ds,owner:this,tasks:record.get('tasks'),addressings_to:record.get('addressings_to'),record_id:record.id,ready_to_render_callback:{fn:this.on_note_addresssing_ready,scope:this}};var na=new SG.NoteAdressings(cfg);this.note_addressings[record.id]=na;}},get_note_records:function(){var i;var records=[];for(i=0;i<this.notes_data_set.count();i++){var record=this.notes_data_set.get_record(i);records.push(record);}
return records;},on_note_addresssing_ready:function(){this.note_addressings_loaded_count++;if(this.note_addressings_loaded_count==this.note_record_count)
this.assemble_email();},assemble_email:function(){var email=this.render_html_email();var cc_external=this.email_field_record.get('cc_external');if(!cc_external||cc_external=='')
cc_external=null;var addressings_to=this.email_field_record.get('addressings_to');if(!addressings_to)
addressings_to=[];var url_prefix=window.location.protocol+'//'+window.location.host+'/notes_app_summary_email/';var options={url:'/page/send_notes_app_summary_email',params:{addressings_to:Ext.encode(addressings_to),cc_external:cc_external,subject:this.email_field_record.get('subject'),playlist_id:this.playlist.id,email_body:email,url_prefix:url_prefix},callback:function(options,success,response){if(success){this.finished_callback.fn.call(this.finished_callback.scope,response.responseText);}else{var sed=SG.server_error({connection_response:response});}},scope:this};var conn=new Ext.data.Connection();conn.request(options);},on_click:function(e){this.mask.remove();this.destroy();},render_html_email:function(){var header=this.templates.heading.apply({title:this.email_field_record.get('subject'),note_body:this.email_field_record.get('content')});var versions='';this.note_record_count=0;for(var i=0;i<this.versions_data_set.count();i++){var version_record=this.versions_data_set.get_record(i);versions+=this.templates.version.apply({version_info:this.render_version_info(version_record,i+1),notes:this.render_notes_for_version(version_record)});}
var vdn=this.versions_data_set.count()+' '+SG.schema.entity_types['Version']['display_name_pluralized'];if(this.versions_data_set.count()==1)
vdn='1 '+SG.schema.entity_types['Version']['display_name'];var ndn=this.note_record_count+' '+SG.schema.entity_types['Note']['display_name_pluralized'];if(this.note_record_count==1)
ndn='1 '+SG.schema.entity_types['Note']['display_name'];var summary=this.templates.summary.apply({summary:vdn+', '+ndn});return this.templates.body.apply({body:header+summary+versions});},render_version_info:function(version_record,order){return this.templates.version_info.apply({order:order,version_name:version_record.get('code'),entity_link:SG.Renderers.render_one_detail_link(version_record.get('entity'),true),thumbnail:this.render_version_thumbnail(version_record)});},render_version_thumbnail:function(version_record){return'&nbsp;';},render_notes_for_version:function(version_record){var html='';var note_records=this.get_notes_for_version(version_record);this.note_record_count+=note_records.length;for(var i=0;i<note_records.length;i++){var note_record=note_records[i];var note_addressing=this.note_addressings[note_record.id];html+=this.templates.note.apply({to:this.templates.note_table.apply({content:note_addressing.render_for_html_email()}),body:this.templates.note_table.apply({content:note_record.get('content')})});}
return html;},get_notes_for_version:function(version_record){var notes=[];var note_records=this.get_note_records();for(var i=0;i<note_records.length;i++){var note_record=note_records[i];var note_links=note_record.get('note_links');if(!note_links||note_links.length==0)continue;for(var j=0;j<note_links.length;j++){var link_entity=note_links[j];if(!link_entity)continue;if(link_entity.type==version_record.type&&link_entity.id==version_record.id){notes.push(note_record);break;}}}
return notes;},fetch_notes:function(){var filters;if(this.include_old_notes_on_versions){filters={logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:[this.playlist]}],};}else{filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:this.published_note_ids}],};}
var spec={type:'Note',filters:filters,columns:['tasks','addressings_to','content','note_links'],sorts:[{column:'created_at',direction:'desc'}],result:this.notes_data_set};SG.Repo.query(spec);},fetch_versions:function(){var version_ids=[];var note_records=this.get_note_records();for(var i=0;i<note_records.length;i++){var note_record=note_records[i];var note_links=note_record.get('note_links');if(!note_links)continue;for(var j=0;j<note_links.length;j++){var link_entity=note_links[j];if(link_entity.type=='Version'&&version_ids.indexOf(link_entity.id)==-1)
version_ids.push(link_entity.id);}}
var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:version_ids}],};var spec={type:'Version',filters:filters,columns:['image','code','entity','sg_status_list'],sorts:[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'}],result:this.versions_data_set,parent_entity:this.playlist};SG.Repo.query(spec);},});SG.NotesApp.SummaryEmailPreview=function(context,widget_spec,id){SG.NotesApp.SummaryEmailPreview.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.NotesApp.SummaryEmailPreview,SG.Widget.Base,{templates:{main:'<div class="sgw_notes_app_summary_email_preview"><div class="scroll">'+'<div class="main">{email}</div></div></div>',},init_widget:function(){},on_first_render:function()
{this.container=this.get_container();this.hide_global_nav();this.adjust_sg_main();this.data_set=this.new_data_set('EventLogEntry',this.render_widget);this.fetch_data();},adjust_sg_main:function(){var sg_main=this.container.findParent('div.sg_main',document.body,true);sg_main.addClass('no_global_nav');},hide_global_nav:function(){var global_nav=sg_find('#sg_global_nav');if(!global_nav)return;global_nav=Ext.get(global_nav);global_nav.setDisplayed(false);},render_widget:function(){if(!this.data_set.is_loaded())return;this.hide_loading_overlay();var record=this.data_set.get_record(0);var meta=record.get('meta');this.container.update(this.templates.main.apply({email:meta.email_body}));},fetch_data:function(){this.show_loading_overlay();var spec={type:'EventLogEntry',id:this.get('eventlog_entry_id'),columns:['id','entity','created_by','meta'],result:this.data_set};SG.Repo.find(spec);},});SG.PlaylistOverlay=function(cfg){Ext.apply(this,cfg);SG.PlaylistOverlay.superclass.constructor.call(this);};Ext.extend(SG.PlaylistOverlay,SG.Component,{templates:{main:'<div class="sgc_playlist_overlay">{header}'+'<div class="left_pane">{projects}</div>'+'<div class="right_pane"></div></div>',header:'<div class="header"><div class="left">Open a Playlist</div>'+'<div class="filter_input"><div class="quick_filter_left"></div>'+'<input type="text" value="" class="filter"></input>'+'<div class="clear"></div>'+'<div class="quick_filter_right"></div>'+'</div></div>',project:'<div class="project {selected}" project_id="{project_id}">'+'<div class="project_icon"><img src="{project_thumb}" onerror="sg_missing_project_thumb(this)" /></div>'+'<div class="project_name">{project_name}</div><div class="right_arrow"></div></div>',playlist:'<div class="playlist {selected}" playlist_id="{playlist_id}"><div class="top"><div class="name">'+'{name}</div><div class="timestamp">{timestamp}</div></div>'+'<div class="author">{author}</div></div>',playlist_group:'<div class="grouping_header">{group_name}</div>{playlists}',retired_user:'<span style="font-style: italic;">Retired User</span>',},init_component:function(){var html=this.templates.main.apply({header:this.templates.header.apply(),projects:this.render_projects(),});this.mask=Ext.DomHelper.append(document.body,{tag:'div',cls:'sg_dialog_mask playlist_overlay'},true);this.container=Ext.DomHelper.append(this.mask,html,true);this.add_event(this.mask,'click',this.on_mask_click);Ext.EventManager.onWindowResize(this.position_overlay,this);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'change',this.fetch_playlists);this.position_overlay();this.selected_project_id=null;},on_mask_click:function(e){var t=Ext.get(e.getTarget());var overlay=t.findParent('div.sgc_playlist_overlay',this.mask.dom);if(!overlay){var me=this;setTimeout(function(){if(me.overlay_hidden_callback)
me.overlay_hidden_callback.fn.call(me.overlay_hidden_callback.scope);me.destroy();},0);}},on_click:function(e){var t=Ext.get(e.getTarget());var project=t.findParent('div.project',this.container.dom);if(project){this.selected_project_id=Number(project.getAttribute('project_id'));this.fetch_playlists();this.select_project();return;}
var playlist=t.findParent('div.playlist',this.container.dom,true);if(playlist){if(playlist.hasClass('selected')){var me=this;setTimeout(function(){if(me.overlay_hidden_callback)
me.overlay_hidden_callback.fn.call(me.overlay_hidden_callback.scope);me.destroy();},0);return;}else{this.select_playlist(playlist);var playlist_id=Number(playlist.dom.getAttribute('playlist_id'));var playlist_record=this.playlist_ds.get_record_by_id(playlist_id);this.playlist_picked_callback.fn.call(this.playlist_picked_callback.scope,playlist_record);var me=this;setTimeout(function(){me.destroy();},500);return;}}
var t=Ext.get(e.getTarget());var clear_search=t.findParent('div.clear',this.container.dom);if(clear_search){var filter_input=this.container.child('input.filter');filter_input.dom.value='';this.fetch_playlists();return;}},select_project:function(){var selected=this.container.child('div.project.selected');if(selected)
selected.removeClass('selected');if(!this.selected_project_id)return;var sel='div.project[project_id="'+this.selected_project_id+'"]';var project_div=sg_find(sel,this.container.dom);project_div=Ext.get(project_div);project_div.addClass('selected');},fetch_playlists:function(){if(!this.selected_project_id)return;this.show_loading_overlay();if(this.playlist_ds){this.playlist_ds.destroy();}
var project=SG.schema.project_by_id(this.selected_project_id);var filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[project]}]};var filter_input=this.container.child('input.filter');var filter_text=filter_input.dom.value;if(filter_text&&filter_text.trim()!=""){var cond={path:'code',relation:'contains',values:[filter_text.trim()]};filters.conditions.push(cond);}
this.playlist_ds=this.new_data_set('Playlist',this.on_load_playlists);this.grouping=[{column:'updated_at',direction:'desc',method:'day',no_ungrouping:true}];var spec={type:'Playlist',filters:filters,columns:SG.schema.entity_types.Playlist.fields_sorted_by_display_name,sorts:[{column:'updated_at',direction:'desc'}],grouping:this.grouping,current_page:1,records_per_page:500,result:this.playlist_ds};SG.Repo.query(spec);},on_load_playlists:function(ds){this.hide_loading_overlay();var groups=this.playlist_ds.groups;var html='';for(var i=0;i<groups.length;i++){var group=groups[i];var grp_recs=group.ids;var playlist_html='';for(var j=0;j<grp_recs.length;j++){playlist_html+=this.render_playlist(this.playlist_ds.get_record_by_id(grp_recs[j]));}
var schema_field=SG.schema.get_field('Playlist',this.grouping[0].column);var display_name=SG.GroupHeadingRenderers.get_renderer(schema_field.data_type).render(group,0,this.grouping,schema_field,schema_field.display_name)
html+=this.templates.playlist_group.apply({group_name:display_name,playlists:playlist_html});}
var right_pane=this.container.child('div.right_pane');right_pane.update(html);},minute_length:(1000*60),hour_length:(1000*60*60),day_length:(1000*60*60*24),year_length:(1000*60*60*24*256),render_timestamp:function(timestamp){var update_time=Date.sgParseDateTime(timestamp);var now=new SG.Date();var diff=now.getTime()-update_time.getTime();if(diff<0)diff=1000;if(diff<this.minute_length){var secs=Math.floor(diff/1000);return secs+'s';}else if(diff<this.hour_length){var mins=Math.floor(diff/this.minute_length);return mins+'m';}else if(diff<this.day_length){var hours=Math.floor(diff/this.hour_length);return hours+'h';}else if(diff<this.year_length){var days=Math.floor(diff/this.day_length);return days+'d';}else{var years=Math.floor(diff/this.year_length*10)/10;return years+'y';}},select_playlist:function(elem){var current_selected=this.container.child('div.playlist.selected');if(current_selected)
current_selected.removeClass('selected');elem.addClass('selected');},render_playlist:function(rec){var timestamp=this.render_timestamp(rec.get('updated_at'));var created_by=rec.get('created_by');return this.templates.playlist.apply({playlist_id:rec.id,name:rec.get('code'),author:created_by?rec.get('created_by').name:this.templates.retired_user.apply(),timestamp:timestamp,selected:this.selected_playlist_id==rec.id?'selected':'',});},position_overlay:function(){var dbody=Ext.get(document.body);var width=dbody.getWidth();var height=dbody.getHeight();var l=Math.floor(width*0.5)-260;this.container.setHeight(height-100);this.container.setLeft(l);},render_projects:function(){var data_set=SG.globals.global_projects_last_accessed_by_current_user;var html='';for(var i=0;i<data_set.count();i++){var rec=data_set.get_record(i);html+=this.templates.project.apply({selected:'',project_id:rec.id,project_thumb:rec.get('image')?rec.get('image'):'/images/missing_thumbnail_project.png',project_name:rec.get('name')});}
return html;},destroy_component:function(){this.mask.remove();if(this.__overlay_template_div__)
this.__overlay_template_div__.remove();Ext.EventManager.removeResizeListener(this.position_overlay,this);},show_loading_overlay:function(){var container=this.container.child('div.right_pane');if(!this.__overlay_template_div__){var id="progress_overlay_000";var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(Ext.get(document.body),overlay_html,true);}
this.__overlay_template_div__.alignTo(container,"tl-tl");this.__overlay_template_div__.setWidth(container.getWidth());this.__overlay_template_div__.setHeight(container.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__){this.__overlay_template_div__.hide();}},});SG.ReviewAppTreeNode=function(config){Ext.apply(this,config);this.init();};SG.ReviewAppTreeNode.from_hash=function(hash,after_load_callback){var type_parts=hash.type.split('.');var node;try{var node_class=window[type_parts[0]];var i;for(i=1;i<type_parts.length;i++)
node_class=node_class[type_parts[i]];var init_hash=node_class.to_init_hash(hash);node=new node_class(init_hash);}catch(e){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope,null);return;}
if(!node.data_is_loaded()){var callback={fn:function(){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope,node);},scope:this};node.fetch_data(callback);return;}
if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope,node);};SG.ReviewAppTreeNode.get_root_node=function(){return new SG.ReviewAppRootNode();};SG.ReviewAppTreeNode.prototype={init:function(){},children_are_loaded:function(){return false;},data_is_loaded:function(){return true;},fetch_data:function(after_load_callback){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},fetch_children:function(after_load_callback){return;},is_valid:function(){},has_children:function(){return;},get_children:function(){return this.children||[];},get_child_by_id:function(id){if(!this.children)return;var i;for(i=0;i<this.children.length;i++)
if(this.children[i].id===id)
return this.children[i];},copy:function(config){var cfg={id:this.id,name:this.name};if(config)
Ext.apply(cfg,config);var new_node=new this.constructor(cfg);if(this.parent)
new_node.parent=this.parent.copy();return new_node;},to_hash:function(){var ser_obj={};var funcNameRegex=/(SG\..*).superclass/;var results=(funcNameRegex).exec((this).constructor.toString());ser_obj.type=(results&&results.length>1)?results[1]:"";return ser_obj;},get_path:function(){if(this.path)return this.path;var path='';var parent=this;while(parent&&parent.get_depth()>0){if(path)
path=parent.id+'/'+path;else
path=parent.id;parent=parent.get_parent();}
this.path='/'+path;return this.path;},find_node_at_path:function(path,found_callback){if(path.indexOf('/')===0){var root_path=this.get_path();path=path.replace(new RegExp('^'+root_path),'');}
if(path===''&&found_callback){found_callback.fn.call(found_callback.scope,this);return;}
if(this.async&&!this.data_is_loaded()){this.fetch_data({fn:function(){this._find_node_after_data_loaded(path,found_callback);},scope:this});return;}
this._find_node_after_data_loaded(path,found_callback);},_find_node_after_data_loaded:function(path,found_callback){if(this.async&&this.supports_children&&!this.children_are_loaded()){this.fetch_children({fn:function(){this._find_node_after_children_loaded(path,found_callback);},scope:this});return;}
this._find_node_after_children_loaded(path,found_callback);},_find_node_after_children_loaded:function(path,found_callback){var path_parts=path.split('/');var node=this.get_child_by_id(path_parts[0]);if(node){node.find_node_at_path(path_parts.slice(1).join('/'),found_callback);return;}
found_callback.fn.call(found_callback.scope,null);},get_parent:function(){return this.parent;},get_ancestor_at_depth:function(depth){if(depth>this.get_depth())
return;var node=this;while(node.get_depth()!=depth)
node=node.get_parent();return node;},get_depth:function(){if(this.depth)return this.depth;var depth=0;var parent=this.get_parent();while(parent){++depth;parent=parent.get_parent();}
this.depth=depth;return depth;},is_leaf:function(){return!this.supports_children||!this.has_children();}};SG.ReviewAppGroupedTreeNode=function(config){Ext.apply(this,config);SG.ReviewAppGroupedTreeNode.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppGroupedTreeNode,SG.ReviewAppTreeNode,{default_settings:{sorts:[],grouping:null},init:function(){SG.ReviewAppGroupedTreeNode.superclass.init.call(this);this.supports_children=true;this.allows_user_grouping_and_sorting=false;},get_children:function(){var all_children=[];var groups=this.get_child_groups();var i,j,children;for(i=0;i<groups.length;i++){children=this.get_children_for_group(groups[i].id);for(j=0;j<children.length;j++)
all_children.push(this.get_child_by_id(children[j].id));}
return all_children;},get_child_groups:function(){return[];},get_children_for_group:function(group_id){return[];},get_child_group:function(group_id){return[];},get_sorts:function(){return this.sorts;},set_sorts:function(sorts){this.sorts=sorts;},get_grouping:function(){return this.grouping;},set_grouping:function(grouping){this.grouping=grouping;},get_default_sorts:function(){return sg_deep_copy(this.default_settings.sorts);},get_default_grouping:function(){return sg_deep_copy(this.default_settings.grouping);},has_default_sorts:function(){var first=this.sorts;var second=this.default_settings.sorts;if(!first&&!second)return true;if((!first&&second)||(first&&!second))return false;if(first.length!==second.length)return false;var i;for(i=0;i<first.length;i++){if(first[i].column!==second[i].column||first[i].direction!==second[i].direction)
return false;}
return true;},has_default_grouping:function(){var first=this.grouping;var second=this.default_settings.grouping;if(!first&&!second)return true;if((!first&&second)||(first&&!second))return false;if(first.length!==second.length)return false;var i;for(i=0;i<first.length;i++){if(first[i].column!==second[i].column||first[i].direction!==second[i].direction||first[i].method!==second[i].method)
return false;}
return true;}});SG.ReviewAppRootNode=function(config){Ext.apply(this,config);SG.ReviewAppRootNode.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppRootNode,SG.ReviewAppTreeNode,{init:function(){SG.ReviewAppRootNode.superclass.init.call(this);this.name='Home';this.id='home';this.supports_children=true;this.async=true;},is_valid:function(){return true;},data_is_loaded:function(){return this.has_global_pages!==undefined;},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){this.has_global_pages=this.probe_data_set.count()>0;var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.probe_data_set=new SG.Data.Set('Page');this.probe_data_set.on('load',callback,this);var page_spec={type:'Page',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'ui_category',relation:'is',values:['reports']},{path:'entity_type',relation:'is',values:['Version']},{path:'project',relation:'is',values:[null]}]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(page_spec);},has_children:function(){return true;},children_are_loaded:function(){return true;},get_children:function(){var children=[];var child_ids=['projects'];if(this.has_global_pages)
child_ids.push('global_version_pages');var i,child;for(i=0;i<child_ids.length;i++){child=this.get_child_by_id(child_ids[i]);if(child)
children.push(child);}
return children;},get_child_by_id:function(id){switch(id){case'projects':return new SG.ReviewAppProjectsNode({id:id,parent:this});case'global_version_pages':if(this.has_global_pages)
return new SG.ReviewAppGlobalVersionPagesNode({parent:this,children_exist:true});default:return null;}},copy:function(){return SG.ReviewAppRootNode.superclass.copy.call(this,{has_global_pages:this.has_global_pages});}});SG.ReviewAppProjectsNode=function(config){Ext.apply(this,config);SG.ReviewAppProjectsNode.superclass.constructor.call(this);};SG.ReviewAppProjectsNode.to_init_hash=function(hash){return{};};Ext.extend(SG.ReviewAppProjectsNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppProjectsNode.superclass.init.call(this);this.name='All Projects';this.id='projects';this.icon_class=SG.schema.entity_icon_name('Project');this.async=true;this.is_target=true;},data_is_loaded:function(){return true;},is_valid:function(){return true;},has_children:function(){var i;for(i=0;i<SG.schema.projects.length;i++)
if(SG.schema.projects[i].name!=='Template Project')
return true;return false;},get_parent:function(){if(!this.parent)
this.parent=SG.ReviewAppTreeNode.get_root_node();return this.parent;},children_are_loaded:function(){if(!this.projects_data_set||!this.projects_data_set.is_loaded())return false;if(!this.project_ver_data_sets)return false;var key;for(key in this.project_ver_data_sets){if(this.project_ver_data_sets.hasOwnProperty(key)){if(!this.project_ver_data_sets[key].is_loaded())
return false;}}
return true;},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.project_ver_data_sets={};if(SG.schema.projects.length===0){this.on_after_load_project_sets();return;}
var callback=function(){if(!this.children_are_loaded())return;this.on_after_load_project_sets();};SG.Repo.start_batch();this.projects_data_set=new SG.Data.Set('Project');this.projects_data_set.on('load',callback,this);var proj_spec={type:'Project',columns:['image'],result:this.projects_data_set};SG.Repo.query(proj_spec);var i,data_set,ver_spec,project_id;for(i=0;i<SG.schema.projects.length;i++){project_id=SG.schema.projects[i].id;data_set=new SG.Data.Set('Version');data_set.on('load',callback,this);this.project_ver_data_sets[project_id]=data_set;ver_spec={type:'Version',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]}]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(ver_spec);}
SG.Repo.end_batch();},on_after_load_project_sets:function(){this.status_buckets={};var i,proj_id,status;for(i=0;i<SG.schema.projects.length;i++){proj_id=SG.schema.projects[i].id;if(SG.schema.projects[i].name==='Template Project')continue;if(this.project_ver_data_sets[proj_id].count()<1){if(!this.hide_children_without_versions){if(!this.status_buckets.hasOwnProperty('no_versions'))
this.status_buckets.no_versions=[proj_id];else
this.status_buckets.no_versions.push(proj_id);}
continue;}
status=SG.schema.projects[i].sg_status;if(!status)
status='-1';if(!this.status_buckets.hasOwnProperty(status))
this.status_buckets[status]=[proj_id];else
this.status_buckets[status].push(proj_id);}
var sort_fn=function(a,b){var a_name=sg_project_name(a);var b_name=sg_project_name(b);if(a_name<b_name)return-1;if(a_name>b_name)return 1;return 0;};var key;for(key in this.status_buckets){if(this.status_buckets.hasOwnProperty(key))
this.status_buckets[key].sort(sort_fn);}
for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_children:function(){var children=[];var key,i,id;for(key in this.status_buckets){if(this.status_buckets.hasOwnProperty(key)){for(i=0;i<this.status_buckets[key].length;i++){id=this.status_buckets[key][i].toString();children.push(this.get_child_by_id(id));}}}
return children;},get_child_by_id:function(id){var record=this.projects_data_set.get_record_by_id(Number(id));if(!record)return null;var image=record.get('image');var node=new SG.ReviewAppProjectNode({id:id.toString(),project_id:record.get_id(),image:image,children_exist:true,hide_children_without_versions:this.hide_children_without_versions,parent:this});return node;},get_child_groups:function(){var groups=[];var group_ids=SG.schema.entity_fields.Project.sg_status.values;group_ids=group_ids.concat(['-1','no_versions']);var i;for(i=0;i<group_ids.length;i++)
if(this.status_buckets.hasOwnProperty(group_ids[i]))
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){if(Number(group_id)===-1)
return{id:'-1',name:'No Status'};if(group_id==='no_versions')
return{id:'no_versions',name:'Projects Without Versions',force_render_header:true};var status_values_ordered=SG.schema.entity_fields.Project.sg_status.values;var i,status_idx;for(i=0;i<status_values_ordered.length;i++)
if(status_values_ordered[i]===group_id){status_idx=i;break;}
if(status_idx===null)return;return{id:group_id,name:SG.schema.entity_fields.Project.sg_status.display_values[i]};},get_children_for_group:function(group_id){if(!this.status_buckets.hasOwnProperty(group_id))return[];var children=[];var i,id;for(i=0;i<this.status_buckets[group_id].length;i++){id=this.status_buckets[group_id][i].toString();children.push(this.get_child_by_id(id));}
return children;},copy:function(){var cfg={status_buckets:this.status_buckets,projects_data_set:this.projects_data_set,children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions};return SG.ReviewAppProjectsNode.superclass.copy.call(this,cfg);}});SG.ReviewAppProjectNode=function(config){Ext.apply(this,config);SG.ReviewAppProjectNode.superclass.constructor.call(this);};SG.ReviewAppProjectNode.to_init_hash=function(hash){return{id:hash.pid.toString(),project_id:hash.pid};};Ext.extend(SG.ReviewAppProjectNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppProjectNode.superclass.init.call(this);this.name=sg_project_name(this.project_id);this.icon_class=SG.schema.entity_icon_name('Project');this.shotgun_detail_url='/detail/Project/'+this.project_id;this.async=true;this.is_target=true;},data_is_loaded:function(){return true;},is_valid:function(){return SG.schema.project_by_id(this.project_id)?true:false;},has_children:function(){return true;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppProjectsNode({id:'projects',children_exist:true,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},children_are_loaded:function(){if(!this.has_versions_sets||!this.has_children_sets)return false;var key;for(key in this.has_versions_sets)
if(this.has_versions_sets.hasOwnProperty(key)&&!this.has_versions_sets[key].is_loaded())
return false;for(key in this.has_children_sets){if(this.has_children_sets.hasOwnProperty(key)&&!this.has_children_sets[key].is_loaded())
return false;}
return true;},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.has_versions_sets={};this.has_children_sets={};var project_filter={path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]};SG.Repo.start_batch();var data_set=new SG.Data.Set('Asset');data_set.on('load',this.on_after_load_section_sets,this);this.has_children_sets.assets=data_set;var spec={type:'Asset',columns:[],filters:{logical_operator:'and',conditions:[project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(spec);data_set=new SG.Data.Set('Sequence');data_set.on('load',this.on_after_load_section_sets,this);this.has_children_sets.sequences=data_set;spec={type:'Sequence',columns:[],filters:{logical_operator:'and',conditions:[project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(spec);data_set=new SG.Data.Set('Playlist');data_set.on('load',this.on_after_load_section_sets,this);this.has_children_sets.playlists=data_set;var playlist_spec={type:'Playlist',columns:[],filters:{logical_operator:'and',conditions:[project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(playlist_spec);data_set=new SG.Data.Set('Page');data_set.on('load',this.on_after_load_section_sets,this);this.has_children_sets.pages=data_set;var page_spec={type:'Page',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'ui_category',relation:'is',values:['reports']},{path:'entity_type',relation:'is',values:['Version']},project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(page_spec);data_set=new SG.Data.Set('Version');data_set.on('load',this.on_after_load_section_sets,this);this.has_versions_sets.assets=data_set;spec={type:'Version',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Asset']},project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(spec);data_set=new SG.Data.Set('Version');data_set.on('load',this.on_after_load_section_sets,this);this.has_versions_sets.sequences=data_set;spec={type:'Version',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Shot']},{path:'entity.Shot.sg_sequence',relation:'is_not',values:[null]},project_filter]},records_per_page:1,current_page:1,result:data_set};SG.Repo.query(spec);SG.Repo.end_batch();},on_after_load_section_sets:function(){if(!this.children_are_loaded())return;var i;for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_child_by_id:function(id){var cfg={project_id:this.project_id,children_exist:this.has_children_sets[id].count()>0,hide_children_without_versions:this.hide_children_without_versions,parent:this};switch(id){case'assets':return new SG.ReviewAppAssetTypesNode(cfg);case'sequences':return new SG.ReviewAppSequencesNode(cfg);case'playlists':return new SG.ReviewAppPlaylistsNode(cfg);case'pages':return new SG.ReviewAppVersionPagesNode(cfg);default:return null;}},get_child_groups:function(){var group_ids=['versions'];if(!this.hide_children_without_versions)
group_ids.push('no_versions');var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){switch(group_id){case'versions':return{id:group_id,header_hidden:true};case'no_versions':return{id:group_id,name:'Sections Without Versions',force_render_header:true};default:return null;}},get_children_for_group:function(group_id){var children=[];var key,do_push;for(key in this.has_children_sets){if(this.has_children_sets.hasOwnProperty(key)){do_push=false;if(this.has_children_sets.hasOwnProperty(key)&&this.has_children_sets[key].count()>0){if(!this.has_versions_sets.hasOwnProperty(key)||this.has_versions_sets[key].count()>0){if(group_id==='versions')
do_push=true;}else if(group_id==='no_versions'){do_push=true;}}
if(do_push)
children.push(this.get_child_by_id(key));}}
return children;},copy:function(){return SG.ReviewAppProjectsNode.superclass.copy.call(this,{children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions,project_id:this.project_id});},to_hash:function(){var ser_obj=SG.ReviewAppProjectsNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppAssetTypesNode=function(config){Ext.apply(this,config);SG.ReviewAppAssetTypesNode.superclass.constructor.call(this);};SG.ReviewAppAssetTypesNode.to_init_hash=function(hash){return{project_id:hash.pid};};Ext.extend(SG.ReviewAppAssetTypesNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppAssetTypesNode.superclass.init.call(this);this.id='assets';this.name='All Assets';this.icon_class=SG.schema.entity_icon_name('Asset');this.async=true;this.is_target=true;},data_is_loaded:function(){return true;},is_valid:function(){return SG.schema.project_by_id(this.project_id)?true:false;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppProjectNode({id:this.project_id.toString(),children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},has_children:function(){return SG.schema.entity_fields.Asset.sg_asset_type.display_values.length>0;},children_are_loaded:function(){return this.asset_types;},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.version_summary_data_set=new SG.Data.Set('Version');this.version_summary_data_set.on('load',this.after_load_version_summaries,this);var summary_spec={type:'Version',filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Asset']},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'entity.Asset.sg_asset_type',method:'exact',direction:'asc'}],summaries:[{column:'entity.Asset.sg_asset_type',type:'maximum'}],result:this.version_summary_data_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);},after_load_version_summaries:function(){this.asset_types={};var assets=this.version_summary_data_set.group_summaries;var values=[];var i,id,value;for(i=0;i<assets.length;i++){value=assets[i].summaries[0].value;this.asset_types[value||'-1']=0;values.push(value);}
this.asset_summary_set=new SG.Data.Set('Asset');this.asset_summary_set.on('load',this.after_load_asset_summary,this);var summary_spec={type:'Asset',filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'sg_asset_type',method:'exact',direction:'asc'}],summaries:[{column:'sg_asset_type',type:'maximum'}],result:this.asset_summary_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);},after_load_asset_summary:function(){this.asset_types_no_versions={};var asset_types=this.asset_summary_set.group_summaries;var values=[];var i,id,value;for(i=0;i<asset_types.length;i++){value=asset_types[i].summaries[0].value||'-1';if(this.asset_types.hasOwnProperty(value))
this.asset_types[value]=1;else
this.asset_types_no_versions[value]=1;}
for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_child_by_id:function(id){var asset_types=SG.schema.entity_fields.Asset.sg_asset_type.display_values;if(id!=='-1'&&!this.asset_types.hasOwnProperty(id)&&!this.asset_types_no_versions.hasOwnProperty(id))
return null;return new SG.ReviewAppAssetTypeNode({id:id,asset_type:id,children_exist:this.asset_types[id]===1||this.asset_types_no_versions[id]===1,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions,parent:this});},get_child_groups:function(){var group_ids=['versions'];if(!this.hide_children_without_versions)
group_ids.push('no_versions');var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){switch(group_id){case'versions':return{id:group_id,header_hidden:true};case'no_versions':return{id:group_id,name:'Asset Types Without Versions',force_render_header:true};default:return null;}},get_children_for_group:function(group_id){var i;var children=[];var asset_type_names=[];if(group_id==='no_versions'){var asset_types=SG.schema.entity_fields.Asset.sg_asset_type.display_values;for(i=0;i<asset_types.length;i++)
if(!this.asset_types.hasOwnProperty(asset_types[i])&&this.asset_types_no_versions.hasOwnProperty(asset_types[i]))
asset_type_names.push(asset_types[i]);if(this.asset_types_no_versions.hasOwnProperty('-1'))
asset_type_names.push('-1');}else{var key;for(key in this.asset_types)
if(this.asset_types.hasOwnProperty(key))
asset_type_names.push(key);}
asset_type_names.sort(function(a,b){if(a===b)
return 0;if(a==='-1')
return 1;if(b==='-1')
return-1;if(a>b)
return 1;return-1;});for(i=0;i<asset_type_names.length;i++)
children.push(this.get_child_by_id(asset_type_names[i]));return children;},copy:function(){return SG.ReviewAppAssetTypesNode.superclass.copy.call(this,{project_id:this.project_id,version_summary_data_set:this.version_summary_data_set,asset_types_no_versions:this.asset_types_no_versions,asset_summary_set:this.asset_summary_set,asset_types:this.asset_types,children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions});},to_hash:function(){var ser_obj=SG.ReviewAppAssetTypesNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppAssetTypeNode=function(config){Ext.apply(this,config);SG.ReviewAppAssetTypeNode.superclass.constructor.call(this);};SG.ReviewAppAssetTypeNode.to_init_hash=function(hash){return{id:hash.at,project_id:hash.pid,asset_type:hash.at};};Ext.extend(SG.ReviewAppAssetTypeNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppAssetTypeNode.superclass.init.call(this);this.async=true;this.is_target=true;this.icon_class=SG.schema.entity_icon_name('Asset');if(this.asset_type&&!this.name)
this.name=this.id!=='-1'?this.asset_type.pluralize():'No Asset Type';},data_is_loaded:function(){return typeof(this.children_exist)!=='undefined'||(this.probe_data_set&&this.probe_data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.probe_data_set=new SG.Data.Set('Asset');this.probe_data_set.on('load',callback,this);var probe_spec={type:'Asset',columns:[],filters:{logical_operator:'and',conditions:[{path:'sg_asset_type',relation:'is',values:[this.id!=='-1'?this.asset_type:null]},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(probe_spec);},is_valid:function(){return this.name&&((this.probe_data_set&&this.probe_data_set.count()>0)||this.data_is_loaded());},has_children:function(){if(typeof(this.children_exist)!=='undefined')
return this.children_exist;return this.probe_data_set&&this.probe_data_set.count()>0;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppAssetTypesNode({children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},children_are_loaded:function(){return this.asset_data_set&&this.asset_data_set.is_loaded();},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.summary_data_set=new SG.Data.Set('Version');this.summary_data_set.on('load',this.on_after_load_summaries,this);var summary_spec={type:'Version',filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Asset']},{path:'entity.Asset.sg_asset_type',relation:'is',values:[this.asset_type!=='-1'?this.asset_type:null]},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'entity.Asset.id',method:'exact',direction:'asc'}],summaries:[{column:'entity.Asset.id',type:'maximum'}],result:this.summary_data_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);},on_after_load_summaries:function(){var assets=this.summary_data_set.group_summaries;this.assets_with_versions=[];var i,id;for(i=0;i<assets.length;i++){id=Number(assets[i].summaries[0].value);if(id)
this.assets_with_versions.push(id);}
var callback=function(){var i;for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;};this.asset_data_set=new SG.Data.Set('Asset');this.asset_data_set.on('load',callback,this);var asset_spec={type:'Asset',columns:['code','image'],filters:{logical_operator:'and',conditions:[{path:'sg_asset_type',relation:'is',values:[this.asset_type!=='-1'?this.asset_type:null]},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},sorts:[{column:'code',direction:'asc'}],result:this.asset_data_set};SG.Repo.query(asset_spec);},get_child_by_id:function(id){var record=this.asset_data_set.get_record_by_id(Number(id));if(!record)return null;return new SG.ReviewAppAssetNode({id:id.toString(),name:record.get('code'),image:record.get('image'),asset_id:Number(id),asset_type:this.asset_type,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions,parent:this});},get_child_groups:function(){var group_ids=['versions'];if(!this.hide_children_without_versions)
group_ids.push('no_versions');var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){switch(group_id){case'versions':return{id:group_id,header_hidden:true};case'no_versions':return{id:group_id,name:'Assets Without Versions',force_render_header:true};default:return null;}},get_children_for_group:function(group_id){var i,record,id,do_push;var children=[];for(i=0;i<this.asset_data_set.count();i++){record=this.asset_data_set.get_record(i);id=record.get_id();do_push=false;if(this.assets_with_versions.indexOf(id)===-1){if(group_id==='no_versions')
do_push=true;}else if(group_id==='versions'){do_push=true;}
if(do_push)
children.push(this.get_child_by_id(id));}
return children;},copy:function(){return SG.ReviewAppAssetTypeNode.superclass.copy.call(this,{project_id:this.project_id,asset_type:this.asset_type,probe_data_set:this.probe_data_set,assets_with_versions:this.assets_with_versions,asset_data_set:this.asset_data_set,name:this.name,children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions});},to_hash:function(){var ser_obj=SG.ReviewAppAssetTypeNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;ser_obj.at=this.asset_type;return ser_obj;}});SG.ReviewAppSequencesNode=function(config){Ext.apply(this,config);SG.ReviewAppSequencesNode.superclass.constructor.call(this);};SG.ReviewAppSequencesNode.to_init_hash=function(hash){return{project_id:hash.pid};};Ext.extend(SG.ReviewAppSequencesNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppSequencesNode.superclass.init.call(this);this.id='sequences';this.name='All Shots';this.icon_class=SG.schema.entity_icon_name('Shot');this.async=true;this.is_target=true;},data_is_loaded:function(){return typeof(this.children_exist)!=='undefined'||(this.probe_data_set&&this.probe_data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.probe_data_set=new SG.Data.Set('Shot');this.probe_data_set.on('load',callback,this);var probe_spec={type:'Shot',columns:[],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(probe_spec);},is_valid:function(){return this.name&&((this.probe_data_set&&this.probe_data_set.count()>0)||this.data_is_loaded());},has_children:function(){if(typeof(this.children_exist)!=='undefined')
return this.children_exist;return this.probe_data_set&&this.probe_data_set.count()>0;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppProjectNode({id:this.project_id.toString(),children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},children_are_loaded:function(){return this.seq_data_set&&this.seq_data_set.is_loaded()&&this.all_seqs_set&&this.all_seqs_set.is_loaded();},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;var callback=function(){if(!this.all_seqs_set.is_loaded()||!this.summary_data_set.group_summaries)return;this.on_after_load_summaries();};SG.Repo.start_batch();this.all_seqs_set=new SG.Data.Set('Sequence');this.all_seqs_set.on('load',callback,this);var seq_spec={type:'Sequence',columns:['code','image'],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},sorts:[{column:'code',direction:'asc'}],result:this.all_seqs_set};SG.Repo.query(seq_spec);this.summary_data_set=new SG.Data.Set('Version');this.summary_data_set.on('load',callback,this);var summary_spec={type:'Version',filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Shot']},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'entity.Shot.sg_sequence.Sequence.id',method:'exact',direction:'asc'}],summaries:[{column:'entity.Shot.sg_sequence.Sequence.id',type:'maximum'}],result:this.summary_data_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);SG.Repo.end_batch();},on_after_load_summaries:function(){this.sequences_with_versions=[];var sequences=this.summary_data_set.group_summaries;var i,id;for(i=0;i<sequences.length;i++){id=Number(sequences[i].summaries[0].value);if(id)
this.sequences_with_versions.push(id);else
this.sequences_with_versions.push(-1);}
SG.Repo.start_batch();this.shot_summary_set=new SG.Data.Set('Shot');this.shot_summary_set.on('load',this.on_after_load_shot_summaries,this);var summary_spec={type:'Shot',filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'sg_sequence.Sequence.id',method:'exact',direction:'asc'}],summaries:[{column:'sg_sequence.Sequence.id',type:'maximum'}],result:this.shot_summary_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);SG.Repo.end_batch();},on_after_load_shot_summaries:function(){var sequences=this.shot_summary_set.group_summaries;this.sequences_with_shots=[];var i,value;for(i=0;i<sequences.length;i++){value=sequences[i].summaries[0].value;if(value)
this.sequences_with_shots.push(Number(value));else
this.sequences_with_shots.push(-1);}
for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_child_by_id:function(id){var record=this.all_seqs_set.get_record_by_id(Number(id));if(record)
return new SG.ReviewAppSequenceNode({id:id.toString(),name:record.get('code'),image:record.get('image'),sequence_id:Number(id),project_id:this.project_id,children_exist:this.sequences_with_shots.indexOf(Number(id))>-1,hide_children_without_versions:this.hide_children_without_versions,parent:this});if(id==='-1')
return new SG.ReviewAppSequenceNode({id:id,sequence_id:-1,project_id:this.project_id,children_exist:this.sequences_with_shots.indexOf(-1)>-1,parent:this});},get_child_groups:function(){var group_ids=['versions'];if(!this.hide_children_without_versions)
group_ids.push('no_versions');var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){switch(group_id){case'versions':return{id:group_id,name:'Sequences',force_render_header:true};case'no_versions':return{id:group_id,name:'Sequences Without Versions',force_render_header:true};default:return null;}},get_children_for_group:function(group_id){var children=[];var i,id,do_push;for(i=0;i<this.all_seqs_set.count();i++){id=this.all_seqs_set.get_record(i).get_id();do_push=false;if(this.sequences_with_versions.indexOf(id)>-1){if(group_id==='versions')
do_push=true;}else if(group_id==='no_versions'){do_push=true;}
if(do_push)
children.push(this.get_child_by_id(id.toString()));}
if(this.sequences_with_shots.indexOf(-1)>-1){if(this.sequences_with_versions.indexOf(-1)>-1&&group_id==='versions')
children.push(this.get_child_by_id('-1'));else if(this.sequences_with_versions.indexOf(-1)===-1&&group_id==='no_versions')
children.push(this.get_child_by_id('-1'));}
return children;},copy:function(){return SG.ReviewAppSequencesNode.superclass.copy.call(this,{project_id:this.project_id,all_seq_set:this.all_seq_set,probe_set:this.probe_set,sequences_with_versions:this.sequences_with_versions,sequences_with_shots:this.sequences_with_shots,children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions});},to_hash:function(){var ser_obj=SG.ReviewAppSequencesNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppPlaylistsNode=function(config){Ext.apply(this,config);SG.ReviewAppPlaylistsNode.superclass.constructor.call(this);};SG.ReviewAppPlaylistsNode.to_init_hash=function(hash){return{project_id:hash.pid};};Ext.extend(SG.ReviewAppPlaylistsNode,SG.ReviewAppGroupedTreeNode,{default_settings:{sorts:[{column:'code',direction:'asc'}],grouping:[{column:'updated_at',method:'day',direction:'desc'}]},init:function(){SG.ReviewAppPlaylistsNode.superclass.init.call(this);this.id='playlists',this.name='Playlists';this.icon_class=SG.schema.entity_icon_name('Playlist');this.async=true;this.allows_user_grouping_and_sorting=true;this.entity_type='Playlist';var settings_cookie=getCookie('sgw_review_app_tree_model_Playlists_settings');if(settings_cookie){var settings=Ext.decode(settings_cookie);this.sorts=settings.sorts;this.grouping=settings.grouping;}else{this.sorts=sg_deep_copy(this.default_settings.sorts);this.grouping=sg_deep_copy(this.default_settings.grouping);}},data_is_loaded:function(){return typeof(this.children_exist)!=='undefined'||(this.probe_data_set&&this.probe_data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.probe_data_set=new SG.Data.Set('Playlist');this.probe_data_set.on('load',callback,this);var probe_spec={type:'Playlist',columns:[],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(probe_spec);},is_valid:function(){return this.name&&((this.probe_data_set&&this.probe_data_set.count()>0)||this.data_is_loaded());},has_children:function(){if(typeof(this.children_exist)!=='undefined')
return this.children_exist;return this.probe_data_set&&this.probe_data_set.count()>0;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppProjectNode({id:this.project_id.toString(),children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},children_are_loaded:function(){return this.playlist_set&&this.playlist_set.is_loaded();},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.playlist_set=new SG.Data.Set('Playlist');this.playlist_set.on('load',this.on_playlists_load,this);var playlist_spec={type:'Playlist',columns:['code','created_by','updated_at'],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},sorts:this.get_sorts(),grouping:this.get_grouping(),result:this.playlist_set};SG.Repo.query(playlist_spec);},on_playlists_load:function(){var i;for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_children:function(){var children=[];var i;for(i=0;i<this.playlist_set.count();i++)
children.push(this.get_child_by_id(this.playlist_set.get_record(i).get_id().toString()));return children;},get_child_by_id:function(id){var record=this.playlist_set.get_record_by_id(Number(id));if(!record)return null;return new SG.ReviewAppPlaylistNode({id:id.toString(),name:record.get('code'),created_by:record.get('created_by'),updated_at:record.get('updated_at'),playlist_id:Number(id),project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions,parent:this});},get_child_groups:function(){if(!this.playlist_set.is_grouped())return null;var groups=[];var i;for(i=0;i<this.playlist_set.groups.length;i++)
groups.push(this.get_child_group(i.toString()));return groups;},get_child_group:function(group_id){var display_name=this.playlist_set.groups[Number(group_id)].display_values.join(', ');if(!display_name){var column=this.playlist_set.grouping[0].column;display_name='No '+SG.schema.get_field_display_name('Playlist',column);}
return{id:group_id,name:display_name,force_render_header:true};},get_children_for_group:function(group_id){if(!this.playlist_set.groups||this.playlist_set.groups.length<Number(group_id))
return[];var group=this.playlist_set.groups[Number(group_id)];var children=[];var i,record,name;for(i=0;i<group.ids.length;i++)
children.push(this.get_child_by_id(group.ids[i].toString()));return children;},set_sorts:function(sorts){SG.ReviewAppPlaylistsNode.superclass.set_sorts.call(this,sorts);this.save_settings();},set_grouping:function(grouping){SG.ReviewAppPlaylistsNode.superclass.set_grouping.call(this,grouping);this.save_settings();},save_settings:function(){var settings={sorts:this.get_sorts(),grouping:this.get_grouping()};setCookie('sgw_review_app_tree_model_Playlists_settings',Ext.encode(settings),365);},copy:function(){return SG.ReviewAppPlaylistsNode.superclass.copy.call(this,{project_id:this.project_id,playlist_set:this.playlist_set,children_exist:this.children_exist});},to_hash:function(){var ser_obj=SG.ReviewAppPlaylistsNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppVersionPagesNode=function(config){Ext.apply(this,config);SG.ReviewAppVersionPagesNode.superclass.constructor.call(this);};SG.ReviewAppVersionPagesNode.to_init_hash=function(hash){return{project_id:hash.pid};};Ext.extend(SG.ReviewAppVersionPagesNode,SG.ReviewAppGroupedTreeNode,{default_settings:{sorts:[{column:'name',direction:'asc'}],grouping:[{column:'last_accessed_by_current_user',method:'day',direction:'desc'}]},init:function(){SG.ReviewAppVersionPagesNode.superclass.init.call(this);this.id='pages';this.name='Version Pages';this.icon_class='icon_Page_for_dark_bg';this.menu_icon_class=SG.schema.entity_icon_name('Page');this.async=true;this.allows_user_grouping_and_sorting=true;this.entity_type='Page';var settings_cookie=getCookie('sgw_review_app_tree_model_Pages_settings');if(settings_cookie){var settings=Ext.decode(settings_cookie);this.sorts=settings.sorts;this.grouping=settings.grouping;}else{this.sorts=sg_deep_copy(this.default_settings.sorts);this.grouping=sg_deep_copy(this.default_settings.grouping);}},data_is_loaded:function(){return typeof(this.children_exist)!=='undefined'||(this.probe_data_set&&this.probe_data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.probe_data_set=new SG.Data.Set('Page');this.probe_data_set.on('load',callback,this);var proj_condition;if(this.project_id)
proj_condition={path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]};else
proj_condition={path:'project',relation:'is',values:[null]};var probe_spec={type:'Page',columns:[],filters:{logical_operator:'and',conditions:[{path:'ui_category',relation:'is',values:['reports']},{path:'entity_type',relation:'is',values:['Version']},proj_condition]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(probe_spec);},is_valid:function(){return this.name&&((this.probe_data_set&&this.probe_data_set.count()>0)||this.data_is_loaded());},has_children:function(){if(typeof(this.children_exist)!=='undefined')
return this.children_exist;return this.probe_data_set&&this.probe_data_set.count()>0;},get_parent:function(){if(!this.parent)
if(this.project_id)
this.parent=new SG.ReviewAppProjectNode({id:this.project_id.toString(),children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});else
this.parent=SG.ReviewAppTreeNode.get_root_node();return this.parent;},children_are_loaded:function(){return this.version_pages_set&&this.version_pages_set.is_loaded();},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;this.version_pages_set=new SG.Data.Set('Page');this.version_pages_set.on('load',this.on_version_pages_load,this);var proj_condition;if(this.project_id)
proj_condition={path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]};else
proj_condition={path:'project',relation:'is',values:[null]};var page_spec={type:'Page',columns:['name','last_accessed_by_current_user','updated_at','created_by'],filters:{logical_operator:'and',conditions:[{path:'ui_category',relation:'is',values:['reports']},{path:'entity_type',relation:'is',values:['Version']},proj_condition]},sorts:this.get_sorts(),grouping:this.get_grouping(),result:this.version_pages_set};SG.Repo.query(page_spec);},on_version_pages_load:function(){var i;for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_children:function(){var children=[];var i;for(i=0;i<this.version_pages_set.count();i++)
children.push(this.get_child_by_id(this.version_pages_set.get_record(i).get_id().toString()));return children;},get_child_by_id:function(id){var record=this.version_pages_set.get_record_by_id(Number(id));if(!record)return null;return new SG.ReviewAppVersionPageNode({id:id.toString(),name:record.get('name'),created_by:record.get('created_by'),updated_at:record.get('updated_at'),version_page_id:Number(id),project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions,parent:this});},get_child_groups:function(){if(!this.version_pages_set.is_grouped())return null;var groups=[];var i;for(i=0;i<this.version_pages_set.groups.length;i++)
groups.push(this.get_child_group(i.toString()));return groups;},get_child_group:function(group_id){var display_name=this.version_pages_set.groups[Number(group_id)].display_values.join(', ');if(!display_name){var column=this.version_pages_set.grouping[0].column;display_name='No '+SG.schema.get_field_display_name('Page',column);}
return{id:group_id,name:display_name,force_render_header:true};},get_children_for_group:function(group_id){if(!this.version_pages_set.groups||this.version_pages_set.groups.length<Number(group_id))
return[];var group=this.version_pages_set.groups[Number(group_id)];var children=[];var i,record,name;for(i=0;i<group.ids.length;i++)
children.push(this.get_child_by_id(group.ids[i].toString()));return children;},set_sorts:function(sorts){SG.ReviewAppVersionPagesNode.superclass.set_sorts.call(this,sorts);this.save_settings();},set_grouping:function(grouping){SG.ReviewAppVersionPagesNode.superclass.set_grouping.call(this,grouping);this.save_settings();},save_settings:function(){var settings={sorts:this.get_sorts(),grouping:this.get_grouping()};setCookie('sgw_review_app_tree_model_Pages_settings',Ext.encode(settings),365);},copy:function(){return SG.ReviewAppVersionPagesNode.superclass.copy.call(this,{project_id:this.project_id,version_pages_set:this.version_pages_set,children_exist:this.children_exist});},to_hash:function(){var ser_obj=SG.ReviewAppVersionPagesNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppGlobalVersionPagesNode=function(config){Ext.apply(this,config);SG.ReviewAppGlobalVersionPagesNode.superclass.constructor.call(this);};SG.ReviewAppGlobalVersionPagesNode.to_init_hash=function(hash){return{};};Ext.extend(SG.ReviewAppGlobalVersionPagesNode,SG.ReviewAppVersionPagesNode,{init:function(){SG.ReviewAppGlobalVersionPagesNode.superclass.init.call(this);this.id='global_version_pages';this.name='Global Version Pages';}});SG.ReviewAppLeafNode=function(config){Ext.apply(this,config);SG.ReviewAppLeafNode.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppLeafNode,SG.ReviewAppTreeNode,{init:function(){SG.ReviewAppLeafNode.superclass.init.call(this);this.async=true;this.shotgun_detail_url='/detail/'+this.entity_type+'/'+this.get_entity_id();this.is_target=true;this.columns=['image'];},get_entity_id:function(){return;},data_is_loaded:function(){if(this.name){for(i=0;i<this.columns.length;i++){if(!this.hasOwnProperty(this.columns[i]))
break;}
return true;}
return(this.data_set&&this.data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;this.data_set=new SG.Data.Set(this.entity_type);var callback=function(){var i;if(this.data_set.count()){var record=this.data_set.get_record(0);this.name=record.get(this.name_column);for(i=0;i<this.columns.length;i++)
this[this.columns[i]]=record.get(this.columns[i]);}
for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.data_set.on('load',callback,this);var spec={type:this.entity_type,ids:[this.get_entity_id()],columns:[this.name_column].concat(this.columns),result:this.data_set};SG.Repo.find(spec);},is_valid:function(){return this.name&&((this.data_set&&this.data_set.count()>0)||this.data_is_loaded());},copy:function(config){var cfg={project_id:this.project_id};if(config)
Ext.apply(cfg,config);return SG.ReviewAppLeafNode.superclass.copy.call(this,cfg);}});SG.ReviewAppAssetNode=function(config){Ext.apply(this,config);SG.ReviewAppAssetNode.superclass.constructor.call(this);};SG.ReviewAppAssetNode.to_init_hash=function(hash){return{id:hash.aid.toString(),project_id:hash.pid,asset_type:hash.at,asset_id:hash.aid};};Ext.extend(SG.ReviewAppAssetNode,SG.ReviewAppTreeNode,{init:function(){SG.ReviewAppAssetNode.superclass.init.call(this);this.icon_class=SG.schema.entity_icon_name('Asset');this.async=true;this.is_target=true;this.shotgun_detail_url='/detail/Asset/'+this.asset_id;},data_is_loaded:function(){return(this.name&&this.image&&this.asset_type)||(this.data_set&&this.data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;this.data_set=new SG.Data.Set('Asset');var callback=function(){if(this.data_set.count()){var record=this.data_set.get_record(0);this.name=record.get('code');this.image=record.get('image');this.asset_type=record.get('sg_asset_type')||'-1';}
var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};this.data_set.on('load',callback,this);var spec={type:'Asset',ids:[this.asset_id],columns:['code','sg_asset_type','image'],result:this.data_set};SG.Repo.find(spec);},is_valid:function(){return this.name&&((this.data_set&&this.data_set.count()>0)||this.data_is_loaded());},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppAssetTypeNode({id:this.asset_type,asset_type:this.asset_type,children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},copy:function(){return SG.ReviewAppAssetNode.superclass.copy.call(this,{project_id:this.project_id,asset_type:this.asset_type,asset_id:this.asset_id,children_exist:this.children_exist});},to_hash:function(){var ser_obj=SG.ReviewAppAssetNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;ser_obj.at=this.asset_type;ser_obj.aid=this.asset_id;return ser_obj;}});SG.ReviewAppSequenceNode=function(config){Ext.apply(this,config);SG.ReviewAppSequenceNode.superclass.constructor.call(this);};SG.ReviewAppSequenceNode.to_init_hash=function(hash){return{id:hash.sqid.toString(),project_id:hash.pid,sequence_id:hash.sqid};};Ext.extend(SG.ReviewAppSequenceNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppSequenceNode.superclass.init.call(this);this.async=true;if(this.sequence_id!==-1){this.shotgun_detail_url='/detail/Sequence/'+this.sequence_id;this.icon_class='icon_Sequence_for_dark_bg';this.menu_icon_class=SG.schema.entity_icon_name('Sequence');}else{this.name='Shots Without a Sequence';this.image=null;this.icon_class=SG.schema.entity_icon_name('Shot');}
this.is_target=true;},data_is_loaded:function(){return(this.name&&typeof(this.image)!=='undefined'&&typeof(this.children_exist)!=='undefined')||(this.probe_data_set&&this.probe_data_set.is_loaded());},fetch_data:function(after_load_callback){if(!this.fd_callback_queue)
this.fd_callback_queue=[];if(after_load_callback)
this.fd_callback_queue.push(after_load_callback);if(this.data_loading)return;this.data_loading=true;var callback=function(){if(!this.probe_data_set.is_loaded()||(this.sequence_id>0&&!this.data_set.is_loaded()))return;if(this.sequence_id>0&&this.data_set.count()){var record=this.data_set.get_record(0);this.name=record.get('code');this.image=record.get('image');}
var i;for(i=0;i<this.fd_callback_queue.length;i++)
this.fd_callback_queue[i].fn.call(this.fd_callback_queue[i].scope);this.fd_callback_queue=[];this.data_loading=false;};SG.Repo.start_batch();this.probe_data_set=new SG.Data.Set('Shot');this.probe_data_set.on('load',callback,this);var seq;if(this.sequence_id>0)
seq={type:'Sequence',id:this.sequence_id};else
seq=null;var probe_spec={type:'Shot',columns:[],filters:{logical_operator:'and',conditions:[{path:'sg_sequence',relation:'is',values:[seq]}]},records_per_page:1,current_page:1,result:this.probe_data_set};SG.Repo.query(probe_spec);if(this.sequence_id>0){this.data_set=new SG.Data.Set('Sequence');this.data_set.on('load',callback,this);var spec={type:'Sequence',ids:[this.sequence_id],columns:['code','image'],result:this.data_set};SG.Repo.find(spec);}
SG.Repo.end_batch();},is_valid:function(){return this.name&&(this.sequence_id<0||(this.data_set&&this.data_set.count()>0)||this.data_is_loaded());},has_children:function(){if(typeof(this.children_exist)!=='undefined')
return this.children_exist;return this.probe_data_set&&this.probe_data_set.count()>0;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppSequencesNode({children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},children_are_loaded:function(){return this.shot_data_set&&this.shot_data_set.is_loaded();},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;SG.Repo.start_batch();var callback=function(){if(!this.all_shots_set.is_loaded()||!this.summary_data_set.group_summaries)return;this.on_after_load_summaries();};this.all_shots_set=new SG.Data.Set('Shot');this.all_shots_set.on('load',callback,this);var seq;if(this.sequence_id>0)
seq={type:'Sequence',id:this.sequence_id};else
seq=null;var shots_spec={type:'Shot',columns:['code','image'],filters:{logical_operator:'and',conditions:[{path:'sg_sequence',relation:'is',values:[seq]},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},sorts:[{column:'code',direction:'asc'}],result:this.all_shots_set};SG.Repo.query(shots_spec);this.summary_data_set=new SG.Data.Set('Version');this.summary_data_set.on('load',callback,this);var summary_spec={type:'Version',filters:{logical_operator:'and',conditions:[{path:'entity',relation:'type_is',values:['Shot']},{path:'entity.Shot.sg_sequence',relation:'is',values:[seq]},{path:'project',relation:'is',values:[{type:'Project',id:this.project_id}]}]},grouping:[{column:'entity.Shot.id',method:'exact',direction:'asc'}],summaries:[{column:'entity.Shot.id',type:'maximum'}],result:this.summary_data_set,result_key:'group_summaries'};SG.Repo.summarize(summary_spec);SG.Repo.end_batch();},on_after_load_summaries:function(){this.shots_with_versions=[];var shots=this.summary_data_set.group_summaries;var i,value;for(i=0;i<shots.length;i++){value=shots[i].summaries[0].value;if(value)
this.shots_with_versions.push(Number(value));}
for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_child_by_id:function(id){var record=this.all_shots_set.get_record_by_id(Number(id));if(!record)return null;return new SG.ReviewAppShotNode({id:id.toString(),name:record.get('code'),image:record.get('image'),shot_id:Number(id),sequence_id:this.sequence_id,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions,parent:this});},get_child_groups:function(){var group_ids=['versions'];if(!this.hide_children_without_versions)
group_ids.push('no_versions');var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){switch(group_id){case'versions':return{id:group_id,header_hidden:true};case'no_versions':return{id:group_id,name:'Shots Without Versions',force_render_header:true};default:return null;}},get_children_for_group:function(group_id){var children=[];var i,record,id,do_push;for(i=0;i<this.all_shots_set.count();i++){record=this.all_shots_set.get_record(i);id=record.get_id();do_push=false;if(this.shots_with_versions.indexOf(id)>-1){if(group_id==='versions')
do_push=true;}else if(group_id==='no_versions'){do_push=true;}
if(do_push)
children.push(this.get_child_by_id(id.toString()));}
return children;},copy:function(){return SG.ReviewAppSequenceNode.superclass.copy.call(this,{project_id:this.project_id,sequence_id:this.sequence_id,all_shots_set:this.all_shots_set,shots_with_versions:this.shots_with_versions,children_exist:this.children_exist,hide_children_without_versions:this.hide_children_without_versions});},to_hash:function(){var ser_obj=SG.ReviewAppSequenceNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;ser_obj.sqid=this.sequence_id;return ser_obj;}});SG.ReviewAppShotNode=function(config){Ext.apply(this,config);SG.ReviewAppShotNode.superclass.constructor.call(this);};SG.ReviewAppShotNode.to_init_hash=function(hash){return{id:hash.sid.toString(),project_id:hash.pid,sequence_id:hash.sqid,shot_id:hash.sid};};Ext.extend(SG.ReviewAppShotNode,SG.ReviewAppLeafNode,{init:function(){this.icon_class=SG.schema.entity_icon_name('Shot');this.entity_type='Shot';this.name_column='code';SG.ReviewAppShotNode.superclass.init.call(this);},get_entity_id:function(){return this.shot_id;},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppSequenceNode({id:this.sequence_id,project_id:this.project_id,sequence_id:this.sequence_id,children_exist:true,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},copy:function(){return SG.ReviewAppShotNode.superclass.copy.call(this,{sequence_id:this.sequence_id,shot_id:this.shot_id});},to_hash:function(){var ser_obj=SG.ReviewAppShotNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;ser_obj.sid=this.shot_id;ser_obj.sqid=this.sequence_id;return ser_obj;}});SG.ReviewAppPlaylistNode=function(config){Ext.apply(this,config);SG.ReviewAppPlaylistNode.superclass.constructor.call(this);};SG.ReviewAppPlaylistNode.to_init_hash=function(hash){return{id:hash.plid.toString(),project_id:hash.pid,playlist_id:hash.plid};};Ext.extend(SG.ReviewAppPlaylistNode,SG.ReviewAppLeafNode,{init:function(){this.icon_class=SG.schema.entity_icon_name('Playlist');this.entity_type='Playlist';this.name_column='code';SG.ReviewAppPlaylistNode.superclass.init.call(this);this.columns=['created_by','updated_at'];},get_entity_id:function(){return this.playlist_id;},data_is_loaded:function(){return(this.name&&this.image)||(this.data_set&&this.data_set.is_loaded());},get_parent:function(){if(!this.parent)
this.parent=new SG.ReviewAppPlaylistsNode({children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},copy:function(){return SG.ReviewAppPlaylistNode.superclass.copy.call(this,{playlist_id:this.playlist_id,created_by:this.created_by,updated_at:this.updated_at});},to_hash:function(){var ser_obj=SG.ReviewAppPlaylistNode.superclass.to_hash.call(this);ser_obj.pid=this.project_id;ser_obj.plid=this.playlist_id;return ser_obj;}});SG.ReviewAppVersionPageNode=function(config){Ext.apply(this,config);SG.ReviewAppVersionPageNode.superclass.constructor.call(this);};SG.ReviewAppVersionPageNode.to_init_hash=function(hash){return{id:hash.vpid.toString(),project_id:hash.pid,version_page_id:hash.vpid};};Ext.extend(SG.ReviewAppVersionPageNode,SG.ReviewAppLeafNode,{init:function(){this.icon_class='icon_Page_for_dark_bg';this.menu_icon_class=SG.schema.entity_icon_name('Page');this.entity_type='Page';this.name_column='name';SG.ReviewAppVersionPageNode.superclass.init.call(this);this.shotgun_detail_url='/page/'+this.version_page_id;this.columns=['created_by','updated_at'];},get_entity_id:function(){return this.version_page_id;},get_parent:function(){if(!this.parent)
if(this.project_id)
this.parent=new SG.ReviewAppVersionPagesNode({children_exist:true,project_id:this.project_id,hide_children_without_versions:this.hide_children_without_versions});else
this.parent=new SG.ReviewAppGlobalVersionPagesNode({children_exist:true,hide_children_without_versions:this.hide_children_without_versions});return this.parent;},copy:function(){return SG.ReviewAppVersionPageNode.superclass.copy.call(this,{version_page_id:this.version_page_id,created_by:this.created_by,update_at:this.updated_at});},to_hash:function(){var ser_obj=SG.ReviewAppVersionPageNode.superclass.to_hash.call(this);ser_obj.vpid=this.version_page_id;ser_obj.pid=this.project_id;return ser_obj;}});SG.ReviewAppFavoritesNode=function(config){Ext.apply(this,config);SG.ReviewAppFavoritesNode.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppFavoritesNode,SG.ReviewAppGroupedTreeNode,{init:function(){SG.ReviewAppProjectsNode.superclass.init.call(this);this.name='Recent & Favorites';this.supports_children=true;this.async=true;SG.NotificationCenter.add_observer({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',callback:{fn:this.favorites_changed,scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_recent_',name:'review_app_recent_changed',callback:{fn:this.recent_changed,scope:this}});if(SG.ReviewApp.Utils.favorites_loaded()&&SG.ReviewApp.Utils.recent_loaded()){this.favorites=SG.ReviewApp.Utils.get_favorites().slice(0);this.recent=SG.ReviewApp.Utils.get_recent().slice(0);}},data_is_loaded:function(){return SG.ReviewApp.Utils.favorites_loaded()&&SG.ReviewApp.Utils.recent_loaded()&&this.favorites&&this.recent;},fetch_data:function(after_load_callback){var callback={fn:function(){this.on_data_fetched(after_load_callback);},scope:this};var loading=false;if(!SG.ReviewApp.Utils.favorites_loaded()){SG.ReviewApp.Utils.fetch_favorites(callback);loading=true;}
if(!SG.ReviewApp.Utils.recent_loaded()){SG.ReviewApp.Utils.fetch_recent(callback);loading=true;}
if(!loading)
this.on_data_fetched(after_load_callback);},on_data_fetched:function(after_load_callback){if(!SG.ReviewApp.Utils.favorites_loaded()||!SG.ReviewApp.Utils.recent_loaded())
return;this.favorites=SG.ReviewApp.Utils.get_favorites();this.recent=SG.ReviewApp.Utils.get_recent();if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},is_valid:function(){return true;},has_children:function(){return true;},children_are_loaded:function(){if(!this.favorites||!this.recent)return false;var i;for(i=0;i<this.favorites.length;i++)
if(this.favorites[i].async&&!this.favorites[i].data_is_loaded())
return false;for(i=0;i<this.recent.length;i++)
if(this.recent[i].async&&!this.recent[i].data_is_loaded())
return false;return true;},fetch_children:function(after_load_callback){if(!this.fc_callback_queue)
this.fc_callback_queue=[];if(after_load_callback)
this.fc_callback_queue.push(after_load_callback);if(this.children_loading)return;this.children_loading=true;if(this.favorites.length===0&&this.recent.length===0){this.on_after_node_loaded();return;}
var callback={fn:this.on_after_node_loaded,scope:this};var fetching=false;var i;for(i=0;i<this.favorites.length;i++)
if(this.favorites[i].async&&!this.favorites[i].data_is_loaded()){fetching=true;this.favorites[i].fetch_data(callback);}
for(i=0;i<this.recent.length;i++)
if(this.recent[i].async&&!this.recent[i].data_is_loaded()){fetching=true;this.recent[i].fetch_data(callback);}
if(!fetching)
this.on_after_node_loaded();},on_after_node_loaded:function(){if(!this.children_loading||!this.children_are_loaded())return;var new_favs=[];var i;for(i=0;i<this.favorites.length;i++)
if(this.favorites[i].is_valid())
new_favs.push(this.favorites[i]);this.favorites=new_favs;var new_recent=[];for(i=0;i<this.recent.length;i++)
if(this.recent[i].is_valid())
new_recent.push(this.recent[i]);this.recent=new_recent;for(i=0;i<this.fc_callback_queue.length;i++)
this.fc_callback_queue[i].fn.call(this.fc_callback_queue[i].scope);this.fc_callback_queue=[];this.children_loading=false;},get_children:function(){return this.favorites.concat(this.recent);},get_favorite_by_path:function(path){var i;for(i=0;i<this.favorites.length;i++)
if(this.favorites[i].get_path()===path)
return this.favorites[i];return null;},get_recent_by_path:function(path){var i;for(i=0;i<this.recent.length;i++)
if(this.recent[i].get_path()===path)
return this.recent[i];return null;},get_child_groups:function(){var group_ids=['favorites','recent'];var groups=[];var i;for(i=0;i<group_ids.length;i++)
groups.push(this.get_child_group(group_ids[i]));return groups;},get_child_group:function(group_id){if(group_id==='favorites'){return{id:group_id,name:'Favorites',force_render_header:true,};}else if(group_id==='recent'){return{id:group_id,name:'Recent',force_render_header:true};}
return null;},get_children_for_group:function(group_id){var i;var children=[];if(group_id==='favorites')
return this.favorites.slice(0);if(group_id==='recent')
return this.recent.slice(0);return children;},reset:function(){if(!SG.ReviewApp.Utils.favorites_loaded()||!SG.ReviewApp.Utils.recent_loaded())
return;this.recent=SG.ReviewApp.Utils.get_recent();this.favorites=SG.ReviewApp.Utils.get_favorites();},recent_changed:function(args){this.recent=SG.ReviewApp.Utils.get_recent();var callback={fn:function(){if(this.recent_changed_callback)
this.recent_changed_callback.fn.call(this.recent_changed_callback.scope,args);},scope:this};if(!this.data_is_loaded()){this.fetch_data({fn:function(){this.fetch_children(callback);},scope:this});return;}
this.fetch_children(callback);},favorites_changed:function(args){this.favorites=SG.ReviewApp.Utils.get_favorites();var callback={fn:function(){if(this.favorites_changed_callback)
this.favorites_changed_callback.fn.call(this.favorites_changed_callback.scope,args);},scope:this};if(!this.data_is_loaded()){this.fetch_data({fn:function(){this.fetch_children(callback);},scope:this});return;}
this.fetch_children(callback);}});SG.ReviewAppNavBar=function(config){Ext.apply(this,config);SG.ReviewAppNavBar.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNavBar,SG.Component,{templates:{main:'<div class="sgc_review_app_nav_bar">'+'<div class="home_button"></div>'+'<div class="path"></div>'+'<div class="favorite"></div>'+'<div class="jump_to_shotgun"></div>'+'<div class="refresh_button" style="display: none;">'+'<div class="refresh_light"></div>'+'</div>'+'<div class="cancel_button" style="display: none;"></div>'+'</div>',token:'<div class="token" depth="{depth}" tabindex="0">'+'<div class="display_name"></div>'+'<div class="menu_hit_area">'+'<img class="arrow" src="/images/review_app_browser_arrow.png" width="4" height="9">'+'</div>'+'</div>',token_editor:'<input class="token_editor" type="text" autocomplete="off" depth="{depth}" tabindex="1"></input>',loading_menu_contents:'<img src="/images/indicator_large_transparent.gif">&nbsp;Loading...'},on_first_render:function(){this.container.update(this.templates.main.apply());this.path_div=this.container.child('div.path');this.jump_button_div=this.container.child('div.jump_to_shotgun');this.favorite_button_div=this.container.child('div.favorite');this.refresh_button_div=this.container.child('div.refresh_button');this.cancel_button_div=this.container.child('div.cancel_button');this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'dblclick',this.on_dblclick);this.add_event(this.container,'mousedown',this.on_mousedown);SG.NotificationCenter.add_observer({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',callback:{fn:this.favorites_changed,scope:this}});},destroy_component:function(){SG.NotificationCenter.remove_observer({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',callback:{fn:this.favorites_changed,scope:this}});},render:function(){this.render_node(this.node);},render_node:function(node,after_render_callback){if(!this.rendered||!node){this.on_first_render();this.rendered=true;if(!node)
return;}
this.rendered_node=node;if(!this.rendered_node.is_target||!this.node.shotgun_detail_url||this.editing)
this.jump_button_div.removeClass('displayed');else
this.jump_button_div.addClass('displayed');if(this.loading){this.cancel_button_div.setDisplayed(true);this.refresh_button_div.setDisplayed(false);}else{this.refresh_button_div.setDisplayed(this.rendered_node.is_target&&!this.editing);}
var callback={fn:function(){this.render_node(node,after_render_callback);},scope:this};if(!this.path_is_loaded(this.rendered_node,callback))
return;if(!this.rendered_node.is_target||this.editing){this.favorite_button_div.removeClass('displayed');}else{this.favorite_button_div.addClass('displayed');if(SG.ReviewApp.Utils.node_is_favorite(this.node))
this.favorite_button_div.addClass('favorited');else
this.favorite_button_div.removeClass('favorited');}
var token_divs=sg_find_all('div.token',this.container.dom);var token_map={};var max_depth=0;this.deleting_nodes=true;var i,token_div,depth;for(i=0;i<token_divs.length;i++){depth=Number(token_divs[i].getAttribute('depth'));token_div=Ext.get(token_divs[i]);if(depth>this.rendered_node.get_depth()){token_div.remove();continue;}
token_map[depth]=token_div;if(depth>max_depth)
max_depth=depth;}
this.deleting_nodes=false;var contents,template;for(i=max_depth+1;i<=this.rendered_node.get_depth();i++){contents=this.templates.token.apply({depth:i});token_div=Ext.DomHelper.append(this.path_div,contents,true);token_div.on('keydown',this.on_token_keydown,this);token_div.on('focus',this.on_token_focus,this);token_div.on('blur',this.on_token_blur,this);token_map[i]=token_div;}
var display_name_div,ancestor,html;for(i=1;i<=this.rendered_node.get_depth();i++){ancestor=this.rendered_node.get_ancestor_at_depth(i);html='';if(ancestor.icon_class)
html+='<div class="token_icon '+ancestor.icon_class+'"></div>&nbsp;';html+=ancestor.name;display_name_div=token_map[i].child('div.display_name');display_name_div.update(html);if(ancestor.is_leaf())
token_map[i].addClass('is_leaf');else
token_map[i].removeClass('is_leaf');}
if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);},render_editor_at_depth:function(depth){this.editing=true;var ancestor=this.rendered_node.get_ancestor_at_depth(depth-1);var html=this.templates.token_editor.apply({depth:depth});this.skip_path_reset=true;var callback={fn:function(){Ext.DomHelper.append(this.path_div,html);var editor=this.path_div.child('input.token_editor');editor.on('focus',this.on_editor_focus,this);editor.on('blur',this.on_editor_blur,this);editor.on('keydown',this.on_editor_keydown,this);editor.on('keyup',this.on_editor_keyup,this);editor.focus();this.render_editor_menu(editor,editor,depth-1);this.skip_path_reset=false;},scope:this};this.render_node(ancestor,callback);},render_selection_menu:function(token_elem,align_elem,depth){if(!this.children_menu){var cfg={before_show:{fn:function(the_menu){the_menu.token_elem.addClass('menu_showing');the_menu.token_elem.focus();},scope:this},after_hide:{fn:function(the_menu){if(!this.keep_menu_showing)
the_menu.token_elem.removeClass('menu_showing');},scope:this},allow_submenu_click_events:true,menu_class:'sgw_review_app_token_autocomplete'};this.children_menu=this.new_component(SG.Menu,cfg);}
if(SG.Menu.now_showing===this.children_menu){SG.Menu.now_showing.cancel();SG.Menu.now_showing=null;}
this.children_menu.position={dom_elem:align_elem,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};this.children_menu.token_elem=token_elem;this.children_menu.depth=depth;var node=this.rendered_node.get_ancestor_at_depth(depth);var items=[];if(node.async&&!node.children_are_loaded()&&!this.fetching_data){this.fetching_data=true;this.fetching_data_path=node.get_path();node.fetch_children({fn:function(){this.fetching_data=false;if(this.children_menu.depth!==node.get_depth())
return;this.on_editor_data_loaded(node,this.children_menu);var showing=this.children_menu.is_showing();this.children_menu.render();if(showing){this.keep_menu_showing=true;this.children_menu.show();this.keep_menu_showing=false;}else{this.children_menu.__hide();}},scope:this});var loading_html=this.templates.loading_menu_contents.apply();this.children_menu.items=[{disabled:true,html:loading_html}];this.children_menu.render();this.children_menu.show();return;}
this.on_editor_data_loaded(node,this.children_menu);this.children_menu.render();this.children_menu.show();},render_editor_menu:function(token_elem,align_elem,depth){if(!this.listbox){var cfg={before_show:{fn:function(the_menu){this.editor_menu_showing=true;the_menu.token_elem.focus();},scope:this},after_hide:{fn:function(the_menu){if(!this.keep_menu_showing)
this.editor_menu_showing=false;},scope:this},canceled:{fn:this.on_editor_menu_canceled,scope:this},menu_class:'sgw_review_app_token_autocomplete'};this.listbox=this.new_component(SG.ListBox,cfg);}
this.listbox.position={dom_elem:align_elem,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};this.listbox.token_elem=token_elem;var node=this.rendered_node.get_ancestor_at_depth(depth);var items=[];if(node.async&&!node.children_are_loaded()&&!this.fetching_data){node.fetch_children({fn:function(){this.fetching_data=false;this.on_editor_data_loaded(node,this.listbox);this.listbox.render();if(this.editor_menu_showing){this.keep_menu_showing=true;this.listbox.show();this.keep_menu_showing=false;}else
this.listbox.hide();},scope:this});this.fetching_data=true;var loading_html=this.templates.loading_menu_contents.apply();this.listbox.items=[{disabled:true,html:loading_html}];this.listbox.render();this.listbox.show();return;}
this.on_editor_data_loaded(node,this.listbox);this.listbox.render();this.listbox.show();},on_click:function(e){var target=Ext.get(e.getTarget());var elem;var token_elem=Ext.get(target.findParent('div.token',this.container));var home_elem=Ext.get(target.findParent('div.home_button',this.container));if(token_elem||home_elem){var depth,pc_elem;if(token_elem){depth=Number(token_elem.dom.getAttribute('depth'));this.select_token_at_depth(depth);elem=Ext.get(target.findParent('div.menu_hit_area',this.container));if(!elem)return;pc_elem=Ext.get(elem.findParent('div.token'));if(!pc_elem)
return;}else{depth=0;elem=home_elem;pc_elem=home_elem;}
if(SG.Menu.now_showing===this.children_menu&&this.children_menu.depth===depth){SG.Menu.now_showing.cancel();SG.Menu.now_showing=null;}else{this.render_selection_menu(pc_elem,elem,depth);}
return;}
elem=Ext.get(target.findParent('div.refresh_button'));if(elem&&!this.loading&&this.refresh_callback){this.refresh_callback.fn.call(this.refresh_callback.scope);return;}
elem=Ext.get(target.findParent('div.cancel_button'));if(elem&&this.loading){this.set_loading(false);if(this.cancel_callback)
this.cancel_callback.fn.call(this.cancel_callback.scope,this.node);return;}
elem=Ext.get(target.findParent('div.favorite'));if(elem){var is_favorite=SG.ReviewApp.Utils.node_is_favorite(this.rendered_node);if(is_favorite){SG.ReviewApp.Utils.unfavorite_node(this.rendered_node);this.favorite_button_div.removeClass('favorited');}else{SG.ReviewApp.Utils.favorite_node(this.rendered_node);this.favorite_button_div.addClass('favorited');}
return;}
elem=Ext.get(target.findParent('div.jump_to_shotgun'));if(elem&&elem.hasClass('displayed')&&this.rendered_node.shotgun_detail_url){var url=this.rendered_node.shotgun_detail_url;url=window.location.protocol+'//'+window.location.host+url;if(SG.globals.review_app_player)
SG.globals.review_app_player.open_external_browser(url);else
window.open(url);return;}},on_dblclick:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.token'),this.container);if(elem){var menu_hit_area=Ext.get(target.findParent('div.menu_hit_area',this.container));if(menu_hit_area)return;this.render_editor_at_depth(Number(elem.dom.getAttribute('depth')));return;}
if(target.hasClass('path')){var depth=this.rendered_node.get_depth();if(depth){if(this.rendered_node.has_children())
this.render_editor_at_depth(depth+1);else
this.render_editor_at_depth(depth);}else{this.render_editor_at_depth(1);}
return;}},on_mousedown:function(e){var target=Ext.get(e.getTarget());if(target.hasClass('path')&&!this.editing){var depth=this.rendered_node.get_depth();var path_token_div=this.container.child('div.token[depth="'+depth+'"]');if(depth>=1&&path_token_div){e.stopEvent();path_token_div.focus();}
return;}},on_editor_data_loaded:function(node,menu){var editor=this.path_div.child('input.token_editor');var filter;if(editor&&editor.dom.value!=='')
filter=editor.dom.value;menu.items=this.get_token_menu_items_filtered(node,filter);},on_node_selected:function(node,skip_target_selected_callback){var execute_callback=!skip_target_selected_callback&&node.is_target&&this.target_selected_callback;var still_editing=node.supports_children&&node.has_children()&&!execute_callback;this.clear_editor(still_editing);var callback={fn:function(){if(still_editing){this.skip_path_reset=true;this.render_editor_at_depth(node.get_depth()+1);this.skip_path_reset=false;}else{if(execute_callback)
this.target_selected_callback.fn.call(this.target_selected_callback.scope,node);this.select_token_at_depth(node.get_depth());}},scope:this};if(execute_callback)
this.set_node(node);this.render_node(node,callback);},on_editor_focus:function(e){this.deselect_tokens();},on_editor_blur:function(e){if(this.deleting_editor||this.skip_path_reset)return;var target=Ext.get(e.getTarget());var depth=Number(target.dom.getAttribute('depth'));if(this.editor_menu_showing){var menu_depth=Number(this.listbox.token_elem.dom.getAttribute('depth'));if(depth===menu_depth&&this.listbox.menu_mousedown)
return;}
this.clear_editor();this.render_node(this.node);},on_editor_keydown:function(e){var target=Ext.get(e.getTarget());var key=e.getKey();var currently_selected,depth;if(key===Ext.EventObject.UP||key===Ext.EventObject.DOWN){if(!this.listbox||!this.editor_menu_showing)return;this.listbox.key_up_down(key===Ext.EventObject.UP);currently_selected=this.listbox.find_selected(true);if(!currently_selected)return;var node=currently_selected.value;target.dom.value=node.name;e.stopEvent();return;}
if(key===Ext.EventObject.TAB||key===Ext.EventObject.ENTER||key===Ext.EventObject.RIGHT){e.preventDefault();if(key===Ext.EventObject.TAB&&e.hasModifier()&&e.shiftKey){depth=Number(target.dom.getAttribute('depth'));this.skip_path_reset=true;this.clear_editor();this.delete_token_at_depth(depth);this.skip_path_reset=false;return;}
if(!this.listbox)return;if(this.fetching_data){return;}
currently_selected=this.listbox.find_selected(true);if(!currently_selected&&this.listbox.items.length>0){var i=0;while(i<this.listbox.items.length&&(this.listbox.items[i].heading||!this.listbox.items[i].value)){i++;}
currently_selected=this.listbox.items[i];}
if(!currently_selected){return;}
var node=currently_selected.value;var skip_target_selected_callback=key!==Ext.EventObject.ENTER&&!node.is_leaf();this.on_node_selected(node,skip_target_selected_callback);return;}
if(key===Ext.EventObject.BACKSPACE||key===Ext.EventObject.LEFT){depth=Number(target.dom.getAttribute('depth'));if(target.dom.value===''&&depth>1){e.preventDefault();this.skip_path_reset=true;this.clear_editor();this.delete_token_at_depth(depth);this.skip_path_reset=false;}
return;}
if(key===Ext.EventObject.ESC){e.stopEvent();this.skip_path_reset=true;this.clear_editor();this.render_node(this.node);this.skip_path_reset=false;return;}},on_editor_keyup:function(e){var key=e.getKey();if(!e.isSpecialKey()){if(this.fetching_data)return;var depth=this.rendered_node.get_depth();if(this.rendered_node.async&&!this.rendered_node.children_are_loaded()){this.fetching_data=true;this.rendered_node.fetch_children({fn:function(){this.on_editor_data_loaded(this.rendered_node,this.listbox);this.listbox.render();this.listbox.show();this.fetching_data=false;this.fetching_data_path=null;},scope:this});return;}
this.on_editor_data_loaded(this.rendered_node,this.listbox);this.listbox.render();this.listbox.show();return;}},on_editor_menu_canceled:function(){var editor=this.path_div.child('input.token_editor');if(editor)
editor.focus();},on_token_focus:function(e){var target=Ext.get(e.getTarget());var depth=Number(target.dom.getAttribute('depth'));this.select_token_at_depth(depth);},on_token_blur:function(e){var target=Ext.get(e.getTarget());if(this.deleting_nodes)return;var depth=target.dom.getAttribute('depth');if(this.editor_menu_showing){var menu_depth=this.listbox.token_elem.dom.getAttribute('depth');if(depth===menu_depth&&this.listbox.menu_mousedown)
return;}
if(document.activeElement){var focused=Ext.get(document.activeElement);if(focused&&focused.hasClass('token')&&focused.dom.getAttribute('depth')===depth)
return;if(!this.editing&&!this.rendered_node.is_target&&focused&&!focused.hasClass('token')){this.render_node(this.node);return;}}
if(this.listbox)
this.listbox.hide();target.removeClass('selected');},on_token_keydown:function(e){var target=Ext.get(e.getTarget());var key=e.getKey();var depth;if(key===Ext.EventObject.TAB){depth=Number(target.dom.getAttribute('depth'));if(depth>=this.rendered_node.get_depth()&&!this.rendered_node.has_children){e.stopEvent();this.render_editor_at_depth(depth+1);}
return;}
if(key===Ext.EventObject.ENTER||key===Ext.EventObject.BACKSPACE||key===Ext.EventObject.DELETE||key===Ext.EventObject.LEFT){depth=Number(target.dom.getAttribute('depth'));this.render_editor_at_depth(depth);return;}
if(key===Ext.EventObject.UP||key===Ext.EventObject.HOME){this.select_token_at_depth(1);return;}
if(key===Ext.EventObject.DOWN||key===Ext.EventObject.END){this.select_token_at_depth(this.rendered_node.get_depth());return;}
if(key===Ext.EventObject.ESC){e.stopEvent();this.clear_editor();this.render_node(this.node);return;}},set_node:function(node){this.node=node.copy();},select_token_at_depth:function(depth){var selected_divs=sg_find_all('div.token.selected',this.path_div.dom);var i,token_div;for(i=0;i<selected_divs.length;i++){if(depth===Number(selected_divs[i].getAttribute('depth')))
token_div=Ext.get(selected_divs[i]);else
Ext.fly(selected_divs[i]).removeClass('selected');}
if(!token_div){token_div=this.path_div.child('div.token[depth="'+depth+'"]');if(!token_div)
return;}
token_div.addClass('selected');token_div.focus();},delete_token_at_depth:function(depth){var node;if(depth>1)
node=this.rendered_node.get_ancestor_at_depth(depth-1);else
node=this.rendered_node.get_ancestor_at_depth(1);var callback={fn:function(){if(depth>1)
this.select_token_at_depth(node.get_depth());else
this.render_editor_at_depth(1);},scope:this};this.render_node(node,callback);},path_is_loaded:function(node,after_load_callback){var nodes=[];var parent=node;while(parent){if(parent.async&&!parent.data_is_loaded())
nodes.push(parent);parent=parent.get_parent();}
if(!nodes.length&&SG.ReviewApp.Utils.favorites_loaded()&&SG.ReviewApp.Utils.recent_loaded())
return true;var callback={fn:function(){this.after_path_loaded(nodes,after_load_callback);},scope:this};var loading=false;var i;for(i=0;i<nodes.length;i++)
if(!nodes[i].data_is_loaded()){loading=true;nodes[i].fetch_data(callback);}
if(!SG.ReviewApp.Utils.favorites_loaded()){loading=true;SG.ReviewApp.Utils.fetch_favorites(callback);}
if(!SG.ReviewApp.Utils.recent_loaded()){loading=true;SG.ReviewApp.Utils.fetch_recent(callback);}
if(!loading)
return true;return false;},after_path_loaded:function(nodes,after_load_callback){var i;for(i=0;i<nodes.length;i++)
if(!nodes[i].data_is_loaded())
return;if(!SG.ReviewApp.Utils.favorites_loaded())
return;if(!SG.ReviewApp.Utils.recent_loaded())
return;if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},deselect_tokens:function(){var selected_divs=sg_find_all('div.token.selected',this.path_div.dom);var i,path_token_div;for(i=0;i<selected_divs.length;i++)
Ext.get(selected_divs[i]).removeClass('selected');},clear_editor:function(still_editing){if(this.deleting_editor)return;this.deleting_editor=true;var editor=this.path_div.child('input.token_editor');if(editor)
editor.remove();if(this.listbox)
this.listbox.hide();this.deleting_editor=false;this.editing=still_editing?true:false;},get_group_items_filtered:function(node,filter,regex,current_node){var group_hash={};var groups=node.get_child_groups();var num_groups=0;var i,j,id;for(i=0;i<groups.length;i++){id=groups[i].id;children=node.get_children_for_group(id);if(regex){group_hash[id]=this.filter_nodes(children,regex);}else{group_hash[id]=[];for(j=0;j<children.length;j++)
group_hash[id].push({node:children[j]});}
if(!group_hash[id].length)continue;if(groups[i].force_render_header)
num_groups=2;num_groups+=1;}
var items=[];for(i=0;i<groups.length;i++){children=group_hash[groups[i].id];if(children.length<1)continue;if(num_groups>1)
items.push({heading:groups[i].name});items=items.concat(this.get_menu_items_for_nodes(current_node,children,node,filter));this.remove_duplicate_default_items(items);}
return items;},get_token_menu_items_filtered:function(node,filter){var depth=node.get_depth();var current_node=this.node.get_ancestor_at_depth(depth+1);if(current_node&&current_node.get_parent().get_path()!=node.get_path())
current_node=null;if(!node)return;var items=[];var regex;if(filter){filter=filter.toLowerCase();regex=new RegExp(filter,'i');}
var i,children,group_hash;if(typeof(node.get_child_groups)==='function'){items=this.get_group_items_filtered(node,filter,regex,current_node);}else{children=node.get_children();if(filter){children=this.filter_nodes(children,regex);}else{var temp=[];for(i=0;i<children.length;i++)
temp.push({node:children[i]});children=temp;}
items=items.concat(this.get_menu_items_for_nodes(current_node,children,node,filter));if(node.id==='home'){var fav_node=new SG.ReviewAppFavoritesNode({id:'favorites_and_recent',parent:SG.ReviewAppTreeNode.get_root_node()});items=items.concat(this.get_group_items_filtered(fav_node,filter,regex,current_node));}
this.remove_duplicate_default_items(items);}
if(items.length===0){items.push({disabled:true,html:'No matches'});}else{var item_was_checked=false;var first_item_index=-1;for(i=0;i<items.length;i++){if(items[i].checked)
item_was_checked=true;if(first_item_index<0&&items[i].value)
first_item_index=i;if(first_item_index>-1&&item_was_checked)
break;}
if(!item_was_checked&&first_item_index>-1)
items[first_item_index].default_item=true;}
return items;},filter_nodes:function(nodes,regex){var matching_nodes=[];var i,match;for(i=0;i<nodes.length;i++){match=nodes[i].name.match(regex);if(match)
matching_nodes.push({node:nodes[i],match:match});}
matching_nodes.sort(function(a,b){if(a.match.index>b.match.index)
return 1;if(a.match.index<b.match.index)
return-1;return 0;});return matching_nodes;},get_menu_items_for_nodes:function(current_node,nodes,parent_node,filter){var items=[];var i,node,display_name,checked,item;for(i=0;i<nodes.length;i++){node=nodes[i].node;display_name=node.name;if(filter&&nodes[i].match&&this.listbox)
display_name=this.listbox.highlight_string(filter,display_name)||display_name;if(parent_node.id==='favorites_and_recent'&&node.project_id)
display_name+=' <span class="project_name">'+sg_project_name(node.project_id)+'</span>';checked=current_node?current_node.id===node.id:false;var icon_class=node.menu_icon_class?node.menu_icon_class:node.icon_class;item={html:display_name,checked:checked,default_item:checked,icon_name:icon_class,value:node,item_selected:{fn:function(menu,item){this.on_node_selected(item.value);},scope:this}};if(!node.is_leaf())
item.submenu={node:node,allow_submenu_click_events:true,before_first_render:{fn:this.on_submenu_before_first_render,scope:this}};items.push(item);}
return items;},remove_duplicate_default_items:function(items){var found_one=false;var i;for(i=0;i<items.length;i++){if(items[i].default_item){if(found_one)
items[i].default_item=false;else
found_one=true;}}},on_submenu_before_first_render:function(menu){var node=menu.node;var items=[];if(node.async&&!node.children_are_loaded()){this.fetching_data=true;node.fetch_children({fn:function(){this.on_editor_data_loaded(node,menu);menu.render();var active_submenu=menu.parent_menu.current_submenu_item_showing;if(active_submenu&&active_submenu.submenu.id===menu.id)
menu.show();else
menu.__hide();this.fetching_data=false;},scope:this});var loading_html=this.templates.loading_menu_contents.apply();menu.items=[{disabled:true,html:loading_html}];return;}
this.on_editor_data_loaded(node,menu);},favorites_changed:function(args){var is_favorite,node;if(args.added){node=args.added.node;is_favorite=true;}else if(args.removed){node=args.removed.node;is_favorite=false;}else{return;}
if(node.get_path()!==this.rendered_node.get_path())return;if(is_favorite)
this.favorite_button_div.addClass('favorited');else
this.favorite_button_div.removeClass('favorited');},set_loading:function(state){this.loading=state;this.refresh_button_div.setDisplayed(!state);this.cancel_button_div.setDisplayed(state);},start_update_indicator:function(){this.refresh_button_div.addClass('updating');},stop_update_indicator:function(){this.refresh_button_div.removeClass('updating');}});SG.ReviewAppColumnBrowser=function(config){Ext.apply(this,config);SG.ReviewAppColumnBrowser.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppColumnBrowser,SG.Component,{templates:{main:'<div class="sgc_review_app_column_browser {extra_classes}" depth="0">'+'<div class="menu_area_wrapper">'+'<div class="menu_area">'+'{previous_page_button}'+'<div class="title_area">'+'<div class="page_title old"></div>'+'<div class="page_title current"></div>'+'</div>'+'{menu_bar_right}'+'</div>'+'</div>'+'<div class="column_browser_contents">{page_wrappers}</div>'+'</div>',page_wrapper:'<div class="page_wrapper {extra_classes}" depth="{depth}"></div>',previous_page_button:'<div class="previous_page_button">'+'<div class="previous_page_left"></div>'+'<div class="previous_page_mid">'+'<div class="previous_page_button_text"></div>'+'<div class="loading_indicator"></div>'+'</div>'+'<div class="previous_page_right"></div>'+'</div>',loading_page:'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div>'},init_component:function(){this.on_first_render();this.pages={};var depth=this.depth;if(this.node&&!this.depth)
depth=this.node.get_depth();if(this.node)
this.set_node_at_depth(this.node,depth,true,true,this.after_render_callback);},on_first_render:function(){var page_wrappers_html='';var i;for(i=0;i<this.max_depth;i++)
page_wrappers_html+=this.templates.page_wrapper.apply({depth:i});var previous_page_button=this.templates.previous_page_button.apply();this.container.update(this.templates.main.apply({extra_classes:this.extra_classes?this.extra_classes:'',menu_bar_right:this.menu_bar_right?this.menu_bar_right:'',previous_page_button:previous_page_button,page_wrappers:page_wrappers_html}));this.main_div=this.container.child('div.sgc_review_app_column_browser');this.contents_div=this.main_div.child('div.column_browser_contents');this.title_area_div=this.main_div.child('div.title_area');this.previous_page_button_div=this.main_div.child('div.previous_page_button');this.add_event(this.container,'click',this.on_click);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.previous_page_button',this.main_div));if(elem&&!this.page_loading&&this.current_depth>0){this.previous_page_button_div.addClass('loading');var callback={fn:function(){this.previous_page_button_div.removeClass('loading');},scope:this};this.previous_page(false,callback);return;}},page_exists:function(page_idx){return this.pages.hasOwnProperty(page_idx);},previous_page:function(refresh,after_render_callback){var depth=this.current_depth;if(depth<1)return;var callback={fn:function(){if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);if(this.previous_page_callback)
this.previous_page_callback.fn.call(this.previous_page_callback.scope,depth-1);},scope:this};this.set_node_at_depth(this.node,depth-1,refresh,false,callback);},next_page:function(child_id,after_render_callback){var node=this.node.get_ancestor_at_depth(this.current_depth);var child_node=node.get_child_by_id(child_id);if(!child_node)return;this.set_target_node(child_node);this.set_node(child_node,false,false,after_render_callback);},set_target_node:function(target_node){this.target_node=target_node;},init_page:function(node,depth){var id=node.id;var page_wrapper_div=this.contents_div.child('div.page_wrapper[depth="'+depth+'"]');var page_type=this.get_page_class_from_id(id);var page_node=node.get_ancestor_at_depth(depth);if(!this.target_node)
this.target_node=node;var cfg={container:page_wrapper_div,node:page_node,target_node:this.target_node,depth:depth};var new_page=this.new_component(page_type,cfg);this.pages[depth]=new_page;},set_node:function(node,refresh,skip_anim,after_render_callback,skip_title_anim){var depth=node.get_depth();if(node.is_leaf()&&depth>0)
--depth;this.set_node_at_depth(node,depth,refresh,skip_anim,after_render_callback,skip_title_anim);},set_node_at_depth:function(node,depth,refresh,skip_anim,after_render_callback,skip_title_anim){if(skip_anim)
this.skip_anim=true;if(depth>this.max_depth)return;if(!refresh&&this.node&&node.get_path()===this.node.get_path()&&depth===this.current_depth)
return;if(!refresh&&this.page_loading)return;this.page_loading=true;if(!this.node)
this.show_loading_overlay();if(refresh||!this.page_exists(depth))
this.init_page(node,depth);this.node_to_render=node;this.depth_to_render=depth;if(this.pages[depth].is_rendered()){this.on_page_rendered(node,depth,refresh,after_render_callback,skip_title_anim);return;}
if(!this.pages[depth].is_loaded()){this.pages[depth].fetch_data({fn:function(){this.on_page_loaded(node,depth,refresh,after_render_callback,skip_title_anim);},scope:this});return;}
this.on_page_loaded(node,depth,refresh,after_render_callback,skip_title_anim);},move_pages:function(node,depth,refresh,skip_title_anim,after_render_callback){var first_page_div=this.contents_div.child('div.page_wrapper[depth="0"]');var width=first_page_div.getWidth()*this.max_depth;if(this.contents_div.getWidth()<width)
this.contents_div.setWidth(width);var left=this.pages[depth].container.getX();var target=this.main_div.getX();var delta_x=target-left;var easing=depth<this.current_depth?'easeOut':'easeIn';var cfg;if(!this.skip_anim)
cfg={duration:0.2,easing:easing,callback:function(){this.on_after_pages_moved(node,depth,refresh,after_render_callback);},scope:this};this.contents_div.setX(this.contents_div.getX()+delta_x,cfg);var anim_cfg;if(!this.skip_anim)
anim_cfg={duration:0.2,easing:easing};if(!skip_title_anim){var direction=depth<this.current_depth?-1:1;var new_title=node.get_ancestor_at_depth(depth).name;this.animate_title(new_title,direction,anim_cfg);}
this.main_div.dom.setAttribute('depth',depth);this.previous_page_button_div.dom.className=this.previous_page_button_div.dom.className;if(depth>0){var button_text=this.previous_page_button_div.child('div.previous_page_button_text');var previous_node=node.get_ancestor_at_depth(depth-1);button_text.update(previous_node.name);}
if(!this.skip_anim)return;this.on_after_pages_moved(node,depth,refresh,after_render_callback);},animate_title:function(new_title,direction,anim_cfg,vertical){var orig_menu_bar=this.container.child('div.page_title.current');var new_menu_bar=this.title_area_div.child('div.page_title.old');var left=this.title_area_div.getX();var top=this.title_area_div.getY();var offset=direction<0?65:-65;if(vertical)
offset=direction<0?20:-20;var after_move_callback;if(orig_menu_bar){after_move_callback=function(){orig_menu_bar.update('');if(vertical)
orig_menu_bar.setY(top);else
orig_menu_bar.setX(left);};var opacity_cfg;if(anim_cfg)
opacity_cfg={duration:anim_cfg.duration,easing:anim_cfg.easing,callback:after_move_callback,scope:orig_menu_bar};orig_menu_bar.dom.className='page_title old';if(vertical)
orig_menu_bar.setY(top+offset,anim_cfg);else
orig_menu_bar.setX(left+offset,anim_cfg);orig_menu_bar.setOpacity(0,opacity_cfg);}
new_menu_bar.dom.className='page_title current';if(vertical)
new_menu_bar.setY(top-offset);else
new_menu_bar.setX(left-offset);new_menu_bar.setOpacity(0);new_menu_bar.update(new_title);if(vertical)
new_menu_bar.setY(top,anim_cfg);else
new_menu_bar.setX(left,anim_cfg);new_menu_bar.setOpacity(1,anim_cfg);if(!anim_cfg&&orig_menu_bar)
after_move_callback();},on_page_loaded:function(node,depth,refresh,after_render_callback,skip_title_anim){if(this.node_to_render!==node||this.depth_to_render!==depth)
return;this.pages[depth].render({fn:function(){this.on_page_rendered(node,depth,refresh,after_render_callback,skip_title_anim);},scope:this});},on_page_rendered:function(node,depth,refresh,after_render_callback,skip_title_anim){if(this.node_to_render!==node||this.depth_to_render!==depth)
return;this.hide_loading_overlay();this.move_pages(node,depth,refresh,skip_title_anim,after_render_callback);},on_after_pages_moved:function(node,depth,refresh,after_render_callback){if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);if(refresh||this.current_depth&&depth<this.current_depth){var i;var starting_depth=refresh?0:depth+1;for(i=starting_depth;i<=this.current_depth;i++){if(i===depth||!this.page_exists(i))continue;var old_page=this.pages[i];delete this.pages[i];old_page.container.update('');old_page.tear_down_events();old_page.destroy();}}
if(node.get_depth()>depth+1)
node=node.get_ancestor_at_depth(depth+1);this.page_loading=false;this.node=node;this.current_depth=depth;this.skip_anim=false;},get_page_class_from_id:function(id){if(!this.page_class_map)return null;if(this.page_class_map.hasOwnProperty(id))
return this.page_class_map[id];else if(this.page_class_map.hasOwnProperty('default_class'))
return this.page_class_map.default_class;return null;},show_loading_overlay:function(){var id="review_app_column_browser_loading_overlay";if(!this.__overlay_template_div__&&!(this.__overlay_template_div__=Ext.get(id))){var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(this.main_div,overlay_html,true);}
this.__overlay_template_div__.alignTo(this.main_div,"tl-tl");this.__overlay_template_div__.setWidth(this.main_div.getWidth());this.__overlay_template_div__.setHeight(this.main_div.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__)
this.__overlay_template_div__.hide();}});SG.ReviewAppColumnBrowserPage=function(config){Ext.apply(this,config);SG.ReviewAppColumnBrowserPage.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppColumnBrowserPage,SG.Component,{templates:{main:'<div class="sgc_review_app_column_browser_page"></div>'},render_page:function(container,after_render_callback){},setup_events:function(){},tear_down_events:function(){},fetch_data:function(after_load_callback){},is_loaded:function(){},render:function(after_render_callback){this.rendered=false;this.container.update(this.templates.main.apply());this.main_div=this.container.child('div.sgc_review_app_column_browser_page');if(this.before_render_callback)
this.before_render_callback.fn.call(this.before_render_callback.scope);this.render_page(this.main_div,{fn:function(){this.rendered=true;if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);},scope:this});},is_rendered:function(){return this.rendered;},get_browser:function(){return this.get_parent_component();}});SG.ReviewAppGroupedList=function(config){Ext.apply(this,config);SG.ReviewAppGroupedList.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppGroupedList,SG.Component,{templates:{main:'<div class="sgc_review_app_grouped_list sgw_review_app_scroll_area">'+'<div class="scroll_area"></div>'+'</div>',group:'<div class="group" group_id="{group_id}">'+'{group_header}'+'<div class="group_contents">{group_contents}</div>'+'</div>',group_header:'<div class="group_header_wrapper">'+'<div class="group_header" group_id="{group_id}">{display_name}</div>'+'</div>',item_wrapper:'<div class="grouped_list_item seltarget selectable {selected} {extra_classes}" '+'group_idx="" group_id="{group_id}" item_id="{item_id}" item_idx="{item_idx}" {extra_attributes}>{item}</div>'},destroy_component:function(){if(this.selection_manager)
this.selection_manager.destroy();},on_first_render:function(){try{this.tear_down_events();}catch(e){}
this.container.update(this.templates.main.apply());this.main_div=this.container.child('div.sgc_review_app_grouped_list');this.scroll_area_div=this.main_div.child('div.scroll_area');if(this.advanced_selection){if(this.selection_manager)
this.selection_manager.destroy();var selection_cfg={container:this.main_div,selection_callback:this.selection_callback,context_menu_callback:this.context_menu_callback,drag_selection_container:this.main_div,vertical_selection:true};this.selection_manager=new SG.SelectionManager(selection_cfg);}
this.setup_events();},render:function(after_render_callback){if(!this.rendered)
this.on_first_render();this.group_headers_rendered=false;var i,j,items,groups,items_hash;if(this.is_grouped){items_hash={};var num_groups=0;for(i=0;i<this.groups.length;i++){items=this.get_items_for_group(this.groups[i].id);items_hash[this.groups[i].id]=items;if(items.length<1&&!this.empty_group_render_callback)continue;if(this.groups[i].force_render_header||this.empty_group_render_callback)
num_groups+=1;num_groups+=1;}
this.group_headers_rendered=num_groups>1;}
if(!this.group_headers_rendered&&this.floating_group_header_div){this.floating_group_header_div.remove();this.floating_group_header_div=null;}
var content='';var item_html;if(this.is_grouped){var header,content_html;for(i=0;i<this.groups.length;i++){items=items_hash[this.groups[i].id];if(items.length<1&&!this.empty_group_render_callback)continue;header='';if(this.group_headers_rendered&&!this.groups[i].header_hidden){header=this.templates.group_header.apply({group_id:this.groups[i].id,display_name:this.groups[i].name});}
if(items.length)
item_html=this.render_items(items,this.groups[i].id);else if(this.empty_group_render_callback)
item_html=this.render_empty_group_item(this.groups[i].id);content+=this.templates.group.apply({group_id:this.groups[i].id,group_header:header,group_contents:item_html});}}else{item_html=this.render_items(this.items);if(item_html)
content+=item_html;}
this.scroll_area_div.update(content);this.scroll_to_topmost_selected_item();if(this.group_headers_rendered)
this.render_floating_group_header();if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);},render_items:function(items,group_id){var item_html='';if(!items.length)return;var i,row_html,item_id;for(i=0;i<items.length;i++)
item_html+=this.render_item(items[i],i,items.length,group_id);return item_html;},render_item:function(item,idx,num_items,group_id){var item_id=item.id;var row_html=this.item_render_callback.fn.call(this.item_render_callback.scope,item_id,group_id);return this.templates.item_wrapper.apply({item_id:item.id,item_idx:idx,group_id:group_id,item:row_html,selected:item.selected?'selected':'',extra_classes:(idx===0?'first ':'')+(idx===num_items-1?'last ':'')+
(item.extra_classes||''),extra_attributes:item.extra_attributes});},render_empty_group_item:function(group_id){var content_html=this.empty_group_render_callback.fn.call(this.empty_group_render_callback.scope,group_id);return this.templates.item_wrapper.apply({item_id:'empty',item_idx:'0',group_id:group_id,item:content_html,extra_classes:'first last empty_group'});},render_floating_group_header:function(e){if(!this.group_headers_rendered)return;var div_top=this.main_div.getTop();var div_bottom=this.main_div.getBottom();var do_update=false;if(!this.current_group_div)
do_update=true;else if(this.current_group_div.getTop()>div_top||this.current_group_div.getBottom()<=div_top)
do_update=true;if(do_update){var group_divs=sg_find_all('div.group',this.main_div.dom);var group_id=-1;var i,group_div,top,bottom;for(i=0;i<group_divs.length;i++){group_div=Ext.fly(group_divs[i]);top=group_div.getTop();bottom=group_div.getBottom();if(top<=div_top&&bottom>div_top){group_id=group_div.dom.getAttribute('group_id');group_div=Ext.get(group_divs[i]);break;}}
if(group_id<0)return;this.current_group_div=group_div;if(!this.floating_group_header_div){this.floating_group_header_div=Ext.get(Ext.DomHelper.append(this.main_div,{tag:'div',cls:'floating_group_header'}));var y=this.main_div.getTop();this.floating_group_header_div.position('absolute',1,this.current_group_div.getX(),y);}
var group=this.get_group(group_id);if(group.header_hidden){this.floating_group_header_div.setDisplayed(false);}else{this.floating_group_header_div.setDisplayed(true);var group_header_html=this.templates.group_header.apply({group_id:group_id,display_name:group.name});this.floating_group_header_div.update(group_header_html);}}
var position=this.floating_group_header_div.getStyle('position');var floating_height=this.floating_group_header_div.getHeight();var current_group_top=this.current_group_div.getTop();var current_group_bottom=this.current_group_div.getBottom();var header_div=this.container.child('div.group_header_wrapper');if(!header_div)
return;var floating_max_height=header_div.getHeight();var bottom_moving_off_top=current_group_bottom>div_top&&current_group_bottom<div_top+floating_max_height;var top_moving_into_body=current_group_top>div_top&&current_group_top<div_top+floating_max_height;var new_height;if(bottom_moving_off_top)
new_height=current_group_bottom-div_top;else if(top_moving_into_body)
new_height=current_group_top-div_top;else
new_height=floating_max_height;if(floating_height!=new_height)
this.floating_group_header_div.setHeight(new_height);var current_group_width=this.current_group_div.getWidth();if(this.floating_group_header_div.getWidth()!=current_group_width)
this.floating_group_header_div.setWidth(current_group_width);},on_click:function(e){var elem;var target=Ext.get(e.getTarget());if(!this.advanced_selection){elem=Ext.get(target.findParent('div.grouped_list_item',this.container));if(elem){var item_id=elem.dom.getAttribute('item_id');var group_id=elem.dom.getAttribute('group_id');var select=true;if(this.item_selection_callback)
select=this.item_selection_callback.fn.call(this.item_selection_callback.scope,item_id,e,group_id);if(!select)return;var selected=sg_find_all('div.grouped_list_item.selected',this.container.dom);var i;for(i=0;i<selected.length;i++)
Ext.fly(selected[i]).removeClass('selected');elem.addClass('selected');}}},scroll_to_topmost_selected_item:function(){var selected_divs=sg_find_all('div.grouped_list_item.selected',this.main_div.dom);var max_mid=-1;var top,height,i;for(i=0;i<selected_divs.length;i++){top=Ext.get(selected_divs[i]).getTop()-this.main_div.getTop();height=Ext.get(selected_divs[i]).getHeight();max_mid=Math.max(max_mid,top+Math.floor(height/2));}
if(this.main_div.dom.scrollTop<max_mid&&max_mid<this.main_div.dom.scrollTop+this.main_div.getHeight()){return;}
this.main_div.dom.scrollTop=max_mid-Math.floor(this.main_div.getHeight()/2);},get_group:function(group_id){var i;for(i=0;i<this.groups.length;i++)
if(this.groups[i].id===group_id)
return this.groups[i];},get_items_for_group:function(group_id){var items=[];var i;for(i=0;i<this.items.length;i++)
if(this.items[i].group_id===group_id)
items.push(this.items[i]);return items;},set_items:function(items,groups){this.items=items;this.groups=groups;this.is_grouped=groups&&groups.length>0?true:false;},get_scroll_pos:function(){return this.main_div&&this.main_div.dom.scrollTop;},set_scroll_pos:function(scroll){if(scroll!=null)
this.main_div.dom.scrollTop=scroll;},insert_item:function(item,idx){var index=0;var previous_item_id=null;var i;if(idx>0){var count=0;for(i=0;i<this.items.length;i++){if(!item.group_id||this.items[i].group_id===item.group_id){previous_item_id=this.items[i].id;index=i+1;if(count+1===idx)
break;++count;}}}
var remove_empty_group_item=false;if(item.group_id&&!this.get_items_for_group(item.group_id).length)
remove_empty_group_item=true;this.items.splice(index,0,item);var group_div=this.container.child('div.group[group_id=\''+item.group_id+'\']');if(!group_div)return;var group_items=this.get_items_for_group(item.group_id);var idiv;for(i=0;i<group_items.length;i++){idiv=group_div.child('div.grouped_list_item[item_id=\''+group_items[i].id+'\']');if(!idiv)continue;if(i===0)
idiv.addClass('first');else
idiv.removeClass('first');if(i===group_items.length-1)
idiv.addClass('last');else
idiv.removeClass('last');idiv.dom.setAttribute('item_idx',i);}
var group_contents_div=group_div.child('div.group_contents');if(!group_contents_div)return;var item_html=this.render_item(item,idx,this.items.length,item.group_id);var insert_first=true;var item_div;if(previous_item_id){var selector='div.grouped_list_item[item_id=\''+previous_item_id+'\']';var previous_item_div=group_contents_div.child(selector);if(previous_item_div){item_div=Ext.DomHelper.insertAfter(previous_item_div,item_html,true);insert_first=false;}}
if(insert_first)
item_div=Ext.DomHelper.insertFirst(group_contents_div,item_html,true);var height=item_div.getHeight();item_div.setHeight(0);item_div.setOpacity(0);item_div.setHeight(height,{duration:0.2,easing:'easeIn',callback:function(){item_div.setStyle('height','auto');},scope:this});item_div.setOpacity(1,{opacity:0.2,easing:'easeIn'});if(remove_empty_group_item){var empty_group_div=group_div.child('div.empty_group');if(!empty_group_div)return;empty_group_div.setHeight(0,{duration:0.2,easing:'easeOut',callback:function(){empty_group_div.remove();},scope:this});empty_group_div.setOpacity(0,{duration:0.2,easing:'easeOut'});}},remove_item:function(id,group_id){var index=-1;var i;for(i=0;i<this.items.length;i++)
if(this.items[i].id===id&&this.items[i].group_id===group_id)
index=i;if(index<0)return;this.items.splice(index,1);var group_div=this.container.child('div.group[group_id=\''+group_id+'\']');if(!group_div)return;var group_items=this.get_items_for_group(group_id);var idiv;for(i=0;i<group_items.length;i++){idiv=group_div.child('div.grouped_list_item[item_id=\''+group_items[i].id+'\']');if(!idiv)continue;if(i===0)
idiv.addClass('first');else
idiv.removeClass('first');if(i===group_items.length-1)
idiv.addClass('last');else
idiv.removeClass('last');idiv.dom.setAttribute('item_idx',i);}
var item_div=group_div.child('div.grouped_list_item[item_id=\''+id+'\']');if(!item_div)return;item_div.setHeight(0,{duration:0.2,easing:'easeOut',callback:function(){item_div.remove();},scope:this});item_div.setOpacity(0,{duration:0.2,easing:'easeOut'});if(group_id&&!this.get_items_for_group(group_id).length&&this.empty_group_render_callback){var group_contents_div=group_div.child('div.group_contents');if(!group_contents_div)return;var item_html=this.render_empty_group_item(group_id);var empty_item=Ext.DomHelper.append(group_contents_div,item_html,true);var height=empty_item.getHeight();empty_item.setHeight(0);empty_item.setOpacity(0);empty_item.setHeight(height,{duration:0.2,easing:'easeIn',callback:function(){empty_item.setStyle('height','auto');},scope:this});empty_item.setOpacity(1,{duration:0.2,easing:'easeIn'});}},move_item:function(id,idx,group_id){var index=-1;var current_index=-1;var i;for(i=0;i<this.items.length;i++)
if(this.items[i].group_id===group_id){current_index++;if(this.items[i].id===id){index=i;break;}}
if(index<0||current_index<0||current_index===idx)return;var item=this.items.splice(index,1)[0];item.selected=false;var insert_index=0;var previous_item_id=null;if(idx>0){var count=0;for(i=0;i<this.items.length;i++){if(!item.group_id||this.items[i].group_id===item.group_id){previous_item_id=this.items[i].id;insert_index=i+1;if(count+1===idx)
break;++count;}}}
this.items.splice(insert_index,0,item);var group_div=this.container.child('div.group[group_id=\''+group_id+'\']');if(!group_div)return;var item_div=group_div.child('div.grouped_list_item[item_id=\''+id+'\']');if(!item_div)return;var callback=function(){item_div.remove();var group_contents_div=group_div.child('div.group_contents');if(!group_contents_div)return;var group_items=this.get_items_for_group(group_id);var item_html=this.render_item(item,idx,group_items.length,group_id);var insert_first=true;var new_div;if(previous_item_id){var selector='div.grouped_list_item[item_id=\''+previous_item_id+'\']';var previous_item_div=group_contents_div.child(selector);if(previous_item_div){new_div=Ext.DomHelper.insertAfter(previous_item_div,item_html,true);insert_first=false;}}
if(insert_first)
new_div=Ext.DomHelper.insertFirst(group_contents_div,item_html,true);var height=new_div.getHeight();new_div.setHeight(0);new_div.setOpacity(0);new_div.setHeight(height,{duration:0.2,easing:'easeIn',callback:function(){new_div.setStyle('height','auto');},scope:this});new_div.setOpacity(1,{duration:0.2,easing:'easeIn'});var idiv;for(i=0;i<group_items.length;i++){idiv=group_div.child('div.grouped_list_item[item_id=\''+group_items[i].id+'\']');if(!idiv)continue;if(i===0)
idiv.addClass('first');else
idiv.removeClass('first');if(i===group_items.length-1)
idiv.addClass('last');else
idiv.removeClass('last');idiv.dom.setAttribute('item_idx',i);}};item_div.setHeight(0,{duration:0.2,easing:'easeOut',callback:callback,scope:this});item_div.setOpacity(0,{duration:0.2,easing:'easeOut'});},setup_events:function(){this.add_event(this.container,'click',this.on_click);if(this.main_div)
this.add_event(this.main_div,'scroll',this.render_floating_group_header);Ext.EventManager.onWindowResize(this.render_floating_group_header,this);},tear_down_events:function(){this.remove_event(this.container,'click',this.on_click);if(this.main_div)
this.remove_event(this.main_div,'scroll',this.render_floating_group_header);Ext.EventManager.removeResizeListener(this.render_floating_group_header,this);if(this.floating_group_header_div){this.floating_group_header_div.remove();this.floating_group_header_div=null;}}});SG.ReviewAppToolComponent=function(config){Ext.apply(this,config);SG.ReviewAppToolComponent.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppToolComponent,SG.Component,{destroy_component:function(){this.hide_loading_overlay();},render_tool:function(force){this.dirty=force?true:this.dirty;if(this.dirty||!this.is_current_tool){this.on_first_render();this.dirty=false;}
this.render_menu_bar();},on_first_render:function(){},render_menu_bar:function(){},save_tool_state:function(){this.state_saved=true;this.save_state();},save_state:function(){},restore_tool_state:function(){if(!this.state_saved)return;this.restore_state();this.state_saved=false;},restore_state:function(){},set_is_current_tool:function(is_current){this.is_current_tool=is_current;},accepts_context:function(context){},set_tool_context:function(context,record){if(SG.ReviewApp.Utils.contexts_match(this.get_tool_context(),context))
return;this.set_context(context,record);this.dirty=true;},set_review_app_context:function(context){this.get_details_component().set_tool_context(context);},set_context:function(context){},get_tool_context:function(){return this.get_context();},get_context:function(){},get_details_component:function(){return this.get_parent_component();},get_current_version_fields:function(){return[];},show_loading_overlay:function(container)
{if(!container){container=this.container;}
this.get_parent_widget().show_loading_overlay(container);},hide_loading_overlay:function()
{this.get_parent_widget().hide_loading_overlay();}});SG.ReviewAppRelatedVersions=function(config){Ext.apply(this,config);SG.ReviewAppRelatedVersions.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppRelatedVersions,SG.ReviewAppToolComponent,{templates:{main:'<div class="sgw_review_app_related_versions">'+'<div class="sgw_review_app_related_versions_menus_wrapper">'+'<div class="sgw_review_app_related_versions_menus">{menu_items}</div>'+'</div>'+'<div class="versions_main sgw_review_app_scroll_area"></div>'+'</div>',menu_bar:'<div class="sgw_review_app_related_versions_top_pane">'+'<div class="bold_title"></div>'+'</div>',menu_item:'<div class="menu_item" menu_type="{menu_type}">{menu_name}<div class="menu_item_triangle"></div></div>',version:'<div class="version_wrapper">{version_contents}</div>',version_contents:'<div class="playing_indicator"></div>'+'<div class="version_body">'+'<div class="thumb">{image}</div>'+'<div class="all_fields">'+'<div class="version_code">{code}</div>'+'<div class="fields">{field_rows}</div>'+'</div>'+'</div>',field_row:'<div class="field">'+'<div class="field_name" sg_tip="{field_name}"><div>{field_name}</div></div>'+'<div class="field_value {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>'+'</div>',thumb:'<div class="thumbnail">'+'{image}'+'<div class="review_app_flagged_indicator"></div>'+'</div>',image:'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>'},init_component:function(){this.set_tool_context(this.initial_context);this.linked_entity=null;this.grouping_settings={};this.locked_fields=['image','code'];var use_default_settings=false;var encoded_settings=getCookie('review_app_related_versions_columns');if(!encoded_settings){use_default_settings=true;}else{var settings=Ext.decode(encoded_settings);if(!settings.hasOwnProperty('columns')||!settings.hasOwnProperty('sorts')||!settings.hasOwnProperty('grouping')){use_default_settings=true;}else{this.grouping=settings.grouping;this.columns=settings.columns;this.sorts=settings.sorts;}}
if(use_default_settings){this.grouping=null;this.columns=[{field:'image',show_label:false},{field:'code',show_label:false},{field:'user',show_label:false},{field:'sg_status_list',show_label:false}];this.sorts=[{column:'id',direction:'desc'}];}
if(SG.globals.review_app_player)
SG.globals.review_app_player.on('viewed_versions_changed',this.indicate_currently_playing_versions,this);SG.NotificationCenter.add_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});},destroy_component:function(){SG.NotificationCenter.remove_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});},on_first_render:function(){var menu_items=[{type:'sorting',display_name:'Sort'},{type:'grouping',display_name:'Group'},{type:'fields',display_name:'Fields'}];var menu_html='';var i;for(i=0;i<menu_items.length;i++)
menu_html+=this.templates.menu_item.apply({menu_name:menu_items[i].display_name,menu_type:menu_items[i].type});var html=this.templates.main.apply({menu_items:menu_html});this.container.update(html);this.main_div=this.container.child('div.sgw_review_app_related_versions');this.versions_div=this.container.child('div.versions_main');var cfg={container:this.versions_div,advanced_selection:true,selection_callback:{fn:this.on_entities_selected,scope:this},context_menu_callback:{fn:this.on_contextmenu,scope:this},item_render_callback:{fn:this.render_version,scope:this},is_grouped:this.grouping===null};this.grouped_list=this.new_component(SG.ReviewAppGroupedList,cfg);if(this.related_versions){this.on_related_versions_load();}else{this.fetch_related_versions();this.show_loading_overlay(this.versions_div);}
this.add_event(this.main_div,'click',this.on_click);this.add_event(this.main_div,'dblclick',this.on_dblclick);},render_menu_bar:function(){var html=this.templates.menu_bar.apply();this.menu_bar_container.update(html);if(this.related_versions&&this.related_versions.is_loaded()){var num_versions=this.related_versions.count();var title_div=this.menu_bar_container.child('div.bold_title');title_div.update(''+num_versions+' Related Version'+(num_versions>1?'s':''));}},render:function(){if(!this.related_versions||!this.related_versions.is_loaded())return;this.grouped_list.render({fn:this.indicate_currently_playing_versions,scope:this});this.hide_loading_overlay();},render_version:function(item_id){var record=this.related_versions.get_record_by_id(item_id);var fields_html='';var i,renderer,field_value,field_name,cfg;for(i=0;i<this.columns.length;i++){field_name=this.columns[i].field;if(this.locked_fields.indexOf(field_name)>-1)
continue;cfg=this.cell_manager.get_cell(field_name).render(record);cfg.field_name=SG.schema.get_field_display_name('Version',field_name);fields_html+=this.templates.field_row.apply(cfg);}
var image_html;if(record.get('image')){var cell=this.cell_manager.get_cell('image');cell.skip_revolver_thumb_overlay=true;cell.render_contextmenu_overlay=false;cfg=cell.render(record);image_html=this.templates.image.apply(cfg);}else{image_html='<img src="/images/missing_image.png"/>';}
var contents=this.templates.version_contents.apply({code:record.get('code'),image:this.templates.thumb.apply({image:image_html}),field_rows:fields_html});return this.templates.version.apply({version_contents:contents,extra_classes:(fields_html?'extra_fields_displayed':'')});},fetch_related_versions:function(){this.related_versions=this.new_data_set('Version',this.on_related_versions_load,this.on_related_versions_change);var columns=['flagged'];var i;for(i=0;i<this.columns.length;i++)
columns.push(this.columns[i].field);if(this.linked_entity){SG.ReviewApp.Utils.fetch_versions_for_entity(this.linked_entity.type,this.linked_entity.id,columns,this.sorts,this.grouping,this.related_versions);return;}
var spec={type:'Version',ids:[this.version.id],columns:columns,grouping:this.grouping,result:this.related_versions};SG.Repo.find(spec);},fetch_flagged_states:function(ids){var data_set=new SG.Data.Set('Version');var callback=function(){this.on_flagged_states_load(data_set);};data_set.on('load',callback,this);var spec={type:'Version',ids:ids,columns:['flagged'],result:data_set};SG.Repo.find(spec);},on_related_versions_load:function(){if(!this.related_versions.is_loaded()){return;}
var cfg={container:this.container,data_set:this.related_versions,projects:this.get_parent_widget().context_projects(),field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this},read_only:true};this.cell_manager=this.new_component(SG.CellManager,cfg);this.render_menu_bar();var groups=[];var items=[];var i,selected,record;if(this.related_versions.grouped){var group,display_name,column,j;for(i=0;i<this.related_versions.groups.length;i++){group=this.related_versions.groups[i];display_name=group.display_values.join(', ');if(!display_name){column=this.grouping[0].column;display_name='No '+SG.schema.get_field('Version',column).display_name;}
groups.push({id:group.idx.toString(),name:display_name,force_render_header:true});for(j=0;j<group.ids.length;j++){record=this.related_versions.get_record_by_id(group.ids[j]);selected=false;if(this.selected_versions&&this.selected_versions.length>0){selected=this.selected_versions.indexOf(group.ids[j])>-1;}else if(this.version){selected=group.ids[j]===this.version.id;this.selected_versions=[this.version.id];}
items.push({id:group.ids[j],group_id:group.idx.toString(),selected:selected,extra_classes:'version '+(record.get('flagged')?'flagged':''),extra_attributes:'record_id="'+group.ids[j]+'"'});}}}else{var id;for(i=0;i<this.related_versions.count();i++){record=this.related_versions.get_record(i);id=record.get_id();selected=false;if(this.selected_versions&&this.selected_versions.length>0){selected=this.selected_versions.indexOf(id)>-1;}else if(this.version){selected=id===this.version.id;this.selected_versions=[this.version.id];}
items.push({id:id.toString(),selected:selected,extra_classes:'version '+(record.get('flagged')?'flagged':''),extra_attributes:'record_id="'+id+'"'});}}
this.grouped_list.set_items(items,groups);this.render();this.restore_tool_state();},on_related_versions_change:function(changes){var record_ids=[];var change,i,id,vdiv;for(i=0;i<changes.length;i++){change=changes[i];if(change.state!=='pending'&&change.type==='update'&&change.column==='flagged')
record_ids.push(change.record.get_id());}
if(record_ids.length)
SG.ReviewApp.Utils.notify_flag_state_changed(record_ids,'related_versions');},on_flagged_states_load:function(data_set){var i,record,id,orig_record,flagged;for(i=0;i<data_set.count();i++){record=data_set.get_record(i);id=record.get_id();orig_record=this.related_versions.get_record_by_id(id);if(!orig_record)continue;flagged=record.get('flagged');orig_record.set('flagged',flagged);this.update_flagged_state(id,flagged);}},on_entities_selected:function(selection){this.selected_versions=sg_deep_copy(selection);return true;},on_click:function(e){if(!this.is_current_tool)
return;var elem;var target=Ext.get(e.getTarget());elem=Ext.get(target.findParent('div.menu_item[menu_type=sorting]',this.container));if(elem){if(!this.sort_menu){this.sort_menu_toolbar_div=elem;this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this}});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'Version',no_advanced:true,get_sorts_callback:{fn:this.on_get_sorts,scope:this},set_sorts_callback:{fn:this.on_set_sorts,scope:this}});}
this.sort_menu.show();return;}
elem=Ext.get(target.findParent('div.menu_item[menu_type=grouping]',this.container));if(elem){if(!this.grouping_menu){this.grouping_menu_toolbar_div=elem;this.grouping_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_grouping_menu,scope:this}});this.grouping_menu_helper=new SG.util.GroupingMenuHelper({entity_type:'Version',no_advanced:true,grouping_setting_callback:{fn:this.get_grouping_settings,scope:this},on_grouping_field:{fn:this.on_grouping_field_menu_item,scope:this}});}
this.grouping_menu.show();return;}
elem=Ext.get(target.findParent('div.menu_item[menu_type=fields]',this.container));if(elem){if(!this.fields_menu){this.fields_menu_toolbar_div=elem;this.fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this}});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return this.locked_fields.indexOf(field_name)>-1;},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var i;for(i=0;i<this.columns.length;i++){if(this.columns[i].field===field_name)
return true;}
return false;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
this.fields_menu.show();return;}},on_contextmenu:function(e){if(!this.is_current_tool)
return;var elem;var target=Ext.get(e.getTarget());elem=Ext.get(target.findParent('div.version',this.versions_div));if(elem&&elem.hasClass('selected')&&this.selected_versions)
{e.stopEvent();if(!this.context_menu){this.context_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){var version_div=the_menu.target_elem.findParent('div.version_row',this.versions_div,true);the_menu.items=[];if(SG.globals.review_app_player&&this.selected_versions.length==1){if(SG.globals.review_app_player.supports_version_swap_for_entities()){if(SG.globals.review_app_player.version_loaded_for_entity(this.linked_entity))
the_menu.items.push({html:'Swap Into Sequence',item_selected:{fn:function(){var version_id=this.selected_versions[0];SG.globals.review_app_player.swap_versions_for_entities([version_id],[this.linked_entity]);},scope:this}});}
the_menu.items.push({html:'Replace',item_selected:{fn:this.view_selected_version,scope:this}});}
if(SG.globals.review_app_player&&SG.globals.review_app_player.supports_comparison()){if(this.selected_versions.length>1)
the_menu.items.push({html:'Compare Selected',item_selected:{fn:this.compare_versions,scope:this}});the_menu.items.push({html:'Compare With Current',item_selected:{fn:this.compare_versions_with_current,scope:this}});}
var selected_are_flagged=this.versions_are_flagged(this.selected_versions);var user_can_flag=SG.schema.can_edit_field('Version','flagged');if(selected_are_flagged){the_menu.items.push({html:'Unflag Selected',item_selected:{fn:function(){this.flag_versions_by_id(this.selected_versions,true);},scope:this},icon_name:'review_app_unflagged_menu_item',disabled:!user_can_flag});}else{the_menu.items.push({html:'Flag Selected',item_selected:{fn:function(){this.flag_versions_by_id(this.selected_versions);},scope:this},icon_name:'review_app_flagged_menu_item',disabled:!user_can_flag});}
the_menu.render();},scope:this}});}
this.context_menu.target_elem=target;this.context_menu.position={xy:e.getXY()};this.context_menu.show();return;}},on_dblclick:function(e){if(!this.is_current_tool)
return;var elem;var target=Ext.get(e.getTarget());elem=target.findParent('div.version',this.versions_div);var is_field=target.findParent('div.version_field',this.versions_div)!==null;if(elem&&!is_field){this.view_selected_version();return;}},on_flagged_state_changed:function(args){var record_ids=args.version_ids;var sender=args.sender;if(!this.is_current_tool||sender==='related_versions')return;var visible_record_ids=[];var i;for(i=0;i<record_ids.length;i++){if(this.related_versions.get_record_by_id(record_ids[i]))
visible_record_ids.push(record_ids[i]);}
if(visible_record_ids.length)
this.fetch_flagged_states(visible_record_ids);},on_get_sorts:function(){return this.sorts;},on_set_sorts:function(new_sorts){this.sorts=new_sorts;this.save_settings();this.show_loading_overlay(this.versions_div);this.fetch_related_versions();},on_before_show_sort_menu:function(menu){menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};menu.items=this.sorting_menu_helper.get_menu_items();menu.render();},on_before_show_grouping_menu:function(menu){menu.position={dom_elem:this.grouping_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};menu.items=this.grouping_menu_helper.get_menu_items();menu.render();},on_grouping_field_menu_item:function(menu,item){if(item.value=="__ungroup__"||(item.checked&&item.no_ungrouping!==true))
this.set_grouping_settings(null);else
this.set_grouping_settings([item.value]);this.show_loading_overlay(this.versions_div);this.fetch_related_versions();},on_before_show_fields_menu:function(menu){menu.position={dom_elem:this.fields_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};menu.items=this.fields_menu_helper.get_menu_items();menu.render();},view_selected_version:function(){if(!SG.globals.review_app_player||(this.selected_versions&&this.selected_versions.length<1))return;var version_id=this.selected_versions[0];this.version={type:'Version',id:version_id};this.set_review_app_context([this.version]);SG.globals.review_app_player.view_versions([version_id]);},compare_versions_with_current:function(){if(!SG.globals.review_app_player||!SG.globals.review_app_player.supports_comparison())
return;if(this.selected_versions&&this.selected_versions.length<1)
return;var version_ids=SG.globals.review_app_player.get_viewed_versions();if(!version_ids)return;var i,j;for(i=0;i<this.selected_versions.length;i++){var skip_id=false;for(j=0;j<version_ids.length;j++){if(version_ids[j]===this.selected_versions[i]){skip_id=true;break;}}
if(skip_id)
continue;version_ids.push(this.selected_versions[i]);}
SG.globals.review_app_player.compare_versions(version_ids);},compare_versions:function(){if(!SG.globals.review_app_player||!SG.globals.review_app_player.supports_comparison())
return;if(this.selected_versions&&this.selected_versions.length<1)
return;var version_ids=[];var i;for(i=0;i<this.selected_versions.length;i++)
version_ids.push(this.selected_versions[i]);this.version={type:'Version',id:version_ids[0]};this.set_review_app_context([this.version]);SG.globals.review_app_player.compare_versions(version_ids);},versions_are_flagged:function(record_ids){var i,record;for(i=0;i<record_ids.length;i++){record=this.related_versions.get_record_by_id(record_ids[i]);if(!record)continue;if(!record.get('flagged'))
return false;}
return true;},flag_versions_by_id:function(record_ids,unflag){var records=[];var i,record,vdiv;for(i=0;i<record_ids.length;i++){record=this.related_versions.get_record_by_id(record_ids[i]);if(!record)continue;this.update_flagged_state(record_ids[i],unflag?false:true);records.push(record);}
SG.ReviewApp.Utils.flag_version_records(records,unflag);},update_flagged_state:function(id,flagged){var vdiv=this.versions_div.child('div.version[record_id='+id+']');if(!vdiv)return;if(flagged)
vdiv.addClass('flagged');else
vdiv.removeClass('flagged');},indicate_currently_playing_versions:function(){if(!SG.globals.review_app_player||!this.versions_div)return;var version_ids=SG.globals.review_app_player.get_loaded_versions();if(!version_ids)return;var now_playing_divs=sg_find_all('div.version.now_playing',this.versions_div.dom);var i;for(i=0;i<now_playing_divs.length;i++)
Ext.fly(now_playing_divs[i]).removeClass('now_playing');var current_divs=sg_find_all('div.version.current',this.versions_div.dom);for(i=0;i<current_divs.length;i++)
Ext.fly(current_divs[i]).removeClass('current');var version_div;for(i=0;i<version_ids.length;i++){version_div=this.versions_div.child('div.version[record_id="'+version_ids[i]+'"]');if(!version_div)continue;version_div.addClass('now_playing');if(version_ids[i]===this.version.id)
version_div.addClass('current');}},get_grouping_settings:function(){if(!this.grouping)return false;var grouping=[];for(var i=0;i<this.grouping.length;i++)
{var group=this.grouping[i];var schema_field=SG.schema.get_field('Version',group.column);if(schema_field!=null&&!schema_field.no_grouping)
grouping.push(group);}
if(grouping.length===0)
return null;return grouping;},set_grouping_settings:function(grouping){this.grouping=grouping;this.grouping_settings={};this.save_settings();if(this.nested_grouping_dialog&&!this.nested_grouping_dialog.__destroyed__)
{var grouping_for_dialog=grouping;if(grouping_for_dialog===false)
grouping_for_dialog=[null];this.nested_grouping_dialog.grouping=grouping_for_dialog;this.nested_grouping_dialog.render();}},toggle_field:function(menu,item){if(this.locked_fields.indexOf(item.field)>-1)return;var field_index=-1;var i;for(i=0;i<this.columns.length;i++){if(this.columns[i].field===item.field)
field_index=i;}
if(field_index>-1)
this.columns.splice(field_index,1);else
this.columns.push({field:item.field,show_label:false});this.save_settings();this.show_loading_overlay(this.versions_div);this.fetch_related_versions();},get_field_property_for_cell_manager:function(schema_field){for(var i=0;i<this.columns.length;i++){var field_property=this.columns[i];if(field_property.field==schema_field.name)
return field_property;}
return null;},save_settings:function(){var settings={columns:this.columns,sorts:this.sorts,grouping:this.grouping};setCookie('review_app_related_versions_columns',Ext.encode(settings),365);},accepts_context:function(context){if(context.length===1&&context[0].type==='Version')
return true;return false;},get_context:function(){return this.version?[this.version]:null;},set_context:function(context,record){this.version=context?context[0]:null;if(record){var entity=record.get('entity');if(entity&&this.linked_entity&&entity.type===this.linked_entity.type&&entity.id===this.linked_entity.id){this.skip_render=true;this.indicate_currently_playing_versions();return;}else{this.linked_entity=entity;this.skip_render=false;}}else{this.linked_entity=null;}
this.related_versions=null;this.selected_versions=null;this.scroll_position=0;},get_current_version_fields:function(){return['entity'];},save_state:function(){this.scroll_position=this.versions_div.dom.scrollTop;},restore_state:function(){this.versions_div.dom.scrollTop=this.scroll_position;}});SG.Widget.ReviewAppBrowser=function(context,widget_spec,id){SG.Widget.ReviewAppBrowser.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ReviewAppBrowser,SG.Widget.Base,{default_settings:{filter_panel_settings:{}},templates:{main:'<div class="sgw_review_app_browser {render_mode} {browser_open} {filter_panel_open}">'+'<div class="browser_pane"></div>'+'<div class="main_wrapper">'+'<div class="top_pane_wrapper">'+'<div class="top_pane {no_right_controls}">'+'<div>'+'<div class="sgw_review_app_switch browser_button {browser_button_active}">'+'<div class="button_icon browser_icon"></div>'+'</div>'+'</div>'+'<div class="nav_bar"></div>'+'<div>'+'<div class="history_button sgw_review_app_switch" sg_tip="History options">'+'<div class="button_icon history_icon"></div>'+'<div class="button_icon drop_down_arrow"></div>'+'</div>'+'</div>'+'<div>'+'<div class="sort_button sgw_review_app_switch" sg_tip="Sorting options">'+'<div class="button_icon sort_icon"></div>'+'<div class="button_icon drop_down_arrow"></div>'+'</div>'+'</div>'+'<div class="mode_switcher"></div>'+'<div class="search_field"></div>'+'<div>'+'<div class="sgw_review_app_switch filter_button {filter_active}">'+'<div class="button_icon filter_icon"></div>'+'</div>'+'</div>'+'{right_controls}'+'</div>'+'</div>'+'<div class="bottom_pane">'+'<div class="timeline_message_bar_wrapper">'+'<div class="sgw_review_app_message_bar">'+'<div class="message_content"></div>'+'<div class="close"></div>'+'</div>'+'<div class="timeline_size_slider_wrapper">'+'<div class="timeline_wrapper"><div class="timeline"></div></div>'+'</div>'+'</div>'+'<div class="filter_panel_pane sgc_filter_panel">'+'<div class="filter_panel_wrapper"></div>'+'<div class="filter_panel_more_fields">'+'<span>More Filters</span><div class="dropdown_arrow_small"></div>'+'</div>'+'</div>'+'</div>'+'</div>'+'<div class="pkg_out_of_date_alert"></div>'+'</div>',right_controls:'<div class="right_controls">'+'<div class="close_pane_button"></div>'+'<div class="tear_off_pane_button {floating}"></div>'+'</div>',mode_link:'<div class="mode_button sgw_review_app_switch {extra_class} {active}" query_mode="{mode}" sg_tip="{sg_tip}">'+'<div class="button_icon"></div>'+'</div>',playlist_item:'<div class="playlist_item {extra_classes}" playlist_item_idx="{playlist_item_idx}"></div>',version:'<div class="version seltarget selectable {selected} {active} {flagged}" record_id="{record_id}" '+'group_idx="0" playlist_item_idx="{playlist_item_idx}" sg_tip=\'{sg_tip}\'>'+'<div class="version_body">'+'<div class="content">{thumb}</div>'+'<div class="field">{fields}</div>'+'</div>'+'<div class="playing_indicator"></div>'+'</div>',step_swatch:'<div class="sgw_review_app_browser_step_swatch" style="background-color: rgb({color});"></div>',thumb:'<div class="thumbnail">'+'<div class="thumb_wrapper">'+'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>'+'<div class="review_app_flagged_indicator"></div>'+'</div>'+'</div>',no_version:'<div class="version no_versions" playlist_item_idx="{playlist_item_idx}" sg_tip=\'{sg_tip}\'>'+'<div class="version_body">'+'<div class="content">'+'{thumb}'+'</div>'+'<div class="field">No Versions Available</div>'+'</div>'+'<div class="playing_indicator"></div>'+'</div>',no_thumb:'<div class="no_thumb">'+'<div class="no_version"></div>'+'<div class="review_app_flagged_indicator"></div>'+'</div>',slider:'<div class="slider" style="width: {width}px;">'+'<div class="small_icon"></div><div class="left_cap"></div><div class="middle"></div>'+'<div class="right_cap"></div><div class="large_icon"></div>'+'<div class="knob" id="{slider_id}" style="left: {left}px;"></div>'+'</div>',active_outline_layer:'<div class="active_outline_wrapper">'+'<div class="active_outline"></div>'+'</div>'},init_widget:function(){if(this.parent)
this.context=this.parent.context.clone();},destroy_widget:function(){SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'loading_changed',callback:{fn:this.on_loading_changed,scope:this}});SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'updating_state_changed',callback:{fn:this.on_updating_state_changed,scope:this}});SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'node_changed',callback:{fn:function(args){this.on_node_changed(args.node,args.sender);},scope:this}});SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'filter_settings_changed',callback:{fn:this.on_filter_settings_changed,scope:this}});SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'dataset_empty',callback:{fn:this.on_dataset_empty,scope:this}});SG.NotificationCenter.remove_observer({uuid:'_review_app_canvas_timeline_',name:'no_entity_chosen',callback:{fn:this.on_no_entity_chosen,scope:this}});},on_first_render:function(){this.container=this.get_container();this.add_event(this.container,'click',this.on_click);if(sg_is_in_rv()&&!SG.globals.review_app_player)
SG.globals.review_app_player=new SG.ReviewAppPlayerRV({browser_pane:this});else if(SG.globals.review_app_player)
SG.globals.review_app_player.browser_pane=this;if(SG.globals.review_app_player){SG.globals.review_app_player.on('updates_enabled_changed',this.on_updates_enabled,this);SG.globals.review_app_player.on('docked_state_changed',this.on_docked_state_changed,this);}
this.widget_spec.create_child_spec('canvas_timeline',{type:'SG.Widget.ReviewAppCanvasTimeline',children:{}},this);this.canvas_timeline=this.construct_child('canvas_timeline',this.context.clone());SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'loading_changed',callback:{fn:this.on_loading_changed,scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'updating_state_changed',callback:{fn:this.on_updating_state_changed,scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'node_changed',callback:{fn:function(args){this.on_node_changed(args.node,args.sender);},scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'filter_settings_changed',callback:{fn:this.on_filter_settings_changed,scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'dataset_empty',callback:{fn:this.on_dataset_empty,scope:this}});SG.NotificationCenter.add_observer({uuid:'_review_app_canvas_timeline_',name:'no_entity_chosen',callback:{fn:this.on_no_entity_chosen,scope:this}});var doc_elem=Ext.get(document);doc_elem.on('keydown',this.on_keydown,this);var embedded=SG.globals.review_app_player&&SG.globals.review_app_player.has_embedded_panes();var floating=embedded&&!SG.globals.review_app_player.pane_is_docked('Bottom');var right_controls;if(embedded){right_controls=this.templates.right_controls.apply({floating:floating?'floating':''});}
var browser_open_cookie=getCookie('sgw_review_app_timeline_browser_open');var browser_open=browser_open_cookie?Number(browser_open_cookie):0;var filter_panel_open_cookie=getCookie('sgw_review_app_timeline_filter_panel_open');var filter_panel_open=filter_panel_open_cookie?Number(filter_panel_open_cookie):0;var filter_panel_settings_cookie=getCookie('sgw_review_app_timeline_filter_panel_settings');if(filter_panel_settings_cookie)
this.set('filter_panel_settings',Ext.decode(filter_panel_settings_cookie));var render_mode=this.canvas_timeline.get_render_mode();var html=this.templates.main.apply({no_right_controls:!right_controls?'no_right_controls':'',right_controls:right_controls,render_mode:render_mode+'_mode',browser_open:browser_open?'browser_open':'',filter_panel_open:filter_panel_open?'filter_panel_open':'',filter_active:filter_panel_open?'active':'',browser_button_active:browser_open?'active':''});this.container.update(html);this.main_div=this.container.child('div.sgw_review_app_browser');this.nav_bar_div=this.container.child('div.nav_bar');var cfg={container:this.nav_bar_div,target_selected_callback:{fn:function(node){this.clear_filters();this.canvas_timeline.set_node(node);},scope:this},refresh_callback:{fn:function(){this.canvas_timeline.reload();},scope:this},cancel_callback:{fn:function(){this.canvas_timeline.cancel_loading();this.on_node_changed(this.canvas_timeline.get_node());},scope:this}};this.nav_bar=this.new_component(SG.ReviewAppNavBar,cfg);this.nav_bar.render();this.bottom_pane_div=this.container.child('div.bottom_pane');this.browser_pane_div=this.container.child('div.browser_pane');this.message_bar_div=this.bottom_pane_div.child('div.sgw_review_app_message_bar');this.message_bar_content_div=this.message_bar_div.child('div.message_content');this.timeline_wrapper_div=this.bottom_pane_div.child('div.timeline_wrapper');this.timeline_div=this.bottom_pane_div.child('div.timeline');this.timeline_canvas=this.bottom_pane_div.child('canvas.timeline');this.filter_panel_wrapper_div=this.bottom_pane_div.child('div.filter_panel_wrapper');this.browser=this.new_component(SG.ReviewAppBrowserColumnBrowser,{container:this.browser_pane_div,max_depth:5,page_class_map:{default_class:SG.ReviewAppBrowserColumnBrowserPage},current_node_callback:{fn:function(){return this.canvas_timeline.get_node();},scope:this}});if(browser_open)
this.browser.show_loading_overlay();this.filter_panel=this.new_component(SG.Widget.EntityQuery.FilterPanel,{panel_type:'main',entity_type:'Version',container:this.filter_panel_wrapper_div,filter_panel_on_right:true,widget:this,is_showing_callback:{fn:this.filter_panel_is_showing,scope:this},dataset_total_size_callback:{fn:function(){this.canvas_timeline.get_dataset_size();},scope:this},update_filter_button_callback:{fn:this.update_filter_button,scope:this},through_join_fields_and_parent_callback:{fn:function(){return{through_join_fields:[],parent_entity:null};},scope:this},setting_get_callback:{fn:this.get_filter_panel_setting,scope:this},setting_set_callback:{fn:this.set_filter_panel_setting,scope:this},get_page_filters_callback:{fn:this.get_filters,scope:this},update_filters_callback:{fn:this.update_filters,scope:this},get_displayed_columns_callback:{fn:this.get_displayed_columns,scope:this},extra_scroll_area_class:'sgw_review_app_scroll_area'});this.update_filter_button();this.search_field_div=this.container.child('div.search_field');cfg={container:this.search_field_div,filter_panel:this.filter_panel,locked_to_entity_types:['Sequence','Shot','Asset','Playlist','Page'],item_selected_callback:{fn:this.quickjump_item_selected,scope:this}};this.search_field=this.new_component(SG.ReviewAppSearchField,cfg);this.search_field.render();this.mode_switcher_div=this.container.child('div.mode_switcher');this.render_mode_switcher();var timeline_id=this.canvas_timeline.get_container_id();this.timeline_div.dom.setAttribute('id',timeline_id);this.canvas_timeline.render();},render_widget:function(){},render_mode_switcher:function(){var modes=['timeline','gallery'];var sg_tips=['Timeline View','Gallery View'];var mode=this.canvas_timeline.get_mode();var render_mode=this.canvas_timeline.get_render_mode();if(mode==='sequence'){modes.push('cut');sg_tips.push('Cut View');}else if(render_mode==='cut'){render_mode='timeline';}
var mode_buttons_html='';var i,extra_classes;for(i=0;i<modes.length;i++){extra_classes=modes[i]+'_mode';mode_buttons_html+=this.templates.mode_link.apply({extra_class:extra_classes,active:render_mode===modes[i]?'active':'',mode:modes[i],sg_tip:sg_tips[i]});}
this.mode_switcher_div.update(mode_buttons_html);},get_render_mode:function(){return this.canvas_timeline.get_render_mode();},set_render_mode:function(render_mode){var active_mode_button=this.mode_switcher_div.child('div.mode_button.active');active_mode_button.removeClass('active');var new_active_button=this.mode_switcher_div.child('div.mode_button[query_mode="'+render_mode+'"]');new_active_button.addClass('active');var callback={fn:function(){this.render_mode_switcher();this.update_sort_button();},scope:this};this.canvas_timeline.set_render_mode(render_mode,callback);},clear_filters:function(){this.filter_panel.reset_filters_no_notify();this.filter_panel.save_filters_to_settings();this.search_field.clear_input();},on_loading_changed:function(state){this.nav_bar.set_loading(state);if(state)
this.show_loading_overlay(this.bottom_pane_div);else
this.hide_loading_overlay();},on_updating_state_changed:function(state){if(state)
this.nav_bar.start_update_indicator();else
this.nav_bar.stop_update_indicator();},on_node_changed:function(node,sender){if(!this.browser.node||this.browser.node.get_path()!==node.get_path())
this.set_browser_node(node);if(!this.nav_bar.node||this.nav_bar.node.get_path()!==node.get_path()){this.nav_bar.set_node(node);this.nav_bar.render();}
SG.ReviewApp.Utils.add_recent(node,sender);this.render_mode_switcher();this.update_sort_button();this.update_history_button();this.update_filter_button();this.filter_panel.render();var mode=this.canvas_timeline.get_mode();if(!mode){this.on_no_entity_chosen();}else{this.close_message_bar();}},on_no_entity_chosen:function(){this.display_message_bar('Please browse to an entity to begin.');if(!this.browser_is_open())
this.open_browser();},on_filter_settings_changed:function(filter_settings){var current_filter_settings=sg_deep_copy(this.get('filter_panel_settings'));var settings_keys=['one_click_filters','panel_filters','saved_filters','text_filters','last_quick_filter_value'];var key;for(key in filter_settings)
if(settings_keys.indexOf(key)!==-1)
current_filter_settings[key]=filter_settings[key];if(!current_filter_settings.fields)
current_filter_settings.fields=[];var i;if(filter_settings.fields)
for(i=0;i<filter_settings.fields.length;i++)
if(current_filter_settings.fields.indexOf(filter_settings.fields[i])<0)
current_filter_settings.fields.push(filter_settings.fields[i]);this.set('filter_panel_settings',current_filter_settings);this.filter_panel.get_filters_from_settings();if(filter_settings.last_quick_filter_value)
this.search_field.refresh();},on_dataset_empty:function(is_empty){var mode=this.canvas_timeline.get_mode();if(!mode)
return;if(!is_empty){this.close_message_bar();return;}
var message;if(mode==='all_projects'){message='No Versions were found';}else{var entity_type_name;var pluralized=false;switch(mode){case'all_shots':entity_type_name='Shot';pluralized=true;break;case'all_assets':entity_type_name='Asset';pluralized=true;break;default:var name_parts=mode.split('_');var entity_type_name='';for(i=0;i<name_parts.length;i++){entity_type_name+=name_parts[i].charAt(0).toUpperCase()+name_parts[i].slice(1);if(i!=name_parts.length-1)
entity_type_name+=' ';}
break;}
message='No Versions were found';if(pluralized)
message+=' for these '+entity_type_name.pluralize(2);else
message+=' for this '+entity_type_name;}
if(this.has_filters()||this.search_field.get_current_filter())
message+=' that match your filters';this.display_message_bar(message);return;},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.browser_button',this.main_div));if(elem){if(elem.hasClass('active'))
this.close_browser();else
this.open_browser();return;}
elem=Ext.get(target.findParent('div.filter_button',this.main_div));if(elem){if(elem.hasClass('active'))
this.close_filter_panel();else
this.open_filter_panel();return;}
elem=Ext.get(target.findParent('div.history_button',this.main_div));if(elem&&!elem.hasClass('disabled')){if(!this.history_menu){this.history_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){var limit_options=[5,10,15];var mode=this.canvas_timeline.get_mode();the_menu.items=[];var entity_type;if(['all_shots','sequence','shot'].indexOf(mode)>-1)
entity_type='SHOT';else if(['all_assets','asset_type','asset'].indexOf(mode)>-1)
entity_type='ASSET';else
entity_type='ENTITY';the_menu.items.push({heading:'VERSIONS PER '+entity_type});var history_limit=this.canvas_timeline.get_history_limit();the_menu.items.push({html:'Most recent only',checked:history_limit===1,value:1});var i;for(i=0;i<limit_options.length;i++){the_menu.items.push({html:limit_options[i]+' most recent',checked:history_limit===limit_options[i],value:limit_options[i]});}
the_menu.items.push({html:'All',checked:history_limit===-1,value:-1});the_menu.render();the_menu.position.dom_elem.addClass('active');the_menu.position.dom_elem.dom.removeAttribute('sg_tip');},scope:this},after_hide:{fn:function(the_menu){the_menu.position.dom_elem.removeClass('active');the_menu.position.dom_elem.dom.setAttribute('sg_tip','History Options');},scope:this},item_selected:{fn:function(menu,item){if(item.value===this.canvas_timeline.get_history_limit())return;this.update_history_button_for_limit(item.value);this.canvas_timeline.set_history_limit(item.value);},scope:this}});}
if(SG.Menu.now_showing!==this.history_menu){this.history_menu.target_elem=target;this.history_menu.position={dom_elem:elem,elem_anchor:'bl',menu_anchor:'tl'};this.history_menu.show();}else{this.history_menu.hide();}
return;}
elem=Ext.get(target.findParent('div.sort_button',this.main_div));if(elem&&!elem.hasClass('disabled')){if(!this.sort_menu){this.sort_menu_toolbar_div=elem;this.sort_menu=this.new_component(SG.Menu,{menu_class:'sgw_review_app_browser_sort_menu',before_show:{fn:function(the_menu){the_menu.position.dom_elem.addClass('active');the_menu.position.dom_elem.dom.removeAttribute('sg_tip');this.on_before_show_sort_menu(the_menu);},scope:this},after_hide:{fn:function(the_menu){the_menu.position.dom_elem.removeClass('active');this.update_sort_button_tooltip();},scope:this}});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'Version',get_sorts_callback:{fn:this.get_sorts,scope:this},set_sorts_callback:{fn:this.set_sorts,scope:this}});}
if(SG.Menu.now_showing!==this.sort_menu){this.sort_menu.position={dom_elem:elem,elem_anchor:'bl',menu_anchor:'tl',no_cover:true};this.sort_menu.show();}else{this.sort_menu.hide();}
return;}
elem=Ext.get(target.findParent('div.mode_button',this.mode_switcher_div));if(elem&&!elem.hasClass('active')&&!elem.hasClass('disabled')){var mode=elem.dom.getAttribute('query_mode');this.set_render_mode(mode);return;}
elem=Ext.get(target.findParent('div.close_pane_button',this.container));if(elem){SG.globals.review_app_player.close_pane('Bottom');return;}
elem=Ext.get(target.findParent('div.tear_off_pane_button',this.container));if(elem){if(SG.globals.review_app_player.pane_is_docked('Bottom'))
SG.globals.review_app_player.tear_off_pane('Bottom');else
SG.globals.review_app_player.dock_pane('Bottom');return;}
elem=Ext.get(target.findParent('div.close',this.message_bar_div));if(elem&&elem.findParent('div.sgw_review_app_message_bar',this.container)){this.close_message_bar();this.dismissed_message_bar=true;return;}
elem=Ext.get(target.findParent('div.filter_panel_more_fields'),this.bottom_pane_div);if(elem){this.filter_panel.show_more_fields_menu(elem);return;}},on_keydown:function(e){if(SG.GlobalNav.__ignore(e))
return;var key=e.getKey();if(key===81||key===83){var me=this;setTimeout(function(){me.search_field.quick_key_focus();},1);e.stopEvent();return;}},on_updates_enabled:function(enabled){if(!enabled&&!this.canvas_timeline.updates_are_disabled()&&SG.globals.review_app_player){var freq=SG.globals.review_app_player.get_update_frequency();var message='Updates to the Revolver UI are disabled while playing.';if(freq>0){var k=Math.floor(freq/1024);message='A source being viewed is larger than '+k+'K. For performance, '+'Revolver UI updates are disabled';}
this.display_message_bar(message,true);}else if(enabled&&this.canvas_timeline.updates_are_disabled()){this.close_message_bar();}},on_docked_state_changed:function(docked){var elem=this.container.child('div.tear_off_pane_button');if(elem){if(!docked)
elem.addClass('floating');else
elem.removeClass('floating');}},on_before_show_sort_menu:function(menu){var items=[{heading:'SORT VERSIONS BY'}];var sorts=this.canvas_timeline.get_sorts();var is_default=this.canvas_timeline.has_default_sorts();if(sorts.length){var sort_display_names=this.canvas_timeline.get_sort_display_names();var current_sort_text;if(sort_display_names.length<2)
current_sort_text='Sorting by '+sort_display_names[0];else
current_sort_text='Sorting first by '+sort_display_names[0]+' then by '+
sort_display_names.slice(1).join(' then by ');items.push({line:true});items.push({html:current_sort_text,disabled:true});}
if(!is_default){items.push({html:'Reset sorts to default',item_selected:{fn:function(){var callback={fn:this.update_sort_button,scope:this};this.canvas_timeline.reset_sorts_to_default(callback);},scope:this}});}
if(items.length)
items.push({line:true});items=items.concat(this.sorting_menu_helper.get_menu_items());menu.items=items;menu.render();},set_browser_node:function(node,force_open){if(!node)
node=SG.ReviewAppTreeNode.get_root_node();var is_open=this.main_div.hasClass('browser_open');if(!force_open&&!is_open)
return;var depth=Math.max(node.get_depth()-1,0);if(this.browser.get_mode()==='favorites'){this.browser.on_after_pages_moved(node,depth);this.browser.show_favorites_page(true);}else{this.browser.set_target_node(node);this.browser.set_node_at_depth(node,depth,true,true);}
this.main_div.addClass('browser_open');},get_sorts:function(){return this.canvas_timeline.get_sorts();},set_sorts:function(sorts){var callback={fn:this.update_sort_button,scope:this};this.update_sort_button_for_sorts(sorts);this.canvas_timeline.set_sorts(sorts,callback);},display_message_bar:function(message,no_anim){if(no_anim)
this.message_bar_div.addClass('no_anim');this.message_bar_content_div.update(message);if(!this.message_bar_div.hasClass('open'))
this.resize_canvas(no_anim?0:1000);this.message_bar_div.addClass('open');},close_message_bar:function(){if(this.message_bar_div.hasClass('open'))
this.resize_canvas(1000);this.message_bar_div.removeClass('no_anim');this.message_bar_div.removeClass('open');},resize_canvas:function(duration){if(duration>0)
this.canvas_timeline.render();else
this.canvas_timeline.resize_canvas_to_fit_container();if(duration<0)return;var me=this;setTimeout(function(){me.resize_canvas(duration-20);},20);},browser_is_open:function(){var browser_button=this.main_div.child('div.browser_button');return browser_button?browser_button.hasClass('active'):false;},open_browser:function(){var browser_button=this.main_div.child('div.browser_button');browser_button.addClass('active');setCookie('sgw_review_app_timeline_browser_open','1',365);this.set_browser_node(this.canvas_timeline.get_node(),true);this.resize_canvas(250);},close_browser:function(){var browser_button=this.main_div.child('div.browser_button');browser_button.removeClass('active');setCookie('sgw_review_app_timeline_browser_open','0',365);this.main_div.removeClass('browser_open');this.resize_canvas(250);},open_filter_panel:function(){var filter_button=this.main_div.child('div.filter_button');filter_button.addClass('active');this.main_div.addClass('filter_panel_open');setCookie('sgw_review_app_timeline_filter_panel_open','1',365);this.filter_panel.render();this.resize_canvas(250);},close_filter_panel:function(){var filter_button=this.main_div.child('div.filter_button');filter_button.removeClass('active');this.main_div.removeClass('filter_panel_open');setCookie('sgw_review_app_timeline_filter_panel_open','0',365);this.resize_canvas(250);},update_filter_button:function(){var filter_button=this.main_div.child('div.filter_button');if(this.has_filters())
filter_button.addClass('has_filters');else
filter_button.removeClass('has_filters');},update_sort_button:function(){this.update_sort_button_for_sorts(this.canvas_timeline.get_sorts());},update_sort_button_for_sorts:function(sorts){var sort_button=this.main_div.child('div.sort_button');var mode=this.canvas_timeline.get_mode();var render_mode=this.canvas_timeline.get_render_mode();var enabled;if(mode){if(render_mode==='cut')
enabled=false;else{if(['shot','asset'].indexOf(mode)>-1)
enabled=render_mode==='gallery';else
enabled=true;}}
if(!enabled){sort_button.addClass('disabled');}else{sort_button.removeClass('disabled');if(this.canvas_timeline.sorts_are_default(sorts))
sort_button.removeClass('has_sorts');else
sort_button.addClass('has_sorts');}
this.update_sort_button_tooltip();},update_sort_button_tooltip:function(){var sort_button=this.main_div.child('div.sort_button');var sort_display_names=this.canvas_timeline.get_sort_display_names();var tooltip;if(sort_display_names.length){if(sort_display_names.length<2)
tooltip='Sorting by [[b]]'+sort_display_names[0]+'[[/b]]';else
tooltip='Sorting first by [[b]]'+sort_display_names[0]+'[[/b]] then by [[b]]'+
sort_display_names.slice(1).join('[[/b]] then by [[b]]')+'[[/b]]';}else{tooltip='Sorting Options';if(sort_button.hasClass('disabled'))
tooltip+=' (disabled)';}
sort_button.dom.setAttribute('sg_tip',tooltip);},update_history_button:function(){this.update_history_button_for_limit(this.canvas_timeline.get_history_limit());},update_history_button_for_limit:function(version_limit){var history_button=this.main_div.child('div.history_button');var mode=this.canvas_timeline.get_mode();var enabled;if(mode)
enabled=['playlist','version_page'].indexOf(mode)>-1?false:true;if(!enabled){history_button.removeClass('active');history_button.removeClass('has_history');history_button.addClass('disabled');history_button.dom.setAttribute('sg_tip','History Options (Disabled)');}else{history_button.removeClass('disabled');if(version_limit!==1)
history_button.addClass('has_history');else
history_button.removeClass('has_history');history_button.dom.setAttribute('sg_tip','History Options');}},filter_panel_is_showing:function(){return this.main_div&&this.main_div.hasClass('filter_panel_open');},get_filter_panel_setting:function(setting_name){return this.get('filter_panel_settings')[setting_name];},set_filter_panel_setting:function(setting_name,value){var settings=this.get('filter_panel_settings');settings[setting_name]=value;this.set('filter_panel_settings',settings);var stored_settings=sg_deep_copy(settings);delete(stored_settings.one_click_filters);delete(stored_settings.panel_filters);delete(stored_settings.saved_filters);delete(stored_settings.text_filters);delete(stored_settings.last_quick_filter_value);setCookie('sgw_review_app_timeline_filter_panel_settings',Ext.encode(stored_settings),365);},has_filters:function(){return(this.filter_panel.one_click_filters||this.filter_panel.panel_filters||this.filter_panel.saved_filters)?true:false;},get_filters:function(filters){return this.canvas_timeline.get_filters();},update_filters:function(filters){var callback={fn:function(){this.filter_panel.render();},scope:this};this.canvas_timeline.set_extra_filters(filters,callback);},get_displayed_columns:function(){var set_fields=['code','user','description','sg_task.Task.step'];if(this.canvas_timeline.get_mode()==='playlist'||this.canvas_timeline.get_mode()==='version_page')
set_fields.push('entity');var filter_panel_fields=this.filter_panel.get_fields();var i;for(i=0;i<filter_panel_fields.length;i++)
if(set_fields.indexOf(filter_panel_fields[i])===-1)
set_fields.push(filter_panel_fields[i]);return set_fields;},quickjump_item_selected:function(item){if(!item.value)return;this.canvas_timeline.set_entity(item.value);this.search_field.blur_input();}});SG.ReviewAppBrowserColumnBrowser=function(config){Ext.apply(this,config);SG.ReviewAppBrowserColumnBrowser.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppBrowserColumnBrowser,SG.ReviewAppColumnBrowser,{templates:{menu_bar_right:'<div class="column_browser_mode_switch">'+'<div class="sgw_review_app_switch favorites_and_recents_button {favorites_active}" sg_tip="Recent and Favorites">'+'<div class="button_icon favorites_icon"></div>'+'</div>'+'<div class="sgw_review_app_switch tree_button {tree_active}" sg_tip="Entity Tree">'+'<div class="button_icon tree_icon"></div>'+'</div>'+'</div>'},on_first_render:function(){var mode_cookie=getCookie('sgw_review_app_timeline_browser_mode');var mode=mode_cookie?mode_cookie:'tree';this.menu_bar_right=this.templates.menu_bar_right.apply({favorites_active:mode==='favorites'?'active':'',tree_active:mode==='tree'?'active':''});this.extra_classes=this.mode+'_mode';SG.ReviewAppBrowserColumnBrowser.superclass.on_first_render.call(this);this.fav_button=this.container.child('div.favorites_and_recents_button');this.tree_button=this.container.child('div.tree_button');this.set_mode(mode);var wrapper=this.templates.page_wrapper.apply({depth:'-1',extra_classes:'favorites'});var fav_container=Ext.DomHelper.insertAfter(this.contents_div,wrapper,true);this.favorites_page=this.new_component(SG.ReviewAppBrowserColumnBrowserFavoritesPage,{container:fav_container});this.previous_page_callback={fn:function(depth){var page=this.pages[depth];var selected=sg_find_all('div.selected',page.container.dom);var remove_anim_fn=function(fly){setTimeout(function(){fly.removeClass('anim');},500);};var i,fly;for(i=0;i<selected.length;i++){fly=Ext.fly(selected[i]);fly.addClass('anim');fly.removeClass('selected');remove_anim_fn(fly);}},scope:this};},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.favorites_and_recents_button',this.main_div));if(elem&&!elem.hasClass('active')){this.set_mode('favorites');this.last_tree_node=this.node;this.last_depth=this.current_depth;this.show_favorites_page();return;}
elem=Ext.get(target.findParent('div.tree_button',this.main_div));if(elem&&!elem.hasClass('active')){this.set_mode('tree');this.show_loading_overlay();this.hide_favorites_page();return;}
SG.ReviewAppBrowserColumnBrowser.superclass.on_click.call(this,e);},get_mode:function(){return this.mode;},set_mode:function(mode){this.mode=mode;setCookie('sgw_review_app_timeline_browser_mode',mode,365);if(this.mode==='favorites'){this.fav_button.addClass('active');this.tree_button.removeClass('active');}else{this.tree_button.addClass('active');this.fav_button.removeClass('active');}},show_favorites_page:function(skip_anim){this.show_loading_overlay();var anim_cfg;if(!skip_anim)
anim_cfg={duration:0.25,easing:'easeOut'};this.favorites_page.reset();this.favorites_page.target_node=this.get_timeline_node();if(!this.favorites_page.is_loaded()){this.favorites_page.fetch_data({fn:function(){this.on_favorites_loaded(anim_cfg);},scope:this});return;}
this.on_favorites_loaded(anim_cfg);},on_favorites_loaded:function(anim_cfg){this.favorites_page.render({fn:function(){this.on_favorites_rendered(anim_cfg);},scope:this});},on_favorites_rendered:function(anim_cfg){this.hide_loading_overlay();var height_anim_cfg,opac_anim_cfg;if(anim_cfg){height_anim_cfg=sg_deep_copy(anim_cfg);height_anim_cfg.callback=this.on_favorite_page_shown;height_anim_cfg.scope=this;opac_anim_cfg=sg_deep_copy(anim_cfg);}
this.animate_title('Recent & Favorites',-1,anim_cfg,true);this.main_div.removeClass('tree_mode');this.main_div.addClass('favorites_mode');this.favorites_page.container.setDisplayed('block');this.favorites_page.container.setStyle('bottom','auto');this.favorites_page.container.setHeight(this.contents_div.getHeight()-300);this.favorites_page.container.setHeight(this.contents_div.getHeight(),height_anim_cfg);this.favorites_page.container.setOpacity(1,opac_anim_cfg);this.favorites_page.main_div.setStyle('top','auto');this.favorites_page.main_div.setHeight(this.contents_div.getHeight());if(!anim_cfg)
this.on_favorite_page_shown();},on_favorite_page_shown:function(){this.favorites_page.container.setStyle('bottom','0px');this.favorites_page.container.setStyle('height','auto');this.favorites_page.main_div.setStyle('height','auto');this.favorites_page.main_div.setStyle('top','0px');},hide_favorites_page:function(node,after_load_callback){var depth;if(node){depth=node.get_depth();}else if(this.last_tree_node&&this.last_depth){node=this.last_tree_node;depth=this.last_depth;}else{node=this.node;depth=this.current_depth;}
var anim_cfg={duration:0.25,easing:'easeIn'};var callback={fn:function(){this.hide_loading_overlay();this.tree_button.addClass('active');this.fav_button.removeClass('active');this.main_div.addClass('tree_mode');this.main_div.removeClass('favorites_mode');var height_anim_cfg,opac_anim_cfg;if(anim_cfg){height_anim_cfg=sg_deep_copy(anim_cfg);height_anim_cfg.callback=this.on_favorite_page_hidden;height_anim_cfg.scope=this;opac_anim_cfg=sg_deep_copy(anim_cfg);}
this.favorites_page.container.setStyle('bottom','auto');this.favorites_page.container.setHeight(this.contents_div.getHeight());this.favorites_page.container.setHeight(this.contents_div.getHeight()-300,height_anim_cfg);this.favorites_page.container.setOpacity(0,opac_anim_cfg);this.favorites_page.main_div.setStyle('top','auto');this.favorites_page.main_div.setHeight(this.contents_div.getHeight());var title=node.get_ancestor_at_depth(depth).name;this.animate_title(title,1,anim_cfg,true);if(!anim_cfg)
this.on_favorite_page_hidden();if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};var target_node=this.get_timeline_node();this.set_mode('tree');this.set_target_node(target_node);if(node.is_leaf()&&depth===node.get_depth())
--depth;this.set_node_at_depth(node,depth,true,true,callback,true);},get_timeline_node:function(){if(this.current_node_callback)
return this.current_node_callback.fn.call(this.current_node_callback.scope);return null;},on_favorite_page_hidden:function(){this.favorites_page.container.setDisplayed(false);this.favorites_page.main_div.setStyle('height','auto');this.favorites_page.main_div.setStyle('top','0px');}});SG.ReviewAppBrowserColumnBrowserPage=function(config){Ext.apply(this,config);SG.ReviewAppBrowserColumnBrowserPage.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppBrowserColumnBrowserPage,SG.ReviewAppColumnBrowserPage,{templates:{empty_page:'<div class="empty_page">'+'<div class="frame">'+'<div class="empty_message">{empty_message}</div>'+'</div>'+'</div>',sorting_and_grouping:'<div class="sorted_and_grouped_page">'+'<div class="controls_wrapper">'+'<div class="controls">'+'<div class="menu_item sorting">Sort<div class="menu_item_triangle"></div></div>'+'<div class="menu_item grouping">Group<div class="menu_item_triangle"></div></div>'+'</div>'+'</div>'+'<div class="page_content"></div>'+'</div>',item:'<div class="grouped_list_row {has_children} {is_target} {is_current} {extra_classes}">'+'<div class="item_selection_area">'+'<div class="icon_and_thumb {no_thumb}">{icon_and_thumb}</div>'+'<div class="item_name">{display_name}</div>'+'<div class="loading_indicator"></div>'+'<div class="favorite {favorited}"></div>'+'</div>'+'<div class="arrow_wrapper">'+'<div class="arrow"></div>'+'</div>'+'</div>',icon:'<div style="margin-top: 3px;" class="{icon_class}"></div>',thumb:'<div class="thumbnail"><img src="/thumbnail/image/{thumb}" '+'onError="sg_missing_image(this)"/></div>'},init_component:function(){this.before_render_callback={fn:this.on_before_render,scope:this};if(!this.ignore_favorites_changes){SG.NotificationCenter.add_observer({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',callback:{fn:this.favorites_changed,scope:this}});}},init_grouped_list:function(){var selected_path;if(this.target_node.get_depth()>this.node.get_depth())
selected_path=this.target_node.get_ancestor_at_depth(this.node.get_depth()+1).get_path();var is_grouped=this.node.get_child_groups&&this.node.get_child_groups();var i,groups,items;if(is_grouped){groups=this.node.get_child_groups();items=[];var j,group_items,group_item;for(i=0;i<groups.length;i++){group_items=this.node.get_children_for_group(groups[i].id);for(j=0;j<group_items.length;j++){group_item=group_items[j];group_item.group_id=groups[i].id;items.push(group_item);}}}else{items=this.node.get_children();}
this.images_exist=false;this.children_exist=false;for(i=0;i<items.length;i++){if(items[i].image)
this.images_exist=true;if(items[i].has_children())
this.children_exist=true;if(selected_path&&items[i].get_path()===selected_path)
items[i].selected=true;}
if(!this.grouped_list){var cfg={node:this.node,is_grouped:is_grouped,groups:groups,items:items,item_selection_callback:{fn:this.on_item_selected,scope:this},item_render_callback:{fn:this.render_item,scope:this}};this.grouped_list=this.new_component(SG.ReviewAppGroupedList,cfg);}else{this.grouped_list.set_items(items,groups);}},is_loaded:function(){if(!SG.ReviewApp.Utils.favorites_loaded())
return false;if(!this.node.async)
return true;if(!this.node.data_is_loaded())
return false;if(!this.node.has_children())
return true;return this.node.children_are_loaded();},fetch_data:function(after_load_callback){var callback={fn:function(){this.after_favorites_loaded(after_load_callback);},scope:this};var loading=false;if(!SG.ReviewApp.Utils.favorites_loaded()){SG.ReviewApp.Utils.fetch_favorites(callback);loading=true;}
if(this.node.async&&!this.node.data_is_loaded()){this.node.fetch_data(callback);loading=true;}
if(!loading)
this.after_favorites_loaded(after_load_callback);},after_favorites_loaded:function(after_load_callback){if(!SG.ReviewApp.Utils.favorites_loaded())return;if(this.node.async&&!this.node.data_is_loaded())return;if(this.node.async&&this.node.has_children()&&!this.node.children_are_loaded()){this.node.fetch_children(after_load_callback);return;}
if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},on_before_render:function(){if(this.node.has_children()&&!this.grouped_list){this.init_grouped_list();return;}
this.page_is_empty=true;},on_first_render:function(container){if(this.node.allows_user_grouping_and_sorting){container.update(this.templates.sorting_and_grouping.apply());this.update_sort_menu_tooltip();this.update_group_menu_tooltip();var controls_div=container.child('div.controls');this.add_event(controls_div,'click',this.on_sort_and_group_click);container=container.child('div.page_content');}
this.grouped_list.container=container;},update_sort_menu_tooltip:function(){var sort_menu=this.container.child('div.menu_item.sorting');var sorts=this.get_sorts();if(!sorts||!sorts.length){sort_menu.dom.setAttribute('sg_tip','Not sorting');return;}
var sort_display_names=[];var i;for(i=0;i<sorts.length;i++)
sort_display_names.push(SG.schema.get_field_display_name(this.node.entity_type,sorts[i].column));var tooltip;if(sort_display_names.length<2)
tooltip='Sorting by [[b]]'+sort_display_names[0]+'[[/b]]';else
tooltip='Sorting first by [[b]]'+sort_display_names[0]+'[[/b]] then by [[b]]'+
sort_display_names.slice(1).join('[[/b]] then by [[b]]')+'[[/b]]';sort_menu.dom.setAttribute('sg_tip',tooltip);},update_group_menu_tooltip:function(){var group_menu=this.container.child('div.menu_item.grouping');var grouping=this.get_grouping();if(!grouping||!grouping.length){group_menu.dom.setAttribute('sg_tip','Not grouping');return;}
var group_display_names=[];var i;for(i=0;i<grouping.length;i++)
group_display_names.push(SG.schema.get_field_display_name(this.node.entity_type,grouping[i].column));var tooltip;if(group_display_names.length<2)
tooltip='Grouping by [[b]]'+group_display_names[0]+'[[/b]]';else
tooltip='Grouping first by [[b]]'+group_display_names[0]+'[[/b]] then by [[b]]'+
group_display_names.slice(1).join('[[/b]] then by [[b]]')+'[[/b]]';group_menu.dom.setAttribute('sg_tip',tooltip);},on_sort_and_group_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.sorting',this.container));if(elem){if(!this.sort_menu){this.sort_menu_toolbar_div=elem;this.sort_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_sort_menu,scope:this}});this.sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:this.node.entity_type,no_advanced:true,get_sorts_callback:{fn:this.get_sorts,scope:this},set_sorts_callback:{fn:this.set_sorts,scope:this}});}
if(SG.Menu.now_showing!==this.sort_menu)
this.sort_menu.show();else
this.sort_menu.hide();return;}
elem=Ext.get(target.findParent('div.grouping',this.container));if(elem){if(!this.grouping_menu){this.grouping_menu_toolbar_div=elem;this.grouping_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_grouping_menu,scope:this}});this.grouping_menu_helper=new SG.util.GroupingMenuHelper({entity_type:this.node.entity_type,no_advanced:true,grouping_setting_callback:{fn:this.get_grouping,scope:this},on_grouping_field:{fn:this.on_grouping_field_menu_item,scope:this}});}
if(SG.Menu.now_showing!==this.grouping_menu)
this.grouping_menu.show();else
this.grouping_menu.hide();return;}},get_sorts:function(){return this.node.get_sorts();},set_sorts:function(new_sorts){this.get_browser().show_loading_overlay();this.node.set_sorts(new_sorts);this.update_sort_menu_tooltip();var callback={fn:function(){this.init_grouped_list();this.grouped_list.render({fn:function(){this.get_browser().hide_loading_overlay();},scope:this});},scope:this};this.node.fetch_children(callback);},on_before_show_sort_menu:function(menu){menu.position={dom_elem:this.sort_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};var items;if(!this.node.has_default_sorts()){items=[{html:'Reset sorts to default',item_selected:{fn:function(){this.set_sorts(this.node.get_default_sorts());},scope:this}},{line:true}];}else{items=[];}
menu.items=items.concat(this.sorting_menu_helper.get_menu_items());menu.render();},get_grouping:function(){return this.node.get_grouping();},set_grouping:function(grouping){this.get_browser().show_loading_overlay();this.node.set_grouping(grouping);this.update_group_menu_tooltip();var callback={fn:function(){this.init_grouped_list();this.grouped_list.render({fn:function(){this.get_browser().hide_loading_overlay();},scope:this});},scope:this};this.node.fetch_children(callback);},on_before_show_grouping_menu:function(menu){menu.position={dom_elem:this.grouping_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};var items;if(!this.node.has_default_grouping()){items=[{html:'Reset grouping to default',item_selected:{fn:function(){this.set_grouping(this.node.get_default_grouping());},scope:this}},{line:true}];}else{items=[];}
menu.items=items.concat(this.grouping_menu_helper.get_menu_items());menu.render();},on_grouping_field_menu_item:function(menu,item){if(item.value=="__ungroup__"||(item.checked&&item.no_ungrouping!==true))
this.set_grouping(null);else
this.set_grouping([item.value]);},render_page:function(container,after_render_callback){if(!this.page_is_empty){if(!this.rendered)
this.on_first_render(container);this.grouped_list.render(after_render_callback);return;}
this.render_empty_page(container);if(after_render_callback)
after_render_callback.fn.call(after_render_callback.scope);},render_empty_page:function(container){var message;if(this.node.id==='projects')
message='There are no projects, or you do not have permission to access them';else
message='There are no Versions';container.update(this.templates.empty_page.apply({empty_message:message}));},tear_down_events:function(){if(this.grouped_list)
this.grouped_list.tear_down_events();},render_item:function(item_id){var child_node=this.node.get_child_by_id(item_id);var target_node=this.get_browser().get_timeline_node();var has_children=false;if(child_node.supports_children&&child_node.has_children())
has_children=true;var icon_and_thumb='';var no_thumb=false;if(child_node.image)
icon_and_thumb+=this.templates.thumb.apply({thumb:child_node.image});else
no_thumb=true;var favorite=SG.ReviewApp.Utils.node_is_favorite(child_node);if(child_node.icon_class)
icon_and_thumb+=this.templates.icon.apply({icon_class:child_node.icon_class});var display_name=child_node.name;if(['playlists','pages','global_version_pages'].indexOf(this.node.id)>-1){if(child_node.created_by)
display_name+='<br><span class="project_name">Created by '+child_node.created_by.name+'</span>';if(child_node.updated_at)
display_name+='<br><span class="project_name">Updated '+
elapsed_time_phrase(Date.sgParseDateTime(child_node.updated_at))+'</span>';}
return this.templates.item.apply({no_thumb:(no_thumb&&this.images_exist)?'no_thumb':'',icon_and_thumb:icon_and_thumb,display_name:display_name,has_children:has_children?'has_children':(this.children_exist?'no_children':''),is_target:child_node.is_target?'is_target':'',is_current:target_node&&target_node.get_path()===child_node.get_path()?'current':'',favorited:favorite?'favorited':''});},on_item_selected:function(item_id,e){var child_node=this.node.get_child_by_id(item_id);if(!child_node)return;var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.favorite',this.container));if(elem){var is_favorite=SG.ReviewApp.Utils.node_is_favorite(child_node);if(is_favorite){SG.ReviewApp.Utils.unfavorite_node(child_node);elem.removeClass('favorited');}else{SG.ReviewApp.Utils.favorite_node(child_node);elem.addClass('favorited');}
return false;}
var hit_target=target;var item_container=Ext.get(hit_target.findParent('div.grouped_list_item',this.container));var row_container=Ext.get(hit_target.findParent('div.grouped_list_row',this.container));if(!item_container||!row_container)return false;if(child_node.supports_children){if(child_node.is_target)
hit_target=Ext.get(target.findParent('div.arrow_wrapper',this.container));if(hit_target&&child_node.has_children()){var browser=this.get_browser();if(browser.page_loading)return false;item_container.addClass('loading');row_container.removeClass('current');var callback={fn:function(){item_container.removeClass('loading');},scope:this};browser.next_page(item_id,callback);return true;}
var current_items=sg_find_all('div.grouped_list_row.current',this.container.dom);var i;for(i=0;i<current_items.length;i++)
Ext.fly(current_items[i]).removeClass('current');}
if(!child_node.is_target)return true;row_container.addClass('current');this.get_browser().node=child_node;var timeline_widget=this.get_parent_widget();timeline_widget.clear_filters();timeline_widget.canvas_timeline.set_node(child_node);return true;},favorites_changed:function(args){var is_favorite,node;if(args.added){node=args.added.node;is_favorite=true;}else if(args.removed){node=args.removed.node;is_favorite=false;}else{return;}
if(node.get_parent().get_path()!==this.node.get_path())return;var child_node=this.node.get_child_by_id(node.id);if(!child_node)return;var item_div=this.container.child('div.grouped_list_item[item_id='+child_node.id+']');if(!item_div)return;var favorite_div=item_div.child('div.favorite');if(is_favorite)
favorite_div.addClass('favorited');else
favorite_div.removeClass('favorited');}});SG.ReviewAppBrowserColumnBrowserFavoritesPage=function(config){Ext.apply(this,config);SG.ReviewAppBrowserColumnBrowserFavoritesPage.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppBrowserColumnBrowserFavoritesPage,SG.ReviewAppBrowserColumnBrowserPage,{templates:{empty_group_item:'<div class="grouped_list_row grouped_list_empty_group_item" group_id="{group_id}">'+'{empty_text}'+'</div>'},init_component:function(){this.node=new SG.ReviewAppFavoritesNode({id:'favorites_and_recent',favorites_changed_callback:{fn:this.favorites_changed,scope:this},recent_changed_callback:{fn:this.recent_changed,scope:this}});this.target_node=this.node;this.depth=0;this.ignore_favorites_changes=true;SG.ReviewAppBrowserColumnBrowserFavoritesPage.superclass.init_component.call(this);},reset:function(){this.node.reset();},is_loaded:function(){return this.node.data_is_loaded()&&this.node.children_are_loaded();},fetch_data:function(after_load_callback){this.node.fetch_data({fn:function(){this.node.fetch_children(after_load_callback);},scope:this});},on_before_render:function(){this.init_grouped_list();},render_page:function(container,after_render_callback){this.grouped_list.container=container;this.grouped_list.render(after_render_callback);},is_showing:function(){return this.container.getX()>=0&&this.container.getY()>=0;},init_grouped_list:function(){var target_path;if(this.target_node)
target_path=this.target_node.get_path();var groups=this.node.get_child_groups();var children_exist=false;var images_exist=false;var items=[];var i,j,group_items,group_item;for(i=0;i<groups.length;i++){group_items=this.node.get_children_for_group(groups[i].id);for(j=0;j<group_items.length;j++){group_item=group_items[j];if(group_item.has_children())
this.children_exist=true;if(group_item.image)
this.images_exist=true;items.push({id:group_item.get_path(),group_id:groups[i].id,extra_attributes:group_item.extra_attributes,selected:target_path===group_item.get_path()});}}
if(!this.grouped_list){var cfg={node:this.node,is_grouped:true,groups:groups,items:items,item_selection_callback:{fn:this.on_item_selected,scope:this},item_render_callback:{fn:this.render_item,scope:this},empty_group_render_callback:{fn:this.render_empty_group_item,scope:this}};this.grouped_list=this.new_component(SG.ReviewAppGroupedList,cfg);}else{this.grouped_list.set_items(items,groups);}},render_empty_group_item:function(group_id){var text;if(group_id==='favorites')
text='You have no favorites';else
text='You have no recent items';return this.templates.empty_group_item.apply({empty_text:text,group_id:group_id});},render_item:function(item_path,group_id){var child_node;if(group_id==='favorites')
child_node=this.node.get_favorite_by_path(item_path);else
child_node=this.node.get_recent_by_path(item_path);var target_node=this.get_browser().get_timeline_node();var has_children=false;if(child_node.supports_children&&child_node.has_children())
has_children=true;var icon_and_thumb='';var no_thumb=false;if(child_node.image)
icon_and_thumb+=this.templates.thumb.apply({thumb:child_node.image});else
no_thumb=true;var favorite=SG.ReviewApp.Utils.node_is_favorite(child_node);if(child_node.icon_class)
icon_and_thumb+=this.templates.icon.apply({icon_class:child_node.icon_class});var display_name=child_node.name;if(child_node.playlist_id||child_node.version_page_id){if(child_node.created_by)
display_name+='<br><span class="project_name">Created by '+
child_node.created_by.name+'</span>';if(child_node.updated_at)
display_name+='<br><span class="project_name">Updated '+
elapsed_time_phrase(Date.sgParseDateTime(child_node.updated_at))+'</span>';}
if(!(child_node instanceof SG.ReviewAppProjectNode)&&child_node.project_id)
display_name+='<br><span class="project_name">'+sg_project_name(child_node.project_id)
+'</span>';return this.templates.item.apply({no_thumb:no_thumb&&this.images_exist?'no_thumb':'',icon_and_thumb:icon_and_thumb,display_name:display_name,has_children:has_children?'has_children':(this.children_exist?'no_children':''),is_target:child_node.is_target?'is_target':'',is_current:target_node&&target_node.get_path()===child_node.get_path()?'current':'',favorited:favorite?'favorited':''});},on_item_selected:function(item_path,e,group_id){var child_node;if(group_id==='favorites')
child_node=this.node.get_favorite_by_path(item_path);else
child_node=this.node.get_recent_by_path(item_path);if(child_node){return this.on_node_selected(child_node,e,group_id);}else{var root_node=SG.ReviewAppTreeNode.get_root_node();root_node.find_node_at_path(item_path,{fn:function(node){this.on_node_selected(node,e,group_id);},scope:this});var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.favorite',this.container));if(elem.hasClass('favorited'))
elem.removeClass('favorited');else
elem.addClass('favorited');return elem?false:true;}},on_node_selected:function(node,e,group_id){if(!node)return;var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.favorite',this.container));if(elem){var is_favorite=SG.ReviewApp.Utils.node_is_favorite(node);if(is_favorite){SG.ReviewApp.Utils.unfavorite_node(node,group_id);elem.removeClass('favorited');}else{SG.ReviewApp.Utils.favorite_node(node,group_id);elem.addClass('favorited');}
return false;}
var browser=this.get_browser();if(node.supports_children){var hit_target=target;var item_container=Ext.get(hit_target.findParent('div.grouped_list_item',this.container));var row_container=Ext.get(hit_target.findParent('div.grouped_list_row',this.container));if(!item_container||!row_container)return false;if(node.is_target)
hit_target=Ext.get(target.findParent('div.arrow_wrapper',this.container));if(hit_target&&node.has_children()){if(browser.page_loading)return false;var item_container=Ext.get(hit_target.findParent('div.grouped_list_item',this.container));if(!item_container)return false;item_container.addClass('loading');row_container.removeClass('current');var callback={fn:function(){var me=this;setTimeout(function(){var sel=sg_find_all('div.grouped_list_item.selected',me.container.dom);var i;for(i=0;i<sel.length;i++)
Ext.get(sel[i]).removeClass('selected');},250);item_container.removeClass('loading');},scope:this};browser.hide_favorites_page(node,callback);return true;}
var current_items=sg_find_all('div.grouped_list_row.current',this.container.dom);var i;for(i=0;i<current_items.length;i++)
Ext.fly(current_items[i]).removeClass('current');row_container.addClass('current');}
if(!node.is_target)return true;var timeline_widget=this.get_parent_widget();this.target_node=null;SG.ReviewApp.Utils.add_recent(node,group_id);browser.on_after_pages_moved(node,node.get_depth());timeline_widget.clear_filters();timeline_widget.canvas_timeline.set_node(node,group_id);return true;},favorites_changed:function(args){if(!this.grouped_list||!this.is_showing()||this.get_browser().get_mode()!=='favorites')return;var path,item_divs,i,favorite_div,item_div;if(args.added){path=args.added.node.get_path();item_divs=sg_find_all('div.grouped_list_item[item_id=\''+path+'\']',this.container.dom);for(i=0;i<item_divs.length;i++){item_div=Ext.get(item_divs[i]);favorite_div=item_div.child('div.favorite');favorite_div.addClass('favorited');}
var item={id:path,group_id:'favorites'};this.grouped_list.insert_item(item,args.added.index);}
if(args.removed){path=args.removed.node.get_path();item_divs=sg_find_all('div.grouped_list_item[item_id=\''+path+'\']',this.container.dom);for(i=0;i<item_divs.length;i++){item_div=Ext.get(item_divs[i]);favorite_div=item_div.child('div.favorite');favorite_div.removeClass('favorited');}
this.grouped_list.remove_item(path,'favorites');}},recent_changed:function(args){if(!this.grouped_list||!this.is_showing()||this.get_browser().get_mode()!=='favorites')return;if(args.sender==='recent')return;var i;if(args.added){var item;for(i=0;i<args.added.length;i++){item={id:args.added[i].node.get_path(),group_id:'recent',image:args.added[i].node.image};this.grouped_list.insert_item(item,args.added[i].index);}}
if(args.moved){for(i=0;i<args.moved.length;i++)
if(args.moved[i].index===0)
this.grouped_list.move_item(args.moved[i].node.get_path(),0,'recent');}
if(args.removed&&args.sender!=='favorites'){for(i=0;i<args.removed.length;i++)
this.grouped_list.remove_item(args.removed[i].node.get_path(),'recent');}}});SG.ReviewApp=function(){};SG.ReviewApp.Utils={fetch_latest_n_versions_for_entity:function(entity_type,entity_id,columns,extra_conditions,data_set,ver_count){var conditions=[];if(extra_conditions){conditions=JSON.parse(JSON.stringify(extra_conditions));}
var entity_filter;if(entity_type&&entity_id)
entity_filter={path:'entity',relation:'is',values:[{type:entity_type,id:entity_id}]};else
entity_filter={path:'entity',relation:'is',values:[null]};if(conditions instanceof Array)
conditions.push(entity_filter);else
conditions=[{conditions:[conditions,entity_filter],logical_operator:'and'}];var ver_spec={type:'Version',columns:columns,filters:{logical_operator:'and',conditions:conditions},sorts:[{column:'id',direction:'desc'}],result:data_set};if(ver_count>-1){ver_spec.records_per_page=ver_count;ver_spec.current_page=1;}
SG.Repo.query(ver_spec);},fetch_versions_for_entity:function(entity_type,entity_id,columns,sorts,grouping,data_set){var spec={type:'Version',columns:columns,sorts:sorts,filters:{logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:entity_type,id:entity_id}]}]},grouping:grouping,result:data_set};SG.Repo.query(spec);},fetch_version_for_entity:function(entity,after_load_callback){var version_set=new SG.Data.Set('Version');version_set.on('load',function(){var record=version_set.count()?version_set.get_record(0):null;if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope,record);},this);var path='entity';if(this.entity_type==='Sequence')
path='entity.Shot.sg_sequence';var filters={logical_operator:'and',conditions:[{path:path,relation:'in',values:[entity]},{logical_operator:'or',conditions:[{path:'sg_uploaded_movie_mp4',relation:'is_not',values:[null]},{path:'sg_uploaded_movie_webm',relation:'is_not',values:[null]}]}]};var spec={type:'Version',columns:['entity'],filters:filters,sorts:[{column:'id',direction:'desc'}],result:version_set,records_per_page:1,current_page:1};SG.Repo.query(spec);},view_in_rv:function(entity){if(!entity.type==='Version')return;var mu_args='[(string, string)] {("version_id", "'+entity.id+'")}';var url=window.location.protocol+'//'+window.location.host
var cmd='-flags ModeManagerPreload=shotgun_review_app '+'-eval \'shotgun_review_app.theMode().setServer("'+url+'"); '+'shotgun_review_app.theMode().launchTimeline('+mu_args+');\'';var baked_cmd='';var i;for(i=0;i<cmd.length;i++)
baked_cmd+=cmd.charCodeAt(i).toString(16);document.location='rvlink://baked/'+baked_cmd;},rv_is_available:function(){if(window.rvsession)
return true;return false;},rv_eval:function(cmd){if(this.rv_is_available())
return this.parse_mu_result(window.rvsession.evaluate(cmd));},declare_mu_func:function(func_name,func_def){var cmd='runtime.lookup_function( runtime.intern_name(\"'+func_name+'\") )';var defined=this.rv_eval(cmd);if(!defined)
return this.rv_eval(func_def);},register_rv_callback:function(fn,event_names){if(!this.rv_is_available())return;window.rvsession.eventString.connect(fn);window.rvsession.bindToRegex(event_names.join('|'));},parse_mu_result:function(result){if(result===undefined||result=='nil'||result=='void')
return null;if(result.indexOf('exception:')>-1)
throw{message:"RV Error: "+result};if(result==="true")
return true;if(result==="false")
return false;if(result.length>1&&result[0]==='"'&&result[result.length-1]==='"')
return result.slice(1,-1);if(/^-?[0-9]+(\.[0-9]+)?$/.test(result))
return Number(result);var is_list=false;var contents,substr;if(/^.*\[\] \{.*\}$/.test(result)){is_list=true;var first_brace_pos=result.indexOf('{');var last_brace_pos=result.lastIndexOf('}');substr=result.slice(first_brace_pos+1,last_brace_pos);if(substr.trim()==='')
contents=[];else
contents=substr.split(',');}else if(/^\(.*\)$/.test(result)){is_list=true;var first_paren_pos=result.indexOf('(');var last_paren_pos=result.lastIndexOf(')');substr=result.slice(first_paren_pos+1,last_paren_pos);if(substr.trim()==='')
contents=[];else
contents=substr.split(',');}
if(is_list){var i;var list_items=[];for(i=0;i<contents.length;i++)
list_items.push(this.parse_mu_result(contents[i].trim()));return list_items;}
return{name:result};},contexts_match:function(first,second){if(!first&&!second)return true;if((!first&&second)||(first&&!second)||(first.length!=second.length))return false;var item_map={};var keys=['id','type'];var i,j,k,key,matched,matched_indices;for(i=0;i<first.length;i++){for(j=0;j<second.length;j++){matched=true;for(k=0;k<keys.length;k++){key=keys[k];if(first[i].hasOwnProperty(key)){if(second[j].hasOwnProperty(key)&&first[i][key]===second[j][key]){continue;}else{matched=false;break;}}else{matched=false;break;}}
if(matched){item_map[i]=j;break;}}
if(item_map.hasOwnProperty(i)){for(j=0;j<keys.length;j++){key=keys[j];if(second[item_map[i]].hasOwnProperty(key)&&!first[i].hasOwnProperty(key))
return false;}}else{return false;}}
return true;},reveal:function(container,delay){var target_height=container.getHeight();delay=(delay||delay===0)?delay:250;container.setHeight(0);container.setOpacity(0);container.setDisplayed(false);setTimeout(function(){container.setDisplayed(true);container.setHeight(target_height,{duration:0.25,easing:'easeOut',callback:function(){container.setStyle('height','auto');},scope:this});container.setOpacity(1,{duration:0.25,easing:'easeOut'});},delay);},hide:function(container,delay,callback){delay=delay||0;setTimeout(function(){container.setHeight(0,{duration:0.25,easing:'easeIn',callback:function(){if(callback)
callback.fn.call(callback.scope);},scope:this});container.setOpacity(0,{duration:0.25,easing:'easeIn'});},delay);},remove:function(container,delay,callback){this.hide(container,delay,{fn:function(){container.remove();if(callback)
callback.fn.call(callback.scope);},scope:this});},flag_version_records:function(records,unflagged){if(records.length<1)return;var record_ids=[];var i,record;SG.Repo.start_batch();var changed;for(i=0;i<records.length;i++){record=records[i];changed=false;if(record.get('flagged')&&unflagged){record.set('flagged',0);changed=true;}else if(!record.get('flagged')&&!unflagged){record.set('flagged',1);changed=true;}
if(changed){record.commit(true);record_ids.push(record.get_id());}}
SG.Repo.end_batch();},notify_flag_state_changed:function(version_ids,sender){SG.NotificationCenter.post({uuid:'_review_app_utils_',name:'flagged_state_changed',args:{version_ids:version_ids,sender:sender}});},store_favorites:function(){var ser_obj=[];var i;for(i=0;i<this.favorites.length;i++)
ser_obj.push(this.favorites[i].to_hash());localStorage.setItem('sgw_review_app_favorites',Ext.encode(ser_obj));},fetch_favorites:function(after_load_callback){if(!this.ff_callback_queue)
this.ff_callback_queue=[];if(after_load_callback)
this.ff_callback_queue.push(after_load_callback);if(this.favorites_loading)return;this.favorites_loading=true;this.favorites_map={};var cookie=localStorage.getItem('sgw_review_app_favorites');var exit=false;var ser_obj;if(!cookie){exit=true;}else{ser_obj=Ext.decode(cookie);if(ser_obj.length===0)
exit=true;}
if(exit){this.favorites=[];this.process_ff_callback_queue();return;}
var me=this;var make_callback=function(i){return{fn:function(node){me.on_favorite_fetched(node,i,ser_obj.length,after_load_callback);},scope:me};};var i;for(i=0;i<ser_obj.length;i++)
SG.ReviewAppTreeNode.from_hash(ser_obj[i],make_callback(i));},on_favorite_fetched:function(node,index,num_nodes,after_load_callback){this.favorites_map[index]=node;var key;var key_count=0;for(key in this.favorites_map)
if(this.favorites_map.hasOwnProperty(key))
++key_count;if(key_count<num_nodes)return;this.favorites=[];var i;for(i=0;i<num_nodes;i++)
if(this.favorites_map.hasOwnProperty(i)&&this.favorites_map[i]&&this.favorites_map[i].is_valid())
this.favorites.push(this.favorites_map[i]);this.favorites_map={};this.process_ff_callback_queue();},process_ff_callback_queue:function(){var i;for(i=0;i<this.ff_callback_queue.length;i++)
this.ff_callback_queue[i].fn.call(this.ff_callback_queue[i].scope);this.ff_callback_queue=[];this.favorites_loading=false;},favorites_loaded:function(){return this.favorites?true:false;},get_favorites:function(){return this.favorites.slice(0);},node_is_favorite:function(node){var i;for(i=0;i<this.favorites.length;i++){if(node.get_path()===this.favorites[i].get_path())
return true;}
return false;},favorite_node:function(node,sender,no_notify){if(!this.favorites_loaded()){this.fetch_favorites({fn:function(){this.favorite_node(node,sender,no_notify);},scope:this});return;}
var favs=this.favorites.slice(0);if(favs.length>100&&this.node_is_favorite(node))return;var index=0;var i;for(i=0;i<favs.length;i++){if(node.name.toLowerCase()>favs[i].name.toLowerCase())
index=i+1;else
break;}
var moved_nodes;if(index<favs.length){moved_nodes=[];var nodes=favs.slice(index);for(i=0;i<nodes.length;i++)
moved_nodes.push({node:nodes[i],index:index+i+1});}
var inserted_node=node.copy();favs.splice(index,0,inserted_node);this.favorites=favs;if(!no_notify){var args={added:{node:node,index:index},sender:sender};if(moved_nodes)
args.moved=moved_nodes;SG.NotificationCenter.post({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',args:args});}
this.update_recent_from_history('_favorited_',no_notify);this.store_favorites();},unfavorite_node:function(node,sender,no_notify){if(!this.favorites_loaded()){this.fetch_favorites({fn:function(){this.unfavorite_node(node,sender,no_notify);},scope:this});return;}
var favs=this.favorites.slice(0);var index=-1;var i;for(i=0;i<favs.length;i++){if(node.get_path()===favs[i].get_path()){index=i;break;}}
if(index<0)return;var moved_nodes;if(index<favs.length-1){moved_nodes=[];var nodes=favs.slice(index+1);for(i=0;i<nodes.length;i++)
moved_nodes.push({node:nodes[i],index:index+i});}
favs.splice(index,1);this.favorites=favs;if(!no_notify){var args={removed:{node:node,index:index},sender:sender};if(moved_nodes)
args.moved=moved_nodes;SG.NotificationCenter.post({uuid:'_review_app_favorites_',name:'review_app_favorites_changed',args:args});}
this.update_recent_from_history('_unfavorited_',no_notify);this.store_favorites();},store_recent:function(){var ser_obj=[];var i;for(i=0;i<this.history.length;i++)
ser_obj.push(this.history[i].to_hash());localStorage.setItem('sgw_review_app_history',Ext.encode(ser_obj));},fetch_recent:function(after_load_callback){if(!this.fr_callback_queue)
this.fr_callback_queue=[];if(after_load_callback)
this.fr_callback_queue.push(after_load_callback);if(this.recent_loading)return;this.recent_loading=true;this.history_map={};var cookie=localStorage.getItem('sgw_review_app_history');var exit=false;var ser_obj;if(!cookie){exit=true;}else{ser_obj=Ext.decode(cookie);if(ser_obj.length===0)
exit=true;}
if(exit){this.history=[];this.recent=[];this.process_fr_callback_queue();return;}
var me=this;var make_callback=function(i){return{fn:function(node){this.history_map[i]=node;me.on_recent_and_favorites_loaded(ser_obj.length);},scope:me};};var i;for(i=0;i<ser_obj.length;i++)
SG.ReviewAppTreeNode.from_hash(ser_obj[i],make_callback(i));if(!this.favorites_loaded())
this.fetch_favorites({fn:function(){this.on_recent_and_favorites_loaded(ser_obj.length);},scope:this});},on_recent_and_favorites_loaded:function(num_nodes){var key;var key_count=0;for(key in this.history_map)
if(this.history_map.hasOwnProperty(key))
++key_count;if(key_count<num_nodes||!this.favorites_loaded())return;var i;this.history=[];for(i=0;i<num_nodes;i++)
if(this.history_map.hasOwnProperty(i)&&this.history_map[i]&&this.history_map[i].is_valid())
this.history.push(this.history_map[i]);this.update_recent_from_history();this.history_map={};this.process_fr_callback_queue();},process_fr_callback_queue:function(){var i;for(i=0;i<this.fr_callback_queue.length;i++)
this.fr_callback_queue[i].fn.call(this.fr_callback_queue[i].scope);this.fr_callback_queue=[];this.recent_loading=false;},recent_loaded:function(){return this.recent?true:false;},get_recent:function(){return this.recent.slice(0);},add_recent:function(node,sender,no_notify){if(!this.recent_loaded()||!this.favorites_loaded()){var callback={fn:function(){if(!this.recent_loaded()||!this.favorites_loaded())return;this.add_recent(node,sender);},scope:this};this.fetch_recent(callback);this.fetch_favorites(callback);return;}
var parent=node.get_parent();if(!parent)return;var history=this.history.slice(0);var index=-1;var i;for(i=0;i<history.length;i++){if(history[i].get_path()===node.get_path()){index=i;break;}}
if(index===0)return;if(index>0)
history.splice(index,1);history=[node.copy()].concat(history);if(history.length>50)
history=history.slice(0,50);this.history=history;this.update_recent_from_history(sender,no_notify);this.store_recent();},update_recent_from_history:function(sender,no_notify){if(!this.history)return;var new_recent=[];var paths=[];var i;for(i=0;i<this.history.length;i++){if(!this.node_is_favorite(this.history[i])&&paths.indexOf(this.history[i].get_path())<0){new_recent.push(this.history[i]);paths.push(this.history[i].get_path());if(new_recent.length>=10)
break;}}
var old_recent=this.recent?this.recent.slice(0):null;this.recent=new_recent;if(old_recent&&!no_notify){var old_to_new_map={};var new_to_old_map={};var j;for(i=0;i<old_recent.length;i++){for(j=0;j<new_recent.length;j++){if(old_recent[i].get_path()===new_recent[j].get_path()){old_to_new_map[i]=j;new_to_old_map[j]=i;break;}}}
var added_indices=[];var key;for(i=0;i<new_recent.length;i++)
if(!new_to_old_map.hasOwnProperty(i))
added_indices.push(i);var removed_indices=[];for(i=0;i<old_recent.length;i++)
if(!old_to_new_map.hasOwnProperty(i))
removed_indices.push(i);var moved_indices=[];for(i=0;i<new_recent.length;i++)
if(new_to_old_map.hasOwnProperty(i)&&i!==new_to_old_map[i])
moved_indices.push(i);var args={sender:sender};var changed=false;if(added_indices.length){args.added=[];for(i=0;i<added_indices.length;i++){args.added.push({node:new_recent[added_indices[i]],index:added_indices[i]});}
changed=true;}
if(removed_indices.length){args.removed=[];for(i=0;i<removed_indices.length;i++){args.removed.push({node:old_recent[removed_indices[i]],index:removed_indices[i]});}
changed=true;}
if(moved_indices.length){args.moved=[];for(i=0;i<moved_indices.length;i++){args.moved.push({node:new_recent[moved_indices[i]],index:moved_indices[i]});}
changed=true;}
if(changed)
SG.NotificationCenter.post({uuid:'_review_app_recent_',name:'review_app_recent_changed',args:args});}}};SG.Widget.ReviewAppSubmission=function(context,widget_spec,id){SG.Widget.ReviewAppSubmission.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ReviewAppSubmission,SG.Widget.Base,{templates:{main:'<div class="sgw_review_app_submission">'+'<div class="sgw_review_app_submission_top_pane">Shotgun Submit'+'<div class="close_pane_button"></div>'+'<div class="tear_off_pane_button {floating}"></div>'+'</div>'+'<div class="sgw_review_app_submission_bottom_pane">'+'<div class="sgw_review_app_message_bar">'+'<div class="message_content"></div>'+'<div class="close"></div>'+'</div>'+'<div class="submission_form sgw_review_app_scroll_area"></div>'+'</div>'+'<div class="pkg_out_of_date_alert"></div>'+'</div>',field_table:'<div class="fields"><table>{table_contents}</table></div>',field:'<tr>'+'<td class="field_label {mandatory}" sg_tip="{sg_tip}"><div>{field_label}</div></td>'+'<td class="field_value"><div class="{cell_classes}" {cell_attributes}>{cell_content}</div></td>'+'</tr>',footer:'<div class="controls">'+'<input name="submit" class="sgw_review_app_icon_button" type="button" value="Submit">'+'</div>',success:'<div class="success_box">'+'<div class="success_message">Your work has been submitted successfully!</div>'+'{extra_content}'+'</div>',extra_content:'<b>Please do not close this window until the following have completed:</b>'+'<div class="success_options"></div>',action_waiting:'<div class="action waiting">{action_description} waiting to begin</div>',action_in_progress:'<div class="action in_progress">'+'<div class="progress"></div>'+'&nbsp;{action_description} in progress</div>',action_complete:'<div class="action complete">'+'<div class="progress"></div>'+'&nbsp;{action_description} complete!</div>',action_failed:'<div class="action failed">'+'<div class="progress"></div>'+'&nbsp;{action_description} failed!</div>',content_ready:'<div class="timeline_button">View in Timeline</div>'},init_widget:function(){this.project=this.context.get('project');this.entity=this.context.get('entity');this.step=this.context.get('step');this.task=this.context.get('task');var qt_path=this.context.get('qt_output_path');this.quicktime_output_path=qt_path?decodeURIComponent(qt_path):null;this.fields=[{name:'project',label:'Project',cell_type:SG.FakeInputCell,required:true},{name:'entity',label:'Link',cell_type:SG.FakeInputCell,required:true},{name:'sg_task',label:'Task',cell_type:SG.FakeInputCell,required:false},{name:'description',label:'Comment',cell_type:SG.LargeTextAreaCell,required:true},{name:'sg_status_list',label:'Status',cell_type:SG.FakeInputCell,required:false}];this.version_set=this.new_data_set('Version',null,this.on_version_change);this.record=this.version_set.new_record();this.declare_mu_funcs();var me=this;SG.ReviewApp.Utils.register_rv_callback(function(name,contents,sender){me.on_rv_event(name,contents,sender);},['sg-pane-top-level-changed','sg-thumbnail-upload-finished','sg-thumbnail-upload-error','sg-filmstrip-upload-finished','sg-filmstrip-upload-error','sg-quicktime-export-complete','sg-quicktime-export-error','sg-quicktime-upload-complete','after-graph-view-change','graph-node-inputs-changed']);},on_first_render:function(){this.container=this.get_container();var floating=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().paneIsFloating("Bottom")');this.container.update(this.templates.main.apply({floating:floating?'floating':''}));this.add_event(this.container,'click',this.on_click);this.bottom_pane_div=this.container.child('div.submission_form');this.message_bar_div=this.container.child('div.sgw_review_app_message_bar');this.message_bar_content_div=this.message_bar_div.child('div.message_content');var rv_ver_checker_div=this.container.child('div.pkg_out_of_date_alert');this.rv_pkg_checker=this.new_component(SG.ReviewAppRvVersionChecker,{container:rv_ver_checker_div});if(this.rv_pkg_checker.rv_pkg_is_out_of_date()){this.rv_pkg_checker.render();return;}
var cell_config={container:this.container,data_set:this.version_set,projects:SG.schema.projects,in_form:true,get_fields_callback:{fn:this.get_fields,scope:this},before_first_cell:{fn:this.focus_submit_button,scope:this},after_last_cell:{fn:this.focus_submit_button,scope:this},edit_applied_callback:{fn:this.on_after_cell_edit,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);if(!this.task&&this.entity){this.tasks_set=this.new_data_set('Task',this.on_tasks_load);this.fetching_tasks=true;this.show_loading_overlay(this.bottom_pane_div);this.fetch_tasks();}else{this.set_defaults();}
this.on_media_loaded();},render_widget:function(){if(this.fetching_tasks)return;var schema=SG.schema.entity_fields.Version;var i;var field_table_contents='';var field,data_type,cell,cell_hash;for(i=0;i<this.fields.length;i++){field=this.fields[i];data_type=schema[field.name].data_type;cell=this.cell_manager.get_cell(field.name,{type:field.cell_type});cell_hash=cell.render(this.record);cell_hash.field_label=field.label;if(field.required){cell_hash.mandatory='mandatory';cell_hash.sg_tip='Required';}
field_table_contents+=this.templates.field.apply(cell_hash);this.last_rendered_cell=cell;}
var html=this.templates.field_table.apply({table_contents:field_table_contents});html+=this.templates.footer.apply();this.bottom_pane_div.update(html);this.submit_button=this.container.child('input[name="submit"]');this.add_event(this.submit_button,'keydown',this.on_submit_button_keydown);this.submit_button.on('click',this.on_submit_button_clicked,this);var me=this;setTimeout(function(){me.edit_first_empty_field();},750);},render_success:function(){var extra_content='';if(this.thumbnail_enabled()||this.filmstrips_enabled()||this.quicktime_enabled())
extra_content=this.templates.extra_content.apply();var html=this.templates.success.apply({extra_content:extra_content});this.bottom_pane_div.update(html);if(extra_content){this.options_div=this.bottom_pane_div.child('div.success_options');this.render_success_options();}else{this.on_submission_complete();}},render_success_options:function(){if(!this.options_div)return;var cfgs=[];if(this.thumbnail_enabled())
cfgs.push({action_description:'Thumbnail generation',complete:this.thumbnail_generated,in_progress:this.thumbnail_generation_started,error:this.thumbnail_generation_failed});if(this.filmstrips_enabled())
cfgs.push({action_description:'Filmstrip thumbnail generation',complete:this.filmstrip_generated,in_progress:this.filmstrip_generation_started,error:this.filmstrip_generation_failed});if(this.quicktime_enabled()){cfgs.push({action_description:'Quicktime generation',complete:this.quicktime_generated,in_progress:this.quicktime_generation_started,error:this.quicktime_generation_failed});}
if(this.quicktime_upload_enabled()){cfgs.push({action_description:'Quicktime upload',complete:this.quicktime_upload_complete,in_progress:this.quicktime_upload_started,error:this.quicktime_upload_failed});}
var options_html='';var i,cfg,template;for(i=0;i<cfgs.length;i++){if(cfgs[i].complete)
template=this.templates.action_complete;else if(cfgs[i].error)
template=this.templates.action_failed;else if(cfgs[i].in_progress)
template=this.templates.action_in_progress;else
template=this.templates.action_waiting;options_html+=template.apply(cfgs[i]);}
this.options_div.update(options_html);},on_submission_complete:function(){Ext.DomHelper.append(this.bottom_pane_div,this.templates.content_ready.apply());this.submission_complete=true;},fetch_tasks:function(){var conditions=[{path:'entity',relation:'is',values:[this.entity]}];if(this.step)
conditions.push({path:'step',relation:'is',values:[this.step]});var task_spec={type:'Task',columns:['content','task_assignees','step','sg_status_list'],filters:{logical_operator:'and',conditions:conditions},sorts:[{column:'sg_status_list',direction:'desc'}],result:this.tasks_set};SG.Repo.query(task_spec);},fetch_task_link:function(task_id){var data_set=this.new_data_set('Task');data_set.on('load',function(){if(!data_set.count())return;var task=data_set.get_record(0);this.entity=task.get('entity');if(this.entity)
this.record.set('entity',this.entity);if(task.get('project'))
this.record.set('project',task.get('project'));var i,field;for(i=0;i<this.fields.length;i++){field=this.fields[i];if(['entity','project'].indexOf(field.name)===-1)continue;var cell=this.cell_manager.get_cell(field.name,{type:field.cell_type});cell.update_cell(this.record,true);}},this);var task_spec={type:'Task',ids:[task_id],columns:['entity'],result:data_set};SG.Repo.find(task_spec);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.close_pane_button',this.container));if(elem){this.close_pane();return;}
elem=Ext.get(target.findParent('div.tear_off_pane_button',this.container));if(elem){if(SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().paneIsFloating("Bottom")'))
this.dock_pane();else
this.tear_off_pane();return;}
elem=Ext.get(target.findParent('div.close',this.message_bar_div));if(elem&&elem.findParent('div.sgw_review_app_message_bar',this.container)){this.close_message_bar();return;}
elem=Ext.get(target.findParent('div.timeline_button',this.container));if(elem){this.show_loading_overlay();window.location="/page/review_app?version_id="+this.record.get_id();return;}},on_after_cell_edit:function(field,record,cell){if(field==='sg_task'&&record.get('sg_task')){this.fetch_task_link(record.get('sg_task').id);return;}
var cleared=false;if(field==='entity'&&record.get('sg_task')){record.set('sg_task',null);cleared=true;}else if(field==='project'&&(record.get('entity')||record.get('sg_task'))){record.set('sg_task',null);record.set('entity',null);cleared=true;}
if(cleared){var i,field;for(i=0;i<this.fields.length;i++){field=this.fields[i];if(['sg_task','entity'].indexOf(field.name)===-1)continue;var cell=this.cell_manager.get_cell(field.name,{type:field.cell_type});cell.update_cell(this.record,true);}}},on_submit_button_keydown:function(e){var key=e.getKey();if(key==Ext.EventObject.TAB)
{e.stopEvent();if(e.shiftKey)
this.edit_last_field();else
this.edit_first_field();}},on_submit_button_clicked:function(e){e.stopEvent();this.on_submit();},on_rv_event:function(name,content,sender){if(name==='sg-pane-top-level-changed'){var event_contents=content.split(';');var pane_name=event_contents[0];var floating=Number(event_contents[1]);if(pane_name==='Bottom'){var elem=this.container.child('div.tear_off_pane_button');if(elem){if(floating)
elem.addClass('floating');else
elem.removeClass('floating');}}
return;}
switch(name){case'sg-thumbnail-upload-finished':this.on_thumbnail_complete();break;case'sg-thumbnail-upload-error':this.on_thumbnail_error(content);break;case'sg-filmstrip-upload-finished':this.on_filmstrip_complete();break;case'sg-filmstrip-upload-error':this.on_filmstrip_error(content);break;case'sg-quicktime-export-complete':this.on_quicktime_complete();break;case'sg-quicktime-export-error':this.on_quicktime_error(content);break;case'sg-quicktime-upload-complete':this.on_quicktime_upload_complete();break;case'sg-quicktime-upload-error':this.on_quicktime_upload_error(content);break;case'after-graph-view-change':this.on_media_loaded();break;case'graph-node-inputs-changed':var view_node=this.rv_eval_with_error_dialog('viewNode()');if(view_node&&view_node==content)
this.on_media_loaded();break;default:break;}},on_submit:function(){if(!this.mandatory_fields_provided()){this.submit_complete();return;}
var message;if(!this.source&&!sg_is_in_rv()){message='Unable to communicate with RV';this.display_message_bar(message,true);return;}
var source=this.on_media_loaded();if(!source)return;this.source=source;this.file_name=this.get_file_name_of_source(this.source);this.show_loading_overlay(this.bottom_pane_div);this.submit();},on_media_loaded:function(){var sources=this.get_all_sources();var message,source;if(!sources||!sources.length)
message='No media is currently loaded in RV';else if(sources.length>1){var view_node=this.rv_eval_with_error_dialog('viewNode()');message='There are multiple inputs loaded in RV for the view "'+view_node
+'". Please ensure only one source is loaded.';}else{var result=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().currentShotgunSources();');if(result&&result.length>0){message='This content is already associated with a Version in Shotgun';}else{source=sources[0]+"_source";var file_name=this.get_file_name_of_source(source);if(!file_name){message="File name cannot be determined for the current source.";}else{var reqd_fields=['project','code','sg_task','sg_path_to_frames','entity','sg_first_frame','sg_last_frame','frame_count','frame_range','sg_path_to_movie','sg_movie_has_slate'];var missing_fields=[];var i;for(i=0;i<reqd_fields.length;i++){if(!SG.schema.entity_fields.Version.hasOwnProperty(reqd_fields[i]))
missing_fields.push(reqd_fields[i]);}
if(missing_fields.length>0)
message="The following Version fields are required but do not exist: "+
missing_fields.join(", ");}}}
if(message){this.display_message_bar(message,true);return null;}else if(SG.globals.preferences.enable_revolver_quicktime_generation&&sg_is_in_rv()&&SG.ReviewApp.Utils.rv_eval('sg_os_is_win64();')){this.display_message_bar("Quicktime generation is not currently available on this OS.");}else{this.close_message_bar();}
return source;},on_tasks_load:function(){this.fetching_tasks=false;this.determine_task();this.hide_loading_overlay();this.set_defaults();this.render_widget();},on_version_change:function(changes){var change,i;var created=false;var movie_updated=false;for(i=0;i<changes.length;i++){change=changes[i];if(change.type==='create'){this.hide_loading_overlay();this.render_success();this.thumbnail_generated=false;this.filmstrip_generated=false;this.quicktime_generated=false;this.quicktime_upload_complete=false;this.perform_next_action();this.submit_complete();return;}
if(change.state!='pending'&&change.type==='update'&&change.column==='sg_path_to_movie'){this.quicktime_generated=true;this.perform_next_action();return;}}
this.submit_complete();},perform_next_action:function(){var complete=true;if(this.thumbnail_enabled()&&!this.thumbnail_generated){this.generate_thumbnail();complete=false;}else if(this.filmstrips_enabled()&&!this.filmstrip_generated){this.generate_filmstrip();complete=false;}else if(this.quicktime_enabled()&&!this.quicktime_generated){this.generate_quicktime();complete=false;}else if(this.quicktime_upload_enabled()&&!this.quicktime_upload_complete){this.upload_quicktime();complete=false;}
if(complete)
this.on_submission_complete();this.render_success_options();},set_defaults:function(){if(this.project)
this.record.set('project',this.project);if(this.task)
this.record.set('sg_task',this.task);if(SG.schema.entity_fields.Version.sg_status_list.status_list_subset.indexOf('rev')!==-1)
this.record.set('sg_status_list','rev');},determine_task:function(){if(!this.tasks_set.count())return;var our_tasks_indices=[];var in_progress_tasks_indices=[];var i,rec,assignees,j;for(i=0;i<this.tasks_set.count();i++){rec=this.tasks_set.get_record(i);assignees=rec.get('task_assignees');for(j=0;j<assignees.length;j++){if(assignees[j].name===SG.globals.current_user.display_name){our_tasks_indices.push(i);break;}}
if(rec.get('sg_status_list')==='ip')
in_progress_tasks_indices.push(i);}
var rec_found=false;if(!our_tasks_indices.length&&!in_progress_tasks_indices.length){rec=this.tasks_set.get_record(0);rec_found=true;}
else if(our_tasks_indices.length){for(i=0;i<our_tasks_indices.length;i++){if(in_progress_tasks_indices.indexOf(our_tasks_indices[i])>-1){rec=this.tasks_set.get_record(our_tasks_indices[i]);rec_found=true;}}
if(!rec_found){rec=this.tasks_set.get_record(our_tasks_indices[0]);rec_found=true;}}
else if(in_progress_tasks_indices.length){rec=this.tasks_set.get_record(in_progress_tasks_indices[0]);rec_found=true;}
if(!rec_found)
rec=this.tasks_set.get_record(0);this.task={type:'Task',id:rec.get_id(),name:rec.get('content'),status:rec.get('sg_status_list')};return;},get_fields:function(){var field_names=[];var i;for(i=0;i<this.fields.length;i++)
field_names.push(this.fields[i].name);return field_names;},edit_cell:function(cell){var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="'+cell.field+'"]';var cell_elem=sg_find(sel,this.bottom_pane_div.dom);if(cell_elem){cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});}},edit_field:function(field_name,field_type){var cell=this.cell_manager.get_cell(field_name,{type:field_type});if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}},edit_first_field:function(){var field_hash=this.fields[0];this.edit_field(field_hash.name,field_hash.cell_type);},edit_first_empty_field:function(){var i,field;for(i=0;i<this.fields.length;i++){field=this.fields[i];if(this.record.get(field.name))continue;this.edit_field(field.name,field.cell_type);return;}
this.focus_submit_button();},edit_last_field:function(){if(this.last_rendered_cell){var me=this;setTimeout(function(){me.edit_cell(me.last_rendered_cell);});}},focus_submit_button:function(){var me=this;setTimeout(function(){me.submit_button.dom.focus();});},declare_mu_funcs:function(){var func_name;var func_names=[];var func_defs=[];func_name='sg_frames';func_names.push(func_name);func_defs.push('function: '+func_name+' ((int, int); string sourceName) { '+'let smi = sourceMediaInfo(sourceName); '+'return (smi.startFrame, smi.endFrame); }');func_name='sg_os_is_win64';func_names.push(func_name);func_defs.push('function: '+func_name+' (bool;) { '+'require runtime; '+'let os = runtime.build_os(), '+'    arch = runtime.build_architecture(); '+'return os == "WINDOWS" && arch == "IA32_64"; '+'}');var i,cmd,defined;for(i=0;i<func_defs.length;i++)
defined=SG.ReviewApp.Utils.declare_mu_func(func_names[i],func_defs[i]);},rv_eval_with_error_dialog:function(cmd){try{return SG.ReviewApp.Utils.rv_eval(cmd);}catch(obj){this.display_message_bar(obj.message,true);}},get_all_sources:function(){var view_node=this.rv_eval_with_error_dialog('viewNode()');var node_type=this.rv_eval_with_error_dialog('nodeType("'+view_node+'")');if(['RVSource','RVFileSource','RVImageSource','RVSourceGroup'].indexOf(node_type)>-1)
return[view_node];return this.rv_eval_with_error_dialog('nodeConnections(viewNode(), false)._0;');},get_file_name_of_source:function(source_name){return this.rv_eval_with_error_dialog('shotgun_review_app.theMode().getFilePathForSource("'+source_name+'")');},get_frames_of_source:function(source_name){return this.rv_eval_with_error_dialog('sg_frames("'+source_name+'")');},mandatory_fields_provided:function(){var missing_fields=[];var missing_fields_indices=[];var i,field,value;for(i=0;i<this.fields.length;i++){field=this.fields[i];if(!field.required)
continue;value=this.record.get(field.name);if(value==null||value===''||(typeof value=='string'&&value.strip()==="")){missing_fields.push('"'+field.label+'"');missing_fields_indices.push(i);}}
if(missing_fields.length>0){var message='Please provide: '+missing_fields.join(', ')+'.';this.display_message_bar('Required Fields Missing: '+message);return false;}
return true;},submit:function(){this.submitting=true;this.submit_button.dom.setAttribute('disabled',true);var version_name=this.get_version_name();this.record.set('code',version_name);if(this.file_name_is_movie(this.file_name)){this.quicktime_output_path=this.file_name;this.record.set('sg_path_to_movie',this.file_name);}else{this.record.set('sg_path_to_frames',this.file_name);}
var frames=this.get_frames_of_source(this.source);var first_frame=frames[0];if(first_frame>-1)
this.record.set('sg_first_frame',first_frame);var last_frame=frames[1];if(last_frame>-1)
this.record.set('sg_last_frame',last_frame);if(first_frame>-1&&last_frame>-1){this.duration=last_frame-first_frame+1;this.record.set('frame_count',this.duration);this.record.set('frame_range',first_frame+'-'+last_frame);}
this.show_loading_overlay(this.bottom_pane_div);var no_undo=true;this.record.commit(no_undo);},submit_complete:function(){this.submitting=false;if(this.submit_button)
this.submit_button.dom.removeAttribute('disabled');this.hide_loading_overlay();},file_name_is_movie:function(file_name){return(/\.(mov|MOV|avi|AVI|mp4|MP4)$/).test(file_name);},get_version_name:function(){var start_index=0;var last_slash_index=Math.max(this.file_name.lastIndexOf('/'),this.file_name.lastIndexOf('\\'));if(last_slash_index!==-1)
start_index=last_slash_index+1;var base_name=this.file_name.slice(start_index);var end_index=base_name.length;var extension_index=base_name.lastIndexOf('.');if(extension_index!==-1){end_index=extension_index;var date_spec_RE=/\.[0-9]{1,2}\.[0-9]{1,2}\.[0-9]{1,2}$/;if(!base_name.slice(0,extension_index).match(date_spec_RE)){var frame_index=base_name.lastIndexOf('.',extension_index-1);if(frame_index!==-1){var frame_spec_RE=/^(#+|@+|(-?[0-9]+(--?[0-9]+)?(#+|@+)?))$/;if(base_name.slice(frame_index+1,extension_index).match(frame_spec_RE))
end_index=frame_index;}}}
var version_name=base_name.slice(0,end_index);if(!version_name)
version_name=this.file_name;return version_name;},get_quicktime_base_name:function(){var base=this.quicktime_output_path?this.quicktime_output_path:(this.get_version_name()+'.mov');var file_name=base.replace(/^.*[\/\\]/,'');while(file_name.indexOf('#')>-1||file_name.indexOf('@')>-1||file_name.indexOf(' ')>-1)
file_name=file_name.replace(/(@+|#+|\s+)/,'');return file_name.replace(/\.[^\.]*$/,'')+'.mov';},get_quicktime_output_path:function(){if(this.quicktime_output_path)return this.quicktime_output_path;var dir_name=this.file_name.replace(/[^\/\\]*$/,'');return dir_name+this.get_quicktime_base_name();},generate_filmstrip:function(){if(this.filmstrip_generation_started)return;this.filmstrip_generation_started=true;var rv_cmd='shotgun_review_app.theMode().uploadFilmstripForCurrentSource('+
this.record.get_id()+');';SG.ReviewApp.Utils.rv_eval(rv_cmd);this.render_success_options();},generate_thumbnail:function(){if(this.thumbnail_generation_started)return;this.thumbnail_generation_started=true;SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().uploadThumbnailForCurrentSource('+this.record.get_id()+');');this.render_success_options();},generate_quicktime:function(){if(this.quicktime_generation_started)return;var date=new Date();var date_str=date.toDateString()+' '+date.getHours()+'.'+date.getMinutes();var metadata=[{name:'Artist',value:SG.globals.current_user.display_name},{name:'Created',value:date_str},{name:'File name',value:this.get_quicktime_base_name()},{name:'Comment',value:this.record.get('description')}];var entity=this.record.get('entity');if(entity&&entity.name)
metadata=[{name:entity.type,value:entity.name}].concat(metadata);var metadata_items=[];var i;for(i=0;i<metadata.length;i++)
metadata_items.push(metadata[i].name+'='+metadata[i].value);this.quicktime_output_path=this.get_quicktime_output_path();if(!this.quicktime_output_path){this.on_quicktime_error('Could not determine quicktime output path');return;}
this.quicktime_generation_started=true;var rv_cmd='shotgun_review_app.theMode().exportQuicktimeForCurrentSource("'+
this.quicktime_output_path+'", string[] {"'+metadata_items.join('", "')+'"});';SG.ReviewApp.Utils.rv_eval(rv_cmd);this.render_success_options();},upload_quicktime:function(){if(!this.quicktime_output_path){this.on_quicktime_upload_error('Could not determine quicktime output path');return;}
this.quicktime_upload_started=true;var rv_cmd='shotgun_upload.theMode().uploadMovToVersion("'+
this.quicktime_output_path+'", '+this.record.get_id()+', '+'"sg-quicktime-upload-complete");';var error=SG.ReviewApp.Utils.rv_eval(rv_cmd);if(error){this.on_quicktime_upload_error(error);return;}
this.render_success_options();},on_thumbnail_complete:function(){if(this.thumbnail_generated)return;this.thumbnail_generated=true;this.perform_next_action();},on_thumbnail_error:function(error){if(this.thumbnail_generation_failed)return;this.thumbnail_generation_failed=true;this.display_message_bar(error,true);this.perform_next_action();},on_filmstrip_complete:function(){if(this.filmstrip_generated)return;this.filmstrip_generated=true;this.perform_next_action();},on_filmstrip_error:function(error){if(this.filmstrip_generation_failed)return;this.filmstrip_generation_failed=true;this.display_message_bar(error,true);this.perform_next_action();},on_quicktime_complete:function(){if(this.quicktime_complete_handled)return;this.quicktime_complete_handled=true;this.record.set('sg_path_to_movie',this.quicktime_output_path);this.record.set('sg_movie_has_slate',true);var no_undo=true;this.record.commit(no_undo);},on_quicktime_error:function(error){if(this.quicktime_generation_failed)return;this.quicktime_generation_failed=true;this.display_message_bar(error,true);this.perform_next_action();},on_quicktime_upload_complete:function(){if(this.quicktime_upload_complete)return;this.quicktime_upload_complete=true;this.perform_next_action();},on_quicktime_upload_error:function(error){if(this.quicktime_upload_failed)return;this.quicktime_upload_failed=true;this.display_message_bar(error,true);this.render_success_options();},display_message_bar:function(message,error){this.message_bar_div.addClass('open');this.message_bar_content_div.update((error?'<b>Error:</b> ':'<b>Warning:</b> ')+message);if(error)
this.message_bar_div.addClass('error_message');else
this.message_bar_div.removeClass('error_message');},thumbnail_enabled:function(){return SG.globals.preferences.enable_revolver_thumbnail_generation;},quicktime_enabled:function(){return SG.globals.preferences.enable_revolver_quicktime_generation&&(this.file_name&&!this.file_name_is_movie(this.file_name))&&(!sg_is_in_rv()||!SG.ReviewApp.Utils.rv_eval('sg_os_is_win64();'));},quicktime_upload_enabled:function(){return!this.quicktime_generation_failed&&SG.globals.preferences.enable_revolver_quicktime_upload&&(this.quicktime_enabled()||(this.file_name&&this.file_name_is_movie(this.file_name)));},filmstrips_enabled:function(){return SG.globals.preferences.enable_revolver_thumbnail_generation&&SG.globals.preferences.filmstrip_thumbnails&&this.duration>1;},close_message_bar:function(){this.message_bar_div.removeClass('open');},close_pane:function(){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().closePane("Bottom");');},tear_off_pane:function(){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().setFloating("Bottom", true);');},dock_pane:function(){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().setFloating("Bottom", false);');}});SG.ReviewAppNoteForm=function(config){Ext.apply(this,config);SG.ReviewAppNoteForm.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNoteForm,SG.Component,{templates:{main:'<div class="sgc_review_app_note_form {is_reply}">{layout}</div>',note_layout:'<div class="current_user_thumb">{image}</div>'+'<div class="triangle">'+'<div class="comment_triangle"></div>'+'</div>'+'{note_form}',reply_layout:'{note_form}',note_form:'<div class="note_form">'+'<div class="note_body"></div>'+'<div class="note_fields_wrapper">'+'<div class="section fields"></div>'+'<div class="section tasks sgc_tasks_mini_grid_selector"></div>'+'<div class="section attachments"></div>'+'<div class="extra_controls">'+'<div class="extra_control tasks" sg_tip="Tasks">'+'<div class="icon_Task"></div>'+'</div>'+'<div class="extra_control attach" sg_tip="Attach a File">'+'<div class="icon_paperclip"></div>'+'</div>'+'<div class="extra_control more_fields">Fields</div>'+'<div class="extra_control spanner"></div>'+'<div class="extra_control cancel">Cancel</div>'+'<div class="extra_control create" tabindex="0">{submit_button_text}</div>'+'</div>'+'</div>'+'</div>'+'</div>',unlabeled_field:'<div class="{cell_classes}" {cell_attributes} field="{field}">{cell_content}</div>',field:'<div class="field" field="{field}">'+'<div class="field_label {mandatory}" sg_tip="{sg_tip}">{field_label}</div>'+'<div class="field_value {cell_classes}" {cell_attributes}>{cell_content}</div>'+'</div>',attachment_files:'<div class="attach_me {extra_cls}" field="{field}"></div>',attachment_field:'<div class="field" field="{field}"><table class="field_edit"><tr>'+'<td class="field_label " sg_tip="{sg_tip}"><div>{field_label}:</div></td>'+'<td class="field_value">{attachment_files}'+'</td></tr></table></div>',thumb_path:'/thumbnail/image/{value}',user_thumb:'<img src="{thumb}" onerror="sg_missing_user_thumb(this);">',default_user_thumb:'/images/default_user_thumb.png',reply_textarea:'<div class="current_user_thumb">{image}</div>'+'<div class="reply_textarea">'+'<textarea class="reply_textarea" placeholder="Reply or update Note properties..."></textarea>'+'</div>'},init_component:function(){this.events={entity_created:true};},on_first_render:function(){this.attachment_controls={};var layout;if(this.is_reply){layout=this.templates.reply_layout.apply({note_form:this.templates.note_form.apply({submit_button_text:'Reply'})});}else{var value=SG.globals.current_user.thumb_url;if(!value)
value=this.templates.default_user_thumb.apply();layout=this.templates.note_layout.apply({image:this.templates.user_thumb.apply({thumb:value}),note_form:this.templates.note_form.apply({submit_button_text:'Create Note'})});}
this.container.update(this.templates.main.apply({is_reply:this.is_reply?'is_reply':'',layout:layout}));this.note_form_div=this.container.child('div.note_form');this.note_body_div=this.container.child('div.note_body');this.note_fields_wrapper=this.container.child('div.note_fields_wrapper');this.fields_div=this.container.child('div.fields');this.extra_controls_div=this.container.child('div.extra_controls');this.quick_fields_div=this.container.child('div.quick_fields');this.more_fields_div=this.container.child('div.more_fields');this.tasks_div=this.container.child('div.tasks');this.attachments_div=this.container.child('div.attachments');this.attach_button=this.container.child('div.extra_control.attach');this.tasks_button=this.container.child('div.extra_control.tasks');this.more_fields_button=this.container.child('div.extra_control.more_fields');this.create_button=this.container.child('div.extra_control.create');this.add_event(this.data_set,'change',this.on_data_change);this.setup_cell_manager();this.load_visible_fields();this.render_note_body();this.user_thumb_div=this.container.child('div.current_user_thumb');this.add_event(this.container,'click',this.on_click);this.add_event(this.create_button,'keydown',this.on_create_button_keydown);},render:function(rerender){if(!this.rendered||rerender){this.on_first_render();this.rendered=true;}},render_note_body:function(){var html;if(this.is_reply){var value=SG.globals.current_user.thumb_url;if(!value)
value=this.templates.default_user_thumb.apply();html=this.templates.reply_textarea.apply({image:this.templates.user_thumb.apply({thumb:value})});}else{var cell=this.cell_manager.get_cell('content',{type:SG.LargeTextAreaCell});cell.placeholder_text='Create a new Note...';var cfg=cell.render(this.record);html=this.templates.unlabeled_field.apply(cfg);}
this.note_body_div.update(html);this.textarea=this.note_body_div.child('textarea');if(!this.is_reply&&this.record.get('content')){this.note_fields_wrapper.addClass('displayed');return;}
this.textarea.on('focus',this.show_fields,this);if(this.is_reply)
this.textarea.on('keydown',this.on_textarea_keydown,this);},render_tasks:function(){var cell=this.get_tasks_cell();var cfg=cell.render(this.record);var html=this.templates.unlabeled_field.apply(cfg);this.tasks_div.update(html);cell.render_note_addressings();},render_attachment_field:function(schema_field){var attachment_cfg={};var cfg={field:schema_field.name,field_label:schema_field.display_name,sg_tip:schema_field.display_name,};if(schema_field.name=='attachments'){cfg.attachment_files=this.templates.attachment_files.apply({field:'attachments',extra_cls:'threaded'});}else{cfg.attachments_files=this.templates.attachment_files.apply({field:schema_field.name});attachment_cfg.url_field=true;}
var html=this.templates.attachment_field.apply(cfg);var div=Ext.DomHelper.append(this.attachments_div,html,true);if(schema_field.name=='attachments'){attachment_cfg.container=div;}else{var attachment_div=div.child('td.field_value');attachment_cfg.container=attachment_div;}
this.attachment_controls[schema_field.name]=attachment_cfg;this.render_attachment_control(schema_field.name);},render_attachment_control:function(field){var ac=this.attachment_controls[field];var cfg={container:ac.container};if(ac.url_field)
cfg.url_field=field;ac.component=this.new_component(SG.AttachmentControl,cfg);ac.component.render();},upload_done:function(record_id,attachments,url_field){if(url_field&&attachments.length==1){this.record.set(url_field,attachments[0]);this.data_set.commit(true);}
if(this.upload_queue.length==0){this.fire_done_callback(record_id);}else{var upload_fn=this.upload_queue.shift();upload_fn.call(this);}},render_fields:function(){this.attachments_div.update('');this.tasks_div.update('');this.fields_div.update('');var i,field;for(i=0;i<this.visible_fields.length;i++){field=this.visible_fields[i];this.render_field(field);}},render_field:function(field){var schema_field=SG.schema.get_field('Note',field);if(schema_field.data_type==='url'||schema_field.name==='attachments'){this.render_attachment_field(schema_field);this.attachments_div.addClass('displayed');this.attach_button.addClass('active');return;}else if(field==='content'){this.render_note_body();return;}else if(field==='tasks'){this.render_tasks();this.tasks_div.addClass('displayed');this.tasks_button.addClass('active');return;}
var prefs=this.get_entity_prefs();var i,pref;for(i=0;i<prefs.length;i++){if(prefs[i].field===field)
pref=prefs[i];}
var cell=this.cell_manager.get_cell(field);if(!cell)return;var cfg=cell.render(this.record);cfg.field_label=schema_field.display_name;cfg.sg_tip=schema_field.display_name;cfg.field=field;cfg.mandatory=pref&&pref.mandatory_on_create&&'mandatory';var html=this.templates.field.apply(cfg);Ext.DomHelper.append(this.fields_div,html);this.fields_div.addClass('displayed');},get_cell_config:function(schema_field){return{type:this.get_cell_type(schema_field),double_click_for_edit:false};},get_cell_type:function(schema_field){if(schema_field.name=='content')
return SG.LargeTextAreaCell;else if(schema_field.name=="tasks")
return SG.TasksMiniGridSelector;else if(typeof(schema_field.editor)==="string")
return SG.FakeInputCell;else if(schema_field.data_type=='url')
return SG.UrlCell;else
return SG.FakeInputCell;},get_entity_prefs:function()
{var prefs=SG.globals.entity_field_prefs['new_entity']['Note']['settings'];var ret=[];for(var i=0;i<prefs.length;i++)
{var field_hash=prefs[i];var schema_field=SG.schema.get_field('Note',field_hash.field);if(schema_field)
ret.push(field_hash);}
return ret;},get_fields:function(){var supported_fields=[];var fields=this.get_fields_callback.fn.call(this.get_fields_callback.scope);var i,schema_field;for(i=0;i<fields.length;i++)
{schema_field=SG.schema.get_field('Note',fields[i]);if(this.more_fields_disabled(schema_field))continue;supported_fields.push(schema_field.name);}
return supported_fields;},on_before_first_cell:function(){if(this.is_reply)
this.textarea.focus();else
this.focus_create_button();},setup_cell_manager:function(){var cfg={container:this.container,edit_container:this.edit_container,data_set:this.data_set,projects:sg_deep_copy(this.all_projects),in_form:true,get_fields_callback:{fn:this.get_tabable_fields,scope:this},before_first_cell:{fn:this.on_before_first_cell,scope:this},after_last_cell:{fn:this.focus_create_button,scope:this},edit_applied_callback:{fn:this.on_cell_edit,scope:this},on_cell_edit_changed:{fn:this.on_cell_edit_changed,scope:this},use_single_record_navigation:true};this.cell_manager=this.new_component(SG.CellManager,cfg);},get_tabable_fields:function(){var fields=[];if(!this.is_reply)
fields.push('content');var i;for(i=0;i<this.visible_fields.length;i++)
{if(['content','tasks','attachments'].indexOf(this.visible_fields[i])===-1)
fields.push(this.visible_fields[i]);}
if(this.visible_fields.indexOf('tasks')>-1)
fields.push('tasks');return fields;},focus_create_button:function(){if(!this.create_button)return;var me=this;setTimeout(function(){me.create_button.dom.focus();});},on_before_show_more_fields_menu:function(the_menu){var items=[];var fields=this.get_fields();var i,schema_field,cant_remove;for(i=0;i<fields.length;i++)
{var schema_field=SG.schema.get_field('Note',fields[i]);cant_remove=this.visible_fields.indexOf(schema_field.name)!==-1&&['project','tasks'].indexOf(schema_field.name)!==-1;items.push({html:schema_field.display_name,field_name:schema_field.name,checked:this.visible_fields.indexOf(schema_field.name)>-1,disabled:cant_remove,});}
this.more_fields_button.addClass('active');the_menu.items=items;the_menu.render();},show_more_fields_menu:function(dom_elem){if(!this.more_fields_menu)
{this.more_fields_menu=new SG.Menu({before_show:{fn:this.on_before_show_more_fields_menu,scope:this},after_hide:{fn:function(){this.more_fields_button.removeClass('active');},scope:this},item_selected:{fn:this.on_more_fields_set,scope:this}});}
this.more_fields_menu.render();this.more_fields_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_more_fields_set:function(menu,menu_item){var field=menu_item.field_name;if(menu_item.checked)
this.hide_field(field);else
this.show_field(field);},hide_field:function(field){var index=this.visible_fields.indexOf(field);if(index<0)
return;this.visible_fields.splice(index,1);var schema_field=SG.schema.get_field('Note',field);this.save_visible_fields();if(field==='tasks'){this.tasks_button.removeClass('active');this.tasks_div.update('');this.tasks_div.removeClass('displayed');return;}else if(field==='attachments'||schema_field.data_type==='url'){this.attach_button.removeClass('active');this.attachments_div.update('');this.attachments_div.removeClass('displayed');return;}
var field_div=this.container.child('div.field[field="'+field+'"]');if(field_div)
field_div.remove();var field=this.fields_div.child('div.field');if(!field)
this.fields_div.removeClass('displayed');},show_field:function(field){this.visible_fields.push(field);this.render_field(field);this.save_visible_fields();},load_visible_fields:function(){var vis_fields=localStorage.getItem('sgc_review_app_note_form_visible_fields');this.visible_fields=vis_fields?this.filter_fields(Ext.decode(vis_fields)):[];},save_visible_fields:function(){var fields=this.filter_fields(this.visible_fields);localStorage.setItem('sgc_review_app_note_form_visible_fields',Ext.encode(fields));},filter_fields:function(fields){var filtered_fields=[];var i,field,schema_field;for(i=0;i<fields.length;i++){field=fields[i];if(['tasks','attachments','user'].indexOf(field)>-1)
continue;schema_field=SG.schema.get_field('Note',field);if(!schema_field||schema_field.data_type==='url')
continue;filtered_fields.push(field);}
var field_prefs=this.get_entity_prefs();var i;for(i=0;i<field_prefs.length;i++){pref=field_prefs[i];if(pref.type!=='more'||pref.hidden)
continue;if(filtered_fields.indexOf(pref.field)===-1)
filtered_fields.push(pref.field);}
return filtered_fields;},more_fields_disabled:function(field_schema){var supported_data_types=['checkbox','currency','date','duration','entity','float','text','number','percent','status_list','multi_entity','system_task_type','list','timecode','date_time','url'];var not_these=['tasks','attachments','content','project','created_at','user'];if(field_schema.read_only){return true;}else if(supported_data_types.indexOf(field_schema.data_type)==-1){return true;}else if(not_these.indexOf(field_schema.name)!=-1){return true;}else if(!SG.schema.can_edit_field('EntityFieldPref','settings')){var prefs=this.get_entity_prefs();var i,pref;for(i=0;i<prefs.length;i++){if(prefs[i].field===field)
pref=prefs[i];}
if(pref&&pref.mandatory_on_create)
return true;}
return false;},check_for_mandatory_inputs:function(){if(this.is_reply){if(this.textarea.dom.value.trim()||this.record.get_state()==='dirty')
return true;for(af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;ac=this.attachment_controls[af];if(ac.component.ready())
return true;}
alert('No changes to save');return false;}
var field_prefs=this.get_entity_prefs();var found_project=false;var mandatory_fields=['content'];var missing_fields=[];var i,pref,value,schema_field;for(i=0;i<field_prefs.length;i++)
{pref=field_prefs[i];if(pref.hidden||!pref.mandatory_on_create)continue;if(pref.field=='project')
found_project=true;if(mandatory_fields.indexOf(pref.field)===-1)
mandatory_fields.push(pref.field);}
if(!found_project)
mandatory_fields.push('project');var field;for(i=0;i<mandatory_fields.length;i++){field=mandatory_fields[i];value=this.record.get(field);if(value===undefined||value===null||value===''||(typeof value=='string'&&value.strip()==='')){schema_field=SG.schema.get_field('Note',field);missing_fields.push(schema_field.display_name);}}
if(missing_fields.length==0)
return true;alert('Please provide: '+missing_fields.join(', ')+'.');return false;},on_data_change:function(changes){if(!this.creating)
return;var record_id;var i,change;for(i=0;i<changes.length;i++){change=changes[i];if((this.is_reply&&change.type==='update'&&change.state==='server')||(!this.is_reply&&change.type==='create')){record_id=this.is_reply&&this.reply_id?this.reply_id:change.record.id;break;}else if(['change_failed','update_failed'].indexOf(change.type)>-1){this.fire_done_callback(null);return;}}
if(record_id)
this.upload_files(record_id);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.more_fields',this.container));if(elem){if(SG.Menu.now_showing&&SG.Menu.now_showing===this.more_fields_menu)
this.more_fields_menu.hide();else
this.show_more_fields_menu(elem);return;}
elem=target.findParent('div.extra_control.tasks',this.container);if(elem){if(this.tasks_div.hasClass('displayed'))
this.hide_field('tasks');else
this.show_field('tasks');}
elem=target.findParent('div.extra_control.attach',this.container);if(elem){if(this.visible_fields.indexOf('attachments')>-1)
this.hide_field('attachments');else
this.show_field('attachments');}
elem=target.findParent('div.extra_control.cancel',this.container);if(elem){if(this.is_reply)
this.textarea.dom.value='';if(this.cell_manager.active_editor)
this.cell_manager.active_editor.blur();var fields=this.record.get_fields();var i,schema_field,cell;for(i=0;i<fields.length;i++){this.record.revert(fields[i]);schema_field=SG.schema.get_field('Note',fields[i]);cell=this.cell_manager.get_cell(fields[i],this.get_cell_config(schema_field));if(!cell)continue;cell.update_cell(this.record,true);}
if(this.cancel_callback)
this.cancel_callback.fn.call(this.cancel_callback.scope);this.hide_fields();return;}
elem=target.findParent('div.extra_control.create',this.container);if(elem){this.submit();return;}},submit:function(){if(this.creating)
return;this.fire_busy_callback();this.creating=true;var tasks_cell=this.get_tasks_cell();tasks_cell.get_selected_tasks({fn:this.on_selected_tasks_ready,scope:this});},on_selected_tasks_ready:function(tasks){if(tasks!==null)
this.record.set('tasks',tasks);if(!this.check_for_mandatory_inputs()){this.creating=false;this.fire_cancel_callback();return;}
this.cell_manager.apply_all_edits();var wait_for_reply=false;if(this.is_reply){var value=this.textarea.dom.value.trim();this.reply_id=null;if(value){var reply_record=new SG.Data.Record('Reply');reply_record.set_owner(this);reply_record.set('entity',{type:'Note',id:this.record.get_id()});reply_record.set('content',value);reply_record.commit(true);wait_for_reply=true;}}
if(!wait_for_reply)
this.record.commit(true);},set_record:function(record){this.record=record;this.render_note_body();this.hide_fields();},reset_after_error:function(){this.creating=false;this.hide_progress_indicator();},on_create_button_keydown:function(e){var key=e.getKey();if(key==Ext.EventObject.TAB){e.stopEvent();e.getTarget().blur();if(e.shiftKey)
this.edit_last_field();else if(this.is_reply)
this.textarea.focus();else
this.edit_first_field();return;}
if(key===Ext.EventObject.ENTER){this.submit();return;}},on_textarea_keydown:function(e){var key=e.getKey();if(key==Ext.EventObject.TAB){e.stopEvent();e.getTarget().blur();if(e.shiftKey){this.create_button.focus();}else{var fields=this.get_tabable_fields();if(fields.length)
this.edit_first_field();else
this.create_button.focus();}}},edit_first_field:function(){var fields=this.get_tabable_fields();var field=fields[0];this.edit_field(field);},edit_last_field:function(){var fields=this.get_tabable_fields();var field=fields[fields.length-1];this.edit_field(field);},edit_field:function(field){var schema_field=SG.schema.get_field('Note',field);var cell=this.cell_manager.get_cell(field,this.get_cell_config(schema_field));if(cell){var me=this;setTimeout(function(){me.edit_cell(cell);});}},edit_cell:function(cell){var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="'+cell.field+'"]';var cell_elem=sg_find(sel,this.container.dom);if(!cell_elem)return;cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});},on_cell_edit:function(field,record,cell){if(field!='note_links')return;var cell=this.get_tasks_cell();cell.set_entities(this.record.get('note_links'));},on_cell_edit_changed:function(field,value){if(field!='note_links')return;this.record.set('note_links',value);var cell=this.get_tasks_cell();cell.set_entities(value);},on_record_change:function(changes){var reply_id;var i;for(i=0;i<changes.length;i++){if(changes[i].type==='create'){reply_id=changes[i].record.id;break;}else if(changes[i].type==='create_failed'){this.fire_done_callback(null);}}
if(reply_id){this.reply_id=reply_id;if(this.record.state==='dirty')
this.record.commit(true);else
this.upload_files(reply_id);}},upload_files:function(record_id){var make_upload_fn=function(ac,fv){return function(){ac.component.submit(fv);};};this.upload_queue=[];var links=[{type:'Note',id:this.record.get_id()}];var done_callback={fn:function(attachments,url_field){this.upload_done(record_id,attachments,url_field);},scope:this};var no_attach=true;var af,ac,fv,links;for(af in this.attachment_controls){if(!this.attachment_controls.hasOwnProperty(af))continue;ac=this.attachment_controls[af];if(ac.component.ready())
no_attach=false;else
continue;var fv=[{column:"attachment_links",value:links}];if(this.record.get("project"))
fv.push({column:"project",value:this.record.get("project")});ac.component.done_callback=done_callback;ac.component.error_callback=done_callback;this.upload_queue.push(make_upload_fn(ac,fv));}
if(no_attach){this.fire_done_callback(record_id);return;}
var upload_fn=this.upload_queue.shift();upload_fn.call(this);},get_tasks_cell:function(){var cell=this.cell_manager.get_cell('tasks',{type:SG.TasksMiniGridSelector});if(!cell.rendered)
cell.setup_initial_state(this.record);return cell;},fire_busy_callback:function(){if(this.busy_callback)
this.busy_callback.fn.call(this.busy_callback.scope,this);},fire_cancel_callback:function(){this.creating=false;if(this.cancel_callback)
this.cancel_callback.fn.call(this.cancel_callback.scope,this);},fire_done_callback:function(record_id){this.creating=false;if(this.is_reply)
this.textarea.dom.value='';this.render_note_body();this.render_fields();if(this.done_callback)
this.done_callback.fn.call(this.done_callback.scope,record_id,this);},show_fields:function(){if(this.note_form_div.hasClass('fields_displayed'))return;this.load_visible_fields();this.render_fields();this.note_form_div.addClass('fields_displayed');var h=this.note_fields_wrapper.getHeight();this.note_fields_wrapper.dom.style.overflow='hidden';this.note_fields_wrapper.setHeight(0);this.note_fields_wrapper.setHeight(h,{duration:0.2,easing:'easeOut',callback:function(){this.note_fields_wrapper.dom.style.overflow='visible';this.note_fields_wrapper.dom.style.height='auto';},scope:this});if(this.fields_displayed_callback)
this.fields_displayed_callback.fn.call(this.fields_displayed_callback.scope,true);},hide_fields:function(){this.textarea.blur();this.note_fields_wrapper.dom.style.overflow='hidden';this.note_fields_wrapper.setHeight(0,{duration:0.2,easing:'easeIn',callback:function(){this.note_fields_wrapper.dom.style.overflow='visible';this.note_fields_wrapper.dom.style.height='auto';this.note_form_div.removeClass('fields_displayed');this.hide_field('tasks');this.hide_field('attachments');this.fields_div.update('');this.fields_div.removeClass('displayed');if(this.fields_displayed_callback)
this.fields_displayed_callback.fn.call(this.fields_displayed_callback.scope,false);},scope:this});}});SG.ReviewAppNote=function(config){Ext.apply(this,config);SG.ReviewAppNote.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNote,SG.Component,{templates:{main:'<div class="sgc_review_app_note" record_id="{record_id}">{entry_body}</div>',entry_body:'<div class="entry">'+'<div class="user_thumbnail" user_type="{user_type}" user_id="{user_id}">{img}</div>'+'<div class="thumb_padding"></div>'+'<div class="note_wrapper">'+'<div class="user_name_and_date">'+'<span class="prefix">{prefix}</span>'+'<span class="user_name" user_type="{user_type}" user_id="{user_id}">{user_name}</span>'+'<span class="date">{created_at}</span>'+'</div>'+'<div class="description">{description}</div>'+'{attachments}'+'{replies}'+'</div>'+'</div>',date:'&nbsp;&bull;&nbsp;{created_at}',reply_entry:'<div class="reply" record_id="{record_id}">{entry_body}</div>',replies:'<div class="reply_wrapper no_replies">'+'<div class="triangle">'+'<div class="triangle_img comment_triangle_vertical"></div>'+'</div>'+'<div class="reply_box">'+'<div class="reply_count"></div>'+'<div class="replies"></div>'+'<div class="new_reply"></div>'+'</div>'+'</div>',attachments:'<div class="attachments">'+'<div class="annot_attachments"></div>'+'<div class="non_annot_attachments"></div>'+'</div>',user_thumb:'<img class="thumbnail" src="/thumbnail/image/{value}" onError="sg_missing_user_thumb(this);"/>',default_user_thumb:'<img class="thumbnail" src="/images/default_user_thumb.png">',annot_attachments:'The following frames were annotated with this {entity_type}:'+'<div class="annotated_frames"></div>',non_annot_attachments:'<div class="image_attachments"></div>'+'<div class="other_attachments"></div>',annot_frame_wrapper:'<div class="attachment_content annotated_frame" record_id="{record_id}" frame="{frame}">{thumb}<span>Frame {frame}</span></div>',image_attachment:'<div class="attachment_content image" record_id="{record_id}" sg_tip="Click to View in External Browser">'+'<a href="{image_path}"><img src="/thumbnail/image/{thumb}" onError="sg_missing_image(this)"/></a>'+'</div>',other_attachment:'<div class="attachment_content" record_id="{record_id}">{file_link}&nbsp;<span class="attachment_size">{size}</span></div>',upload_progress:'<table class="upload_progress">'+'<tr>'+'<td rowspan="2" class="progress_indicator"><img src="{progress_icon}"/></td>'+'<td class="upload_progress">Uploading annotated frames...</td>'+'</tr>'+'<tr>'+'<td><div class="note_upload_progress_bar"></div></td>'+'</tr>'+'</table>',upload_error:'<div class="upload_error">Upload Error: {error}</div>',progress_gradient:'-webkit-gradient(linear, {progress_start}% top, {progress_end}% top'+', from(rgba(114, 214, 251, 1.0)), to(rgba(114, 214, 251, 0)))'},init_component:function(){this.reply_order=[];this.fake_reply_ids=[];this.replies={};this.attachment_order=[];this.attachments={};this.reply_count=0;this.replies_loaded=false;},render:function(){var entry_cfg={created_at:this.templates.date.apply({created_at:SG.Renderers.social_date_time.render(this.record.get('created_at'))}),description:SG.Markup.parse(this.record.get('content')),attachments:this.templates.attachments.apply(),replies:this.templates.replies.apply()}
var user=this.record.get('user');if(user){var value=this.record.get('user.'+user.type+'.image');var image;if(value)
image=this.templates.user_thumb.apply({value:value});else
image=this.templates.default_user_thumb.apply();entry_cfg.img=image;entry_cfg.user_type=user.type;entry_cfg.user_id=user.id;entry_cfg.user_name=user.name;}else{entry_cfg.user_name='<i>Unknown</i>';entry_cfg.img=this.templates.default_user_thumb.apply();}
this.container.update(this.templates.main.apply({record_id:this.record.get_id(),entry_body:this.templates.entry_body.apply(entry_cfg)}));this.main_div=this.container.child('div.sgc_review_app_note');this.new_reply_div=this.container.child('div.new_reply');var note_id=this.record.get_id();this.reply_component=this.new_component(SG.ReviewAppNoteForm,{container:this.new_reply_div,edit_container:this.edit_container,is_reply:true,all_projects:this.projects,data_set:this.data_set,entity:{type:'Note',id:note_id},record:this.record,get_fields_callback:this.get_fields_callback,fields_displayed_callback:{fn:function(state){var replies_div=this.container.child('div.reply_wrapper');var triangle_img_div=replies_div.child('div.triangle_img');var no_replies=replies_div.hasClass('no_replies');if(state){replies_div.addClass('fields_displayed');if(no_replies)
triangle_img_div.replaceClass('comment_triangle_vertical','comment_triangle_vertical_white');}else{replies_div.removeClass('fields_displayed');if(triangle_img_div.hasClass('comment_triangle_vertical_white'))
triangle_img_div.replaceClass('comment_triangle_vertical_white','comment_triangle_vertical');}},scope:this},busy_callback:{fn:function(){this.upload_start_time=new Date();if(this.note_manager.busy_callback)
this.note_manager.busy_callback.fn.call(this.note_manager.busy_callback.scope);},scope:this},done_callback:{fn:this.on_reply_created,scope:this},cancel_callback:this.note_manager.cancel_callback});this.reply_component.render();this.add_event(this.container,'click',this.on_click);},render_replies_and_attachments:function(reply_ids,attachment_ids){if(this.attachment_order.length>0)
this.render_attachments(this.container,attachment_ids,this.attachment_order,this.attachments);var reply_wrapper_div=this.container.child('div.reply_wrapper');if(this.replies_loaded)
reply_wrapper_div.addClass('replies_loaded');else
reply_wrapper_div.removeClass('replies_loaded');if(this.reply_count===0){reply_wrapper_div.addClass('no_replies');}else{reply_wrapper_div.removeClass('no_replies');var triangle_img_div=reply_wrapper_div.child('div.triangle_img');if(triangle_img_div.hasClass('comment_triangle_vertical_white'))
triangle_img_div.replaceClass('comment_triangle_vertical_white','comment_triangle_vertical');}
var replies_div=reply_wrapper_div.child('div.replies');var i,reply_id,reply_hash,reply_div,previous_id,previous_div,user,value,image,html;for(i=0;i<this.reply_order.length;i++){reply_id=this.reply_order[i];if(reply_ids&&reply_ids.indexOf(reply_id)<0)
continue;reply_hash=this.replies[reply_id];reply_div=this.container.child('div.reply[record_id='+reply_id+']');user=reply_hash.user;if(user&&reply_hash.user_thumb)
image=this.templates.user_thumb.apply({value:reply_hash.user_thumb});else
image=this.templates.default_user_thumb.apply();if(!reply_div){previous_id=i<1?null:this.reply_order[i-1];html=this.templates.reply_entry.apply({record_id:reply_id,entry_body:this.templates.entry_body.apply({user_type:user&&user.type,user_id:user&&user.id,img:image,user_name:user&&user.name,created_at:this.templates.date.apply({created_at:SG.Renderers.social_date_time.render(reply_hash.date)}),description:SG.Markup.parse(reply_hash.description),attachments:this.templates.attachments.apply()})});if(previous_id){previous_div=this.container.child('div.reply[record_id='+previous_id+']');reply_div=Ext.DomHelper.insertAfter(previous_div,html,true);}else{reply_div=Ext.DomHelper.insertFirst(replies_div,html,true);}}
if(reply_hash.attachment_order.length>0)
this.render_attachments(reply_div,attachment_ids,reply_hash.attachment_order,reply_hash.attachments);}},render_attachments:function(container,attachment_ids,attachment_order,attachment_hash){var schema_field=SG.schema.get_field('Attachment','this_file');var size_r=SG.Renderers.file_size;var url_r=SG.Renderers.url;var me=this;var annotation_sort_fn=function(a,b){var a_frame=me.get_annotation_frame(attachment_hash[a].record);var b_frame=me.get_annotation_frame(attachment_hash[b].record);if(a_frame<b_frame)
return-1;if(a_frame>b_frame)
return 1;return 0;};var image_attachments=[];var annot_attachments=[];var other_attachments=[];var i,attach_id,rec;for(i=0;i<attachment_order.length;i++){attach_id=attachment_order[i];if(attachment_ids&&attachment_ids.indexOf(attach_id)<0)
continue;rec=attachment_hash[attach_id].record;file_name=rec.get('filename');is_valid_image=file_name&&file_name.match(/.*\.((png)|(jpg)|(gif))$/);is_annotation=file_name&&file_name.match(/annot_.*\.\d+\.(jpg|png)/);if(rec.get('image')&&is_annotation)
annot_attachments.push(attach_id);else if(rec.get('image')&&is_valid_image)
image_attachments.push(attach_id);else
other_attachments.push(attach_id);}
var j,html;var frame_divs=container.query('div.annotated_frame');var annot_div=container.child('div.annotated_frames');var attach_id;if(annot_attachments.length){annot_attachments.sort(annotation_sort_fn);if(!annot_div){html=this.templates.annot_attachments.apply({entity_type:container.hasClass('reply')?'Reply':'Note'});var attach_container=container.child('div.annot_attachments');Ext.DomHelper.insertFirst(attach_container,html,true);annot_div=attach_container.child('div.annotated_frames');}
var j,frame_div,next_frame_div,image_html;for(i=0;i<annot_attachments.length;i++){attach_id=annot_attachments[i];if(annot_div.child('div.attachment_content[record_id='+attach_id+']'))
continue;rec=attachment_hash[attach_id].record;frame_num=this.get_annotation_frame(rec);next_frame_div=null;for(j=0;j<frame_divs.length;j++){if(Number(frame_divs[j].getAttribute('frame'))>frame_num)
next_frame_div=Ext.get(frame_divs[j]);}
image_html=this.templates.image_attachment.apply({record_id:rec.id,thumb:rec.get('image'),image_path:rec.get('this_file').url});html=this.templates.annot_frame_wrapper.apply({record_id:rec.id,thumb:image_html,frame:frame_num});if(next_frame_div){Ext.DomHelper.insertBefore(next_frame_div,html);continue;}
Ext.DomHelper.append(annot_div,html);}}
var image_div=container.child('div.image_attachments');var other_div=container.child('div.other_attachments');var non_annot_div=container.child('div.non_annot_attachments');if(image_attachments.length||other_attachments.length){if(!image_div&&!other_div){Ext.DomHelper.append(non_annot_div,this.templates.non_annot_attachments.apply());image_div=non_annot_div.child('div.image_attachments');other_div=non_annot_div.child('div.other_attachments');}
if(!frame_divs.length&&annot_attachments.length)
Ext.DomHelper.insertFirst(non_annot_div,'<span>Other Attachments:</span>');}
var index,previous_div,id;for(i=0;i<image_attachments.length;i++){attach_id=image_attachments[i];if(image_div.child('div.attachment_content[record_id='+attach_id+']'))
continue;index=attachment_order.indexOf(attach_id);previous_div=null;for(j=0;j<index;j++){id=attachment_order[j];previous_div=image_div.child('div.attachment_content[record_id='+id+']');}
rec=attachment_hash[attach_id].record;html=this.templates.image_attachment.apply({record_id:rec.id,thumb:rec.get('image'),image_path:rec.get('this_file').url});if(previous_div){Ext.DomHelper.insertAfter(previous_div,html);continue;}
Ext.DomHelper.insertFirst(image_div,html);}
for(i=0;i<other_attachments.length;i++){attach_id=other_attachments[i];if(other_div.child('div.attachment_content[record_id='+attach_id+']'))
continue;index=attachment_order.indexOf(attach_id);previous_div=null;for(j=0;j<index;j++){id=attachment_order[j];previous_div=other_div.child('div.attachment_content[record_id='+id+']');}
rec=attachment_hash[attach_id].record;html=this.templates.other_attachment.apply({record_id:rec.id,file_link:url_r.render_nbsp(rec.get('this_file'),schema_field),size:size_r.render_nbsp(rec.get('file_size'))});if(previous_div){Ext.DomHelper.insertAfter(previous_div,html);continue;}
Ext.DomHelper.insertFirst(other_div,html);}},fetch_more_replies:function(after_load_callback){var reply_data_set=this.new_data_set('Reply',function(){this.note_manager.fetch_reply_attachments(reply_data_set,[this.get_note_id()],after_load_callback);});var before_reply_id=this.reply_order[0];var reply_spec={type:'Reply',columns:['content','user','user.HumanUser.image','user.ApiUser.image','created_at'],filters:{logical_operator:'and',conditions:[{path:'id',relation:'less_than',values:[before_reply_id]},{path:'entity.Note.id',relation:'is',values:[this.get_note_id()]},]},sorts:[{column:'created_at',direction:'asc'}],grouping:[{column:'entity'}],result:reply_data_set};SG.Repo.query(reply_spec);},fetch_replies_and_attachments:function(reply_ids,since_time,after_load_callback){var note_id=this.get_note_id();var reply_data_set=this.new_data_set('Reply');var attach_data_set=this.new_data_set('Attachment');var after_load_fn=function(){if(!reply_data_set.is_loaded()||!attach_data_set.is_loaded())return;this.note_manager.on_replies_and_attachments_load(reply_data_set,attach_data_set,[note_id],after_load_callback);};reply_data_set.on('load',after_load_fn,this);attach_data_set.on('load',after_load_fn,this);var reply_spec={type:'Reply',columns:['content','user','user.HumanUser.image','user.ApiUser.image','created_at'],sorts:[{column:'created_at',direction:'asc'}],grouping:[{column:'entity'}],result:reply_data_set};SG.Repo.start_batch();if(!reply_ids){reply_spec.filters={logical_operator:'and',conditions:[{path:'entity.Note.id',relation:'in',values:[note_id]}]};SG.Repo.query(reply_spec);}else{reply_spec.ids=reply_ids;SG.Repo.find(reply_spec);}
var attachment_columns=SG.schema.entity_types.Attachment.fields_sorted_by_display_name;if(attachment_columns.indexOf('file_size')<0)
attachment_columns.push('file_size');if(attachment_columns.indexOf('image')<0)
attachment_columns.push('image');var thumb_cols=['created_by.HumanUser.image','created_by.ApiUser.image'];attachment_columns=attachment_columns.concat(thumb_cols);var attachment_spec={type:'Attachment',columns:attachment_columns,filters:{logical_operator:'and',conditions:[{path:'attachment_links.Note.id',relation:'in',values:[note_id]}]},grouping:[{column:'attachment_links'}],sorts:[{column:'created_at',direction:'asc'}],result:attach_data_set};if(since_time)
attachment_spec.filters.conditions.push({path:'created_at',relation:'greater_than',values:[SG.GridEditor.DateTimeParser.data_store_format(since_time)]});SG.Repo.query(attachment_spec);SG.Repo.end_batch();},on_reply_created:function(reply_id){var callback={fn:function(){this.reply_component.hide_fields();this.upload_annotated_frames(reply_id);if(this.note_manager.done_callback)
this.note_manager.done_callback.fn.call(this.note_manager.done_callback.scope);},scope:this};var since_time=this.upload_start_time;this.upload_start_time=null;this.reply_count++;var reply_ids;if(reply_id)
reply_ids=[reply_id];this.fetch_replies_and_attachments(reply_ids,since_time,callback);},on_annotation_upload_progress:function(complete_ratio){var progress_div=this.container.child('div.note_upload_progress_bar');if(!progress_div)return;var progress_start=Math.round(complete_ratio*100);var progress_end=progress_start+1;progress_div.setStyle('backgroundImage',this.templates.progress_gradient.apply({progress_start:progress_start,progress_end:progress_end}));},on_annotation_upload_complete:function(){var table=this.container.child('table.upload_progress');if(table)
table.remove();this.note_manager.fetch_note_attachments([this.get_note_id()],this.upload_start_time);},on_annotation_upload_error:function(error){var table=this.container.child('table.upload_progress');if(!table)return;var attachments_div=Ext.get(table.findParent('div.attachments',this.container));if(!attachments_div)return;table.remove();Ext.DomHelper.insertFirst(attachments_div,this.templates.upload_error({error:error_message}));},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('span.reply',this.container));if(elem){var new_reply_div=Ext.get(elem.findParent('div.new_reply'));new_reply_div.update('');return;}
elem=target.findParent('span.user_name',this.container);if(!elem){elem=target.findParent('img.thumbnail',this.container);if(elem)
elem=Ext.fly(elem).findParent('div.user_thumbnail',this.container);}
if(elem){var type=elem.getAttribute('user_type');var id=elem.getAttribute('user_id');if(!type||!id)
return;var url=window.location.protocol+'//'+window.location.host+'/detail/'+type+'/'+id;if(SG.globals.review_app_player)
SG.globals.review_app_player.open_external_browser(url);else
window.open(url);return;}
elem=Ext.get(target.findParent('div.reply_count'));if(elem){if(this.note_manager.busy_callback)
this.note_manager.busy_callback.fn.call(this.note_manager.busy_callback.scope);this.fetch_more_replies(this.note_manager.done_callback);return;}},process_replies:function(data_set){var reply_ids=[];var i,j,group,note_id,ids,reply_id,user,rec;for(i=0;i<data_set.groups.length;i++){group=data_set.groups[i];note_id=group.template_values[0].id;if(note_id!==this.get_note_id())continue;for(j=0;j<group.ids.length;j++){reply_id=group.ids[j];if(this.reply_order.indexOf(reply_id)>-1)
continue;this.reply_order.push(reply_id);rec=data_set.get_record_by_id(reply_id);user=rec.get('user');this.replies[reply_id]={record:rec,user:user,user_thumb:user&&rec.get('user.'+user.type+'.image'),date:rec.get('created_at'),description:rec.get('content'),data_set:data_set,attachment_order:[],attachments:{}};reply_ids.push(reply_id);}
this.reply_order.sort();if(this.reply_order.length>=this.reply_count)
this.replies_loaded=true;}
return reply_ids;},process_reply_summaries:function(data_set){var summary_found=false;var i,summary;for(i=0;i<data_set.group_summaries.length;i++){summary=data_set.group_summaries[i];if(summary.template_values[0].id===this.get_note_id()){summary_found=true;break;}}
if(!summary_found){this.reply_count=0;this.replies_loaded=true;return false;}
var count=Number(summary.summaries[0].value);this.reply_count=count;if(count>2){reply_wrapper_div=this.container.child('div.reply_wrapper');reply_wrapper_div.removeClass('no_replies');reply_count_div=reply_wrapper_div.child('div.reply_count');reply_count_div.update('View all '+count+' Replies');}
return true;},process_attachments:function(data_set,reply_ids){if(!data_set)return[];var attachment_ids=[];var i,j,k,l,notes,note_id,reply_id,rec,attach_id,note_rec,user,user_id,date;var reply_id,reply_rec,reply_found,reply_hash,fake_reply,previous_reply_id;for(i=0;i<data_set.groups.length;i++){notes=data_set.groups[i].template_values[0];for(j=0;j<notes.length;j++){note_id=notes[j].id;if(note_id!==this.get_note_id())
continue;for(k=0;k<data_set.groups[i].ids.length;k++){attach_id=data_set.groups[i].ids[k];rec=data_set.get_record_by_id(attach_id);reply_found=false;var num_replies=this.reply_order.length;for(l=num_replies-1;l>=0;l--){reply_id=this.reply_order[l];if(this.fake_reply_ids.indexOf(reply_id)>-1)
continue;reply_rec=this.replies[reply_id].record;user_id=reply_rec.get('user')&&reply_rec.get('user').id;date=Date.sgParseDateTime(reply_rec.get('created_at'));if(this.attachment_is_in_group(rec,user_id,date)){if(this.replies[reply_id].attachment_order.indexOf(attach_id)>-1){reply_found=true;break;}
this.replies[reply_id].attachment_order.push(attach_id);this.replies[reply_id].attachments[attach_id]={record:rec,data_set:data_set}
attachment_ids.push(attach_id);if(reply_ids.indexOf(reply_id)<0)
reply_ids.push(reply_id);reply_found=true;break;}}
if(!reply_found){user_id=this.record.get('user')&&this.record.get('user').id;date=Date.sgParseDateTime(this.record.get('created_at'));if(this.attachment_is_in_group(rec,user_id,date)){if(this.attachment_order.indexOf(attach_id)>-1)
continue;this.attachment_order.push(attach_id);this.attachments[attach_id]={record:rec,data_set:data_set}
attachment_ids.push(attach_id);continue;}}
if(reply_found)
continue;reply_found=false;for(l=0;l<this.fake_reply_ids.length;l++){reply_id=this.fake_reply_ids[l];reply_hash=this.replies[reply_id];date=Date.sgParseDateTime(reply_hash.date);if(this.attachment_is_in_group(rec,reply_hash.user.id,date)){if(this.replies[reply_id].attachment_order.indexOf(attach_id)>-1)
continue;this.replies[reply_id].attachment_order.push(attach_id);this.replies[reply_id].attachments[attach_id]={record:rec,data_set:data_set};attachment_ids.push(attach_id);if(reply_ids.indexOf(reply_id)<0)
reply_ids.push(reply_id);reply_found=true;break;}}
if(reply_found)
continue;date=Date.sgParseDateTime(rec.get('created_at'));user=rec.get('created_by');reply_id=note_id+'_'+date.getTime();reply_hash={user:user,user_thumb:user&&rec.get('created_by.'+user.type+'.image'),date:rec.get('created_at'),description:'',attachment_order:[attach_id],attachments:{}};reply_hash.attachments[attach_id]={record:rec,data_set:data_set};for(l=0;l<this.reply_order.length;l++){previous_reply_id=this.reply_order[l];if(date<Date.sgParseDateTime(this.replies[previous_reply_id].date))
break;}
this.fake_reply_ids.push(reply_id);this.reply_order.splice(l,0,reply_id);this.replies[reply_id]=reply_hash;attachment_ids.push(attach_id);if(reply_ids.indexOf(reply_id)<0)
reply_ids.push(reply_id);}}}
return attachment_ids;},update_time_stamp:function(){var now=new Date();created_at=this.record.get('created_at');var date_span=this.container.child('span.date');if(date_span)
date_span.update(this.templates.date.apply({created_at:SG.Renderers.social_date_time.render(created_at)}));for(i=0;i<this.reply_order.length;i++){reply_id=this.reply_order[i];reply_hash=this.replies[reply_id];if(!reply_hash)continue;created_at=reply_hash.date||reply_hash.record.get('created_at');reply_div=this.container.child('div.reply[record_id='+reply_id+']');if(!reply_div)continue;date_span=reply_div.child('span.date');if(!date_span)continue;date_span.update(this.templates.date.apply({created_at:SG.Renderers.social_date_time.render(created_at)}));}},upload_annotated_frames:function(reply_id){this.has_annotated_frames=SG.globals.review_app_player&&SG.globals.review_app_player.has_annotated_frames();if(this.has_annotated_frames){var selector,record_div;if(reply_id)
record_div=this.container.child('div.reply[record_id='+reply_id+']');else
record_div=this.container;var html=this.templates.upload_progress.apply({progress_icon:SG.globals.icons.IndicatorLargeTransparent});var attachments_div=record_div.child('div.attachments');Ext.DomHelper.insertFirst(attachments_div,html);this.upload_start_time=new Date();SG.globals.review_app_player.upload_annotated_frames_to_note(this.get_note_id());}},attachment_is_in_group:function(attach_record,user_id,date){if(user_id!==attach_record.get('created_by').id)
return false;var attach_date=Date.sgParseDateTime(attach_record.get('created_at'));return(date<=attach_date&&attach_date-date<60*1000);},get_note_id:function(){return this.record.get_id();},get_user:function(){return this.record.get('user');},get_reply_users:function(){var user_map={};var users=[];var i,reply,key;for(i=0;i<this.reply_order.length;i++){reply=this.replies[this.reply_order[i]];if(!reply||!reply.user)continue;key=reply.user.type+' '+reply.user.id;if(!user_map.hasOwnProperty(key)){users.push(reply.user);user_map[key]=true;}}
return users;},get_annotation_frame:function(record){var file_name=record.get('filename');return Number(file_name.match(/(\d+)\.(jpg|png)/)[1]);}});SG.ReviewAppNoteManager=function(config){Ext.apply(this,config);SG.ReviewAppNoteManager.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNoteManager,SG.Component,{init_component:function(){this.note_components={};if(SG.globals.review_app_player){this.add_event(SG.globals.review_app_player,'note_upload_complete',this.on_annotation_upload_complete);this.add_event(SG.globals.review_app_player,'note_upload_error',this.on_annotation_upload_error);this.add_event(SG.globals.review_app_player,'note_upload_progress',this.on_annotation_upload_progress);}},destroy_component:function(){var note_id;for(note_id in this.note_components)
if(this.note_components.hasOwnProperty(note_id))
this.remove_note_components_by_id(note_id);},create_note_component:function(parent,cfg){var note_comp=parent.new_component(SG.ReviewAppNote,cfg);note_comp.note_manager=this;var note_id=note_comp.get_note_id();if(!this.note_components[note_id])
this.note_components[note_id]=[];this.note_components[note_id].push(note_comp);return note_comp;},remove_note_components_by_id:function(parent,note_id){if(!this.note_components[note_id])return;var i,component;for(i=0;i<this.note_components[note_id].length;i++){component=this.note_components[note_id][i];idx=parent.__subcomponents__.indexOf(component);if(idx>-1)
parent.__subcomponents__.splice(idx,1);component.destroy();}
delete this.note_components[note_id];},start_note_creation:function(){return;},end_note_creation:function(after_load_callback){this.fetch_note_attachments(this.get_note_ids());this.fetch_reply_counts(this.get_note_ids(),after_load_callback);},fetch_note_attachments:function(note_ids,since_time,after_load_callback){if(!note_ids.length){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);return;}
var attach_data_set=this.new_data_set('Attachment');var after_load_fn=function(){this.on_replies_and_attachments_load(null,attach_data_set,note_ids,after_load_callback);};attach_data_set.on('load',after_load_fn,this);var attachment_columns=SG.schema.entity_types.Attachment.fields_sorted_by_display_name;if(attachment_columns.indexOf('file_size')<0)
attachment_columns.push('file_size');if(attachment_columns.indexOf('image')<0)
attachment_columns.push('image');var thumb_cols=['created_by.HumanUser.image','created_by.ApiUser.image'];attachment_columns=attachment_columns.concat(thumb_cols);var attachment_spec={type:'Attachment',columns:attachment_columns,grouping:[{column:'attachment_links'}],filters:{logical_operator:'or',conditions:[]},sorts:[{column:'created_at',direction:'asc'}],result:attach_data_set};var i,note_id,note_comps,note_comp,creation_date,note_reply_end_date,db_date,user;for(i=0;i<note_ids.length;i++){note_id=note_ids[i];note_comps=this.note_components[note_id];note_comp=note_comps&&note_comps.length&&note_comps[0];if(!note_comp)continue;creation_date=Date.sgParseDateTime(note_comp.record.get('created_at'));note_reply_end_date=new Date(creation_date.getTime()+60*1000);db_date=SG.GridEditor.DateTimeParser.data_store_format(note_reply_end_date);user=note_comp.record.get('user');attachment_spec.filters.conditions.push({logical_operator:'and',conditions:[{path:'attachment_links.Note.id',relation:'is',values:[note_id]},{path:'created_at',relation:'less_than',values:[db_date]}]});}
if(since_time)
attachment_spec.filters.conditions.push({path:'created_at',relation:'greater_than',values:[SG.GridEditor.DateTimeParser.data_store_format(since_time)]});SG.Repo.query(attachment_spec);},fetch_reply_counts:function(note_ids,after_load_callback){var data_set=this.new_data_set('Reply');var callback=function(){this.on_reply_counts_load(data_set,note_ids,after_load_callback);};data_set.on('load',callback,this);var spec={type:'Reply',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'entity.Note.id',relation:'in',values:note_ids}]},grouping:[{column:'entity'}],summaries:[{column:'id',type:'count'}],result:data_set,result_key:'group_summaries'};SG.Repo.summarize(spec);},fetch_latest_replies:function(note_ids,after_load_callback){var reply_data_set=this.new_data_set('Reply',function(){this.on_latest_replies_load(reply_data_set,note_ids,after_load_callback);});var reply_spec={type:'Reply',columns:['content','user','user.HumanUser.image','user.ApiUser.image','created_at'],server_side_filters:'revolver_latest_replies',server_side_filters_params:{note_ids:note_ids,note_limit:2},sorts:[{column:'created_at',direction:'asc'}],grouping:[{column:'entity'}],result:reply_data_set};SG.Repo.query(reply_spec);},fetch_reply_attachments:function(reply_data_set,note_ids,after_load_callback){var attach_data_set=this.new_data_set('Attachment',function(){this.on_replies_and_attachments_load(reply_data_set,attach_data_set,note_ids,after_load_callback);});var attachment_columns=SG.schema.entity_types.Attachment.fields_sorted_by_display_name;if(attachment_columns.indexOf('file_size')<0)
attachment_columns.push('file_size');if(attachment_columns.indexOf('image')<0)
attachment_columns.push('image');var thumb_cols=['created_by.HumanUser.image','created_by.ApiUser.image'];attachment_columns=attachment_columns.concat(thumb_cols);var attachment_spec={type:'Attachment',columns:attachment_columns,grouping:[{column:'attachment_links'}],filters:{logical_operator:'or',conditions:[]},sorts:[{column:'created_at',direction:'asc'}],result:attach_data_set};var i,j,note_id,note_found,group,note_comps,note_comp,filters,record,creation_date;var attach_start_date,db_date,ids,last_id;for(i=0;i<note_ids.length;i++){note_id=note_ids[i];note_found=false;for(j=0;j<reply_data_set.groups.length;j++){group=reply_data_set.groups[j];if(note_id===group.template_values[0].id){note_found=true;break;}}
if(!note_found)continue;note_comps=this.note_components[note_id];note_comp=note_comps&&note_comps.length&&note_comps[0];if(!note_comp)continue;filters={logical_operator:'and',conditions:[{path:'attachment_links.Note.id',relation:'is',values:[note_id]}]};if(note_comp.replies.length+group.ids.length===note_comp.reply_count){record=note_comp.record;creation_date=Date.sgParseDateTime(record.get('created_at'));attach_start_date=new Date(creation_date.getTime());}else{record=reply_data_set.get_record_by_id(group.ids[0]);attach_start_date=Date.sgParseDateTime(record.get('created_at'));}
db_date=SG.GridEditor.DateTimeParser.data_store_format(attach_start_date);filters.conditions.push({path:'created_at',relation:'greater_than',values:[db_date]});attachment_spec.filters.conditions.push(filters);}
SG.Repo.query(attachment_spec);},on_replies_and_attachments_load:function(reply_data_set,attach_data_set,note_ids,after_load_callback){var i,j,note_comps,note_comp,reply_ids,attach_ids,users;for(i=0;i<note_ids.length;i++){note_comps=this.note_components[note_ids[i]];if(!note_comps)continue;for(j=0;j<note_comps.length;j++){note_comp=note_comps[j];reply_ids=null;attach_ids=null;reply_ids=[];if(reply_data_set)
reply_ids=note_comp.process_replies(reply_data_set);if(attach_data_set)
attach_ids=note_comp.process_attachments(attach_data_set,reply_ids);if(reply_ids||attach_ids)
note_comp.render_replies_and_attachments(reply_ids,attach_ids);}}
if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},on_reply_counts_load:function(data_set,note_ids,after_load_callback){var reply_note_ids=[];var i,j,k,note_id,note_comps,note_comp,append_note_id;for(i=0;i<note_ids.length;i++){note_comps=this.note_components[note_ids[i]];if(!note_comps)continue;for(j=0;j<note_comps.length;j++){note_comp=note_comps[j];append_note_id=note_comps[j].process_reply_summaries(data_set);if(append_note_id&&reply_note_ids.indexOf(note_ids[i])<0)
reply_note_ids.push(note_ids[i]);}}
if(reply_note_ids.length){this.fetch_latest_replies(reply_note_ids,after_load_callback);return;}
if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},on_latest_replies_load:function(data_set,note_ids,after_load_callback){if(data_set.count()===0){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);return;}
this.fetch_reply_attachments(data_set,note_ids,after_load_callback);},on_annotation_upload_progress:function(note_id,complete_ratio){var note_comps=this.note_components[note_id];if(!note_comps)return;var i;for(i=0;i<note_comps.length;i++)
note_comps[i].on_annotation_upload_progress(complete_ratio);},on_annotation_upload_complete:function(note_id){var note_comps=this.note_components[note_id];if(!note_comps)return;var i;for(i=0;i<note_comps.length;i++)
note_comps[i].on_annotation_upload_complete();if(this.done_callback)
this.done_callback.fn.call(this.done_callback.scope);},on_annotation_upload_error:function(note_id,error){var note_comps=this.note_components[note_id];if(!note_comps)return;var i;for(i=0;i<note_comps.length;i++)
note_comps[i].update_upload_error(error);if(this.done_callback)
this.done_callback.fn.call(this.done_callback.scope);},start_time_stamp_updates:function(){this.end_time_stamp_updates();var me=this;this.interval_id=setInterval(function(){me.update_time_stamps();},60*1000);},update_time_stamps:function(){var note_id,i,note_comp;for(note_id in this.note_components)
if(this.note_components.hasOwnProperty(note_id))
for(i=0;i<this.note_components[note_id].length;i++)
this.note_components[note_id][i].update_time_stamp();},end_time_stamp_updates:function(){if(this.interval_id)
clearInterval(this.interval_id);},get_note_ids:function(){var note_ids=[];var note_id;for(note_id in this.note_components)
if(this.note_components.hasOwnProperty(note_id))
note_ids.push(Number(note_id));return note_ids;},get_note_components_for_id:function(note_id){var note_comps=this.note_components[note_id];return note_comps?note_comps:[];}});SG.ReviewAppNotes=function(config){Ext.apply(this,config);SG.ReviewAppNotes.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNotes,SG.ReviewAppToolComponent,{templates:{main:'<div class="sgc_review_app_notes"></div>',menu_bar:'<div class="sgc_review_app_notes_top_pane">'+'<div class="bold_title">Notes</div>'+'<div class="spacer"></div>'+'{annotation_mode_toggle}'+'{mode_switch}'+'</div>',mode_switch:'<div class="notes_mode_switch">'+'<div class="sgw_review_app_switch feed_view {feed_active}" sg_tip="Feed"></div>'+'<div class="sgw_review_app_switch search_view {search_active}" sg_tip="Search"></div>'+'</div>',annotation_mode_toggle:'<div class="annotation_button sgw_review_app_icon_button"><div class="nib"></div></div>'},init_component:function(){this.disable_related_notes_feature=true;this.mode='feed';if(!this.disable_related_notes_feature)
this.mode=localStorage.getItem('sgc_review_app_notes_mode')||'feed';this.set_tool_context(this.initial_context);this.user_thumb_map={};},on_first_render:function(){this.render_menu_bar();this.container.update(this.templates.main.apply());this.main_div=this.container.child('div.sgc_review_app_notes');this.render_current_mode();},render_current_mode:function(){var view=this.get_current_view();if(!view)return;this.main_div.update('');view.container=Ext.DomHelper.append(this.main_div,{tag:'div',cls:this.mode+'_view'},true);var context=this.get_context();if(!SG.ReviewApp.Utils.contexts_match(view.get_context(),context))
view.set_context(context,this.version_record);view.render();view.restore_state();},get_current_view:function(){if(!this.main_div)return null;if(this.mode==='feed'){if(!this.feed_view)
this.feed_view=this.new_component(SG.ReviewAppNotesFeedView,{container:this.main_div,disable_related_notes_feature:this.disable_related_notes_feature});return this.feed_view;}
if(!this.search_view)
this.search_view=this.new_component(SG.ReviewAppNotesSearchView,{container:this.main_div});return this.search_view;},render_menu_bar:function(){var can_toggle_ann_mode=SG.globals.review_app_player&&SG.globals.review_app_player.can_toggle_annotation_mode();var ann_mode_button=can_toggle_ann_mode?this.templates.annotation_mode_toggle.apply():'';var mode_switch=null;if(!this.disable_related_notes_feature)
mode_switch=this.templates.mode_switch.apply({feed_active:this.mode==='feed'?'active':'',search_active:this.mode!=='feed'?'active':''});this.menu_bar_container.update(this.templates.menu_bar.apply({annotation_mode_toggle:ann_mode_button,mode_switch:mode_switch}));this.top_pane_div=this.menu_bar_container.child('div.sgc_review_app_notes_top_pane');this.add_event(this.top_pane_div,'click',this.on_menu_click);},on_menu_click:function(e){var target=Ext.get(e.getTarget());var elem=target.findParent('div.annotation_button',this.top_pane_div);if(elem&&SG.globals.review_app_player){SG.globals.review_app_player.toggle_annotation_mode();return;}
elem=Ext.get(target.findParent('div.search_view',this.top_pane_div));if(elem&&!elem.hasClass('active')){this.set_mode('search');return;}
elem=Ext.get(target.findParent('div.feed_view',this.top_pane_div));if(elem&&!elem.hasClass('active')){this.set_mode('feed');return;}},accepts_context:function(context){if(context.length===1&&context[0].type==='Version')
return true;return false;},set_mode:function(mode){var old_view=this.get_current_view();old_view.save_state();this.mode=mode;localStorage.setItem('sgc_review_app_notes_mode',mode);var feed_view_switch=this.top_pane_div.child('div.feed_view');var search_view_switch=this.top_pane_div.child('div.search_view');if(mode==='feed'){feed_view_switch.addClass('active');search_view_switch.removeClass('active');}else{feed_view_switch.removeClass('active');search_view_switch.addClass('active');}
this.render_current_mode();},get_context:function(){return this.version?[this.version]:null;},set_context:function(context,record){this.version=context?context[0]:null;this.version_record=record;var view=this.get_current_view();if(view&&!SG.ReviewApp.Utils.contexts_match(view.get_context(),context))
view.set_context(context,record);},get_current_version_fields:function(){return['code','description','user','created_at','entity','sg_task','project'];},save_state:function(){var view=this.get_current_view();view.save_state();},restore_state:function(){var view=this.get_current_view();view.restore_state();}});SG.ReviewAppNotesView=function(config){Ext.apply(this,config);SG.ReviewAppNotesView.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNotesView,SG.Component,{templates:{version_note:'<div class="sgc_review_app_notes_note_form"></div>',version_entry:'<div class="version" record_id="{record_id}">{entry_body}</div>',entity_group:'<div class="group_wrapper">'+'<div class="group entity_group thread_item {collapsed}">'+'<div class="header">'+'</div>'+'<div class="count_wrapper">'+'<div class="prefix"></div>'+'<div class="review_app_close_pane collapse_group"></div>'+'</div>'+'<div class="notes"></div>'+'</div>'+'</div>',version_group:'<div class="group_wrapper">'+'<div class="group version_group thread_item {collapsed}" record_ids="{record_ids}">'+'<div class="header versions">'+'{version_contents}'+'</div>'+'<div class="count_wrapper">'+'<div class="prefix"></div>'+'</div>'+'<div class="notes"></div>'+'</div>'+'</div>',new_note_entry:'<div class="note thread_item {related_note}" record_id="{record_id}"><hr class="start"/>{entry_body}<hr class="end"/></div>',reply_entry:'<div class="reply" record_id="{record_id}">{entry_body}</div>',entry_body:'<div class="entry">'+'<div class="user_thumbnail" user_type="{user_type}" user_id="{user_id}">{image}</div>'+'<div class="thumb_padding"></div>'+'<div class="note_wrapper">'+'<div class="user_name_and_date">'+'<span class="prefix">{prefix}</span>'+'<span class="user_name" user_type="{user_type}" user_id="{user_id}">{user_name}</span>'+'<span class="date">&nbsp;&bull;&nbsp;{created_at}</span>'+'</div>'+'<div class="description">{description}</div>'+'{attachments}'+'{replies}'+'</div>'+'</div>',thumb_url:'/thumbnail/image/{value}',user_thumb:'<img class="thumbnail" src="{thumb_url}" onError="sg_missing_user_thumb(this);"/>',default_user_thumb:'<img class="thumbnail" src="/images/default_user_thumb.png">',related_version_entry_body:'<div class="entry">'+'{version_thumb}'+'<div class="note_wrapper">'+'<div class="version_name" sg_tip="{version_name}">{version_name}</div>'+'<div class="user_name_and_date">'+'<span class="prefix">{prefix}</span>'+'<span class="user_name" user_type="{user_type}" user_id="{user_id}">{user_name}</span>'+'<span class="date">&nbsp;&bull;&nbsp;{created_at}</span>'+'</div>'+'{description_content}'+'</div>'+'<div class="review_app_close_pane collapse_group"></div>'+'</div>',related_version_description:'<div class="description_content">'+'<div class="user_thumbnail" user_type="{user_type}" user_id="{user_id}">{img}</div>'+'<div class="description">{description}</div>'+'</div>',related_version_thumb:'<div class="version_thumb">'+'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>'+'</div>'},init_component:function(){this.note_manager=this.new_component(SG.ReviewAppNoteManager,{busy_callback:{fn:function(){this.show_loading_overlay();},scope:this},done_callback:{fn:function(){this.hide_loading_overlay();},scope:this},cancel_callback:{fn:function(){this.hide_loading_overlay();},scope:this}});},render:function(){return;},render_entity_group:function(group,all_note_ids,container,order_by_version,animate,no_duplicates,collapsed){var group_exists=false;var entity_id=group.entity_id;var group_divs=container.query('div.entity_group');var i,j,group_div,notes_div,note_ids,note_id,notes_match,group_wrapper_div;if(!no_duplicates){for(i=0;i<group_divs.length;i++){group_div=Ext.get(group_divs[i]);notes_div=group_div.child('div.notes');note_ids=notes_div.dom.getAttribute('record_ids').split(' ');notes_match=true;for(j=0;j<note_ids.length;j++){note_id=Number(note_ids[j]);if(group.ids.indexOf(note_id)===-1){notes_match=false;break;}}
if(notes_match){group_exists=true;group_wrapper_div=group_div.findParent('div.group_wrapper',container,true);break;}}}else if(group_divs.length){group_div=Ext.get(group_divs[0]);group_wrapper_div=group_div.findParent('div.group_wrapper',container,true);group_exists=true;}
if(!group_exists){var html=this.templates.entity_group.apply({collapsed:collapsed?'collapsed':''});var prev_id;if(!order_by_version){var note_idx=this.notes_order.indexOf(group.ids[0]);prev_id=note_idx>0?this.notes_order[note_idx-1]:null;}
var prev_div=this.find_preceding_div(container,prev_id,container,order_by_version);if(!prev_div)
group_wrapper_div=Ext.DomHelper.append(container,html,true);else
group_wrapper_div=Ext.DomHelper.insertAfter(prev_div,html,true);if(animate)
SG.ReviewApp.Utils.reveal(group_wrapper_div);}
notes_div=group_wrapper_div.child('div.notes');notes_div.dom.setAttribute('record_ids',group.ids.join(' '));if(!collapsed){var parent_div=group_wrapper_div.child('div.notes');for(i=0;i<group.ids.length;i++)
this.render_note(group.ids[i],parent_div,all_note_ids,container);}
return group_wrapper_div;},render_version_group:function(group,all_note_ids,container,order_by_version,animate,no_duplicates,collapsed){var group_exists=false;var version_ids=group.version_ids;var group_divs=container.query('div.version_group[record_ids="'+version_ids.join(' ')+'"]');var i,j,group_div,notes_div,note_ids,note_id,notes_match,group_wrapper_div;if(!no_duplicates){for(i=0;i<group_divs.length;i++){group_div=Ext.get(group_divs[i]);notes_div=group_div.child('div.notes');note_ids=notes_div.dom.getAttribute('record_ids').split(' ');notes_match=true;for(j=0;j<note_ids.length;j++){note_id=Number(note_ids[j]);if(group.ids.indexOf(note_id)===-1){notes_match=false;break;}}
if(notes_match){group_exists=true;group_wrapper_div=group_div.findParent('div.group_wrapper',container,true);break;}}}else if(group_divs.length){group_div=Ext.get(group_divs[0]);group_wrapper_div=group_div.findParent('div.group_wrapper',container,true);group_exists=true;}
if(!group_exists){var version_entries_html='';var version_rec,cm,cell,body_html,version_thumb,user,cfg,entry_cfg;var value,image,desc_cfg,desc_html;for(i=0;i<version_ids.length;i++){if(!this.versions[version_ids[i]])continue;version_rec=this.versions[version_ids[i]].record;if(!version_rec)continue;user=version_rec.get('user');version_thumb='';if(version_rec.get('image')){cm=new SG.CellManager({container:this.container,data_set:this.versions[version_ids[i]].data_set,edit_container:this.edit_container,projects:this.get_parent_widget().context_projects(),read_only:true});cell=cm.get_cell('image');cell.skip_revolver_thumb_overlay=true;cell.render_contextmenu_overlay=false;cfg=cell.render(version_rec);version_thumb=this.templates.related_version_thumb.apply(cfg);}
desc_cfg=null;if(version_rec.get('description'))
desc_cfg={description:SG.Markup.parse(version_rec.get('description'))};var created_at=version_rec.get('created_at');created_at.skip_time=true;entry_cfg={version_name:version_rec.get('code'),version_thumb:version_thumb,created_at:SG.Renderers.social_date_time.render(created_at)};if(user){entry_cfg.user_type=user.type;entry_cfg.user_id=user.id;entry_cfg.user_name=user.name;if(desc_cfg){value=version_rec.get('user.'+user.type+'.image');if(value)
image=this.templates.user_thumb.apply({thumb_url:this.templates.thumb_url.apply({value:value})});else
image=this.templates.default_user_thumb.apply();desc_cfg.user_type=user.type;desc_cfg.user_id=user.id;desc_cfg.img=image;}}else{entry_cfg.user_name='<i>Unknown</i>';}
desc_html='';if(desc_cfg)
desc_html=this.templates.related_version_description.apply(desc_cfg);entry_cfg.description_content=desc_html;body_html=this.templates.related_version_entry_body.apply(entry_cfg);version_entries_html+=this.templates.version_entry.apply({record_id:version_ids[i],entry_body:body_html});}
var html=this.templates.version_group.apply({collapsed:collapsed?'collapsed':'',record_ids:version_ids.join(' '),version_contents:version_entries_html});var prev_id;if(order_by_version){var version_idx=this.version_order.indexOf(group.version_ids[0]);prev_id=version_idx>0?this.version_order[version_idx-1]:null;}else{var note_idx=this.notes_order.indexOf(group.ids[0]);prev_id=note_idx>0?this.notes_order[note_idx-1]:null;}
var prev_div=this.find_preceding_div(container,prev_id,container,order_by_version);if(!prev_div)
group_wrapper_div=Ext.DomHelper.insertFirst(container,html,true);else
group_wrapper_div=Ext.DomHelper.insertAfter(prev_div,html,true);if(animate)
SG.ReviewApp.Utils.reveal(group_wrapper_div);}
notes_div=group_wrapper_div.child('div.notes');notes_div.dom.setAttribute('record_ids',group.ids.join(' '));if(!collapsed){var parent_div=group_wrapper_div.child('div.notes');for(i=0;i<group.ids.length;i++)
this.render_note(group.ids[i],parent_div,all_note_ids,container);}
return group_wrapper_div;},render_note:function(note_id,parent_div,all_note_ids,container){var note_div=parent_div.child('div.note[record_id='+note_id+']');if(note_div)return;all_note_ids.push(note_id);var note_hash=this.notes[note_id];var is_related_note=note_hash.version_ids.indexOf(this.version.id)===-1;var idx=this.notes_order.indexOf(note_id);var previous_id=idx>0&&this.notes_order[idx-1];var previous_div=this.find_preceding_div(parent_div,previous_id,container);var html='<div class="note" record_id="'+note_id+'"></div>';var new_note_div;if(previous_div)
new_note_div=Ext.DomHelper.insertAfter(previous_div,html,true);else
new_note_div=Ext.DomHelper.insertFirst(parent_div,html,true);this.note_manager.remove_note_components_by_id(this,note_id);var note_component=this.note_manager.create_note_component(this,{container:new_note_div,edit_container:this.edit_container,projects:[this.version_record.get('project')],record:note_hash.record,data_set:note_hash.data_set,get_fields_callback:{fn:this.get_note_columns,scope:this}});note_component.render();},on_click:function(e,container){var target=Ext.get(e.getTarget());var elem=target.findParent('span.user_name',this.container);if(!elem){elem=target.findParent('img.thumbnail',this.container);if(elem)
elem=Ext.fly(elem).findParent('div.user_thumbnail',this.container);}
if(elem){var type=elem.getAttribute('user_type');var id=elem.getAttribute('user_id');if(!type||!id)
return;var url=window.location.protocol+'//'+window.location.host+'/detail/'+type+'/'+id;if(SG.globals.review_app_player)
SG.globals.review_app_player.open_external_browser(url);else
window.open(url);return;}
elem=Ext.get(target.findParent('div.version_group.collapsed'));if(!elem)
elem=Ext.get(target.findParent('div.entity_group.collapsed'));if(elem){this.expand_group(elem);this.update_expand_all();return;}},process_notes:function(notes_data_set,append){var ids=[];var i,j,record,note_id,note_hash,version_ids,note_links,link_type,link_id,has_entity_link;for(i=notes_data_set.count()-1;i>-1;i--){record=notes_data_set.get_record(i);note_id=record.get_id();if(this.notes_order.indexOf(note_id)>-1){if(this.notes[note_id].record)
continue;}else{this.notes_order.push(note_id);}
ids.push(note_id);version_ids=[];note_links=record.get('note_links');has_entity_link=false;for(j=0;j<note_links.length;j++){link_type=note_links[j].type;link_id=note_links[j].id;if(link_type==='Version'&&version_ids.indexOf(link_id)<0)
version_ids.push(link_id);if(this.linked_entity&&link_type===this.linked_entity.type&&link_id===this.linked_entity.id)
has_entity_link=true;}
if(!version_ids.length&&has_entity_link){if(this.entity_note_order.indexOf(note_id)<0){this.entity_note_order.push(note_id);this.entity_note_count++;}}
for(j=0;j<version_ids.length;j++){if(!this.versions[version_ids[j]])
this.versions[version_ids[j]]={count:0};if(!append)
this.versions[version_ids[j]].count=0;if(!this.versions[version_ids[j]].note_order)
this.versions[version_ids[j]].note_order=[];if(this.versions[version_ids[j]].note_order.indexOf(note_id)<0){this.versions[version_ids[j]].note_order.push(note_id);this.versions[version_ids[j]].count++;}}
this.notes[note_id]={record:record,has_entity_link:has_entity_link,version_ids:version_ids,data_set:notes_data_set,fake_reply_ids:[],replies_loaded:false,reply_count:0,reply_order:[],replies:{},attachment_order:[],attachments:{}};}
if(append)return ids;var note_ids_to_remove=[];var all_note_ids=this.notes_order.concat(this.entity_note_order);for(i=0;i<all_note_ids.length;i++)
if(!notes_data_set.get_record_by_id(all_note_ids[i])&&note_ids_to_remove.indexOf(all_note_ids[i])<0)
note_ids_to_remove.push(all_note_ids[i]);var note_idx,note_ids,to_remove,version_idx;for(i=0;i<note_ids_to_remove.length;i++){note_id=note_ids_to_remove[i];note_idx=this.notes_order.indexOf(note_id);if(note_idx>-1)
this.notes_order.splice(note_idx,1);this.note_manager.remove_note_components_by_id(this,note_id);note_idx=this.entity_note_order.indexOf(note_id);if(note_idx>-1){this.entity_note_order.splice(note_idx,1);this.entity_note_count--;if(this.entity_note_count===0)
this.entity_group_collapsed=true;}
version_ids=this.notes[note_id].version_ids;to_remove=[];for(j=0;j<version_ids.length;j++){note_ids=this.versions[version_ids[j]].note_order;if(!note_ids)continue;note_idx=note_ids.indexOf(note_id);if(note_idx>-1){note_ids.splice(note_idx,1);this.versions[version_ids[j]].count--;if(note_ids.length===0){version_idx=this.version_order.indexOf(version_ids[j]);if(version_idx>-1)
this.version_order.splice(version_idx,1);delete this.versions[version_ids[j]];}}}
delete this.notes[note_id];}
return ids;},process_versions:function(data_set){var i,record,record_id;for(i=0;i<data_set.count();i++){record=data_set.get_record(i);record_id=record.get_id();if(this.versions[record_id]&&this.versions[record_id].record)
continue;this.version_order.push(record_id);if(!this.versions[record_id])
this.versions[record_id]={count:0,collapsed:true};this.versions[record_id].record=record;this.versions[record_id].data_set=data_set;}
var me=this;this.version_order.sort(function(a,b){var a_code=me.versions[a].record.get('code');var b_code=me.versions[b].record.get('code');if(a_code<b_code)
return-1;if(a_code>b_code)
return 1;return 0;});},find_preceding_div:function(parent_div,previous_id,container,order_by_version){if(!previous_id)return null;var previous_div,group_div;if(order_by_version){group_div=parent_div.child('div.version_group[record_ids='+previous_id+']');previous_div=group_div&&group_div.findParent('div.group_wrapper',container,true);}else{previous_div=parent_div.child('div.note[record_id='+previous_id+']');}
if(parent_div===container&&!order_by_version){if(previous_div){var group_wrapper_div=previous_div.findParent('div.group_wrapper',container,true);if(group_wrapper_div)
previous_div=group_wrapper_div;}else{var group_divs=container.query('div.group');var i,notes_div,record_ids;for(i=0;i<group_divs.length;i++){group_div=Ext.get(group_divs[i]);notes_div=group_div.child('div.notes');record_ids=notes_div.dom.getAttribute('record_ids').split(' ');if(record_ids.indexOf(previous_id.toString())>-1){previous_div=group_div.findParent('div.group_wrapper',container,true);break;}}}}
return previous_div;},get_note_columns:function(){var supported_fields=['content','created_at','user','user.HumanUser.image','user.ApiUser.image','attachments'];var fields=SG.schema.get_categorized_fields('Note').ordinary;var i;for(i=0;i<fields.length;i++)
{var schema_field=fields[i];if(supported_fields.indexOf(schema_field.name)>-1||!schema_field.grid_column)
continue;supported_fields.push(schema_field.name);}
return supported_fields;},get_version_columns:function(){return['id','code','user','user.HumanUser.image','user.ApiUser.image','description','created_at','image'];},update_time_stamps:function(container){var now=new Date();var ignore_delta=7*24*60*60*1000;var version_id,version_divs,created_at,i;for(version_id in this.versions){if(this.versions[version_id]&&this.versions[version_id].record){version_divs=container.query('div.version[record_id='+version_id+']');created_at=this.versions[version_id].record.get('created_at');if(now-Date.sgParseDateTime(created_at)<ignore_delta)
for(i=0;i<version_divs.length;i++)
this.update_time_stamp(Ext.get(version_divs[i]),created_at);}}},update_time_stamp:function(container,date){if(!container)return;var date_span=container.child('span.date');if(!date_span)return;date_span.update('&nbsp;&bull;&nbsp'+SG.Renderers.social_date_time.render(date));},get_created_date:function(record){return Date.sgParseDateTime(record.get('created_at'));},get_context:function(){return this.version?[this.version]:null;},set_context:function(context,record){this.version=context?context[0]:null;this.version_record=record;this.linked_entity=record&&record.get('entity');},save_state:function(){},restore_state:function(){},show_loading_overlay:function(container){var parent=this.get_parent_component();parent.show_loading_overlay(container);},hide_loading_overlay:function(){var parent=this.get_parent_component();parent.hide_loading_overlay();}});SG.ReviewAppNotesFeedView=function(config){Ext.apply(this,config);SG.ReviewAppNotesFeedView.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNotesFeedView,SG.ReviewAppNotesView,{templates:{main:'<div class="sgc_review_app_notes_feed_view">'+'{menu_bar}'+'<div class="notes_main sgw_review_app_scroll_area">'+'<div class="version_details thread_item {all_notes_loaded}"></div>'+'<div class="load_more_notes"></div>'+'<div class="notes thread_item"></div>'+'<div class="new_note_form thread_item"></div>'+'</div>'+'</div>',menu_bar:'<div class="menu_bar_wrapper">'+'<div class="menu_bar">'+'<div class="menu_item toggle_related_notes">{related_notes_text}</div>'+'</div>'+'</div>',load_more_notes_button:'<div class="load_more_notes_button">{button_text}</div>',load_one_more_note_button_text:'Load 1 previous note',load_more_notes_button_text:'Load {num_more_notes} previous notes'},init_component:function(){SG.ReviewAppNotesFeedView.superclass.init_component.call(this);this.load_related_notes=false;if(!this.disable_related_notes_feature){var load_related_notes_setting=localStorage.getItem('sgc_review_app_notes_related_notes');this.load_related_notes=load_related_notes_setting?Number(load_related_notes_setting)===1:false;}
this.setup_new_record();},render:function(){var all_loaded=!this.notes||this.all_notes_loaded;var menu_bar_html;if(!this.disable_related_notes_feature)
menu_bar_html=this.templates.menu_bar.apply({related_notes_text:this.load_related_notes?'Hide Related Notes':'Show Related Notes'});this.container.update(this.templates.main.apply({menu_bar:menu_bar_html,all_notes_loaded:all_loaded?'all_notes_loaded':''}));this.main_div=this.container.child('div.sgc_review_app_notes_feed_view');this.bottom_pane_div=this.container.child('div.notes_main');this.version_details_div=this.container.child('div.version_details');this.load_more_notes_div=this.container.child('div.load_more_notes');this.new_note_form_div=this.container.child('div.new_note_form');this.notes_div=this.container.child('div.notes');if(this.version_record){var user=this.version_record.get('user');var created_at=this.version_record.get('created_at');created_at.skip_time=true;var entry_cfg={created_at:SG.Renderers.social_date_time.render(created_at),description:SG.Markup.parse(this.version_record.get('description'))};if(user){var value=this.version_record.get('user.'+user.type+'.image');var image;if(value)
image=this.templates.user_thumb.apply({thumb_url:this.templates.thumb_url.apply({value:value})});else
image=this.templates.default_user_thumb.apply();entry_cfg.prefix='Version by ';entry_cfg.image=image;entry_cfg.user_type=user.type;entry_cfg.user_id=user.id;entry_cfg.user_name=user.name;}else{entry_cfg.user_name='<i>Unknown</i>';entry_cfg.image=this.templates.default_user_thumb.apply();}
var version_entry_html=this.templates.version_entry.apply({record_id:this.version_record.get_id(),entry_body:this.templates.entry_body.apply(entry_cfg)});this.version_details_div.update(version_entry_html);this.new_note_form_div.update(this.templates.version_note.apply());}
this.add_event(this.main_div,'click',this.on_click);this.show_loading_overlay();if(this.notes_order&&this.notes){this.render_note_form();this.render_notes();this.restore_state();this.hide_loading_overlay();return;}
this.entity_note_order=[];this.notes_order=[];this.versions={};this.version_order=[];this.notes={};if(!this.record_initialised)
this.init_record();this.render_note_form();this.fetch_latest_notes();},render_load_more_notes_button:function(){if(this.note_count-this.notes_order.length<1)
this.all_notes_loaded=true;if(this.all_notes_loaded){this.version_details_div.addClass('all_notes_loaded');this.load_more_notes_div.setDisplayed(false);return;}
var button_text='View all '+this.note_count+' Notes';var button_html=this.templates.load_more_notes_button.apply({button_text:button_text});this.load_more_notes_div.update(button_html);this.load_more_notes_div.setDisplayed(true);this.version_details_div.removeClass('all_notes_loaded');},render_note_form:function(){var form_div=this.new_note_form_div.child('div.sgc_review_app_notes_note_form');if(!form_div)return;if(!this.new_note_component){var cfg={container:form_div,edit_container:this.edit_container,all_projects:[this.version_record.get('project')],data_set:this.note_data_set,record:this.record,get_fields_callback:{fn:this.get_note_columns,scope:this},busy_callback:{fn:function(){this.show_loading_overlay();},scope:this},cancel_callback:{fn:function(){this.init_record();this.hide_loading_overlay();},scope:this}};this.new_note_component=this.new_component(SG.ReviewAppNoteForm,cfg);this.new_note_component.done_callback={fn:function(note_id){this.new_note_component.hide_fields();if(note_id){this.on_note_created(note_id,this.notes_div);return;}},scope:this};this.new_note_component.render();}else{this.new_note_component.container=form_div;this.new_note_component.render(true);}},render_notes:function(note_ids){var i,note_id;var all_note_ids=[];this.render_load_more_notes_button();this.note_manager.start_note_creation();this.render_groups(all_note_ids);this.note_manager.end_note_creation({fn:function(){this.hide_loading_overlay();},scope:this});},render_entity_group:function(group,all_note_ids,animate,collapsed){var group_wrapper_div=SG.ReviewAppNotesFeedView.superclass.render_entity_group.call(this,group,all_note_ids,this.notes_div,false,animate,false,collapsed);var group_div=group_wrapper_div.child('div.group');var prefix_div=group_div.child('div.prefix');var prefix_text;if(group_div.hasClass('collapsed')){if(group.count>1)
prefix_text='There are '+group.count+' Notes';else
prefix_text='There is 1 Note';}else{if(group.count>1)
prefix_text='The Notes below are';else
prefix_text='The Note below is';}
prefix_text+=' linked to the same '+this.linked_entity.type+' as the current Version';prefix_div.update(prefix_text);return group_wrapper_div;},render_groups:function(all_note_ids){var groups;if(this.load_related_notes&&this.group_related_notes_by_links)
groups=this.get_link_groups();else
groups=this.get_feed_groups();var i,group;for(i=0;i<groups.length;i++){group=groups[i];switch(group.type){case'note':this.render_note(group.id,this.notes_div,all_note_ids,this.notes_div);break;case'entity':this.render_entity_group(group,all_note_ids);break;case'version':this.render_version_group(group,all_note_ids,this.notes_div);break;default:break;}}},get_feed_groups:function(){var groups=[];var i,note_id,note_hash,is_related_note,last_group;for(i=0;i<this.notes_order.length;i++){note_id=this.notes_order[i];note_hash=this.notes[note_id];is_related_note=note_hash.version_ids.length>0&&note_hash.version_ids.indexOf(this.version.id)===-1;if(!is_related_note&&note_hash.version_ids[0]===this.version.id){groups.push({type:'note',version_id:this.version.id,id:note_id,count:1});continue;}
if(!groups.length){if(note_hash.version_ids.length>0)
groups.push({type:'version',version_ids:note_hash.version_ids,ids:[note_id],count:1});else
groups.push({type:'entity',ids:[note_id],count:1});continue;}
last_group=groups[groups.length-1];if(note_hash.version_ids.length===0){if(last_group.type!=='entity'){groups.push({type:'entity',ids:[note_id],count:1});}else{last_group.ids.push(note_id);last_group.count++;}
continue;}
if(last_group.type!=='version'||JSON.stringify(last_group.version_ids)!==JSON.stringify(note_hash.version_ids)){groups.push({type:'version',version_ids:note_hash.version_ids,ids:[note_id],count:1});continue;}
last_group.ids.push(note_id);last_group.count++;}
return groups;},render_related_notes_menu:function(dom_elem){if(!this.related_notes_menu){this.related_notes_menu=this.new_component(SG.Menu,{before_show:{fn:function(the_menu){var items=[];items.push({html:'Display Related Notes',checked:this.load_related_notes,item_selected:{fn:this.on_related_notes_changed,scope:this}});the_menu.items=items;the_menu.render();},scope:this}});}
this.related_notes_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.related_notes_menu.show();return;},clear_related_notes:function(){var version_groups=this.notes_div.query('div.version_group');var entity_groups=this.notes_div.query('div.entity_group');var divs_to_remove=version_groups.concat(entity_groups);var i;for(i=0;i<divs_to_remove.length;i++)
Ext.fly(divs_to_remove[i]).remove();var indexes_to_remove=[];var note_id,note_div,version_ids;for(i=0;i<this.notes_order.length;i++){note_id=this.notes_order[i];if(this.notes[note_id].version_ids.indexOf(this.version.id)===-1){indexes_to_remove.push(i);note_div=this.notes_div.child('div.note[record_id='+note_id+']');if(note_div)
note_div.remove();delete this.notes[note_id];}}
var new_notes_order=[];for(i=0;i<this.notes_order.length;i++)
if(indexes_to_remove.indexOf(i)===-1)
new_notes_order.push(this.notes_order[i]);this.notes_order=new_notes_order;var version_id;for(version_id in this.versions)
if(version_id!==this.version.id)
delete this.versions[version_id];},fetch_latest_notes:function(){this.show_loading_overlay();var callback={fn:function(note_ids){this.hide_loading_overlay();},scope:this};var links=[];if(this.load_related_notes&&this.linked_entity)
links.push(this.linked_entity);else
links.push(this.version);var data_set=this.new_data_set('Note',function(){this.note_count=data_set.get_paging_info().record_count;this.on_notes_load(data_set,callback);});var notes_spec={type:'Note',columns:this.get_note_columns(),filters:{logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:links}]},sorts:[{column:'created_at',direction:'desc'}],result:data_set,records_per_page:2,current_page:1};SG.Repo.query(notes_spec);},fetch_notes:function(){if(this.all_notes_loaded)
this.fetch_all_notes();else
this.fetch_latest_notes();},fetch_all_notes:function(){this.show_loading_overlay();var callback={fn:function(){this.all_notes_loaded=true;this.hide_loading_overlay();},scope:this};var data_set=this.new_data_set('Note',function(){this.note_count=data_set.count();this.on_notes_load(data_set,callback);});var links=[];if(this.load_related_notes&&this.linked_entity)
links.push(this.linked_entity);else
links.push(this.version);var note_spec={type:'Note',columns:this.get_note_columns(),filters:{logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:links}]},sorts:[{column:'id',direction:'desc'}],result:data_set};SG.Repo.query(note_spec);},fetch_related_versions:function(note_data_set,after_load_callback){var version_ids=[];var i,j,links;for(i=0;i<note_data_set.count();i++){links=note_data_set.get_record(i).get('note_links');for(j=0;j<links.length;j++)
if(links[j].type==='Version'&&version_ids.indexOf(links[j].id)<0)
version_ids.push(links[j].id);}
if(!version_ids.length){this.render_notes();if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);return;}
var data_set=this.new_data_set('Version',function(){this.on_related_versions_load(data_set,after_load_callback);});var ver_spec={type:'Version',ids:version_ids,columns:this.get_version_columns(),result:data_set};SG.Repo.find(ver_spec);},fetch_new_note:function(record_id,after_load_callback){var data_set=this.new_data_set('Note',function(){this.on_new_note_load(data_set,after_load_callback);});var note_spec={type:'Note',columns:this.get_note_columns(),ids:[record_id],result:data_set};SG.Repo.find(note_spec);},on_notes_load:function(notes_data_set,after_load_callback){var ids=this.process_notes(notes_data_set,true);this.sort_by_creation_date(this.notes_order);var key;for(key in this.versions)
if(this.versions.hasOwnProperty(key))
this.sort_by_creation_date(this.versions[key].note_order);var after_load_fn=function(){this.render_notes(ids);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);};if(this.load_related_notes){this.fetch_related_versions(notes_data_set,{fn:after_load_fn,scope:this});return;}
after_load_fn.call(this);},sort_by_creation_date:function(id_list){var me=this;id_list.sort(function(a,b){var a_date=me.get_created_date(me.notes[a].record);var b_date=me.get_created_date(me.notes[b].record);return a_date-b_date;});},on_related_versions_load:function(data_set,after_load_callback){this.process_versions(data_set);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},update_time_stamps:function(){var now=new Date();var ignore_delta=7*24*60*60*1000;if(this.version_record){var created_at=this.version_record.get('created_at');if(now-Date.sgParseDateTime(created_at)<ignore_delta)
this.update_time_stamp(this.version_details_div,this.version_record.get('created_at'));}
SG.ReviewAppNotesFeedView.superclass.update_time_stamps(this,this.notes_div);},on_note_created:function(note_id,container){var callback={fn:function(){var note_comps=this.note_manager.get_note_components_for_id(note_id);if(note_comps.length>0)
note_comps[0].upload_annotated_frames();this.new_note_component.hide_fields();this.hide_loading_overlay();},scope:this};this.fetch_new_note(note_id,callback);},on_new_note_load:function(data_set,after_load_callback){if(data_set.count())
this.note_count++;this.on_notes_load(data_set,after_load_callback);this.note_data_set.remove([this.record]);this.record=this.note_data_set.new_record();this.init_record();this.new_note_component.set_record(this.record);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=target.findParent('div.load_more_notes_button',this.load_more_notes_div);if(elem){this.fetch_all_notes();return;}
elem=Ext.get(target.findParent('div.toggle_related_notes',this.main_div));if(elem){this.toggle_related_notes();var related_notes_div=this.main_div.child('div.toggle_related_notes');if(this.load_related_notes)
related_notes_div.update('Hide Related Notes');else
related_notes_div.update('Show Related Notes');return;}
SG.ReviewAppNotesFeedView.superclass.on_click.call(this,e,this.notes_div);},toggle_related_notes:function(){this.load_related_notes=!this.load_related_notes;localStorage.setItem('sgc_review_app_notes_related_notes',this.load_related_notes?'1':'0');if(!this.load_related_notes){this.load_more_notes_div.setDisplayed(false);this.clear_related_notes();}
if(this.load_related_notes||!this.all_notes_loaded)
this.fetch_notes();},init_record:function(){var user=this.version_record.get('user');if(user)
this.record.set('addressings_to',[user]);this.record.set('user',{type:'HumanUser',id:SG.globals.current_user.id,name:SG.globals.current_user.display_name,valid:'valid'});var links=[this.version];if(this.linked_entity)
links.push(this.linked_entity);var subject=SG.globals.current_user.display_name+'\'s Note on '+
this.version_record.get('code');this.record.set('subject',subject);this.record.set('project',this.version_record.get('project'));this.record.set('note_links',links);var task=this.version_record.get('sg_task');if(task)
this.record.set('tasks',[task]);this.record_initialised=true;},setup_new_record:function(){this.note_data_set=this.new_data_set('Note');this.record=this.note_data_set.new_record();this.record_initialised=false;},set_context:function(context,record){SG.ReviewAppNotesFeedView.superclass.set_context.call(this,context,record);this.notes_order=null;this.notes=null;this.setup_new_record();this.new_note_component=null;this.all_notes_loaded=false;this.new_note_data_set=null;this.attachments_data_set=null;this.user_data_set=null;this.scroll_position=0;},save_state:function(){if(this.note_manager)
this.note_manager.end_time_stamp_updates();this.scroll_position=this.bottom_pane_div.dom.scrollTop;},restore_state:function(){if(this.note_manager)
this.note_manager.start_time_stamp_updates();this.bottom_pane_div.dom.scrollTop=this.scroll_position;}});SG.ReviewAppNotesSearchView=function(config){Ext.apply(this,config);SG.ReviewAppNotesSearchView.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppNotesSearchView,SG.ReviewAppNotesView,{templates:{main:'<div class="sgc_review_app_notes_search_view">'+'<div class="menu_bar_wrapper">'+'<div class="menu_bar">'+'<div class="menu_options">'+'<div id="sgc_review_app_notes_search_view_filter" class="note_filter" sg_tip="Search related Notes"></div>'+'<div class="expand_all">{expand_text}</div>'+'</div>'+'</div>'+'</div>'+'<div class="versions_main sgw_review_app_scroll_area"></div>'+'</div>',version_group:'<div class="group_wrapper">'+'<div class="group version_group thread_item {collapsed}" record_ids="{record_ids}">'+'<div class="header versions">'+'{version_contents}'+'</div>'+'<div class="count_wrapper">'+'<div class="prefix"></div>'+'</div>'+'<div class="notes"></div>'+'</div>'+'</div>',no_matches:'<div class="no_matches_wrapper">'+'<div class="no_matches">{no_matches_text}</div>'+'</div>'},init_component:function(){SG.ReviewAppNotesSearchView.superclass.init_component.call(this);this.all_expanded=false;var encoded_settings=localStorage.getItem('sgc_review_app_notes_qf_settings');this.quick_filter_settings={};if(encoded_settings)
this.quick_filter_settings=Ext.decode(encoded_settings);},render:function(){this.container.update(this.templates.main.apply({expand_text:this.all_expanded?'Collapse All':'Expand All'}));this.main_div=this.container.child('div.sgc_review_app_notes_search_view');this.versions_div=this.container.child('div.versions_main');this.add_event(this.main_div,'click',this.on_click);if(!this.filter){this.filter=this.new_component(SG.QuickFilter,{container_id:'sgc_review_app_notes_search_view_filter',entity_type:'Note',widget:this.get_parent_widget(),quick_filter_callback:{fn:this.on_filters_changed,scope:this},get_settings_callback:{fn:function(name){return this.quick_filter_settings[name];},scope:this},set_settings_callback:{fn:function(name,value){this.quick_filter_settings[name]=value;localStorage.setItem('sgc_review_app_notes_qf_settings',Ext.encode(this.quick_filter_settings));},scope:this},external_button_click_handler:true});this.filter.toggle_quick_filter_showing();}else{this.filter.setup_container();this.filter.render();}
this.show_loading_overlay();if(this.notes_order&&this.notes){this.render_groups();this.restore_state();this.hide_loading_overlay();return;}
this.entity_note_count=0;this.entity_group_collapsed=true;this.entity_note_order=[];this.notes={};this.notes_order=[];this.versions={};this.version_order=[];this.filters=this.filter.set_current_filter(this.filter.current_filter||'');this.fetch_related_notes();},render_entity_group:function(group,all_note_ids,animate,collapsed){var group_wrapper_div=SG.ReviewAppNotesSearchView.superclass.render_entity_group.call(this,group,all_note_ids,this.versions_div,true,animate,true,collapsed);var group_div=group_wrapper_div.child('div.group');this.update_prefix_text(group_div,collapsed,animate);return group_wrapper_div;},render_version_group:function(group,all_note_ids,animate,collapsed){var group_wrapper_div=SG.ReviewAppNotesSearchView.superclass.render_version_group.call(this,group,all_note_ids,this.versions_div,true,animate,true,collapsed);var group_div=group_wrapper_div.child('div.group');this.update_prefix_text(group_div,collapsed,animate);return group_wrapper_div;},update_prefix_text:function(group_div,collapsed,animate){var has_filters=this.filters&&this.filters.conditions.length>0;var prefix_text;if(group_div.hasClass('entity_group')){if(collapsed){prefix_text='View '+this.entity_note_count+' '+(has_filters?'matching ':'')+'Note'.pluralize(this.entity_note_count)+' linked to this '+this.linked_entity.type;}else{prefix_text='The '+'Note'.pluralize(this.entity_note_count)+' below is linked to this '+this.linked_entity.type;}}else if(collapsed){var record_ids=group_div.dom.getAttribute('record_ids').split(' ');if(record_ids.length>0){var count=this.versions[Number(record_ids[0])].count;prefix_text='View ';if(has_filters)
prefix_text+=count+' matching';else
prefix_text+=(count>1?'all ':'')+count;prefix_text+=' '+'Note'.pluralize(count)+' linked to this Version';}}
var prefix_div=group_div.child('div.prefix');prefix_div.update(prefix_text);},render_groups:function(animate){var groups=this.get_link_groups();this.remove_filtered_notes(groups);var all_note_ids=[];var no_matches_div=this.versions_div.child('div.no_matches');if(!groups.length){var text='There are no Notes related to this Version';if(this.filters&&this.filters.conditions.length)
text='There are no Notes matching your filters';if(!no_matches_div){no_matches_div=Ext.DomHelper.insertFirst(this.versions_div,this.templates.no_matches.apply({no_matches_text:text}),true);SG.ReviewApp.Utils.reveal(no_matches_div);}else{no_matches_div.update(text);}
return;}
if(no_matches_div){var no_matches_wrapper=no_matches_div.findParent('div.no_matches_wrapper',this.versions_div,true);SG.ReviewApp.Utils.remove(no_matches_div);}
var i,j,group,collapsed,version_id,version_hash;for(i=0;i<groups.length;i++){group=groups[i];switch(group.type){case'entity':this.render_entity_group(group,all_note_ids,animate,this.entity_group_collapsed);break;case'version':collapsed=true;version_id=group.version_ids&&group.version_ids.length&&group.version_ids[0];version_hash=version_id&&this.versions[version_id];if(version_hash)
collapsed=version_hash.collapsed;this.render_version_group(group,all_note_ids,animate,collapsed);break;default:break;}}},remove_filtered_notes:function(groups){var group_divs=[];var i;var entity_groups=this.versions_div.query('div.entity_group');var group_wrapper_div;if(this.entity_note_count===0){for(i=0;i<entity_groups.length;i++){group_wrapper_div=Ext.get(Ext.get(entity_groups[i]).findParent('div.group_wrapper'));SG.ReviewApp.Utils.remove(group_wrapper_div);}}else{group_divs=group_divs.concat(entity_groups);}
var version_groups=this.versions_div.query('div.version_group');var j,group_div,version_ids_str,do_remove;for(i=0;i<version_groups.length;i++){group_div=version_groups[i];version_ids_str=group_div.getAttribute('record_ids');do_remove=true;for(j=0;j<groups.length;j++)
if(groups[j].version_ids){groups[j].version_ids.sort();if(version_ids_str===groups[j].version_ids.join(' ')){do_remove=false;break;}}
if(do_remove){group_wrapper_div=Ext.get(Ext.get(group_div).findParent('div.group_wrapper'));SG.ReviewApp.Utils.remove(group_wrapper_div);}else{group_divs.push(group_div);}}
var note_divs,note_id;for(i=0;i<group_divs.length;i++){note_divs=Ext.get(group_divs[i]).query('div.note');for(j=0;j<note_divs.length;j++){note_id=Number(note_divs[j].getAttribute('record_id'));if(!this.notes.hasOwnProperty(note_id))
SG.ReviewApp.Utils.remove(Ext.get(note_divs[j]));}}},process_note_summaries:function(data_set){var i,version_id,version_hash;var version_ids=[];var j,record,note_id,note_hash,note_links,link_type,link_id,vids,has_entity_link;for(i=0;i<data_set.count();i++){record=data_set.get_record(i);note_id=record.get_id();if(this.notes_order.indexOf(note_id)<0)
this.notes_order.push(note_id);note_links=record.get('note_links');has_entity_link=false;vids=[];for(j=0;j<note_links.length;j++){link_type=note_links[j].type;link_id=note_links[j].id;if(link_type==='Version'){vids.push(link_id);if(version_ids.indexOf(link_id)<0)
version_ids.push(link_id);}
if(this.linked_entity&&link_type===this.linked_entity.type&&link_id===this.linked_entity.id){has_entity_link=true;}}
if(vids.length===0&&has_entity_link&&this.entity_note_order.indexOf(note_id)<0){this.entity_note_order.push(note_id);this.entity_note_count++;}
if(!this.notes.hasOwnProperty(note_id))
this.notes[note_id]={has_entity_link:has_entity_link,version_ids:vids};for(j=0;j<vids.length;j++){version_id=vids[j];if(!this.versions[version_id])
this.versions[version_id]={count:0,collapsed:true};if(!this.versions[version_id].note_order)
this.versions[version_id].note_order=[];if(this.versions[version_id].note_order.indexOf(note_id)<0){this.versions[version_id].note_order.push(note_id);this.versions[version_id].count++;}}}
var note_ids_to_remove=[];var all_note_ids=this.notes_order.concat(this.entity_note_order);for(i=0;i<all_note_ids.length;i++)
if(!data_set.get_record_by_id(all_note_ids[i])&&note_ids_to_remove.indexOf(all_note_ids[i])<0)
note_ids_to_remove.push(all_note_ids[i]);var note_idx,note_ids,to_remove,version_idx;for(i=0;i<note_ids_to_remove.length;i++){note_id=note_ids_to_remove[i];note_idx=this.notes_order.indexOf(note_id);if(note_idx>-1)
this.notes_order.splice(note_idx,1);this.note_manager.remove_note_components_by_id(this,note_id);note_idx=this.entity_note_order.indexOf(note_id);if(note_idx>-1){this.entity_note_order.splice(note_idx,1);this.entity_note_count--;if(this.entity_note_count===0)
this.entity_group_collapsed=true;}
version_ids=this.notes[note_id].version_ids;to_remove=[];for(j=0;j<version_ids.length;j++){note_ids=this.versions[version_ids[j]].note_order;if(!note_ids)continue;note_idx=note_ids.indexOf(note_id);if(note_idx>-1){note_ids.splice(note_idx,1);this.versions[version_ids[j]].count--;if(note_ids.length===0){version_idx=this.version_order.indexOf(version_ids[j]);if(version_idx>-1)
this.version_order.splice(version_idx,1);delete this.versions[version_ids[j]];}}}
delete this.notes[note_id];}
return version_ids;},fetch_related_notes:function(animate){var links;if(this.linked_entity)
links=[this.linked_entity];else
links=[this.version];var data_set=this.new_data_set('Note');data_set.on('load',function(){this.on_note_summaries_load(data_set,animate);},this);var spec={type:'Note',columns:['note_links'],filters:{logical_operator:'and',conditions:[{path:'note_links',relation:'is',values:links}]},sorts:[{column:'created_at',direction:'asc'}],result:data_set};if(this.filters)
spec.filters.conditions.push(this.filters);SG.Repo.query(spec);},fetch_notes_by_id:function(note_ids,animate,after_load_callback){var data_set=this.new_data_set('Note',function(){var note_ids=this.process_notes(data_set,true);this.update_expand_all();this.note_manager.start_note_creation();this.render_groups(animate);this.note_manager.end_note_creation(after_load_callback);});var spec={type:'Note',columns:this.get_note_columns(),filters:{logical_operator:'and',conditions:[{path:'id',relation:'in',values:note_ids}]},sorts:[{column:'created_at',direction:'asc'}],result:data_set};SG.Repo.query(spec);return;},fetch_versions:function(version_ids,animate,callback){if(!version_ids.length){this.clear_notes(true);if(callback)
callback.fn.call(callback.scope);return;}
var data_set=this.new_data_set('Version',function(){this.on_versions_load(data_set,animate);if(callback)
callback.fn.call(callback.scope);});var spec={type:'Version',columns:this.get_version_columns(),filters:{logical_operator:'and',conditions:[{path:'id',relation:'in',values:version_ids}]},sorts:[{column:'code',direction:'asc'}],result:data_set};SG.Repo.query(spec);},on_notes_load:function(data_set,animate){var note_ids=this.process_notes(data_set);this.update_expand_all();var version_ids=[];var version_id;for(version_id in this.versions)
if(this.versions.hasOwnProperty(version_id))
version_ids.push(Number(version_id));var callback={fn:function(){this.hide_loading_overlay();},scope:this};this.fetch_versions(version_ids,animate,callback);},on_note_summaries_load:function(data_set,animate){var version_ids=this.process_note_summaries(data_set);var note_ids=[];var i,j,version_hash,note_id;for(i=0;i<version_ids.length;i++){version_hash=this.versions[version_ids[i]];if(!version_hash||version_hash.collapsed)continue;for(j=0;j<version_hash.note_order.length;j++){note_id=version_hash.note_order[j];if(note_ids.indexOf(note_id)<0)
note_ids.push(note_id);}}
var callback={fn:function(){this.fetch_notes_by_id(note_ids,animate,{fn:function(){this.hide_loading_overlay();},scope:this});},scope:this};if(version_ids.length){this.fetch_versions(version_ids,animate,callback);return;}
callback.fn.call(callback.scope);},on_versions_load:function(data_set,animate){this.process_versions(data_set);this.note_manager.start_note_creation();this.render_groups(animate);this.note_manager.end_note_creation({fn:function(){this.hide_loading_overlay();},scope:this});},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.expand_all',this.versions_div));if(elem){if(!this.all_expanded)
this.expand_all();else
this.collapse_all();return;}
elem=Ext.get(target.findParent('div.collapse_group',this.versions_div));if(elem){var group_div=Ext.get(target.findParent('div.version_group',this.versions_div));if(!group_div)
group_div=Ext.get(target.findParent('div.entity_group',this.versions_div));if(group_div)
this.collapse_group(group_div);return;}
SG.ReviewAppNotesSearchView.superclass.on_click.call(this,e,this.versions_div);},on_filters_changed:function(filters){this.filters=filters;this.show_loading_overlay();this.fetch_related_notes(true);},get_link_groups:function(){var group_map={};var group_order=[];var i,note_id,note_hash,ver_str;for(i=0;i<this.notes_order.length;i++){note_id=this.notes_order[i];note_hash=this.notes[note_id];if(!note_hash)continue;ver_str='-1';if(note_hash.version_ids.length){note_hash.version_ids.sort();ver_str=note_hash.version_ids.join(' ');}
if(!group_map[ver_str])
group_map[ver_str]=[note_id];else
group_map[ver_str].push(note_id);if(group_order.indexOf(ver_str)<0)
group_order.push(ver_str);}
var me=this;group_order.sort(function(a,b){if(a==='-1')return 1;if(b==='-1')return-1;var a_split=a.split(' ');var b_split=b.split(' ');var i=0;do{if(a_split[i]!==b_split[i]){var a_idx=me.version_order.indexOf(Number(a_split[i]));var b_idx=me.version_order.indexOf(Number(b_split[i]));return a_idx-b_idx;}
i++;}while(i<a_split.length&&i<b_split.length);return a_split.length-b_split.length;});var groups=[];var j,ver_str_split,version_ids;for(i=0;i<group_order.length;i++){ver_str=group_order[i];if(ver_str==='-1'){groups.push({type:'entity',count:group_map['-1'].count,ids:group_map['-1']});continue;}
ver_str_split=ver_str.split(' ');version_ids=[];for(j=0;j<ver_str_split.length;j++)
version_ids.push(Number(ver_str_split[j]));groups.push({type:'version',version_ids:version_ids,ids:group_map[ver_str],count:group_map[ver_str].length});}
return groups;},clear_notes:function(animate){this.notes_order=[];this.notes={};this.version_order=[];this.versions={};this.entity_note_order=[];this.entity_note_count=0;this.entity_group_collapsed=true;this.render_groups(animate);},expand_group:function(group_div,after_load_callback){var notes_div=group_div.child('div.notes');var note_ids=notes_div.dom.getAttribute('record_ids').split(' ');var ids=[];var i,id,note_comps;for(i=0;i<note_ids.length;i++)
ids.push(Number(note_ids[i]));if(group_div.hasClass('entity_group')){this.entity_group_collapsed=false;}else{var record_ids=group_div.dom.getAttribute('record_ids').split(' ');if(record_ids.length>0)
this.versions[Number(record_ids[0])].collapsed=false;}
this.show_loading_overlay();this.fetch_notes_by_id(ids,true,{fn:function(){group_div.removeClass('collapsed');this.hide_loading_overlay();},scope:this});},collapse_group:function(group_div){var note_divs=group_div.query('div.note');var i,note_div,note_id;var make_collapse_fn=function(group_div){return function(){group_div.addClass('collapsed');};};for(i=0;i<note_divs.length;i++){note_div=note_divs[i];note_id=Number(note_div.getAttribute('record_id'));this.note_manager.remove_note_components_by_id(note_id);SG.ReviewApp.Utils.remove(Ext.get(note_div),0,{fn:make_collapse_fn(group_div),scope:this});this.update_prefix_text(group_div,true,true);}
if(group_div.hasClass('entity_group')){this.entity_group_collapsed=true;}else{var record_ids=group_div.dom.getAttribute('record_ids').split(' ');if(record_ids.length>0)
this.versions[Number(record_ids[0])].collapsed=true;}},expand_all:function(){var collapsed_divs=this.main_div.query('div.collapsed');var note_ids=[];var i,j,collapsed_div,note_div,note_id_strs;for(i=0;i<collapsed_divs.length;i++){collapsed_div=Ext.get(collapsed_divs[i]);collapsed_div.removeClass('collapsed');note_div=collapsed_div.child('div.notes');note_id_strs=note_div.dom.getAttribute('record_ids').split(' ');for(j=0;j<note_id_strs.length;j++)
note_ids.push(Number(note_id_strs[j]));}
this.entity_group_collapsed=false;var version_hash;for(i=0;i<this.version_order.length;i++){version_hash=this.versions[this.version_order[i]];if(!version_hash)continue;version_hash.collapsed=false;}
this.update_expand_all();this.show_loading_overlay();this.fetch_notes_by_id(note_ids,true,{fn:function(){this.hide_loading_overlay();},scope:this});},collapse_all:function(){var group_divs=this.main_div.query('div.version_group:not(.collapsed)');group_divs=group_divs.concat(this.main_div.query('div.entity_group:not(.collapsed)'));var i,group_div;for(i=0;i<group_divs.length;i++)
this.collapse_group(Ext.get(group_divs[i]));this.update_expand_all();},update_expand_all:function(){var all_expanded=true;var j,version_hash;for(j=0;j<this.version_order.length;j++){version_hash=this.versions[this.version_order[j]];if(!version_hash)continue;if(version_hash.collapsed){all_expanded=false;break;}}
if(this.entity_note_count&&this.entity_group_collapsed)
all_expanded=false;this.all_expanded=all_expanded;var expand_all_div=this.main_div.child('div.expand_all');if(!expand_all_div)return;if(this.all_expanded)
expand_all_div.update('Collapse All');else
expand_all_div.update('Expand All');},set_context:function(context,record){SG.ReviewAppNotesFeedView.superclass.set_context.call(this,context,record);this.notes_order=null;this.notes=null;this.scroll_position=0;},save_state:function(){if(this.note_manager)
this.note_manager.end_time_stamp_updates();this.scroll_position=this.versions_div.dom.scrollTop;},restore_state:function(){if(this.note_manager)
this.note_manager.start_time_stamp_updates();this.versions_div.dom.scrollTop=this.scroll_position;}});SG.Widget.ReviewAppDetails=function(context,widget_spec,id){SG.Widget.ReviewAppDetails.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ReviewAppDetails,SG.Widget.Base,{templates:{main:'<div class="sgw_review_app_details"></div>'},init_widget:function(){if(sg_is_in_rv()&&!SG.globals.review_app_player){SG.globals.review_app_player=new SG.ReviewAppPlayerRV();SG.globals.review_app_player.skip_record_viewed_version_event=true;}},destroy_widget:function(){Ext.EventManager.removeResizeListener(this.on_window_resize,this);},on_first_render:function(){this.container=this.get_container();var encoded_settings=getCookie('review_app_info_columns');var columns=null;if(encoded_settings)
columns=Ext.decode(encoded_settings);var cookie=getCookie('review_app_details_info_open');var info_pane_open=cookie&&Number(cookie);var tab_idx_cookie=getCookie('review_app_tool_index');var tab_index=tab_idx_cookie?Number(tab_idx_cookie):0;this.container.update(this.templates.main.apply());this.details=this.new_component(SG.ReviewAppDetailsComponent,{container:this.container.child('div.sgw_review_app_details'),columns:columns,info_pane_open:info_pane_open,tab_index:tab_index,projects:this.context_projects(),columns_changed_callback:{fn:this.on_columns_changed,scope:this},info_open_changed_callback:{fn:this.on_info_open_changed,scope:this},tab_index_changed_callback:{fn:this.on_tab_index_changed,scope:this}});this.details.render();if(this.context.get('entity'))
this.details.set_tool_context([{type:'Version',id:this.context.get('entity').id}]);else{this.details.set_tool_context_from_player_contents();this.details.init_cell_manager();}
Ext.EventManager.onWindowResize(this.on_window_resize,this);},render_widget:function(){this.details.position_arrow();},set_tool_context:function(context,force){if(!this.details)return;this.details.set_tool_context(context,force);},on_info_open_changed:function(open){setCookie('review_app_details_info_open',open?'1':'0',365);},on_columns_changed:function(columns){setCookie('review_app_info_columns',Ext.encode(columns),365);},on_tab_index_changed:function(tab_idx){setCookie('review_app_tool_index',tab_idx,365);},on_window_resize:function(e){this.details.position_arrow();}});SG.ReviewAppDetailsComponent=function(config)
{Ext.apply(this,config);SG.ReviewAppDetailsComponent.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppDetailsComponent,SG.Component,{templates:{main:'<div class="sgc_review_app_details {is_gecko}">'+'<div class="top_pane">'+'<div class="info"></div>'+'<div class="tool_switcher">'+'<div class="mid_right_wrapper">'+'<div class="middle_controls">'+'<div class="toolbar"></div>'+'<div class="arrow_wrapper"></div>'+'</div>'+'{right_controls}'+'</div>'+'</div>'+'<div class="menu_bar"></div>'+'</div>'+'<div class="bottom_pane"></div>'+'<div class="pkg_out_of_date_alert"></div>'+'</div>',right_controls:'<div class="right_controls">'+'<div class="close_pane_button"></div>'+'<div class="tear_off_pane_button {floating}"></div>'+'</div>',info_content:'<div class="version_thumb {flagged}">'+'{image}'+'<div class="expand_info" sg_tip="Expand or collapse this info pane"></div>'+'<div class="review_app_flagged_indicator"></div>'+'</div>'+'<div class="version_area_other_fields">'+'<div class="version_link" field="entity">{entity}</div>'+'<div class="version_code" field="code">{code}</div>'+'<div class="measure_wrapper">'+'<div class="version_fields"></div>'+'<div class="more_fields">More fields...</div>'+'</div>'+'</div>'+'<div class="jump_to_shotgun" sg_tip="View the Shotgun page for this Version"></div>'+'<div class="pin_button" sg_tip="Pin the detail pane to this Version"></div>',info_no_content:'',field:'<div class="field">'+'<div class="field_name" sg_tip="{field_name}"><div>{field_name}</div></div>'+'<div class="field_value {cell_classes}" style="{cell_styles}" '+'{cell_attributes}>{cell_content}</div>'+'</div>',tool:'<div class="tool_button {selected} {disabled} {extra_classes}" tool_name="{tool_name}" '+'tool_idx="{tool_idx}"></div>',thumb:'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>{cell_content}</div>'},init_component:function(){this.locked_fields=['entity','image','code'];if(!this.columns)
this.columns=[{field:'image',show_label:false},{field:'code',show_label:false},{field:'user',show_label:false},{field:'entity',show_label:false},{field:'sg_status_list',show_label:false}];this.data_set=this.new_data_set('Version',this.on_version_load,this.on_version_change);SG.NotificationCenter.add_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});},destroy_component:function(){SG.NotificationCenter.remove_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});},on_first_render:function(){var embedded=SG.globals.review_app_player&&SG.globals.review_app_player.has_embedded_panes();var floating=embedded&&!SG.globals.review_app_player.pane_is_docked('Right');var right_controls;if(embedded){right_controls=this.templates.right_controls.apply({floating:floating?'floating':''});}
this.container.update(this.templates.main.apply({is_gecko:Ext.isGecko?'is_gecko':'',right_controls:right_controls}));this.top_pane_div=this.container.child('div.top_pane');this.bottom_pane_div=this.container.child('div.bottom_pane');this.info_div=this.top_pane_div.child('div.info');if(this.info_pane_open)
this.open_info_pane();this.toolbar_div=this.container.child('div.toolbar');this.menu_bar_div=this.container.child('div.menu_bar');this.arrow_wrapper_div=this.top_pane_div.child('div.arrow_wrapper');var cfg={initial_context:this.tool_context,container:this.bottom_pane_div,menu_bar_container:this.menu_bar_div,edit_container:this.edit_container,menu_class:this.menu_class};this.tools=[{name:'related_versions',display_name:'Related Versions',component:this.new_component(SG.ReviewAppRelatedVersions,cfg)},{name:'notes',display_name:'Notes',component:this.new_component(SG.ReviewAppNotes,cfg)}];if(SG.globals.review_app_player){SG.globals.review_app_player.on('viewed_versions_changed',this.on_viewed_versions_changed,this);SG.globals.review_app_player.on('updates_enabled_changed',this.on_updates_enabled,this);SG.globals.review_app_player.on('docked_state_changed',this.on_docked_state_changed,this);}
if(isNaN(this.tab_index))
this.tab_index=0;var tool_html='';var i;for(i=0;i<this.tools.length;i++)
tool_html+=this.templates.tool.apply({selected:i===this.tab_index?'selected':'',tool_name:this.tools[i].name,disabled:this.tools[i].disabled?'disabled':'',tool_idx:i});this.toolbar_div.update(tool_html);this.set_current_tab_idx(this.tab_index);this.position_arrow();this.add_event(this.top_pane_div,'click',this.on_top_pane_click);this.add_event(this.container,'click',this.on_click);},render:function(){if(!this.rendered){this.on_first_render();this.rendered=true;}
this.position_arrow();},render_version_header:function(){var params={};var i,field;for(i=0;i<this.columns.length;i++){if(this.locked_fields.indexOf(this.columns[i].field)<0)
continue;field=this.columns[i].field;var value,cell,cfg;switch(field){case'entity':params.entity=this.record.get('entity')&&this.record.get('entity').name;break;case'code':params.code=this.record.get('code');break;case'image':if(this.record.get('image')){cell=this.cell_manager.get_cell('image');cell.skip_revolver_thumb_overlay=true;cell.render_contextmenu_overlay=false;cfg=cell.render(this.record);params.image=this.templates.thumb.apply(cfg);}else{params.image='<img src="/images/missing_image.png"/>';}
break;default:cfg=this.cell_manager.get_cell(field).render(this.record);cfg.field_name=SG.schema.get_field_display_name('Version',field);params[field]=this.templates.field.apply(cfg);}}
params.flagged=this.record.get('flagged')?'flagged':'';this.info_div.update(this.templates.info_content.apply(params));this.measure_div=this.info_div.child('div.measure_wrapper');this.render_extra_fields();},render_extra_fields:function(){var extra_fields_html='';var cfg,i,field_name;var extra_fields=[];for(i=0;i<this.columns.length;i++){field_name=this.columns[i].field;if(this.locked_fields.indexOf(field_name)>-1)
continue;extra_fields.push(this.columns[i].field);}
for(i=0;i<extra_fields.length;i++){cfg=this.cell_manager.get_cell(extra_fields[i]).render(this.record);cfg.field_name=SG.schema.get_field_display_name('Version',extra_fields[i]);extra_fields_html+=this.templates.field.apply(cfg);}
var version_fields_div=this.info_div.child('div.version_fields');version_fields_div.update(extra_fields_html);},render_empty_page:function(){for(i=0;i<this.tools.length;i++){if(!this.tools[i].component)
continue;this.tools[i].component.dirty=true;}
this.info_div.update('');this.menu_bar_div.update('');this.bottom_pane_div.update('');},fetch_version:function(){var fields=['flagged'];var i,j,tool_fields;for(i=0;i<this.tools.length;i++){if(!this.tools[i].component)
continue;tool_fields=this.tools[i].component.get_current_version_fields();for(j=0;j<tool_fields.length;j++)
if(fields.indexOf(tool_fields[j])<0)
fields.push(tool_fields[j]);}
for(i=0;i<this.columns.length;i++)
if(fields.indexOf(this.columns[i].field)<0)
fields.push(this.columns[i].field);var spec={type:'Version',ids:[this.tool_context[0].id],columns:fields,result:this.data_set};SG.Repo.find(spec);},fetch_flagged_state:function(){var data_set=new SG.Data.Set('Version');var callback=function(){if(data_set.count()===0)return;var record=data_set.get_record(0);if(record.get_id()!==this.record.get_id())return;var flagged=record.get('flagged');this.record.set('flagged',flagged);this.update_flagged_state(flagged);};data_set.on('load',callback,this);var spec={type:'Version',ids:[this.record.get_id()],columns:['flagged'],result:data_set};SG.Repo.find(spec);},on_version_load:function(){if(!this.data_set.count())return;this.record=this.data_set.get_record(0);this.tool_context=[{type:this.record.get_type(),id:this.record.get_id(),name:this.record.get('code'),valid:'valid'}];this.render_version_header();this.hide_loading_overlay();this.render_tools();},on_version_change:function(changes){var change,i,vdiv;for(i=0;i<changes.length;i++){change=changes[i];if(change.state!=='pending'&&change.type==='update'&&change.column==='flagged'&&change.record.id===this.record.get_id())
SG.ReviewApp.Utils.notify_flag_state_changed([change.record.get_id()],'details');}},update_flagged_state:function(flagged){var vdiv=this.info_div.child('div.version_thumb');if(!vdiv)return;if(flagged)
vdiv.addClass('flagged');else
vdiv.removeClass('flagged');},render_tools:function(force){if(this.tools){var i;for(i=0;i<this.tools.length;i++){if(!this.tools[i].component)
continue;if(this.tools[i].component.accepts_context(this.tool_context)){this.tools[i].component.set_tool_context(this.tool_context,this.record);if(this.current_tab_idx===i&&!this.tools[i].component.skip_render)
this.tools[this.current_tab_idx].component.render_tool(force);}else{if(this.current_tab_idx===i)
this.render_empty_page();}}}},on_top_pane_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.tool_button',this.top_pane_div));if(elem&&!elem.hasClass('selected')&&!elem.hasClass('disabled')){var selected_tools=sg_find_all('div.tool_button.selected',this.top_pane_div.dom);elem.addClass('selected');var i;for(i=0;i<selected_tools.length;i++){Ext.fly(selected_tools[i]).removeClass('selected');}
this.position_arrow(true);this.set_current_tab_idx(Number(elem.dom.getAttribute('tool_idx')));return;}
elem=Ext.get(target.findParent('div.close_pane_button',this.top_pane_div));if(elem){SG.globals.review_app_player.close_pane('Right')
return;}
elem=Ext.get(target.findParent('div.tear_off_pane_button',this.top_pane_div));if(elem){if(SG.globals.review_app_player.pane_is_docked('Right'))
SG.globals.review_app_player.tear_off_pane('Right')
else
SG.globals.review_app_player.dock_pane('Right')
return;}
elem=Ext.get(target.findParent('div.pin_button',this.top_pane_div));if(elem){if(elem.hasClass('pinned'))
this.unpin();else
this.pin();return;}
elem=Ext.get(target.findParent('div.jump_to_shotgun',this.top_pane_div));if(elem&&this.record){var url='/detail/'+this.record.get_type()+'/'+this.record.get_id();if(SG.globals.review_app_player){url=window.location.protocol+'//'+window.location.host+url;SG.globals.review_app_player.open_external_browser(url);}else{window.open(url);}
return;}
elem=Ext.get(target.findParent('div.more_fields',this.top_pane_div));if(elem){this.fields_menu_toolbar_div=elem;if(!this.fields_menu){this.fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},after_hide:{fn:function(the_menu){Ext.fly(the_menu.position.dom_elem).removeClass('active');},scope:this}});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'Version',field_disabled_callback:{fn:function(field_schema,field_name){return this.locked_fields.indexOf(field_name)>-1;},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var i;for(i=0;i<this.columns.length;i++){if(this.columns[i].field===field_name)
return true;}
return false;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
elem.addClass('active');this.fields_menu.show();return;}
elem=Ext.get(target.findParent('div.version_thumb',this.top_pane_div));if(elem&&!target.hasClass('version_thumb')){this.toggle_info_pane();return;}},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('a',this.container));if(elem){e.stopEvent();var url=elem.dom.getAttribute('href');if(SG.globals.review_app_player){if(url.indexOf('http')!==0){url=window.location.protocol+'//'+window.location.host+url;}
SG.globals.review_app_player.open_external_browser(url);}else{window.open(url);}
return;}},on_flagged_state_changed:function(args){var record_ids=args.version_ids;var sender=args.sender;if(sender==='details')return;if(record_ids.indexOf(this.record.get_id())>-1)
this.fetch_flagged_state();},on_docked_state_changed:function(docked){var elem=this.container.child('div.tear_off_pane_button');if(elem){if(!docked)
elem.addClass('floating');else
elem.removeClass('floating');}},on_viewed_versions_changed:function(version_ids,current_version_id,progress){if(!current_version_id)return;this.set_tool_context([{type:'Version',id:current_version_id}]);},on_updates_enabled:function(enabled){if(enabled&&this.updates_disabled){this.updates_disabled=false;if(!this.pinned)
this.unpin();return;}
if(enabled||this.updates_disabled)return;this.updates_disabled=true;this.pinned=this.is_pinned();if(!this.pinned)
this.pin();},on_before_show_fields_menu:function(menu){menu.position={dom_elem:this.fields_menu_toolbar_div.dom,elem_anchor:'bl',menu_anchor:'tl',minimum_height:200};menu.items=this.fields_menu_helper.get_menu_items();menu.render();},toggle_field:function(menu,item){if(this.locked_fields.indexOf(item.field)>-1)return;var field_index=-1;var i;for(i=0;i<this.columns.length;i++){if(this.columns[i].field===item.field)
field_index=i;}
var version_needs_update=false;if(field_index>-1){this.columns.splice(field_index,1);}else{this.columns.push({field:item.field,show_label:false});version_needs_update=true;}
if(version_needs_update){this.show_loading_overlay();this.data_set=this.new_data_set('Version',this.on_version_load,this.on_version_change);this.init_cell_manager();this.fetch_version();}else{this.render_extra_fields();}
if(this.columns_changed_callback)
this.columns_changed_callback.fn.call(this.columns_changed_callback.scope,this.columns);},position_arrow:function(animate){var selected_tool_button=this.container.child('div.tool_button.selected');if(!selected_tool_button)return;if(!this.arrow_div){var contents={tag:'div',cls:'sgc_review_app_details_arrow'};this.arrow_div=Ext.get(Ext.DomHelper.append(this.arrow_wrapper_div,contents));}
var x=selected_tool_button.getLeft()+(selected_tool_button.getWidth()-this.arrow_div.getWidth())/2;var cfg=null;if(animate){cfg={duration:0.25,easing:'easeOut'};}
this.arrow_div.setX(x,cfg);},set_current_tab_idx:function(idx){if(idx===this.current_tab_idx)return;if(this.tool_context&&this.current_tab_idx>-1)
this.tools[this.current_tab_idx].component.save_tool_state();this.current_tab_idx=idx;if(this.tool_context&&this.tools[idx].component.accepts_context(this.tool_context)){this.tools[idx].component.render_tool();}else{this.render_empty_page();}
var i;for(i=0;i<this.tools.length;i++){if(!this.tools[i].component)continue;this.tools[i].component.set_is_current_tool(i===idx);}
if(this.tab_index_changed_callback)
this.tab_index_changed_callback.fn.call(this.tab_index_changed_callback.scope,idx);},set_tool_context:function(context,force){if(!force&&SG.ReviewApp.Utils.contexts_match(this.tool_context,context))
return;if(this.updates_disabled||this.is_pinned())return;this.tool_context=context;this.data_set=this.new_data_set('Version',this.on_version_load,this.on_version_change);this.init_cell_manager();this.fetch_version();if(this.info_div.hasClass('open'))
this.show_loading_overlay(this.info_div);},set_tool_context_from_player_contents:function(){if(!SG.globals.review_app_player)return;var progress_hash=SG.globals.review_app_player.get_progress()
if(progress_hash&&progress_hash.version_id){this.set_tool_context([{type:'Version',id:progress_hash.version_id}]);return;}
this.tool_context=null;this.render_empty_page();},init_cell_manager:function(){var cell_config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:this.projects,field_property_callback:{fn:this.get_field_property_for_cell_manager,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);},get_field_property_for_cell_manager:function(schema_field){for(var i=0;i<this.columns.length;i++){var field_property=this.columns[i];if(field_property.field==schema_field.name)
return field_property;}
return null;},is_pinned:function(){var pin_button=this.container.child('div.pin_button');return pin_button&&pin_button.hasClass('pinned');},pin:function(){var pin_button=this.container.child('div.pin_button');if(pin_button&&!pin_button.hasClass('pinned')){pin_button.addClass('pinned');}},unpin:function(){var pin_button=this.container.child('div.pin_button');if(pin_button&&pin_button.hasClass('pinned')){pin_button.removeClass('pinned');this.set_tool_context_from_player_contents();}},open_info_pane:function(){this.info_div.addClass('open');if(this.measure_div){var version_fields_div=this.measure_div.child('div.version_fields');var more_fields_div=this.measure_div.child('div.more_fields');var height=more_fields_div.getBottom()-version_fields_div.getTop();this.measure_div.setHeight(height+2);}
if(this.info_open_changed_callback)
this.info_open_changed_callback.fn.call(this.info_open_changed_callback.scope,true);},close_info_pane:function(){this.info_div.removeClass('open');if(this.measure_div)
this.measure_div.setHeight(0);if(this.info_open_changed_callback)
this.info_open_changed_callback.fn.call(this.info_open_changed_callback.scope,false);},toggle_info_pane:function(){if(this.info_div.hasClass('open'))
this.close_info_pane();else
this.open_info_pane();},destroy_component:function(){Ext.EventManager.removeResizeListener(this.position_arrow,this);},show_loading_overlay:function(container){var id="review_app_details_component";if(!this.__overlay_template_div__&&!(this.__overlay_template_div__=Ext.get(id))){var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(this.container,overlay_html,true);}
if(!container)
container=this.container;this.__overlay_template_div__.alignTo(container,"tl-tl");this.__overlay_template_div__.setWidth(container.getWidth());this.__overlay_template_div__.setHeight(container.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__)
this.__overlay_template_div__.hide();}});SG.Widget.ReviewAppWebView=function(context,widget_spec,id){SG.Widget.ReviewAppWebView.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ReviewAppWebView,SG.Widget.Base,{templates:{main:'<div class="sgw_review_app_web_view">'+'<div class="player_and_details">'+'<div class="player_wrapper">'+'<iframe id="fabric_player" style="position: absolute; top:0; z-index:6; width:100%; height:100%; display:none; border:0; background-image: url(\'/files/Fabric/Apps/Sample/UseCases/ModelReview/fabric-demo-gradient.png\')"></iframe>'+'</div>'+'<div class="webview_details">'+'<div id="{details_id}" style="width:100%;height:100%;"></div>'+'</div>'+'</div>'+'<div class="webview_timeline">'+'<div id="{timeline_id}" style="width:100%;height:100%;"></div>'+'</div>'+'</div>'},on_first_render:function(){this.container=this.get_container();this.timeline=this.get_child('timeline');this.details=this.get_child('details');var cfg={"timeline_id":this.timeline.get_container_id(),"timeline_class":this.timeline.get_css_class_name(),"details_id":this.details.get_container_id(),"details_class":this.details.get_css_class_name(),};this.container.update(this.templates.main.apply(cfg));this.main_div=this.container.child('div.sgw_review_app_web_view');this.player_wrapper_div=this.container.child('div.player_wrapper');var player_class;player_class=SG.ReviewAppPlayerVideoElement;this.player=this.new_component(player_class,{container:this.player_wrapper_div,version_load_callback:{fn:this.on_version_load,scope:this},parent:this});this.player.on('viewed_versions_changed',function(version_ids,current_version_id,progress){var details=this.get_child('details');if(details)
details.set_tool_context([{type:'Version',id:current_version_id}]);},this);SG.globals.review_app_player=this.player;this.player.render();this.timeline.render();this.details.render();},render_widget:function(){},view_versions:function(version_ids){this.version_ids=version_ids;SG.globals.review_app_player.view_versions(version_ids);},on_version_load:function(version_data_set){if(!version_data_set.count())return;this.main_div.addClass('details_open');this.details.render();var rec=version_data_set.get_record(0);var movie_url=rec.get('sg_uploaded_movie')?rec.get('sg_uploaded_movie').url:"";if(movie_url.match(/\.abc$/)){$('fabric_player').style.display='block';$('fabric_player').src="/files/Fabric/Apps/Sample/UseCases/AnimationReviewTool/index.html?url="+movie_url;this.get_child('details').set_tool_context([{type:'Version',id:rec.get('id')}]);}else{if($('fabric_player'))
$('fabric_player').style.display='none';}},});SG.ReviewAppRvVersionChecker=function(config){Ext.apply(this,config);SG.ReviewAppRvVersionChecker.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppRvVersionChecker,SG.Component,{reqd_pkg_major_ver:0,reqd_pkg_minor_ver:83,templates:{main:'<div class="sgw_review_app_rv_version_checker">'+'<div class="background">'+'<div class="message_box">'+'<div class="title">{title}</div>'+'<div class="message">{message}</div>'+'</div>'+'</div>'+'</div>',title:'Revolver for RV Package Out of Date',message:'The installed Revolver for RV package is not compatible with this version of Shotgun. '+'Revolver for RV <b>{expected_version}</b> or later is required, but '+'<b>{installed_version}</b> is installed. <br><br>Please ask your systems administrator '+'to download and install the most recent Revolver for RV package.'},render:function(){if(!this.rv_pkg_is_out_of_date())return;var reqd_ver=this.reqd_pkg_major_ver+'.'+this.reqd_pkg_minor_ver;var installed_ver_parts=this.installed_rv_pkg_ver();var installed_ver=installed_ver_parts?installed_ver_parts.join('.'):'an earlier version';var message=this.templates.message.apply({expected_version:reqd_ver,installed_version:installed_ver});var html=this.templates.main.apply({title:this.templates.title.apply(),message:message});this.container=Ext.DomHelper.append(document.body,html,true);this.message_box_div=this.container.child('div.message_box');this.background_div=this.container.child('div.background');this.message_width=350;this.message_height=200;this.message_box_div.setHeight(this.message_height);this.message_box_div.setWidth(this.message_width);this.on_window_resize();Ext.EventManager.onWindowResize(this.on_window_resize,this);},on_window_resize:function(){var x=Math.floor((this.background_div.getWidth()-this.message_width)/2);var y=Math.floor((this.background_div.getHeight()-this.message_height)/2);this.message_box_div.setXY([x,y]);},installed_rv_pkg_ver:function(){if(!sg_is_in_rv())return null;var result;try{result=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.packageVersion()');}catch(e){}
if(!result||result.length!==2)return null;return result;},rv_pkg_is_out_of_date:function(){if(!sg_is_in_rv())return false;var result=this.installed_rv_pkg_ver();if(!result)return true;if(result[0]<this.reqd_pkg_major_ver||result[0]===this.reqd_pkg_major_ver&&result[1]<this.reqd_pkg_minor_ver){return true;}
return false;}});SG.ReviewAppPlayerAnnotations=function(config){Ext.apply(this,config);SG.ReviewAppPlayerAnnotations.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerAnnotations,SG.Component,{templates:{canvas:'<canvas class="sgc_review_app_player_annotations_canvas"></canvas>',controls:'<div class="sgc_review_app_player_annotations_controls">'+'<div class="color_picker">'+'<img src="/images/pencil_cursor.png"/>'+'</div>'+'</div>'},destroy_component:function(){Ext.EventManager.removeListener(window,'mouseup',this.on_annotations_cancel,this);},on_first_render:function(){this.disabled=true;this.annotations={};this.version_ids=[];this.canvas_container.update(this.templates.canvas.apply());this.controls_container.update(this.templates.controls.apply());this.canvas=this.canvas_container.child('canvas');this.color_picker_div=this.controls_container.child('div.color_picker');this.pencil_icon=new Image();this.pencil_icon.src='/images/pencil_cursor.png';this.pencil_icon.onload=this.set_annotation_color.createDelegate(this,[localStorage.getItem('sgw_review_app_annotation_color')||'255,255,255']);this.pencil_icon_colored=this.controls_container.child('img');var ctx=this.canvas.dom.getContext('2d');this.tool=new this.tool_Pencil(ctx);this.tool.on_stop=this.on_annotation_done.createDelegate(this);this.add_event(this.player,'viewed_versions_changed',this.on_viewed_versions_changed);this.add_event(this.controls_container,'click',this.on_click);this.add_event(this.canvas,'mousedown',this.on_annotations_events,this,{preventDefault:true});this.add_event(this.canvas,'mouseup',this.on_annotations_events,this,{preventDefault:true});this.add_event(this.canvas,'mousemove',this.on_annotations_events,this,{preventDefault:true});this.add_event(this.canvas,'mouseout',this.on_annotations_events,this,{preventDefault:true});this.add_event(this.canvas,'mouseover',this.on_annotations_events,this,{preventDefault:true});Ext.EventManager.addListener(window,'mouseup',this.on_annotations_cancel,this);},render:function(){if(!this.rendered){this.on_first_render();this.rendered=true;}
this.render_annotations();},render_annotations:function(){var region=this.player.get_video_bounding_box();if(!region)return;var ctx=this.canvas.dom.getContext('2d');var annotated_frames=this.annotations[this.current_version_id];var annotated_frame=annotated_frames&&annotated_frames[this.frame];if(region.w&&region.h&&(this.canvas.dom.width!==region.w||this.canvas.dom.height!==region.h)){this.canvas.dom.width=region.w;this.canvas.dom.height=region.h;this.annotations_drawn=false;}else if(this.annotations_drawn||!annotated_frame){ctx.clearRect(0,0,this.canvas.dom.width,this.canvas.dom.height);this.annotations_drawn=false;}
if(ctx.lineWidth!==5)
ctx.lineWidth=5;if(!annotated_frame)
return;var bb=this.player.get_rendered_video_bounding_box();if(bb.w===0||bb.h===0)
return;ctx.drawImage(annotated_frame.annotation_buffer,bb.x,bb.y,bb.w,bb.h);this.annotations_drawn=true;},has_annotated_frames:function(){var version_id,frame;for(version_id in this.annotations)
if(this.annotations.hasOwnProperty(version_id))
for(frame in this.annotations[version_id])
if(this.annotations[version_id].hasOwnProperty(frame)&&!this.annotations[version_id][frame]['already_uploaded'])
return true;return false;},list_annotated_frames:function(version_id){var frames=[];if(!this.annotations[version_id])return[];var frame;for(frame in this.annotations[version_id])
frames.push(Number(frame));return frames;},upload_annotated_frames_to_note:function(note_id)
{var frames=[];var version_id,frame,annotation;for(version_id in this.annotations){if(this.annotations.hasOwnProperty(version_id)){for(frame in this.annotations[version_id]){if(this.annotations[version_id].hasOwnProperty(frame)){if(!this.annotations[version_id][frame]['already_uploaded']){this.annotations[version_id][frame]['already_uploaded']=true;annotation=this.annotations[version_id][frame];var f=document.createElement('canvas');f.width=800;f.height=Math.round((annotation['video_buffer'].height/annotation['video_buffer'].width)*f.width);var ctx=f.getContext('2d');ctx.drawImage(annotation['video_buffer'],0,0,f.width,f.height);ctx.drawImage(annotation['annotation_buffer'],0,0,f.width,f.height);frames.push({frame:'annot_version_'+version_id+'.'+frame+'.png',data_url:f.toDataURL()});}}}}}
if(frames.length>0){var me=this;Ext.Ajax.request({method:'POST',url:'/page/review_app_attach_annotations',params:{note_id:note_id,annotations:JSON.stringify(frames)},callback:function(options,success,response){if(success)
me.player.on_note_upload_complete(note_id);else
me.player.on_note_upload_error(note_id);}});}},clear_annotation:function(version_id,frame){if(!this.annotations[version_id]||!this.annotations[version_id][frame])return;delete this.annotations[version_id][frame];this.render();},on_click:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.color_picker'));if(elem){this.show_color_picker();return;}},on_annotations_events:function(event){if(event.type==='mousedown'&&!this.player.paused()){this.player.pause();}
if(this.tool&&this.tool[event.type]){var canvas_xy=this.canvas.getXY();var xy=event.getXY();this.tool[event.type](xy[0]-canvas_xy[0],xy[1]-canvas_xy[1]);}},on_annotation_done:function(){if(this.disabled)return;if(!this.annotations[this.current_version_id])
this.annotations[this.current_version_id]={};if(!this.annotations[this.current_version_id][this.frame])
this.annotations[this.current_version_id][this.frame]={};this.annotations[this.current_version_id][this.frame]['already_uploaded']=false;var dom_elem=this.player.get_video_data();var bb=this.player.get_rendered_video_bounding_box();var buffer;if(!this.annotations[this.current_version_id][this.frame].hasOwnProperty('video_buffer')){buffer=document.createElement('canvas');buffer.height=bb.h;buffer.width=bb.w;buffer.getContext('2d').drawImage(dom_elem,bb.x,bb.y,bb.w,bb.h,0,0,bb.w,bb.h);this.annotations[this.current_version_id][this.frame]['video_buffer']=buffer;}
buffer=this.annotations[this.current_version_id][this.frame].annotation_buffer;if(!buffer){buffer=document.createElement('canvas');buffer.height=bb.h;buffer.width=bb.w;this.annotations[this.current_version_id][this.frame].annotation_buffer=buffer;}
buffer.getContext('2d').drawImage(this.canvas.dom,bb.x,bb.y,bb.w,bb.h,0,0,buffer.width,buffer.height);this.annotations_drawn=true;this.player.on_frame_annotated(this.current_version_id,this.frame);},on_annotations_cancel:function(event){if(this.tool){this.tool.started_when_mouseout=false;}},tool_Pencil:function(ctx){var tool=this;tool.ctx=ctx;tool.started=false;tool.started_when_mouseout=false;tool.path=[];tool.recording=true;tool.last_x=false;tool.last_y=false;this.mousedown=function(x,y){tool.recording=true;tool.start(x,y);Ext.EventManager.addListener(document,'mouseup',tool.stop,this,{single:true});};this.mousemove=function(x,y){tool.lineTo(x,y);};this.mouseup=function(x,y){tool.stop();};this.mouseout=function(x,y){if(tool.started){tool.started_when_mouseout=true;tool.stop();};};this.mouseover=function(x,y){if(tool.started_when_mouseout){tool.start(x,y);};};this.start=function(x,y){tool.started=true;tool.ctx.strokeStyle="rgb("+tool.annotation_color+")";tool.last_x=x;tool.last_y=y;tool.ctx.beginPath();tool.ctx.moveTo(tool.last_x,tool.last_y);if(tool.recording){tool.path.push(tool.annotation_color);tool.path.push([x,y]);};};this.lineTo=function(x,y){if(tool.started){tool.ctx.lineTo(x,y);tool.ctx.stroke();tool.last_x=x;tool.last_y=y;if(tool.recording){tool.path.push([x,y]);}}};this.stop=function(){if(tool.started){tool.started=false;if(tool.path.length<=2){tool.path=[];return;}
if(tool.on_stop){tool.on_stop();}}};},show_color_picker:function(el)
{if(this.active_picker){this.active_picker.color_editor_el.remove();this.active_picker.destroy();this.active_picker=null;return;}
this.active_picker=new SG.ColorPicker({container:this.controls_container,cell_element:this.color_picker_div,initial_value:this.tool.annotation_color,edit_callback:{fn:this.on_color_picked,scope:this}});},on_color_picked:function(color)
{localStorage.setItem('sgw_review_app_annotation_color',color);this.set_annotation_color(color);this.active_picker=null;},set_annotation_color:function(color)
{if(!this.pencil_icon.complete)
return;this.tool.annotation_color=color;var canvas=document.createElement('canvas');canvas.width=this.pencil_icon.width;canvas.height=this.pencil_icon.height;ctx=canvas.getContext("2d");ctx.drawImage(this.pencil_icon,0,0);ctx.fillStyle="rgb("+color+")";ctx.beginPath();ctx.moveTo(6,5);ctx.lineTo(13,12);ctx.lineTo(11,14);ctx.lineTo(4,6);ctx.fill();this.pencil_icon_colored.dom.src=canvas.toDataURL();this.canvas.dom.style.cursor="url("+this.pencil_icon_colored.dom.src+") 0 0, crosshair";},on_viewed_versions_changed:function(version_ids,current_version_id,progress){if(JSON.stringify(version_ids)!==JSON.stringify(this.version_ids)){var i;for(i=0;i<this.version_ids.length;i++)
if(this.annotations[this.version_ids[i]]&&version_ids.indexOf(this.version_ids[i])<0)
delete this.annotations[this.version_ids[i]];this.version_ids=sg_deep_copy(version_ids);}
var range_hash;if(current_version_id)
range_hash=this.player.get_frame_range_for_version(current_version_id);if(!current_version_id||!range_hash){this.current_version_id=null;this.progress=0;this.render_annotations();return;}
var offset=((range_hash.end_frame-range_hash.start_frame)*progress).toFixed(6);var frame=range_hash.start_frame+Math.floor(offset);if(this.current_version_id!==current_version_id||this.frame!==frame){this.current_version_id=current_version_id;this.frame=frame;this.tool.path=[];this.render_annotations();}},disable:function(){if(this.disabled)return;this.canvas.dom.style.cursor='default';this.disabled=true;this.color_picker_div.removeClass('displayed');this.canvas.removeClass('displayed');},enable:function(){if(!this.disabled)return;this.set_annotation_color(localStorage.getItem('sgw_review_app_annotation_color')||'255,255,255');this.disabled=false;this.color_picker_div.addClass('displayed');this.canvas.addClass('displayed');}});SG.ReviewAppPlayerController=function(config){Ext.apply(this,config);SG.ReviewAppPlayerController.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerController,SG.Component,{templates:{main:'<div class="sgc_review_app_player_controller">'+'<div class="play_pause"></div>'+'<div class="timeline_wrapper">'+'<div class="timeline"></div>'+'<div class="annotations"></div>'+'</div>'+'<div class="frame_rate"></div>'+'</div>',annotation_marker:'<div class="annotation_marker_wrapper" frame="{frame}" version_id="{version_id}">'+'<div class="annotation_marker"></div>'+'</div>',timeline_segment:'<div class="segment {extra_classes}" style="width: {width}px;" version_id="{version_id}">'+'<div class="buffer_range" style="opacity: 0;"></div>'+'</div>'},on_first_render:function(){this.version_ids=[];this.duration={};this.container.update(this.templates.main.apply());this.main_div=this.container.child('div.sgc_review_app_player_controller');this.play_pause_button=this.container.child('div.play_pause');this.timeline_div=this.container.child('div.timeline');this.annotations_div=this.container.child('div.annotations');this.frame_rate_div=this.container.child('div.frame_rate');this.add_event(this.player,'play_state_changed',this.on_play_state_changed);this.add_event(this.player,'viewed_versions_changed',this.on_viewed_versions_changed);this.add_event(this.player,'frame_annotated',this.render_timeline);this.add_event(this.player,'buffer_progress_changed',this.on_buffer_progress_changed);this.add_event(this.container,'click',this.on_click);this.add_event(this.container,'mousedown',this.on_mousedown);this.add_event(this.container,'mouseover',this.on_mouseover);this.add_event(this.container,'mouseout',this.on_mouseout);var doc_elem=Ext.get(document);doc_elem.on('keydown',this.on_keydown,this);doc_elem.on('keyup',this.on_keyup,this);},render:function(){if(!this.rendered){this.on_first_render();this.rendered=true;}
this.render_timeline();},render_timeline:function(){var total_width=this.timeline_div.getWidth();this.timeline_rendered=false;if(total_width===0)return;var timeline_html='';var i,total_width;if(this.version_ids.length>0){var total_duration=0;for(i=0;i<this.version_ids.length;i++)
total_duration+=this.get_duration_for_version(this.version_ids[i]);var sum_widths=0;var width,dur;for(i=0;i<this.version_ids.length;i++){dur=this.get_duration_for_version(this.version_ids[i]);if(i===this.version_ids.length-1)
width=total_width-sum_widths;else
width=Math.floor(dur/total_duration*total_width);sum_widths+=width;timeline_html+=this.templates.timeline_segment.apply({width:width,extra_classes:i%2?'light_bg':'',version_id:this.version_ids[i]});}
this.timeline_rendered=true;}
this.playhead_div=null;this.timeline_div.update(timeline_html);this.version_segment_map={};var segment,xy,segment_width;for(i=0;i<this.version_ids.length;i++){segment=this.timeline_div.child('div.segment[version_id='+this.version_ids[i]+']');if(!segment)continue;xy=segment.getXY();segment_width=segment.getWidth();this.version_segment_map[this.version_ids[i]]={elem:segment,xy:xy,width:segment_width,height:segment.getHeight()};}
var progress=this.player.get_progress();if(progress&&progress.version_id>-1){this.current_version_id=progress.version_id;this.progress=progress.progress;}else{this.current_version_id=null;this.progress=0;}
this.render_playhead();this.render_buffer_range();this.annotations_div.update('');var count=0;var version_id,frames,range,dur,j,marker,offset,x,segment_hash,bb,progress;for(i=0;i<this.version_ids.length;i++){version_id=this.version_ids[i];frames=this.player.list_annotated_frames(i);if(!frames.length)continue;range=this.frame_ranges[version_id];for(j=0;j<frames.length;j++){marker=Ext.DomHelper.append(this.annotations_div,this.templates.annotation_marker.apply({version_id:version_id,frame:frames[j]}),true);progress=0;if(range.end_frame>range.start_frame)
progress=(frames[j]-range.start_frame)/(range.end_frame-range.start_frame);bb=this.get_playhead_bb_for_progress(version_id,progress);if(bb===null)continue;x=bb.x+0.5*(bb.w-marker.getWidth());marker.dom.setAttribute('style','left: '+x+'px; top: '+(count*-marker.getHeight())+'px;');count++;}}},get_playhead_bb_for_progress:function(version_id,progress){var segment_hash=this.version_segment_map&&this.version_segment_map[version_id];var segment=segment_hash&&segment_hash.elem;if(!segment)return null;var dur=this.get_duration_for_version(version_id);var segment_x=segment_hash.xy[0];var segment_width=segment_hash.width;var frame_width=Math.floor(segment_width/dur);var playhead_width=Math.max(8,frame_width);var first_version_hash=this.version_segment_map[this.version_ids[0]];first_version_x=0;if(first_version_hash)
first_version_x=first_version_hash.xy[0];var min_x=(segment_x-first_version_x)+playhead_width/2;var max_x=(segment_x-first_version_x)+segment_width-playhead_width/2;var x=(segment_x-first_version_x)+Math.floor(playhead_width/2+(segment_width-playhead_width)*progress);x=Math.min(max_x,Math.max(x,min_x))-playhead_width/2;return{x:x,y:-segment_hash.height,w:playhead_width,h:segment_hash.height};},render_playhead:function(){if(!this.playhead_div)
this.playhead_div=Ext.DomHelper.append(this.timeline_div,{tag:'div',cls:'playhead'},true);if(!this.current_version_id){this.playhead_div.setDisplayed(false);return;}
this.playhead_div.setDisplayed(true);var bb=this.get_playhead_bb_for_progress(this.current_version_id,this.progress);if(bb===null)return;var style='width: '+bb.w+'px; left: '+bb.x+'px; top: '+bb.y+'px;';this.playhead_div.dom.setAttribute('style',style);},render_buffer_range:function(){var buffer_ranges=this.player.get_buffer_ranges_for_loaded_versions();var i,buffer_range_div,percent_buffered;for(i=0;i<buffer_ranges.length;i++){buffer_range_div=this.timeline_div.child('div.segment[version_id='+buffer_ranges[i]['version_id']+'] > div.buffer_range');if(!buffer_range_div)continue;percent_buffered=Number(buffer_ranges[i]['percent_buffered']);buffer_range_div.setWidth(percent_buffered.toString()+'%');if(percent_buffered===100){if(buffer_range_div.getStyle('opacity')==='1')
buffer_range_div.setOpacity(0,{duration:0.2});}else{buffer_range_div.setOpacity(1);}}},render_frame_rate:function(frame_rate){this.frame_rate_div.update(Math.floor(frame_rate)+' fps');},on_click:function(e){var target=Ext.get(e.getTarget());var elem=target.findParent('div.play_pause');if(elem){if(this.player.paused())
this.player.play();else
this.player.pause();return;}
elem=Ext.get(target.findParent('div.annotation_marker_wrapper.delete'));if(elem){var version_id=Number(elem.dom.getAttribute('version_id'));var frame=Number(elem.dom.getAttribute('frame'));this.player.clear_annotation(version_id,frame);this.player.render();this.render_timeline();return;}},on_mousedown:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.annotation_marker_wrapper.delete'));if(elem)return;elem=target.findParent('div.timeline_wrapper');if(elem){this.player.pause();this.on_mousemove(e);var doc_elem=Ext.get(document);doc_elem.on('mousemove',this.on_mousemove,this,{preventDefault:true});doc_elem.on('mouseup',function(){doc_elem.un('mousemove',this.on_mousemove);},this,{single:true});return;}},on_mousemove:function(e){e.preventDefault();var xy=e.getXY();var segments=sg_find_all('div.segment',this.timeline_div.dom);var segment;var i,s;for(i=0;i<segments.length;i++){s=Ext.get(segments[i]);if(s.getX()<xy[0]&&s.getX()+s.getWidth()>=xy[0]){segment=s;break;}}
if(!segment){var first_segment=Ext.get(segments[0]);var last_segment=Ext.get(segments[segments.length-1]);if(xy[0]<first_segment.getX())
segment=first_segment;else if(xy[0]>first_segment.getX()+first_segment.getWidth())
segment=last_segment;else
return;}
var version_id=Number(segment.dom.getAttribute('version_id'));var dur=this.get_duration_for_version(version_id);var playhead_width=Math.floor(segment.getWidth()/dur);var x=xy[0]-segment.getXY()[0];var progress=Math.max(0,Math.min(1,x/segment.getWidth()));this.player.set_progress_for_version_id(version_id,progress);},on_mouseover:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.annotation_marker_wrapper',this.timeline_div));if(elem){this.moused_over_marker=elem;if(e.browserEvent.altKey)
elem.addClass('delete');return;}},on_mouseout:function(e){var target=Ext.get(e.getTarget());var elem=Ext.get(target.findParent('div.annotation_marker_wrapper',this.timeline_div));if(elem){this.moused_over_marker=null;elem.removeClass('delete');}},on_keydown:function(e){var key=e.getKey();if(key===18&&this.moused_over_marker){this.moused_over_marker.addClass('delete');return;}},on_keyup:function(e){var key=e.getKey();if(key===18&&this.moused_over_marker){this.moused_over_marker.removeClass('delete');return;}},on_play_state_changed:function(playing){if(playing)
this.play_pause_button.addClass('playing')
else
this.play_pause_button.removeClass('playing');},on_viewed_versions_changed:function(version_ids,current_version_id,progress){var do_render_playhead=false;if(JSON.stringify(version_ids)!==JSON.stringify(this.version_ids)){var frame_ranges={};this.version_ids=[];this.frame_ranges={};var i,range_hash;for(i=0;i<version_ids.length;i++){range_hash=this.player.get_frame_range_for_version(version_ids[i]);if(!range_hash)
continue;this.version_ids.push(version_ids[i]);this.frame_ranges[version_ids[i]]=range_hash;}
this.render_timeline();}else if(!this.timeline_rendered){this.render_timeline();}else{do_render_playhead=true;}
this.current_version_id=current_version_id;this.progress=progress;if(this.timeline_rendered&&do_render_playhead){this.render_playhead();this.render_buffer_range();}},on_buffer_progress_changed:function(){this.render_buffer_range();},get_duration_for_version:function(version_id){var range_hash=this.frame_ranges[version_id];if(!range_hash)return null;return range_hash.end_frame-range_hash.start_frame+1;},hide:function(){this.main_div.removeClass('displayed');},show:function(){this.main_div.addClass('displayed');}});SG.ReviewAppPlayer=function(config){Ext.apply(this,config);SG.ReviewAppPlayer.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayer,SG.Component,{player_name:'Revolver',init_component:function(){this.events={viewed_versions_changed:true,updates_enabled_changed:true,note_upload_complete:true,note_upload_error:true,note_upload_progress:true,docked_state_changed:true,loading_changed:true};},status:{UNAVAILABLE:0,PROCESSING:1,READY:2},get_loaded_versions:function(){},get_viewed_versions:function(){},get_buffer_ranges_for_loaded_versions:function(){},get_progress:function(){},view_versions:function(version_ids){},get_required_version_columns:function(){return[];},get_record_status:function(record){return this.status.UNAVAILABLE;},supports_comparison:function(){return false;},compare_versions:function(version_ids){},supports_version_swap_for_entities:function(){return false;},version_loaded_for_entity:function(entity){},swap_version_for_entity:function(version_id,entity){},get_update_frequency:function(){return-1;},open_external_browser:function(url){window.open(url);},can_toggle_annotation_mode:function(){return false;},toggle_annotation_mode:function(){return;},has_annotated_frames:function(){return false;},upload_annotated_frames_to_note:function(note_id){},has_embedded_panes:function(){return false;},pane_is_docked:function(pane){},dock_pane:function(pane){},tear_off_pane:function(pane){},close_pane:function(pane){},on_docked_state_changed:function(docked){this.fireEvent('docked_state_changed',docked);},on_note_upload_complete:function(note_id){this.fireEvent('note_upload_complete',note_id);},on_note_upload_error:function(note_id,error_message){this.fireEvent('note_upload_error',note_id,error_message);},on_note_upload_progress:function(note_id,complete_ratio){this.fireEvent('note_upload_progress',note_id,complete_ratio);},on_loading_changed:function(loading){this.fireEvent('loading_changed',loading);},on_viewed_versions_changed:function(version_ids,current_version_id,progress){if(!this.skip_record_viewed_version_event&&current_version_id&&this.current_version_id!==current_version_id){var options={url:'/page/review_app_view_versions',params:{version_ids:[current_version_id],player:this.player_name}};var conn=new Ext.data.Connection();conn.request(options);this.current_version_id=current_version_id;}
this.fireEvent('viewed_versions_changed',version_ids,current_version_id,progress);},on_updates_enabled_changed:function(enabled){this.fireEvent('updates_enabled_changed',enabled);}});SG.ReviewAppPlayerRV=function(config){Ext.apply(this,config);SG.ReviewAppPlayerRV.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerRV,SG.ReviewAppPlayer,{player_name:'Revolver for RV',init_component:function(){SG.ReviewAppPlayerRV.superclass.init_component.call(this);this.rv_pkg_checker=this.new_component(SG.ReviewAppRvVersionChecker,{});if(this.rv_pkg_checker.rv_pkg_is_out_of_date()){this.rv_pkg_checker.render();return;}
Ext.get(document).on('keydown',this.on_keydown,this);var me=this;SG.ReviewApp.Utils.register_rv_callback(function(name,contents,sender){me.on_rv_event(name,contents,sender);},['sg-source-frame-changed','sg-updates-disabled','sg-updates-enabled','sg-flagged-state-changed','sg-pane-top-level-changed','sg-focus-search-field','sg-note-attachment-progress-updated','sg-attachment-upload-error','sg-all-note-uploads-complete']);SG.NotificationCenter.add_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});},get_loaded_versions:function(){var viewed_version_ids=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().allShotgunSources()');if(!viewed_version_ids||viewed_version_ids[0]===-1)
return[];return viewed_version_ids;},get_viewed_versions:function(){var version_ids=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().currentShotgunSources();');if(!version_ids||version_ids[0]===-1)
return[];return version_ids;},get_progress:function(){var result=SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().playheadPosition();');if(!result||result[0]===-1)
return null;return{version_id:result[0],progress:result[1]};},view_versions:function(version_ids){SG.ReviewApp.Utils.rv_eval('setViewNode("defaultSequence");');SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().sessionFromVersionIds(int[] {'+
version_ids.join(', ')+'});');var url=window.location.protocol+'//'+window.location.host+'/page/review_app_details';SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().openPaneToUrl("'+url+'", "Right", 450);');},get_required_version_columns:function(){return['sg_path_to_frames','sg_path_to_movie'];},get_record_status:function(record){if(record.get('sg_path_to_frames')||record.get('sg_path_to_movie'))
return this.status.READY;return this.status.UNAVAILABLE;},supports_comparison:function(){return true;},compare_versions:function(version_ids){SG.ReviewApp.Utils.rv_eval('setViewNode("defaultSequence");');SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().compareFromVersionIds(int[] {'+
version_ids.join(', ')+'})');},supports_version_swap_for_entities:function(){return true;},version_loaded_for_entity:function(entity){var cmd='shotgun_review_app.theMode().sourceFromEntity("'+entity.type+'", '+entity.id+')';return SG.ReviewApp.Utils.rv_eval(cmd);},swap_versions_for_entities:function(version_ids,entities){var found_sources=[];var found_version_ids=[];var i;for(i=0;i<entities.length;i++){var cmd='shotgun_review_app.theMode().sourceFromEntity("'+entities[i].type+'", '+entities[i].id+')';var source_name=SG.ReviewApp.Utils.rv_eval(cmd);if(source_name){found_sources.push(source_name);found_version_ids.push(version_ids[i]);}}
if(!found_sources.length)return;cmd='shotgun_review_app.theMode().swapVersionsForSources(string[] {"'+found_sources.join('", "')+'"}, int[] {'+found_version_ids.join(', ')+'})';SG.ReviewApp.Utils.rv_eval(cmd);},get_update_frequency:function(){return SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().getUpdateFrequency();');},open_external_browser:function(url){SG.ReviewApp.Utils.rv_eval('openUrl("'+url+'")');},can_toggle_annotation_mode:function(){return true;},toggle_annotation_mode:function(){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().toggleAnnotationTools();');},has_annotated_frames:function(){return SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().hasAnnotatedFramesToUpload();');},upload_annotated_frames_to_note:function(note_id){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().uploadAnnotatedFramesToNote('+
note_id+')');},has_embedded_panes:function(){return true;},pane_is_docked:function(pane){return!SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().paneIsFloating("'+pane+'")');},dock_pane:function(pane){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().setFloating("'+pane+'", false);');},tear_off_pane:function(pane){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().setFloating("'+pane+'", true);');},close_pane:function(pane){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().closePane("'+pane+'");');},on_keydown:function(e){if(SG.GlobalNav.__ignore(e))
return;e.stopEvent();var key=e.getKey();if(key===Ext.EventObject.SPACE){SG.ReviewApp.Utils.rv_eval('use extra_commands; togglePlay();');return;}
if(key===81||key===83){SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().focusSearchField(nil)');return;}
if(key===Ext.EventObject.DOWN&&e.shiftKey){if(e.altKey)
SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().previousFlaggedVersion(nil)');else
SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().previousVersion(nil)');return;}
if(key===Ext.EventObject.UP&&e.shiftKey){if(e.altKey)
SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().nextFlaggedVersion(nil)');else
SG.ReviewApp.Utils.rv_eval('shotgun_review_app.theMode().nextVersion(nil)');return;}},on_rv_event:function(name,content,sender){var event_contents;if(name==='sg-source-frame-changed'){event_contents=content.split('|');var viewed_version_ids=SG.ReviewApp.Utils.parse_mu_result(event_contents[0]);var playhead_pos=SG.ReviewApp.Utils.parse_mu_result(event_contents[1]);var current_version_id,progress;if(playhead_pos&&playhead_pos[0]!==-1){current_version_id=playhead_pos[0];progress=playhead_pos[1];}
this.on_viewed_versions_changed(viewed_version_ids,current_version_id,progress);return;}
if(['sg-updates-enabled','sg-updates-disabled'].indexOf(name)>-1){var enabled=name==='sg-updates-enabled';this.on_updates_enabled_changed(enabled);return;}
if(name==='sg-flagged-state-changed'){var parts=content.split("|");var record_ids=SG.ReviewApp.Utils.parse_mu_result(parts[0]);var sender=SG.ReviewApp.Utils.parse_mu_result(parts[1]);if(!record_ids.length)return;SG.NotificationCenter.post({uuid:'_review_app_utils_',name:'flagged_state_changed',args:{version_ids:record_ids,sender:sender,rv_ignore:true}});return;}
if(name==='sg-pane-top-level-changed'){var event_contents=content.split(';');var pane_name=event_contents[0];var floating=Number(event_contents[1]);this.on_docked_state_changed(!floating);return;}
if(name==='sg-focus-search-field'&&this.browser_pane){this.browser_pane.search_field.quick_key_focus();return;}
if(name==='sg-note-attachment-progress-updated'){event_contents=content.split(';');note_id=Number(event_contents[0]);var completion_ratio=Number(event_contents[1]);if(completion_ratio)
this.on_note_upload_progress(note_id,completion_ratio);return;}
if(name==='sg-all-note-uploads-complete'){note_id=Number(content);this.on_note_upload_complete(note_id);return;}
if(name==='sg-attachment-upload-error'){event_contents=content.split(';');note_id=Number(event_contents[0]);var error=event_contents[1];this.on_note_upload_error(note_id,error);return;}},on_flagged_state_changed:function(args){var record_ids=args.version_ids;if(args.rv_ignore||!record_ids.length)return;var sender=args.sender;var cmd='shotgun_review_app.theMode().flaggedStateChanged(int[]{'+record_ids.join(',')+'}, "'+sender+'")';SG.ReviewApp.Utils.rv_eval(cmd);},});SG.ReviewAppPlayerHtml5=function(config){Ext.apply(this,config);SG.ReviewAppPlayerHtml5.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerHtml5,SG.ReviewAppPlayer,{templates:{main:'<div class="sgw_review_app_html5_player_loading" style="display: none;"></div>'+'<div class="sgw_review_app_html5_player_annotations_wrapper"></div>'+'<div class="sgw_review_app_html5_player_annotations_controls"></div>'+'<div class="sgw_review_app_html5_player_controller"></div>',thumb:'/file_serve/{image}'},timeline_media:[],player_name:'Revolver Web Player',init_component:function(){SG.ReviewAppPlayerHtml5.superclass.init_component.call(this);this.events.play_state_changed=true;this.events.frame_annotated=true;this._paused=true;var vid=document.createElement('video');this.can_play_mp4=false;this.can_play_webm=false;if(vid.canPlayType){if(vid.canPlayType('video/mp4'))
this.can_play_mp4=true;if(vid.canPlayType('video/webm'))
this.can_play_webm=true;}
Ext.fly(vid).remove();this.is_safari=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);},destroy_component:function(){var i,media;for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];if(media.dom){media.dom.pause();Ext.get(media.dom).remove();delete media.dom;};}
this.timeline_media=[];},setup_keyboard_shortcuts:function(){this.keyboard_shortcut_callbacks={};this.keyboard_shortcut_callbacks[32]={fn:this.toggle_playback,scope:this};this.keyboard_shortcut_callbacks[37]={fn:this.frame_backward,scope:this};this.keyboard_shortcut_callbacks[39]={fn:this.frame_forward,scope:this};var doc_elem=Ext.get(document);this.add_event(doc_elem,'keydown',this.on_keydown);Ext.EventManager.removeResizeListener(this.render,this);},on_first_render:function(){this.touch_interface=navigator.userAgent.match(/(iPod|iPhone|iPad)/);this.container.update(this.templates.main.apply());this.on_first_render_video();this.controller_container=this.container.child('div.sgw_review_app_html5_player_controller');this.controller=this.new_component(SG.ReviewAppPlayerController,{player:this,container:this.controller_container});this.controller.render();this.ann_canvas_container=this.container.child('div.sgw_review_app_html5_player_annotations_wrapper');this.ann_controls_container=this.container.child('div.sgw_review_app_html5_player_annotations_controls');if(this.touch_interface){this.ann_canvas_container.setDisplayed(false);this.ann_controls_container.setDisplayed(false);}else{this.annotations=this.new_component(SG.ReviewAppPlayerAnnotations,{player:this,canvas_container:this.ann_canvas_container,controls_container:this.ann_controls_container});this.annotations.render();}
this.setup_keyboard_shortcuts();Ext.EventManager.onWindowResize(this.render,this);var requestAnimationFrame=function(callback){window.setTimeout(function(){callback(Date.now());},1000/60);};var me=this;var step=function(timestamp){me.update_current_frame(timestamp);requestAnimationFrame(step);};requestAnimationFrame(step);},render:function(){if(!this.rendered){this.on_first_render();this.rendered=true;}
this.render_video();var now=Date.now();if(!this.paused())
this.render_frame_rate(now);this.last_rendered=now;if(this.container.getWidth()!==this.container_width||this.container.getHeight()!==this.container_height){this.container_width=this.container.getWidth();this.container_height=this.container.getHeight();if(!this.touch_interface){this.controller.render();this.annotations.render();}}},render_frame_rate:function(timestamp){if(!this.last_rendered)return;if(!this.frame_rates)
this.frame_rates=[];this.frame_rates.push(1000/(timestamp-this.last_rendered));if(!this.last_rendered_frame_rate){this.last_rendered_frame_rate=timestamp;return;}
if(this.last_rendered_frame_rate&&timestamp-this.last_rendered_frame_rate>250){var average_frame_rate=0;var i;for(i=0;i<this.frame_rates.length;i++)
average_frame_rate+=this.frame_rates[i];average_frame_rate=average_frame_rate/this.frame_rates.length;this.controller.render_frame_rate(average_frame_rate);this.frame_rates=[];this.last_rendered_frame_rate=Date.now();}},render_watermark:function(clear){if(!SG.globals.preferences.enable_revolver_watermarking||SG.globals.current_user.can_use_revolver_without_watermarking)
return;var media=this.timeline_idx>-1&&this.timeline_media[this.timeline_idx];if(!media)return;var video_elem=this.get_video_elem();if(!video_elem){return;}else if(video_elem.readyState<2){Ext.get(video_elem).on('loadeddata',function(){this.render_watermark(clear);},this,{single:true});return;}
if(!this.watermark_canvas){this.watermark_canvas=document.createElement('canvas');this.watermark_canvas_ctx=this.watermark_canvas.getContext('2d');}
var width=this.watermark_target_canvas.dom.width;var height=this.watermark_target_canvas.dom.height;if(width===0||height===0)return;if(this.watermark_canvas.width!==width||this.watermark_canvas.height!==height){this.watermark_canvas.width=width;this.watermark_canvas.height=height;var ctx=this.watermark_canvas_ctx;var font_size=200;var font=font_size+'px Helvetica';if(ctx.font!==font)
ctx.font=font;var name=SG.globals.current_user.login;var text_width=ctx.measureText(name).width;var bb=this.get_rendered_video_bounding_box();var diag=Math.floor(Math.pow(bb.w*bb.w+bb.h*bb.h,0.5));var angle=-Math.atan(bb.h/bb.w);var max_width=diag-font_size*bb.w/bb.h;if(text_width>max_width){while(text_width>max_width){font_size--;ctx.font=font_size+'px Helvetica';max_width=diag-font_size*bb.w/bb.h;text_width=ctx.measureText(name).width;}}
ctx.save();ctx.translate(bb.x+bb.w/2,bb.y+bb.h/2);ctx.rotate(angle);ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='rgb(0, 0, 0)';ctx.lineWidth=Math.ceil(font_size/20);ctx.strokeStyle='rgb(255, 255, 255)';ctx.strokeText(name,0,0);ctx.fillText(name,0,0);ctx.stroke();ctx.restore();}
if(!this.watermark_target_canvas_ctx)
this.watermark_target_canvas_ctx=this.watermark_target_canvas.dom.getContext('2d');if(clear)
this.watermark_target_canvas_ctx.clearRect(0,0,width,height);this.watermark_target_canvas_ctx.save();this.watermark_target_canvas_ctx.globalAlpha=0.12;this.watermark_target_canvas_ctx.drawImage(this.watermark_canvas,0,0);this.watermark_target_canvas_ctx.restore();},on_keydown:function(e){if(e.shiftKey)
return;var key=e.getKey();if(!(key in this.keyboard_shortcut_callbacks))
return;if(SG.GlobalNav.__ignore(e))
return;e.stopEvent();var callback=this.keyboard_shortcut_callbacks[key];callback.fn.call(callback.scope);},view_versions:function(version_ids){this.show_loading();var versions_data=this.new_data_set('Version',function(){this.on_version_load(version_ids,versions_data)});var filters={logical_operator:'and',conditions:[{path:'id',relation:'in',values:version_ids}]};var spec={type:'Version',filters:filters,columns:['code','sg_uploaded_movie','sg_uploaded_movie_webm','sg_uploaded_movie_mp4','entity','sg_uploaded_movie_frame_rate','sg_first_frame','sg_last_frame','sg_movie_has_slate','entity.Shot.sg_cut_in','entity.Shot.sg_cut_out','image'],result:versions_data};SG.Repo.query(spec);},on_version_load:function(version_ids,versions_data){var rec=versions_data.get_record(0);var movie_url=rec.get('sg_uploaded_movie')?rec.get('sg_uploaded_movie').url:"";if(!movie_url.match(/\.abc$/))
this.load_versions(version_ids,versions_data);else
this.hide_loading();if(this.version_load_callback)
this.version_load_callback.fn.call(this.version_load_callback.scope,versions_data);},load_versions:function(version_ids,versions_data){this.pause();this.clear();this.timeline_idx=-1;this.timeline_media=[];var rec,media;for(var i=0;i<version_ids.length;i++){rec=versions_data.get_record_by_id(version_ids[i]);media={};media.record=rec;media.version_id=rec.get('id');media.code=rec.get('code');media.first_frame=rec.get('sg_first_frame');media.last_frame=rec.get('sg_last_frame');media.fps=rec.get('sg_uploaded_movie_frame_rate')||24;media.has_slate=rec.get('sg_movie_has_slate');media.cut_in=rec.get('entity.Shot.sg_cut_in');media.cut_out=rec.get('entity.Shot.sg_cut_out');media.h264_url=rec.get('sg_uploaded_movie_mp4')?rec.get('sg_uploaded_movie_mp4').url:"";media.webm_url=rec.get('sg_uploaded_movie_webm')?rec.get('sg_uploaded_movie_webm').url:"";media.poster_frame=rec.get('image')&&this.templates.thumb.apply({image:rec.get('image')}),media.is_pdf=rec.get('sg_uploaded_movie')?/\.pdf$/i.test(rec.get('sg_uploaded_movie').url):false;this.timeline_media[i]=media;}
this.preload_media();},preload_media:function(){var make_play_state_changed_callback=function(video,state){return function(e){var media=this.timeline_media[this.timeline_idx];if(media&&media.dom===video.dom){if(this.is_safari&&!state)
video.dom.currentTime=video.dom.currentTime;if(!state&&!this._paused){video.dom.play();return;}
this.on_play_state_changed(state);}};};var to_remove=[];var no_video=true;var i,src_elem,video,media;for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];video=Ext.get(document.createElement('video'));video.dom.preload='auto';video.addClass('active');if(media.poster_frame)
video.dom.poster=media.poster_frame;if(this.touch_interface){video.dom.controls=true;video.dom.loop=true;}
video.on('play',make_play_state_changed_callback(video,true),this);video.on('pause',make_play_state_changed_callback(video,false),this);media.dom=video.dom;if(this.touch_interface){video.on('load',function(){this.on_metadata_loaded();this.on_data_loaded();},this,{single:true});}else{video.on('loadedmetadata',this.on_metadata_loaded,this,{single:true});video.on('loadeddata',this.on_data_loaded,this,{single:true});video.on('progress',this.on_buffer_progress_changed,this);}
if(media.h264_url&&this.can_play_mp4){video.dom.src=media.h264_url;no_video=false;}else if(media.webm_url&&this.can_play_webm){video.dom.src=media.webm_url;no_video=false;}else{media.dom=undefined;to_remove.push(i);console.log('No supported media formats');}
if(media.dom&&this.touch_interface)
this.load_media(0);}
if(no_video){this.timeline_idx=0;this.hide_loading();this.render();return;}
if(to_remove.length){var new_media=[];for(i=0;i<this.timeline_media.length;i++)
if(to_remove.indexOf(i)===-1)
new_media.push(this.timeline_media[i]);this.timeline_media=new_media;}},on_metadata_loaded:function(){var i,media;if(!this.touch_interface){for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];if(media&&media.dom&&media.dom.readyState<1)
return;}}
for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];if(!media.dom)continue;this.update_media_hash(media,media.dom);this.set_frame(media.timeline_in,media.fps,media.dom);}},on_data_loaded:function(){var i,media;if(!this.touch_interface){for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];if(media&&media.dom&&media.dom.readyState<2)
return;}}
this.hide_loading();this.load_media(0,null,{fn:function(){media=this.timeline_media[0];if(!media.is_pdf&&media.timeline_duration>1)
this.play();},scope:this},true);},on_buffer_progress_changed:function(){this.fireEvent('buffer_progress_changed');},load_next:function(after_load_callback){var old_idx=this.timeline_idx;var old_media=this.timeline_media[old_idx];old_media.dom.pause();var new_idx=(old_idx+1)%this.timeline_media.length;var callback={fn:function(){if(this.timeline_idx===new_idx&&old_idx!==new_idx)
this.set_frame(old_media.timeline_in,old_media.fps,old_media.dom);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};this.load_media(new_idx,null,callback);},load_previous:function(after_load_callback){var old_idx=this.timeline_idx;var old_media=this.timeline_media[old_idx];old_media.dom.pause();var new_idx=old_idx===0?this.timeline_media.length-1:this.timeline_idx-1;var callback={fn:function(){if(this.timeline_idx===new_idx&&old_idx!==new_idx)
this.set_frame(old_media.timeline_in,old_media.fps,old_media.dom);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};this.load_media(new_idx,this.timeline_media[new_idx].timeline_out,after_load_callback);},get_buffer_ranges_for_loaded_versions:function(){var buffer_ranges=[];var i,media,video,percent_buffered;for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];percent_buffered=0;if(!media.loaded){buffer_ranges.push({version_id:media.version_id,percent_buffered:100});continue;}
video=media.dom;if(video&&video.buffered&&video.buffered.length>0&&video.buffered.end&&video.duration)
percent_buffered=Math.floor((video.buffered.end(0)/video.duration)*100);buffer_ranges.push({version_id:media.version_id,percent_buffered:percent_buffered});}
return buffer_ranges;},update_media_hash:function(media_hash,video_dom){media_hash.loaded=true;media_hash.duration=video_dom.duration;media_hash.first_frame=0;media_hash.last_frame=this.seconds_to_frames(video_dom.duration,media_hash.fps)-1;media_hash.cut_in=media_hash.has_slate?1:0;media_hash.cut_out=media_hash.last_frame;media_hash.timeline_in=this.get_start_frame(media_hash);media_hash.timeline_out=this.get_end_frame(media_hash);media_hash.timeline_duration=this.get_frame_duration(media_hash);},get_start_frame:function(media){return media.cut_in-media.first_frame;},get_end_frame:function(media){return media.cut_out-media.first_frame;},get_frame_duration:function(media){return media.timeline_out-media.timeline_in+1;},get_current_frame:function(){return this.current_frame;},set_time:function(at_time,dom,skip_seeked_callbacks){var video_elem=this.get_video_elem();at_time=at_time!=null?at_time:video_elem.currentTime;dom=dom||video_elem;if(!dom)return;this.seeking=true;if(dom===video_elem&&!skip_seeked_callbacks){var video_ext_elem=Ext.get(dom);var timeout_func=function(){var video_elem=this.get_video_elem();if(dom===video_elem)
this.render();if(dom.seeking)return;if(this.loading_timeout){clearTimeout(this.loading_timeout);this.loading_timeout=null;}
this.hide_waiting();};video_ext_elem.on('seeking',function(){if(this.loading_timeout)return;var me=this;this.loading_timeout=setTimeout(function(){if(dom.seeking){me.show_waiting();return;}
me.hide_waiting();this.loading_timeout=null;},750);},this,{single:true});video_ext_elem.on('seeked',timeout_func,this,{single:true});video_ext_elem.on('play',timeout_func,this,{single:true});}
if(dom.readyState>1){dom.currentTime=at_time;}else{Ext.EventManager.addListener(dom,'readystatechange',function(){this.set_time(at_time,dom);},this,{single:true});}},set_frame:function(at_frame,fps,dom,seeked_callback,skip_seeked_callbacks){dom=dom||this.get_video_elem();fps=fps||this.timeline_media[this.timeline_idx].fps;if(dom===this.get_video_elem())
this.current_frame=at_frame;var callback=function(){if(seeked_callback)
seeked_callback.fn.call(seeked_callback.scope);};Ext.get(dom).on('seeked',callback,this,{single:true});this.set_time(this.frames_to_seconds(at_frame,fps),dom,skip_seeked_callbacks);},play_next:function(){this.load_next({fn:this.play,scope:this});},toggle_playback:function(){if(this.paused()){this.play();}else{this.pause();}},frame_forward:function(){var media=this.timeline_media[this.timeline_idx];if(!media)return;this.pause();var next_frame=this.get_current_frame()+1;if(next_frame>media.timeline_out){if(this.timeline_media.length>this.timeline_idx+1)
this.load_next();}else{this.set_frame(next_frame);}},frame_backward:function(){var media=this.timeline_media[this.timeline_idx];if(!media)return;this.pause();var prev_frame=this.get_current_frame()-1;if(prev_frame<media.timeline_in){if(this.timeline_idx>0)
this.load_previous();}else{this.set_frame(prev_frame);}},seconds_to_frames:function(seconds,frame_rate){frame_rate=frame_rate!=null?frame_rate:24.0;return Math.floor((seconds+5e-4)*frame_rate);},frames_to_seconds:function(frames,frame_rate){frame_rate=frame_rate!=null?frame_rate:24.0;return(frames/frame_rate)+5e-4;},play:function(){this._paused=false;var video=this.get_video_elem();if(video)
video.play();},pause:function(){var video=this.get_video_elem();if(video)
video.pause();if(!this._paused)
this.render();this._paused=true;},paused:function(){var video=this.get_video_elem();if(video)
return video.paused;return true;},update_current_frame:function(timestamp){var play_next=false;var media=this.timeline_media[this.timeline_idx];var video=this.get_video_elem();if(media&&media.loaded){if(!video)return;if(this.current_time==video.currentTime)return;this.current_time=video.currentTime;var new_frame=this.seconds_to_frames(this.current_time,media.fps);this.current_frame=new_frame;this.render();if(this.timeline_media.length>0){var out=media.timeline_out;if((!video.paused&&this.current_frame>=out)||(!this.seeking&&(video.ended||this.current_frame>=out)))
play_next=true;}}else{this.current_frame=null;}
var version_ids=this.get_loaded_versions();var progress_hash=this.get_progress();var current_version_id,progress;if(progress_hash){current_version_id=progress_hash.version_id;progress=progress_hash.progress;}
this.on_viewed_versions_changed(version_ids,current_version_id,progress);if(!this.paused())
this.seeking=false;if(play_next)
this.play_next();},set_progress_for_version_id:function(version_id,progress){var idx=-1;var i;for(i=0;i<this.timeline_media.length;i++)
if(this.timeline_media[i].version_id===version_id){idx=i;break;}
if(idx===-1)return;this.pause();var frame=this.timeline_media[idx].timeline_in+
Math.floor(progress*this.timeline_media[idx].timeline_duration);frame=Math.min(this.timeline_media[idx].timeline_out,frame);this.load_media(idx,frame);},get_loaded_versions:function(){var version_ids=[];var i,media;for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];version_ids.push(media.version_id);}
return version_ids;},get_viewed_versions:function(){if(isNaN(this.timeline_idx)||this.timeline_idx>=this.timeline_media.length)
return[];var media=this.timeline_media[this.timeline_idx];return[media.version_id];},get_frame_range_for_version:function(version_id){var i,media;for(i=0;i<this.timeline_media.length;i++){media=this.timeline_media[i];if(media.loaded&&media.version_id===version_id)
return{start_frame:media.timeline_in,end_frame:media.timeline_out};}
return null;},get_progress:function(){if(isNaN(this.timeline_idx)||this.timeline_idx>=this.timeline_media.length)
return null;var media=this.timeline_media[this.timeline_idx];if(!media)
return null;if(!media.loaded||!media.duration)
return{version_id:media.version_id,progress:0};var progress;if(this.timeline_media[this.timeline_idx]&&this.get_video_elem()&&!isNaN(this.current_frame)){if(media.timeline_out===media.timeline_in)
progress=1;else
progress=(this.current_frame-media.timeline_in)/(media.timeline_out-media.timeline_in);}
return{version_id:media.version_id,progress:progress};},get_record_status:function(record){var transcode_status=record.get('sg_uploaded_movie_transcoding_status');if(transcode_status===2)
return this.status.UNAVAILABLE;if((this.can_play_mp4||this.can_play_webm)&&transcode_status===0)
return this.status.PROCESSING;if(this.can_play_mp4&&record.get('sg_uploaded_movie_mp4'))
return this.status.READY;if(this.can_play_webm&&record.get('sg_uploaded_movie_webm'))
return this.status.READY;return this.status.UNAVAILABLE;},has_annotated_frames:function(){return this.annotations.has_annotated_frames();},list_annotated_frames:function(media_idx){if(!this.timeline_media[media_idx])return[];var version_id=this.timeline_media[media_idx].version_id;return this.annotations.list_annotated_frames(version_id);},clear_annotation:function(version_id,frame){this.annotations.clear_annotation(version_id,frame);},upload_annotated_frames_to_note:function(note_id){this.annotations.upload_annotated_frames_to_note(note_id);},get_video_bounding_box:function(){return null;},get_rendered_video_bounding_box:function(){return null;},get_video_data:function(){return null;},get_video_elem:function(){var media=this.timeline_idx>-1&&this.timeline_media[this.timeline_idx];return media&&media.dom;},on_play_state_changed:function(playing){this.fireEvent('play_state_changed',playing);},on_frame_annotated:function(version_id,frame){this.fireEvent('frame_annotated',version_id,frame);},show_waiting:function(){var loading=this.container.child("div.sgw_review_app_html5_player_loading");if(loading){loading.addClass('transparent');loading.setDisplayed(true);}},hide_waiting:function(){loading=this.container.child("div.sgw_review_app_html5_player_loading");if(loading)
loading.setDisplayed(false);},show_loading:function(transparent){this.on_loading_changed(true);var loading=this.container.child("div.sgw_review_app_html5_player_loading");if(loading){loading.setDisplayed(true);loading.removeClass('transparent');}},hide_loading:function(){this.on_loading_changed(false);loading=this.container.child("div.sgw_review_app_html5_player_loading");if(loading)
loading.setDisplayed(false);}});SG.ReviewAppPlayerCanvas=function(config){Ext.apply(this,config);SG.ReviewAppPlayerCanvas.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerCanvas,SG.ReviewAppPlayerHtml5,{templates:{video:'<canvas class="sgw_review_app_html5_player_video_canvas"></canvas>'+'<video></video>'+'<div id="video_debug"></div>'},timeline_media:[],player_name:'Revolver Web Player (Canvas)',on_first_render_video:function(){Ext.DomHelper.append(this.container,this.templates.video.apply())
this.video_canvas=this.container.child("canvas.sgw_review_app_html5_player_video_canvas");this.video_canvas_ctx=this.video_canvas.dom.getContext('2d');this.video_tag=this.container.child("video");this.watermark_target_canvas=this.video_canvas;},clear:function(){var ctx=this.video_canvas.dom.getContext('2d');ctx.clearRect(0,0,this.video_canvas.dom.width,this.video_canvas.dom.height);},render_video:function(){if(!this.touch_interface){this.video_canvas.dom.width=this.container.getWidth();this.video_canvas.dom.height=this.container.getHeight()-this.controller.container.getHeight();var media=this.timeline_media[this.timeline_idx];if(!media)return;if(media.dom){var bb=this.get_rendered_video_bounding_box();this.video_canvas_ctx.drawImage(media.dom,bb.x,bb.y,bb.w,bb.h);this.annotations.enable();this.controller.show();this.render_watermark();}else{this.video_canvas_ctx.save();this.video_canvas_ctx.clearRect(0,0,this.video_canvas.dom.width,this.video_canvas.dom.height);this.video_canvas_ctx.font='14px Helvetica';this.video_canvas_ctx.fillStyle='white';this.video_canvas_ctx.textAlign='center';var text;if(media){var record=media.record;var status=this.get_record_status(record);if(status===this.status.PROCESSING)
text='This Version Is Currently Being Transcoded';else
text='This Version Has No Playable Media';}else{text='No Playable Versions';}
this.video_canvas_ctx.fillText(text,this.video_canvas.dom.width/2,this.video_canvas.dom.height/2);this.video_canvas_ctx.restore();var version_ids=this.get_loaded_versions();var version_id,progress;if(version_ids.length)
version_id=media.version_id;this.annotations.disable();this.controller.hide();this.on_viewed_versions_changed(version_ids,version_id,0);}}},get_video_bounding_box:function(){if(!this.video_canvas||!this.video_canvas.dom.width)return null;return{x:0,y:0,w:this.video_canvas.dom.width,h:this.video_canvas.dom.height};},get_rendered_video_bounding_box:function(){var video=this.get_video_elem();var video_h=video.videoHeight;var video_w=video.videoWidth;var ratio_h=this.video_canvas.dom.height/video_h;var ratio_w=this.video_canvas.dom.width/video_w;var w,h;if(ratio_h<ratio_w){w=Math.floor(video_w*ratio_h);h=Math.floor(video_h*ratio_h);}else{w=Math.floor(video_w*ratio_w);h=Math.floor(video_h*ratio_w);}
w=Math.max(0,w);h=Math.max(0,h);var x=(this.video_canvas.dom.width-w)/2;var y=(this.video_canvas.dom.height-h)/2;return{x:x,y:y,w:w,h:h};},get_video_data:function(){return this.video_canvas.dom;},load_media:function(idx,at_frame,after_load_callback,skip_seeked_callbacks){this.timeline_idx=idx;var media=this.timeline_media[idx];if(!media||!media.dom){this.render();return;}
this.current_time=null;this.current_frame=null;at_frame=at_frame!=null?at_frame:media.timeline_in;this.set_frame(at_frame,media.fps,media.dom,after_load_callback,skip_seeked_callbacks);if(this.touch_interface){this.video_tag.dom.parentNode.replaceChild(media.dom,this.video_tag.dom);this.video_tag=this.container.child("video");this.video_tag.addClass('active');}}});SG.ReviewAppPlayerVideoElement=function(config){Ext.apply(this,config);SG.ReviewAppPlayerVideoElement.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppPlayerVideoElement,SG.ReviewAppPlayerHtml5,{templates:{video:'<div class="no_media"></div>'+'<canvas class="sgw_review_app_html5_player_watermark_canvas"></canvas>'},timeline_media:[],player_name:'Revolver Web Player (Video Element)',on_first_render_video:function(){Ext.DomHelper.append(this.container,this.templates.video.apply(),true);this.watermark_target_canvas=this.container.child('canvas');this.no_media_div=this.container.child('div.no_media');this.annotation_canvas=document.createElement('canvas');if(this.touch_interface)
this.watermark_target_canvas.setDisplayed(false);},render_video:function(){var media=this.timeline_media[this.timeline_idx];if(!media)return;var video_elem=Ext.get(this.get_video_elem());var do_render_watermark=false;if(media.loaded){if(!this.touch_interface){this.annotations.enable();if(this.watermark_target_canvas.dom.style.display==='none'){this.watermark_target_canvas.setDisplayed(true);do_render_watermark=true;}
this.controller.show();}
if(this.no_media_div.dom.style.display!=='none'){this.no_media_div.setDisplayed(false);if(video_elem)
video_elem.setDisplayed(true);}}else{var record=media.record;var status=this.get_record_status(record);if(status!==this.status.READY){if(!this.touch_interface){this.annotations.disable();this.watermark_target_canvas.setDisplayed(false);this.controller.hide();}
var text;if(status===this.status.PROCESSING)
text='<p>This Version Is Currently Being Transcoded</p>';else
text='<p>This Version Has No Playable Media</p>';this.no_media_div.update(text);if(this.no_media_div.dom.style.display==='none'){this.no_media_div.setDisplayed(true);if(video_elem)
video_elem.setDisplayed(false);}}else{this.no_media_div.setDisplayed(false);}}
var size=this.container.getSize();var w=size.width;var h=size.height;if(!this.touch_interface)
h-=this.controller.container.getHeight();if(video_elem){size=video_elem.getSize();if(size.width!==w||size.height!==h){video_elem.setSize(w,h);this.watermark_target_canvas.dom.width=w;this.watermark_target_canvas.dom.height=h;do_render_watermark=true;}}
if(do_render_watermark&&!this.touch_interface)
this.render_watermark(true);},get_video_bounding_box:function(){var video_elem=Ext.fly(this.get_video_elem());if(!video_elem)return null;var w=video_elem.getWidth();var h=video_elem.getHeight();if(w===0||h===0){w=parseInt(video_elem.dom.style.width,10)||0;h=parseInt(video_elem.dom.style.height,10)||0;}
return video_elem&&{x:0,y:0,w:w,h:h};},get_rendered_video_bounding_box:function(){var video_elem=this.get_video_elem();if(!video_elem)return null;var rect=this.get_video_bounding_box();var video_h=video_elem.videoHeight;var video_w=video_elem.videoWidth;var ratio_h=rect.h/video_h;var ratio_w=rect.w/video_w;if(ratio_h<ratio_w){var w=Math.floor(video_w*ratio_h)
var h=Math.floor(video_h*ratio_h)}else{var w=Math.floor(video_w*ratio_w)
var h=Math.floor(video_h*ratio_w)}
w=Math.max(0,w);h=Math.max(0,h);var x=Math.floor(rect.x+(rect.w-w)/2);var y=Math.floor(rect.y+(rect.h-h)/2);return{x:x,y:y,w:w,h:h};},load_media:function(idx,at_frame,after_load_callback,skip_seeked_callbacks){var media=this.timeline_media[idx];if(!media){this.render();return;}
var old_idx=this.timeline_idx;this.timeline_idx=idx;this.current_frame=null;this.current_time=null;var callback={fn:function(){if(idx!==old_idx){var old_video_elems=this.container.query('video');var i;for(i=0;i<old_video_elems.length;i++)
if(old_video_elems[i]!==media.dom)
old_video_elems[i].style.display='none';if(!media.dom.parentNode)
this.container.dom.appendChild(media.dom);media.dom.style.display='block';}
if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};if(this.touch_interface){callback.fn.call(callback.scope);var me=this;setTimeout(function(){me.render();me.hide_loading();},250);return;}
at_frame=at_frame!=null?at_frame:media.timeline_in;this.set_frame(at_frame,media.fps,media.dom,callback,skip_seeked_callbacks);},clear:function(){var old_video_elems=this.container.query('video');var i;for(i=0;i<old_video_elems.length;i++)
Ext.fly(old_video_elems[i]).remove();},get_video_data:function(){var video_elem=this.get_video_elem();if(!video_elem)return;var video_h=video_elem.videoHeight;var video_w=video_elem.videoWidth;var video_rect=this.get_video_bounding_box();var rect=this.get_rendered_video_bounding_box();this.annotation_canvas.width=video_rect.w;this.annotation_canvas.height=video_rect.h;var ctx=this.annotation_canvas.getContext('2d');ctx.drawImage(video_elem,rect.x,rect.y,rect.w,rect.h);ctx.drawImage(this.watermark_target_canvas.dom,0,0);return this.annotation_canvas;}});SG.Widget.ReviewAppCanvasTimeline=function(context,widget_spec,id){SG.Widget.ReviewAppCanvasTimeline.superclass.constructor.call(this,context,widget_spec,id);};Ext.extend(SG.Widget.ReviewAppCanvasTimeline,SG.Widget.Base,{default_settings:{zoom:1.0,num_versions:1,render_mode:'timeline',version_page_size:50,entity_page_size:50,filters:{logical_operator:"and",conditions:[{logical_operator:"and",conditions:[]}]},sorts:{all_projects:[{column:'id',direction:'desc'}],project:[{column:'id',direction:'desc'}],all_shots:[{column:'id',direction:'desc'}],sequence:[{column:'entity.Shot.sg_cut_order',direction:'asc'},{column:'entity.Shot.code',direction:'asc'}],shot:[{column:'id',direction:'desc'}],asset_type:[{column:'entity.Asset.code',direction:'asc'}],asset:[{column:'id',direction:'desc'}],playlist:[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'},{column:'playlists.PlaylistVersionConnection.id',direction:'asc'}],version_page:null}},templates:{main:'<div class="sgw_review_app_canvas_timeline"></div>'},init_widget:function(){this.initial_version=this.context.get('version');this.linked_entity=this.context.get('linked_entity');this.initial_project=this.context.get('project');this.initial_asset_type=this.context.get('asset_type');if(this.initial_version){try{}catch(e){}}},on_first_render:function(){this.container=this.get_container();this.container.update(this.templates.main.apply());var entity_page_size_cookie=getCookie('sgw_review_app_timeline_entity_page_size');if(entity_page_size_cookie)
this.set('entity_page_size',Number(entity_page_size_cookie));var version_page_size_cookie=getCookie('sgw_review_app_timeline_version_page_size');if(version_page_size_cookie)
this.set('version_page_size',Number(version_page_size_cookie));var thumb_size_cookie=getCookie('sgw_review_app_timeline_thumb_size');if(thumb_size_cookie)
this.set('zoom',Number(thumb_size_cookie));var render_mode_cookie=getCookie('sgw_review_app_timeline_render_mode');if(render_mode_cookie)
this.set('render_mode',render_mode_cookie);var ver_limit_cookie=getCookie('sgw_review_app_timeline_version_limit');if(ver_limit_cookie)
this.set('num_versions',Number(ver_limit_cookie));var sorts_cookie=getCookie('sgw_review_app_timeline_sorts');if(sorts_cookie){var sorts=Ext.decode(sorts_cookie);var entity_type;for(entity_type in this.default_settings.sorts)
if(!sorts.hasOwnProperty(entity_type))
sorts[entity_type]=this.default_settings.sorts[entity_type];this.set('sorts',sorts);}
this.timeline=this.new_component(SG.ReviewAppCanvasTimelineComponent,{container:this.container.child('div.sgw_review_app_canvas_timeline'),entity_page_size:this.get('entity_page_size'),version_page_size:this.get('version_page_size'),zoom:this.get('zoom'),render_mode:this.get('render_mode'),history_limit:this.get('num_versions'),sorts:this.get('sorts'),contextmenu_callback:{fn:this.on_contextmenu,scope:this},loading_changed_callback:{fn:this.on_loading_changed,scope:this},updating_state_changed_callback:{fn:this.on_updating_state_changed,scope:this},node_changed_callback:{fn:this.on_node_changed,scope:this},sorts_changed_callback:{fn:this.on_sorts_changed,scope:this},render_mode_changed_callback:{fn:this.on_render_mode_changed,scope:this},history_limit_changed_callback:{fn:this.on_history_limit_changed,scope:this},zoom_changed_callback:{fn:this.on_zoom_changed,scope:this},entity_page_size_changed_callback:{fn:this.on_entity_page_size_changed,scope:this},version_page_size_changed_callback:{fn:this.on_version_page_size_changed,scope:this}});this.timeline.render();var callback={fn:function(){SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'no_entity_chosen'});},scope:this};if(this.initial_version){if(SG.globals.review_app_player)
this.timeline.view_versions([this.initial_version.id]);this.timeline.set_version(this.initial_version.id,this.linked_entity);return;}
if(this.linked_entity){this.timeline.set_entity(this.linked_entity);return;}
if(this.initial_asset_type&&project_id){var proj=this.initial_project;var project_id=proj?proj.id:null;this.timeline.set_asset_type(this.initial_asset_type,project_id);return;}
if(SG.globals.review_app_player){var version_ids=SG.globals.review_app_player.get_viewed_versions();if(version_ids&&version_ids.length>0){var version_id=version_ids[0];this.timeline.set_version(version_id,null);return;}}
var node_cookie=getCookie('sgw_review_app_timeline_node');if(node_cookie){try{var hash=Ext.decode(node_cookie);var found_callback={fn:function(node){var cb;if(!node){node=this.timeline.generate_nav_node();cb=callback;}
this.timeline.set_node(node,null,cb);},scope:this};SG.ReviewAppTreeNode.from_hash(hash,found_callback);return;}catch(e){}}
var node=this.timeline.generate_nav_node();this.timeline.set_node(node,null,callback);},render_widget:function(){this.timeline.render();},get_render_mode:function(){return this.timeline?this.timeline.render_mode:this.get('render_mode');},set_render_mode:function(render_mode,after_load_callback){this.timeline.set_render_mode(render_mode,after_load_callback);},get_node:function(){return this.timeline.get_node();},set_node:function(node,sender){this.timeline.set_node(node,sender);},set_entity:function(record,sender,after_load_callback){this.timeline.set_entity(record,sender,after_load_callback);},reload:function(){this.timeline.reload();},on_loading_changed:function(state){SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'loading_changed',args:state});},on_updating_state_changed:function(state){SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'updating_state_changed',args:state});},on_node_changed:function(node,sender){setCookie('sgw_review_app_timeline_node',Ext.encode(node.to_hash()),365);SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'node_changed',args:{node:node,sender:sender}});},on_render_mode_changed:function(render_mode){this.set('render_mode',render_mode);setCookie('sgw_review_app_timeline_render_mode',render_mode,365);},get_mode:function(){return this.timeline&&this.timeline.get_mode();},get_sorts:function(){return this.timeline.get_sorts();},set_sorts:function(sorts,after_load_callback){this.timeline.set_sorts(sorts,after_load_callback);},reset_sorts_to_default:function(after_load_callback){this.timeline.reset_sorts_to_default(after_load_callback);},has_default_sorts:function(){return this.timeline.has_default_sorts();},sorts_are_default:function(sorts){return this.timeline.sorts_are_default(sorts);},get_sort_display_names:function(){if(!this.timeline)return[];var sorts=this.timeline.get_sorts();var is_default=this.timeline.has_default_sorts();var sort_display_names=[];if(sorts.length){var special_fields=['entity.Shot.sg_cut_order','entity.Asset.code','entity.Shot.code','playlists.PlaylistVersionConnection.sg_sort_order'];var i,parts,entity_type,column;for(i=0;i<sorts.length;i++){if(special_fields.indexOf(sorts[i].column)>-1){parts=sorts[i].column.split('.');entity_type=parts[1];column=parts[2];sort_display_names.push(SG.schema.get_field_display_name(entity_type,column));}else if(sorts[i].column==='playlists.PlaylistVersionConnection.id'){sort_display_names.push('Playlist Version Connection Id');}else{sort_display_names.push(SG.schema.get_field_display_name('Version',sorts[i].column));}}}
return sort_display_names;},on_sorts_changed:function(sorts){this.set('sorts',sorts);setCookie('sgw_review_app_timeline_sorts',Ext.encode(sorts),365);},get_filters:function(){return this.timeline.get_filters();},set_extra_filters:function(filters,after_load_callback){this.timeline.set_extra_filters(filters,after_load_callback);},get_history_limit:function(){return this.timeline.history_limit;},set_history_limit:function(limit,after_load_callback){this.timeline.set_history_limit(limit,after_load_callback);},is_rendering_versions:function(){return this.timeline.is_rendering_versions();},on_history_limit_changed:function(limit){this.set('num_versions',limit);setCookie('sgw_review_app_timeline_version_limit',limit,365);},on_zoom_changed:function(zoom){this.set('zoom',zoom);setCookie('sgw_review_app_timeline_thumb_size',zoom,365);},on_entity_page_size_changed:function(entity_page_size){this.set('entity_page_size',entity_page_size);setCookie('sgw_review_app_timeline_entity_page_size',entity_page_size,365);},on_version_page_size_changed:function(version_page_size){this.set('version_page_size',version_page_size);setCookie('sgw_review_app_timeline_version_page_size',version_page_size,365);},resize_canvas_to_fit_container:function(){this.timeline.resize_canvas_to_fit_container();},get_dataset_size:function(){return this.timeline.get_dataset_size();},updates_are_disabled:function(){return this.timeline.updates_are_disabled();},on_contextmenu:function(event){event.stopEvent();if(!this.context_menu){this.context_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_contextmenu,scope:this},menu_class:'sgw_review_app_canvas_timeline_menu'});}
this.context_menu.position={xy:event.getXY()};this.context_menu.show();return;},on_before_show_contextmenu:function(the_menu){the_menu.items=[];var selected_ids=this.timeline.get_selected_ids();if(selected_ids.length&&SG.globals.review_app_player){the_menu.items.push({html:'Play Selected',item_selected:{fn:function(){this.timeline.view_selected();},scope:this}});}
if(this.timeline.render_mode!=='gallery'){if(SG.globals.review_app_player)
the_menu.items.push({html:'Play All in Timeline',item_selected:{fn:function(){this.timeline.view_active_versions();},scope:this}});if(selected_ids.length){var all_selected_items_active=true;var version_id;for(version_id in this.timeline.selected_items)
if(this.timeline.selected_items.hasOwnProperty(version_id))
if(this.timeline.selected_items[version_id].row_idx!==0){all_selected_items_active=false;break;}
if(!all_selected_items_active)
the_menu.items.push({html:'Move Selected to Timeline',item_selected:{fn:function(){this.timeline.move_selected_items_to_timeline();},scope:this}});}}
if(selected_ids.length){var selected_are_flagged=this.timeline.items_are_flagged(selected_ids);var user_can_flag=SG.schema.can_edit_field('Version','flagged');if(selected_are_flagged){the_menu.items.push({html:'Unflag Selected',item_selected:{fn:function(){this.timeline.flag_items_by_id(selected_ids,true);},scope:this},icon_name:'review_app_unflagged_menu_item',disabled:!user_can_flag});}else{the_menu.items.push({html:'Flag Selected',item_selected:{fn:function(){this.timeline.flag_items_by_id(selected_ids);},scope:this},icon_name:'review_app_flagged_menu_item',disabled:!user_can_flag});}}
if(the_menu.items.length)
the_menu.items.push({line:true});var levels=[25,50,100,200];var item,menu_title;if(this.timeline.is_rendering_versions()){if(this.timeline.version_page_size>0)
menu_title='Loading '+this.timeline.version_page_size+' Versions at a Time';else
menu_title='Loading All Results';item={html:menu_title,submenu:{before_show:{fn:function(menu){menu.items=[];var i;for(i=0;i<levels.length;i++)
menu.items.push({html:levels[i]+' at a Time',value:levels[i],checked:this.timeline.version_page_size===levels[i]});menu.items.push({html:'All Results',value:-1,checked:this.timeline.version_page_size===-1});menu.render();},scope:this},item_selected:{fn:function(menu,item){this.timeline.set_version_page_size(item.value)},scope:this}}};}else{var entity_type=this.timeline.get_entity_type_name_for_current_mode();if(this.timeline.entity_page_size>0)
menu_title='Loading '+this.timeline.entity_page_size+' '+
entity_type.pluralize(2)+' at a Time';else
menu_title='Loading All '+entity_type.pluralize(2);item={html:menu_title,submenu:{before_show:{fn:function(menu){menu.items=[];var i;for(i=0;i<levels.length;i++)
menu.items.push({html:levels[i]+' at a Time',value:levels[i],checked:this.timeline.entity_page_size===levels[i]});menu.items.push({html:'All '+entity_type.pluralize(2),value:-1,checked:this.timeline.entity_page_size===-1});menu.render();},scope:this},item_selected:{fn:function(menu,item){this.timeline.set_entity_page_size(item.value)},scope:this}}};}
the_menu.items.push(item);the_menu.render();}});SG.ReviewAppCanvasTimelineComponent=function(config){Ext.apply(this,config);SG.ReviewAppCanvasTimelineComponent.superclass.constructor.call(this,config);};Ext.extend(SG.ReviewAppCanvasTimelineComponent,SG.Component,{templates:{main:'<div class="sgc_canvas_timeline">'+'<canvas class="timeline" width="1" height="1"></canvas>'+'<canvas class="shadows" width="1" height="1"></canvas>'+'</div>',thumb:'/thumbnail/image/{image_src}',filmstrip_image:'/file_serve/{image_src}',missing_thumb:'/images/missing_image.png'},default_sorts:{all_projects:[{column:'id',direction:'desc'}],project:[{column:'id',direction:'desc'}],all_shots:[{column:'id',direction:'desc'}],sequence:[{column:'entity.Shot.sg_cut_order',direction:'asc'},{column:'entity.Shot.code',direction:'asc'}],shot:[{column:'id',direction:'desc'}],asset_type:[{column:'entity.Asset.code',direction:'asc'}],asset:[{column:'id',direction:'desc'}],playlist:[{column:'playlists.PlaylistVersionConnection.sg_sort_order',direction:'asc'},{column:'playlists.PlaylistVersionConnection.id',direction:'asc'}],version_page:null},init_component:function(){if(SG.globals.review_app_player){SG.globals.review_app_player.on('viewed_versions_changed',this.on_viewed_versions_changed,this);SG.globals.review_app_player.on('updates_enabled_changed',this.on_updates_enabled,this);var me=this;setInterval(function(){me.fetch_updates();},10*1000);}
SG.NotificationCenter.add_observer({uuid:'_review_app_utils_',name:'flagged_state_changed',callback:{fn:this.on_flagged_state_changed,scope:this}});this.request_animation_frame=function(fn){var anim_fn=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(function(){callback(Date.now());},1000/60);};anim_fn(fn);}},on_first_render:function(){this.pixel_ratio=1;if(!isNaN(window.devicePixelRatio))
this.pixel_ratio=window.devicePixelRatio;this.touch_interface=navigator.userAgent.match(/(iPod|iPhone|iPad)/);this.box_width=80*this.pixel_ratio;this.box_height=this.floor(this.box_width/1.77);this.box_padding=5*this.pixel_ratio;this.progress_area_height=12*this.pixel_ratio;this.num_fields=1;this.field_height=11*this.pixel_ratio;this.field_padding=6*this.pixel_ratio;this.header_items=[];this.num_header_fields=1;this.header_height=this.num_header_fields*(2*this.field_padding+this.field_height);this.header_shadow_height=20*this.pixel_ratio;this.header_bar_left_item={bb:{}};this.header_bar_right_item={bb:{}};if(!this.canvas_padding)
this.canvas_padding=50;this.canvas_padding*=this.pixel_ratio;this.scrollbar_width=(this.touch_interface?5:12)*this.pixel_ratio;this.scrollbar_padding=3*this.pixel_ratio;this.active_band_item={};this.active_band_line_width=3*this.pixel_ratio;this.zoom_slider_item={opacity:0.5};this.zoom_slider_width=80*this.pixel_ratio;this.zoom_slider_padding=10*this.pixel_ratio;this.zoom_handle_size=10*this.pixel_ratio;this.load_more_button_item={};this.horizontal_scrollbar_item={};this.vertical_scrollbar_item={};this.counts_item={};this.zoom_min=0.4;this.zoom_max=8;this.tx=0;this.ty=0;this.ox=0;this.oy=0;this.anim_queue=[];this.deletion_queue={};this.version_items={};this.visible_version_items=[];this.rtree=new SG.ReviewAppRTree();this.selected_items={};this.selected_ids=[];this.hovered_items={};this.viewed_items={};this.num_columns=0;this.num_rows=0;if(!this.corner_radius)
this.corner_radius=100;this.corner_radius*=this.pixel_ratio;if(!this.shadow_radius)
this.shadow_radius=30;this.shadow_radius*=this.pixel_ratio;if(!this.entity_page_size)
this.entity_page_size=50;this.max_num_entities=this.entity_page_size;this.current_num_entities=0;this.total_num_entities=0;if(!this.version_page_size)
this.version_page_size=50;this.max_num_versions=this.version_page_size;this.current_num_versions=0;this.total_num_versions=0;this.reset_bounds();this.container.update(this.templates.main.apply());this.canvas=this.container.child('canvas.timeline');this.shadow_canvas=this.container.child('canvas.shadows');var width=this.container.getWidth();var height=this.container.getHeight();if(!this.zoom)
this.zoom=1;if(!this.render_mode)
this.render_mode='timeline';if(!this.history_limit)
this.history_limit=1;if(!this.sorts)
this.sorts=sg_deep_copy(this.default_sorts);this.num_items_per_row=this.get_num_items_per_row(width);this.flagged_image=new Image();this.flagged_image.src='/images/review_app_flagged_indicator.png';this.slider_left_small_image=new Image();this.slider_left_small_image.src='/images/slider_leftsmall.png';this.slider_right_large_image=new Image();this.slider_right_large_image.src='/images/slider_rightlarge.png';this.entity_type_icons={};this.missing_image=new Image();this.missing_image.src=this.templates.missing_thumb.apply();this.tooltip_handler=this.new_component(SG.NewGanttTooltips,{container:this.container,find_area_callback:{fn:this.get_tooltip_item_under_mouse,scope:this}});this.clear_ids(true);if(this.touch_interface){this.add_event(this.shadow_canvas,'touchstart',this.on_canvas_mousedown);this.add_event(this.shadow_canvas,'gesturestart',this.on_canvas_gesturestart);this.add_event(this.shadow_canvas,'gesturechange',this.on_canvas_gesturechange);this.add_event(this.shadow_canvas,'gestureend',this.on_canvas_gestureend);Ext.EventManager.addListener(window,'touchmove',this.on_mousemove,this);Ext.EventManager.addListener(window,'touchend',this.on_mouseup,this);}else{this.add_event(this.shadow_canvas,'dblclick',this.on_dblclick);var mouse_scroll_event=Ext.isGecko?'DOMMouseScroll':'mousewheel';this.add_event(this.shadow_canvas,mouse_scroll_event,this.on_canvas_mousewheel);this.add_event(this.shadow_canvas,'mousedown',this.on_canvas_mousedown);this.add_event(this.shadow_canvas,'mousemove',this.on_canvas_mousemove);this.add_event(this.shadow_canvas,'mouseover',this.on_cursor_local_coords_change);this.add_event(this.shadow_canvas,'mouseout',this.on_canvas_mouseout);Ext.EventManager.addListener(window,'mouseup',this.on_mouseup,this);Ext.EventManager.addListener(window,'mousemove',this.on_mousemove,this);}
Ext.EventManager.onWindowResize(this.resize_canvas_to_fit_container,this);},render:function(){if(!this.rendered){this.on_first_render();this.rendered=true;}
if(this.anim_queue.length>0){if(this.animating){this.render_requested=true;return;}
var step=function(timestamp){var rerender=this.process_anim_queue();if(this.render_requested||rerender){this.render_frame(rerender);}else{this.process_deletions();this.process_anim_queue_deletions();}
this.render_requested=false;if(this.anim_queue.length){this.request_animation_frame(step.createDelegate(this));return;}
this.animating=false;};this.request_animation_frame(step.createDelegate(this));this.animating=true;return;}
this.render_frame();},render_frame:function(visible_version_items_already_calculated){this.process_deletions();var width=this.container.getWidth()*this.pixel_ratio;var height=this.container.getHeight()*this.pixel_ratio;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);if(bounds_rect.x<Number.MAX_VALUE&&bounds_rect.y<Number.MAX_VALUE){var min_tx=bounds_rect.x;var max_tx=bounds_rect.x+bounds_rect.w-view_rect.w;this.tx=this.min(this.max(this.tx,min_tx),max_tx);var min_ty=bounds_rect.y;var max_ty=bounds_rect.y+bounds_rect.h-view_rect.h
this.ty=this.min(this.max(this.ty,min_ty),max_ty);view_rect=this.get_view_rect(width,height);}
this.translating=false;if(this.last_tx!==this.tx||this.last_ty!==this.ty)
this.translating=true;this.zooming=false;if(this.last_zoom!==this.zoom)
this.zooming=true;this.last_tx=this.tx;this.last_ty=this.ty;this.last_zoom=this.zoom;if(!this.canvas_ctx)
this.canvas_ctx=this.canvas.dom.getContext('2d');var ctx=this.canvas_ctx;var font=11*this.pixel_ratio+'px Helvetica';if(ctx.font!==font)
ctx.font=font;var baseline='top';if(ctx.textBaseline!==baseline)
ctx.textBaseline=baseline;if(!visible_version_items_already_calculated)
this.visible_version_items=this.get_visible_version_items(view_rect);this.canvas_xy=this.canvas.getXY();this.dims_changed=false;if(Number(this.canvas.dom.getAttribute('width'))!==width||Number(this.canvas.dom.getAttribute('height'))!==height){this.canvas.dom.setAttribute('width',width);this.canvas.dom.setAttribute('height',height);this.canvas_w=width;this.canvas_h=height;if(this.pixel_ratio!==1){this.canvas.dom.style.width=width/this.pixel_ratio+'px';this.canvas.dom.style.height=height/this.pixel_ratio+'px';}
this.zoom_slider_item.bb=this.get_zoom_slider_focus_area(width,height);this.active_band_item.bb=this.get_active_band_geometry(width,height,view_rect);this.dims_changed=true;}
if(this.dims_changed||this.translating||this.zooming){this.update_header_item_bounding_boxes(width,height);this.update_scrollbar_bounding_boxes(width,height,view_rect,bounds_rect);}
var attempt_region_rendering=!this.dims_changed&&this.can_use_region_rendering(width,height);this.process_anim_queue_deletions();var regions,i;if(attempt_region_rendering){var dirty_regions=this.get_dirty_regions(width,height);var sum_region_areas=0;for(i=0;i<dirty_regions.length;i++)
sum_region_areas+=dirty_regions[i].w*dirty_regions[i].h;if(sum_region_areas<0.6*width*height){regions=dirty_regions;for(i=0;i<regions.length;i++)
ctx.clearRect(regions[i].x,regions[i].y,regions[i].w,regions[i].h);}}
if(!regions){ctx.clearRect(0,0,width,height);this.header_dirty=true;}
this.render_active_band(ctx,width,height,regions);this.render_version_items(ctx,width,height,regions);this.render_load_more_button(ctx,width,height,regions);if(this.drag_selection_start&&this.drag_selection_end)
this.render_drag_selection_box(ctx);if(!this.hide_counts)
this.render_counts(ctx,width,height,regions);if(this.header_area_is_showing())
this.render_header(ctx,width,height,regions);this.render_shadows(ctx,width,height);this.render_scrollbars(ctx,width,height,view_rect,bounds_rect,regions);if(this.zoom_slider_is_showing())
this.render_zoom_slider(ctx,width,height,regions);if(false&&regions){ctx.save();ctx.fillStyle='rgba(255, 0, 0, 0.1)';for(i=0;i<regions.length;i++)
ctx.fillRect(regions[i].x,regions[i].y,regions[i].w,regions[i].h);ctx.restore();}},can_use_region_rendering:function(width,height){if(this.dims_changed||this.translating||this.zooming)return false;if((this.drag_selection_start&&this.drag_selection_end)||this.drag_selection_released){this.drag_selection_released=false;return false;}
if(this.counts_content_changed())
return false;var anims=this.get_anims_by_name('position');return anims.length===0;},get_dirty_regions:function(width,height){var view_items=[this.zoom_slider_item,this.header_bar_left_item,this.header_bar_right_item];view_items=view_items.concat(this.header_items);var items=[this.active_band_item,this.load_more_button_item].concat(this.visible_version_items);items=items.concat(view_items);var regions=[];var i,j,item,dirty,anims,rect,region;for(i=0;i<items.length;i++){item=items[i];dirty=false;if(item.rerender){dirty=true;}else{anims=this.get_anims_for_item(item);for(j=0;j<anims.length;j++)
if(anims[j].name!=='position'){dirty=true;break;}}
if(!dirty)continue;if(view_items.indexOf(item)>-1)
rect=item.bb;else
rect=this.to_view_rect(item.bb,true);region=this.intersect(rect,{x:0,y:0,w:width,h:height});if(region)
regions.push(region);};return regions.length?this.merge(regions):[];},merge:function(regions){var i,j,k,new_regions,current,next,merged;do{merged=null;for(i=0;i<regions.length;i++){current=regions[i];for(j=i+1;j<regions.length;j++){next=regions[j];if(this.intersects(current,next)){x=this.min(current.x,next.x);y=this.min(current.y,next.y);merged={x:x,y:y,w:this.max(current.x+current.w,next.x+next.w)-x,h:this.max(current.y+current.h,next.y+next.h)-y};break;}}
if(merged)
break;}
if(merged){new_regions=[merged];for(k=0;k<regions.length;k++)
if(k!==i&&k!==j)
new_regions.push(regions[k]);regions=new_regions;}}while(merged);return regions;},intersects:function(rect_1,rect_2){return!(rect_1.x>rect_2.x+rect_2.w||rect_1.x+rect_1.w<rect_2.x||rect_1.y>rect_2.y+rect_2.h||rect_1.y+rect_1.h<rect_2.y);},intersect:function(rect_1,rect_2){if(!this.intersects(rect_1,rect_2))
return null;var x=this.max(rect_1.x,rect_2.x);var y=this.max(rect_1.y,rect_2.y);var w=this.min(rect_1.x+rect_1.w,rect_2.x+rect_2.w)-x;var h=this.min(rect_1.y+rect_1.h,rect_2.y+rect_2.h)-y;if(w===0||h===0)
return null;return{x:x,y:y,w:w,h:h};},get_intersecting_subregions:function(rect,regions){var subregions=[];var iscx;for(i=0;i<regions.length;i++){iscx=this.intersect(rect,regions[i]);if(iscx)
subregions.push(iscx);}
return subregions;},render_to_regions:function(ctx,item,rect,regions,render_callback){var subregions=this.get_intersecting_subregions(rect,regions);if(!subregions.length)
return;var canvas=this.get_cached_canvas(item,rect.w,rect.h,render_callback);var i,sub_rect,source_x,source_y,source_w,source_h;for(i=0;i<subregions.length;i++){sub_rect=subregions[i];source_x=sub_rect.x-rect.x;source_y=sub_rect.y-rect.y;source_w=this.min(sub_rect.w,canvas.width-source_x)||1;source_h=this.min(sub_rect.h,canvas.height-source_y)||1;if(item.scale&&item.scale<1){var w=this.floor(item.scale*sub_rect.w);var h=this.floor(item.scale*sub_rect.h);var scaled_rect={x:this.floor(rect.x+rect.w*(1-item.scale)/2+(sub_rect.x-rect.x)/rect.w*w),y:this.floor(rect.y+rect.h*(1-item.scale)/2+(sub_rect.y-rect.y)/rect.h*h),w:w,h:h};ctx.drawImage(canvas,source_x,source_y,source_w,source_h,scaled_rect.x,scaled_rect.y,scaled_rect.w,scaled_rect.h);}else{ctx.drawImage(canvas,source_x,source_y,source_w,source_h,sub_rect.x,sub_rect.y,sub_rect.w,sub_rect.h);}}},render_active_band:function(ctx,width,height,regions){var item=this.active_band_item;if(!item.visibility)return;var rect=this.to_view_rect(this.active_band_item.bb,true);rect.x=0;rect.w=width;var view_rect={x:0,y:0,w:width,h:height};if(!this.intersects(rect,view_rect))
return;if(!regions)
regions=[view_rect];var render_callback={fn:function(){this.render_active_band_canvas(item,rect.w,rect.h);},scope:this};ctx.save();ctx.globalAlpha=item.visibility;this.render_to_regions(ctx,item,rect,regions,render_callback);ctx.restore();},render_active_band_canvas:function(item,width,height){var ctx=item.ctx;var offset=this.active_band_line_width%2===0?0.5*this.pixel_ratio:0;ctx.fillStyle='rgba(204, 221, 238, 0.2)';ctx.fillRect(0,0,width,height);ctx.strokeStyle='rgb(204, 221, 238)';ctx.lineWidth=this.active_band_line_width;ctx.beginPath();ctx.moveTo(0,offset+this.active_band_line_width/2.0);ctx.lineTo(width,offset+this.active_band_line_width/2.0);ctx.moveTo(0,height-offset-this.active_band_line_width/2.0);ctx.lineTo(width,height-offset-this.active_band_line_width/2.0);ctx.closePath();ctx.stroke();},render_version_items:function(ctx,width,height,regions){if(!this.num_columns)return;var i;for(i=0;i<this.visible_version_items.length;i++)
this.render_version_item(ctx,this.visible_version_items[i],width,height,regions);},render_version_item:function(ctx,item,width,height,regions){if(item.opacity===0||item.visibility===0||item.scale===0)
return;var rect=this.to_view_rect(item.bb,true);if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var render_callback={fn:function(){this.render_version_item_canvas(item,rect.w,rect.h);},scope:this};ctx.save();ctx.globalAlpha=item.visibility;this.render_to_regions(ctx,item,rect,regions,render_callback);ctx.restore();},get_cached_canvas:function(item,width,height,render_callback){if(!item.canvas){item.canvas=document.createElement('canvas');item.ctx=item.canvas.getContext('2d');item.rerender=true;}
if(!item.rerender){var anims=this.get_anims_for_item(item);var i;for(i=0;i<anims.length;i++)
if(['position','visibility'].indexOf(anims[i].name)<0){item.rerender=true;break;}}
var resize=false;if(item.rerender){if(item.canvas.width!==width||item.canvas.height!==height)
resize=true;}else if(Math.abs(item.canvas.width-width)>1||Math.abs(item.canvas.height-height)>1){item.rerender=true;resize=true;}
if(resize){item.canvas.width=width;item.canvas.height=height;var font=11*this.pixel_ratio+'px Helvetica';if(item.ctx.font!==font)
item.ctx.font=font;var baseline='top';if(item.ctx.textBaseline!==baseline)
item.ctx.textBaseline=baseline;}else if(item.rerender){item.ctx.clearRect(0,0,width,height);}
if(item.rerender){render_callback.fn.call(render_callback.scope);item.rerender=false;}
return item.canvas;},render_version_item_canvas:function(item,width,height){item.ctx.save();item.ctx.globalAlpha*=item.opacity;var bb=sg_deep_copy(item.bb);var padding=this.to_view_dist(this.box_padding,true);var line_offset=0.5*this.pixel_ratio;var rect;if(item.selected){rect={x:0,y:0,w:width,h:height};var start_color='rgb(234, 233, 215)';var end_color='rgb(247, 246, 206)';var grad=item.ctx.createLinearGradient(0,rect.y,0,rect.y+rect.h);grad.addColorStop(0,start_color);grad.addColorStop(1,end_color);item.ctx.lineWidth=1*this.pixel_ratio;item.ctx.strokeStyle='rgba(0, 0, 0, 0.1)';item.ctx.fillStyle=grad;item.ctx.fillRect(rect.x,rect.y,rect.w,rect.h);item.ctx.beginPath();item.ctx.moveTo(rect.x+line_offset,rect.y+rect.h-line_offset);item.ctx.lineTo(rect.x+line_offset,rect.y+line_offset);item.ctx.lineTo(rect.x+rect.w-line_offset,rect.y+line_offset);item.ctx.stroke();item.ctx.closePath();}
var record=item.record;var can_request_images=true;var i;var anims=this.get_anims_for_item_by_name(item,'position');if(anims.length)
can_request_images=false;if(!item.hasOwnProperty('image')&&can_request_images){if(record.get('image')){path=this.templates.thumb.apply({image_src:record.get('image')});this.request_image(path,item);}
item.image=null;}
var box_width=this.to_view_dist(this.box_width,true);var box_height=this.to_view_dist(this.box_height,true);var max_image_w=box_width-2*padding;var max_image_h=box_height-padding;var image_y=padding;var image_visible=false;var image_upper_right;var shadow_offset_x=this.to_view_dist(-1.5*this.pixel_ratio,true);var shadow_offset_y=this.to_view_dist(-1*this.pixel_ratio,true);var shadow_offset_w=this.to_view_dist(3*this.pixel_ratio,true);var shadow_offset_h=this.to_view_dist(4*this.pixel_ratio,true);var radius=this.to_view_dist(4*this.pixel_ratio,true);var shadow_start_color='rgba(0, 0, 0, 0.5)';var shadow_end_color='rgba(0, 0, 0, 0)';var shadow_rect;var status_opacity=0.5;if(item.status==='ready')
status_opacity=1.0;if(record.get('image')){var image_alpha=item.ctx.globalAlpha*(item.image_opacity||0);rect={x:padding,y:image_y,w:max_image_w,h:max_image_h};if(!item.image_opacity||item.image_opacity<1){item.ctx.save();item.ctx.globalAlpha*=1.0-image_alpha;this.render_dashed_rect(item.ctx,rect);item.ctx.restore();}
var image,image_offset_x,natural_width,natural_height;if(item.filmstrip_progress){image=item.filmstrip_image;image_offset_x=this.floor(item.filmstrip_progress*image.naturalWidth/240)*240;natural_width=240;natural_height=item.filmstrip_image.naturalHeight;}else{image=item.image||(item.missing_image&&this.missing_image);if(image){image_offset_x=0;natural_width=image.naturalWidth;natural_height=image.naturalHeight;}}
if(image&&image_alpha>0){var image_x,image_width,image_height;var scale_x=max_image_w/natural_width;var scale_y=max_image_h/natural_height;image_width=this.floor(natural_width*this.min(scale_x,scale_y));image_height=this.floor(natural_height*this.min(scale_x,scale_y));image_x=scale_x<scale_y?padding:this.floor((width-image_width)/2.0)
rect={x:image_x,y:image_y,w:image_width,h:image_height};item.ctx.save();item.ctx.globalAlpha=image_alpha*status_opacity;var shadow_rect={x:rect.x+shadow_offset_x,y:rect.y+shadow_offset_y,w:rect.w+shadow_offset_w,h:rect.h+shadow_offset_h};this.render_box_shadow(item.ctx,shadow_rect,radius,radius,false,shadow_start_color,shadow_end_color);item.ctx.drawImage(image,image_offset_x,0,natural_width,natural_height,rect.x,rect.y,rect.w,rect.h);item.ctx.restore();image_visible=true;image_upper_right={x:rect.x+rect.w,y:rect.y};}}else{item.ctx.save();item.ctx.globalAlpha*=status_opacity;rect={x:padding,y:image_y,w:max_image_w,h:max_image_h};shadow_rect={x:rect.x+shadow_offset_x,y:rect.y+shadow_offset_y,w:rect.w+shadow_offset_w,h:rect.h+shadow_offset_h};this.render_box_shadow(item.ctx,shadow_rect,radius,radius,false,shadow_start_color,shadow_end_color);item.ctx.beginPath();item.ctx.fillStyle='rgb(15, 15, 15)';item.ctx.fillRect(rect.x,rect.y,rect.w,rect.h);item.ctx.closePath();if(item.status!=='processing'){fill_style='white';if(!item.no_thumb_text||item.last_w>width||(item.last_w<width&&item.no_thumb_text.truncated))
item.no_thumb_text=this.fit_text_to_rect('No Thumbnail',item.ctx,rect);if(item.no_thumb_text.text){var text_pt={x:rect.x+this.floor(rect.w/2.0),y:rect.y+this.floor(rect.h/2.0),};this.render_text(item.ctx,item.no_thumb_text.text,text_pt,fill_style,'center','middle');}}
image_visible=true;image_upper_right={x:rect.x+rect.w,y:rect.y};item.ctx.restore();}
if(item.status!=='ready'){var d_length=this.floor(this.distance({x:0,y:0},{x:rect.w,y:rect.y}));var d_theta=Math.atan(rect.h/rect.w);var sin_d_theta=Math.sin(d_theta);var cos_d_theta=Math.cos(d_theta);var line_width=9*this.pixel_ratio*this.zoom;var angle=Math.PI/4;var tan_angle=Math.tan(angle);var t=0;var quads=[];var quad,c,i0,i1,i2,i3,d0,d1,d2,d3,d4,pt1,pt2,pts;while(t<d_length){quad=[];for(i=0;i<2;i++){c={x:rect.x+t*cos_d_theta,y:rect.y+t*sin_d_theta};i0={x:(c.y-rect.y)/tan_angle+c.x,y:rect.y};i1={x:rect.x+rect.w,y:c.y-tan_angle*(rect.x+rect.w-c.x)};d0=this.distance(i0,c);d1=this.distance(i1,c);if(d0<d1)
pt1=i0;else
pt1=i1;i2={x:rect.x,y:tan_angle*(c.x-rect.x)+c.y};i3={x:c.x-(rect.y+rect.h-c.y)/tan_angle,y:rect.y+rect.h};d2=this.distance(i2,c);d3=this.distance(i3,c);if(d2<d3)
pt2=i2;else
pt2=i3;pt1.x=this.min(rect.x+rect.w,this.max(rect.x,pt1.x));pt2.x=this.min(rect.x+rect.w,this.max(rect.x,pt2.x));pt1.y=this.min(rect.y+rect.h,this.max(rect.y,pt1.y));pt2.y=this.min(rect.y+rect.h,this.max(rect.y,pt2.y));if(i===1){pts=[];if(pt2.x!==quad[quad.length-1].x&&pt2.y!==quad[quad.length-1].y)
pts.push({x:this.min(pt2.x,quad[quad.length-1].x),y:this.max(pt2.y,quad[quad.length-1].y)});pts.push(pt2);pts.push(pt1);if(pt1.x!==quad[0].x&&pt1.y!==quad[0].y)
pts.push({x:this.max(pt1.x,quad[0].x),y:this.min(pt1.y,quad[0].y)});quad=quad.concat(pts);}else{quad=quad.concat([pt1,pt2]);t+=line_width/Math.sin(d_theta+angle);}}
quads.push(quad);}
item.ctx.save();var j;for(i=0;i<quads.length;i++){if(i%2)
item.ctx.fillStyle='rgba(0, 0, 0, 0.12)';else
item.ctx.fillStyle='rgba(255, 255, 255, 0.15)';item.ctx.beginPath();item.ctx.moveTo(quads[i][0].x,quads[i][0].y);for(j=1;j<quads[i].length;j++)
item.ctx.lineTo(quads[i][j].x,quads[i][j].y);item.ctx.closePath();item.ctx.fill();}
item.ctx.restore();}
if(item.status==='processing'){var outer_r=this.min(max_image_w/2,max_image_h/2)*0.8;item.ctx.save();item.ctx.fillStyle='rgb(255, 255, 255)';item.ctx.shadowColor='rgba(0, 0, 0, 0.8)';item.ctx.shadowBlur=outer_r/4;item.ctx.beginPath();var x=rect.x+rect.w/2;var y=rect.y+rect.h/2;var d=new Date();var percent=(d.getTime()%2000)/2000;item.ctx.arc(x,y,outer_r,0,2*Math.PI,false);item.ctx.arc(x,y,this.floor(0.85*outer_r),0,2*Math.PI,true);item.ctx.moveTo(x,y-outer_r);var start_angle=3*Math.PI/2;item.ctx.arc(x,y,this.floor(0.7*outer_r),start_angle,start_angle+2*Math.PI*percent,false);item.ctx.lineTo(x,y);item.ctx.closePath();item.ctx.fill();item.ctx.restore();}
var field_start=image_y+max_image_h;var text_height=11*this.pixel_ratio;var field_end;if(record.get('code')){var step=record.get('sg_task.Task.step');var entity=record.get('entity');var entity_type=entity&&entity.type;var step_rendered=false;var pt;if(step&&entity_type){var color;var steps=SG.globals.steps[entity_type];if(steps){for(i=0;i<steps.length;i++){if(steps[i].id===step.id){color=steps[i].color;break;}}}
if(color){item.ctx.save();var pt={x:padding,y:field_start+this.field_padding};item.ctx.beginPath();item.ctx.fillStyle='rgb('+color+')';item.ctx.lineWidth=1*this.pixel_ratio;item.ctx.strokeStyle=item.selected?'rgb(55, 55, 55)':'rgb(221, 221, 221)';item.ctx.rect(pt.x+line_offset,pt.y+line_offset,text_height,text_height);item.ctx.fill();item.ctx.stroke();item.ctx.closePath();item.ctx.restore();step_rendered=true;}}
item.ctx.save();pt={x:padding,y:field_start+this.field_padding};var step_width=15*this.pixel_ratio;if(step_rendered)
pt.x+=step_width;var w=max_image_w-(step_rendered?step_width:0);var rect={x:pt.x,y:pt.y,w:w,h:text_height};var fill_style=item.selected?'black':'rgb(221, 221, 221)';this.render_item_field(item.ctx,item,'code',rect,fill_style);item.ctx.restore();field_end=field_start+2*this.field_padding+this.field_height;}else{field_end=field_start;}
item.ctx.restore();if(item.flag_opacity>0&&image_visible){item.ctx.save();item.ctx.globalAlpha*=item.flag_opacity;var flagged_image_width=this.flagged_image.naturalWidth*this.pixel_ratio;var flagged_image_height=this.flagged_image.naturalHeight*this.pixel_ratio;var x=image_upper_right.x-flagged_image_width;var y=image_upper_right.y;item.ctx.drawImage(this.flagged_image,x,y,flagged_image_width,flagged_image_height);item.ctx.restore();}
rect={x:2,y:field_end,w:width-4,h:this.progress_area_height-1};var progress_w=0;if(item.playing&&item.progress>0){var progress_w=this.floor(item.progress*rect.w);item.ctx.fillStyle='rgb(226, 226, 238)';item.ctx.fillRect(rect.x,rect.y,progress_w,rect.h);}
if(rect.w-progress_w>0){var fill_style;if(item.playing)
fill_style='rgb(184, 184, 213)';else if(item.viewed)
fill_style='rgb(95, 92, 120)';else if(item.selected)
fill_style='rgb(196, 195, 164)';else
fill_style='rgb(68, 68, 68)';item.ctx.fillStyle=fill_style;item.ctx.fillRect(rect.x+progress_w,rect.y,rect.w-progress_w,rect.h);}
item.ctx.lineWidth=1*this.pixel_ratio;item.ctx.strokeStyle='rgba(255, 255, 255, 0.2)';item.ctx.beginPath();item.ctx.moveTo(rect.x+line_offset,rect.y+rect.h-line_offset);item.ctx.lineTo(rect.x+line_offset,rect.y+line_offset);item.ctx.lineTo(rect.x+rect.w-line_offset,rect.y+line_offset);item.ctx.stroke();item.ctx.closePath();item.ctx.strokeStyle='rgba(0, 0, 0, 0.2)';item.ctx.beginPath();item.ctx.moveTo(rect.x+rect.w-line_offset,rect.y+3*line_offset);item.ctx.lineTo(rect.x+rect.w-line_offset,rect.y+rect.h-line_offset);item.ctx.lineTo(rect.x+3*line_offset,rect.y+rect.h-line_offset);item.ctx.stroke();item.ctx.closePath();item.ctx.restore();item.last_w=width;},render_load_more_button:function(ctx,width,height,regions){var item=this.load_more_button_item;if(!item.visibility)
return;var rect=this.to_view_rect(item.bb,true);var view_rect={x:0,y:0,w:width,h:height};if(!this.intersects(rect,view_rect))
return;if(!regions)
regions=[view_rect];var render_callback={fn:function(){this.render_load_more_button_canvas(item,rect.w,rect.h);},scope:this};ctx.save();ctx.globalAlpha=item.visibility;this.render_to_regions(ctx,item,rect,regions,render_callback);ctx.restore();},render_load_more_button_canvas:function(item,width,height){var padding=this.to_view_dist(this.box_padding,true);var rect={x:padding,y:padding,w:width-2*padding,h:height-2*padding};this.render_dashed_rect(item.ctx,rect);var arm_width=this.to_view_dist(5*this.pixel_ratio,true);var arm_length=this.to_view_dist(10*this.pixel_ratio,true);var start={x:this.floor((width-arm_width)/2),y:this.floor((height-arm_width)/2)-arm_length};item.ctx.moveTo(start.x,start.y);item.ctx.lineTo(start.x+arm_width,start.y);item.ctx.lineTo(start.x+arm_width,start.y+arm_length);item.ctx.lineTo(start.x+arm_width+arm_length,start.y+arm_length);item.ctx.lineTo(start.x+arm_width+arm_length,start.y+arm_length+arm_width);item.ctx.lineTo(start.x+arm_width,start.y+arm_length+arm_width);item.ctx.lineTo(start.x+arm_width,start.y+2*arm_length+arm_width);item.ctx.lineTo(start.x,start.y+2*arm_length+arm_width);item.ctx.lineTo(start.x,start.y+arm_length+arm_width);item.ctx.lineTo(start.x-arm_length,start.y+arm_length+arm_width);item.ctx.lineTo(start.x-arm_length,start.y+arm_length);item.ctx.lineTo(start.x,start.y+arm_length);item.ctx.lineTo(start.x,start.y);item.ctx.fillStyle='rgba(221, 221, 221, 0.5)';item.ctx.fill();},render_counts:function(ctx,width,height,regions){if(!this.get_mode()||!this.node)return;var canvas=this.get_counts_canvas(width,height);var padding=5*this.pixel_ratio;var scroll_rect=this.get_horizontal_scroll_area_geometry(width,height);var rect={x:this.floor((width-canvas.width)/2.0)-padding,y:scroll_rect.y-padding-canvas.height,w:canvas.width,h:canvas.height};if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var subregions=this.get_intersecting_subregions(rect,regions);if(!subregions.length)return;ctx.save();var i,sub_rect,source_x,source_y,source_w,source_h;for(i=0;i<subregions.length;i++){sub_rect=subregions[i];source_x=sub_rect.x-rect.x;source_y=sub_rect.y-rect.y;source_w=this.min(sub_rect.w,canvas.width-source_x)||1;source_h=this.min(sub_rect.h,canvas.height-source_y)||1;ctx.drawImage(canvas,source_x,source_y,source_w,source_h,sub_rect.x,sub_rect.y,sub_rect.w,sub_rect.h);}
ctx.restore();},counts_content_changed:function(){return this.current_num_versions!==this.counts_item.current_num_versions||this.current_num_entities!==this.counts_item.current_num_entities||this.total_num_versions!==this.counts_item.total_num_versions||this.total_num_entities!==this.counts_item.total_num_entities;},get_counts_canvas:function(width,height){var item=this.counts_item;var rerender=false;if(!item.canvas){item.canvas=document.createElement('canvas');item.ctx=item.canvas.getContext('2d');rerender=true;}
if(this.counts_content_changed())
rerender=true;if(rerender)
this.render_counts_canvas();return item.canvas;},render_counts_canvas:function(){var entity_type=this.get_entity_type_name_for_current_mode();var ctx=this.counts_item.ctx;var current_num_items,total_num_items;if(this.is_rendering_versions()){current_num_items=this.current_num_versions;total_num_items=this.total_num_versions;}else if(this.current_num_versions>0){current_num_items=this.current_num_entities;total_num_items=this.total_num_entities;}else{current_num_items=0;total_num_items=0;}
var font_size=this.floor(11*this.pixel_ratio);var font_style=font_size+'px Helvetica';var text_parts=[{text:'Displaying ',font:font_style},{text:current_num_items,font:'bold '+font_style},{text:' of ',font:font_style},{text:total_num_items,font:'bold '+font_style},{text:' '+entity_type.pluralize(total_num_items),font:font_style},];if(this.is_rendering_entities()){text_parts=text_parts.concat([{text:' and ',font:font_style},{text:this.current_num_versions,font:'bold '+font_style},{text:' Versions',font:font_style}]);}
var max_text_width=0;var text_widths=[0];var num_lines=1;var i;for(i=0;i<text_parts.length;i++){if(text_parts[i].line){num_lines++;text_widths.push(0);continue;}
ctx.font=text_parts[i].font;text_parts[i].width=ctx.measureText(text_parts[i].text).width;text_widths[num_lines-1]+=text_parts[i].width;max_text_width=this.max(text_widths[num_lines-1],max_text_width);}
var padding=5*this.pixel_ratio;var rect_w=max_text_width+2*padding;var rect_h=num_lines*(font_size+padding)+padding;if(this.counts_item.canvas.width!==rect_w||this.counts_item.canvas.height!==rect_h){this.counts_item.canvas.width=rect_w;this.counts_item.canvas.height=rect_h;}else{ctx.clearRect(0,0,rect_w,rect_h);}
ctx.fillStyle='rgba(0, 0, 0, 0.6)';ctx.fillRect(0,0,rect_w,rect_h);var offset=4*this.pixel_ratio;var text_pt={x:this.floor((rect_w-text_widths[0])/2),y:offset};var shadow_offset=1*this.pixel_ratio;var line_count=0;var shadow_pt;for(i=0;i<text_parts.length;i++){if(text_parts[i].line){line_count++;text_pt.x=this.floor((rect_w-text_widths[line_count])/2)
text_pt.y+=line_count*(font_size+offset);continue;}
shadow_pt={x:text_pt.x+shadow_offset,y:text_pt.y+shadow_offset};ctx.font=text_parts[i].font;this.render_text(ctx,text_parts[i].text,shadow_pt,'rgba(0, 0, 0, 0.6)',null,'top');this.render_text(ctx,text_parts[i].text,text_pt,'rgb(221, 221, 221)',null,'top');text_pt.x+=text_parts[i].width;}
this.counts_item.current_num_versions=this.current_num_versions;this.counts_item.current_num_entities=this.current_num_entities;this.counts_item.total_num_versions=this.total_num_versions;this.counts_item.total_num_entities=this.total_num_entities;},update_header_item_bounding_boxes:function(width,height){var start=this.get_timeline_origin(width,height);var start_x=0;var end_x=0;var w=this.to_view_dist(this.box_width,true);var i,item,start_pt,end_pt,bb;for(i=0;i<this.header_items.length;i++){item=this.header_items[i];start_pt={x:start.x+i*this.box_width,y:start.y};end_pt={x:start_pt.x+this.box_width,y:start.y};start_pt=this.to_view_coords(start_pt,true);end_pt=this.to_view_coords(end_pt,true);bb={x:start_pt.x,y:0,w:end_pt.x-start_pt.x,h:this.header_height+this.header_shadow_height};if(item.bb.w!==bb.w||item.bb.h!==item.h)
item.rerender=true;item.bb=bb;if(i===0)
start_x=bb.x;else if(i===this.header_items.length-1)
end_x=bb.x+bb.w;}
this.header_bar_left_item.bb={x:0,y:0,w:this.max(0,start_x),h:this.header_height+this.header_shadow_height};this.header_bar_right_item.bb={x:this.min(width,end_x),y:0,w:width-this.min(width,end_x),h:this.header_height+this.header_shadow_height};this.header_dirty=true;},render_header:function(ctx,width,height,regions){var rect={x:0,y:0,w:width,h:this.header_height+this.header_shadow_height};if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var subregions=this.get_intersecting_subregions(rect,regions);if(!subregions.length)
return;var resize=false;var canvas;if(!this.header_background_canvas){canvas=document.createElement('canvas');this.header_background_canvas=canvas;resize=true;}else{canvas=this.header_background_canvas;if(this.header_background_canvas.width!==rect.w||this.header_background_canvas.height!==rect.h)
resize=true;}
if(resize){canvas.width=rect.w;canvas.height=rect.h;var hctx=canvas.getContext('2d');hctx.fillStyle='rgb(80, 80, 80)';hctx.fillRect(rect.x,rect.y,rect.w,this.header_height);var border_width=1*this.pixel_ratio;hctx.fillStyle='rgb(55, 55, 55)';hctx.fillRect(rect.x,rect.y+this.header_height-border_width,rect.w,border_width);var shadow_height=rect.y+rect.h-this.header_height;var shadow_rect={x:rect.x,y:rect.y+this.header_height,w:rect.w,h:shadow_height};grad=hctx.createLinearGradient(shadow_rect.x,shadow_rect.y,shadow_rect.x,shadow_rect.y+shadow_rect.h);grad.addColorStop(0,'rgba(0, 0, 0, 0.15)');grad.addColorStop(1,'rgba(0, 0, 0, 0)');hctx.fillStyle=grad;hctx.fillRect(shadow_rect.x,shadow_rect.y,shadow_rect.w,shadow_rect.h);}
var i,sub_rect,source_x,source_y,source_w,source_h;for(i=0;i<subregions.length;i++){sub_rect=subregions[i];source_x=sub_rect.x-rect.x;source_y=sub_rect.y-rect.y;source_w=this.min(sub_rect.w,canvas.width-source_x)||1;source_h=this.min(sub_rect.h,canvas.height-source_y)||1;ctx.drawImage(canvas,source_x,source_y,source_w,source_h,sub_rect.x,sub_rect.y,sub_rect.w,sub_rect.h);}
var items=[this.header_bar_left_item,this.header_bar_right_item].concat(this.header_items);var i;for(i=0;i<items.length;i++)
this.render_header_item(ctx,items[i],width,height,regions);this.header_dirty=false;},render_header_item:function(ctx,item,width,height,regions){var rect=item.bb;if(rect.w<1)
return;if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var render_callback={fn:function(){this.render_header_item_canvas(item,rect.w,rect.h);},scope:this};this.render_to_regions(ctx,item,rect,regions,render_callback);},render_header_item_background:function(ctx,rect,left_shadow,right_highlight){var header_height=this.header_height;var grad;if(left_shadow){grad=ctx.createLinearGradient(0,0,0,header_height);grad.addColorStop(0,'rgba(55, 55, 55, 0)');grad.addColorStop(1,'rgba(55, 55, 55, 1)');ctx.fillStyle=grad;ctx.fillRect(rect.x,rect.y,1,header_height-1);}
if(right_highlight){grad=ctx.createLinearGradient(0,0,0,header_height);grad.addColorStop(0,'rgba(255, 255, 255, 0)');grad.addColorStop(1,'rgba(255, 255, 255, 0.2)');ctx.fillStyle=grad;ctx.fillRect(rect.x+rect.w-1,rect.y,1,header_height-1);}},render_header_item_canvas:function(item,width,height){var ctx=item.ctx;var header_height=this.header_height;var entity=item.entity;var column_padding=3*this.pixel_ratio;var offset=0.5*this.pixel_ratio;var render_left_shadow=item!==this.header_bar_left_item;var render_right_highlight=item!==this.header_bar_right_item;this.render_header_item_background(ctx,{x:0,y:0,w:width,h:height},render_left_shadow,render_right_highlight);if(!entity)
return;var me=this;var make_onload_callback=function(entity_type,image){return function(){me.entity_type_icons[entity_type].image=image;var i,item;for(i=0;i<me.entity_order.length;i++){item=me.entity_order[i].item;if(item&&me.entity_order[i].type===entity_type)
item.rerender=true;}
me.render();};};var icon=null;if(this.entity_type_icons.hasOwnProperty(entity.type)){if(this.entity_type_icons[entity.type].image)
icon=this.entity_type_icons[entity.type].image;}else{var image=new Image();this.entity_type_icons[entity.type]={fetching:true};image.onload=make_onload_callback(entity.type,image);image.src='/images/icon_'+entity.type+'.png';}
var font=11*this.pixel_ratio+'px Helvetica';if(ctx.font!==font)
ctx.font=font;var baseline='top';if(ctx.textBaseline!==baseline)
ctx.textBaseline=baseline;if(item.opacity){var grad=ctx.createLinearGradient(0,0,0,header_height);grad.addColorStop(0,'rgba(105, 105, 105, 0)');grad.addColorStop(0.3,'rgba(105, 105, 105, 1)');var bg_padding=1*this.pixel_ratio;ctx.save();ctx.globalAlpha=item.opacity;ctx.fillStyle=grad;ctx.fillRect(bg_padding,0,width-2*bg_padding,header_height-bg_padding);ctx.restore();}
var entity_name=item.entity_name;var padding=8*this.pixel_ratio;var icon_width=icon?icon.naturalWidth*this.pixel_ratio:0;var icon_height=icon?icon.naturalHeight*this.pixel_ratio:0;var spacing=3*this.pixel_ratio;var text_rect={x:padding+(icon?icon_width+spacing:0),y:0,w:this.max(width-2*padding-(icon?icon_width+spacing:0),0),h:header_height};if(!entity_name||item.last_w>text_rect.w||(item.last_w<text_rect.w&&entity_name.truncated)){entity_name=this.fit_text_to_rect(entity.name,ctx,text_rect);item.entity_name=entity_name;}
var text_size=11*this.pixel_ratio;text_point={x:this.floor((width-entity_name.width)/2.0),y:this.floor((header_height-text_size)/2.0)};if(icon){var offset=icon_width;if(entity_name.width)
offset+=spacing;text_point.x-=this.floor(offset/2.0);ctx.drawImage(icon,text_point.x,this.floor((header_height-icon_height)/2.0),icon_width,icon_height);text_point.x+=offset;}
if(entity_name.text)
this.render_text(ctx,entity_name.text,text_point,'rgb(221, 221, 221)');item.last_w=text_rect.w;ctx.restore();},render_dashed_rect:function(ctx,rect,stroke_style){var pts=[{x:rect.x,y:rect.y},{x:rect.x+rect.w,y:rect.y},{x:rect.x+rect.w,y:rect.y+rect.h},{x:rect.x,y:rect.y+rect.h}];var dash_length=4*this.pixel_ratio;var line_offset=0.5*this.pixel_ratio;ctx.lineWidth=1*this.pixel_ratio;ctx.strokeStyle=stroke_style||'rgb(221, 221, 221)';ctx.beginPath();var i,j,length_x,length_y,length,previous,vec_x,vec_y,start,end;for(i=0;i<pts.length;i++){previous=i===0?3:i-1;length_x=(pts[i].x-pts[previous].x);length_y=(pts[i].y-pts[previous].y);length=this.max(Math.abs(length_x),Math.abs(length_y));vec_x=length_x?length_x/Math.abs(length_x):0;vec_y=length_y?length_y/Math.abs(length_y):0;for(j=0;j<length;j+=dash_length*2){start={x:pts[previous].x+vec_x*j,y:pts[previous].y+vec_y*j};end={x:pts[previous].x+vec_x*this.min(j+dash_length,length),y:pts[previous].y+vec_y*this.min(j+dash_length,length)};ctx.moveTo(start.x+line_offset,start.y+line_offset);ctx.lineTo(end.x+line_offset,end.y+line_offset);}}
ctx.stroke();ctx.closePath();},render_text:function(ctx,text,point,fill_style,align,baseline,font_size){if(font_size){var font=font_size+'px Helvetica';if(ctx.font!==font)
ctx.font=font;}
if(baseline&&ctx.textBaseline!==baseline)
ctx.textBaseline=baseline;if(fill_style&&ctx.fillStyle!==fill_style)
ctx.fillStyle=fill_style;if(align&&ctx.textAlign!==align)
ctx.textAlign=align;ctx.fillText(text,point.x,point.y);},render_item_field:function(ctx,item,field_name,rect,fill_style,align,font_size){var width=this.to_view_dist(item.bb.w,true);var previous_text=item[field_name+'_text'];if(!previous_text||item.last_w>width||(item.last_w<width&&previous_text.truncated)){var text=this.fit_text_to_rect(item.record.get(field_name),ctx,rect);item[field_name+'_text']=text;}
if(item[field_name+'_text'].text)
this.render_text(ctx,item[field_name+'_text'].text,rect,fill_style);},render_drag_selection_box:function(ctx){var rect=this.to_view_rect({x:this.drag_selection_start.x,y:this.drag_selection_start.y,w:this.drag_selection_end.x-this.drag_selection_start.x,h:this.drag_selection_end.y-this.drag_selection_start.y},true);ctx.fillStyle='rgba(255, 255, 255, 0.2)';ctx.fillRect(rect.x,rect.y,rect.w,rect.h);var offset=1*this.pixel_ratio;this.render_dashed_rect(ctx,{x:rect.x,y:rect.y,w:rect.w-offset,h:rect.h-offset},'rgba(0, 0, 0, 0.5)');this.render_dashed_rect(ctx,{x:rect.x-offset,y:rect.y-offset,w:rect.w-offset,h:rect.h-offset});},render_shadows:function(ctx,width,height){var canvas_xy=this.canvas_xy;if(this.shadow_canvas.getX()!==this.canvas_xy[0]||this.shadow_canvas.getY()!==this.canvas_xy[1]){this.shadow_canvas.setXY(this.canvas_xy);}
if(Number(this.shadow_canvas.dom.getAttribute('width'))!==width||Number(this.shadow_canvas.dom.getAttribute('height'))!==height){this.shadow_canvas.dom.setAttribute('width',width);this.shadow_canvas.dom.setAttribute('height',height);var shadow_ctx=this.shadow_canvas.dom.getContext('2d');if(this.pixel_ratio!==1){this.shadow_canvas.dom.style.width=width/this.pixel_ratio+'px';this.shadow_canvas.dom.style.height=height/this.pixel_ratio+'px';}
var start_color='rgba(0, 0, 0, 0.15)';var end_color='rgba(0, 0, 0, 0)';this.render_box_shadow(shadow_ctx,{x:0,y:0,w:width,h:height},this.shadow_radius,this.corner_radius,true,start_color,end_color);}},render_box_shadow:function(ctx,rect,shadow_radius,corner_radius,inset,start_color,end_color){corner_radius=corner_radius?this.max(corner_radius,shadow_radius):shadow_radius;if(rect.h<=2*shadow_radius||rect.w<=2*shadow_radius){var rgb_1=start_color.match(/\(([^\(\)]*)\)/)[1].split(',');var rgb_2=end_color.match(/\(([^\(\)]*)\)/)[1].split(',');var r_1=Number(rgb_1[0]);var g_1=Number(rgb_1[1]);var b_1=Number(rgb_1[2]);var a_1=rgb_1.length>3?Number(rgb_1[3]):1;var r_2=Number(rgb_2[0]);var g_2=Number(rgb_2[1]);var b_2=Number(rgb_2[2]);var a_2=rgb_2.length>3?Number(rgb_2[3]):1;var ratio=this.min(rect.h,rect.w)/(2*shadow_radius);var r=(1-ratio)*r_1+ratio*r_2;var g=(1-ratio)*g_1+ratio*g_2;var b=(1-ratio)*b_1+ratio*b_2;var a=(1-ratio)*a_1+ratio*a_2;end_color='rgba('+r+', '+g+', '+b+', '+a+')';}
var corner_width=this.min(this.floor(rect.w/2),corner_radius);var corner_height=this.min(this.floor(rect.h/2),corner_radius);corner_radius=this.min(corner_width,corner_height);shadow_radius=this.min(corner_radius,shadow_radius);var grad,start;if(rect.w-2*corner_width>0){start=rect.y+corner_height-corner_radius;grad=ctx.createLinearGradient(rect.x,start,rect.x,start+shadow_radius);grad.addColorStop(inset?0:1,start_color);grad.addColorStop(inset?1:0,end_color);ctx.fillStyle=grad;ctx.fillRect(rect.x+corner_width,rect.y,rect.w-2*corner_width,corner_height);start=rect.y+rect.h-corner_height+corner_radius;grad=ctx.createLinearGradient(rect.x,start,rect.x,start-shadow_radius);grad.addColorStop(inset?0:1,start_color);grad.addColorStop(inset?1:0,end_color);ctx.fillStyle=grad;ctx.fillRect(rect.x+corner_width,rect.y+rect.h-corner_height,rect.w-2*corner_width,corner_height);}
grad=ctx.createRadialGradient(rect.x+corner_width,rect.y+corner_height,corner_radius-shadow_radius,rect.x+corner_width,rect.y+corner_height,corner_radius);grad.addColorStop(inset?0:1,end_color);grad.addColorStop(inset?1:0,start_color);ctx.fillStyle=grad;ctx.fillRect(rect.x,rect.y,corner_width,corner_height);grad=ctx.createRadialGradient(rect.x+rect.w-corner_width,rect.y+corner_height,corner_radius-shadow_radius,rect.x+rect.w-corner_width,rect.y+corner_height,corner_radius);grad.addColorStop(inset?0:1,end_color);grad.addColorStop(inset?1:0,start_color);ctx.fillStyle=grad;ctx.fillRect(rect.x+rect.w-corner_width,rect.y,corner_width,corner_height);if(rect.h-2*corner_height>0){start=rect.x+rect.w-corner_width+corner_radius
grad=ctx.createLinearGradient(start,rect.y,start-shadow_radius,rect.y);grad.addColorStop(inset?0:1,start_color);grad.addColorStop(inset?1:0,end_color);ctx.fillStyle=grad;ctx.fillRect(rect.x+rect.w-corner_width,rect.y+corner_height,corner_width,rect.h-2*corner_height);start=rect.x+corner_width-corner_radius;grad=ctx.createLinearGradient(start,rect.y,start+shadow_radius,rect.y);grad.addColorStop(inset?0:1,start_color);grad.addColorStop(inset?1:0,end_color);ctx.fillStyle=grad;ctx.fillRect(rect.x,rect.y+corner_height,corner_width,rect.h-2*corner_height);}
grad=ctx.createRadialGradient(rect.x+rect.w-corner_width,rect.y+rect.h-corner_height,corner_radius-shadow_radius,rect.x+rect.w-corner_width,rect.y+rect.h-corner_height,corner_radius);grad.addColorStop(inset?0:1,end_color);grad.addColorStop(inset?1:0,start_color);ctx.fillStyle=grad;ctx.fillRect(rect.x+rect.w-corner_width,rect.y+rect.h-corner_height,corner_width,corner_height);grad=ctx.createRadialGradient(rect.x+corner_width,rect.y+rect.h-corner_height,corner_radius-shadow_radius,rect.x+corner_width,rect.y+rect.h-corner_height,corner_radius);grad.addColorStop(inset?0:1,end_color);grad.addColorStop(inset?1:0,start_color);ctx.fillStyle=grad;ctx.fillRect(rect.x,rect.y+rect.h-corner_height,corner_width,corner_height);if(!inset){ctx.fillStyle=start_color;ctx.fillRect(rect.x+corner_width,rect.y+corner_height,rect.w-2*corner_width,rect.h-2*corner_height);}},update_scrollbar_bounding_boxes:function(width,height,view_rect,bounds_rect){var h_scroll_vis=this.horizontal_scrollbar_is_showing(view_rect,bounds_rect)?1:0;var v_scroll_vis=this.vertical_scrollbar_is_showing(view_rect,bounds_rect)?1:0;if(!this.horizontal_scrollbar_item.bb||h_scroll_vis){var h_bb=this.get_horizontal_scrollbar_geometry(width,height,view_rect,bounds_rect);this.horizontal_scrollbar_item.bb=h_bb;this.horizontal_scrollbar_item.rerender=true;}
if(!this.vertical_scrollbar_item.bb||v_scroll_vis){var v_bb=this.get_vertical_scrollbar_geometry(width,height,view_rect,bounds_rect);this.vertical_scrollbar_item.bb=v_bb;this.vertical_scrollbar_item.rerender=true;}
var current_h_scroll_vis=this.horizontal_scrollbar_item.visibility||0;var current_v_scroll_vis=this.vertical_scrollbar_item.visibility||0;this.horizontal_scrollbar_item.visibility=h_scroll_vis;if(h_scroll_vis!==current_h_scroll_vis)
this.horizontal_scrollbar_item.rerender=true;this.vertical_scrollbar_item.visibility=v_scroll_vis;if(v_scroll_vis!==current_v_scroll_vis)
this.vertical_scrollbar_item.rerender=true;},render_scrollbars:function(ctx,width,height,view_rect,bounds_rect,regions){if(this.horizontal_scrollbar_item.visibility)
this.render_scrollbar(ctx,this.horizontal_scrollbar_item,width,height,regions);if(this.vertical_scrollbar_item.visibility)
this.render_scrollbar(ctx,this.vertical_scrollbar_item,width,height,regions);},render_scrollbar:function(ctx,item,width,height,regions){var rect=item.bb;if(!rect)
return;if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var subregions=this.get_intersecting_subregions(rect,regions);if(!subregions.length)
return;var render_callback={fn:function(){this.render_scrollbar_canvas(item,rect.w,rect.h);},scope:this};this.render_to_regions(ctx,item,rect,regions,render_callback);},render_scrollbar_canvas:function(item,width,height){var offset=0.5*this.pixel_ratio;var ctx=item.ctx;ctx.save();ctx.lineWidth=1*this.pixel_ratio;ctx.fillStyle='rgba(0, 0, 0, 0.4)';ctx.strokeStyle='rgb(180, 180, 180)';ctx.fillRect(0,0,width,height);ctx.strokeRect(offset,offset,width-2*offset,height-2*offset);ctx.restore();},render_zoom_slider:function(ctx,width,height,regions){if(!this.slider_left_small_image.complete||!this.slider_right_large_image.complete)
return;var item=this.zoom_slider_item;var rect=item.bb;if(!regions)
regions=[{x:0,y:0,w:width,h:height}];var render_callback={fn:function(){this.render_zoom_slider_canvas(item,rect.w,rect.h);},scope:this};ctx.save();ctx.globalAlpha=this.zoom_slider_item.opacity;this.render_to_regions(ctx,item,rect,regions,render_callback);ctx.restore();},render_zoom_slider_canvas:function(item,width,height){var ctx=item.ctx;var slider_area=this.get_zoom_slider_area({x:0,y:0,w:width,h:height});var gutter_height=5*this.pixel_ratio;var gutter_rect={x:slider_area.x+this.floor(this.zoom_handle_size/2),y:slider_area.y+this.floor((slider_area.h-gutter_height)/2),w:slider_area.w-this.zoom_handle_size,h:gutter_height};var grad=ctx.createLinearGradient(gutter_rect.x,gutter_rect.y,gutter_rect.x,gutter_rect.y+gutter_rect.h);grad.addColorStop(0,'rgb(100, 100, 100)');grad.addColorStop(1,'rgb(221, 221, 221)');var offset=0.5*this.pixel_ratio;ctx.fillStyle=grad;ctx.lineWidth=1*this.pixel_ratio;ctx.strokeStyle='rgb(68, 68, 68)';ctx.fillRect(gutter_rect.x,gutter_rect.y,gutter_rect.w,gutter_rect.h);ctx.strokeRect(gutter_rect.x+offset,gutter_rect.y+offset,gutter_rect.w-2*offset,gutter_rect.h-2*offset);var image_w=9*this.pixel_ratio;var image_h=8*this.pixel_ratio;var spacing=3*this.pixel_ratio;var image_rect={x:gutter_rect.x-image_w-this.floor(this.zoom_handle_size/2)-spacing,y:gutter_rect.y+this.floor((gutter_rect.h-image_h)/2),w:image_w,h:image_h};ctx.drawImage(this.slider_left_small_image,image_rect.x,image_rect.y,image_rect.w,image_rect.h);image_w=14*this.pixel_ratio;image_h=12*this.pixel_ratio;image_rect={x:gutter_rect.x+gutter_rect.w+this.floor(this.zoom_handle_size/2)+spacing,y:gutter_rect.y+this.floor((gutter_rect.h-image_h)/2),w:image_w,h:image_h};ctx.drawImage(this.slider_right_large_image,image_rect.x,image_rect.y,image_rect.w,image_rect.h);var handle_rect=this.get_zoom_slider_handle_area(slider_area);var radius=this.floor(handle_rect.h/2);var center_x=handle_rect.x+radius;var center_y=handle_rect.y+radius;var grad=ctx.createRadialGradient(handle_rect.x,handle_rect.y,0,handle_rect.x,handle_rect.y,radius*3);grad.addColorStop(0,'rgb(221, 221, 221)');grad.addColorStop(1,'rgb(100, 100, 100)');ctx.fillStyle=grad;ctx.beginPath();ctx.arc(center_x,center_y,radius,0,2*Math.PI,false);ctx.fill();ctx.stroke();ctx.closePath();this.zoom_slider_zoom=this.zoom;},on_dblclick:function(event){var clicked_item=this.get_item_under_mouse(event);if(clicked_item&&SG.globals.review_app_player){this.view_versions([clicked_item.record.get_id()]);return;}},on_canvas_mousewheel:function(event){var e=event.browserEvent;if('wheelDeltaX'in e){wheel_delta_x=e.wheelDeltaX*0.125;wheel_delta_y=e.wheelDeltaY*0.125;}else{wheel_delta_x=e.axis===1?-e.detail:0;wheel_delta_y=e.axis===2?-e.detail:0;}
if(Math.abs(wheel_delta_x)<2&&Math.abs(wheel_delta_y)<2)return;var delta_x=this.to_local_dist(wheel_delta_x);var delta_y=this.to_local_dist(wheel_delta_y);var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);this.scroll_by({x:delta_x,y:delta_y},width,height,view_rect,bounds_rect);this.on_cursor_local_coords_change(event);},on_canvas_mousedown:function(event){event.preventDefault();if(document.activeElement!==this.shadow_canvas.dom){document.activeElement.blur();this.shadow_canvas.focus();}
var canvas_xy=this.canvas_xy;var x,y;if(this.touch_interface){if(event.browserEvent.touches.length===1){if(this.last_touch_time&&event.browserEvent.timeStamp-this.last_touch_time<250){this.on_dblclick(event);return;}
x=event.browserEvent.touches[0].pageX-canvas_xy[0];y=event.browserEvent.touches[0].pageY-canvas_xy[1];this.last_touch_time=event.browserEvent.timeStamp;}else{return;}}else{var xy=event.getXY();x=xy[0]-canvas_xy[0];y=xy[1]-canvas_xy[1];}
var pt={x:x*this.pixel_ratio,y:y*this.pixel_ratio};var width=this.canvas_w;var height=this.canvas_h;if(this.header_area_is_showing()&&this.point_is_in_header_area(pt,width,height))
return;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);this.shadow_canvas.setStyle('cursor','pointer');this.zoom_slider_active=false;if(this.zoom_slider_is_showing()){if(this.point_is_in_zoom_slider_handle_area(pt,width,height)){this.zoom_slider_active=true;return;}else if(this.point_is_in_zoom_slider_area(pt,width,height)){var zoom=this.get_zoom_for_point_in_zoom_slider_area(pt,width,height);this.set_zoom(zoom);this.zoom_slider_active=true;return;}else if(this.point_is_in_zoom_slider_focus_area(pt,width,height)){return;}}
this.horizontal_scrolling_start=null;var geo_area,cur_pos,new_pos;if(this.horizontal_scrollbar_is_showing(view_rect,bounds_rect)){if(this.touch_interface){this.horizontal_scrolling_start=this.to_local_coords({x:pt.x,y:0}).x;}else if(this.point_is_in_horizontal_scroll_area(pt,width,height,view_rect,bounds_rect)){geo_area=this.get_horizontal_scroll_area_geometry(width,height,view_rect,bounds_rect);var geo_h=this.get_horizontal_scrollbar_geometry(width,height,view_rect,bounds_rect);if(geo_h&&x>=geo_h.x&&y>=geo_h.y&&x<geo_h.x+geo_h.w&&y<geo_h.y+geo_h.h){this.horizontal_scrolling_start=x-geo_h.x;return;}
cur_pos=view_rect.x+view_rect.w/2.0;geo_area=this.get_horizontal_scroll_area_geometry(width,height,view_rect,bounds_rect);new_pos=(pt.x-geo_area.x)/geo_area.w*bounds_rect.w+bounds_rect.x;this.scroll_by({x:cur_pos-new_pos,y:0},width,height,view_rect,bounds_rect);this.horizontal_scrolling_start=geo_h.w/2.0;return;}}
this.vertical_scrolling_start=null;if(this.vertical_scrollbar_is_showing(view_rect,bounds_rect)){if(this.touch_interface){this.vertical_scrolling_start=this.to_local_coords({x:0,y:pt.y}).y;}else if(this.point_is_in_vertical_scroll_area(pt,width,height,view_rect,bounds_rect)){geo_area=this.get_vertical_scroll_area_geometry(width,height,view_rect,bounds_rect);var geo_v=this.get_vertical_scrollbar_geometry(width,height,view_rect,bounds_rect);if(geo_v&&x>=geo_v.x&&y>=geo_v.y&&x<geo_v.x+geo_v.w&&y<geo_v.y+geo_v.h){this.vertical_scrolling_start=y-geo_v.y;return;}
cur_pos=view_rect.y+view_rect.h/2.0;new_pos=(pt.y-geo_area.y)/geo_area.h*bounds_rect.h+bounds_rect.y;this.scroll_by({x:0,y:cur_pos-new_pos},width,height,view_rect,bounds_rect);this.vertical_scrolling_start=geo_v.h/2.0;return;}}
var dom_event=event.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac||sg_is_in_rv())
ctrl_click=dom_event.ctrlKey;var right_click=dom_event.which?dom_event.which===3:dom_event.button===2;if(!right_click&&this.load_more_button_is_showing()&&this.point_is_in_load_more_button(pt,width,height)){this.set_loading(true);var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state,true);var target_state=this.clone_state();if(this.is_rendering_versions())
target_state.append_versions=true;else
target_state.append_entities=true;this.fetch_versions_for_current_mode(target_state,callback);return;}
var local_pt=this.to_local_coords(pt);var clicked_item=this.get_item_containing_point(pt,width,height,view_rect,bounds_rect);if(!right_click&&!this.touch_interface){event.preventDefault();this.drag_selection_start=local_pt;this.base_selected_items={};var version_id;if(ctrl_click||event.shiftKey){for(version_id in this.selected_items)
if(this.selected_items.hasOwnProperty(version_id))
this.base_selected_items[version_id]=this.selected_items[version_id];}}
if(clicked_item){var item;if(this.last_selected_item&&event.shiftKey){var items;if(this.render_mode==='gallery'){var first_global_idx=this.last_selected_item.global_idx;var second_global_idx=clicked_item.global_idx;items=this.get_items_between_global_indexes(first_global_idx,second_global_idx);}else{var first_column_idx=this.last_selected_item.column_idx;var second_column_idx=clicked_item.column_idx;var first_row_idx=this.last_selected_item.row_idx;var second_row_idx=clicked_item.row_idx;items=this.get_items_between_row_and_column_indexes(first_column_idx,first_row_idx,second_column_idx,second_row_idx);}
var i;for(i=0;i<items.length;i++)
this.select_item(items[i]);this.selected_ids=this.sort_selected_item_ids();}else if(!event.shiftKey){var deselect_all=right_click?!clicked_item.selected:!ctrl_click;if(deselect_all){this.deselect_all_items();this.last_selected_item=null;}
var deselect=ctrl_click&&!right_click&&clicked_item.selected;if(deselect){this.deselect_item(clicked_item);}else{this.select_item(clicked_item);this.last_selected_item=clicked_item;}
this.selected_ids=this.sort_selected_item_ids();}
this.render();}
if(right_click&&this.contextmenu_callback){this.tooltip_handler.hide();this.contextmenu_callback.fn.call(this.contextmenu_callback.scope,event);}},on_mouseup:function(event){var do_render=false;if(this.touch_interface&&event.browserEvent.changedTouches.length===1&&this.last_touch_pos&&this.second_to_last_touch_pos){var delta_t=this.last_touch_pos.time-this.second_to_last_touch_pos.time;var vel_x=this.to_local_dist(this.last_touch_pos.x-this.second_to_last_touch_pos.x)/delta_t;var vel_y=this.to_local_dist(this.last_touch_pos.y-this.second_to_last_touch_pos.y)/delta_t;var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var duration=500;this.push_anim(null,'scroll',{callback:{fn:function(anim_cfg,progress){var progress_delta=anim_cfg.last_progress?progress-anim_cfg.last_progress:0;anim_cfg.last_progress=progress;var dx=this.floor(vel_x*duration*progress_delta*(1.0-this.ease_in_out(progress)));var dy=this.floor(vel_y*duration*progress_delta*(1.0-this.ease_in_out(progress)));this.scroll_by({x:dx,y:dy},width,height,view_rect,bounds_rect);},scope:this},duration:duration});do_render=true;this.last_touch_pos=null;this.second_to_last_touch_pos=null;}
if(this.horizontal_scrolling_start||this.vertical_scrolling_start||this.drag_selection_start||this.zoom_slider_active){event.preventDefault();}
this.horizontal_scrolling_start=null;this.vertical_scrolling_start=null;this.zoom_slider_active=false;if(this.drag_selection_start){do_render=true;this.selected_ids=this.sort_selected_item_ids();if(!this.get_item_under_mouse(event))
this.shadow_canvas.setStyle('cursor','default');this.drag_selection_start=null;this.drag_selection_end=null;this.drag_selection_released=true;}
if(do_render)
this.render();return;},on_mousemove:function(event){if(!this.horizontal_scrolling_start&&!this.vertical_scrolling_start&&!this.drag_selection_start&&!this.zoom_slider_active)
return;event.preventDefault();var xy=event.getXY();var canvas_xy=this.canvas_xy;var x,y;if(this.touch_interface){if(event.browserEvent.changedTouches.length===1){x=event.browserEvent.changedTouches[0].pageX-canvas_xy[0];y=event.browserEvent.changedTouches[0].pageY-canvas_xy[1];if(this.last_touch_pos)
this.second_to_last_touch_pos=this.last_touch_pos;this.last_touch_pos={x:x,y:y,time:event.browserEvent.timeStamp};}else{this.horizontal_scrolling_start=null;this.vertical_scrolling_start=null;this.drag_selection_start=null;this.zoom_slider_active=null;return;}}else{var xy=event.getXY();x=xy[0]-canvas_xy[0];y=xy[1]-canvas_xy[1];}
var pt={x:this.pixel_ratio*x,y:this.pixel_ratio*y};var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var x_dist=0;var geo_area,geo_bar,cur_pos,new_pos;if(this.horizontal_scrolling_start){if(this.touch_interface){x_dist=this.to_local_coords({x:pt.x,y:0}).x-this.horizontal_scrolling_start;}else{geo_area=this.get_horizontal_scroll_area_geometry(width,height,view_rect,bounds_rect);geo_bar=this.get_horizontal_scrollbar_geometry(width,height,view_rect,bounds_rect);cur_pos=view_rect.x+view_rect.w/2.0;var new_bar_x=pt.x-geo_area.x-this.horizontal_scrolling_start;new_pos=(new_bar_x+geo_bar.w/2.0)/geo_area.w*bounds_rect.w+bounds_rect.x;x_dist=cur_pos-new_pos;}}
var y_dist=0;if(this.vertical_scrolling_start){if(this.touch_interface){y_dist=this.to_local_coords({x:0,y:pt.y}).y-this.vertical_scrolling_start;}else{geo_area=this.get_vertical_scroll_area_geometry(width,height,view_rect,bounds_rect);geo_bar=this.get_vertical_scrollbar_geometry(width,height,view_rect,bounds_rect);cur_pos=view_rect.y+view_rect.h/2.0;var new_bar_y=pt.y-geo_area.y-this.vertical_scrolling_start;new_pos=(new_bar_y+geo_bar.h/2.0)/geo_area.h*bounds_rect.h+bounds_rect.y;y_dist=cur_pos-new_pos;}}
if(x_dist||y_dist){this.scroll_by({x:x_dist,y:y_dist},width,height,view_rect,bounds_rect);return;}
if(this.zoom_slider_active){var zoom=this.get_zoom_for_point_in_zoom_slider_area(pt,width,height);this.set_zoom(zoom);return;}
var i;if(this.drag_selection_start){var local_pt=this.to_local_coords(pt);var canvas_width=this.canvas_w;var canvas_height=this.canvas_h;var off_top=pt.y-10*this.pixel_ratio;var off_right=pt.x-canvas_width+10*this.pixel_ratio;var off_bottom=pt.y-canvas_height+10*this.pixel_ratio;var off_left=pt.x-10*this.pixel_ratio;var x_scroll,y_scroll;if(off_top<0||off_right>0||off_bottom>0||off_left<0){x_scroll=0;if(off_left<0)
x_scroll=this.to_local_dist(off_left);else if(off_right>0)
x_scroll=this.to_local_dist(off_right);y_scroll=0;if(off_top<0)
y_scroll=this.to_local_dist(off_top);else if(off_bottom>0)
y_scroll=this.to_local_dist(off_bottom);this.drag_selection_end={x:local_pt.x+x_scroll,y:local_pt.y+y_scroll};}else{this.drag_selection_end=local_pt;}
var x=this.drag_selection_start.x;var y=this.drag_selection_start.y;var w=this.drag_selection_end.x-this.drag_selection_start.x;var h=this.drag_selection_end.y-this.drag_selection_start.y;x=this.min(x,x+w);y=this.min(y,y+h);w=Math.abs(w);h=Math.abs(h);if(w+h<6*this.pixel_ratio)return;var items=this.get_items_overlapping_rect({x:x,y:y,w:w,h:h});var version_id;for(version_id in this.selected_items)
this.deselect_item(this.selected_items[version_id]);for(version_id in this.base_selected_items)
this.select_item(this.base_selected_items[version_id]);for(i=0;i<items.length;i++)
this.select_item(items[i]);if(x_scroll||y_scroll)
this.scroll_by({x:-x_scroll,y:-y_scroll},width,height,view_rect,bounds_rect);else
this.render();return;}},on_canvas_mousemove:function(event){if(this.drag_selection_start||this.vertical_scrolling_start||this.horizontal_scrolling_start||this.zoom_slider_active)
return;this.on_cursor_local_coords_change(event);},on_canvas_mouseout:function(event){var xy=event.getXY();var canvas_xy=this.canvas_xy;var width=this.canvas_w;var height=this.canvas_h;var pt={x:this.pixel_ratio*(xy[0]-canvas_xy[0]),y:this.pixel_ratio*(xy[1]-canvas_xy[1])};if(this.clear_unhovered_items(pt,null,width,height))
this.render();},on_canvas_gesturestart:function(event){event.preventDefault();if(!this.disable_zooming&&event.browserEvent.scale){this.initial_zoom=this.zoom;this.initial_scale=event.browserEvent.scale;return;}},on_canvas_gesturechange:function(event){event.preventDefault();if(!this.disable_zooming&&this.initial_zoom&&event.browserEvent.scale){var zoom=this.initial_zoom*event.browserEvent.scale/this.initial_scale;zoom=this.min(this.max(zoom,this.zoom_min),this.zoom_max);if(zoom!=this.zoom)
this.set_zoom(zoom);event.stopEvent();return;}},on_canvas_gestureend:function(event){event.preventDefault();if(!this.disable_zooming&&this.initial_zoom){this.initial_zoom=null;this.initial_scale=null;return;}},on_cursor_local_coords_change:function(event){var xy=event.getXY();var canvas_xy=this.canvas_xy;var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var pt={x:this.pixel_ratio*(xy[0]-canvas_xy[0]),y:this.pixel_ratio*(xy[1]-canvas_xy[1])};var anim_added=false;var i;if(this.header_area_is_showing()&&(!this.point_is_in_controls(pt,width,height,view_rect,bounds_rect)||this.point_is_in_header_area(pt,width,height))){var entity=this.get_entity_for_point_in_timeline(pt,width,height);if(entity&&entity.item&&entity.item.target_opac!==1){var item=entity.item;var init_opac=item.opacity||0;anims=this.get_anims_for_item_by_name(item,'opacity');for(i=0;i<anims.length;i++)
this.cancel_anim(anims[i]);item.target_opac=1;if(init_opac!==1){this.push_anim(item,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(init_opac,1,anim_cfg,progress);},scope:this},duration:250*(1-init_opac),delay:250});anim_added=true;}}}
if(this.point_is_in_controls(pt,width,height,view_rect,bounds_rect)){if(!this.point_is_in_header_area(pt,width,height))
this.shadow_canvas.setStyle('cursor','pointer');if(this.zoom_slider_is_showing()&&this.point_is_in_zoom_slider_focus_area(pt,width,height)&&this.zoom_slider_item.opacity_target!==1){this.zoom_slider_item.opacity_target=1;anim_cfgs=this.get_anims_for_item_by_name(this.zoom_slider_item,'opacity');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);init_opac=this.zoom_slider_item.opacity;if(init_opac!==1){this.push_anim(this.zoom_slider_item,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(init_opac,1,anim_cfg,progress);},scope:this},duration:250*(2-2*init_opac)});anim_added=true;}}
if(this.clear_unhovered_items(pt,null,width,height,true)||anim_added)
this.render();return;}
if(this.load_more_button_is_showing()&&this.point_is_in_load_more_button(pt,width,height)){this.shadow_canvas.setStyle('cursor','pointer');if(this.clear_unhovered_items(pt,null,width,height,true)||anim_added)
this.render();return;}
var hovered_item=this.get_item_containing_point(pt,width,height,view_rect,bounds_rect);var anim_cfgs,current_opac;if(hovered_item&&hovered_item.state!=='removed'&&!this.hovered_items.hasOwnProperty(hovered_item.record.get_id())){var filmstrip_image=hovered_item.record.get('filmstrip_image');var can_request_images=true;var anims=this.get_anims_for_item_by_name(hovered_item,'position');if(anims.length)
can_request_images=false;if(filmstrip_image&&!hovered_item.hasOwnProperty('filmstrip_image')&&can_request_images){var path=this.templates.filmstrip_image.apply({image_src:filmstrip_image});this.request_image(path,hovered_item,true);hovered_item.filmstrip_image=null;}
this.shadow_canvas.setStyle('cursor','pointer');this.hovered_items[hovered_item.record.get_id()]=hovered_item;var initial_opac=hovered_item.opacity;anim_cfgs=this.get_anims_for_item_by_name(hovered_item,'opacity');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);if(initial_opac!==1){this.push_anim(hovered_item,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(initial_opac,1,anim_cfg,progress);},scope:this}});anim_added=true;}}
var local_pt=this.to_local_coords(pt);if(hovered_item&&hovered_item.filmstrip_image){hovered_item.filmstrip_progress=(local_pt.x-hovered_item.bb.x)/hovered_item.bb.w;hovered_item.rerender=true;}
if(this.clear_unhovered_items(pt,hovered_item,width,height))
anim_added=true;if(anim_added||(hovered_item&&hovered_item.rerender))
this.render();},on_flagged_state_changed:function(args){var version_ids=args.version_ids;var sender=args.sender;if(sender==='timeline')return;var record_ids=[];var i;for(i=0;i<version_ids.length;i++){if(this.get_record_by_id(version_ids[i]))
record_ids.push(version_ids[i]);}
if(record_ids.length)
this.fetch_flagged_states(record_ids);},on_updates_enabled:function(enabled){if(enabled&&this.updates_disabled){this.updates_disabled=false;this.determine_viewed_version();}else if(!enabled&&!this.updates_disabled){this.updates_disabled=true;}},on_image_load:function(item,image){item.image=image;this.push_anim(item,'image',{callback:{fn:this.fade_image_in,scope:this}});this.render();},on_image_error:function(item){item.missing_image=true;this.push_anim(item,'image',{callback:{fn:this.fade_image_in,scope:this}});this.render();},update_timeline:function(previous_state,append){var render_mode=this.render_mode;var node_changed=!previous_state.node||previous_state.node.get_path()!==this.node.get_path();var render_mode_changed=!previous_state.render_mode||previous_state.render_mode!=render_mode;var previous_render_mode=previous_state.render_mode;var mode=this.get_mode();var data_set;if(mode==='playlist')
data_set=this.playlist_versions_set;else if(mode==='version_page')
data_set=this.page_versions_set;else
data_set=this.versions_set;var num_columns=append?this.num_columns:0;var num_rows=append?this.num_rows:0;var count=append?previous_state.current_num_versions:0;var width=this.canvas_w;var height=this.canvas_h;var view_rect=this.get_view_rect(this.canvas_w,this.canvas_h);var bounds_rect=this.get_bounds_rect(this.canvas_w,this.canvas_h);var i,group;if(this.is_rendering_versions()){this.header_items=[];num_columns+=data_set.count();num_rows=1;count+=data_set.count();}else{var start_index=0;if(append)
start_index=previous_state.entity_order.length;else
this.header_items=[];var header_item_width=this.to_view_dist(this.box_width,true);var num_versions,header_item;for(i=start_index;i<this.entity_order.length;i++){if(!this.entity_order[i])
continue;group=this.get_group_for_entity(this.entity_order[i]);num_versions=group?group.ids.length:0;this.entity_order[i].count=num_versions;num_rows=this.max(num_versions,num_rows);count+=num_versions;if(render_mode==='cut'||num_versions){header_item={entity:this.entity_order[i],bb:{}};this.header_items.push(header_item);this.entity_order[i].item=header_item;num_columns++;}}}
var num_columns_changed=false;if(num_columns!==this.num_columns){num_columns_changed=!render_mode_changed&&render_mode!=='gallery';this.num_columns=num_columns;}
var num_rows_changed=false;if(num_rows!==this.num_rows){num_rows_changed=!render_mode_changed&&render_mode!=='gallery';this.num_rows=num_rows;}
var num_versions_changed=render_mode==='gallery'&&count!==previous_state.current_num_versions;if(count!==0){if(node_changed||render_mode_changed){this.reset_origin(width,height);this.reset_bounds();}else if(num_columns_changed||num_versions_changed){this.reset_bounds();}}
if(!this.is_rendering_versions())
this.update_header_item_bounding_boxes(width,height);var empty=count===0;if(empty&&render_mode==='cut'&&this.current_num_entities!==this.total_num_entities)
empty=false;SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'dataset_empty',args:empty});if(!append){var version_ids=[];var j;if(this.is_rendering_versions()){for(i=0;i<data_set.count();i++)
version_ids.push(data_set.get_record(i).get_id());}else{for(i=0;i<data_set.groups.length;i++)
version_ids=version_ids.concat(data_set.groups[i].ids);}
var me=this;var make_completion_callback=function(item){return{fn:function(){this.rtree.remove(item.bb,item);this.deletion_queue[item.record.get_id()]=item;},scope:me};};var selection_changed=false;var version_id;for(version_id in this.version_items){if(this.version_items.hasOwnProperty(version_id)&&version_ids.indexOf(Number(version_id))>-1)
continue;item=this.version_items[version_id];if(item.state==='removed')
continue;item.state='removed';item.selected=false;if(this.selected_items.hasOwnProperty(version_id)){delete this.selected_items[version_id];selection_changed=true;}
this.push_anim(item,'visibility',{callback:{fn:this.fade_item_out,scope:this},complete_callback:make_completion_callback(item),duration:500,delay:250});}
if(selection_changed)
this.selected_ids=this.sort_selected_item_ids();}
if(render_mode_changed||num_rows_changed||(render_mode!=='gallery'&&node_changed)){if(!this.active_band_item.hasOwnProperty('visibility')){this.active_band_item.visibility=previous_render_mode!=='gallery'&&this.num_rows>1?1:0;this.active_band_item.rerender=true;}
var ab_target_opac=render_mode!=='gallery'&&num_rows>1?1:0;var ab_init_opac=this.active_band_item.visibility;if(ab_init_opac!==ab_target_opac)
this.push_anim(this.active_band_item,'visibility',{callback:{fn:function(anim_cfg,progress){this.fade_item_from_to(ab_init_opac,ab_target_opac,anim_cfg,progress);},scope:this},delay:ab_target_opac?500:0});if(render_mode!=='gallery'){var old_bb=sg_deep_copy(this.active_band_item.bb);var ab_target_bb=this.get_active_band_geometry(width,height,view_rect);if(!this.active_band_item.bb||render_mode_changed){this.active_band_item.bb=ab_target_bb;}else if(this.active_band_item.bb.x!==ab_target_bb.x||this.active_band_item.bb.y!==ab_target_bb.y){this.push_anim(this.active_band_item,'position',{callback:{fn:function(anim_cfg,progress){this.move_bb(old_bb,ab_target_bb,anim_cfg,progress);},scope:this},delay:250});}}}
if(render_mode_changed&&render_mode==='gallery')
this.num_items_per_row=this.get_num_items_per_row(width);if(append){var version_id,item;for(version_id in this.version_items)
if(this.version_items.hasOwnProperty(version_id)){item=this.version_items[version_id];if(item.state==='removed')
continue;this.add_item(item.record,item.global_idx,item.column_idx,item.row_idx,render_mode,width,height);}}
var load_more_is_showing=this.load_more_button_is_showing();var load_more_changed=!previous_state.node||load_more_is_showing!==this.load_more_button_is_showing_for_state(previous_state);if(load_more_changed){var target_opac=load_more_is_showing?1:0;var init_opac=this.load_more_button_item.visibility||0;if(this.load_more_button_item.target_visibility!==target_opac){this.load_more_button_item.target_visibility=target_opac;if(init_opac!==target_opac)
this.push_anim(this.load_more_button_item,'visibility',{callback:{fn:function(anim_cfg,progress){this.fade_item_from_to(init_opac,target_opac,anim_cfg,progress);},scope:this},duration:500*(target_opac?1-init_opac:init_opac),delay:250});}}
if(load_more_is_showing){var lm_bb=this.get_load_more_button_geometry(width,height);if(load_more_changed){this.load_more_button_item.bb=lm_bb;}else{var old_bb=sg_deep_copy(this.load_more_button_item.bb);if(old_bb.x!==lm_bb.x||old_bb.y!==lm_bb.y)
this.push_anim(this.load_more_button_item,'position',{callback:{fn:function(anim_cfg,progress){this.move_bb(old_bb,lm_bb,anim_cfg,progress);},scope:this},duration:500,delay:250});}}
var count=append?previous_state.current_num_versions:0;var start_column_idx=append?previous_state.entity_order.length:0;var start_from,bb;if(this.is_rendering_versions()){for(i=0;i<data_set.count();i++){bb=this.add_item(data_set.get_record(i),count,start_column_idx+i,0,render_mode,width,height,start_from);if(i===0)
start_from=bb;count++;}}else{if(!this.entity_map||!append)
this.entity_map={};var j,key,active_id,offset,entity,group,id;var col_idx=start_column_idx;for(i=start_column_idx;i<this.entity_order.length;i++){if(!this.entity_order[i])continue;key=this.entity_order[i].type+'_'+this.entity_order[i].id;active_id=this.active_versions?this.active_versions[key]:null;group=this.get_group_for_entity(this.entity_order[i]);if(!group){this.entity_map[key]=[];if(render_mode==='cut')
col_idx++;continue;}
offset=active_id?group.ids.indexOf(active_id):0;this.entity_map[key]=group.ids.slice(0);for(j=0;j<group.ids.length;j++){id=group.ids[j];bb=this.add_item(data_set.get_record_by_id(id),count,col_idx,j-offset,render_mode,width,height,start_from);if(i===0&&j===0)
start_from=bb;count++;}
col_idx++;}}
this.set_loading(false);if(render_mode!=='gallery')
this.set_active_versions(this.active_versions);this.determine_viewed_version();view_rect=this.get_view_rect(this.canvas_w,this.canvas_h);bounds_rect=this.get_bounds_rect(this.canvas_w,this.canvas_h);this.update_scrollbar_bounding_boxes(width,height,view_rect,bounds_rect);this.render();},add_item:function(record,global_idx,column_idx,row_idx,render_mode,width,height,start_from){var bb=this.get_version_item_bounding_box(width,height,global_idx,column_idx,row_idx,render_mode);start_from=start_from||bb;var make_complete_callback=function(item){return{fn:function(){item.state='unchanged';},scope:this};};var version_id=record.get_id();var fade_in_delay=250+this.to_view_dist(this.distance(start_from,bb),true)/2;var cfg,target_opac;if(!this.version_items.hasOwnProperty(version_id)){cfg={state:'added',bb:bb,column_idx:column_idx,row_idx:row_idx,global_idx:global_idx,record:record,visibility:0,flagged:record.get('flagged'),flag_opacity:record.get('flagged')?1:0};cfg.opacity=this.get_item_opacity_for_mode(cfg,render_mode);this.push_anim(cfg,'visibility',{start_callback:{fn:function(){this.rtree.remove(cfg.bb,cfg);this.rtree.insert(cfg.bb,cfg);},scope:this},callback:{fn:this.fade_item_in,scope:this},complete_callback:make_complete_callback(cfg),duration:500,delay:fade_in_delay});this.version_items[version_id]=cfg;}else{cfg=this.version_items[version_id];if(bb.x!==cfg.bb.x||bb.y!==cfg.bb.y){cfg.state='moved';cfg.column_idx=column_idx;cfg.row_idx=row_idx;cfg.global_idx=global_idx;cfg.target_bb=bb;target_opac=this.get_item_opacity_for_mode(cfg,render_mode);if(cfg.visibility===0){this.rtree.remove(cfg.bb,cfg);this.rtree.insert(cfg.bb,cfg);this.push_anim(cfg,'visibility',{callback:{fn:this.fade_item_in,scope:this},complete_callback:make_complete_callback(cfg),duration:500,delay:fade_in_delay});}
this.push_anim(cfg,'position',{callback:{fn:function(anim_cfg,progress){this.move_item(sg_deep_copy(cfg.bb),bb,anim_cfg,progress);},scope:this},complete_callback:make_complete_callback(cfg),duration:1000,delay:250});if(cfg.opacity!==target_opac)
this.push_anim(cfg,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(cfg.opacity,target_opac,anim_cfg,progress);},scope:this},duration:1000,delay:250});}else{cfg.state='unchanged';cfg.column_idx=column_idx;cfg.row_idx=row_idx;cfg.global_idx=global_idx;}
if(cfg.flagged!==record.get('flagged')){if(isNaN(cfg.flagged_opacity))
cfg.flagged_opacity=record.get('flagged')?1:0;var from_opac=cfg.flagged_opacity;var to_opac=record.get('flagged')?1:0;cfg.flagged=record.get('flagged');if(from_opac!==to_opac){this.push_anim(cfg,'flagged',{callback:{fn:function(anim_cfg,progress){this.flag_opacity_from_to(from_opac,to_opac,anim_cfg,progress);},scope:this}});}}}
var status='ready';if(SG.globals.review_app_player){var state=SG.globals.review_app_player.get_record_status(record);if(state===SG.globals.review_app_player.status.UNAVAILABLE)
status='unavailable';else if(state===SG.globals.review_app_player.status.PROCESSING)
status='processing';}
if(cfg.status!==status){cfg.status=status;if(status==='processing')
this.push_anim(cfg,'status',{periodic:true,frequency:1000/30});}
cfg.sg_tip=this.get_tooltip_for_item(cfg);if(cfg.state!=='removed')
this.update_bounds(bb);return bb;},update_item_positions:function(width,height,skip_animate){var complete_callback={fn:function(){var items=[];var version_id,item,anims,i;for(version_id in this.version_items){if(this.version_items.hasOwnProperty(version_id)){item=this.version_items[version_id];if(item.state==='removed')continue;anims=this.get_anims_for_item_by_name(item,'position');for(i=0;i<anims.length;i++)
if(!anims[i].to_delete)
return;items.push(item);}}
this.reset_bounds();for(i=0;i<items.length;i++)
this.update_bounds(items[i].bb);var view_rect=this.get_view_rect(width,height);var bounds_rect=this.get_bounds_rect(width,height);this.update_scrollbar_bounding_boxes(width,height,view_rect,bounds_rect);this.render();},scope:this};var me=this;var make_move_item_callback=function(orig_bb,target_bb){return{fn:function(anim_cfg,progress){this.move_item(orig_bb,target_bb,anim_cfg,progress);},scope:me};};var do_animate=false;var render_mode=this.render_mode;var cfg,bb,version_id,anim_cfgs,i,position_changed;for(version_id in this.version_items){if(this.version_items.hasOwnProperty(version_id)){cfg=this.version_items[version_id];if(cfg.state==='removed')continue;bb=this.get_version_item_bounding_box(width,height,cfg.global_idx,cfg.column_idx,cfg.row_idx,render_mode);if(skip_animate){this.rtree.remove(cfg.bb,cfg);cfg.bb=bb;this.rtree.insert(cfg.bb,cfg);}else if(cfg.bb.w!==bb.w||cfg.bb.h!==bb.h){this.rtree.remove(cfg.bb,cfg);cfg.bb.w=bb.w;cfg.bb.h=bb.h;this.rtree.insert(cfg.bb,cfg);}
anim_cfgs=this.get_anims_for_item_by_name(cfg,'position');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);if(skip_animate||(cfg.bb.x===bb.x&&cfg.bb.y===bb.y))
continue;do_animate=true;this.push_anim(cfg,'position',{callback:make_move_item_callback(sg_deep_copy(cfg.bb),bb),complete_callback:complete_callback});}}
if(this.load_more_button_is_showing()){bb=this.get_load_more_button_geometry(width,height);if(skip_animate)
this.load_more_button_item.bb=bb;anim_cfgs=this.get_anims_for_item_by_name(this.load_more_button_item,'position');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);var old_bb=sg_deep_copy(this.load_more_button_item.bb);if(!skip_animate&&(old_bb.x!==bb.x||old_bb.y!==bb.y)){do_animate=true;this.push_anim(this.load_more_button_item,'position',{callback:{fn:function(anim_cfg,progress){this.move_bb(old_bb,bb,anim_cfg,progress);},scope:this}});}}
if(do_animate)
this.render();else if(skip_animate)
complete_callback.fn.call(complete_callback.scope);},reset_bounds:function(){this.min_x=Number.MAX_VALUE;this.min_y=Number.MAX_VALUE;this.max_x=-Number.MAX_VALUE;this.max_y=-Number.MAX_VALUE;},update_bounds:function(bb){this.min_x=this.min(this.min_x,bb.x);this.min_y=this.min(this.min_y,bb.y);this.max_x=this.max(this.max_x,bb.x+bb.w);this.max_y=this.max(this.max_y,bb.y+bb.h);},get_num_items_per_row:function(width){return this.floor((width-2.0*this.canvas_padding)/this.to_view_dist(this.box_width));},to_local_coords:function(pt){var zoom=this.zoom;var x=pt.x/zoom+this.tx;var y=pt.y/zoom+this.ty;return{x:x,y:y};},to_view_coords:function(pt,floor){var zoom=this.zoom;var x=floor?this.floor(zoom*(pt.x-this.tx)):zoom*(pt.x-this.tx);var y=floor?this.floor(zoom*(pt.y-this.ty)):zoom*(pt.y-this.ty);return{x:x,y:y};},to_view_rect:function(rect,floor){var upper_left_corner=this.to_view_coords({x:rect.x,y:rect.y},floor);var lower_right_corner=this.to_view_coords({x:rect.x+rect.w,y:rect.y+rect.h},floor);return{x:upper_left_corner.x,y:upper_left_corner.y,w:lower_right_corner.x-upper_left_corner.x,h:lower_right_corner.y-upper_left_corner.y};},to_local_dist_for_zoom:function(dist,zoom){return dist/zoom;},to_local_dist:function(dist){return dist/this.zoom;},to_view_dist:function(dist,floor){var zoom=this.zoom;return floor?this.floor(dist*zoom):dist*zoom;},get_timeline_width:function(){return this.num_columns*this.box_width;},get_version_item_bounding_box:function(width,height,global_idx,column_idx,row_idx,render_mode){var box_height=this.get_version_height();var y_offset=0;var start,x,y;if(render_mode!=='gallery'){start=this.get_timeline_origin(width,height);var row_offset=0;if(row_idx!==0){row_offset=(row_idx<0?-1:1)*this.to_local_dist(this.active_band_line_width);}
x=start.x+column_idx*this.box_width;y=start.y+(box_height+y_offset)*row_idx+row_offset;}else{start=this.get_gallery_origin();x=start.x+(global_idx%this.num_items_per_row)*this.box_width;y=start.y+this.floor(global_idx/this.num_items_per_row)*(y_offset+box_height);}
return{x:x,y:y,w:this.box_width,h:box_height};},get_timeline_origin_for_zoom:function(width,height,zoom){var padding_local=this.to_local_dist_for_zoom(this.canvas_padding,zoom);var timeline_width=this.get_timeline_width();var canvas_width_local=this.to_local_dist_for_zoom(width,zoom);var canvas_height_local=this.to_local_dist_for_zoom(height,zoom);if(this.load_more_button_is_showing())
timeline_width+=this.box_width;var offset_x;if(timeline_width+2*padding_local<canvas_width_local)
offset_x=(canvas_width_local-timeline_width)/2;else
offset_x=padding_local;var box_height=this.get_version_height();var offset_y;if(box_height+2*padding_local<canvas_height_local)
offset_y=(canvas_height_local-box_height)/2;else
offset_y=padding_local;return{x:this.ox+offset_x,y:this.oy+offset_y};},get_timeline_origin:function(width,height){return this.get_timeline_origin_for_zoom(width,height,this.zoom);},get_gallery_origin:function(){var padding_local=this.to_local_dist(this.canvas_padding);return{x:this.ox+padding_local,y:this.oy+padding_local};},get_version_height_for_zoom:function(zoom){var fields_height=this.num_fields*(2*this.to_local_dist_for_zoom(this.field_padding,zoom)+
this.to_local_dist_for_zoom(this.field_height,zoom));return this.box_height+fields_height+this.to_local_dist_for_zoom(this.progress_area_height,zoom);},get_version_height:function(){return this.get_version_height_for_zoom(this.zoom);},get_view_rect:function(width,height){var bb=this.to_local_coords({x:0,y:0});var local_width=this.to_local_dist(width);var local_height=this.to_local_dist(height);return{x:bb.x,y:bb.y,w:local_width,h:local_height};},get_bounds_rect:function(width,height){var canvas_width_local=this.to_local_dist(width);var canvas_height_local=this.to_local_dist(height);var canvas_padding=this.to_local_dist(this.canvas_padding);var render_mode=this.render_mode;var left_padding=canvas_padding;var timeline_width;if(render_mode!=='gallery'){timeline_width=this.get_timeline_width();if(this.load_more_button_is_showing())
timeline_width+=this.box_width;if(timeline_width+2*left_padding<canvas_width_local)
left_padding=(canvas_width_local-timeline_width)/2.0;}
var top_padding=canvas_padding;var box_height=this.get_version_height();if(render_mode!=='gallery'&&2*top_padding+box_height<canvas_height_local){top_padding=(canvas_height_local-box_height)/2.0;}
var bounds_x,bounds_width;if(render_mode==='cut'){bounds_x=this.get_timeline_origin(width,height).x;bounds_width=timeline_width;}else{bounds_x=this.min_x;bounds_width=this.max_x-this.min_x;}
var bounds_y=this.min_y;var bounds_height=this.max_y-this.min_y;if(this.load_more_button_is_showing()){if(render_mode==='gallery'&&this.current_num_versions%this.num_items_per_row===0)
bounds_height+=box_height;else
bounds_width+=this.box_width;}
bounds_x-=left_padding;bounds_y-=top_padding;bounds_width=this.max(bounds_width+2*left_padding,canvas_width_local);bounds_height=this.max(bounds_height+2*top_padding,canvas_height_local);return{x:bounds_x,y:bounds_y,w:bounds_width,h:bounds_height};},is_rendering_versions_for_state:function(state){return state.render_mode==='gallery'||['playlist','version_page'].indexOf(this.get_mode_for_state(state))>-1;},is_rendering_entities_for_state:function(state){return!this.is_rendering_versions_for_state(state);},is_rendering_versions:function(){return this.is_rendering_versions_for_state(this.get_state());},is_rendering_entities:function(){return this.is_rendering_entities_for_state(this.get_state());},load_more_button_is_showing_for_state:function(state){if(this.is_rendering_versions_for_state(state))
return state.current_num_versions<state.total_num_versions;else
return state.current_num_entities<state.total_num_entities;},load_more_button_is_showing:function(){return this.load_more_button_is_showing_for_state(this.get_state());},get_load_more_button_geometry:function(width,height){var box_height=this.get_version_height();var origin,x,y;if(this.render_mode==='gallery'){origin=this.get_gallery_origin();x=origin.x+(this.current_num_versions%this.num_items_per_row)*this.box_width;y=origin.y+this.floor(this.current_num_versions/this.num_items_per_row)*box_height;}else{origin=this.get_timeline_origin(width,height);x=origin.x+this.get_timeline_width();y=origin.y;}
return{x:x,y:y,w:this.box_width,h:box_height};},get_active_band_geometry:function(width,height,view_rect){var line_width=this.to_local_dist(this.active_band_line_width);var y=this.get_timeline_origin(width,height).y-line_width;var h=this.get_version_height()+2*line_width;return{x:view_rect.x,y:y,w:view_rect.w,h:h};},point_is_in_load_more_button:function(pt,width,height){var rect=this.to_view_rect(this.get_load_more_button_geometry(width,height),true);return(pt.x>=rect.x&&pt.y>=rect.y&&pt.x<rect.x+rect.w&&pt.y<rect.y+rect.h);},horizontal_scrollbar_is_showing:function(view_rect,bounds_rect){if(this.render_mode==='gallery'||bounds_rect.x===Number.MAX_VALUE||bounds_rect.y===Number.MAX_VALUE)
return false;var delta=0.0001;return(Math.abs(view_rect.x-bounds_rect.x)>delta||Math.abs(view_rect.x-bounds_rect.x+view_rect.w-bounds_rect.w)>delta);},vertical_scrollbar_is_showing:function(view_rect,bounds_rect){if(bounds_rect.x===Number.MAX_VALUE||bounds_rect.y===Number.MAX_VALUE)
return false;var delta=0.0001;return(Math.abs(view_rect.y-bounds_rect.y)>delta||Math.abs(view_rect.y-bounds_rect.y+view_rect.h-bounds_rect.h)>delta);},get_horizontal_scroll_area_width:function(width){return width-this.scrollbar_padding*3-this.scrollbar_width;},get_vertical_scroll_area_height:function(width,height){var sa_height=height-this.scrollbar_padding*2;if(this.header_area_is_showing())
sa_height-=this.get_header_area(width,height).h;return sa_height;},get_horizontal_scroll_area_geometry:function(width,height){var y=height-this.scrollbar_padding-this.scrollbar_width;width=this.get_horizontal_scroll_area_width(width)+this.scrollbar_padding;return{x:0,y:y,w:width,h:this.scrollbar_width+this.scrollbar_padding};},point_is_in_horizontal_scroll_area:function(pt,width,height,view_rect,bounds_rect){var geo_area=this.get_horizontal_scroll_area_geometry(width,height,view_rect,bounds_rect);return(geo_area&&pt.x>=geo_area.x&&pt.y>=geo_area.y&&pt.x<geo_area.x+geo_area.w&&pt.y<geo_area.y+geo_area.h);},get_horizontal_scrollbar_geometry:function(width,height,view_rect,bounds_rect){var view_start_h=this.max((view_rect.x-bounds_rect.x)/bounds_rect.w,0);var view_end_h=this.min((view_rect.x+view_rect.w-bounds_rect.x)/bounds_rect.w,1);var view_w=view_end_h-view_start_h;var view_mid_h=(view_start_h+view_end_h)/2;var view_progress=(view_mid_h-view_w/2)/(1-view_w);var full_width=this.get_horizontal_scroll_area_width(width);var width_h=this.max(this.floor(full_width*(view_end_h-view_start_h)),20*this.pixel_ratio);var x_h=this.scrollbar_padding+this.floor((full_width-width_h)*view_progress);var y_h=height-this.scrollbar_padding-this.scrollbar_width;var height_h=this.scrollbar_width;return{x:x_h,y:y_h,w:width_h,h:height_h};},get_vertical_scroll_area_geometry:function(width,height){var x=width-this.scrollbar_padding-this.scrollbar_width;var y=0;if(this.header_area_is_showing()){var header_area=this.get_header_area();y=header_area.y+header_area.h;}
height=this.get_vertical_scroll_area_height(width,height);return{x:x,y:y,w:this.scrollbar_width+this.scrollbar_padding,h:height};},point_is_in_vertical_scroll_area:function(pt,width,height,view_rect,bounds_rect){var geo_area=this.get_vertical_scroll_area_geometry(width,height);return(geo_area&&pt.x>=geo_area.x&&pt.y>=geo_area.y&&pt.x<geo_area.x+geo_area.w&&pt.y<geo_area.y+geo_area.h);},get_vertical_scrollbar_geometry:function(width,height,view_rect,bounds_rect){var view_start_v=this.max((view_rect.y-bounds_rect.y)/bounds_rect.h,0);var view_end_v=this.min((view_rect.y+view_rect.h-bounds_rect.y)/bounds_rect.h,1);var view_h=view_end_v-view_start_v;var view_mid_v=(view_start_v+view_end_v)/2;var view_progress=(view_mid_v-view_h/2)/(1-view_h);var area=this.get_vertical_scroll_area_geometry(width,height);var height_v=this.max(this.floor(area.h*(view_end_v-view_start_v)),20*this.pixel_ratio);var x_v=area.x;var y_v=area.y+this.scrollbar_padding+this.floor((area.h-height_v)*view_progress);var width_v=this.scrollbar_width;return{x:x_v,y:y_v,w:width_v,h:height_v};},zoom_slider_is_showing:function(){return!this.touch_interface&&!this.disable_zooming;},get_zoom_slider_focus_area:function(width,height){var vertical_scroll=this.get_vertical_scroll_area_geometry(width,height);var horizontal_scroll=this.get_horizontal_scroll_area_geometry(width,height);var w=this.zoom_slider_width+2*this.zoom_slider_padding+
2*14*this.pixel_ratio+this.zoom_handle_size+6*this.pixel_ratio;var h=this.zoom_handle_size+2*this.zoom_slider_padding;return{x:vertical_scroll.x-w,y:horizontal_scroll.y-h,w:w,h:h};},point_is_in_zoom_slider_focus_area:function(pt,width,height){var area=this.get_zoom_slider_focus_area(width,height);return(pt.x>=area.x&&pt.y>=area.y&&pt.x<area.x+area.w&&pt.y<area.y+area.h);},get_zoom_slider_area:function(focus_area){var x_offset=this.floor((focus_area.w-this.zoom_slider_width)/2);var h=focus_area.h-2*this.zoom_slider_padding;return{x:focus_area.x+x_offset,y:focus_area.y+this.zoom_slider_padding,w:this.zoom_slider_width,h:h};},point_is_in_zoom_slider_area:function(pt,width,height){var focus_area=this.get_zoom_slider_focus_area(width,height);var area=this.get_zoom_slider_area(focus_area);return(pt.x>=area.x&&pt.y>=area.y&&pt.x<area.x+area.w&&pt.y<area.y+area.h);},get_zoom_for_point_in_zoom_slider_area:function(pt,width,height){var focus_area=this.get_zoom_slider_focus_area(width,height);var area=this.get_zoom_slider_area(focus_area);var progress=Math.pow(this.max(0,this.min(1,(pt.x-area.x)/area.w)),3);return(1-progress)*this.zoom_min+progress*this.zoom_max;},get_zoom_slider_handle_area:function(slider_area){var progress=Math.pow((this.zoom-this.zoom_min)/(this.zoom_max-this.zoom_min),1/3);var radius=this.floor(this.zoom_handle_size/2);return{x:slider_area.x+this.floor((slider_area.w-this.zoom_handle_size)*progress),y:slider_area.y,w:this.zoom_handle_size,h:this.zoom_handle_size};},point_is_in_zoom_slider_handle_area:function(pt,width,height){var focus_area=this.get_zoom_slider_focus_area(width,height);var slider_area=this.get_zoom_slider_area(focus_area);var area=this.get_zoom_slider_handle_area(slider_area);return(pt.x>=area.x&&pt.y>=area.y&&pt.x<area.x+area.w&&pt.y<area.y+area.h);},header_area_is_showing:function(){return!this.hide_header&&this.is_rendering_entities()&&this.num_columns>0&&['asset','shot'].indexOf(this.get_mode())<0;},get_header_area:function(width,height){return{x:0,y:0,h:this.num_header_fields*(2*this.field_padding+this.field_height),w:width};},get_entity_for_point_in_timeline:function(pt,width,height){if(pt.y<0||pt.y>height)
return null;var start=this.get_timeline_origin(width,height);var pt_local=this.to_local_coords(pt);var entity_float=(pt_local.x-start.x)/this.box_width;if(entity_float<0)
return null;var index=this.floor(entity_float);if(this.render_mode==='cut'){if(index<0||index>=this.entity_order.length)
return null;return this.entity_order[index];}
var count=0;var i,group;for(i=0;i<this.entity_order.length;i++){if(!this.entity_order[i]||!this.entity_order[i].count)continue;if(count===index)
return this.entity_order[i];count++;}
return null;},point_is_in_header_area:function(pt,width,height){var area=this.get_header_area(width,height);return(pt.x>=area.x&&pt.y>=area.y&&pt.x<area.x+area.w&&pt.y<area.y+area.h);},point_is_in_controls:function(point,width,height,view_rect,bounds_rect){if(this.horizontal_scrollbar_is_showing(view_rect,bounds_rect)&&this.point_is_in_horizontal_scroll_area(point,width,height,view_rect,bounds_rect))
return true;if(this.vertical_scrollbar_is_showing(view_rect,bounds_rect)&&this.point_is_in_vertical_scroll_area(point,width,height,view_rect,bounds_rect))
return true;if(this.zoom_slider_is_showing()&&this.point_is_in_zoom_slider_focus_area(point,width,height))
return true;if(this.header_area_is_showing()&&this.point_is_in_header_area(point,width,height))
return true;return false;},get_item_containing_point:function(point,width,height,view_rect,bounds_rect){if(this.point_is_in_controls(point,width,height,view_rect,bounds_rect))
return null;var local_pt=this.to_local_coords(point);var results=[];this.rtree.search({x:local_pt.x,y:local_pt.y,w:0,h:0},false,results);return results.length?results[0]:null;},get_items_between_row_and_column_indexes:function(column_idx_a,row_idx_a,column_idx_b,row_idx_b){var min_row_idx,max_row_idx,min_column_idx,max_column_idx;if(row_idx_a<row_idx_b||(row_idx_a===row_idx_b&&column_idx_a<column_idx_b)){min_row_idx=row_idx_a;min_column_idx=column_idx_a;max_row_idx=row_idx_b;max_column_idx=column_idx_b;}else{min_row_idx=row_idx_b;min_column_idx=column_idx_b;max_row_idx=row_idx_a;max_column_idx=column_idx_a;}
var items=[];var item,version_id;for(version_id in this.version_items){if(this.version_items.hasOwnProperty(version_id)){item=this.version_items[version_id];if(item.row_idx<min_row_idx||item.row_idx>max_row_idx)
continue;if(item.row_idx===min_row_idx&&item.column_idx<min_column_idx)
continue;if(item.row_idx===max_row_idx&&item.column_idx>max_column_idx)
continue;items.push(item);}}
return items;},get_items_between_global_indexes:function(global_idx_a,global_idx_b){var min_idx=this.min(global_idx_a,global_idx_b);var max_idx=this.max(global_idx_a,global_idx_b);var items=[]
var item,version_id;for(version_id in this.version_items){if(this.version_items.hasOwnProperty(version_id)){item=this.version_items[version_id];if(item.global_idx>=min_idx&&item.global_idx<=max_idx)
items.push(item);}}
return items;},get_items_overlapping_rect:function(rect){var items=[];this.rtree.search(rect,false,items);return items;},get_visible_version_items:function(view_rect){var items=this.get_items_overlapping_rect(view_rect);var map={removed:0,added:1,unchanged:2,moved:3};items.sort(function(a,b){return(map[a.state]||0)-(map[b.state]||0);});return items;},get_tooltip_for_item:function(item){var html='';if(item.status!=='ready'){var warning_icon='<div class="icon_warning" style="display: inline-block; vertical-align: text-bottom;"></div>';html+=warning_icon;if(item.status==='processing')
html+='<b>This Version is currently being transcoded</b>';else if(item.status==='unavailable')
html+='<b>This Version has no viewable media</b>';html+='<br/><hr style="border: none; border-top: 1px solid rgba(0, 0, 0, 0.25); background: none;"/>';}
if(item.record)
html+='<b>'+item.record.get('code')+'</b><br/>';var entity_record=item.record.get('entity');if(entity_record)
html+='<b>'+entity_record.type+':</b> '+entity_record.name;else
html+='No Entity Link';html+='<br/>';if(item.record){var step=item.record.get('sg_task.Task.step');if(step){var i,color;var steps=SG.globals.steps.Shot;for(i=0;i<steps.length;i++){if(steps[i].id===step.id){color=steps[i].color;break;}}
if(color)
html+='<b>Step:</b> <div class="sgw_review_app_browser_step_swatch" '+'style="background-color: rgb('+color+');"></div>'+step.name+'<br/>';}}else{html+='There are no Versions available for this '+entity_record.type+' that meet the current criteria';}
return html;},scroll_by:function(delta_vector,width,height,view_rect,bounds_rect){var do_render=false;var new_tx,new_ty;if(this.render_mode!=='gallery'&&delta_vector.x){if(view_rect.x-delta_vector.x<bounds_rect.x)
new_tx=bounds_rect.x;else if(view_rect.x+view_rect.w-delta_vector.x>bounds_rect.x+bounds_rect.w)
new_tx=bounds_rect.x+bounds_rect.w-view_rect.w;else
new_tx=this.tx-delta_vector.x;if(this.tx!==new_tx){this.tx=new_tx;do_render=true;}}
if(delta_vector.y){if(view_rect.y-delta_vector.y<bounds_rect.y)
new_ty=bounds_rect.y;else if(view_rect.y+view_rect.h-delta_vector.y>bounds_rect.y+bounds_rect.h)
new_ty=bounds_rect.y+bounds_rect.h-view_rect.h;else
new_ty=this.ty-delta_vector.y;if(this.ty!==new_ty){this.ty=new_ty;do_render=true;}}
if(do_render)
this.render();},scroll_to_version:function(version_id){if(!this.version_items.hasOwnProperty(version_id))return;var item=this.version_items[version_id];var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var target_tx=item.bb.x-(view_rect.w-this.box_width)/2;var target_ty=item.bb.y-(view_rect.h-this.get_version_height())/2;var delta_vector={x:this.tx-target_tx,y:this.ty-target_ty};this.scroll_by(delta_vector,width,height,view_rect,bounds_rect);},set_zoom:function(zoom){zoom=this.max(this.min(this.zoom_max,zoom),this.zoom_min);var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);if(this.render_mode!=='gallery'){var old_version_height=this.get_version_height();var new_version_height=this.get_version_height_for_zoom(zoom);var old_origin=this.get_timeline_origin(width,height);var new_origin=this.get_timeline_origin_for_zoom(width,height,zoom);var old_mid_y=old_origin.y+old_version_height/2;var new_mid_y=new_origin.y+new_version_height/2;var new_view_width=width/zoom;var new_view_height=height/zoom;this.tx-=(new_view_width-view_rect.w)/2-(new_origin.x-old_origin.x);this.ty-=(new_view_height-view_rect.h)/2-(new_mid_y-old_mid_y);}
this.zooming=true;this.zoom=zoom;this.zoom_slider_item.rerender=true;if(this.zoom_changed_callback)
this.zoom_changed_callback.fn.call(this.zoom_changed_callback.scope,this.zoom);if(this.render_mode!=='gallery')
this.active_band_item.bb=this.get_active_band_geometry(width,height,view_rect);this.update_item_positions(width,height,true);if(this.render_mode==='gallery'){this.reflow_gallery(width,height);return;}
this.num_items_per_row=this.get_num_items_per_row(width);return;},reflow_gallery:function(width,height){var n_per_row=this.get_num_items_per_row(width);if(this.render_mode!=='gallery')return;if(this.last_wrap_callback_id)
clearTimeout(this.last_wrap_callback_id);var me=this;this.last_wrap_callback_id=setTimeout(function(){if(n_per_row!==me.num_items_per_row){me.num_items_per_row=n_per_row;me.update_item_positions(width,height);}
clearTimeout(me.last_wrap_callback_id);},250);},reset_origin:function(width,height){this.ox=this.tx;this.oy=this.ty;},request_image:function(path,item,is_filmstrip,success_callback,error_callback){var new_image=new Image();var me=this;new_image.onload=function(){if(is_filmstrip)
item.filmstrip_image=new_image;else
me.on_image_load(item,new_image);};new_image.onerror=function(){me.on_image_error(item);};new_image.src=path;},push_anim:function(item,anim_name,anim_cfg,skip_cancel_other_anims){if(!anim_cfg)
anim_cfg={};if(item&&anim_name&&!skip_cancel_other_anims){var anims=this.get_anims_for_item_by_name(item,anim_name);var i;for(i=0;i<anims.length;i++)
this.cancel_anim(anims[i]);}
anim_cfg.name=anim_name;anim_cfg.item=item;this.anim_queue.push(anim_cfg);},get_anims_for_item:function(item){var anim_cfgs=[];var i;for(i=0;i<this.anim_queue.length;i++)
if(this.anim_queue[i].item===item)
anim_cfgs.push(this.anim_queue[i]);return anim_cfgs;},get_anims_by_name:function(name){var anim_cfgs=[];var i;for(i=0;i<this.anim_queue.length;i++)
if(this.anim_queue[i].name===name)
anim_cfgs.push(this.anim_queue[i]);return anim_cfgs;},get_anims_for_item_by_name:function(item,name){var all_anim_cfgs=this.get_anims_for_item(item);var anim_cfgs=[];for(i=0;i<all_anim_cfgs.length;i++)
if(all_anim_cfgs[i].name===name)
anim_cfgs.push(all_anim_cfgs[i]);return anim_cfgs;},cancel_anim:function(anim_cfg){var index=this.anim_queue.indexOf(anim_cfg);if(index>-1)
this.anim_queue.splice(index,1);},process_anim_queue:function(){if(!this.anim_queue.length)return false;var now=Date.now();var active_anims=[];var i,anim,frequency,progress,delay,duration;for(i=0;i<this.anim_queue.length;i++){anim=this.anim_queue[i];if(anim.to_delete)continue;if(anim.periodic){frequency=anim.frequency||250;if(!anim.last_rendered||now>anim.last_rendered+frequency){anim.last_rendered=now;active_anims.push(anim);}
continue;}
if(!anim.began)
anim.began=now;if(anim.delay&&now<anim.began+anim.delay)
continue;delay=anim.delay||0;duration=anim.duration||250;progress=this.max(0,this.min(1,(now-anim.began-delay)/duration));if(progress===0)continue;active_anims.push(anim);if(!anim.started){if(anim.start_callback)
anim.start_callback.fn.call(anim.start_callback.scope);anim.started=true;}
if(anim.callback)
anim.callback.fn.call(anim.callback.scope,anim,progress);if(progress===1){anim.to_delete=true;if(anim.item)
anim.item.rerender=true;if(anim.complete_callback)
anim.complete_callback.fn.call(anim.complete_callback.scope);}}
if(!active_anims.length)
return false;var view_rect=this.get_view_rect(this.canvas_w,this.canvas_h);this.visible_version_items=this.get_visible_version_items(view_rect);for(i=0;i<active_anims.length;i++){if(!active_anims[i].item||!active_anims[i].item.record)
return true;if(this.visible_version_items.indexOf(active_anims[i].item)>-1)
return true;}
return false;},process_anim_queue_deletions:function(){var new_anim_queue=[];var i;for(i=0;i<this.anim_queue.length;i++)
if(!this.anim_queue[i].to_delete)
new_anim_queue.push(this.anim_queue[i]);this.anim_queue=new_anim_queue;},process_deletions:function(){var selection_changed=false;var version_id,item,anims,i;for(version_id in this.deletion_queue){item=this.version_items[version_id];anims=this.get_anims_for_item(item);for(i=0;i<anims.length;i++)
this.cancel_anim(anims[i]);delete this.version_items[version_id];if(this.selected_items.hasOwnProperty(version_id)){delete this.selected_items[version_id];selection_changed=true;}
if(this.hovered_items.hasOwnProperty(version_id))
delete this.hovered_items[version_id];if(this.viewed_items.hasOwnProperty(version_id))
delete this.viewed_items[version_id];delete this.deletion_queue[version_id];}
if(selection_changed)
this.selected_ids=this.sort_selected_item_ids();},get_item_opacity_for_mode:function(item,render_mode){if(render_mode==='gallery')
return 1;if(item.selected)
return 1;if(this.hovered_items.hasOwnProperty(item.record.get_id()))
return 1;if(item.row_idx===0)
return 1;return 0.5;},get_item_under_mouse:function(event){var xy=event.getXY();var canvas_xy=this.canvas_xy;var width=this.canvas_w;var height=this.canvas_h;var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var pt={x:this.pixel_ratio*(xy[0]-canvas_xy[0]),y:this.pixel_ratio*(xy[1]-canvas_xy[1])};return this.get_item_containing_point(pt,width,height,view_rect,bounds_rect);},get_tooltip_item_under_mouse:function(event){var xy=event.getXY();var width=this.canvas_w;var height=this.canvas_h;var pt={x:this.pixel_ratio*(xy[0]-this.canvas_xy[0]),y:this.pixel_ratio*(xy[1]-this.canvas_xy[1])};var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);var item=this.get_item_containing_point(pt,width,height,view_rect,bounds_rect);if(item)
return{sg_tip:item.sg_tip};if(this.header_area_is_showing()&&this.point_is_in_header_area(pt,width,height)){var entity=this.get_entity_for_point_in_timeline(pt,width,height);if(!entity)
return null;return{sg_tip:'<b>'+entity.type+'</b>: '+entity.name};}
if(this.load_more_button_is_showing()&&this.point_is_in_load_more_button(pt,width,height)){var entity_type=this.get_entity_type_name_for_current_mode();if(this.is_rendering_versions())
num=this.min(this.version_page_size,this.total_num_versions-this.current_num_versions);else
num=this.min(this.entity_page_size,this.total_num_entities-this.current_num_entities);return{sg_tip:'Load '+num+' More '+entity_type.pluralize(num)};}
return null;},clear_unhovered_items:function(pt,hovered_item,width,height,skip_cursor_reset){var anim_added=false;var me=this;var make_fade_callback=function(current_opac,target_opac){return{fn:function(anim_cfg,progress){this.opacity_from_to(current_opac,target_opac,anim_cfg,progress);},scope:me};};var i,version_id,item,current_opac,target_opac;for(version_id in this.hovered_items){if(this.hovered_items.hasOwnProperty(version_id)){item=this.hovered_items[version_id];if(hovered_item&&item===hovered_item)
continue;delete this.hovered_items[version_id];if(item.filmstrip_progress){delete item.filmstrip_progress;item.rerender=true;anim_added=true;}
if(item.state==='removed')
continue;anim_cfgs=this.get_anims_for_item_by_name(item,'opacity');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);current_opac=item.opacity;target_opac=this.get_item_opacity_for_mode(item,this.render_mode);if(current_opac!==target_opac){this.push_anim(item,'opacity',{callback:make_fade_callback(current_opac,target_opac)});anim_added=true;}}}
var entity=this.get_entity_for_point_in_timeline(pt,width,height);var item,j,init_opac,anims;for(i=0;i<this.header_items.length;i++){item=this.header_items[i];if((entity&&item===entity.item)||item.target_opac===0)
continue;anims=this.get_anims_for_item_by_name(item,'opacity');for(j=0;j<anims.length;j++)
this.cancel_anim(anims[j]);init_opac=item.opacity||0;item.target_opac=0;if(init_opac!==0){this.push_anim(item,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(init_opac,0,anim_cfg,progress);},scope:this},duration:250*init_opac});anim_added=true;}}
if(this.zoom_slider_is_showing()&&!this.point_is_in_zoom_slider_focus_area(pt,width,height)&&this.zoom_slider_item.opacity!==0.5&&this.zoom_slider_item.opacity_target!==0.5){this.zoom_slider_item.opacity_target=0.5;anim_cfgs=this.get_anims_for_item_by_name(this.zoom_slider_item,'opacity');for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);var init_opac=this.zoom_slider_item.opacity;this.push_anim(this.zoom_slider_item,'opacity',{callback:{fn:function(anim_cfg,progress){this.opacity_from_to(init_opac,0.5,anim_cfg,progress);},scope:this},duration:250*(2*init_opac-1)});anim_added=true;}
var bounds_rect=this.get_bounds_rect(width,height);var view_rect=this.get_view_rect(width,height);if(!skip_cursor_reset&&!this.get_item_containing_point(pt,width,height,view_rect,bounds_rect))
this.shadow_canvas.setStyle('cursor','default');return anim_added;},select_version:function(version_id,skip_clear_selection){if(!this.version_items.hasOwnProperty(version_id))return;var do_select=true;if(!skip_clear_selection)
do_select=!this.deselect_all_items(version_id);if(do_select)
this.select_item(this.version_items[version_id]);},select_item:function(item){item.selected=true;item.rerender=true;var anim_cfgs=this.get_anims_for_item_by_name(item,'opacity');var i;for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);item.opacity=1;this.selected_items[item.record.get_id()]=item;},deselect_item:function(item){item.selected=false;item.rerender=true;var anim_cfgs=this.get_anims_for_item_by_name(item,'opacity');var i;for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);item.opacity=this.get_item_opacity_for_mode(item,this.render_mode);delete this.selected_items[item.record.get_id()];},deselect_all_items:function(keep_version_id){var keep_version_id_found=false;for(version_id in this.selected_items)
if(!keep_version_id||version_id!==keep_version_id)
this.deselect_item(this.selected_items[version_id],true);else
keep_version_id_found=true;return!keep_version_id||keep_version_id_found;},move_selected_items_to_timeline:function(){if(this.render_mode==='gallery')return;var entity_map={};var i,id,record,key;for(i=0;i<this.selected_ids.length;i++){id=this.selected_ids[i];if(!this.version_items.hasOwnProperty(id))return;record=this.version_items[id].record;if(!record)continue;key=record.get('entity').type+'_'+record.get('entity').id;if(!entity_map.hasOwnProperty(key)||entity_map[key].id<id)
entity_map[key]={id:id,entity:record.get('entity')};}
var active_versions=sg_deep_copy(this.active_versions);var version_id,entity;var entities=[];var version_ids=[];for(key in entity_map){version_id=entity_map[key].id;entity=entity_map[key].entity;active_versions[key]=version_id;entities.push(entity);version_ids.push(version_id);}
if(SG.globals.review_app_player&&SG.globals.review_app_player.supports_version_swap_for_entities())
SG.globals.review_app_player.swap_versions_for_entities(version_ids,entities);this.set_active_versions(active_versions);},items_are_flagged:function(version_ids){var i,record;for(i=0;i<version_ids.length;i++){if(!this.version_items.hasOwnProperty(version_ids[i]))continue;record=this.version_items[version_ids[i]].record;if(!record)continue;if(!record.get('flagged'))
return false;}
return true;},flag_items_by_id:function(version_ids,unflag){var records=[];var i,record,vdiv;for(i=0;i<version_ids.length;i++){if(!this.version_items.hasOwnProperty(version_ids[i]))continue;record=this.version_items[version_ids[i]].record;if(!record)continue;this.update_flagged_state(version_ids[i],!unflag);records.push(record);}
SG.ReviewApp.Utils.flag_version_records(records,unflag);},update_flagged_state:function(id,flagged){if(!this.version_items.hasOwnProperty(id))
return;var item=this.version_items[id];item.flagged=flagged;var anim_cfgs=this.get_anims_for_item_by_name(item,'flagged');var i;for(i=0;i<anim_cfgs.length;i++)
this.cancel_anim(anim_cfgs[i]);var start_opac=item.flag_opacity||(item.record.get('flagged')?1:0);var target_opac=flagged?1:0;if(start_opac!==target_opac){this.push_anim(item,'flagged',{callback:{fn:function(anim_cfg,progress){this.flag_opacity_from_to(start_opac,target_opac,anim_cfg,progress);},scope:this}});this.render();}},update_viewed_versions:function(playing_version_id,progress,viewed_version_ids){var rerender=false;var version_id;for(version_id in this.viewed_items){if(this.viewed_items.hasOwnProperty(version_id)&&viewed_version_ids.indexOf(Number(version_id))===-1){rerender=true;this.viewed_items[version_id].viewed=false;this.viewed_items[version_id].playing=false;this.viewed_items[version_id].progress=0;this.viewed_items[version_id].rerender=true;delete this.viewed_items[version_id];}}
var i;for(i=0;i<viewed_version_ids.length;i++){version_id=viewed_version_ids[i];item=this.version_items[version_id];if(!this.version_items[version_id])
continue;if(!item.viewed){item.viewed=true;rerender=true;item.rerender=true;}
if(version_id===playing_version_id){if(!item.playing||item.progress!==progress){item.playing=true;item.progress=progress;rerender=true;item.rerender=true;}}else if(item.playing){item.playing=false;item.progress=0;rerender=true;item.rerender=true;}
this.viewed_items[version_id]=item;}
return rerender;},set_active_versions:function(active_versions){this.active_versions=sg_deep_copy(active_versions);var indexes_changed=false;if(active_versions){var me=this;var make_fade_callback=function(current_opac,target_opac){return{fn:function(anim_cfg,progress){this.opacity_from_to(current_opac,target_opac,anim_cfg,progress);},scope:me};};var key,version_item,version_id,item;for(key in active_versions){version_item=this.version_items[active_versions[key]];if(!version_item||version_item.state==='removed'||version_item.row_idx===0)
continue;for(version_id in this.version_items){if(Number(version_id)===active_versions[key])
continue;item=this.version_items[version_id];if(item.column_idx===version_item.column_idx){item.row_idx-=version_item.row_idx;indexes_changed=true;var target_opac=this.get_item_opacity_for_mode(item,this.render_mode);if(item.opacity!==target_opac)
this.push_anim(item,'opacity',{callback:make_fade_callback(item.opacity,target_opac)});}}
version_item.row_idx=0;indexes_changed=true;var current_opac=version_item.opacity;if(current_opac!==1)
this.push_anim(version_item,'opacity',{callback:make_fade_callback(current_opac,1)});}}
if(!indexes_changed)return;var width=this.canvas_w;var height=this.canvas_h;this.update_item_positions(width,height);},get_active_versions:function(){var active_version_ids=[];var version_id;for(version_id in this.version_items)
if(this.version_items.hasOwnProperty(version_id)&&this.version_items[version_id].row_idx===0)
active_version_ids.push(Number(version_id));return active_version_ids;},get_selected_ids:function(){return this.selected_ids;},sort_ids:function(ids){var items=[];var version_id;var i;for(i=0;i<ids.length;i++)
if(this.version_items.hasOwnProperty(ids[i]))
items.push(this.version_items[ids[i]]);if(this.render_mode==='gallery')
items.sort(function(a,b){return a.global_idx-b.global_idx;});else
items.sort(function(a,b){if(a.column_idx!==b.column_idx)
return a.column_idx-b.column_idx;return a.row_idx-b.row_idx;});var ids=[];for(i=0;i<items.length;i++)
ids.push(items[i].record.get_id());return ids;},sort_selected_item_ids:function(){var ids=[];var version_id;for(version_id in this.selected_items)
if(this.selected_items.hasOwnProperty(version_id))
ids.push(Number(version_id));return this.sort_ids(ids);},property_from_to:function(property_name,from,to,anim_cfg,progress){anim_cfg.item[property_name]=(1.0-this.ease_out(progress))*from+
this.ease_out(progress)*to;},fit_text_to_rect:function(text,ctx,rect,font_size,baseline){ctx.save();var font=(font_size||11*this.pixel_ratio)+'px Helvetica';if(ctx.font!==font)
ctx.font=font;var b_line=baseline||'top';if(ctx.textBaseline!==b_line)
ctx.textBaseline=b_line;var text_width=ctx.measureText(text).width;var text_with_ellipses=text;var text_has_ellipses=false;if(text_width>rect.w){text_has_ellipses=true;var ellipsis_width=ctx.measureText('...').width;var cur_text=ellipsis_width>rect.w?'...':text;var min_char_width=0;var max_char_width=cur_text.length;var start_index,bias;if(cur_text.length%2){start_index=this.floor(cur_text.length/2.0)+1;bias=0;}else{start_index=cur_text.length/2;bias=1;}
if(ellipsis_width<rect.w){var char_width,half_char_width,total_width,front_half,back_half;while(Math.abs(max_char_width-min_char_width)>1){char_width=min_char_width+this.floor((max_char_width-min_char_width)/2);half_char_width=this.floor(char_width/2);bias_half_char_width=char_width-half_char_width
front_half=cur_text.slice(0,start_index-(bias?half_char_width:bias_half_char_width));back_half=cur_text.slice(start_index+(bias?bias_half_char_width:half_char_width));total_width=ctx.measureText(front_half+back_half).width+ellipsis_width;if(total_width>rect.w){min_char_width=char_width;}else if(total_width<rect.w)
max_char_width=char_width;else
break;}
if(total_width>rect.w){char_width=max_char_width;half_char_width=this.floor(char_width/2);bias_half_char_width=char_width-half_char_width;front_half=cur_text.slice(0,start_index-(bias?half_char_width:bias_half_char_width));back_half=cur_text.slice(start_index+(bias?bias_half_char_width:half_char_width));total_width=ctx.measureText(front_half+back_half).width+ellipsis_width;}
text_with_ellipses=front_half+'...'+back_half;text_width=total_width;}else{text_with_ellipses='';text_width=0;}}
ctx.restore();return{text:text_with_ellipses,width:text_width,truncated:text_has_ellipses};},opacity_from_to:function(from,to,anim_cfg,progress){this.property_from_to('opacity',from,to,anim_cfg,progress);},fade_item_from_to:function(from,to,anim_cfg,progress){this.property_from_to('visibility',from,to,anim_cfg,progress);},flag_opacity_from_to:function(from,to,anim_cfg,progress){this.property_from_to('flag_opacity',from,to,anim_cfg,progress);},fade_item_in:function(anim_cfg,progress){anim_cfg.item.scale=this.ease_out(progress);this.fade_item_from_to(0,1,anim_cfg,progress);},fade_item_out:function(anim_cfg,progress){anim_cfg.item.scale=1-this.ease_in(progress);this.fade_item_from_to(1,0,anim_cfg,progress);},fade_image_in:function(anim_cfg,progress){anim_cfg.item.image_opacity=progress>1?1.0:(progress>0?this.ease_in(progress):0);},move_bb:function(bb1,bb2,anim_cfg,progress){var prog=this.ease_in_out(progress);anim_cfg.item.bb.x=this.floor((1.0-prog)*bb1.x+prog*bb2.x);anim_cfg.item.bb.y=this.floor((1.0-prog)*bb1.y+prog*bb2.y);},move_item:function(orig_bb,target_bb,anim_cfg,progress){this.rtree.remove(anim_cfg.item.bb,anim_cfg.item);this.move_bb(orig_bb,target_bb,anim_cfg,progress);this.rtree.insert(anim_cfg.item.bb,anim_cfg.item);},ease_in:function(progress){return progress*progress*progress;},ease_out:function(progress){var p=progress-1;return(p*p*p+1);},ease_in_out:function(progress){return progress*progress*(3-2*progress);},floor:function(val){return~~val;},min:function(a,b){if(a<b)
return a;else
return b;},max:function(a,b){if(a>b)
return a;else
return b;},distance:function(pt1,pt2){var min,max;var dx=pt2.x-pt1.x;var dy=pt2.y-pt1.y;if(dx<0)dx=-dx;if(dy<0)dy=-dy;if(dx<dy){min=dx;max=dy;}else{min=dy;max=dx;}
var approx=(max*1007)+(min*441);if(max<(min<<4))
approx-=(max*40);return((approx+512)>>10);},resize_canvas_to_fit_container:function(){var width=this.container.getWidth()*this.pixel_ratio;var height=this.container.getHeight()*this.pixel_ratio;var view_rect=this.get_view_rect(width,height);if(this.render_mode==='gallery'){this.render();this.reflow_gallery(width,height);return;}
this.active_band_item.bb=this.get_active_band_geometry(width,height,view_rect);this.update_item_positions(width,height,true);return;},get_state:function(clone){var state={node:this.node,render_mode:this.render_mode,history_limit:this.history_limit,sorts:clone?sg_deep_copy(this.sorts):this.sorts,filters:clone?sg_deep_copy(this.filters):this.filters,entity_order:this.entity_order,active_versions:clone?sg_deep_copy(this.active_versions):this.active_versions,extra_filters:clone?sg_deep_copy(this.extra_filters):this.extra_filters,version_page_default_sorts:clone?sg_deep_copy(this.version_page_default_sorts):this.version_page_default_sorts,project_id:this.project_id,asset_type:this.asset_type,asset_id:this.asset_id,sequence_id:this.sequence_id,shot_id:this.shot_id,playlist_id:this.playlist_id,version_page_id:this.version_page_id,section:this.section,dismissed_message_bar:this.dismissed_message_bar,entity_page_size:this.entity_page_size,current_num_entities:this.current_num_entities,max_num_entities:this.max_num_entities,total_num_entities:this.total_num_entities,version_page_size:this.version_page_size,current_num_versions:this.current_num_versions,max_num_versions:this.max_num_versions,total_num_versions:this.total_num_versions};return state;},set_state:function(state){this.render_mode=state.render_mode;this.history_limit=state.history_limit;this.sorts=state.sorts;this.filters=sg_deep_copy(state.filters);this.entity_order=state.entity_order;this.active_versions=state.active_versions;this.extra_filters=state.extra_filters;this.version_page_default_sorts=state.version_page_default_sorts;this.project_id=state.project_id;this.asset_type=state.asset_type;this.asset_id=state.asset_id;this.sequence_id=state.sequence_id;this.shot_id=state.shot_id;this.playlist_id=state.playlist_id;this.version_page_id=state.version_page_id;this.section=state.section;this.dismissed_message_bar=state.dismissed_message_bar;this.entity_page_size=state.entity_page_size;this.current_num_entities=state.current_num_entities;this.max_num_entities=state.max_num_entities;this.total_num_entities=state.total_num_entities;this.version_page_size=state.version_page_size;this.current_num_versions=state.current_num_versions;this.max_num_versions=state.max_num_versions;this.total_num_versions=state.total_num_versions;},clone_state:function(){return this.get_state(true);},get_after_fetch_callback:function(previous_state,append,sender,after_load_callback){return{fn:function(){var node=this.generate_nav_node();if(!this.node||this.node.get_path()!==node.get_path()){this.node=node;if(this.node_changed_callback)
this.node_changed_callback.fn.call(this.node_changed_callback.scope,node,sender);}
var sorts_changed=false;if(JSON.stringify(this.sorts)!==JSON.stringify(previous_state.sorts)){sorts_changed=true;if(this.sorts_changed_callback)
this.sorts_changed_callback.fn.call(this.sorts_changed_callback.scope,this.sorts);}
if(this.render_mode!==previous_state.render_mode&&this.render_mode_changed_callback)
this.render_mode_changed_callback.fn.call(this.render_mode_changed_callback.scope,this.render_mode);if(this.history_limit!==previous_state.history_limit&&this.history_limit_changed_callback)
this.history_limit_changed_callback.fn.call(this.history_limit_changed_callback.scope,this.history_limit);if(this.version_page_size!==previous_state.version_page_size&&this.version_page_size_changed_callback)
this.version_page_size_changed_callback.fn.call(this.version_page_size_changed_callback.scope,this.version_page_size);if(this.entity_page_size!==previous_state.entity_page_size&&this.entity_page_size_changed_callback)
this.entity_page_size_changed_callback.fn.call(this.entity_page_size_changed_callback.scope,this.entity_page_size);var mode=this.get_mode();this.last_updated=new Date();if(mode){this.update_timeline(previous_state,append);}else{this.clear();this.set_loading(false);}
if(sorts_changed)
this.selected_ids=this.sort_selected_item_ids();if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};},clear:function(){this.version_items={};this.rtree=new SG.ReviewAppRTree();this.selected_items={};this.selected_ids=[];this.hovered_items={};this.viewed_items={};this.last_selected_item=null;this.num_columns=0;this.num_rows=0;if(this.active_band_item.visibility!==0){var init_opac=this.active_band_item.visibility;this.push_anim(this.active_band_item,'visibility',{callback:{fn:function(anim_cfg,progress){this.fade_item_from_to(init_opac,0,anim_cfg,progress);},scope:this},delay:250});}
this.render();},set_loading:function(state){if(this.loading!==state&&this.loading_changed_callback)
this.loading_changed_callback.fn.call(this.loading_changed_callback.scope,state);this.loading=state;},is_loading:function(){return this.loading;},cancel_loading:function(){this.set_loading(false);},reload:function(){this.set_loading(true);var state=this.clone_state();var callback=this.get_after_fetch_callback(state);this.fetch_versions_for_current_mode(state,callback);},updates_are_disabled:function(){return this.updates_disabled;},generate_nav_node:function(on_complete){if(!this.project_id){if(this.version_page_id)
return new SG.ReviewAppVersionPageNode({id:this.version_page_id.toString(),version_page_id:this.version_page_id});else
return new SG.ReviewAppProjectsNode({id:'projects'});}
var parent_node;if(this.asset_id)
return new SG.ReviewAppAssetNode({id:this.asset_id.toString(),asset_id:this.asset_id,asset_type:this.asset_type,project_id:this.project_id});if(this.asset_type)
return new SG.ReviewAppAssetTypeNode({id:this.asset_type,asset_type:this.asset_type,project_id:this.project_id});if(this.shot_id)
return new SG.ReviewAppShotNode({id:this.shot_id.toString(),shot_id:this.shot_id,sequence_id:this.sequence_id,project_id:this.project_id});if(this.sequence_id)
return new SG.ReviewAppSequenceNode({id:this.sequence_id.toString(),sequence_id:this.sequence_id,project_id:this.project_id});if(this.playlist_id)
return new SG.ReviewAppPlaylistNode({id:this.playlist_id.toString(),playlist_id:this.playlist_id,project_id:this.project_id});if(this.version_page_id)
return new SG.ReviewAppVersionPageNode({id:this.version_page_id.toString(),version_page_id:this.version_page_id,project_id:this.project_id});if(this.section==='assets')
return new SG.ReviewAppAssetTypesNode({project_id:this.project_id});if(this.section==='sequences')
return new SG.ReviewAppSequencesNode({project_id:this.project_id});return new SG.ReviewAppProjectNode({id:this.project_id.toString(),project_id:this.project_id});},get_node:function(){return this.node;},set_node:function(node,sender,after_load_callback){var entity;if('asset_id'in node){entity={type:'Asset',id:node.asset_id};}else if('shot_id'in node){entity={type:'Shot',id:node.shot_id};}else if('sequence_id'in node&&node.sequence_id>0){entity={type:'Sequence',id:node.sequence_id};}else if('playlist_id'in node){entity={type:'Playlist',id:node.playlist_id};}else if('version_page_id'in node){entity={type:'Page',id:node.version_page_id};}else if(node instanceof SG.ReviewAppProjectNode){entity={type:'Project',id:node.project_id};}else{var previous_state=this.clone_state();var callback=this.get_after_fetch_callback(previous_state,false,sender,after_load_callback);if('asset_type'in node){this.set_asset_type(node.asset_type,node.project_id,callback);}else if('sequence_id'in node&&node.sequence_id===-1){this.set_sequence_id(-1,node.project_id,callback);}else if(node instanceof SG.ReviewAppSequencesNode){this.set_all_shots(node.project_id,callback);}else if(node instanceof SG.ReviewAppAssetTypesNode){this.set_all_assets(node.project_id,callback);}else if(node instanceof SG.ReviewAppProjectsNode){this.set_all_projects(callback);}else{set_node=false;this.node=null;this.clear_ids(true);this.loading=true;callback.fn.call(callback.scope);return false;}
return true;}
this.set_entity(entity,sender,after_load_callback);return true;},set_entity:function(record,sender,after_load_callback){var previous_state=this.clone_state();var callback=this.get_after_fetch_callback(previous_state,false,sender,after_load_callback);switch(record.type){case'Shot':this.set_shot_id(record.id,callback);return true;case'Asset':this.set_asset_id(record.id,callback);return true;case'Sequence':this.set_sequence_id(record.id,null,callback);return true;case'Playlist':this.set_playlist_id(record.id,callback);return true;case'Page':this.set_version_page_id(record.id,callback);return true;case'Project':this.set_project_id(record.id,callback);default:return false;}},get_mode:function(){return this.get_mode_for_state(this);},get_mode_for_state:function(state){if(state.playlist_id)
return'playlist';if(state.version_page_id)
return'version_page';if(state.asset_id)
return'asset';if(state.asset_type)
return'asset_type';if(state.shot_id)
return'shot';if(state.sequence_id)
return'sequence';if(state.section==='sequences')
return'all_shots';if(state.section==='assets')
return'all_assets';if(state.project_id)
return'project';return'all_projects';},get_entity_type_name_for_current_mode:function(){var entity_type;if(this.is_rendering_versions())
entity_type='Version';else if(['all_shots','sequence','shot'].indexOf(this.get_mode())>-1)
entity_type='Shot';else if(['all_assets','asset_type','asset'].indexOf(this.get_mode())>-1)
entity_type='Asset';else
entity_type='Entity';return entity_type;},clear_ids_for_state:function(state){state.project_id=null;state.asset_type=null;state.asset_id=null;state.sequence_id=null;state.shot_id=null;state.playlist_id=null;state.version_page_id=null;state.section=null;state.entity_order=[];state.active_versions=null;state.extra_filters={logical_operator:'and',conditions:[]};state.dismissed_message_bar=false;state.current_num_entities=0;state.max_num_entities=this.entity_page_size;state.total_num_entities=0;state.current_num_versions=0;state.max_num_versions=this.version_page_size;state.total_num_versions=0;},clear_ids:function(){this.clear_ids_for_state(this);},set_version:function(version_id,entity,after_load_callback){if(entity){this.on_this_entity_load(version_id,entity,after_load_callback);}
var data_set=this.new_data_set('Version',function(){if(data_set.count()<1)
return;var entity=data_set.get_record(0).get('entity');if(!entity)
return;this.on_this_entity_load(version_id,entity,after_load_callback);},this);var ver_spec={type:'Version',ids:[version_id],columns:['entity'],result:data_set};SG.Repo.find(ver_spec);},set_all_projects:function(after_load_callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';this.fetch_all_projects(target_state,after_load_callback);},set_project_id:function(project_id,after_load_callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.project_id=project_id;this.fetch_project(project_id,target_state,after_load_callback);},set_all_assets:function(project_id,after_load_callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.section='assets';target_state.project_id=project_id;this.fetch_all_assets(project_id,target_state,after_load_callback);},set_asset_id:function(asset_id,after_load_callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.asset_id=asset_id;this.fetch_asset(asset_id,target_state,after_load_callback);},set_asset_type:function(asset_type,project_id,callback,target_state){if(this.is_loading())return;this.set_loading(true);if(!target_state)
target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.asset_type=asset_type;target_state.project_id=project_id;this.fetch_assets_with_asset_type(asset_type,project_id,target_state,callback);},set_all_shots:function(project_id,after_load_callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.section='sequences';target_state.project_id=project_id;this.fetch_all_shots(project_id,target_state,after_load_callback);},set_sequence_id:function(sequence_id,project_id,after_load_callback,target_state){if(this.is_loading())return;this.set_loading(true);if(!target_state)
target_state=this.clone_state();var initial_render_mode=target_state.render_mode;this.clear_ids_for_state(target_state);target_state.render_mode=initial_render_mode;target_state.sequence_id=sequence_id;target_state.project_id=project_id;this.fetch_seq_shots(sequence_id,target_state,after_load_callback);},set_shot_id:function(shot_id,callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.shot_id=shot_id;this.fetch_shot(shot_id,target_state,callback);},set_playlist_id:function(playlist_id,callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.playlist_id=playlist_id;this.fetch_playlist_versions(playlist_id,target_state,callback);},set_version_page_id:function(version_page_id,callback){if(this.is_loading())return;this.set_loading(true);var target_state=this.clone_state();this.clear_ids_for_state(target_state);if(target_state.render_mode==='cut')
target_state.render_mode='timeline';target_state.version_page_id=version_page_id;this.fetch_version_page(version_page_id,target_state,callback);},fetch_this_link:function(version_id,entity,data_set,summary_set,columns){SG.Repo.start_batch();var shot_spec={type:entity.type,ids:[entity.id],columns:columns,result:data_set};SG.Repo.find(shot_spec);if(!this.no_history_stack||this.history_limit<0){var ver_spec={type:'Version',columns:['id'],filters:{logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:entity.type,id:entity.id}]},{path:'id',relation:'greater_than',values:[version_id-1]}]},summaries:[{column:'id',type:'count'}],result:summary_set,result_key:'version_count'};SG.Repo.summarize(ver_spec);}
SG.Repo.end_batch();},fetch_all_projects:function(target_state,after_load_callback){var asset_set=this.new_data_set('Asset');var shot_set=this.new_data_set('Shot');var filters={logical_operator:'and',conditions:[{path:'project',relation:'is_not',values:[null]},{logical_operator:'or',conditions:[{path:'entity',relation:'type_is',values:['Asset']},{path:'entity',relation:'type_is',values:['Shot']}]}]};target_state.filters=filters;var callback=function(){if(!asset_set.is_loaded()||!shot_set.is_loaded())return;this.on_project_load(asset_set,shot_set,target_state,after_load_callback);};asset_set.on('load',callback,this);shot_set.on('load',callback,this);SG.Repo.start_batch();var project_filter={logical_operator:'and',conditions:[{path:'project',relation:'is_not',values:[null]}]};var asset_spec={type:'Asset',columns:['code'],filters:project_filter,result:asset_set};SG.Repo.query(asset_spec);var shot_spec={type:'Shot',columns:['code'],filters:project_filter,result:shot_set};SG.Repo.query(shot_spec);SG.Repo.end_batch();},fetch_project:function(project_id,target_state,after_load_callback){var asset_set=this.new_data_set('Asset');var shot_set=this.new_data_set('Shot');var filters=filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]},{logical_operator:'or',conditions:[{path:'entity',relation:'type_is',values:['Asset']},{path:'entity',relation:'type_is',values:['Shot']}]}]};target_state.filters=filters;var callback=function(){if(!asset_set.is_loaded()||!shot_set.is_loaded())return;this.on_project_load(asset_set,shot_set,target_state,after_load_callback);};asset_set.on('load',callback,this);shot_set.on('load',callback,this);SG.Repo.start_batch();var project_filter={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]}]};var asset_spec={type:'Asset',columns:['code'],filters:project_filter,result:asset_set};SG.Repo.query(asset_spec);var shot_spec={type:'Shot',columns:['code'],filters:project_filter,result:shot_set};SG.Repo.query(shot_spec);SG.Repo.end_batch();},fetch_all_assets:function(project_id,target_state,after_load_callback){var asset_set=this.new_data_set('Asset');var filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]},{path:'entity',relation:'type_is',values:['Asset']}]};target_state.filters=filters;asset_set.on('load',function(){this.on_all_assets_load(asset_set,target_state,after_load_callback);},this);var asset_spec={type:'Asset',columns:['code'],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]}]},result:asset_set};SG.Repo.query(asset_spec);},fetch_assets_with_asset_type:function(asset_type,project_id,target_state,after_load_callback){var asset_type_set=this.new_data_set('Asset');asset_type_set.on('load',function(){this.on_asset_type_load(asset_type_set,target_state,after_load_callback);},this);var filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]},{path:'entity.Asset.sg_asset_type',relation:'is',values:[asset_type!=='-1'?asset_type:null]}]};target_state.filters=filters;var asset_type_spec={type:'Asset',columns:['code','image'],filters:{logical_operator:'and',conditions:[{path:'sg_asset_type',relation:'is',values:[asset_type!=='-1'?asset_type:null]},{path:'project',relation:'is',values:[{type:'Project',id:project_id}]}]},result:asset_type_set};SG.Repo.query(asset_type_spec);},fetch_asset:function(asset_id,target_state,after_load_callback){var asset_set=this.new_data_set('Asset');var filters={logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:'Asset',id:asset_id}]}]};target_state.filters=filters;asset_set.on('load',function(){this.on_asset_load(asset_set,target_state,after_load_callback);},this);var asset_spec={type:'Asset',ids:[asset_id],columns:['code','sg_asset_type','image'],result:asset_set};SG.Repo.find(asset_spec);},fetch_all_shots:function(project_id,target_state,after_load_callback){var shot_set=this.new_data_set('Shot');var filters={logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]},{path:'entity',relation:'type_is',values:['Shot']}]};target_state.filters=filters;shot_set.on('load',function(){this.on_all_shots_load(shot_set,target_state,after_load_callback);},this);var shot_spec={type:'Shot',columns:['code'],filters:{logical_operator:'and',conditions:[{path:'project',relation:'is',values:[{type:'Project',id:project_id}]}]},result:shot_set};SG.Repo.query(shot_spec);},fetch_seq_shots:function(sequence_id,target_state,after_load_callback){var seq_set;if(sequence_id>0)
seq_set=this.new_data_set('Sequence');var seq_shots_set=this.new_data_set('Shot');var callback=function(){this.on_seq_shots_load(seq_set,seq_shots_set,target_state,after_load_callback);};var seq=null;if(sequence_id>0){seq={type:'Sequence',id:sequence_id};seq_set.on('load',callback,this);}
seq_shots_set.on('load',callback,this);SG.Repo.start_batch();var filters={logical_operator:'and',conditions:[{path:'entity.Shot.sg_sequence',relation:'is',values:[seq]}]};var shot_filters={logical_operator:'and',conditions:[{path:'sg_sequence',relation:'is',values:[seq]}]};if(sequence_id>0){var seq_spec={type:'Sequence',ids:[sequence_id],columns:[],result:seq_set};SG.Repo.find(seq_spec);}else{filters.conditions.push({path:'entity.Shot.project',relation:'is',values:[{type:'Project',id:target_state.project_id}]});shot_filters.conditions.push({path:'project',relation:'is',values:[{type:'Project',id:target_state.project_id}]});}
target_state.filters=filters;var shot_spec={type:'Shot',columns:['sg_cut_order','image'],filters:shot_filters,sorts:[{column:'sg_cut_order',direction:'asc'},{column:'code',direction:'asc'}],result:seq_shots_set};SG.Repo.query(shot_spec);SG.Repo.end_batch();},fetch_shot:function(shot_id,target_state,after_load_callback){var shot_set=this.new_data_set('Shot');var filters={logical_operator:'and',conditions:[{path:'entity',relation:'is',values:[{type:'Shot',id:shot_id}]}]};target_state.filters=filters;shot_set.on('load',function(){this.on_shot_load(shot_set,target_state,after_load_callback);},this);var shot_spec={type:'Shot',ids:[shot_id],columns:['code','sg_sequence','image'],result:shot_set};SG.Repo.find(shot_spec);},fetch_playlist_versions:function(playlist_id,target_state,after_load_callback){var playlist_set=this.new_data_set('Playlist');var playlist_versions_set=this.new_data_set('Version');var filters={logical_operator:'and',conditions:[{path:'playlists',relation:'is',values:[{type:'Playlist',id:playlist_id}]}]};target_state.filters=filters;var callback=function(){this.on_playlist_versions_load(playlist_set,playlist_versions_set,target_state,after_load_callback);};playlist_set.on('load',callback,this);playlist_versions_set.on('load',callback,this);var filters_copy=sg_deep_copy(filters);this.extend_filters(filters_copy,target_state.extra_filters);SG.Repo.start_batch();var playlist_spec={type:'Playlist',ids:[playlist_id],columns:[],result:playlist_set};SG.Repo.find(playlist_spec);var sorts=this.get_sorts_for_mode_from_state(target_state);var columns=['entity','image','sg_task.Task.step','user','description','flagged'];if(SG.globals.review_app_player)
columns=columns.concat(SG.globals.review_app_player.get_required_version_columns());var ver_spec={type:'Version',columns:columns,filters:filters_copy,sorts:sorts,parent_entity:{type:'Playlist',id:playlist_id},result:playlist_versions_set};if(target_state.version_page_size>0){var page_idx,num_per_page;if(target_state.append_versions){num_per_page=target_state.version_page_size;target_state.max_num_versions+=num_per_page;page_idx=this.floor(target_state.max_num_versions/num_per_page);}else{num_per_page=target_state.max_num_versions;page_idx=1;}
ver_spec.records_per_page=num_per_page;ver_spec.current_page=page_idx;}
SG.Repo.query(ver_spec);SG.Repo.end_batch();},fetch_version_page:function(version_page_id,target_state,after_load_callback){var node_changed=this.get_mode()!=='version_page'||this.version_page_id!==version_page_id;var options={url:'/page/page_settings',params:{page_id:version_page_id},callback:function(options,success,response){if(success){var fetch_page_versions=false;var filters;try{var settings=JSON.parse(response.responseText).settings;filters=settings.settings.filters;this.get_parent_widget().substitute_filter_tokens(filters);target_state.filters=filters;if(node_changed){try{var panel_settings=settings.settings.filter_panel_main_entity_type_settings||{};var conditions=[];var panel_filters=panel_settings.panel_filters||{logical_operator:'and',conditions:[]};if(panel_settings.text_filters||panel_settings.saved_filters||panel_settings.one_click_filters){var conditions=[panel_filters];if(panel_settings.text_filters)
conditions.push(panel_settings.text_filters);if(panel_settings.saved_filters)
conditions.push(panel_settings.saved_filters);if(panel_settings.one_click_filters)
conditions.push(panel_settings.one_click_filters);target_state.extra_filters={logical_operator:'and',conditions:conditions};}else{target_state.extra_filters=panel_filters;}
SG.NotificationCenter.post({uuid:'_review_app_canvas_timeline_',name:'filter_settings_changed',args:panel_settings});}catch(e1){}}
fetch_page_versions=true;}catch(e2){target_state.filters=null;}
var default_sorts;try{default_sorts=settings.children.list_content.settings.sorts;}catch(e3){default_sorts=null;}
target_state.version_page_default_sorts=default_sorts;if(fetch_page_versions){var page_set=this.new_data_set('Page');var callback=function(){var page_record=page_set.count()?page_set.get_record(0):null;var proj=page_record?page_record.get('project'):null;var project_id=proj?proj.id:null;target_state.project_id=project_id;this.fetch_page_versions(target_state,after_load_callback);}
page_set.on('load',callback,this);var page_spec={type:'Page',ids:[version_page_id],columns:[],result:page_set};SG.Repo.find(page_spec);return;}}
this.on_version_details_load(after_load_callback);return;},scope:this};var conn=new Ext.data.Connection();conn.request(options);},fetch_page_versions:function(target_state,after_load_callback){var filters_copy=sg_deep_copy(target_state.filters);var current_sorts=this.get_sorts_for_mode_from_state(target_state);var page_versions_set=this.new_data_set('Version');page_versions_set.on('load',function(){this.on_page_versions_load(page_versions_set,target_state,after_load_callback);},this);this.extend_filters(filters_copy,target_state.extra_filters);var columns=['entity','image','sg_task.Task.step','user','description','flagged'];if(SG.globals.review_app_player)
columns=columns.concat(SG.globals.review_app_player.get_required_version_columns());var ver_spec={type:'Version',columns:columns,filters:filters_copy,sorts:current_sorts,result:page_versions_set};if(target_state.version_page_size>0){var page_idx,num_per_page;if(target_state.append_versions){num_per_page=target_state.version_page_size;target_state.max_num_versions+=num_per_page;page_idx=this.floor(target_state.max_num_versions/num_per_page);}else{num_per_page=target_state.max_num_versions;page_idx=1;}
ver_spec.records_per_page=num_per_page;ver_spec.current_page=page_idx;}
SG.Repo.query(ver_spec);},fetch_versions:function(entities,target_state,after_load_callback){var callback,columns;if(target_state.render_mode!=='gallery'){var i,key;if(!target_state.active_versions&&target_state.target_version_id&&target_state.target_entity){target_state.active_versions={};key=target_state.target_entity.type+'_'+target_state.target_entity.id;target_state.active_versions[key]=target_state.target_version_id;}}else{target_state.active_versions=null;}
var columns=['entity','image','sg_task.Task.step','user','description','flagged'];if(SG.globals.review_app_player)
columns=columns.concat(SG.globals.review_app_player.get_required_version_columns());var callback;switch(target_state.render_mode){case'gallery':callback={fn:function(data_set){this.on_gallery_history_load(data_set,target_state,after_load_callback);},scope:this};this.fetch_version_history(entities,columns,target_state,callback);break;case'cut':target_state.total_num_entities=entities.length;var start_index=0;var end_index=entities.length;if(target_state.entity_page_size>0){var page_idx,num_per_page;if(target_state.append_entities){target_state.max_num_entities+=target_state.entity_page_size;start_index=target_state.current_num_entities;}else{start_index=0;}
end_index=this.min(entities.length,target_state.max_num_entities);}
var loaded_entities=entities.slice(start_index,end_index);callback={fn:function(data_set){this.on_cut_history_load(loaded_entities,data_set,target_state,after_load_callback);},scope:this};this.fetch_version_history(loaded_entities,columns,target_state,callback);break;case'timeline':this.fetch_latest_versions(target_state,after_load_callback);break;default:break;}},fetch_active_versions:function(entities,latest_versions,target_state,after_load_callback){var skip_active_versions=!target_state.active_versions||target_state.append_versions||target_state.append_entities;var active_entities=[];var active_version_sets=[];var callback=function(){this.on_active_versions_load(latest_versions,active_entities,active_version_sets,target_state,after_load_callback);};var i,key;if(!skip_active_versions){for(i=0;i<entities.length;i++){key=entities[i].type+'_'+entities[i].id;if(target_state.active_versions.hasOwnProperty(key)){if(latest_versions.hasOwnProperty(key)&&target_state.active_versions[key]===latest_versions[key])
continue;active_entities.push(entities[i]);active_version_sets.push(this.new_data_set('Version',callback));}}}
if(!target_state.active_versions)
target_state.active_versions={};if(skip_active_versions||active_entities.length===0){target_state.active_versions=sg_deep_copy(latest_versions);this.fetch_sorted_active_versions(target_state,after_load_callback);return;}
var filters=sg_deep_copy(target_state.extra_filters);SG.Repo.start_batch();var entity,version_id,data_set,spec;for(i=0;i<active_entities.length;i++){entity=active_entities[i];data_set=active_version_sets[i];version_id=target_state.active_versions[entity.type+'_'+entity.id];spec={type:'Version',columns:['id','entity'],filters:{logical_operator:'and',conditions:[{path:'entity.'+entity.type+'.id',relation:'is',values:[entity.id]},{path:'id',relation:'greater_than',values:[version_id-1]},]},sorts:[{column:'id',direction:'desc'}],result:data_set}
if(target_state.history_limit>-1){spec.records_per_page=this.no_history_stack?1:target_state.history_limit;spec.current_page=1;}
if(filters)
spec.filters.conditions.push(filters);SG.Repo.query(spec);}
SG.Repo.end_batch();},fetch_latest_versions:function(target_state,after_load_callback){var data_set=this.new_data_set('Version');data_set.on('load',function(){this.on_latest_versions_load(data_set,target_state,after_load_callback);},this);var spec={type:'Version',columns:['id','entity'],filters:target_state.filters,grouping:[{column:'entity'}],summaries:[{column:'id',type:'maximum'}],result:data_set,result_key:'group_summaries'};if(target_state.extra_filters)
spec.filters.conditions.push(target_state.extra_filters);SG.Repo.summarize(spec);},fetch_version_history:function(entities,columns,target_state,after_load_callback){if(!entities.length){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);return;}
var data_set=this.new_data_set('Version',function(){if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope,data_set);});var entity_ids={};var version_limit=this.no_history_stack?1:target_state.history_limit;var entity_type,entity_id,version_id,key,value;for(i=0;i<entities.length;i++){if(!entities[i])continue;entity_type=entities[i].type;entity_id=entities[i].id;key=entities[i].type+'_'+entities[i].id;version_id=null;if(this.no_history_stack&&target_state.active_versions[key]){entity_type='Version';entity_id=target_state.active_versions[key];}
if(entity_ids.hasOwnProperty(entity_type))
entity_ids[entity_type].push(entity_id);else
entity_ids[entity_type]=[entity_id];}
var grouping,sorts,records_per_page,current_page;if(this.is_rendering_versions_for_state(target_state)){sorts=this.get_sorts_for_mode_from_state(target_state);if(target_state.version_page_size>0){var page_idx,num_per_page;if(target_state.append_versions){records_per_page=target_state.version_page_size;target_state.max_num_versions+=records_per_page;current_page=this.floor(target_state.max_num_versions/records_per_page);}else{records_per_page=target_state.max_num_versions;current_page=1;}}}else{grouping=[{column:'entity'}];sorts=[{column:'id',direction:'desc'}];}
var spec;if(version_limit>-1){spec={type:'Version',columns:columns,server_side_filters:'revolver_latest_versions',server_side_filters_params:{entity_ids:entity_ids,version_limit:version_limit,filters:sg_deep_copy(target_state.extra_filters)},grouping:grouping,sorts:sorts,records_per_page:records_per_page,current_page:current_page,result:data_set}
SG.Repo.query(spec);return;}
var entity_filters={logical_operator:'or',conditions:[]};var etype;for(etype in entity_ids){if(entity_ids.hasOwnProperty(etype)){entity_filters.conditions.push({path:'entity.'+etype+'.id',relation:'in',values:entity_ids[etype]});}}
var filters={logical_operator:'and',conditions:[entity_filters,sg_deep_copy(target_state.extra_filters)]};spec={type:'Version',columns:columns,filters:filters,sorts:sorts,grouping:grouping,records_per_page:records_per_page,current_page:current_page,result:data_set};SG.Repo.query(spec);},fetch_versions_for_current_mode:function(target_state,callback){switch(this.get_mode()){case'sequence':this.fetch_seq_shots(this.sequence_id,target_state,callback);break;case'shot':this.fetch_shot(this.shot_id,target_state,callback);break;case'asset_type':this.fetch_assets_with_asset_type(this.asset_type,this.project_id,target_state,callback);break;case'asset':this.fetch_asset(this.asset_id,target_state,callback);break;case'playlist':this.fetch_playlist_versions(this.playlist_id,target_state,callback);break;case'version_page':this.fetch_version_page(this.version_page_id,target_state,callback);break;case'all_shots':this.fetch_all_shots(this.project_id,target_state,callback);break;case'all_assets':this.fetch_all_assets(this.project_id,target_state,callback);break;case'project':this.fetch_project(this.project_id,target_state,callback);break;case'all_projects':this.fetch_all_projects(target_state,callback);break;default:break;}},fetch_updates:function(){var now=new Date();if(this.updates_disabled||!this.last_updated||now-this.last_updated<30*1000)
return;this.last_updated=now;if(this.updating_state_changed_callback)
this.updating_state_changed_callback.fn.call(this.updating_state_changed_callback.scope,true);var version_ids=[];var key;for(key in this.version_items)
if(this.version_items.hasOwnProperty(key))
version_ids.push(Number(key));if(!version_ids.length)return;var data_set=this.new_data_set('Version');data_set.on('load',function(){this.on_updates_load(data_set);},this);var columns=['image'];if(SG.globals.review_app_player)
columns=columns.concat(SG.globals.review_app_player.get_required_version_columns());var spec={type:'Version',columns:columns,ids:version_ids,result:data_set};SG.Repo.find(spec);},fetch_sorted_active_versions:function(target_state,after_load_callback){var active_versions_set=this.new_data_set('Version');active_versions_set.on('load',function(){this.on_sorted_active_versions_load(active_versions_set,target_state,after_load_callback);},this);var active_ids=[];var key;for(key in target_state.active_versions)
if(target_state.active_versions.hasOwnProperty(key)&&target_state.active_versions[key])
active_ids.push(target_state.active_versions[key]);target_state.total_num_entities=active_ids.length;if(!active_ids.length){this.set_state(target_state);this.on_version_details_load(after_load_callback);return;}
var sorts=this.get_sorts_for_mode_from_state(target_state);var ver_spec={type:'Version',filters:{logical_operator:'and',conditions:[{path:'id',relation:'in',values:active_ids}]},columns:['id','entity'],sorts:sorts,result:active_versions_set};if(target_state.entity_page_size>0){var page_idx,num_per_page;if(target_state.append_entities){num_per_page=target_state.entity_page_size;target_state.max_num_entities+=num_per_page;page_idx=this.floor(target_state.max_num_entities/target_state.entity_page_size);}else{num_per_page=target_state.max_num_entities;page_idx=1;}
ver_spec.records_per_page=num_per_page;ver_spec.current_page=page_idx;}
SG.Repo.query(ver_spec);},fetch_flagged_states:function(ids){var data_set=new SG.Data.Set('Version');var callback=function(){this.on_flagged_states_load(data_set);};data_set.on('load',callback,this);var spec={type:'Version',ids:ids,columns:['flagged'],result:data_set};SG.Repo.find(spec);},get_version_limit_from_summary_set:function(summary_set){if(!summary_set.data.version_count)return null;var num_versions=Number(summary_set.data.version_count.id);if(num_versions>this.history_limit){if(num_versions<=5)
num_versions=5;else if(num_versions<=10)
num_versions=10;else if(num_versions<=15)
num_versions=15;else
num_versions=-1;return num_versions;}
return null;},on_this_entity_load:function(version_id,entity,after_load_callback){var summary_set=new SG.Data.SummarySet('Version');var callback={fn:function(){this.select_version(version_id);this.scroll_to_version(version_id);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},scope:this};var data_set,callback_fn,columns;if(entity.type==='Shot'){data_set=this.new_data_set('Shot');callback_fn=function(){this.on_this_shot_load(version_id,entity,data_set,summary_set,callback);};columns=['sg_sequence'];}else if(entity.type==='Asset'){data_set=this.new_data_set('Asset');callback_fn=function(){this.on_this_asset_load(version_id,entity,data_set,summary_set,callback);};columns=['sg_asset_type'];}
if(data_set&&columns){data_set.on('load',callback_fn,this);summary_set.on('load',callback_fn,this);this.fetch_this_link(version_id,entity,data_set,summary_set,columns);}},on_this_shot_load:function(version_id,entity,data_set,summary_set,after_load_callback){if(!data_set.is_loaded()||(!this.no_history_stack&&this.history_limit>-1&&version_id&&!summary_set.is_loaded()))
return;if(data_set.count()<1){return;}
var shot=data_set.get_record(0);var sequence=shot.get('sg_sequence');var sequence_id=sequence?sequence.id:-1;var project=shot.get('project');var project_id=project&&project.id;var target_state=this.clone_state();target_state.target_version_id=version_id;target_state.target_entity=entity;if(!this.no_history_stack&&this.history_limit>-1){var history_limit=this.get_version_limit_from_summary_set(summary_set);if(history_limit&&history_limit>target_state.history_limit)
target_state.history_limit=history_limit;}
var previous_state=this.clone_state();var callback=this.get_after_fetch_callback(previous_state,false,null,after_load_callback);this.loading=false;this.set_sequence_id(sequence_id,project_id,callback,target_state);},on_this_asset_load:function(version_id,entity,data_set,summary_set,after_load_callback){if(!data_set.is_loaded()||(!this.no_history_stack&&this.history_limit>-1&&version_id&&!summary_set.is_loaded()))
return;if(data_set.count()<1)return;var asset=data_set.get_record(0);var proj=asset.get('project');var project_id=proj?proj.id:null;var asset_type=asset.get('sg_asset_type')||'-1';var target_state=this.clone_state();target_state.target_version_id=version_id;target_state.target_entity=entity;if(!this.no_history_stack&&this.history_limit>-1){var history_limit=this.get_version_limit_from_summary_set(summary_set);if(history_limit&&history_limit>target_state.history_limit)
target_state.history_limit=history_limit;}
var previous_state=this.clone_state();var callback=this.get_after_fetch_callback(previous_state,false,null,after_load_callback);this.loading=false;this.set_asset_type(asset_type,project_id,callback,target_state);},on_project_load:function(asset_set,shot_set,target_state,after_load_callback){if(!this.is_loading())return;if(!asset_set.count()&&!shot_set.count()){this.entity_order=[];this.on_version_details_load(after_load_callback);return;}
var entities=[];var i,record;for(i=0;i<asset_set.count();i++){record=asset_set.get_record(i);entities.push({type:'Asset',id:record.get_id(),name:record.get('code')});}
for(i=0;i<shot_set.count();i++){record=shot_set.get_record(i);entities.push({type:'Shot',id:record.get_id(),name:record.get('code')});}
this.fetch_versions(entities,target_state,after_load_callback);},on_all_assets_load:function(asset_set,target_state,after_load_callback){if(!this.is_loading())return;if(!asset_set.count()){this.entity_order=[];this.on_version_details_load(after_load_callback);return;}
var entities=[];var i,record;for(i=0;i<asset_set.count();i++){record=asset_set.get_record(i);entities.push({type:'Asset',id:record.get_id(),name:record.get('code')});}
this.fetch_versions(entities,target_state,after_load_callback);},on_asset_load:function(asset_set,target_state,after_load_callback){if(!this.is_loading())return;if(!asset_set.count()){this.on_version_details_load(after_load_callback);return;}
var record=asset_set.get_record(0);var entities=[{type:'Asset',id:record.get_id(),name:record.get('code'),image:record.get('image')}];target_state.project_id=record.get('project').id;target_state.asset_type=record.get('sg_asset_type')||'-1';this.fetch_versions(entities,target_state,after_load_callback);},on_asset_type_load:function(asset_type_set,target_state,after_load_callback){if(!this.is_loading())return;if(!asset_type_set.count()){this.on_version_details_load(after_load_callback);return;}
var entities=[];var i,record;for(i=0;i<asset_type_set.count();i++){record=asset_type_set.get_record(i);entities.push({type:record.get_type(),id:record.get_id(),name:record.get('code'),image:record.get('image')});}
this.fetch_versions(entities,target_state,after_load_callback);},on_all_shots_load:function(shot_set,target_state,after_load_callback){if(!this.is_loading())return;if(!shot_set.count()){this.on_version_details_load(after_load_callback);return;}
var entities=[];var i,record;for(i=0;i<shot_set.count();i++){record=shot_set.get_record(i);entities.push({type:'Shot',id:record.get_id(),name:record.get('code')});}
this.fetch_versions(entities,target_state,after_load_callback);},on_seq_shots_load:function(seq_set,seq_shots_set,target_state,after_load_callback){if((target_state.sequence_id>0&&!seq_set.is_loaded())||!seq_shots_set.is_loaded())return;if(!this.is_loading())return;var seq_record;if(target_state.sequence_id>0&&seq_set.count()>0){seq_record=seq_set.get_record(0);target_state.project_id=seq_record.get('project').id;}
if((target_state.sequence_id>0&&!seq_set.count())||!seq_shots_set.count()){this.set_state(target_state);this.on_version_details_load(after_load_callback);return;}
var has_cut_order=true;if(target_state.sequence_id>0)
for(i=0;i<seq_shots_set.count();i++){record=seq_shots_set.get_record(i);if(isNaN(record.get('sg_cut_order'))){has_cut_order=false;break;}}
var entities=[];var i,record;var idx=0;var cut_order;for(i=0;i<seq_shots_set.count();i++){record=seq_shots_set.get_record(i);entities.push({type:'Shot',id:record.get_id(),name:record.get('code'),image:record.get('image')});++idx;}
target_state.has_cut_order=has_cut_order;this.fetch_versions(entities,target_state,after_load_callback);},on_shot_load:function(shot_set,target_state,after_load_callback){if(!this.is_loading())return;if(!shot_set.count()){this.on_version_details_load(after_load_callback);return;}
var record=shot_set.get_record(0);var entities=[{type:'Shot',id:record.get_id(),name:record.get('code'),image:record.get('image')}];target_state.project_id=record.get('project').id;target_state.sequence_id=record.get('sg_sequence').id;this.fetch_versions(entities,target_state,after_load_callback);},on_playlist_versions_load:function(playlist_set,playlist_versions_set,target_state,after_load_callback){if(!playlist_set.is_loaded()||!playlist_versions_set.is_loaded())return;if(!this.is_loading())return;playlist_versions_set.on('change',this.on_version_change,this);this.playlist_versions_set=playlist_versions_set;var playlist_record=playlist_set.count()?playlist_set.get_record(0):null;var proj=playlist_record?playlist_record.get('project'):null;if(proj)
target_state.project_id=proj.id
else
target_state.project_id=null;if(target_state.append_versions){target_state.current_num_versions+=playlist_versions_set.count();target_state.entity_order=sg_deep_copy(this.entity_order);target_state.active_versions=sg_deep_copy(this.active_versions);}else{target_state.current_num_versions=playlist_versions_set.count();target_state.entity_order=[];target_state.active_versions={};}
var i,record,entity;for(i=0;i<playlist_versions_set.count();i++){record=playlist_versions_set.get_record(i);entity=sg_deep_copy(record.get('entity'));target_state.entity_order.push(entity);if(entity)
target_state.active_versions[entity.type+'_'+entity.id]=record.get_id();}
if(playlist_versions_set.paging_info&&playlist_versions_set.paging_info.record_count)
target_state.total_num_versions=playlist_versions_set.paging_info.record_count;else
target_state.total_num_versions=playlist_versions_set.count();this.set_state(target_state);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},on_page_versions_load:function(page_versions_set,target_state,after_load_callback){if(!this.is_loading())return;page_versions_set.on('change',this.on_version_change,this);this.page_versions_set=page_versions_set;var i;if(target_state.append_versions){target_state.current_num_versions+=page_versions_set.count();target_state.entity_order=sg_deep_copy(this.entity_order);target_state.active_versions=sg_deep_copy(this.active_versions);}else{target_state.current_num_versions=page_versions_set.count();target_state.entity_order=[];target_state.active_versions={};}
var group,record,entity,do_push;for(i=0;i<page_versions_set.count();i++){record=page_versions_set.get_record(i);entity=record.get('entity');target_state.entity_order.push(entity);}
if(page_versions_set.paging_info&&page_versions_set.paging_info.record_count)
target_state.total_num_versions=page_versions_set.paging_info.record_count;else
target_state.total_num_versions=page_versions_set.count();this.set_state(target_state);if(after_load_callback)
after_load_callback.fn.call(after_load_callback.scope);},on_active_versions_load:function(latest_versions,active_entities,active_version_sets,target_state,after_load_callback){var i;for(i=0;i<active_version_sets.length;i++)
if(!active_version_sets[i].is_loaded())
return;var new_active_versions=sg_deep_copy(latest_versions);var i,entity,data_set,version_id,key;for(i=0;i<active_entities.length;i++){entity=active_entities[i];data_set=active_version_sets[i];key=entity.type+'_'+entity.id;version_id=target_state.active_versions[key];if(data_set.get_record_by_id(version_id))
new_active_versions[key]=version_id;}
target_state.active_versions=new_active_versions;this.fetch_sorted_active_versions(target_state,after_load_callback);},on_latest_versions_load:function(data_set,target_state,after_load_callback){var latest_versions={};var summary=data_set.group_summaries;var entities=[];var i,entity;for(i=0;i<summary.length;i++){if(summary[i].template_values&&summary[i].template_values[0]){entity=summary[i].template_values[0];entities.push(entity);latest_versions[entity.type+'_'+entity.id]=Number(summary[i].summaries[0].value);}}
if(entities.length===0){this.fetch_sorted_active_versions(target_state,after_load_callback);return;}
this.fetch_active_versions(entities,latest_versions,target_state,after_load_callback);},on_sorted_active_versions_load:function(active_versions_set,target_state,after_load_callback){if(!this.is_loading())return;var new_entity_order=[];var i,j,record_id;for(i=0;i<active_versions_set.count();i++)
new_entity_order.push(sg_deep_copy(active_versions_set.get_record(i).get('entity')));var callback={fn:function(data_set){this.on_timeline_history_load(new_entity_order,data_set,target_state,after_load_callback);},scope:this};var columns=['entity','image','sg_task.Task.step','user','description','flagged'];if(SG.globals.review_app_player)
columns=columns.concat(SG.globals.review_app_player.get_required_version_columns());this.fetch_version_history(new_entity_order,columns,target_state,callback);},on_gallery_history_load:function(data_set,target_state,after_load_callback){if(!this.is_loading())return;var total_num_versions;if(data_set.paging_info&&data_set.paging_info.record_count)
total_num_versions=data_set.paging_info.record_count;else
total_num_versions=data_set.count();if(target_state.append_versions)
target_state.current_num_versions+=data_set.count();else
target_state.current_num_versions=data_set.count();target_state.total_num_versions=total_num_versions;this.set_state(target_state);data_set.on('change',this.on_version_change,this);this.versions_set=data_set;this.on_version_details_load(after_load_callback);},on_timeline_history_load:function(entities,data_set,target_state,after_load_callback){if(!this.is_loading())return;data_set.on('change',this.on_version_change,this);var num_versions=data_set.count();if(target_state.append_entities){target_state.entity_order=this.entity_order.concat(entities);target_state.current_num_versions+=num_versions;}else{target_state.entity_order=entities;target_state.current_num_versions=num_versions;}
target_state.current_num_entities=target_state.entity_order.length;this.set_state(target_state);this.versions_set=data_set;this.on_version_details_load(after_load_callback);},on_cut_history_load:function(entities,data_set,target_state,after_load_callback){if(!this.is_loading())return;var new_active_versions={};var i,entity;if(!target_state.active_versions&&target_state.target_version_id&&target_state.target_entity){for(i=0;i<entities.length;i++){entity=entities[i];if(target_state.target_entity.type===entity.type&&target_state.target_entity.id===entity.id){target_state.active_versions={};target_state.active_versions[entity.type+'_'+entity.id]=target_state.target_version_id;break;}}}
var key,group;var num_versions=0;for(i=0;i<entities.length;i++){entity=entities[i];group=this.get_group_for_entity_from_data_set(entity,data_set);key=entity.type+'_'+entity.id;if(!group){delete new_active_versions[key];continue;}
num_versions+=group.ids.length;if(target_state.active_versions&&target_state.active_versions.hasOwnProperty(key)&&data_set.get_record_by_id(target_state.active_versions[key])){new_active_versions[key]=target_state.active_versions[key];}else if(group.ids.length>0){new_active_versions[key]=group.ids[0];}else{delete new_active_versions[key];}}
target_state.active_versions=new_active_versions;if(target_state.append_entities){target_state.current_num_versions+=num_versions;target_state.entity_order=this.entity_order.concat(entities);}else{target_state.current_num_versions=num_versions;target_state.entity_order=entities;}
target_state.current_num_entities=target_state.entity_order.length;this.set_state(target_state);this.versions_set=data_set;this.on_version_details_load(after_load_callback);},on_version_details_load:function(callback){if(!this.is_loading())return;if(callback)
callback.fn.call(callback.scope);},on_updates_load:function(data_set){var render=false;var i,j,record,item,status,s,anim_cfgs,path,re;for(i=0;i<data_set.count();i++){record=data_set.get_record(i);item=this.version_items[record.get_id()];if(!item)continue;status='ready';if(SG.globals.review_app_player){var s=SG.globals.review_app_player.get_record_status(record);if(s===SG.globals.review_app_player.status.UNAVAILABLE)
status='unavailable';else if(s===SG.globals.review_app_player.status.PROCESSING)
status='processing';}
if(status!==item.status){item.status=status;item.rerender=true;render=true;anim_cfgs=this.get_anims_for_item_by_name(item,'status');for(j=0;j<anim_cfgs.length;j++)
this.cancel_anim(anim_cfgs[j]);if(status==='processing'){this.push_anim(item,'status',{periodic:true,frequency:1000/30});render=true;}
item.sg_tip=this.get_tooltip_for_item(item);}
if(record.get('image')){path=this.templates.thumb.apply({image_src:record.get('image')});re=RegExp(path+'$');if(item.image&&!re.test(item.image.src)){delete item.image;item.image_opacity=0;item.rerender=true;render=true;}}
if(record.get('filmstrip_image')){path=this.templates.filmstrip_image.apply({image_src:record.get('filmstrip_image')});re=RegExp(path+'$');if(item.filmstrip_image&&!re.test(item.filmstrip_image.src)){delete item.filmstrip_image;item.rerender=true;render=true;}}}
if(render)
this.render();if(this.updating_state_changed_callback)
this.updating_state_changed_callback.fn.call(this.updating_state_changed_callback.scope,false);},on_flagged_states_load:function(data_set){var i,record,id,orig_record,flagged;for(i=0;i<data_set.count();i++){record=data_set.get_record(i);id=record.get_id();orig_record=this.get_record_by_id(id);if(!orig_record)continue;flagged=record.get('flagged');orig_record.set('flagged',flagged);this.update_flagged_state(id,flagged);}},on_version_change:function(changes){var record_ids=[];var change,i,vdiv;for(i=0;i<changes.length;i++){change=changes[i];if(change.state!=='pending'&&change.type==='update'&&change.column==='flagged')
record_ids.push(change.record.get_id());}
if(record_ids.length)
SG.ReviewApp.Utils.notify_flag_state_changed(record_ids,'timeline');},extend_filters:function(filters_a,filters_b){if(!filters_a)
filters_a={logical_operator:'and',conditions:[]};if(filters_b)
filters_a.conditions=filters_a.conditions.concat(filters_b);this.get_parent_widget().substitute_filter_tokens(filters_a);},set_extra_filters:function(filters,after_load_callback){if(!this.get_mode())return;filters=filters||{logical_operator:'and',conditions:[]};this.set_loading(true);var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state,false,null,after_load_callback);var target_state=this.clone_state();target_state.extra_filters=filters;this.fetch_versions_for_current_mode(target_state,callback);},get_sorts:function(){return this.get_sorts_for_mode_from_state(this.get_state());},get_sorts_for_mode_from_state:function(state){var mode=this.get_mode_for_state(state);var sorts=state.sorts[mode];if(state.render_mode==='cut'){sorts=sg_deep_copy(this.default_sorts[mode]);}else if(mode==='version_page'&&!sorts){sorts=state.version_page_default_sorts;}
return sorts||[];},sorts_are_equal:function(first,second){if(!first&&!second)return true;if((!first&&second)||(first&&!second))return false;if(first.length!==second.length)return false;var i;for(i=0;i<first.length;i++){if(first[i].column!==second[i].column||first[i].direction!==second[i].direction)
return false;}
return true;},has_default_sorts:function(){var current_sorts=this.get_sorts();return this.sorts_are_default(current_sorts);},sorts_are_default:function(sorts){var default_sorts;if(this.get_mode()==='version_page')
default_sorts=this.version_page_default_sorts||[];else
default_sorts=this.default_sorts[this.get_mode()];return this.sorts_are_equal(sorts,default_sorts);},reset_sorts_to_default:function(callback){var sorts;if(this.get_mode()==='version_page'&&!sorts)
sorts=this.version_page_default_sorts;else
sorts=this.default_sorts[this.get_mode()];this.set_sorts(sorts,callback);},set_sorts:function(sorts,after_load_callback){var previous_render_mode=this.render_mode;var initial_state=this.clone_state();var target_state=this.clone_state();var all_sorts=sg_deep_copy(this.sorts);if(this.get_mode()==='version_page'&&this.sorts_are_equal(sorts,this.version_page_default_sorts))
all_sorts.version_page=null;else
all_sorts[this.get_mode()]=sorts;target_state.sorts=all_sorts;this.set_loading(true);var callback=this.get_after_fetch_callback(initial_state,false,null,after_load_callback);this.fetch_versions_for_current_mode(target_state,callback);},set_render_mode:function(render_mode,after_load_callback){var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state,false,null,after_load_callback);if(!this.get_mode()){callback.fn.call(callback.scope);return;}
this.set_loading(true);var target_state=this.clone_state();target_state.render_mode=render_mode;this.fetch_versions_for_current_mode(target_state,callback);},set_history_limit:function(limit,after_load_callback){var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state,false,null,after_load_callback);this.set_loading(true);var target_state=this.clone_state();target_state.history_limit=limit;this.fetch_versions_for_current_mode(target_state,callback);},set_version_page_size:function(limit){var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state);var target_state=this.clone_state();target_state.version_page_size=limit;if(limit>-1)
target_state.max_num_versions=(this.floor((this.current_num_versions-1)/limit)+1)*limit;else
target_state.max_num_versions=-1;if((target_state.max_num_versions===-1||target_state.max_num_versions!==this.current_num_versions)&&this.current_num_versions!==this.total_num_versions){this.set_loading(true);this.fetch_versions_for_current_mode(target_state,callback);}else{this.set_state(target_state);if(this.version_page_size_changed_callback)
this.version_page_size_changed_callback.fn.call(this.version_page_size_changed_callback.scope,limit);}},set_entity_page_size:function(limit){var initial_state=this.clone_state();var callback=this.get_after_fetch_callback(initial_state);var target_state=this.clone_state();target_state.entity_page_size=limit;if(limit>-1)
target_state.max_num_entities=(this.floor((this.current_num_entities-1)/limit)+1)*limit;else
target_state.max_num_entities=-1;var callback;if((target_state.max_num_entities===-1||target_state.max_num_entities>this.current_num_entities)&&this.current_num_entities!==this.total_num_entities){this.set_loading(true);this.fetch_versions_for_current_mode(target_state,callback);}else{this.set_state(target_state);this.entity_page_size_changed_callback.fn.call(this.entity_page_size_changed_callback.scope,limit);}},get_filters:function(){return sg_deep_copy(this.filters);},get_dataset_size:function(){var mode=this.get_mode();if(mode==='playlist'){if(!this.playlist_versions_set)return 0;return this.playlist_versions_set.count();}if(mode==='version_page'){if(!this.page_versions_set)return 0;return this.page_versions_set.count();}
if(!this.versions_set)return 0;return this.versions_set.count();},get_record_by_id:function(id){if(this.get_mode()==='playlist'&&this.playlist_versions_set)
return this.playlist_versions_set.get_record_by_id(id);if(this.get_mode()==='version_page'&&this.page_versions_set)
return this.page_versions_set.get_record_by_id(id);if(this.versions_set)
return this.versions_set.get_record_by_id(id);return null;},get_group_for_entity_from_data_set:function(entity,data_set){var entity,group;for(j=0;j<data_set.groups.length;j++){e=data_set.groups[j].template_values[0];if(e.type===entity.type&&e.id===entity.id){group=data_set.groups[j];break;}}
if(!group)
return null;return group;},get_group_for_entity:function(entity){if(this.is_rendering_versions())return null;return this.get_group_for_entity_from_data_set(entity,this.versions_set);},determine_viewed_version:function(){if(!SG.globals.review_app_player)return;var viewed_version_ids=SG.globals.review_app_player.get_loaded_versions();if(!viewed_version_ids||viewed_version_ids[0]===-1)
viewed_version_ids=[];var progress_hash=SG.globals.review_app_player.get_progress();if(!progress_hash||progress_hash.version_id===-1)
return;var version_id=progress_hash.version_id;var completion=progress_hash.progress;this.on_viewed_versions_changed(viewed_version_ids,version_id,completion);},on_viewed_versions_changed:function(viewed_version_ids,current_version_id,completion){if(this.updates_disabled)return;var active_versions_changed=false;if(this.render_mode!=='gallery'){var new_active_versions={};var current_record=this.get_record_by_id(current_version_id);if(current_record){var entity=current_record.get('entity');if(entity&&current_version_id)
new_active_versions[entity.type+'_'+entity.id]=current_version_id;}
var i,entity,key,vid,record;for(i=0;i<viewed_version_ids.length;i++){vid=viewed_version_ids[i];record=this.get_record_by_id(vid);if(!record)continue;entity=record.get('entity');if(!entity)continue;key=entity.type+'_'+entity.id;if(!new_active_versions[key]||new_active_versions[key]<vid)
new_active_versions[key]=vid;}
if(!this.active_versions)
this.active_versions={};for(key in new_active_versions){if(new_active_versions.hasOwnProperty(key)){vid=new_active_versions[key];if(!this.active_versions[key]||this.active_versions[key]!==vid){this.active_versions[key]=vid;active_versions_changed=true;}}}}
var rerender=this.update_viewed_versions(current_version_id,completion,viewed_version_ids);if(active_versions_changed)
this.set_active_versions(this.active_versions);if(active_versions_changed||rerender)
this.render();},view_versions:function(version_ids){SG.globals.review_app_player.view_versions(version_ids);},view_selected:function(){this.view_versions(this.selected_ids);},view_active_versions:function(){var version_ids=this.sort_ids(this.get_active_versions());this.view_versions(version_ids);},show_loading_overlay:function(container){var id="review_app_canvas_timeline_loading_overlay";if(!this.__overlay_template_div__&&!(this.__overlay_template_div__=Ext.get(id))){var overlay_html='<div class="progress_indicator_overlay_container widget_not_progress_indicator" id="'+id+'">'+'<div class="progress_indicator_overlay widget_not_progress_indicator"><img src="'+
SG.globals.icons.IndicatorLargeTransparent+'"/></div></div>';this.__overlay_template_div__=Ext.DomHelper.append(this.container,overlay_html,true);}
this.__overlay_template_div__.alignTo(container,"tl-tl");this.__overlay_template_div__.setWidth(container.getWidth());this.__overlay_template_div__.setHeight(container.getHeight());Ext.fly(this.__overlay_template_div__.dom.firstChild).center(this.__overlay_template_div__);this.__overlay_template_div__.show();},hide_loading_overlay:function(){if(this.__overlay_template_div__)
this.__overlay_template_div__.hide();}});SG.ReviewAppSearchField=function(config){Ext.apply(this,config);SG.QuickJump.superclass.constructor.call(this,config);};Ext.extend(SG.ReviewAppSearchField,SG.QuickJump,{templates:{clear_filter:'<div class="clear_filter review_app_close_pane"></div>',tooltip_text:'Filter and search. (keyboard shortcut: "s")'},init_component:function(){SG.ReviewAppSearchField.superclass.init_component.call(this);this.prompt_menu_items_callback={fn:this.get_prompt_menu_items,scope:this};this.waiting_menu_items_callback={fn:this.get_waiting_menu_items,scope:this};this.menu_class='sgw_review_app_timeline_search_field_listbox';this.help_text='Search';this.not_global_quick_jump=true;},on_first_render:function(){SG.ReviewAppSearchField.superclass.on_first_render.call(this);this.filter_panel.get_quick_filter();Ext.EventManager.addListener(window,'blur',this.blur_input,this);},render:function(){SG.ReviewAppSearchField.superclass.render.call(this);this.listbox.disable_autocomplete_focus=true;this.listbox.on('before_show',function(){this.quick_jump_div.dom.removeAttribute('sg_tip');},this);this.listbox.on('after_hide',function(){this.quick_jump_div.dom.setAttribute('sg_tip',this.templates.tooltip_text.apply());},this);var clear_filter_html=this.templates.clear_filter.apply();this.clear_filter_button=Ext.DomHelper.insertAfter(this.input,clear_filter_html,true);this.refresh();this.quick_jump_div.dom.setAttribute('sg_tip',this.templates.tooltip_text.apply());},refresh:function(){if(this.get_current_filter()){this.quick_jump_div.addClass('filter_active');this.input.dom.value=this.get_current_filter();}else{this.clear_input();}},request_params:function(search_text){this.show_autocomplete_spinner();var request_params={query:search_text,sg_autocomplete:true};var classes=SG.schema.convert_entity_types_for_autocomplete(this.current_entity_types);request_params.complete_classes=Ext.encode(classes);if(Number(this.project_id)!==0)
request_params.project_ids=Ext.encode([this.project_id]);return request_params;},on_autocomplete_response:function(response){var items=[this.get_find_in_page_menu_item()];items.push({heading:'JUMP TO'});var new_matches=[];var i;for(i=0;i<response.matches.length;i++){if(response.matches[i].type==='Page'&&response.matches[i].subtype.indexOf('Version')<0)
continue;new_matches.push(response.matches[i]);}
var response_copy=sg_deep_copy(response);response_copy.matches=new_matches;var autocomplete_items=SG.ReviewAppSearchField.superclass.on_autocomplete_response.call(this,response_copy);if(autocomplete_items.length>0){items=items.concat(autocomplete_items);}else{items.push({html:'No Quick Jump matches found',disabled:true});}
return items;},on_click:function(e){var t=Ext.get(e.getTarget());var input=t.findParent('input.qj',this.container);if(input){if(!this.input.hasClass('ready')){this.clear_help_text();this.listbox.autocomplete_request();this.input.addClass('ready');this.input.focus();e.preventDefault();}
return;}
var clear_filter_div=t.findParent('div.clear_filter',this.container);if(clear_filter_div&&this.get_current_filter()){this.quick_key_focus();this.on_filter_cleared();return;}
SG.ReviewAppSearchField.superclass.on_click.call(this,e);},on_keydown:function(e)
{var key=e.getKey();if((key===e.RETURN||key===e.TAB)){if(this.input.hasClass('ready')){var item=this.listbox.find_selected();if(item)
this.listbox.autocomplete_selected(item);else
this.on_filter_set();}
return;}else if(!this.input.hasClass('ready')){this.input.addClass('ready');this.listbox.autocomplete_request();}
SG.ReviewAppSearchField.superclass.on_keydown.call(this,e);},clear_input:function(){this.quick_jump_div.removeClass('filter_active');SG.ReviewAppSearchField.superclass.clear_input.call(this);},clear_all:function(){this.listbox.items=[];SG.ReviewAppSearchField.superclass.clear_all.call(this);},blur_input:function()
{if(this.get_current_filter()&&this.input.hasClass('ready')){this.clear_input();this.input.dom.value=this.get_current_filter();this.quick_jump_div.addClass('filter_active');return;}
SG.ReviewAppSearchField.superclass.blur_input.call(this);},get_current_filter:function(){return this.filter_panel.get('last_quick_filter_value')||'';},set_current_filter:function(filter_string){filter_string=filter_string.strip();if(!filter_string){this.listbox.cancel_autocomplete();this.clear_filter();this.clear_input();return;}
if(this.get_current_filter()===filter_string)
return;try{var input=this.filter_panel.get_quick_filter().get_quick_filter_input();if(input)
input.dom.value=filter_string;this.filter_panel.get_quick_filter().set_unfocused_prompt();}catch(e){}
if(filter_string)
this.quick_jump_div.addClass('filter_active');else
this.quick_jump_div.removeClass('filter_active');var filters=this.filter_panel.get_quick_filter().set_current_filter(filter_string);this.filter_panel.get_quick_filter().update_widget(filters);},clear_filter:function(){this.filter_panel.get_quick_filter().clear_filters();},get_entity_types_menu:function(){if(!this.entity_types_menu){this.entity_types_menu=this.new_component(SG.Menu,{menu_class:' quick_jump_entity_type_and_project_menu',item_selected:{fn:this.on_entity_type_menu_select,scope:this},before_show:{fn:this.on_before_show_entity_types_menu,scope:this},after_hide:{fn:function(){this.quick_jump_div.dom.setAttribute('sg_tip',this.templates.tooltip_text.apply());},scope:this}});this.entity_types_menu.render();}
this.entity_types_menu.position={dom_elem:this.quick_jump_div.dom,elem_anchor:'bl',menu_anchor:'tl',no_cover:true};return this.entity_types_menu;},on_before_show_entity_types_menu:function(menu){this.quick_jump_div.dom.removeAttribute('sg_tip');var items=[];items.push({heading:'QUICK JUMP'});items=items.concat(this.get_entity_types_menu_items());var quick_filter=this.filter_panel.get_quick_filter();items.push({heading:'FILTERING'});var filter_items=quick_filter.get_more_fields_menu_items();var i;for(i=0;i<filter_items.length;i++){filter_items[i].item_selected={fn:quick_filter.on_more_fields_menu_click,scope:quick_filter};}
items=items.concat(filter_items);menu.items=items;menu.render();},get_entity_types_menu_items:function()
{var items=[];items.push({html:'All',value:'all_entity_types',checked:this.entity_type=='all_entity_types'});var i;var entity_types=this.get_all_quick_jump_entities();for(i=0;i<entity_types.length;i++)
{items.push({icon_name:'icon_'+entity_types[i],html:SG.schema.entity_types[entity_types[i]].display_name,value:entity_types[i],checked:entity_types[i]==this.entity_type});}
items.push({line:true});var submenu={};submenu.items=[{html:'All Projects',checked:Number(this.project_id)===0,project_id:0,item_selected:{fn:this.on_project_menu_select,scope:this}}];for(i=0;i<SG.schema.projects.length;i++)
{submenu.items.push({html:SG.schema.projects[i].name,project_id:SG.schema.projects[i].id,checked:Number(this.project_id)===SG.schema.projects[i].id,item_selected:{fn:this.on_project_menu_select,scope:this}});}
items.push({html:'Projects',submenu:submenu});return items;},get_find_in_page_menu_item:function(){return{html:'<i>Find "'+this.input.dom.value+'" on this page</i>',value:'do_filter',default_item:true,item_selected:{fn:this.on_filter_set,scope:this}};},on_filter_set:function(){this.listbox.cancel_autocomplete();this.set_current_filter(this.input.dom.value);this.blur_input();},on_filter_cleared:function(){this.listbox.cancel_autocomplete();this.clear_filter();this.clear_input();this.clear_help_text();},get_prompt_menu_items:function(){var items=[];var prompt_item={html:'Type a name or search term to get started',disabled:true};if(this.input.dom.value)
items.push(this.get_find_in_page_menu_item());else
items.push(prompt_item);if(this.input.dom.value){items.push({heading:'JUMP TO'});items.push(prompt_item);}
return items;},get_waiting_menu_items:function(){var items=[this.get_find_in_page_menu_item()];items.push({heading:'JUMP TO'});items.push({html:'<img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/><i>Loading...</i>',disabled:true});return items;},set_help_text:function(){this.input.dom.value=this.help_text;},clear_help_text:function(){if(this.input.dom.value.strip()===this.help_text)
this.input.dom.value='';}});SG.ReviewAppRTree=function(width){var _Min_Width=3;var _Max_Width=6;if(!isNaN(width)){_Min_Width=Math.floor(width/2.0);_Max_Width=width;}
var _T={x:0,y:0,w:0,h:0,id:"root",nodes:[]};var isArray=function(o){return Object.prototype.toString.call(o)==='[object Array]';};var _name_to_id=(function(){var idCache={};return function(idPrefix){var idVal=0;if(idPrefix in idCache){idVal=idCache[idPrefix]++;}else{idCache[idPrefix]=0;}
return idPrefix+"_"+idVal;}})();SG.ReviewAppRTree.Rectangle.squarified_ratio=function(l,w,fill){var lperi=(l+w)/2.0;var larea=l*w;var lgeo=larea/(lperi*lperi);return(larea*fill/lgeo);};var _remove_subtree=function(rect,obj,root){var hit_stack=[];var count_stack=[];var ret_array=[];var current_depth=1;if(!rect||!SG.ReviewAppRTree.Rectangle.overlap_rectangle(rect,root))
return ret_array;var ret_obj={x:rect.x,y:rect.y,w:rect.w,h:rect.h,target:obj};count_stack.push(root.nodes.length);hit_stack.push(root);do{var tree=hit_stack.pop();var i=count_stack.pop()-1;if("target"in ret_obj){while(i>=0){var ltree=tree.nodes[i];if(SG.ReviewAppRTree.Rectangle.overlap_rectangle(ret_obj,ltree)){if((ret_obj.target&&"leaf"in ltree&&ltree.leaf===ret_obj.target)||(!ret_obj.target&&("leaf"in ltree||SG.ReviewAppRTree.Rectangle.contains_rectangle(ltree,ret_obj)))){if("nodes"in ltree){ret_array=_search_subtree(ltree,true,[],ltree);tree.nodes.splice(i,1);}else{ret_array=tree.nodes.splice(i,1);}
SG.ReviewAppRTree.Rectangle.make_MBR(tree.nodes,tree);delete ret_obj.target;if(tree.nodes.length<_Min_Width){ret_obj.nodes=_search_subtree(tree,true,[],tree);}
break;}else if("nodes"in ltree){current_depth+=1;count_stack.push(i);hit_stack.push(tree);tree=ltree;i=ltree.nodes.length;}}
i-=1;}}else if("nodes"in ret_obj){tree.nodes.splice(i+1,1);if(tree.nodes.length>0)
SG.ReviewAppRTree.Rectangle.make_MBR(tree.nodes,tree);for(var t=0;t<ret_obj.nodes.length;t++)
_insert_subtree(ret_obj.nodes[t],tree);ret_obj.nodes.length=0;if(hit_stack.length==0&&tree.nodes.length<=1){ret_obj.nodes=_search_subtree(tree,true,ret_obj.nodes,tree);tree.nodes.length=0;hit_stack.push(tree);count_stack.push(1);}else if(hit_stack.length>0&&tree.nodes.length<_Min_Width){ret_obj.nodes=_search_subtree(tree,true,ret_obj.nodes,tree);tree.nodes.length=0;}else{delete ret_obj.nodes;}}else{SG.ReviewAppRTree.Rectangle.make_MBR(tree.nodes,tree);}
current_depth-=1;}while(hit_stack.length>0);return(ret_array);};var _choose_leaf_subtree=function(rect,root){var best_choice_index=-1;var best_choice_stack=[];var best_choice_area;var load_callback=function(local_tree,local_node){return(function(data){local_tree._attach_data(local_node,data);});};best_choice_stack.push(root);var nodes=root.nodes;do{if(best_choice_index!=-1){best_choice_stack.push(nodes[best_choice_index]);nodes=nodes[best_choice_index].nodes;best_choice_index=-1;}
for(var i=nodes.length-1;i>=0;i--){var ltree=nodes[i];if("leaf"in ltree){best_choice_index=-1;break;}
var old_lratio=SG.ReviewAppRTree.Rectangle.squarified_ratio(ltree.w,ltree.h,ltree.nodes.length+1);var nw=Math.max(ltree.x+ltree.w,rect.x+rect.w)-Math.min(ltree.x,rect.x);var nh=Math.max(ltree.y+ltree.h,rect.y+rect.h)-Math.min(ltree.y,rect.y);var lratio=SG.ReviewAppRTree.Rectangle.squarified_ratio(nw,nh,ltree.nodes.length+2);if(best_choice_index<0||Math.abs(lratio-old_lratio)<best_choice_area){best_choice_area=Math.abs(lratio-old_lratio);best_choice_index=i;}}}while(best_choice_index!=-1);return(best_choice_stack);};var _linear_split=function(nodes){var n=_pick_linear(nodes);while(nodes.length>0){_pick_next(nodes,n[0],n[1]);}
return(n);};var _pick_next=function(nodes,a,b){var area_a=SG.ReviewAppRTree.Rectangle.squarified_ratio(a.w,a.h,a.nodes.length+1);var area_b=SG.ReviewAppRTree.Rectangle.squarified_ratio(b.w,b.h,b.nodes.length+1);var high_area_delta;var high_area_node;var lowest_growth_group;for(var i=nodes.length-1;i>=0;i--){var l=nodes[i];var new_area_a={};new_area_a.x=Math.min(a.x,l.x);new_area_a.y=Math.min(a.y,l.y);new_area_a.w=Math.max(a.x+a.w,l.x+l.w)-new_area_a.x;new_area_a.h=Math.max(a.y+a.h,l.y+l.h)-new_area_a.y;var change_new_area_a=Math.abs(SG.ReviewAppRTree.Rectangle.squarified_ratio(new_area_a.w,new_area_a.h,a.nodes.length+2)-area_a);var new_area_b={};new_area_b.x=Math.min(b.x,l.x);new_area_b.y=Math.min(b.y,l.y);new_area_b.w=Math.max(b.x+b.w,l.x+l.w)-new_area_b.x;new_area_b.h=Math.max(b.y+b.h,l.y+l.h)-new_area_b.y;var change_new_area_b=Math.abs(SG.ReviewAppRTree.Rectangle.squarified_ratio(new_area_b.w,new_area_b.h,b.nodes.length+2)-area_b);if(!high_area_node||!high_area_delta||Math.abs(change_new_area_b-change_new_area_a)<high_area_delta){high_area_node=i;high_area_delta=Math.abs(change_new_area_b-change_new_area_a);lowest_growth_group=change_new_area_b<change_new_area_a?b:a;}}
var temp_node=nodes.splice(high_area_node,1)[0];if(a.nodes.length+nodes.length+1<=_Min_Width){a.nodes.push(temp_node);SG.ReviewAppRTree.Rectangle.expand_rectangle(a,temp_node);}else if(b.nodes.length+nodes.length+1<=_Min_Width){b.nodes.push(temp_node);SG.ReviewAppRTree.Rectangle.expand_rectangle(b,temp_node);}
else{lowest_growth_group.nodes.push(temp_node);SG.ReviewAppRTree.Rectangle.expand_rectangle(lowest_growth_group,temp_node);}};var _pick_linear=function(nodes){var lowest_high_x=nodes.length-1;var highest_low_x=0;var lowest_high_y=nodes.length-1;var highest_low_y=0;var t1,t2;for(var i=nodes.length-2;i>=0;i--){var l=nodes[i];if(l.x>nodes[highest_low_x].x)highest_low_x=i;else if(l.x+l.w<nodes[lowest_high_x].x+nodes[lowest_high_x].w)lowest_high_x=i;if(l.y>nodes[highest_low_y].y)highest_low_y=i;else if(l.y+l.h<nodes[lowest_high_y].y+nodes[lowest_high_y].h)lowest_high_y=i;}
var dx=Math.abs((nodes[lowest_high_x].x+nodes[lowest_high_x].w)-nodes[highest_low_x].x);var dy=Math.abs((nodes[lowest_high_y].y+nodes[lowest_high_y].h)-nodes[highest_low_y].y);if(dx>dy){if(lowest_high_x>highest_low_x){t1=nodes.splice(lowest_high_x,1)[0];t2=nodes.splice(highest_low_x,1)[0];}else{t2=nodes.splice(highest_low_x,1)[0];t1=nodes.splice(lowest_high_x,1)[0];}}else{if(lowest_high_y>highest_low_y){t1=nodes.splice(lowest_high_y,1)[0];t2=nodes.splice(highest_low_y,1)[0];}else{t2=nodes.splice(highest_low_y,1)[0];t1=nodes.splice(lowest_high_y,1)[0];}}
return([{x:t1.x,y:t1.y,w:t1.w,h:t1.h,nodes:[t1]},{x:t2.x,y:t2.y,w:t2.w,h:t2.h,nodes:[t2]}]);};var _attach_data=function(node,more_tree){node.nodes=more_tree.nodes;node.x=more_tree.x;node.y=more_tree.y;node.w=more_tree.w;node.h=more_tree.h;return(node);};var _search_subtree=function(rect,return_node,return_array,root){var hit_stack=[];if(!SG.ReviewAppRTree.Rectangle.overlap_rectangle(rect,root))
return(return_array);var load_callback=function(local_tree,local_node){return(function(data){local_tree._attach_data(local_node,data);});};hit_stack.push(root.nodes);do{var nodes=hit_stack.pop();for(var i=nodes.length-1;i>=0;i--){var ltree=nodes[i];if(SG.ReviewAppRTree.Rectangle.overlap_rectangle(rect,ltree)){if("nodes"in ltree){hit_stack.push(ltree.nodes);}else if("leaf"in ltree){if(!return_node)
return_array.push(ltree.leaf);else
return_array.push(ltree);}}}}while(hit_stack.length>0);return(return_array);};var _insert_subtree=function(node,root){var bc;if(root.nodes.length==0){root.x=node.x;root.y=node.y;root.w=node.w;root.h=node.h;root.nodes.push(node);return;}
var tree_stack=_choose_leaf_subtree(node,root);var ret_obj=node;do{if(bc&&"nodes"in bc&&bc.nodes.length==0){var pbc=bc;bc=tree_stack.pop();for(var t=0;t<bc.nodes.length;t++)
if(bc.nodes[t]===pbc||bc.nodes[t].nodes.length==0){bc.nodes.splice(t,1);break;}}else{bc=tree_stack.pop();}
if("leaf"in ret_obj||"nodes"in ret_obj||isArray(ret_obj)){if(isArray(ret_obj)){for(var ai=0;ai<ret_obj.length;ai++){SG.ReviewAppRTree.Rectangle.expand_rectangle(bc,ret_obj[ai]);}
bc.nodes=bc.nodes.concat(ret_obj);}else{SG.ReviewAppRTree.Rectangle.expand_rectangle(bc,ret_obj);bc.nodes.push(ret_obj);}
if(bc.nodes.length<=_Max_Width){ret_obj={x:bc.x,y:bc.y,w:bc.w,h:bc.h};}else{var a=_linear_split(bc.nodes);ret_obj=a;if(tree_stack.length<1){bc.nodes.push(a[0]);tree_stack.push(bc);ret_obj=a[1];}}}else{SG.ReviewAppRTree.Rectangle.expand_rectangle(bc,ret_obj);ret_obj={x:bc.x,y:bc.y,w:bc.w,h:bc.h};}}while(tree_stack.length>0);};this.get_tree=function(){return _T;};this.set_tree=function(new_tree,where){if(!where)
where=_T;return(_attach_data(where,new_tree));};this.search=function(rect,return_node,return_array){if(arguments.length<1)
throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle."
switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=[];case 3:arguments[3]=_T;default:arguments.length=4;}
return(_search_subtree.apply(this,arguments));};this.toJSON=function(rect,tree){var hit_stack=[];var count_stack=[];var return_stack={};var max_depth=3;var current_depth=1;var return_string="";if(rect&&!SG.ReviewAppRTree.Rectangle.overlap_rectangle(rect,_T))
return"";if(!tree){count_stack.push(_T.nodes.length);hit_stack.push(_T.nodes);return_string+="var main_tree = {x:"+_T.x.toFixed()+",y:"+_T.y.toFixed()+",w:"+_T.w.toFixed()+",h:"+_T.h.toFixed()+",nodes:[";}else{max_depth+=4;count_stack.push(tree.nodes.length);hit_stack.push(tree.nodes);return_string+="var main_tree = {x:"+tree.x.toFixed()+",y:"+tree.y.toFixed()+",w:"+tree.w.toFixed()+",h:"+tree.h.toFixed()+",nodes:[";}
do{var nodes=hit_stack.pop();var i=count_stack.pop()-1;if(i>=0&&i<nodes.length-1)
return_string+=",";while(i>=0){var ltree=nodes[i];if(!rect||SG.ReviewAppRTree.Rectangle.overlap_rectangle(rect,ltree)){if(ltree.nodes){if(current_depth>=max_depth){var len=return_stack.length;var nam=_name_to_id("saved_subtree");return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",load:'"+nam+".js'}";return_stack[nam]=this.toJSON(rect,ltree);if(i>0)
return_string+=","}else{return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",nodes:[";current_depth+=1;count_stack.push(i);hit_stack.push(nodes);nodes=ltree.nodes;i=ltree.nodes.length;}}else if(ltree.leaf){var data=ltree.leaf.toJSON?ltree.leaf.toJSON():JSON.stringify(ltree.leaf);return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",leaf:"+data+"}";if(i>0)
return_string+=","}else if(ltree.load){return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",load:'"+ltree.load+"'}";if(i>0)
return_string+=","}}
i-=1;}
if(i<0){return_string+="]}";current_depth-=1;}}while(hit_stack.length>0);return_string+=";";for(var my_key in return_stack){return_string+="\nvar "+my_key+" = function(){"+return_stack[my_key]+" return(main_tree);};";}
return(return_string);};this.remove=function(rect,obj){if(arguments.length<1)
throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle."
switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=_T;default:arguments.length=3;}
if(arguments[1]===false){var numberdeleted=0;var ret_array=[];do{numberdeleted=ret_array.length;ret_array=ret_array.concat(_remove_subtree.apply(this,arguments));}while(numberdeleted!=ret_array.length);return ret_array;}
else{return(_remove_subtree.apply(this,arguments));}};this.insert=function(rect,obj){if(arguments.length<2)
throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object."
return(_insert_subtree({x:rect.x,y:rect.y,w:rect.w,h:rect.h,leaf:obj},_T));};};SG.ReviewAppRTree.Rectangle=function(ix,iy,iw,ih){var x,x2,y,y2,w,h;if(ix.x){x=ix.x;y=ix.y;if(ix.w!==0&&!ix.w&&ix.x2){w=ix.x2-ix.x;h=ix.y2-ix.y;}else{w=ix.w;h=ix.h;}
x2=x+w;y2=y+h;}else{x=ix;y=iy;w=iw;h=ih;x2=x+w;y2=y+h;}
this.x1=this.x=function(){return x;};this.y1=this.y=function(){return y;};this.x2=function(){return x2;};this.y2=function(){return y2;};this.w=function(){return w;};this.h=function(){return h;};this.toJSON=function(){return('{"x":'+x.toString()+', "y":'+y.toString()+', "w":'+w.toString()+', "h":'+h.toString()+'}');};this.overlap=function(a){return(this.x()<a.x2()&&this.x2()>a.x()&&this.y()<a.y2()&&this.y2()>a.y());};this.expand=function(a){var nx=Math.min(this.x(),a.x());var ny=Math.min(this.y(),a.y());w=Math.max(this.x2(),a.x2())-nx;h=Math.max(this.y2(),a.y2())-ny;x=nx;y=ny;return(this);};this.setRect=function(ix,iy,iw,ih){var x,x2,y,y2,w,h;if(ix.x){x=ix.x;y=ix.y;if(ix.w!==0&&!ix.w&&ix.x2){w=ix.x2-ix.x;h=ix.y2-ix.y;}else{w=ix.w;h=ix.h;}
x2=x+w;y2=y+h;}else{x=ix;y=iy;w=iw;h=ih;x2=x+w;y2=y+h;}};};SG.ReviewAppRTree.Rectangle.overlap_rectangle=function(a,b){return(a.x<(b.x+b.w)&&(a.x+a.w)>b.x&&a.y<(b.y+b.h)&&(a.y+a.h)>b.y);};SG.ReviewAppRTree.Rectangle.contains_rectangle=function(a,b){return((a.x+a.w)<=(b.x+b.w)&&a.x>=b.x&&(a.y+a.h)<=(b.y+b.h)&&a.y>=b.y);};SG.ReviewAppRTree.Rectangle.expand_rectangle=function(a,b){var nx=Math.min(a.x,b.x);var ny=Math.min(a.y,b.y);a.w=Math.max(a.x+a.w,b.x+b.w)-nx;a.h=Math.max(a.y+a.h,b.y+b.h)-ny;a.x=nx;a.y=ny;return(a);};SG.ReviewAppRTree.Rectangle.make_MBR=function(nodes,rect){if(nodes.length<1)
return({x:0,y:0,w:0,h:0});if(!rect)
rect={x:nodes[0].x,y:nodes[0].y,w:nodes[0].w,h:nodes[0].h};else
rect.x=nodes[0].x;rect.y=nodes[0].y;rect.w=nodes[0].w;rect.h=nodes[0].h;for(var i=nodes.length-1;i>0;i--)
SG.ReviewAppRTree.Rectangle.expand_rectangle(rect,nodes[i]);return(rect);};SG.ReviewAppOverlay=function(config)
{Ext.apply(this,config);SG.ReviewAppOverlay.superclass.constructor.call(this);};Ext.extend(SG.ReviewAppOverlay,SG.Component,{templates:{main:'<div class="sgc_review_app_overlay_mask">'+'<div class="sgc_review_app_overlay {details_displayed}">'+'<div class="overlay_wrapper">'+'<div class="upper_right_buttons">'+'<div class="jump_button"></div>'+'{fullscreen}'+'<div class="close_button" sg_tip="Close Overlay (ESC)"></div>'+'</div>'+'<div class="player_wrapper"></div>'+'</div>'+'<div class="details"></div>'+'<div class="details_toggle"></div>'+'</div>'+'<div class="previous_entity" sg_tip="Previous Record (p)"></div>'+'<div class="next_entity" sg_tip="Next Record (n)"></div>'+'</div>',fullscreen:'<div class="fullscreen" sg_tip="Take Player Full Screen"></div>'},destroy_component:function(){Ext.EventManager.removeResizeListener(this.center_player,this);this.mask.remove();this.container.remove();this.shadow.el.remove();},on_first_render:function(){this.fullscreen_capable=false;if(!navigator.vendor.match(/Apple/)){var test_canvas=document.createElement('canvas');this.fullscreen_capable=test_canvas.requestFullScreen||test_canvas.mozRequestFullScreen||test_canvas.webkitRequestFullScreen;Ext.fly(test_canvas).remove();}
var details_open=false;var details_open_cookie=getCookie('sgc_review_app_overlay_details_open');if(details_open_cookie&&Number(details_open_cookie))
details_open=true;this.mask=Ext.DomHelper.append(document.body,this.templates.main.apply({fullscreen:this.fullscreen_capable?this.templates.fullscreen.apply():'',details_displayed:details_open?'details_displayed':''}),true);this.container=this.mask.child('div.sgc_review_app_overlay');var player_container=this.container.child('div.player_wrapper');var player_class;player_class=SG.ReviewAppPlayerVideoElement;this.player=this.new_component(player_class,{container:player_container});this.player.render();SG.globals.review_app_player=this.player;var encoded_settings=getCookie('review_app_info_columns');var columns=null;if(encoded_settings)
columns=Ext.decode(encoded_settings);var cookie=getCookie('review_app_details_info_open');var info_pane_open=cookie&&Number(cookie);var tab_idx_cookie=getCookie('review_app_tool_index');var tab_index=tab_idx_cookie?Number(tab_idx_cookie):0;this.details_container=this.container.child('div.details');this.details=this.new_component(SG.ReviewAppDetailsComponent,{container:this.details_container,edit_container:this.container,projects:this.get_parent_widget().context_projects(),columns:columns,info_pane_open:info_pane_open,tab_index:tab_index,columns_changed_callback:{fn:this.on_columns_changed,scope:this},info_open_changed_callback:{fn:this.on_info_open_changed,scope:this},tab_index_changed_callback:{fn:this.on_tab_index_changed,scope:this}});this.details.render();this.toggle_details_pane(details_open);SG.globals.review_app_player.on('viewed_versions_changed',function(version_ids,current_version_id,progress){if(!current_version_id||current_version_id<-1)
this.container.child('div.jump_button').setDisplayed(false);else
this.container.child('div.jump_button').setDisplayed(true);},this);SG.globals.review_app_player.on('loading_changed',this.on_player_loading_changed,this);this.shadow=new Ext.Shadow({offset:5,mode:'frame'});this.center_player();this.add_event(this.container,'click',this.on_click);this.add_event(this.mask,'click',this.on_mask_click);this.add_event(Ext.get(document),'keydown',this.on_keydown);Ext.EventManager.onWindowResize(this.center_player,this,true);if(this.fullscreen_capable){this.add_event(Ext.get(document),'mozfullscreenchange',this.on_fullscreen_change);this.add_event(Ext.get(document),'webkitfullscreenchange',this.on_fullscreen_change);}},render:function(){if(!this.rendered){if(document.activeElement)
document.activeElement.blur();this.on_first_render();this.rendered=true;document.body.focus();}},set_entity:function(entity_rec,version_id,linked_entity){this._previous_entity=null;this._next_entity=null;if(this.data_set&&entity_rec){var i=this.data_set.records.indexOf(entity_rec);if(i>=0){if(i>0)
this._previous_entity=this.data_set.records[i-1];if(i<this.data_set.count()-1)
this._next_entity=this.data_set.records[i+1];}}
var prev_button=this.mask.child('div.previous_entity');if(this._previous_entity)
prev_button.addClass('displayed');else
prev_button.removeClass('displayed');var next_button=this.mask.child('div.next_entity');if(this._next_entity)
next_button.addClass('displayed');else
next_button.removeClass('displayed');if(version_id){this.view_version(version_id,linked_entity);return;}
this.player.timeline_media=[];this.player.render();this.details.set_tool_context(null);return;},previous_entity:function(){if(!this._previous_entity)return;this.view_version_for_entity(this._previous_entity);},next_entity:function(){if(!this._next_entity)return;this.view_version_for_entity(this._next_entity);},view_version_for_entity:function(entity_rec){if(entity_rec.get_type()==='Version'){var version_id=entity_rec.get_id();var linked_entity=entity_rec.get('entity');this.set_entity(entity_rec,version_id,linked_entity);return;}
var entity;if(entity_rec.get_type()==='Task')
entity=entity_rec.get('entity');else
entity={type:entity_rec.type,id:entity_rec.id};if(!entity){this.set_entity(entity_rec);return;}
SG.ReviewApp.Utils.fetch_version_for_entity(entity,{fn:function(version_rec){if(version_rec)
this.set_entity(entity_rec,version_rec.get_id(),version_rec.get('entity'));else
this.set_entity(entity_rec);},scope:this});},view_version:function(version_id,entity){this.set_loading(true);this.player.view_versions([version_id]);},on_click:function(e){var target=Ext.get(e.getTarget());var elem=target.findParent('div.close_button');if(elem){this.destroy();return;}
elem=target.findParent('div.jump_button');if(elem){var buttons=Ext.fly(elem).findParent('div.upper_right_buttons',null,true);if(!this.jump_menu)
this.jump_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_jump_menu,scope:this},after_hide:{fn:function(the_menu){the_menu.menu_ext_elem.setStyle('z-index',40001);Ext.fly(elem).removeClass('menu_showing');buttons.removeClass('menu_showing');},scope:this}});Ext.fly(elem).addClass('menu_showing');buttons.addClass('menu_showing');if(SG.Menu.now_showing===this.jump_menu){this.jump_menu.hide();}else{this.jump_menu.position={dom_elem:elem,elem_anchor:'bl',menu_anchor:'tl'};this.jump_menu.show();}
return;}
elem=target.findParent('div.fullscreen');if(elem){if(this.is_fullscreen()){this.exit_fullscreen();}else{this.enter_fullscreen(this.container.dom);}}
elem=target.findParent('div.details_toggle');if(elem){this.toggle_details_pane(!this.container.hasClass('details_displayed'));this.center_player();return;}},on_keydown:function(e){if(SG.GlobalNav.__ignore(e))
return;e.stopEvent();var target=Ext.get(e.getTarget());var key=e.getKey();if(key===Ext.EventObject.ESC){this.destroy();return;}
if(key===80){this.previous_entity();return;}
if(key===78){this.next_entity();return;}},on_fullscreen_change:function(e){var fullscreen=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;var i,j,sheet,rule,menu_sheet;for(i=0;i<document.styleSheets.length;i++){sheet=document.styleSheets[i];for(j=0;j<sheet.cssRules.length;j++){rule=sheet.cssRules[j];if(rule.selectorText=='div.sg_menu')
rule.style.zIndex=fullscreen?2147483647:20001;if(rule.selectorText=='div.sg_dialog_mask')
rule.style.zIndex=fullscreen?2147483647:10000;}}
var fullscreen_button=this.container.child('div.fullscreen');if(fullscreen){fullscreen_button.addClass('is_fullscreen');}else{fullscreen_button.removeClass('is_fullscreen');}
this.center_player();},on_mask_click:function(e){var target=Ext.get(e.getTarget());if(target.hasClass('sgc_review_app_overlay_mask')){this.destroy();return;}
elem=target.findParent('div.previous_entity');if(elem){this.previous_entity();return;}
elem=target.findParent('div.next_entity');if(elem){this.next_entity();return;}},on_before_show_jump_menu:function(the_menu){var items=[];items.push({html:'View in Revolver Web App',item_selected:{fn:this.view_in_revolver,scope:this}});items.push({html:'View in Revolver for RV',item_selected:{fn:this.view_in_revolver_for_rv,scope:this}});the_menu.items=items;the_menu.render();},on_player_loading_changed:function(state){this.set_loading(state);this.center_player();},on_info_open_changed:function(open){setCookie('review_app_details_info_open',open?'1':'0',365);},on_columns_changed:function(columns){setCookie('review_app_info_columns',Ext.encode(columns),365);},on_tab_index_changed:function(tab_idx){setCookie('review_app_tool_index',tab_idx,365);},center_player:function(){if(!this.is_fullscreen()){var details_width=this.details_container.getWidth();var screen_height=this.mask.getHeight();var screen_width=this.mask.getWidth();var height=720;var width=Math.floor(height*1.77);var video_elem=this.player.get_video_elem();if(video_elem){width=Math.max(video_elem.videoWidth,width);height=Math.max(video_elem.videoHeight,height);}
var scale_x=(screen_width-details_width-100)/width;var scale_y=(screen_height-100-30)/height;var scale=Math.min(scale_x,scale_y);if(scale<1){width=Math.floor(scale*width);height=Math.floor(scale*height);}
var final_width=width+details_width;var final_height=height+30;this.container.setWidth(final_width);this.container.setHeight(final_height);this.container.setLeft((screen_width-final_width)/2);this.container.setTop((screen_height-final_height)/2);this.shadow.show(this.container);}else{this.container.setWidth('100%');this.container.setHeight('100%');this.container.setLeft(0);this.container.setTop(0);}
this.player.render();this.details.render();},is_fullscreen:function(){return document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen;},exit_fullscreen:function(){if(document.cancelFullScreen)
document.cancelFullScreen();else if(document.mozCancelFullScreen)
document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)
document.webkitCancelFullScreen();},enter_fullscreen:function(elem){if(elem.requestFullScreen)
elem.requestFullScreen();else if(elem.mozRequestFullScreen)
elem.mozRequestFullScreen();else if(elem.webkitRequestFullScreen)
elem.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);},toggle_details_pane:function(open){var toggle_switch=this.container.child('div.details_toggle');var sg_tip;if(open){sg_tip='Hide the detail pane';this.container.addClass('details_displayed');}else{sg_tip='Show the detail pane';this.container.removeClass('details_displayed');}
setCookie('sgc_review_app_overlay_details_open',open?'1':'0',365);this.details.on_updates_enabled(open);if(open)
this.details.set_tool_context_from_player_contents();toggle_switch.dom.setAttribute('sg_tip',sg_tip);},view_in_revolver:function(){var version_ids=this.player.get_viewed_versions();if(version_ids.length===0)return;this.exit_fullscreen();document.location='/page/review_app_webview?entity_type=Version&entity_id='+version_ids[0];},view_in_revolver_for_rv:function(){var version_ids=this.player.get_viewed_versions();if(version_ids.length===0)return;this.exit_fullscreen();SG.ReviewApp.Utils.view_in_rv({type:'Version',id:version_ids[0]});},set_loading:function(loading){if(loading)
this.details.show_loading_overlay(this.details_container);else
this.details.hide_loading_overlay();}});SG.Widget.ResourcePlanningApp=function(context,widget_spec,id)
{SG.Widget.ResourcePlanningApp.superclass.constructor.call(this,context,widget_spec,id);};SG.Widget.ResourcePlanningApp.request_id=1;Ext.extend(SG.Widget.ResourcePlanningApp,SG.Widget.Base,{default_settings:{major_unit:'week',low_date:null,high_date:null,color_by:'project',},length_of_a_day_in_pixels:{week:32,month:16,month_weeks:5,quarter:2,year:1},header_height:33,major_unit_height:17,header_selected_fill:'rgb(210,210,210)',text_fill:'rgb(0,0,0)',templates:{main:'<div class="sgw_resource_planning_app {no_title_bar}">'+'{header}<div class="content">{left_pane}{right_pane}</div>'+'</div>',header:'<div class="header">{title_bar}<div class="toolbar">{toolbar_contents}</div></div>',title_bar:'<div class="title">'+'<div class="logo"></div>'+'<div class="app_logo"></div>'+'<div class="title_text">Crew Planning'+'<span class="beta" style="color: rgb(180, 180, 180);">BETA</span></div>'+'{text_filter}'+'<div class="available_filter"><span>{checkbox}</span><span>Show Available</span></div>'+'{user_menu}'+'</div>',text_filter:'<div class="text_filter {show_clear}">'+'<div class="icon_search"></div>'+'<input class="text_filter" value="{filter_value}"></input>'+'<div class="text_filter_clear"></div>'+'</div>',toolbar_contents:'{sort}{today}{date_range}{text_filter}{app_launcher}{shortcuts}{color_menu}{refresh}{gear_menu}',app_launcher:'<a class="app_launcher" href="/page/crew_planning_app" target="_blank">'+'<input class="app_launcher" type="button" value="Launch App" /></a>',left_pane:'<div class="left_pane">'+'<div class="left_scroll_wrapper"><div class="left_scroll_container">'+'<div class="left_fake_content"></div></div></div>'+'<canvas class="left_main" height="{canvas_height}" width="{canvas_width}"></canvas>'+'</div>'+'<div class="left_pane_controls">{toolbar_plus}</div>',toolbar_plus:'<div class="toolbar_plus_person button_gradient {disabled}" sg_tip="{sg_tip}">'+'<div class="icon_plus_HumanUser"></div></div>',right_pane:'<div class="right_pane">'+'<div class="right_scroll_wrapper"><div class="right_scroll_container"></div></div>'+'<canvas class="right_main" height="{canvas_height}" width="{canvas_width}"></canvas>'+'<canvas class="right_background" height="{canvas_height}" width="{canvas_width}"></canvas>'+'<canvas class="right_drag" height="{canvas_height}" width="{canvas_width}"></canvas>'+'<div class="drag_marker"></div>'+'<div class="timescale_menu not_sel_target"><div class="icon_filter_menu"></div></div>'+'<div class="date_range_overlay not_sel_target hidden"></div>'+'</div>',sort_menu_control:'<div class="sort_menu_control button_gradient">'+'<span>Sort:</span><span class="current_sort">{sort_description}</span>'+'<div class="overflow_hider button_gradient"></div><div class="arrow_open_dark"></div>'+'</div>'+'<div class="sort_menu_direction {sort_direction} button_gradient">'+'<div class="icon_menu_arrow_down"></div>'+'<div class="icon_menu_arrow_up"></div>'+'</div>',color_menu_button:'<div class="color_menu_button button_gradient"><span>{now_coloring}</span>'+'<div class="arrow_open_dark"></div>'+'</div>',gear_menu_button:'<div class="gear_menu_button"><div class="gear_menu_nobg"></div></div>',refresh_menu_button:'<div class="refresh_menu_button {extra}"></div>',date_range:'<div class="date_range"><span class="dates">{dates}</span><span class="edit_date_range {read_only}">'+'Edit</span></div>',date_range_overlay_contents:'<table><tr><td class="today">{today}</td>'+'<td class="from_date">{from_date}</td><td class="to">to</td><td class="to_date">{to_date}</td>'+'<td class="input"><input type="button" class="update_date_range" value="Update"/></td></tr></table>',date_cell:'<div class="cell {cell_classes}" style="{cell_styles}" {cell_attributes}>'+'<div class="sg_cell_content">{cell_content}</div></div>',user_menu_button:'<div class="user_menu_button">'+'<div class="user_thumb">'+'<img class="invisible" src="{user_thumb}" '+'onload="sg_constrain_and_unhide_image(this)" on_error="sg_missing_user_thumb(this)"/></div>'+'<span class="menu_text">{menu_label}</span>'+'<div class="icon arrow_open_light"></div></div>',shortcuts_link:'<div class="keyboard_shortcuts_link"><span class="fake_link">Keyboard Shortcuts</span></div>',empty_page_banner:'<div class="empty_page_banner {extra_class}">{message}'+'<div class="close_empty_page_banner">x</div></div>',},init_widget:function(){this.current_sort=[{column:'firstname',direction:'asc'}];this.current_text_filter='';this.is_filtered_by_available=false;this.deselected_colors={};this.entity_type='Booking';this.page_project=this.context.get('page_project');if(this.page_project)
this.read_only=true;this.setup_keyboard_shortcuts();this.init_settings_from_url();},init_children:function(){},init_dates:function(){var now=new SG.Date();var low_date_str=this.get('low_date');var high_date_str=this.get('high_date');if(low_date_str==null){var temp=now.add(Date.DAY,-7);low_date_str=temp.data_store_format();this.set('low_date',low_date_str);}
if(high_date_str==null){var temp=now.add(Date.DAY,35);high_date_str=temp.data_store_format();this.set('high_date',high_date_str);}},on_first_render:function(){this.init_dates();this.container=this.get_container();var html=this.templates.main.apply({no_title_bar:this.read_only?'no_title_bar':'',header:this.render_dom_header(),left_pane:this.templates.left_pane.apply({canvas_height:10,canvas_width:10,toolbar_plus:this.read_only?'':this.templates.toolbar_plus.apply({disabled:SG.schema.can_create_entity('HumanUser')?'':'disabled',sg_tip:SG.schema.can_create_entity('HumanUser')?'Create a new Person':'',}),}),right_pane:this.templates.right_pane.apply({canvas_height:10,canvas_width:10})});this.container.update(html);this.calc_browser_scroll_bar_width();this.add_event(this.container,"click",this.on_click);this.add_event(this.container,"contextmenu",this.on_context_click);this.add_event(this.container,"change",this.on_change);var doc=Ext.get(document);this.add_event(doc,"keydown",this.on_keydown);this.add_event(doc,"keypress",this.on_keypress);this.add_event(SG.Checkbox,"change",this.on_checkbox_change);document.title="Crew Planning";this.left_pane=this.container.child('div.left_pane');this.right_pane=this.container.child('div.right_pane');if(!this.read_only)
this.add_event(this.right_pane,'dblclick',this.on_dbl_click_right_pane);this.add_event(this.left_pane,'dblclick',this.on_dbl_click_left_pane);this.add_event(this.left_pane,'mousemove',this.on_mouse_move_over_left_pane);this.scroll_wrapper=this.container.child('div.right_scroll_wrapper');this.add_event(this.scroll_wrapper,"scroll",this.on_scroll);this.left_scroll_container=this.container.child('div.left_scroll_container');this.add_event(this.left_scroll_container,"scroll",this.on_left_scroll);this.left_main_canvas=this.container.child('canvas.left_main');this.right_main_canvas=this.container.child('canvas.right_main');this.right_bg_canvas=this.container.child('canvas.right_background');this.right_drag_canvas=this.container.child('canvas.right_drag');this.left_main_ctx=this.left_main_canvas.dom.getContext("2d");this.right_main_ctx=this.right_main_canvas.dom.getContext("2d");this.right_bg_ctx=this.right_bg_canvas.dom.getContext("2d");this.right_drag_ctx=this.right_drag_canvas.dom.getContext("2d");this.all_left_ctx=[this.left_main_ctx];this.all_left_canvases=[this.left_main_canvas];this.all_right_ctx=[this.right_main_ctx,this.right_bg_ctx,this.right_drag_ctx];this.all_right_canvases=[this.right_main_canvas,this.right_bg_canvas,this.right_drag_canvas];this.all_ctx=this.all_left_ctx.concat(this.all_right_ctx);this.set_canvas_dimensions();this.left_view_port={l:0,r:this.left_canvas_width,t:0,b:this.left_canvas_height};this.right_view_port={l:0,r:this.right_canvas_width,t:0,b:this.right_canvas_height};Ext.EventManager.onWindowResize(this.on_window_resize,this);this.people_ds=this.new_data_set('HumanUser',this.on_load_people,this.on_people_ds_change);this.bookings_ds=this.new_data_set('Booking',this.on_load_bookings,this.on_bookings_ds_change);this.bookings_progressive_load_ds=this.new_data_set('Booking',this.on_load_bookings);this.canvas_field_renderer=new SG.util.CanvasFieldRenderer({entity_type:'HumanUser',fields:['name','image'],ctx:this.left_main_ctx,is_ff_3:false,missing_image_url:"/images/default_user_thumb.png"});if(this.read_only){this.drag_manager={dragging:false,render_new_booking:function(){},};this.selection_manager=new SG.ResourcePlanningAppSelectionManager({widget:this,scroll_container:this.scroll_wrapper,selection_disabled:true,drag_manager:this.drag_manager});}else{this.selection_manager=new SG.ResourcePlanningAppSelectionManager({widget:this,scroll_container:this.scroll_wrapper,});this.drag_manager=new SG.ResourcePlanningAppDragHandler({container:this.container.child('div.right_pane'),scroll_container:this.scroll_wrapper,widget:this,selection_manager:this.selection_manager});this.selection_manager.drag_manager=this.drag_manager;}
this.people_areas=[];this.booking_areas=[];this.background_areas=[];this.set_bounds();this.fetch_people();if(!this.read_only){this.show_app_welcome_overlay();}},show_app_welcome_overlay:function(menu,menuitem){var app_welcome_overlay=new SG.AppWelcomeOverlay({app_name:'crew_planning_app',app_version:'0.1',app_display_name:'Crew Planning',force_display:menuitem&&menuitem.force_display?true:false});},show_timescale_menu:function(anchor_elem){if(this.timescale_menu&&this.timescale_menu.is_showing()){this.timescale_menu.hide();return;}
if(!this.timescale_menu){this.timescale_menu=new SG.Menu({before_show:{fn:this.on_before_show_timescale_menu,scope:this},item_selected:{fn:this.on_timescale_select,scope:this},});}
this.timescale_menu.position={dom_elem:anchor_elem.dom,elem_anchor:"br",menu_anchor:"tr"}
this.timescale_menu.render();this.timescale_menu.show();},on_before_show_timescale_menu:function(){var major_unit=this.get('major_unit');var items=[{html:'Week & Day',major_unit:'week',checked:major_unit=='week'},{html:'Month & Day',major_unit:'month',checked:major_unit=='month'},{html:'Month & Week',major_unit:'month_weeks',checked:major_unit=='month_weeks'},{html:'Quarter & Month',major_unit:'quarter',checked:major_unit=='quarter'},{html:'Year & Quarter',major_unit:'year',checked:major_unit=='year'},];this.timescale_menu.items=items;this.timescale_menu.render();},on_timescale_select:function(menu,item){var gw=this;setTimeout(function(){gw.set_major_unit(item.major_unit);},0);},set_major_unit:function(value){var old_value=this.get('major_unit');if(value==old_value)return;this.set('major_unit',value);this.date_range_selection_for_sort=null;this.set_bounds();this.generate_all_areas();this.render_widget();},on_left_scroll:function(){if(this.scroll_wrapper.dom.scrollTop!=this.left_scroll_container.dom.scrollTop){this.scroll_wrapper.dom.scrollTop=this.left_scroll_container.dom.scrollTop;}},on_scroll:function(){var t=this.scroll_wrapper.dom.scrollTop;var l=this.scroll_wrapper.dom.scrollLeft;this.left_view_port={l:0,r:this.left_canvas_width,t:t,b:t+this.left_canvas_height};this.right_view_port={l:l,r:l+this.right_canvas_width,t:t,b:t+this.right_canvas_height};if(this.scroll_wrapper.dom.scrollTop!=this.left_scroll_container.dom.scrollTop){this.left_scroll_container.dom.scrollTop=this.scroll_wrapper.dom.scrollTop;}
this.render_widget();},render_dom_header:function(){return this.templates.header.apply({title_bar:this.render_title_bar(),toolbar_contents:this.render_toolbar_contents()});},render_title_bar:function(){if(this.read_only)return'';return this.templates.title_bar.apply({checkbox:SG.Checkbox.render(this.widget_id+'_available_cb',null,this.is_filtered_by_available),user_menu:this.render_user_menu_button(),text_filter:this.render_text_filter(),});},render_user_menu_button:function(){return this.templates.user_menu_button.apply({sg_tip:SG.globals.current_user.display_name,menu_label:SG.globals.current_user.display_name,user_thumb:SG.globals.current_user.thumb_url,});},render_toolbar_contents:function(){return this.templates.toolbar_contents.apply({sort:this.render_sort_menu_controls(),today:'',date_range:this.render_date_range_menu(),text_filter:this.read_only?this.render_text_filter():'',color_menu:this.read_only?'':this.render_color_menu_button(),refresh:this.templates.refresh_menu_button.apply({extra:this.read_only?'right':''}),gear_menu:this.read_only?'':this.templates.gear_menu_button.apply({}),app_launcher:this.read_only?this.templates.app_launcher.apply():'',shortcuts:this.read_only?'':this.templates.shortcuts_link.apply({})});},render_text_filter:function(){return this.templates.text_filter.apply({filter_value:this.current_text_filter,show_clear:this.current_text_filter&&this.current_text_filter!=''?'show_clear':'',});},re_render_toolbar:function(){var toolbar_div=this.container.child('div.toolbar');toolbar_div.update(this.render_toolbar_contents());},render_date_range_menu:function(){var low=new SG.Date(this.get('low_date'));var high=new SG.Date(this.get('high_date'));var low_year=low.format('Y');var high_year=high.format('Y');var date_str;if(low_year==high_year){date_str=low.format('M')+' '+low.format('j')+' - '+high.format('M')+' '+high.format('j')+', '+low_year;}else{date_str=low.format('M')+' '+low.format('j')+' '+low_year+' - '+high.format('M')+' '+
high.format('j')+' '+high_year;}
return this.templates.date_range.apply({dates:date_str,read_only:this.read_only?'read_only':''});},render_sort_menu_controls:function(){return this.templates.sort_menu_control.apply({sort_description:this.current_sort_label(),sort_direction:this.current_sort[0].direction});},render_color_menu_button:function(){var label='Color by '+(this.get('color_by')=='project'?'Project':'Dept.');return this.templates.color_menu_button.apply({now_coloring:label});},render_widget:function(do_not_clear_drag_canvas){var ctx,i;for(i=0;i<this.all_left_ctx.length;i++){ctx=this.all_left_ctx[i];ctx.clearRect(0,0,this.left_canvas_width,this.left_canvas_height);ctx.save();ctx.translate(-this.left_view_port.l,-this.left_view_port.t);}
for(i=0;i<this.all_right_ctx.length;i++){ctx=this.all_right_ctx[i];if(do_not_clear_drag_canvas&&ctx==this.right_drag_ctx)continue;ctx.clearRect(0,0,this.right_canvas_width,this.right_canvas_height);ctx.save();ctx.translate(-this.right_view_port.l,-this.right_view_port.t);}
var high=this.time_bounds.high.add(Date.DAY,1);var width=this.calc_time_distance_in_pixels(this.time_bounds.low,high);var height=(this.people_ds.count()*40)+this.header_height;this.render_background_drop_shadow(width,height);for(i=0;i<this.all_right_ctx.length;i++){ctx=this.all_right_ctx[i];ctx.beginPath();ctx.rect(0,0,width,height);ctx.clip();}
this.render_background();this.render_people();this.render_bookings();this.render_header();for(i=0;i<this.all_ctx.length;i++)
this.all_ctx[i].restore();},re_render_widget:function(do_not_clear_drag_canvas){var no_clear=do_not_clear_drag_canvas;var me=this;setTimeout(function(){me.render_widget(no_clear);},0);},render_people:function(){this.render_areas(this.people_areas,true);},render_bookings:function(){this.right_main_ctx.save();this.set_header_clip_for_canvas(this.right_main_ctx,this.header_height);this.render_areas(this.booking_areas);if(this.not_yet_loaded_areas)
this.render_areas(this.not_yet_loaded_areas);if(this.load_message)
this.render_areas([this.load_message]);this.right_main_ctx.restore();},render_areas:function(areas,is_left_canvas){var view_port=is_left_canvas?this.left_view_port:this.right_view_port;for(var i=0;i<areas.length;i++){area=areas[i];if(area.t>view_port.b)continue;if(area.b<view_port.t)continue;if(!is_left_canvas&&area.l>view_port.r)continue;if(!is_left_canvas&&area.r<view_port.l)continue;area.render_fn.call(this,area);}},render_background_drop_shadow:function(width,height){this.right_bg_ctx.shadowOffsetX=2.5;this.right_bg_ctx.shadowOffsetY=0;this.right_bg_ctx.shadowBlur=2;this.right_bg_ctx.shadowColor="rgba(120, 120, 120, 0.5)";this.right_bg_ctx.fillStyle='rgb(255,255,255)';this.right_bg_ctx.fillRect(0,0,width,height);this.right_bg_ctx.shadowOffsetX=0.0;this.right_bg_ctx.shadowOffsetY=0.0;this.right_bg_ctx.shadowBlur=0.0;this.right_bg_ctx.shadowColor="rgba(0, 0, 0, 1.0)";},render_background:function(){this.right_bg_ctx.save();this.set_header_clip_for_canvas(this.right_bg_ctx,this.header_height);this.right_bg_ctx.fillStyle='white';this.right_bg_ctx.fillRect(this.right_view_port.l,this.right_view_port.t,this.right_view_port.l+this.right_canvas_width,this.right_view_port.t+this.right_canvas_height);this.render_background_user_lines();for(var i=0;i<this.background_areas.length;i++){var area=this.background_areas[i];area.render_fn.call(this,area);}
this.right_bg_ctx.restore();},render_background_user_lines:function(){this.right_bg_ctx.strokeStyle='rgb(240,240,240)';var y=this.header_height+0.5;for(var i=0;i<this.people_ds.count();i++){y+=40;this.right_bg_ctx.beginPath();this.right_bg_ctx.moveTo(this.right_view_port.l,y);this.right_bg_ctx.lineTo(this.right_view_port.r,y);this.right_bg_ctx.stroke();}},destroy_widget:function(){Ext.EventManager.removeResizeListener(this.on_window_resize,this);},calc_browser_scroll_bar_width:function(){var scr=null;var inn=null;var wNoScroll=0;var wScroll=0;scr=document.createElement('div');scr.style.position='absolute';scr.style.top='100px';scr.style.left='100px';scr.style.width='200px';scr.style.height='150px';inn=document.createElement('div');inn.style.width='100&#37;';inn.style.height='200px';scr.appendChild(inn);document.body.appendChild(scr);scr.style.overflow='hidden';wNoScroll=inn.offsetWidth;scr.style.overflow='scroll';wScroll=inn.offsetWidth;if(wNoScroll==wScroll)wScroll=scr.clientWidth;document.body.removeChild(document.body.lastChild);this.browser_scroll_bar_width=(wNoScroll-wScroll);},set_canvas_dimensions:function(){var i;this.left_canvas_width=240;this.left_canvas_height=this.right_pane.getHeight();this.right_canvas_height=this.get_right_canvas_height();this.right_canvas_width=this.get_right_canvas_width();for(i=0;i<this.all_left_canvases.length;i++){var canvas=this.all_left_canvases[i];canvas.dom.setAttribute('width',this.left_canvas_width);canvas.dom.setAttribute('height',this.left_canvas_height);}
for(i=0;i<this.all_right_canvases.length;i++){var canvas=this.all_right_canvases[i];canvas.dom.setAttribute('width',this.right_canvas_width);canvas.dom.setAttribute('height',this.right_canvas_height);}},get_right_canvas_height:function(){var h=this.right_pane.getHeight();if(this.scroll_wrapper.dom.scrollWidth>this.scroll_wrapper.dom.clientWidth)
h-=this.browser_scroll_bar_width;return h;},get_right_canvas_width:function(){var w=this.right_pane.getWidth();if(this.scroll_wrapper.dom.scrollHeight>this.scroll_wrapper.dom.clientHeight)
w-=this.browser_scroll_bar_width;return w;},on_window_resize:function(){var left_scroll_container=this.container.child('div.left_scroll_container');left_scroll_container.setHeight(this.left_pane.getHeight());this.set_canvas_dimensions();this.render_widget();},generate_all_areas:function(bookings_ds,people_to_render_index_range){bookings_ds=bookings_ds||this.bookings_ds;this.area_id_count=0;var i;var bookings_map={};for(i=0;i<bookings_ds.count();i++){var booking_rec=bookings_ds.get_record(i);var assigned_to=booking_rec.get('user');if(!assigned_to)continue;if(!bookings_map[assigned_to.id]){bookings_map[assigned_to.id]=[booking_rec];}else{bookings_map[assigned_to.id].push(booking_rec);}}
if(bookings_ds==this.bookings_ds){this.people_areas=[];this.booking_areas=[];}
var y=this.header_height;for(i=0;i<this.people_ds.count();i++){if(people_to_render_index_range&&(i<people_to_render_index_range[0]||i>people_to_render_index_range[1]))
{y+=40;continue;}
var person_rec=this.people_ds.get_record(i);if(bookings_ds==this.bookings_ds)
this.generate_person_area(person_rec,y);var bookings_array=bookings_map[person_rec.id];if(bookings_array){this.stack_bookings(bookings_array,person_rec.id);for(var j=0;j<bookings_array.length;j++){var booking_rec=bookings_array[j];this.generate_booking_area(booking_rec,y);}}
y+=40;}
if(bookings_ds==this.bookings_ds)
this.generate_background_areas();},visible_person_index_range:function(){var view_port=this.left_view_port;var low_index=view_port.t/40;var high_index=(view_port.b/40)+1;return[Math.floor(low_index),Math.floor(high_index)];},stack_bookings:function(booking_recs,user_id){var i,j;var a_rec,b_rec,a_end,b_end,a_start,b_start;for(i=0;i<booking_recs.length;i++){a_rec=booking_recs[i];a_rec.upstream_overlaps=0;a_rec.downstream_overlaps=0;a_start=new SG.Date(a_rec.get('start_date'));a_end=new SG.Date(a_rec.get('end_date'));for(j=0;j<booking_recs.length;j++){if(i==j)continue;b_rec=booking_recs[j];b_start=new SG.Date(b_rec.get('start_date'));b_end=new SG.Date(b_rec.get('end_date'));if(a_end.getTime()<b_start.getTime()||b_end.getTime()<a_start.getTime())continue;if(i<j){a_rec.downstream_overlaps=a_rec.downstream_overlaps+1;}else{a_rec.upstream_overlaps=a_rec.upstream_overlaps+1;}}}},generate_booking_area:function(rec,y){var height=30;var offset=0;var total=0;if(rec.upstream_overlaps!=undefined&&rec.downstream_overlaps!=undefined)
total=rec.upstream_overlaps+rec.downstream_overlaps+1;if(total!=0){height=Math.floor(30/total)+4;offset=height*rec.upstream_overlaps;if(offset>0)
offset-=4;}
var start_str=rec.get('start_date');var end_str=rec.get('end_date');var start_date=new SG.Date(start_str);var end_date=new SG.Date(end_str);end_date=end_date.add(Date.DAY,1);var x=this.calc_time_distance_in_pixels(this.time_bounds.low,start_date);var w=this.calc_time_distance_in_pixels(start_date,end_date);this.booking_areas.push({id:this.gen_area_id(),l:x,r:x+w,t:y+offset,b:y+offset+height,record:rec,render_fn:this.render_booking_fn,type:'booking',selected:this.selection_manager.is_booking_selected(rec.id),});},generate_person_area:function(rec,y){this.people_areas.push({id:this.gen_area_id(),l:0,r:this.left_canvas_width,t:y,b:y+40,record:rec,render_fn:this.render_person_fn,type:'person',selected:this.selection_manager.is_person_selected(rec.id)});},on_load_people:function(ds){if(ds.count()==0){this.show_empty_page_banner(true);this.bookings_ds.load([]);return;}else{this.hide_empty_page_banner();}
this.fetch_bookings();},fetch_bookings:function(){var user_ids=[];var visible_range=this.visible_person_index_range();var before_visible=[];var after_visible=[];var id;for(var i=0;i<this.people_ds.count();i++){id=this.people_ds.get_record(i).id;if(i<visible_range[0]){before_visible.push(id);}else if(i>visible_range[1]){after_visible.push(id);}else{user_ids.push(id);}}
var spec=this.create_bookings_load_request(user_ids,this.bookings_ds);this.pending_bookings_load_request_info={request_id:spec.request_id,not_yet_loaded:{before_visible:null,after_visible:null},loading:user_ids}
if(before_visible.length>0)
this.pending_bookings_load_request_info.not_yet_loaded.before_visible=before_visible;if(after_visible.length>0)
this.pending_bookings_load_request_info.not_yet_loaded.after_visible=after_visible;SG.Repo.query(spec);},create_bookings_load_request:function(user_ids,ds){var users=[];for(var i=0;i<user_ids.length;i++){users.push({type:'HumanUser',id:user_ids[i]});}
var user_cond={path:'user',relation:'in',values:users};var filters={logical_operator:'and',conditions:[user_cond,],};if(!this.read_only){filters.conditions.push({path:'start_date',relation:'less_than_or_equal',values:[this.get('high_date')]});filters.conditions.push({path:'end_date',relation:'greater_than_or_equal',values:[this.get('low_date')]});}
return{type:'Booking',filters:filters,columns:['user','end_date','note','project','start_date','vacation'],sorts:[{column:'start_date',direction:'asc'}],result:ds,request_id:SG.Widget.ResourcePlanningApp.request_id++};},on_people_ds_change:function(changes){var value_successfully_updated=false;for(var i=0;i<changes.length;i++){if(changes[i].state=='server'&&changes[i].type=='update')
value_successfully_updated=true;}
if(!this.person_overlay&&value_successfully_updated){this.fetch_people();}},on_bookings_ds_change:function(changes){var real_change=false;for(var i=0;i<changes.length;i++){if(changes[i].state=='server'&&changes[i].type=='update')
real_change=true;else if(changes[i].type=='retire')
real_change=true;}
if(real_change){this.reset_booking_display();}},on_load_bookings:function(ds,request_id){var pending_request_info=this.pending_bookings_load_request_info;if(pending_request_info.request_id>request_id){return;}
if(ds==this.bookings_progressive_load_ds&&ds.records.length>0){var insert_before=(this.bookings_ds.records.length>0&&this.bookings_ds.records[0].id>this.bookings_progressive_load_ds.records[0].id);if(insert_before){for(var i=this.bookings_progressive_load_ds.records.length-1;i>=0;i--){this.bookings_ds.prepend_record(this.bookings_progressive_load_ds.records[i]);}}else{for(var i=0;i<this.bookings_progressive_load_ds.records.length;i++){this.bookings_ds.append_record(this.bookings_progressive_load_ds.records[i]);}}}
this.not_yet_loaded_areas=[];var not_yet_loaded_segments=[];var width=this.calc_time_distance_in_pixels(new SG.Date(this.get('low_date')),new SG.Date(this.get('high_date')));if(pending_request_info.not_yet_loaded.before_visible){this.not_yet_loaded_areas.push(this.generate_loading_overlay_area(pending_request_info.not_yet_loaded.before_visible,width));}
if(pending_request_info.not_yet_loaded.after_visible){this.not_yet_loaded_areas.push(this.generate_loading_overlay_area(pending_request_info.not_yet_loaded.after_visible,width));}
if(ds==this.bookings_ds){this.reset_booking_display();if(ds.count()==0)
this.show_empty_page_banner();else
this.hide_empty_page_banner();}else{this.reset_booking_display(ds,pending_request_info.loading);}
if(pending_request_info.not_yet_loaded.before_visible||pending_request_info.not_yet_loaded.after_visible){if(pending_request_info.request_id>request_id){return;}
var new_not_yet_loaded=sg_deep_copy(pending_request_info.not_yet_loaded);var max_to_load=50;var to_load,not_loaded;var before_distance=new_not_yet_loaded.before_visible?this.find_distance_from_visible_window(new_not_yet_loaded.before_visible):1000000;var after_distance=new_not_yet_loaded.after_visible?this.find_distance_from_visible_window(new_not_yet_loaded.after_visible):1000000;if(before_distance<=0||before_distance<after_distance){if(before_distance.length<=max_to_load){to_load=new_not_yet_loaded.before_visible;new_not_yet_loaded.before_visible=null;}else{to_load=new_not_yet_loaded.before_visible.splice(new_not_yet_loaded.before_visible.length-max_to_load,max_to_load);if(new_not_yet_loaded.before_visible.length==0)
new_not_yet_loaded.before_visible=null;}}else{if(after_distance.length<=max_to_load){to_load=new_not_yet_loaded.after_visible;new_not_yet_loaded.after_visible=null;}else{to_load=new_not_yet_loaded.after_visible.splice(0,max_to_load);if(new_not_yet_loaded.after_visible.length==0)
new_not_yet_loaded.after_visible=null;}}
var spec=this.create_bookings_load_request(to_load,this.bookings_progressive_load_ds);this.bookings_progressive_load_ds.records=[];this.bookings_progressive_load_ds.id_map={};pending_request_info.request_id=spec.request_id;pending_request_info.not_yet_loaded=new_not_yet_loaded;pending_request_info.loading=to_load;SG.Repo.query(spec);}},generate_loading_overlay_area:function(ids,width){var index1,index2,y1,y2;index1=this.people_ds.get_index(this.people_ds.get_record_by_id(ids[0]));index2=this.people_ds.get_index(this.people_ds.get_record_by_id(ids[ids.length-1]));y1=this.header_height+index1*40;y2=this.header_height+index2*40+40;return{id:'not_yet_loaded_'+ids[0],l:0,r:width,t:y1,b:y2,render_fn:this.render_not_yet_loaded,type:'not_yet_loaded'};},find_distance_from_visible_window:function(user_ids){index1=this.people_ds.get_index(this.people_ds.get_record_by_id(user_ids[0]));index2=this.people_ds.get_index(this.people_ds.get_record_by_id(user_ids[user_ids.length-1]));return SG.Widget.ResourcePlanningApp.find_interval_distance([index1,index2],this.visible_person_index_range());},reset_booking_display:function(bookings_ds,user_ids){this.hide_loading_overlay();if(this.read_only)
this.set_high_low_dates_from_bookings();this.set_bounds();if(bookings_ds){var index1=this.people_ds.get_index(this.people_ds.get_record_by_id(user_ids[0]));var index2=this.people_ds.get_index(this.people_ds.get_record_by_id(user_ids[user_ids.length-1]));this.generate_all_areas(bookings_ds,[index1,index2]);}else{this.generate_all_areas();}
if(bookings_ds!=this.bookings_ds)
this.render_widget(true);else
this.render_widget();if(this.read_only){this.re_render_toolbar();this.set_app_launcher_url();}},set_app_launcher_url:function(){var anchor=this.container.child('a.app_launcher');var url='/page/crew_planning_app#';url+='project_id='+this.page_project.id+'&';url+='low_date='+this.get('low_date')+'&';url+='high_date='+this.get('high_date')+'&';url+='color_by='+this.get('color_by')+'&';url+='major_unit='+this.get('major_unit')+'&';url+='sort_column='+this.current_sort[0].column+'&';url+='sort_direction='+this.current_sort[0].direction+'&';anchor.dom.setAttribute('href',url);},set_high_low_dates_from_bookings:function(){var low_date=null;var high_date=null;for(var i=0;i<this.bookings_ds.count();i++){var rec=this.bookings_ds.get_record(i);var start_date=new SG.Date(rec.get('start_date'));var end_date=new SG.Date(rec.get('end_date'));if(!low_date)low_date=start_date;if(!high_date)high_date=end_date;if(start_date.getTime()<low_date.getTime())low_date=start_date;if(end_date.getTime()>high_date.getTime())high_date=end_date;}
if(!low_date||!high_date)return;low_date=low_date.add(Date.DAY,-7);high_date=high_date.add(Date.DAY,7);this.set('low_date',low_date.data_store_format());this.set('high_date',high_date.data_store_format());},set_bounds:function(){this.major_unit=this.get('major_unit');this.day_length=this.length_of_a_day_in_pixels[this.major_unit];var low_date=new SG.Date(this.get('low_date'));var high_date=new SG.Date(this.get('high_date'));var x=this.calc_time_distance_in_pixels(low_date,high_date);var y=100;if(this.people_ds.is_loaded()){y=(this.people_ds.count()+1)*40;var paging=this.people_ds.get_paging_info();if(paging.page_count>1){y+=15;this.load_message={id:'load_message',l:0,r:x,t:y-23,b:y,render_fn:this.render_load_message,type:'load_message',label:"Showing "+paging.records_per_page+" of "+paging.record_count+" People."}}else{this.load_message=null;}}
this.time_bounds={low:low_date,high:high_date};var right_scroll_container=this.container.child('div.right_scroll_container');right_scroll_container.setWidth(x);right_scroll_container.setHeight(y);this.left_scroll_container=this.container.child('div.left_scroll_container');this.left_scroll_container.setHeight(this.left_pane.getHeight());var left_fake_content=this.container.child('div.left_fake_content');left_fake_content.setHeight(y);if(y>this.right_pane.getHeight()){if(!this.right_pane.hasClass('vert_scrollbar'))
this.right_pane.addClass('vert_scrollbar');}else{if(this.right_pane.hasClass('vert_scrollbar'))
this.right_pane.removeClass('vert_scrollbar');}},fetch_people:function(){this.hide_booking_overlay();this.show_loading_overlay();var filters={logical_operator:'and',conditions:[]};var text_filters=this.get_crud_filters_for_text_filter();if(text_filters)
filters.conditions.push(text_filters);if(this.is_filtered_by_available){var available_filter={path:'id',relation:'has_unbooked_days',values:[this.get('low_date'),this.get('high_date')]};filters={logical_operator:"or",conditions:[filters,available_filter]}}
var filters_with_project=null;if(this.page_project){var proj_filter={path:'projects',relation:'is',values:[this.page_project]};filters_with_project={logical_operator:'and',conditions:[proj_filter,filters]};}
var spec={type:'HumanUser',filters:filters_with_project?filters_with_project:filters,columns:['name','image','department','department.Department.color','department.Department.code'],sorts:this.get_people_sorts(),current_page:1,records_per_page:500,result:this.people_ds};SG.Repo.query(spec);},render_load_message:function(area){this.right_main_ctx.fillStyle="rgb(250,250,200)";this.right_main_ctx.fillRect(this.right_view_port.l+0.5,area.t+0.5,this.right_view_port.r-this.right_view_port.l,area.b-area.t);this.right_main_ctx.fillStyle="rgb(0,0,0)";this.right_main_ctx.fillText(area.label,this.right_view_port.l+50,((area.t+area.b)/2)+3);},render_not_yet_loaded:function(area){var margin=5;this.right_main_ctx.fillStyle="rgb(230,230,230)";this.right_main_ctx.fillRect(margin+this.right_view_port.l+0.5,margin+area.t+0.5,this.right_view_port.r-this.right_view_port.l-margin-margin,area.b-area.t-margin-margin);},render_person_fn:function(area){this.left_main_ctx.fillStyle=area.selected?'rgb(208,227,255)':'rgb(246,246,246)';this.left_main_ctx.fillRect(area.l,area.t,240,40);var image=area.record.get('image');var src='';if(image==null){src='/images/default_user_thumb.png';}else{src='/thumbnail/image/'+image;}
this.canvas_field_renderer.render_image(src,area.l,area.t,39);this.left_main_ctx.font='12px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.left_main_ctx.fillStyle="black";this.left_main_ctx.textAlign='left';var str=this.truncate_string(this.left_main_ctx,area.record.get('name'),150);this.left_main_ctx.fillText(str,area.l+50.5,area.t+24.5);var department_code=area.record.get('department.Department.code');if(department_code){if(department_code.length>5)
department_code=department_code.substring(0,5);var department_color=area.record.get('department.Department.color');if(!department_color){department_color='0,0,0';}
this.left_main_ctx.shadowOffsetX=0.5;this.left_main_ctx.shadowOffsetY=0.5;this.left_main_ctx.shadowBlur=.5;this.left_main_ctx.shadowColor="rgba(0, 0, 0, 0.5)";this.left_main_ctx.font='bold 11px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.left_main_ctx.textAlign='right';this.left_main_ctx.fillStyle='rgb('+department_color+')';this.left_main_ctx.fillText(department_code,area.l+230.5,area.t+24.5);this.left_main_ctx.shadowOffsetX=0.0;this.left_main_ctx.shadowOffsetY=0.0;this.left_main_ctx.shadowBlur=0.0;this.left_main_ctx.shadowColor="rgba(0, 0, 0, 1.0)";}
this.left_main_ctx.strokeStyle=area.selected?'rgb(230,246,255)':'rgb(255,255,255)';this.left_main_ctx.beginPath();this.left_main_ctx.moveTo(area.l,area.t+1);this.left_main_ctx.lineTo(area.l+240,area.t+1);this.left_main_ctx.stroke();this.left_main_ctx.strokeStyle='rgb(220,220,220)';this.left_main_ctx.beginPath();this.left_main_ctx.moveTo(area.l,area.t+40);this.left_main_ctx.lineTo(area.l+240,area.t+40);this.left_main_ctx.stroke();},deselected_color:function(color){var deselected=this.deselected_colors[color];if(deselected)
return deselected;var components=color.split(',');var comp,total=0;for(var i=0;i<3;i++){components[i]=Number(components[i]);total+=components[i];}
var target_gray;if(total>500)
target_gray=Math.floor((total/3.0)*0.85);else{var mean=total/3.0;target_gray=Math.floor(mean+0.7*(255-mean));}
for(var i=0;i<3;i++){components[i]=Math.floor(components[i]+0.3*(target_gray-components[i]));}
deselected=components.join(',');this.deselected_colors[color]=deselected;return deselected;},render_booking_fn:function(area){if(area.dragging){this.right_main_ctx.shadowOffsetX=2.5;this.right_main_ctx.shadowOffsetY=2.5;this.right_main_ctx.shadowBlur=2;this.right_main_ctx.shadowColor="rgba(0, 0, 0, 0.5)";}else if(area.record&&area.record.upstream_overlaps!=undefined&&area.record.upstream_overlaps>0){this.right_main_ctx.lineWidth=1.0;this.right_main_ctx.strokeStyle="white";this.right_main_ctx.strokeRect(area.l-0.5,area.t-0.5,area.r-area.l+2,area.b-area.t+2);}
var rgb_string=this.__get_rgb_color_for_area(area);var rgb_linear=this.rgb_to_linear_color(rgb_string);var fill_color=this.get_booking_fill_color(rgb_linear,area);this.right_main_ctx.fillStyle=this.generate_fill_gradient(this.right_main_ctx,area,fill_color);this.right_main_ctx.fillRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);this.right_main_ctx.shadowOffsetX=0.0;this.right_main_ctx.shadowOffsetY=0.0;this.right_main_ctx.shadowBlur=0.0;this.right_main_ctx.shadowColor="rgba(0, 0, 0, 1.0)";this.right_main_ctx.strokeStyle=this.get_booking_outline_color(fill_color,area);if(area.selected){this.right_main_ctx.lineWidth=3.0;this.right_main_ctx.strokeRect(area.l+1.5,area.t+1.5,area.r-area.l-2,area.b-area.t-2);}else{this.right_main_ctx.lineWidth=1.0;this.right_main_ctx.strokeRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);}
this.render_booking_text(area,fill_color);},generate_fill_gradient:function(ctx,area,linear_color){var m=area.selected?.79:.83;var e=area.selected?.61:.68;var grad=ctx.createLinearGradient(0,area.t,0,area.b);var mid={r:linear_color.r*m,g:linear_color.g*m,b:linear_color.b*m};var end={r:linear_color.r*e,g:linear_color.g*e,b:linear_color.b*e};grad.addColorStop(0,this.linear_color_to_rgb(linear_color));grad.addColorStop(0.5,this.linear_color_to_rgb(mid));grad.addColorStop(1,this.linear_color_to_rgb(end));return grad;},render_booking_text:function(area,fill_color){var h_pad=6;var v_pad=2;var font_size='12px';var italic='italic ';var label='No Project';if(area.record.get('vacation')){label='Vacation';}else{var project=area.record.get('project');if(project&&project.name){label=project.name;italic='';}}
var bld=area.selected?'bold ':'';this.right_main_ctx.font=bld+font_size+italic+'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.right_main_ctx.fillStyle=this.get_booking_text_color(fill_color,area);var w=area.r-area.l-(2*h_pad)
var str=this.truncate_string(this.right_main_ctx,label,w);this.right_main_ctx.fillText(str,area.l+h_pad,((area.t+area.b)/2)+v_pad);var mt=this.right_main_ctx.measureText(str);var note_text=area.record.get('note');if(!note_text||note_text=='')return;if(w-mt.width-h_pad>0){this.right_main_ctx.fillStyle=this.__get_booking_note_text_color(fill_color,area);this.right_main_ctx.font=font_size+'"Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';max_width=w-mt.width-h_pad;var l=area.l+mt.width+(2*h_pad);str=this.truncate_string(this.right_main_ctx,note_text,max_width);this.right_main_ctx.fillText(str,l,((area.t+area.b)/2)+v_pad);}},truncate_string:function(ctx,str,max_width){var width=ctx.measureText(str).width;var ellipsis='…';var ellipsis_width=ctx.measureText(ellipsis).width;if(width<=max_width||width<=ellipsis_width){return str;}else{var len=str.length-1;while(width>=(max_width-ellipsis_width)&&len>0){str=str.substring(0,len);width=ctx.measureText(str).width;len--;}
if(str=='')
return'';else
return str+ellipsis;}},render_pending_booking_fn:function(area){var ctx=this.right_main_ctx;ctx.fillStyle="rgb(196,226,249)";ctx.fillRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);ctx.strokeStyle="rgb(0,0,0)";ctx.strokeRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);var project=area.record.get('project');if(project&&project.name){var w=area.r-area.l;ctx.font='12px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';ctx.fillStyle="black";var mt=ctx.measureText(project.name);if(mt.width<w){var pad=Math.floor((w-mt.width)/2);ctx.fillText(project.name,area.l+pad,((area.t+area.b)/2)+2);}}},render_marker_fn:function(area){this.right_bg_ctx.fillStyle="rgb(210,210,210)";this.right_bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},render_weekend_bars_fn:function(area)
{this.right_bg_ctx.fillStyle="rgba(210,210,210,0.5)";this.right_bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},calc_time_distance_in_pixels:function(from,to){var days=Math.floor((to.getTime()-from.getTime())/(1000*24*60*60));return days*this.day_length;},get_date_at_pixel:function(x)
{var days=Math.floor(x/this.day_length);var ret=this.time_bounds.low.add(Date.DAY,days);return ret;},render_header:function()
{this.right_main_ctx.translate(this.right_view_port.l,this.right_view_port.t);var l=this.right_view_port.l-this.day_length;var r=this.right_view_port.r+this.day_length;var l_days=Math.floor(l/this.day_length);var r_days=Math.floor(r/this.day_length);var low=this.time_bounds.low.add(Date.DAY,l_days);var high=this.time_bounds.low.add(Date.DAY,r_days);var i;var grad=[255,252,252,249,247,256,242,241,238,236,233,231,227,226,222];for(i=0;i<grad.length;i++)
{this.right_main_ctx.strokeStyle='rgb('+grad[i]+','+grad[i]+','+grad[i]+')';this.right_main_ctx.beginPath();this.right_main_ctx.moveTo(0,i+2);this.right_main_ctx.lineTo(this.right_canvas_width,i+2);this.right_main_ctx.stroke();}
this.right_main_ctx.strokeStyle='rgb(144,144,144)';var lines=[0.5,this.major_unit_height-0.5,this.header_height-0.5];for(var i=0;i<lines.length;i++)
{this.right_main_ctx.beginPath();this.right_main_ctx.moveTo(0,lines[i]);this.right_main_ctx.lineTo(this.right_canvas_width,lines[i]);this.right_main_ctx.stroke();}
this.right_main_ctx.fillStyle='rgb(0,0,0)';this.right_main_ctx.font='11px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.right_main_ctx.textAlign='center';if(this.major_unit=='week')
{this.render_header_row(low,high,'week','major',this.get_next_date_week,this.get_label_week_long,70);this.render_header_row(low,high,'day','minor',this.get_next_date_day,this.get_label_day,0);}
else if(this.major_unit=='month')
{this.render_header_row(low,high,'month','major',this.get_next_date_month,function(cur_date){return cur_date.format('F Y');},200);this.render_header_row(low,high,'day','minor',this.get_next_date_day,this.get_label_day,0);}
else if(this.major_unit=='month_weeks')
{this.render_header_row(low,high,'month','major',this.get_next_date_month,function(cur_date){return cur_date.format('M y');},50);this.render_header_row(low,high,'week','minor',this.get_next_date_week,function(cur_date){return cur_date.format('d');},16);}
else if(this.major_unit=='quarter')
{this.render_header_row(low,high,'quarter','major',this.get_next_date_quarter,this.get_label_quarter,70);this.render_header_row(low,high,'month','minor',this.get_next_date_month,function(cur_date){return cur_date.format('M');},50);}
else
{this.render_header_row(low,high,'year','major',this.get_next_date_year,function(cur_date){return cur_date.format('Y');},70);this.render_header_row(low,high,'quarter','minor',this.get_next_date_quarter,this.get_label_quarter_short,70);}},render_header_row:function(low,high,units,rank,next_date_fn,label_fn,min_label_width){var cur_date=low.clone();var end_date=high.clone();if(this.date_range_selection_for_sort&&this.date_range_selection_for_sort.units==units){var subfiltered_date=this.date_range_selection_for_sort.date;}
var x=this.calc_time_distance_in_pixels(this.time_bounds.low,low)-this.right_view_port.l;var text_y=(rank=='major')?12:29;var line_y1=(rank=='major')?0:this.major_unit_height;var line_y2=(rank=='major')?this.major_unit_height-1:this.header_height;var fill_top=(rank=='major')?1:this.major_unit_height;var fill_depth=(rank=='major')?this.major_unit_height-2:this.header_height-this.major_unit_height-1;var w,new_end_date;while(cur_date.getTime()<end_date.getTime()){new_end_date=next_date_fn.call(this,cur_date);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);if(subfiltered_date&&subfiltered_date.getTime()>=cur_date.getTime()&&subfiltered_date.getTime()<new_end_date.getTime())
{this.right_main_ctx.fillStyle=this.header_selected_fill;this.right_main_ctx.fillRect(x+1,fill_top,w-1,fill_depth);subfiltered_date=null;}
if(w>min_label_width){this.write_heading_text(this.right_main_ctx,label_fn.call(this,cur_date,new_end_date),x+Math.floor(w/2),text_y);}
x+=w;this.right_main_ctx.beginPath();this.right_main_ctx.moveTo(x+0.5,line_y1);this.right_main_ctx.lineTo(x+0.5,line_y2);this.right_main_ctx.stroke();cur_date=new_end_date;}},write_heading_text:function(ctx,str,x,y){this.right_main_ctx.fillStyle=this.text_fill;if(this.is_ff_3){ctx.save();ctx.mozTextStyle='11px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';var x_off=Math.floor(ctx.mozMeasureText(str)/2);ctx.translate(x-x_off,y);ctx.mozDrawText(str);ctx.restore();}
else
ctx.fillText(str,x,y);},get_next_date_day:function(cur_date){return cur_date.add(Date.DAY,1);},get_next_date_week:function(cur_date){var offset=cur_date.get_day_of_the_week();return cur_date.add(Date.DAY,(7-offset)+1);},get_next_date_month:function(cur_date){var end_year=parseInt(cur_date.format('Y'));var end_month=parseInt(cur_date.format('n'))+1;if(end_month==13)
{end_month=1;end_year+=1;}
return new SG.Date(end_year+'-'+this.pad2(end_month)+'-01');},get_next_date_quarter:function(cur_date){var date=cur_date.add(Date.DAY,1-cur_date.get_day());var month_remainder=date.get_month()-(3*Math.floor(date.get_month()/3));date=date.add(Date.MONTH,3-month_remainder);return date;},get_next_date_year:function(cur_date){return new SG.Date((cur_date.get_year()+1)+'-01-01');},get_label_day:function(cur_date){return cur_date.format('j');},get_label_week_long:function(cur_date,next_date){return cur_date.format('j/M')+' - '+next_date.add(Date.DAY,-1).format('j/M');},get_label_quarter:function(cur_date){var quarter=Math.floor(cur_date.get_month()/3)+1;return'Qtr '+quarter+'/'+cur_date.format('Y');},get_label_quarter_short:function(cur_date){var quarter=Math.floor(cur_date.get_month()/3)+1;return'Qtr '+quarter;},set_header_clip_for_canvas:function(ctx,header_height){ctx.beginPath();ctx.rect(this.right_view_port.l,this.right_view_port.t+header_height,this.right_canvas_width,this.right_canvas_height-header_height);ctx.clip();},generate_background_areas:function(){this.background_areas=[];if(this.major_unit=='week'||this.major_unit=='month')
this.generate_weekend_background_areas();if(this.major_unit=='month_weeks')
this.generate_month_weeks_background_areas();else if(this.major_unit=='quarter')
this.generate_quarter_background_areas();else if(this.major_unit=='year')
this.generate_year_background_areas();this.generate_today_background_area();},generate_today_background_area:function(){var now=new SG.Date();var l=this.calc_time_distance_in_pixels(this.time_bounds.low,now);var h=this.calc_full_size_area_height();this.background_areas.push({id:this.gen_area_id(),l:l,r:l+this.day_length,t:0,b:h,render_fn:this.render_today_fn,});},render_today_fn:function(area){this.right_bg_ctx.fillStyle="rgba(195,219,255,0.5)";this.right_bg_ctx.fillRect(area.l,area.t,area.r-area.l,area.b-area.t);},generate_weekend_background_areas:function(){var scroll_height=this.calc_full_size_area_height();var x=0;var end_of_week=6;var end_date=this.time_bounds.high.clone();var cur_date=this.time_bounds.low.clone();while(cur_date.getTime()<end_date.getTime())
{var day_of_week=cur_date.format('w');while(day_of_week!=end_of_week){cur_date=cur_date.add(Date.DAY,1);day_of_week=cur_date.format('w');}
x=this.calc_time_distance_in_pixels(this.time_bounds.low,cur_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+(2*this.day_length),t:0,b:scroll_height,render_fn:this.render_weekend_bars_fn,type:'bg_marker'});cur_date=cur_date.add(Date.DAY,7);}},generate_month_weeks_background_areas:function(){var scroll_height=this.calc_full_size_area_height();var x=0;var end_date=this.time_bounds.high.clone();var cur_date=this.time_bounds.low.clone();while(cur_date.getTime()<end_date.getTime())
{var day_of_week=cur_date.format('w');var offset=7;if(day_of_week!=1)
{if(day_of_week==0)
offset=1;else
offset=7-(day_of_week-1);}
new_end_date=cur_date.add(Date.DAY,offset);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:0,b:scroll_height,render_fn:this.render_marker_fn,type:'marker',});x+=w;cur_date=new_end_date;}},generate_quarter_background_areas:function(){var scroll_height=this.calc_full_size_area_height();var x=0;var cls='';var new_end_date;var month_of_year=0;var cur_date=this.time_bounds.low.clone();var end_date=this.time_bounds.high.clone();while(cur_date.getTime()<end_date.getTime())
{new_end_date=cur_date.add(Date.MONTH,1);if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:0,b:scroll_height,render_fn:this.render_marker_fn,type:'marker'});x+=w;cur_date=new_end_date;}},calc_full_size_area_height:function(){if(!this.people_ds.is_loaded())return 10;return(this.people_ds.count()+1)*40;},generate_year_background_areas:function()
{var scroll_height=this.calc_full_size_area_height();var x=0;var month_of_year;var cur_date=this.time_bounds.low.clone();var end_date=this.time_bounds.high.clone();while(cur_date.getTime()<end_date.getTime())
{month_of_year=cur_date.format('n');if(month_of_year<4)
new_end_date=new SG.Date(cur_date.format('Y')+'-04-01');else if(month_of_year<7)
new_end_date=new SG.Date(cur_date.format('Y')+'-07-01');else if(month_of_year<10)
new_end_date=new SG.Date(cur_date.format('Y')+'-10-01');else
{var next_year=Number(cur_date.format('Y'))+1;new_end_date=new SG.Date(next_year+'-01-01');}
if(new_end_date.getTime()>end_date.getTime())
new_end_date=end_date.clone();w=this.calc_time_distance_in_pixels(cur_date,new_end_date);this.background_areas.push({id:this.gen_area_id(),l:x,r:x+1,t:34,b:scroll_height,render_fn:this.render_marker_fn,type:'marker'});x+=w;cur_date=new_end_date;}},pad2:function(num){if(num<10)
return'0'+num;else
return num;},on_dbl_click_left_pane:function(e){var area=this.find_people_area(e);if(area){e.stopEvent();this.show_person_overlay(area);}},on_dbl_click_right_pane:function(e){this.hide_context_menu();if(this.booking_overlay)
this.booking_overlay.destroy();var area=this.find_booking_area(e);if(area){var cfg={mode:'edit',data_set:this.bookings_ds,source_record:area.record,booking_area:area,booking_created_callback:{fn:this.on_booking_changed,scope:this},overlay_canceled_callback:{fn:this.on_booking_overlay_canceled,scope:this}};this.show_booking_overlay(cfg);}else{var record=new SG.Data.Record('Booking');this.prime_record_with_cookie_project(record);var ee={xy:[40,e.xy[1]]};var user_area=this.find_people_area(ee);var coords=this.to_area_coordinates(e);record.set('user',{type:user_area.record.type,id:user_area.record.id,name:user_area.record.get('name')});var days=Math.floor(coords.x/this.day_length);var users=Math.floor((coords.y-this.header_height)/40);var start_date=this.time_bounds.low.add(Date.DAY,days);var end_date=this.time_bounds.low.add(Date.DAY,days);record.set('start_date',start_date.data_store_format());record.set('end_date',end_date.data_store_format());var new_area={l:days*this.day_length,r:(days+1)*this.day_length,t:(users*40)+this.header_height,b:((users+1)*40)+this.header_height-10,record:record,};this.drag_manager.render_new_booking(new_area);var cfg={mode:'new',source_record:new_area.record,booking_area:new_area,booking_created_callback:{fn:this.on_booking_changed,scope:this},overlay_canceled_callback:{fn:this.on_booking_overlay_canceled,scope:this}};this.show_booking_overlay(cfg);}},on_booking_overlay_canceled:function(){this.render_widget();},on_booking_changed:function(){this.show_loading_overlay();this.fetch_bookings();},on_click:function(e){this.hide_context_menu();if(this.drag_manager.dragging)return;var t=Ext.get(e.getTarget());var overlay=t.findParent('div.sgc_booking_overlay',this.container.dom);if(overlay)return;var elem=t.findParent('div.sort_menu_control',this.container.dom);if(elem){this.toggle_sort_menu(elem);return;}
var elem=t.findParent('div.user_menu_button',this.container.dom);if(elem){this.toggle_user_menu(elem);return;}
var elem=t.findParent('div.text_filter_clear',this.container.dom);if(elem){var text_filter_input=this.container.child('input.text_filter');text_filter_input.dom.value='';this.current_text_filter='';this.set_clear_text_filter_visibility();this.selection_manager.clear_selection();this.fetch_people();return;}
var timescale_menu=t.findParent('div.timescale_menu',this.container.dom,true);if(timescale_menu){this.show_timescale_menu(timescale_menu);return;}
var edit_dates=t.findParent('span.edit_date_range',this.container.dom,true);if(edit_dates){var me=this;setTimeout(function(){me.show_date_range_editor(edit_dates);});return;}
var update_date_range=t.findParent('input.update_date_range',this.container.dom);if(update_date_range){var rec=this.date_range_data_set.get_record(0);this.update_date_range(rec.get('start_date'),rec.get('end_date'));return;}
elem=t.findParent('div.sort_menu_direction',this.container.dom,true);if(elem){if(elem.hasClass('asc')){this.set_sort_direction('desc');}else{this.set_sort_direction('asc');}
return;}
elem=t.findParent('div.color_menu_button',this.container.dom);if(elem){this.toggle_color_menu(elem);return;}
elem=t.findParent('div.gear_menu_button',this.container.dom);if(elem){this.toggle_gear_menu(elem);return;}
elem=t.findParent('div.refresh_menu_button',this.container.dom);if(elem){this.fetch_people();return;}
elem=t.findParent('div.right_scroll_wrapper',this.container.dom);if(elem){if(e.browserEvent.layerY<this.header_height){var date_clicked=this.get_date_at_pixel(this.to_area_coordinates(e).x);this.units_clicked(date_clicked,(e.browserEvent.layerY<this.major_unit_height)?'major':'minor');}
return;}
elem=t.findParent('div.toolbar_plus_person',this.container.dom,true);if(elem&&!elem.hasClass('disabled')){this.create_new_person();return;}
elem=t.findParent('div.keyboard_shortcuts_link',this.container.dom);if(elem){this.show_keyboard_shortcuts_help();return;}
var fake_input=t.findParent('div.fake_input',this.container.dom);if(!fake_input)
fake_input=t.findParent('div.grid_editor',this.container.dom);if(fake_input){return;}
elem=t.findParent('div.close_empty_page_banner',this.container.dom);if(elem){this.hide_empty_page_banner();return;}
if(!t.dom.hasAttribute('date_editor')){elem=t.findParent('div.date_range_overlay');if(!elem){this.hide_date_range_overlay();}}},update_date_range:function(start_date,end_date){this.set('low_date',start_date);this.set('high_date',end_date);this.set('date_range','custom');this.date_range_selection_for_sort=null;this.set_bounds();this.generate_all_areas();this.hide_date_range_overlay();this.render_widget();this.re_render_toolbar();this.fetch_people();},on_context_click:function(e){var t=Ext.get(e.getTarget());var overlay=t.findParent('div.sgc_booking_overlay',this.container.dom);if(overlay)return;if(t.findParent('canvas.left_main',this.container.dom)){var user_area=this.find_people_area(e);if(user_area){e.stopEvent();if(this.selection_manager.get_selected_person_ids().indexOf(user_area.record.get_id())==-1){this.selection_manager.on_click(e);}
this.last_context_clicked_area=user_area;this.show_context_menu(t.dom,[e.browserEvent.clientX,e.browserEvent.clientY],'user');}
return;}
if(t.findParent('div.right_scroll_wrapper',this.container.dom)){var booking_area=this.find_booking_area(e);if(booking_area){e.stopEvent();if(this.selection_manager.get_selected_booking_ids().indexOf(booking_area.record.get_id())==-1){this.selection_manager.on_click(e);}
this.show_context_menu(t.dom,[e.browserEvent.clientX,e.browserEvent.clientY],'booking');}
return;}},show_context_menu:function(dom_elem,xy,area_type){if(!this.context_menu){this.context_menu=this.new_component(SG.Menu,{});}
if(area_type=='user'){this.context_menu.items=[{html:'Edit Selected People',disabled:this.selection_manager.get_selected_person_ids().length==0,item_selected:{fn:this.edit_selected_people,scope:this}},{html:'Create Bookings for Selected People',disabled:this.selection_manager.get_selected_person_ids().length==0,item_selected:{fn:this.create_bookings_for_selected_users,scope:this}}];}else if(area_type=='booking'){this.context_menu.items=[{html:'Edit Selected Bookings',disabled:this.selection_manager.get_selected_booking_ids().length==0,item_selected:{fn:this.edit_selected_bookings,scope:this}},{html:'Delete Selected Bookings',disabled:this.selection_manager.get_selected_booking_ids().length==0,item_selected:{fn:this.delete_selected_bookings,scope:this}}];}
this.context_menu.position={xy:xy};this.context_menu.render();this.context_menu.show();},create_bookings_for_selected_users:function(){if(this.booking_overlay)
this.booking_overlay.destroy();var cfg={mode:'new_multi',user_ids:this.selection_manager.get_selected_person_ids(),booking_area:this.last_context_clicked_area,booking_created_callback:{fn:this.on_booking_changed,scope:this},overlay_canceled_callback:{fn:this.on_booking_overlay_canceled,scope:this}};this.show_booking_overlay(cfg);},hide_context_menu:function(){if(this.context_menu){this.context_menu.hide();}},edit_selected_people:function(){var config={data_set:this.people_ds,fields:['firstname','lastname','sg_status','projects','department'],selected_entity_ids:this.selection_manager.get_selected_person_ids(),projects:this.context_projects()};var esd=new SG.EditSelectedDialog(config);},edit_selected_bookings:function(){var config={data_set:this.bookings_ds,fields:['user','start_date','end_date','note'],selected_entity_ids:this.selection_manager.get_selected_booking_ids(),projects:this.context_projects()};var esd=new SG.EditSelectedDialog(config);},delete_selected_bookings:function(){var selected_ids=this.selection_manager.get_selected_booking_ids();for(var i=0;i<selected_ids.length;i++){this.bookings_ds.get_record_by_id(selected_ids[i]).retire();}
this.bookings_ds.commit();},create_new_person:function(){var factory=new SG.EntityFactory({entity_type:'HumanUser',data_record:this.people_ds.new_record()});this.add_event(factory,"done",this.display_new_person_form);factory.create();},display_new_person_form:function(data_record){var nef_config={entity_type:data_record.type,source_record:data_record,allow_keep_form_open:true,all_projects:SG.schema.projects};var nef=sg_new_entity_dialog(nef_config);this.add_event(nef,"entity_created",this.on_new_person_created);},on_new_person_created:function(new_entities){this.fetch_people();},hide_date_range_overlay:function(){var date_range_overlay=this.container.child('div.date_range_overlay');if(!date_range_overlay.hasClass('hidden'))
date_range_overlay.addClass('hidden');},toggle_sort_menu:function(dom_elem){if(this.sort_menu&&this.sort_menu.is_showing()){this.sort_menu.hide();return;}
var items=[];if(SG.schema.get_field('HumanUser','firstname'))
items.push({html:this.sort_menu_item_display('firstname'),checked:(this.current_sort.length==1&&this.current_sort[0].column=='firstname'),value:[{column:'firstname',direction:this.current_sort[0].direction}]});if(SG.schema.get_field('HumanUser','lastname'))
items.push({html:this.sort_menu_item_display('lastname'),checked:(this.current_sort.length==1&&this.current_sort[0].column=='lastname'),value:[{column:'lastname',direction:this.current_sort[0].direction}]});if(SG.schema.get_field('HumanUser','department'))
items.push({html:this.sort_menu_item_display('department'),checked:(this.current_sort.length==1&&this.current_sort[0].column=='department'),value:[{column:'department',direction:this.current_sort[0].direction}]});var sorting_menu_helper=new SG.util.SortingMenuHelper({entity_type:'HumanUser',no_advanced:true,get_sorts_callback:{fn:this.get_sorts_for_menu,scope:this},set_sorts_callback:{fn:this.set_sorts,scope:this}});var is_special=(this.current_sort[0].resource_planning_app||(this.current_sort.length==1&&['firstname','lastname','department'].indexOf(this.current_sort[0].column)>-1));items.push({html:"All Fields",checked:(this.current_sort.length==1&&!is_special),submenu:{items:sorting_menu_helper.get_menu_items()}});items.push({line:true});var avail_item={html:this.sort_menu_item_display('availability'),checked:(this.current_sort[0].resource_planning_app=='availability'),value:this.get_availability_sort()}
if(avail_item.html=='Availability')
avail_item.html='Availability during this time period';items.push(avail_item);items.push({line:true});items.push({html:'Advanced...',checked:(this.current_sort.length>1),item_selected:{fn:this.on_sort_advanced,scope:this}});this.sort_menu=new SG.Menu({items:items,item_selected:{fn:this.on_sort_menu_item_selected,scope:this},position:{dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'}});this.sort_menu.render();this.sort_menu.show();},get_sorts_for_menu:function(){if(this.current_sort[0].resource_planning_app=='availability'){return[];}else{return this.current_sort;}},set_sorts:function(sort_array){this.selection_manager.clear_selection();this.current_sort=sort_array;var dom=sg_find("span.current_sort",this.container.dom);dom.innerHTML=this.current_sort_label();this.fetch_people();},on_sort_menu_item_selected:function(menu,item){this.set_sorts(item.value);},sort_menu_item_display:function(field_name){if(field_name=='availability'){if(this.date_range_selection_for_sort){return'Availability '+this.date_range_selection_for_sort.range_display;}else{return'Availability';}}
return SG.schema.get_field_display_name('HumanUser',field_name);},on_sort_advanced:function(){var helper=new SG.util.EntityFieldsMenuHelper({entity_type:'HumanUser',no_steps:true,field_value_callback:{fn:function(sf,name){return name},scope:this},field_checked_callback:{fn:function(){return false},scope:this},field_disabled_callback:{fn:function(sf,name){return sf.no_sorting},scope:this}});var mcd=new SG.AdvancedSortingDialog({entity_type:'HumanUser',sorts:this.get_sorts_for_menu(),menu_items:helper.get_fields_menu_items(),column_display_name_fn:this.column_display_name_callback});mcd.on('dialog_submitted',this.set_sorts,this);},current_sort_label:function(){var sort_label='';if(this.current_sort[0].resource_planning_app){sort_label=this.sort_menu_item_display(this.current_sort[0].resource_planning_app)}else{var sort_columns=[];for(var i=0;i<this.current_sort.length;i++)
sort_columns.push(this.sort_menu_item_display(this.current_sort[i].column));sort_label=sort_columns.join('>');}
return sort_label;},get_availability_sort:function(){var range_start,range_end;if(this.date_range_selection_for_sort){range_start=this.date_range_selection_for_sort.range_start;range_end=this.date_range_selection_for_sort.range_end;}else{range_start=this.get('low_date');range_end=this.get('high_date');}
return[{column:"id",direction:this.current_sort[0].direction,operation:"unbooked_days",value:range_start+","+range_end,resource_planning_app:'availability'}];},get_people_sorts:function(path_prefix){var sorts=sg_deep_copy(this.current_sort);if(sorts[0].resource_planning_app=='availability'){var range_start,range_end;if(this.date_range_selection_for_sort){range_start=this.date_range_selection_for_sort.range_start;range_end=this.date_range_selection_for_sort.range_end;}else{range_start=this.get('low_date');range_end=this.get('high_date');}
sorts[0].value=range_start+","+range_end;sorts[0].direction=sorts[0].direction=='asc'?'desc':'asc';}
if(sorts.length==1){if(sorts[0].column=='firstname')
sorts[0].column='name';else if(sorts[0].column!='name')
sorts.push({column:'name',direction:sorts[0].direction});}
if(path_prefix){for(var i=0;i<sorts.length;i++){sorts[i].column=path_prefix+sorts[i].column;}}
return sorts;},set_sort_direction:function(direction){this.selection_manager.clear_selection();for(var i=0;i<this.current_sort.length;i++){this.current_sort[i].direction=direction;}
this.re_render_toolbar();this.fetch_people();},toggle_user_menu:function(dom_elem){if(this.user_menu&&this.user_menu.is_showing()){this.user_menu.hide();return;}
if(!this.user_menu){var items=[];items.push({html:'Account Settings',item_selected:{fn:this.show_user_account_settings,scope:this}});items.push({line:true});items.push({html:'Sign Out',item_selected:{fn:this.user_logout,scope:this}});this.user_menu=new SG.Menu({items:items});this.user_menu.render();}
this.user_menu.position={dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'};this.user_menu.show();},show_user_account_settings:function(){var usd=new SG.UserSettingsDialog();},user_logout:function(){this.show_loading_overlay();window.location='/user/logout';},toggle_color_menu:function(dom_elem){if(this.color_menu&&this.color_menu.is_showing()){this.color_menu.hide();return;}
this.color_menu=new SG.Menu({items:[{html:"Department",checked:(this.get('color_by')=='department'),value:'department'},{html:"Project",checked:(this.get('color_by')=='project'),value:'project'}],item_selected:{fn:this.on_color_menu_item_selected,scope:this},position:{dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'}});this.color_menu.render();this.color_menu.show();},on_color_menu_item_selected:function(menu,item){if(this.get('color_by')!=item.value){this.set('color_by',item.value);this.render();this.re_render_toolbar();}},toggle_gear_menu:function(dom_elem){if(this.gear_menu&&this.gear_menu.is_showing()){this.gear_menu.hide();return;}
this.gear_menu=new SG.Menu({items:[{html:"Manage Departments...",value:'departments'},{html:"Manage Projects...",value:'projects'},{line:true},{html:"Export...",value:'export'},{html:"Import...",value:'import'},{line:true},{html:'About Crew Planning',force_display:true,item_selected:{fn:this.show_app_welcome_overlay,scope:this}},{html:'Documentation and Help...',value:'docs_link'},],item_selected:{fn:this.on_gear_menu_item_selected,scope:this},position:{dom_elem:dom_elem,elem_anchor:'bl',menu_anchor:'tl'}});this.gear_menu.render();this.gear_menu.show();},on_gear_menu_item_selected:function(menu,item){if(item.value=='export'){this.export_bookings();return;}
if(item.value=='import'){this.import_bookings();return;}
if(item.value=='docs_link'){window.open('https://support.shotgunsoftware.com/entries/21655662','_blank');return;}
if(item.value=='projects'){this.get_page().get_focus_window().open({title:'Manage Projects',entity_type:'Project',extra_columns:['name','color'],filters:{logical_operator:'and',conditions:[]},callback:{fn:this.on_project_management_window_closed,scope:this}});return;}
if(item.value=='departments'){this.get_page().get_focus_window().open({title:'Manage Departments',entity_type:'Department',extra_columns:['name','code','color','users'],filters:{logical_operator:'and',conditions:[]},callback:{fn:this.on_department_management_window_closed,scope:this}});return;}
alert("Not implemented yet.");},on_project_management_window_closed:function(){this.show_loading_overlay();SG.schema.reload_schema({fn:function(){this.render();this.hide_loading_overlay();},scope:this});},on_department_management_window_closed:function(){this.fetch_people();},on_keydown:function(e){var t=e.target;if(t.nodeName=='INPUT'&&t.className=='update_date_range'&&e.getKey()==e.TAB){e.stopEvent();if(is_shift_click(e)){this.focus_date_range_last_field();}else{this.focus_date_range_first_field();}
return;}
if(t.className=='text_filter'){if(e.getKey()===e.ESC){e.stopEvent();if(t.value!=this.current_text_filter){t.value=this.current_text_filter;return;}
var me=this;setTimeout(function(){t.blur();},100);return;}}
if(document.activeElement&&(document.activeElement.tagName=='TEXTAREA'||(document.activeElement.tagName=='INPUT'&&document.activeElement.getAttribute('type')!='button'))){return;}
if(e.getKey()==Ext.EventObject.BACKSPACE||e.getKey()==Ext.EventObject.DELETE){e.stopEvent();var me=this;setTimeout(function(){if(confirm('Delete selected bookings?'))
me.delete_selected_bookings();},0);return;}
if(SG.KeyboardShortcutsDialog.handle_shortcuts(e,this.keyboard_shortcuts))
return;},on_keypress:function(e){if(SG.KeyboardShortcutsDialog.handle_shortcuts(e,this.keyboard_shortcuts))
return;},show_keyboard_shortcuts_help:function(){var dialog=new SG.KeyboardShortcutsDialog({title:'Crew Planning Keyboard Shortcuts',shortcuts:this.keyboard_shortcuts,width:'650px',height:'390px'});},setup_keyboard_shortcuts:function(){this.keyboard_shortcuts=[{description:"Find",key_code:70,ctrl:false,alt:false,shift:false,callback:{fn:function(){this.hide_all_overlays();var text_filter_input=this.container.child('input.text_filter');text_filter_input.dom.focus();text_filter_input.dom.select();},scope:this}},{description:"Add new booking",key_code:66,ctrl:false,alt:false,shift:false,callback:{fn:function(){this.hide_all_overlays();if(this.selection_manager.get_selected_person_ids().length>0){var sel_ids=this.selection_manager.get_selected_person_ids();var last_user_id=sel_ids[sel_ids.length-1];for(var i=0;i<this.people_areas.length;i++){var person_area=this.people_areas[i];if(last_user_id==person_area.record.id){this.last_context_clicked_area=person_area;break;}}
this.create_bookings_for_selected_users();return;}
var record=new SG.Data.Record('Booking');var start_date=this.time_bounds.low.add(Date.DAY,1);var end_date=this.time_bounds.low.add(Date.DAY,2);record.set('start_date',start_date.data_store_format());record.set('end_date',end_date.data_store_format());this.prime_record_with_cookie_project(record);var cfg={mode:'new',source_record:record,booking_area:null,booking_created_callback:{fn:this.on_booking_changed,scope:this},overlay_canceled_callback:{fn:this.on_booking_overlay_canceled,scope:this},no_callout:true};this.show_booking_overlay(cfg);},scope:this}},{description:"Create a new Person",key_code:80,ctrl:false,alt:false,shift:false,callback:{fn:function(){this.hide_all_overlays();this.create_new_person();},scope:this}},{description:"Open the Sort menu",key_code:83,ctrl:false,alt:false,shift:false,callback:{fn:function(){this.hide_all_overlays();var elem=this.container.child('div.sort_menu_control');if(elem)
this.toggle_sort_menu(elem);},scope:this}},{description:"Help (brings up this overlay)",key_code:63,ctrl:false,alt:false,shift:true,callback:{fn:function(){this.show_keyboard_shortcuts_help();},scope:this}},{description:"Shift view to today, plus 2 weeks before and after",key_code:84,ctrl:false,alt:false,shift:false,callback:{fn:function(){var now=new SG.Date();this.update_date_range(now.add(Date.DAY,-14).data_store_format(),now.add(Date.DAY,14).data_store_format());},scope:this}},{description:"Open date range editor",key_code:68,ctrl:false,alt:false,shift:false,callback:{fn:function(){this.hide_all_overlays();var elem=this.container.child('span.edit_date_range');if(elem)
this.show_date_range_editor(elem);},scope:this}},{key_code:27,ctrl:false,alt:false,shift:false,callback:{fn:this.hide_all_overlays,scope:this}},];},on_change:function(e){var t=e.target;if(t.className=='text_filter'){this.current_text_filter=t.value;this.set_clear_text_filter_visibility();this.selection_manager.clear_selection();this.fetch_people();}},set_clear_text_filter_visibility:function(){var text_filter_div=this.container.child('div.text_filter');if(!this.current_text_filter||this.current_text_filter==''){if(text_filter_div.hasClass('show_clear'))
text_filter_div.removeClass('show_clear');}else{if(!text_filter_div.hasClass('show_clear'))
text_filter_div.addClass('show_clear');}},get_crud_filters_for_text_filter:function(){if(!this.current_text_filter||this.current_text_filter=='')
return null;var search_string_clean=this.current_text_filter.replace(/^\s+|\s+$/g,'');if(search_string_clean==='')
return null;var words=search_string_clean.split(' ');var user_conditions=[];var booking_conditions=[];for(var i=0;i<words.length;i++)
{var word=words[i];if(word.length==0)
continue;var booking_subquery={base_path:'bookings',subquery:{type:'Booking',filters:{logical_operator:'or',conditions:[{active:true,path:'note',relation:'contains',values:[word]},{active:true,path:'project',relation:'name_contains',values:[word]}]}}}
if('vacation'.indexOf(word)>-1){booking_subquery.subquery.filters.conditions.push({path:'vacation',relation:'is',values:[true]});}
user_conditions.push({logical_operator:'or',conditions:[{active:true,path:'name',relation:'contains',values:[word]},{active:true,path:'department',relation:'name_contains',values:[word]},{active:true,path:'department.Department.code',relation:'contains',values:[word]},booking_subquery]});}
return{conditions:user_conditions,logical_operator:'and'};},on_checkbox_change:function(checkbox){if(checkbox.id==this.widget_id+'_available_cb'){if(SG.Checkbox.get_state(checkbox)=='checked')
this.is_filtered_by_available=true;else
this.is_filtered_by_available=false;this.fetch_people();}},units_clicked:function(selected_date,magnitude){var units=(magnitude=='major')?this.major_unit:'day';if(magnitude=='major'&&this.major_unit=='month_weeks')
units='month';if(magnitude=='minor'){switch(this.major_unit){case'month_weeks':units='week';break;case'quarter':units='month';break;case'year':units='quarter';break;}}
var date=selected_date.clone();var start,end,range_display;switch(units){case'day':start=date.data_store_format();end=start;range_display=date.format('M j');break;case'week':date=date.add(Date.DAY,-date.get_day_of_the_week());start=date.data_store_format();range_display='w/o '+date.format('M j');date=date.add(Date.DAY,6);end=date.data_store_format();break;case'month':date=date.add(Date.DAY,1-date.get_day());start=date.data_store_format();date=date.add(Date.MONTH,1);date=date.add(Date.DAY,-1);end=date.data_store_format();range_display=date.format('M Y');break;case'quarter':date=date.add(Date.DAY,1-date.get_day());var month_remainder=date.get_month()-(3*Math.floor(date.get_month()/3));date=date.add(Date.MONTH,-month_remainder);start=date.data_store_format();date=date.add(Date.MONTH,3);date=date.add(Date.DAY,-1);end=date.data_store_format();range_display='Q '+(Math.floor(date.get_month()/3)+1)+'/'+date.format('y');break;case'year':date=date.add(Date.DAY,1-date.get_day());date=date.add(Date.MONTH,-date.get_month());start=date.data_store_format();date=date.add(Date.MONTH,12);date=date.add(Date.DAY,-1);end=date.data_store_format();range_display=start.substring(0,4);break;}
if(this.date_range_selection_for_sort&&this.date_range_selection_for_sort.range_start==start&&this.date_range_selection_for_sort.range_end==end)
{this.date_range_selection_for_sort=null;}else{this.date_range_selection_for_sort={date:selected_date,units:units,range_start:start,range_end:end,range_display:range_display};this.current_sort=this.get_availability_sort();}
this.re_render_toolbar();this.render_widget();this.fetch_people();},show_date_range_editor:function(elem){if(!this.date_range_data_set){this.date_range_data_set=this.new_data_set('Booking');}else{this.date_range_data_set.records=[];}
var record=this.date_range_data_set.new_record();if(!this.cell_manager){var cell_config={container:this.container,data_set:this.date_range_data_set,projects:this.context_projects(),in_form:true,force_editable:true,use_single_record_navigation:true,get_fields_callback:{fn:function(){return['start_date','end_date']},scope:this},before_first_cell:{fn:this.focus_date_range_create_button,scope:this},after_last_cell:{fn:this.focus_date_range_create_button,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);}
record.set('start_date',this.get('low_date'));record.set('end_date',this.get('high_date'));record.make_like_new();var start_cell=this.cell_manager.get_cell('start_date');start_cell.override_editable=true;var config=start_cell.render(record);var from_date=this.templates.date_cell.apply(config);var end_cell=this.cell_manager.get_cell('end_date');end_cell.override_editable=true;config=end_cell.render(record);var to_date=this.templates.date_cell.apply(config);var overlay_contents=this.templates.date_range_overlay_contents.apply({from_date:from_date,to_date:to_date});var date_range_overlay=sg_find('div.date_range_overlay',this.container.dom);date_range_overlay.innerHTML=overlay_contents;Ext.get(date_range_overlay).removeClass('hidden');this.focus_date_range_first_field();},focus_date_range_first_field:function(){var date_range_overlay=sg_find('div.date_range_overlay',this.container.dom);var rec=this.date_range_data_set.get_record(0);var start_cell=this.cell_manager.get_cell('start_date');setTimeout(function(){var cell_elem=sg_find('.sg_cell[field="start_date"]',date_range_overlay);if(cell_elem){start_cell.edit_cell({cell_elem:Ext.get(cell_elem),record:rec});}});},focus_date_range_last_field:function(){var date_range_overlay=sg_find('div.date_range_overlay',this.container.dom);var rec=this.date_range_data_set.get_record(0);var end_cell=this.cell_manager.get_cell('end_date');setTimeout(function(){var cell_elem=sg_find('.sg_cell[field="end_date"]',date_range_overlay);if(cell_elem){end_cell.edit_cell({cell_elem:Ext.get(cell_elem),record:rec});}});},focus_date_range_create_button:function(){var button=this.container.child('input.update_date_range');button.dom.focus();},export_bookings:function(){var booking_ids=[];for(var i=0;i<this.bookings_ds.count();i++){booking_ids.push(this.bookings_ds.get_record(i).id);}
var sorts=this.get_people_sorts('user.HumanUser.');sorts.push({column:'start_date',direction:'desc'});var spec={type:'Booking',filters:{logical_operator:'and',conditions:[{path:'id',relation:'in',values:booking_ids}]},columns:['user','start_date','end_date','project','vacation','note','updated_at','updated_by'],sorts:sorts};SG.Repo.query_csv(spec);},import_bookings:function(){new SG.Importer({entity_type:'Booking'});},reload_all_entities:function(){this.fetch_bookings();},to_area_coordinates:function(e,is_left_canvas){var l=is_left_canvas?this.left_view_port.l:this.right_view_port.l;var t=is_left_canvas?this.left_view_port.t:this.right_view_port.t;var canvas=is_left_canvas?this.left_main_canvas:this.right_main_canvas;var x=e.xy[0]-canvas.getLeft()+l;var y=e.xy[1]-canvas.getTop()+t;return{x:x,y:y};},from_area_coordinates:function(x,y,is_left_canvas){var l=is_left_canvas?this.left_view_port.l:this.right_view_port.l;var t=is_left_canvas?this.left_view_port.t:this.right_view_port.t;var canvas=is_left_canvas?this.left_main_canvas:this.right_main_canvas;var e={xy:[0,0]};e.xy[0]=canvas.getLeft()+x-l;e.xy[1]=canvas.getTop()+y-t;return e;},find_people_area:function(e){return this.find_area(e,this.people_areas,false,false,true);},find_booking_area:function(e,include_drag_handles){var areas=this.find_area(e,this.booking_areas,include_drag_handles,true,false);if(!areas)return areas;if(include_drag_handles)
return areas;var id=-1;var pick;for(var i=0;i<areas.length;i++){var area=areas[i];if(area.id>id){pick=area;id=area.id;}}
return pick;},find_area:function(e,areas,include_drag_handles,return_all_found_areas,is_left_canvas){if(!areas)return null;var coords=this.to_area_coordinates(e,is_left_canvas);var offset=include_drag_handles?10:0;var all_found_areas=[];for(var i=0;i<areas.length;i++)
{var area=areas[i];if(coords.x<area.l-offset)continue;if(coords.x>area.r+offset)continue;if(coords.y<area.t)continue;if(coords.y>area.b)continue;if(return_all_found_areas)
all_found_areas.push(area);else
return area;}
if(return_all_found_areas)
return all_found_areas;else
return null;},gen_area_id:function(){this.area_id_count++;return this.area_id_count;},hide_all_overlays:function(){this.hide_booking_overlay();this.hide_person_overlay();this.hide_date_range_overlay();},show_booking_overlay:function(cfg){this.hide_all_overlays();cfg.widget=this;var content_div=this.container.child('div.content');cfg.render_container=content_div;this.booking_overlay=new SG.BookingOverlay(cfg);},hide_booking_overlay:function(do_not_fire_canceled_callback){if(this.booking_overlay){if(!do_not_fire_canceled_callback)
this.booking_overlay.fire_overlay_canceled_callback();this.booking_overlay.destroy();this.booking_overlay=null;}},is_booking_overlay_visible:function(){return(this.booking_overlay!=null);},show_person_overlay:function(area){this.hide_all_overlays();var content_div=this.container.child('div.content');var cfg={render_container:content_div,widget:this,record:area.record,person_area:area,};this.person_overlay=new SG.PersonOverlay(cfg);},hide_person_overlay:function(){if(this.person_overlay){this.person_overlay.destroy();this.person_overlay=null;}},on_mouse_move_over_left_pane:function(e){var area=this.find_people_area(e);if(area){var coords=this.to_area_coordinates(e,true);if(coords.x<40){if(!this.left_pane.hasClass('thumb_hover'))
this.left_pane.addClass('thumb_hover')
return;}}
if(this.left_pane.hasClass('thumb_hover'))
this.left_pane.removeClass('thumb_hover');},init_settings_from_url:function(){var parts=window.location.hash.split('&');var settings={};for(var i=0;i<parts.length;i++){var split=parts[i].split('=');settings[split[0].replace('#','')]=split[1];}
if(settings['project_id']){var proj=SG.schema.project_by_id(Number(settings['project_id']));this.current_text_filter=proj.name}
if(settings['low_date'])
this.set('low_date',settings['low_date']);if(settings['high_date'])
this.set('high_date',settings['high_date']);if(settings['color_by'])
this.set('color_by',settings['color_by']);if(settings['major_unit'])
this.set('major_unit',settings['major_unit']);if(settings['sort_column']&&settings['sort_direction']){this.current_sort=[{column:settings['sort_column'],direction:settings['sort_direction']}];}},generate_color_test_areas:function(){var swatches=['255,255,255','234,234,234','213,213,213','192,192,192','171,171,171','150,150,150','129,129,129','108,108,108','87,87,87','66,66,66','45,45,45','24,24,24','0,41,59','2,17,74','19,0,46','47,1,50','62,1,19','99,0,0','94,0,0','83,33,0','77,44,1','84,83,3','54,71,1','1,49,1','0,62,87','1,26,108','27,0,69','71,0,76','90,0,28','148,0,0','136,0,2','125,48,2','117,66,0','123,118,0','81,104,0','0,74,0','0,92,131','0,39,166','47,0,106','107,1,112','135,0,43','222,0,0','204,0,1','179,76,7','172,98,0','184,178,4','123,154,1','1,110,1','0,126,174','1,54,218','59,0,140','139,1,149','180,1,59','253,1,0','254,2,0','248,100,2','232,134,0','245,238,0','162,207,0','25,118,27','2,149,216','0,59,251','85,1,177','183,0,188','226,1,71','254,0,0','254,41,0','253,141,3','252,183,0','249,254,1','182,241,1','1,187,0','0,194,255','0,110,252','109,0,249','238,1,253','254,0,98','252,13,45','255,87,16','246,155,12','253,188,0','255,253,28','203,243,23','29,215,46','2,211,252','50,149,253','156,1,255','253,2,253','252,47,140','253,94,99','254,131,89','255,181,76','253,205,68','253,252,100','213,247,98','103,226,102','0,230,254','129,183,255','192,97,253','254,92,255','254,125,179','254,151,152','254,173,146','254,205,138','255,218,137','253,254,152','231,251,154','161,236,154','152,242,251','188,218,252','222,182,255','253,175,251','254,191,218','253,203,204','253,214,199','254,230,196','252,239,195','251,253,204','239,251,203','202,237,197'];var c=0;for(var i=0;i<10;i++){var y=(i*40)+this.header_height;for(var j=0;j<12;j++){var l=j*4*this.day_length;var r=(j+1)*4*this.day_length;this.booking_areas.push({id:this.gen_area_id(),l:l,r:r-1,t:y,b:y+30,record:this.bookings_ds.get_record(0),render_fn:this.render_test_booking_fn,type:'booking',selected:false,color:swatches[c]});c+=1;}}},render_test_booking_fn:function(area){var rgb_color=this.rgb_to_linear_color(area.color);var fill_color=this.get_booking_fill_color(rgb_color,area);this.right_main_ctx.fillStyle=this.generate_fill_gradient(this.right_main_ctx,area,fill_color);this.right_main_ctx.fillRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);this.right_main_ctx.strokeStyle=this.get_booking_outline_color(fill_color,area);if(area.selected){this.right_main_ctx.lineWidth=2.0;this.right_main_ctx.strokeRect(area.l+1.0,area.t+1.0,area.r-area.l-1,area.b-area.t-1);}else{this.right_main_ctx.lineWidth=1.0;this.right_main_ctx.strokeRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);}
var bold=area.selected?'bold ':'';this.right_main_ctx.font=bold+'12px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';this.right_main_ctx.fillStyle=this.get_booking_text_color(fill_color,area);var h_pad=6;var v_pad=2;this.right_main_ctx.fillText('Booking',area.l+h_pad,((area.t+area.b)/2)+v_pad);},rgb_to_linear_color:function(rgb_string){var parts=rgb_string.split(',');var lin_col={r:Math.pow(Number(parts[0])/255.0,2.2),g:Math.pow(Number(parts[1])/255.0,2.2),b:Math.pow(Number(parts[2])/255.0,2.2),};return lin_col;},linear_color_to_rgb:function(lin_col){var p=1.0/2.2;var r=Math.floor(255.0*Math.pow(lin_col.r,p));var g=Math.floor(255.0*Math.pow(lin_col.g,p));var b=Math.floor(255.0*Math.pow(lin_col.b,p));return"rgb("+r+","+g+","+b+")";},luminance:function(lin_col){var lum=(0.2126*lin_col.r)+(0.7152*lin_col.g)+(0.0722*lin_col.b);return lum;},booking_colors:["103,155,222","255,159,93","255,105,219","245,98,102","0,217,79","162,118,215"],booking_colors_sel:["0,83,220","255,111,0","204,0,179","255,0,0","0,167,0","83,37,167","0,0,0","0,0,0"],__get_rgb_color_for_area:function(area){if(area.record.get('vacation')){if(area.selected)
return'200,200,200';else
return'225,225,225';}
if(this.read_only){var area_proj=area.record.get('project');if(!area_proj||this.page_project.id!=area_proj.id){return'255,255,255';}}
var color;if(area.record){if(this.get('color_by')=='department'){var user_rec=this.people_ds.get_record_by_id(area.record.get('user').id);var department=user_rec.get('department');if(department){var department_color=user_rec.get('department.Department.color');if(department_color){color=department_color;}else{color=this.booking_colors[department.id%this.booking_colors.length];}}else{color='220,220,220';}}else if(this.get('color_by')=='project'){var proj=area.record.get('project');if(proj){var schema_project=SG.schema.project_by_id(proj.id);if(schema_project&&schema_project.color){color=schema_project.color;}else{color=this.booking_colors[proj.id%this.booking_colors.length];}}else{color='220,220,220';}}}
return color;},get_booking_fill_color:function(rgb_color,area){if(area.selected){return rgb_color;}else{return{r:Math.pow(rgb_color.r,0.6),g:Math.pow(rgb_color.g,0.6),b:Math.pow(rgb_color.b,0.6),};}},get_booking_outline_color:function(fill_color,area){if(area.selected)
return"rgba(0,0,0,1)";var line_color=sg_deep_copy(fill_color);var mult=0.3;line_color.r*=mult;line_color.g*=mult;line_color.b*=mult;return this.linear_color_to_rgb(line_color);},get_booking_text_color:function(fill_color,area){var lum=this.luminance(fill_color);var rgba='';if(lum<0.5){rgba=area.selected?"rgba(255,255,255,1.0)":"rgba(255,255,255,0.7)";}else{rgba=area.selected?"rgba(0,0,0,1.0)":"rgba(0,0,0,0.5)";}
return rgba;},__get_booking_note_text_color:function(fill_color,area){var lum=this.luminance(fill_color);var rgba='';if(lum<0.5){rgba=area.selected?"rgba(225,225,225,1.0)":"rgba(225,225,225,0.7)";}else{rgba=area.selected?"rgba(51,51,51,1.0)":"rgba(51,51,51,0.5)";}
return rgba;},prime_record_with_cookie_project:function(record){var project=this.get_project_from_cookie();if(project===false){record.set('vacation',true);}else{record.set('vacation',false);record.set('project',project);}},get_project_from_cookie:function(){var cookie=getCookie(this.project_cookie_name());if(cookie){var project=Ext.decode(cookie);return project;}else{return SG.schema.projects[0];}},project_cookie_name:function(){return'sg_rp_last_project_'+SG.globals.current_user.id;},set_project_cookie:function(record){var project;if(record.get('vacation'))
project=false;else
project=record.get('project');setCookie(this.project_cookie_name(),Ext.encode(project),365);},show_empty_page_banner:function(user_banner){if(this.read_only)return;var empty_page_banner=sg_find('div.empty_page_banner',this.container.dom);if(empty_page_banner)return;var message="";if(user_banner)
message="No people match your search.";else
message="No bookings exist yet!  Click and drag to add one.";var toolbar_div=this.container.child('div.toolbar');Ext.DomHelper.append(toolbar_div,this.templates.empty_page_banner.apply({extra_class:user_banner?'no_users':'',message:message}));},hide_empty_page_banner:function(user_banner){var empty_page_banner=sg_find('div.empty_page_banner',this.container.dom);if(empty_page_banner){Ext.get(empty_page_banner).remove();}},});SG.Widget.ResourcePlanningApp.find_interval_distance=function(indexes,visible){var i1v0=indexes[1]-visible[0];var v1i0=visible[1]-indexes[0];if(i1v0<=0||v1i0<=0)
return(i1v0<=0)?-i1v0:-v1i0;var v1v0=visible[1]-visible[0];var i1i0=indexes[1]-indexes[0];return Math.max(-i1v0,-v1i0,-v1v0,-i1i0);};SG.Widget.ResourcePlanningApp.test_interval_distance=function(){var me=this;assert=function(test_label,expected,indexes,visible){if(me.find_interval_distance(indexes,visible)==expected)
puts(test_label+': ok');else{puts(test_label+': FAILED.  Expected '+expected+' but was '+
me.find_interval_distance(indexes,visible));}};assert(1.0,1,[1,2],[3,4]);assert(1.1,2,[1,2],[4,5]);assert(1.2,1,[5,6],[3,4]);assert(1.3,3,[6,7],[2,3]);assert(2.0,0,[2,3],[3,5]);assert(2.1,0,[5,9],[2,5]);assert(3.0,-3,[2,10],[4,7]);assert(3.1,-2,[7,9],[5,11]);assert(3.2,-4,[5,11],[7,11]);assert(3.3,-5,[5,10],[2,10]);assert(3.4,-3,[13,16],[13,20]);assert(3.4,-2,[13,20],[13,15]);assert(4.0,-3,[20,24],[21,25]);assert(4.1,-1,[20,22],[21,100]);assert(4.2,-5,[10,100],[5,15]);};SG.ResourcePlanningAppSelectionManager=function(config)
{Ext.apply(this,config);SG.ResourcePlanningAppSelectionManager.superclass.constructor.call(this,config);};Ext.extend(SG.ResourcePlanningAppSelectionManager,SG.Component,{init_component:function(){this.container=this.widget.container;this.add_event(this.container,'click',this.on_click);this.selected_people_ids=[];this.selected_booking_ids=[];var left_pane=this.container.child('div.left_pane');this.people_drag_selection=new SG.ResourcePlanningAppPeopleDragSelection({container:left_pane,widget:this.widget,selection_manager:this});},get_selected_person_ids:function(){return sg_deep_copy(this.selected_people_ids);},get_selected_booking_ids:function(){return sg_deep_copy(this.selected_booking_ids);},is_person_selected:function(person_id){return(this.selected_people_ids.indexOf(person_id)!=-1);},is_booking_selected:function(booking_id){return(this.selected_booking_ids.indexOf(booking_id)!=-1);},get_booking_selection_count:function(){return this.selected_booking_ids.length;},get_person_selection_count:function(){return this.selected_people_ids.length;},clear_selection:function(){this.selected_people_ids=[];this.selected_booking_ids=[];this.last_selected_area=null;var i;for(i=0;i<this.widget.people_areas.length;i++){var area=this.widget.people_areas[i];area.selected=false;}
for(i=0;i<this.widget.booking_areas.length;i++){var area=this.widget.booking_areas[i];area.selected=false;}},recalculate_user_selection:function(){this.selected_people_ids=[];var i;for(i=0;i<this.widget.people_areas.length;i++){var area=this.widget.people_areas[i];area.selected=false;}
for(i=0;i<this.widget.booking_areas.length;i++){var area=this.widget.booking_areas[i];if(!area.selected)continue;var user=area.record.get('user');var user_area=this.get_user_area(user.id);this.select_user(user_area,true);}},is_scroll_click:function(e){if(this.scroll_container.dom.scrollHeight>this.scroll_container.dom.clientHeight)
{var r=this.scroll_container.getRight();if(e.xy[0]+20>r)
return true;}
if(this.scroll_container.dom.scrollWidth>this.scroll_container.dom.clientWidth)
{var b=this.scroll_container.getBottom();if(e.xy[1]+20>b)
return true;}
return false;},is_elem_in_document:function(element){while(element=element.parentNode){if(element===document){return true;}}
return false;},on_click:function(e){var t=Ext.get(e.getTarget());var not_sel_target=t.findParent('.not_sel_target',100);if(not_sel_target)return;if(this.is_scroll_click(e))return;if(this.drag_manager.dragging)return;if(!this.is_elem_in_document(e.getTarget()))return;if(this.people_drag_selection.dragging)return;if(t.dom.nodeName=='INPUT')return;var grid_editor=t.findParent('.grid_editor',100);if(grid_editor)return;this.widget.hide_all_overlays();var left_canvas=t.findParent('div.left_pane',this.container.dom);if(left_canvas){var area=this.widget.find_people_area(e);if(area&&e.browserEvent.shiftKey&&this.last_selected_area){this.handle_shift_click_on_people(e,area);}else{this.on_canvas_click(e,area);var coords=this.widget.to_area_coordinates(e,true);if((area&&area.selected&&coords.x<40)||(area&&this.selection_disabled&&coords.x<40)){this.widget.show_person_overlay(area);}}
return;}
var right_canvas=t.findParent('div.right_pane',this.container.dom);if(right_canvas){var area=this.widget.find_booking_area(e);this.on_canvas_click(e,area);return;}},handle_shift_click_on_people:function(e,area){if(this.selection_disabled)return;var t=area.t<this.last_selected_area.t?area.t:this.last_selected_area.t;var b=area.b>this.last_selected_area.b?area.b:this.last_selected_area.b;for(var i=0;i<this.widget.people_areas.length;i++){var people_area=this.widget.people_areas[i];var m=Math.floor((people_area.t+people_area.b)/2);if(m>t&&m<b){this.select_area(people_area,true);}}
this.widget.re_render_widget(true);},on_canvas_click:function(e,area){if(this.selection_disabled)return;var option_click=this.is_option_click(e);if(!option_click)this.clear_selection();if(area&&!area.selected)
this.select_area(area);else if(option_click&&area&&area.selected)
this.un_select_area(area);this.widget.re_render_widget(true);},select_area:function(area,dont_record_last_selected_area){if(!dont_record_last_selected_area)
this.last_selected_area=area;if(area.type=='booking'){this.select_booking(area);}else{this.select_user(area);}},select_booking:function(area,dont_select_booking_user){area.selected=true;this.selected_booking_ids.push(area.record.id);if(!dont_select_booking_user){var user=area.record.get('user');var user_area=this.get_user_area(user.id);this.select_user(user_area,true);}},select_user:function(area,dont_select_users_bookings){area.selected=true;if(this.selected_people_ids.indexOf(area.record.id)==-1)
this.selected_people_ids.push(area.record.id);if(!dont_select_users_bookings){var areas=this.get_booking_areas_for_person(area.record.id);for(var i=0;i<areas.length;i++)
this.select_booking(areas[i],true);}},get_user_area:function(user_id){for(var i=0;i<this.widget.people_areas.length;i++){var area=this.widget.people_areas[i];if(area.record.id==user_id)
return area;}},un_select_area:function(area){if(area.type=='booking'){this.un_select_booking(area);}else{this.un_select_user(area);}},un_select_booking:function(area,dont_un_select_booking_user){area.selected=false;var index=this.selected_booking_ids.indexOf(area.record.id);this.selected_booking_ids.splice(index,1);if(!dont_un_select_booking_user){var user=area.record.get('user');var still_selected=this.get_booking_areas_for_person(user.id,true);if(still_selected.length==0){var user_area=this.get_user_area(user.id);this.un_select_user(user_area,true);}}},un_select_user:function(area,dont_un_select_users_bookings){area.selected=false;var index=this.selected_people_ids.indexOf(area.record.id);this.selected_people_ids.splice(index,1);if(!dont_un_select_users_bookings){var areas=this.get_booking_areas_for_person(area.record.id);for(var i=0;i<areas.length;i++)
this.un_select_booking(areas[i],true);}},get_booking_areas_for_person:function(person_id,just_selected_ones){var areas=[];for(var i=0;i<this.widget.booking_areas.length;i++){var area=this.widget.booking_areas[i];if(just_selected_ones&&!area.selected)continue;var user=area.record.get('user');if(user.id==person_id)
areas.push(area);}
return areas;},is_option_click:function(e){var dom_event=e.browserEvent;var ctrl_click=dom_event.metaKey;if(!Ext.isMac)
ctrl_click=dom_event.ctrlKey;return(ctrl_click||dom_event.shiftKey);},});SG.ResourcePlanningAppPeopleDragSelection=function(config){Ext.apply(this,config);var empty=Ext.get('sg_grid_row_drag_nothing');if(!empty)
Ext.DomHelper.append(document.body,{tag:"div",id:"sg_grid_row_drag_nothing"},true);var config={resizeFrame:false,scroll:false};SG.ResourcePlanningAppPeopleDragSelection.superclass.constructor.call(this,this.container,"rows",config);};Ext.extend(SG.ResourcePlanningAppPeopleDragSelection,Ext.dd.DDProxy,{handleMouseDown:function(e){var area=this.widget.find_people_area(e);if(!area||area.selected)return;this.dragging=false;this.last_area=area;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},select_user_area:function(e,area){if(!area||area==this.last_area)return;this.selection_manager.last_selected_area=this.last_area;this.selection_manager.handle_shift_click_on_people(e,area);this.widget.render_widget();this.last_area=area;},startDrag:function(x,y){this.dragging=true;},onDrag:function(e){var area=this.widget.find_people_area(e);this.select_user_area(e,area);},endDrag:function(e){if(!this.dragging){return;}
var area=this.widget.find_people_area(e);this.select_user_area(e,area);this.set_end_dragging_flag();},set_end_dragging_flag:function(){var me=this;setTimeout(function(){me.dragging=false;},5);},});SG.ResourcePlanningAppDragHandler=function(config)
{Ext.apply(this,config);var empty=Ext.get('sg_grid_row_drag_nothing');if(!empty)
Ext.DomHelper.append(document.body,{tag:"div",id:"sg_grid_row_drag_nothing"},true);var config={resizeFrame:false,scroll:false};SG.ResourcePlanningAppDragHandler.superclass.constructor.call(this,this.container,"rows",config);this.setDragElId("sg_grid_row_drag_nothing");this.container.on('mousemove',this.on_mousemove,this);this.drag_marker=this.container.child('div.drag_marker');this.last_hover_area=null;this.dragging=false;};Ext.extend(SG.ResourcePlanningAppDragHandler,Ext.dd.DDProxy,{is_scroll_click:function(e){if(this.scroll_container.dom.scrollHeight>this.scroll_container.dom.clientHeight)
{var r=this.scroll_container.getRight();if(e.xy[0]+20>r)
return true;}
if(this.scroll_container.dom.scrollWidth>this.scroll_container.dom.clientWidth)
{var b=this.scroll_container.getBottom();if(e.xy[1]+20>b)
return true;}
return false;},on_mousemove:function(e){var t=Ext.get(e.getTarget());var overlay=t.findParent('div.sgc_booking_overlay',this.container.dom);if(overlay)return;if(this.dragging||this.widget.is_booking_overlay_visible()){this.last_hover_area=null;return;}
var area=this.find_hover_area(e);if(area&&area!=this.last_hover_area){if(this.last_hover_area!=null)
this.hide_booking_drag_handles(this.last_hover_area)
this.show_booking_drag_handles(area);this.last_hover_area=area;}else if(!area&&this.last_hover_area){this.hide_booking_drag_handles(this.last_hover_area);this.last_hover_area=null;}},find_hover_area:function(e){var areas=this.widget.find_booking_area(e,true);if(!areas)return null;if(areas.length==1)return areas[0];if(!this.last_hover_area){return this.oldest_area(areas);}else{for(var i=0;i<areas.length;i++){if(areas[i]==this.last_hover_area)
return this.last_hover_area;}
return this.oldest_area(areas);}},oldest_area:function(areas){var id=-1;var pick;for(var i=0;i<areas.length;i++){var area=areas[i];if(area.id>id){pick=area;id=area.id;}}
return pick;},hide_booking_drag_handles:function(area){var ctx=this.widget.right_drag_ctx;ctx.save();ctx.translate(-this.widget.right_view_port.l,-this.widget.right_view_port.t);this.widget.set_header_clip_for_canvas(ctx,33);var w=area.r-area.l;var h=area.b-area.t;ctx.clearRect(area.l-10,area.t,w+20,h+1);ctx.restore();},show_booking_drag_handles:function(area){var ctx=this.widget.right_drag_ctx;ctx.save();ctx.translate(-this.widget.right_view_port.l,-this.widget.right_view_port.t);this.widget.set_header_clip_for_canvas(ctx,33);ctx.strokeStyle="black";var w=area.r-area.l;var h=area.b-area.t;var lines=[-8.5,-6.5,-4.5,w+4.5,w+6.5,w+8.5];ctx.beginPath();for(var i=0;i<lines.length;i++){ctx.moveTo(area.l+lines[i],area.t+0.5);ctx.lineTo(area.l+lines[i],area.t+h+0.5);}
ctx.closePath();ctx.stroke();ctx.restore();},handleMouseDown:function(e){if(this.is_scroll_click(e))return;var area=this.find_hover_area(e);this.mode=this.get_drag_type(area,e);this.drag_area=area;this.days_offset=0;this.user_offset=0;var coords=this.widget.to_area_coordinates(e);this.start_x=coords.x;this.start_y=coords.y;Ext.dd.DDProxy.prototype.handleMouseDown.call(this,e);},get_drag_type:function(area,e){if(!area)
return'new';var coords=this.widget.to_area_coordinates(e);if(coords.x<area.l){return'left';}else if(coords.x>area.r){return'right';}else{var user_sel_count=this.selection_manager.get_person_selection_count();if(user_sel_count>1)
return'bar';else
return'free';}},startDrag:function(x,y){this.dragging=true;this.drag_marker.setVisible(true);this.widget.hide_booking_overlay();if(this.mode=='new'){this.selection_manager.clear_selection();this.create_new_booking_area();this.selected_areas=[this.drag_area];this.drag_area.dragging=true;}else{if(!this.drag_area.selected){this.selection_manager.clear_selection();this.selection_manager.select_area(this.drag_area);this.widget.render_widget();}
this.init_selected_bookings_for_drag();}},create_new_booking_area:function(){var record=new SG.Data.Record('Booking');this.widget.prime_record_with_cookie_project(record);var ee=this.widget.from_area_coordinates(40,this.start_y,true);var user_area=this.widget.find_people_area(ee);record.set('user',{type:user_area.record.type,id:user_area.record.id,name:user_area.record.get('name')});var days=Math.floor(this.start_x/this.widget.day_length);var users=Math.floor((this.start_y-this.widget.header_height)/40);this.drag_area={l:days*this.widget.day_length,r:(days+1)*this.widget.day_length,t:(users*40)+this.widget.header_height,b:((users+1)*40)+this.widget.header_height-10,record:record,render_fn:this.render_new_booking,drag_created_pending:true,};},render_new_booking:function(area){var ctx=this.widget.right_drag_ctx;ctx.save();ctx.translate(-this.widget.right_view_port.l,-this.widget.right_view_port.t);this.widget.set_header_clip_for_canvas(ctx,33);ctx.fillStyle="rgb(196,226,249)";ctx.fillRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);ctx.strokeStyle="rgb(0,0,0)";ctx.strokeRect(area.l+0.5,area.t+0.5,area.r-area.l,area.b-area.t);var label='Vacation';var project=area.record.get('project');if(!area.record.get('vacation')&&project&&project.name){label=project.name;}
var w=area.r-area.l;ctx.font='12px "Helvetica Neue", Helvetica, Verdana, Arial, sans-serif';ctx.fillStyle="black";var mt=ctx.measureText(label);if(mt.width<w){var pad=Math.floor((w-mt.width)/2);ctx.fillText(label,area.l+pad,((area.t+area.b)/2)+2);}
ctx.restore();},clear_new_booking:function(area){var ctx=this.widget.right_drag_ctx;var w=area.r-area.l;var h=area.b-area.t;ctx.clearRect(area.l-1,area.t-1,w+2,h+2);},init_selected_bookings_for_drag:function(){this.selected_areas=[];var areas=this.widget.booking_areas;for(var i=0;i<areas.length;i++){var area=areas[i];if(area.selected){area.dragging=true;this.selected_areas.push(area);}}},onDrag:function(e){var fn_name='onDrag_'+this.mode;this[fn_name].call(this,e);},onDrag_right:function(e){this.onDrag_left(e);},onDrag_left:function(e){var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset){var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.resize_selected_graphics(diff,this.mode=='left');this.update_drag_marker(this.drag_area,e);this.widget.render_widget();}},onDrag_new:function(e){var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset){var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.clear_new_booking(this.drag_area);this.resize_selected_graphics(diff,this.days_offset<0);this.update_drag_marker(this.drag_area,e);this.drag_area.render_fn.call(this,this.drag_area);}},resize_selected_graphics:function(offset,is_left){for(var i=0;i<this.selected_areas.length;i++){var area=this.selected_areas[i];if(is_left)
area.l+=this.widget.day_length*offset;else
area.r+=this.widget.day_length*offset;}},onDrag_bar:function(e){var days_offset=this.calc_days_offset(e);if(days_offset!=this.days_offset){var diff=days_offset-this.days_offset;this.days_offset=days_offset;this.move_selected_graphics(diff);this.update_drag_marker(this.drag_area,e);this.widget.render_widget();}},onDrag_free:function(e){var days_offset=this.calc_days_offset(e);var user_offset=this.calc_user_offset(e);if(days_offset!=this.days_offset||user_offset!=this.user_offset){var days_diff=days_offset-this.days_offset;var user_diff=user_offset-this.user_offset;var block_y_movement=false;if(user_diff<0){if(this.drag_area.t-this.widget.right_view_port.t-73<0)
block_y_movement=true;}else{if(this.drag_area.t+80>(40*this.widget.people_ds.count())+33)
block_y_movement=true;}
if(block_y_movement){user_offset=this.user_offset;user_diff=0;}
this.days_offset=days_offset;this.user_offset=user_offset;this.move_selected_graphics(days_diff,user_diff);this.update_drag_marker(this.drag_area,e);this.widget.render_widget();}},move_selected_graphics:function(offset_x,offset_y){for(var i=0;i<this.selected_areas.length;i++){var area=this.selected_areas[i];area.l+=this.widget.day_length*offset_x;area.r+=this.widget.day_length*offset_x;if(offset_y!=undefined){area.t+=40*offset_y;area.b+=40*offset_y;}}},calc_days_offset:function(e){var coords=this.widget.to_area_coordinates(e);var diff_x=coords.x-this.start_x;var days_offset;if(diff_x<0)
days_offset=Math.ceil(diff_x/this.widget.day_length);else
days_offset=Math.floor(diff_x/this.widget.day_length);return days_offset;},calc_user_offset:function(e){var coords=this.widget.to_area_coordinates(e);var diff_y=coords.y-this.start_y;var user_offset;if(diff_y<0)
user_offset=Math.ceil(diff_y/40);else
user_offset=Math.floor(diff_y/40);return user_offset;},endDrag:function(e){this.drag_marker.setVisible(false);var fn_name='endDrag_'+this.mode;this[fn_name].call(this,e);this.set_end_dragging_flag();for(var i=0;i<this.selected_areas.length;i++)
this.selected_areas[i].dragging=false;if(this.mode!="new")
this.widget.render_widget();},endDrag_right:function(e){this.endDrag_left(e);},endDrag_left:function(e){if(this.days_offset==0)return;this.widget.bookings_ds.start_batch();for(var i=0;i<this.selected_areas.length;i++){var area=this.selected_areas[i];var s_date=new SG.Date(area.record.get('start_date'));var e_date=new SG.Date(area.record.get('end_date'));s_date=s_date.add(Date.DAY,this.days_offset);e_date=e_date.add(Date.DAY,this.days_offset);if(this.mode=='left')
area.record.set('start_date',s_date.data_store_format());else
area.record.set('end_date',e_date.data_store_format());}
this.widget.bookings_ds.end_batch();this.widget.bookings_ds.commit(true);},endDrag_bar:function(e){if(this.days_offset==0)return;this.widget.bookings_ds.start_batch();for(var i=0;i<this.selected_areas.length;i++){var area=this.selected_areas[i];var s_date=new SG.Date(area.record.get('start_date'));var e_date=new SG.Date(area.record.get('end_date'));s_date=s_date.add(Date.DAY,this.days_offset);e_date=e_date.add(Date.DAY,this.days_offset);area.record.set('start_date',s_date.data_store_format());area.record.set('end_date',e_date.data_store_format());}
this.widget.bookings_ds.end_batch();this.widget.bookings_ds.commit(true);},endDrag_free:function(e){if(this.days_offset==0&&this.user_offset==0)return;if(this.user_offset==0){this.endDrag_bar(e);return;}
this.widget.bookings_ds.start_batch();for(var i=0;i<this.selected_areas.length;i++){var area=this.selected_areas[i];var s_date=new SG.Date(area.record.get('start_date'));var e_date=new SG.Date(area.record.get('end_date'));s_date=s_date.add(Date.DAY,this.days_offset);e_date=e_date.add(Date.DAY,this.days_offset);area.record.set('start_date',s_date.data_store_format());area.record.set('end_date',e_date.data_store_format());var m=Math.floor((area.t+area.b)/2);var ee=this.widget.from_area_coordinates(40,m,true);var user_area=this.widget.find_people_area(ee);var user={id:user_area.record.id,type:user_area.record.type};area.record.set('user',user);}
this.widget.bookings_ds.end_batch();this.widget.bookings_ds.commit(true);this.selection_manager.recalculate_user_selection();this.widget.render_widget();},set_end_dragging_flag:function(){var me=this;setTimeout(function(){me.dragging=false;},5);},endDrag_new:function(){var start_date=this.widget.get_date_at_pixel(this.drag_area.l);var end_date=this.widget.get_date_at_pixel(this.drag_area.r-this.widget.day_length);this.drag_area.record.set('start_date',start_date.data_store_format());this.drag_area.record.set('end_date',end_date.data_store_format());this.drag_area.render_fn=this.widget.render_pending_booking_fn;this.widget.booking_areas.push(this.drag_area);var cfg={mode:'new',source_record:this.drag_area.record,booking_area:this.drag_area,booking_created_callback:{fn:this.on_new_booking_created,scope:this},overlay_canceled_callback:{fn:this.on_new_booking_canceled,scope:this}};this.widget.show_booking_overlay(cfg);},on_new_booking_created:function(record){this.widget.fetch_bookings();var drag_area=this.widget.booking_areas.pop();this.widget.generate_booking_area(record,drag_area.t);this.widget.render_widget();},on_new_booking_canceled:function(){this.widget.booking_areas.pop();this.widget.render();},update_drag_marker:function(area,e){var text='';var mouse=this.widget.to_area_coordinates(e);var x=mouse.x-this.widget.right_view_port.l;var y;if(this.mode=='left'){var d=this.widget.get_date_at_pixel(area.l);text=d.format('D, M j');}else if(this.mode=='right'){var d=this.widget.get_date_at_pixel(area.r-this.widget.day_length);text=d.format('D, M j');}else{var dl=this.widget.get_date_at_pixel(area.l);var dr=this.widget.get_date_at_pixel(area.r-this.widget.day_length);var lM=dl.format('M');var rM=dr.format('M');var ly=dl.format('y');var ry=dr.format('y');if((lM==rM)&&(ly==ry))
text=dl.format('M j - ')+dr.format('j');else if(ly==ry)
text=dl.format('M j - ')+dr.format('M j');else
text=dl.format('M j/y - ')+dr.format('M j/y');}
var w=(text.length*6)+16;x-=Math.floor(w/2);y=area.t-this.widget.right_view_port.t;this.drag_marker.setTop(y+(area.b-area.t)+4);this.drag_marker.setLeft(x);this.drag_marker.update('<span class="text">'+text+'</span>');},});SG.BookingOverlay=function(cfg){Ext.apply(this,cfg);SG.BookingOverlay.superclass.constructor.call(this);};Ext.extend(SG.BookingOverlay,SG.Component,{templates:{main:'<div class="sgc_booking_overlay not_sel_target"><div class="header {vacation}">'+'<span class="assign_project">Assign Project</span><span class="divider">|</span>'+'<span class="vacation">Vacation</span></div>'+'<div class="fields">{fields}</div>'+'<div class="footer">{footer}</div>'+'<div class="callout"></div></div>',callout_top:'<div class="callout_top callout_triangle"></div>',callout_bottom:'<div class="callout_bottom callout_triangle_bottom"></div>',callout_left:'<div class="callout_left callout_triangle_left"></div>',field:'<div class="field"><table class="field_table"><tr><td class="field_name">{field_display_name}</td>'+'<td class="field_value"><div class="{cell_classes}" {cell_attributes}>{cell_content}</div></td></tr>'+'</table></div>',fields:'{project}<div class="field"><table class="date_table"><tr><td class="dates_label">Dates:</td>'+'<td class="date_value">{start_date}</td><td class="to_label">to</td>'+'<td class="date_value">{end_date}</td></tr></table></div>{note}{user}',date_field:'<div class="{cell_classes}" {cell_attributes}>{cell_content}</div>',footer:'<span class="cancel">Cancel</span><input type="button" class="submit_button" value="{button_label}">',},overlay_width:300,overlay_height:240,init_component:function(){if(this.mode=='new'){this.data_set=this.new_data_set('Booking',null,this.on_data_change);this.setup_new_record();}else if(this.mode=='new_multi'){this.setup_new_multi_data();this.source_record=this.record;}else{this.save_record_values();this.record=this.source_record;}
var html=this.templates.main.apply({vacation:this.source_record&&this.source_record.get('vacation')?'vacation':'assign_project',fields:'',footer:this.render_footer()});this.container=Ext.DomHelper.append(this.render_container,html,true);this.footer_div=this.container.child('div.footer');this.header_div=this.container.child('div.header');this.add_event(this.footer_div,'click',this.on_footer_click);this.add_event(this.header_div,'click',this.on_header_click);var cell_config={container:this.container,edit_container:this.widget.container,data_set:this.data_set,projects:this.widget.context_projects(),get_fields_callback:{fn:this.get_fields,scope:this},in_form:true};this.cell_manager=this.new_component(SG.CellManager,cell_config);var fields_div=this.container.child('div.fields');fields_div.update(this.render_fields());var callout_position=this.position_overlay();var callout=this.container.child('div.callout');if(this.no_callout){}else if(callout_position=='top'){Ext.DomHelper.insertAfter(callout,this.templates.callout_top.apply());}else if(callout_position=='bottom'){Ext.DomHelper.insertAfter(callout,this.templates.callout_bottom.apply());}else{Ext.DomHelper.insertAfter(callout,this.templates.callout_left.apply());}
callout.remove();if(this.mode=='new'){this.focus_assign_project();var doc=Ext.get(document);this.add_event(doc,"keydown",this.on_keypress);this.add_event(doc,"keypress",this.on_keypress);}},on_keypress:function(e){if(this.not_first_keypress)
return;if(e.target.nodeName=='TEXTAREA'||(e.target.nodeName=='INPUT'&&e.target.getAttribute('type')!='button')){this.not_first_keypress=true;return;}
this.not_first_keypress=true;var key_id=e.getKey();if(key_id==Ext.EventObject.TAB){var sel='.sg_cell[record_id="'+this.record.get_id()+'"][field="project"]';var cell_elem=sg_find(sel,this.container.dom);var cell=this.cell_manager.get_cell('project');cell.edit_cell({cell_elem:Ext.get(cell_elem),record:this.record});e.stopEvent();}},focus_assign_project:function(){var input=this.container.child('input.submit_button');input.focus();},setup_new_multi_data:function(){this.data_set=this.new_data_set('Booking',null,this.on_data_change);this.record=this.data_set.new_record();var today=new SG.Date();this.widget.prime_record_with_cookie_project(this.record);this.record.set('start_date',today.data_store_format());this.record.set('end_date',today.data_store_format());},on_header_click:function(e){var is_vacation=this.record.get('vacation');var t=Ext.get(e.getTarget());var vacation=t.findParent('span.vacation',this.container.dom);if(vacation&&!is_vacation){this.record.set('vacation',true);this.header_div.replaceClass('assign_project','vacation');this.re_render_fields();return;}
var assign_project=t.findParent('span.assign_project',this.container.dom);if(assign_project&&is_vacation){this.record.set('vacation',false);this.header_div.replaceClass('vacation','assign_project');this.re_render_fields();return;}},on_footer_click:function(e){var t=Ext.get(e.getTarget());var cancel=t.findParent('span.cancel',this.container.dom);if(cancel){if(this.mode=='edit')
this.revert_record_values();this.hide_overlay();return;}
var submit=t.findParent('input.submit_button',this.container.dom);if(submit){var message=this.check_mandatory_fields();if(message){alert(message);return;}
if(this.mode=='edit'){if(this.record.get_state()!='clean'){this.widget.set_project_cookie(this.record);this.fire_booking_changed_callback();this.record.commit();}
this.hide_overlay(true);return;}else if(this.mode=='new'){this.widget.set_project_cookie(this.record);this.record.commit();}else if(this.mode=='new_multi'){var ds=this.new_data_set('Booking',null,this.on_data_change);var fields=sg_deep_copy(this.get_fields());fields.push('vacation');SG.Repo.start_batch();for(var i=0;i<this.user_ids.length;i++){var r=ds.new_record();for(var j=0;j<fields.length;j++){var field=fields[j];if(field=='user')continue;r.set(field,this.record.get(field));}
r.set('user',{type:'HumanUser',id:this.user_ids[i],valid:'valid'});r.commit();if(i==0)
this.widget.set_project_cookie(r);}
SG.Repo.end_batch();}}},check_mandatory_fields:function(){var vacation=this.record.get('vacation');var project=this.record.get('project');if(!project&&!vacation)
return"A Booking that is not a vacation must have a project";var start_date=this.record.get('start_date');if(!start_date)
return"A Booking must have a start date.";var end_date=this.record.get('end_date');if(!end_date)
return"A Booking must have a end date.";var user=this.record.get('user');if(!user&&this.mode!='new_multi')
return"A Booking must be Assigned to someone";var sdate=new SG.Date(start_date);var edate=new SG.Date(end_date);if(sdate.getTime()>edate.getTime())
return"The start date of a booking can not happen after the end date.";return null;},re_render_fields:function(){var fields_div=this.container.child('div.fields');fields_div.update(this.render_fields());},render_fields:function(){var html='';var fields=this.get_fields();var fields_config={};for(var i=0;i<fields.length;i++){var field=fields[i];var schema_field=SG.schema.get_field('Booking',field);var cell=this.cell_manager.get_cell(field);var cfg=cell.render(this.record);if(this.mode=='new_multi'&&field=='user'){var user_label=this.user_ids.length>1?'users':'user';fields_config[field]=this.templates.field.apply({field_display_name:schema_field.display_name+':',cell_content:this.user_ids.length+' selected '+user_label});}else if(field=='project'&&this.record.get('vacation')){fields_config[field]=this.templates.field.apply({field_display_name:'&nbsp'});}else if(['start_date','end_date'].indexOf(field)==-1){cfg.field_display_name=schema_field.display_name+':';fields_config[field]=this.templates.field.apply(cfg);}else{fields_config[field]=this.templates.date_field.apply(cfg);}}
return this.templates.fields.apply(fields_config);},get_fields:function(){return['project','start_date','end_date','note','user'];},render_footer:function(){var button_label=this.mode=='edit'?'Update Booking':'Assign Project';return this.templates.footer.apply({button_label:button_label});},position_overlay:function(){var callout_position='top';var rch=this.render_container.getHeight();var rcw=this.render_container.getWidth();var overlay_height=this.container.getHeight();if(this.mode=='new_multi'){this.container.setLeft(this.widget.left_canvas_width+20);var t=this.booking_area.t+10-this.widget.right_view_port.t-120;if(t+overlay_height>rch){t=rch-overlay_height-20;}else if(t<0){t=0;}
this.container.setTop(t);callout_position='left';}else if(this.no_callout){var l=Math.floor((rcw-this.overlay_width)*0.5);this.container.setLeft(l);}else{if(this.booking_area){var l=((this.booking_area.l+this.booking_area.r)*.5)-this.overlay_width/2-
this.widget.right_view_port.l+this.widget.left_canvas_width;if(l<105)l=105;if(l+320>rcw)l=rcw-320;var t=this.booking_area.b+10-this.widget.right_view_port.t;if(t+204>rch){t=this.booking_area.t-10-this.widget.right_view_port.t-204
var callout_position='bottom';}
this.container.setTop(t);this.container.setLeft(l);}else{var l=Math.floor((rcw-this.overlay_width)*0.5);this.container.setLeft(l);}}
return callout_position;},destroy_component:function(){this.container.remove();},setup_new_record:function(){this.record=this.data_set.new_record();var fields=sg_deep_copy(this.get_fields());fields.push('vacation');for(var i=0;i<fields.length;i++){var field=fields[i];this.record.set(field,this.source_record.get(field));}
this.widget.prime_record_with_cookie_project(this.record);},on_data_change:function(changes){var created=false;var record=null;for(var i=0;i<changes.length;i++){var change=changes[i];if(change.state=='pending')continue;if(change.type=='create'){created=true;record=change.record;break;}}
if(created){this.fire_booking_changed_callback(record);this.hide_overlay(true);}},save_record_values:function(){var fields=sg_deep_copy(this.get_fields());fields.push('vacation');this.original_record_values={};for(var i=0;i<fields.length;i++){var field=fields[i];this.original_record_values[field]=sg_deep_copy(this.source_record.get(field));}},revert_record_values:function(){for(var field in this.original_record_values){if(!this.original_record_values.hasOwnProperty(field))continue;var value=this.original_record_values[field];this.record.set(field,value);}},hide_overlay:function(fire_cancel_callback){var no_cancel_callback=fire_cancel_callback
var me=this;setTimeout(function(){me.widget.hide_booking_overlay(no_cancel_callback);},0);},fire_overlay_canceled_callback:function(){if(this.overlay_canceled_callback){this.overlay_canceled_callback.fn.call(this.overlay_canceled_callback.scope);}},fire_booking_changed_callback:function(record){if(this.booking_created_callback){this.booking_created_callback.fn.call(this.booking_created_callback.scope,record);}},});SG.PersonOverlay=function(cfg){Ext.apply(this,cfg);SG.PersonOverlay.superclass.constructor.call(this);};Ext.extend(SG.PersonOverlay,SG.Component,{templates:{main:'<div class="sgc_person_overlay not_sel_target">'+'<div class="body"><table><tr><td class="user_thumb">{thumbnail}</td>'+'<td class="fields"><div class="user_name">{user_name}</div><div class="fields">{fields}</div></td>'+'</tr></table></div>'+'<div class="close_x"></div>'+'<div class="callout_left"></div></div>',field:'<div class="field"><div class="{cell_classes}" {cell_attributes}>{cell_content}</div></div>',field_with_label:'<table class="center_field"><tr><td class="field_label">'+'<div class="field_label" sg_tip="{field_label}" clip_tip="this_node" >{field_label}'+'</div></td><td class="field_value"><div style="{cell_styles}" class="{cell_classes}" '+'{cell_attributes}>{cell_content}</div></td></tr></table>',more_fields:'<div class="more_fields"><span class="more_fields">More fields...</span></div>',loading:'<img src="'+SG.globals.icons.IndicatorLargeTransparent+'"/>',user_thumb:'<div class="user_thumb"><img src="{src}" onerror="sg_missing_user_thumb(this)"/></div>',},init_component:function(){var html=this.templates.main.apply({thumbnail:'',user_name:this.render_user_name(),fields:'',note_field:'',});this.container=Ext.DomHelper.append(this.render_container,html,true);this.add_event(this.container,'click',this.on_click);this.data_set=this.new_data_set('HumanUser',this.on_load_fields);var cell_config={container:this.container,edit_container:this.container,data_set:this.data_set,projects:this.widget.context_projects(),get_fields_callback:{fn:this.get_fields,scope:this},field_property_callback:{fn:this.get_person_field_propery,scope:this}};this.cell_manager=this.new_component(SG.CellManager,cell_config);var user_thumb_td=this.container.child('td.user_thumb');user_thumb_td.update(this.render_user_thumb());this.position_overlay();this.fetch_fields();},render_user_name:function(){var user_entity={type:this.record.type,name:this.record.get('name'),valid:'valid',id:this.record.id};return SG.Renderers.render_one_detail_link(user_entity)},on_load_fields:function(){this.field_record=this.data_set.get_record(0);var fields_div=this.container.child('div.fields');fields_div.update(this.render_fields());this.size_field_name_divs();this.position_overlay();},get_person_field_propery:function(schema_field){return{show_label:false};},render_user_thumb:function(){var image=this.record.get('image');var src='';if(image==null){src='/images/default_user_thumb.png';}else{src='/thumbnail/image/'+image;}
return this.templates.user_thumb.apply({src:src});},render_fields:function(){var html='';var fields=this.get_fields();var fields_config={};for(var i=0;i<fields.length;i++){var field=fields[i];var schema_field=SG.schema.get_field('HumanUser',field);if(!schema_field)continue;var cell=this.cell_manager.get_cell(field);if(!cell)continue;var cfg=cell.render(this.field_record);cfg.field_label=SG.schema.get_field_display_name('HumanUser',field);html+=this.templates.field_with_label.apply(cfg);}
html+=this.templates.more_fields.apply();return html;},get_fields:function(){var cookie_fields=this.get_fields_from_cookie();if(cookie_fields)
return cookie_fields;else
return['department','tag_list'];},get_fields_from_cookie:function(){var cookie=getCookie(this.cookie_name());if(cookie){var cookie_settings=Ext.decode(cookie);var ret=[];for(var i=0;i<cookie_settings.length;i++)
{var field=cookie_settings[i];var schema_field=SG.schema.get_field('HumanUser',field);if(schema_field)
ret.push(field);}
return ret;}
else
return null;},set_cookie_fields:function(fields){setCookie(this.cookie_name(),Ext.encode(fields),365);},cookie_name:function(){return'sg_rp_more_fields_'+SG.globals.current_user.id;},position_overlay:function(){this.container.setLeft(250);var t=this.person_area.t-this.widget.left_view_port.t-40;var rch=this.render_container.getHeight();var container_height=this.container.dom.clientHeight;if(t+container_height>rch){t=rch-container_height-20;}
this.container.setTop(t);},destroy_component:function(){this.container.remove();},size_field_name_divs:function(){var divs=sg_find_all('div.field_label',this.container.dom);var largest=0;for(var i=0;i<divs.length;i++){var div=Ext.get(divs[i]);if(div.dom.scrollWidth>div.dom.clientWidth){if(largest<div.dom.scrollWidth)
largest=div.dom.scrollWidth}}
if(largest==0)return;largest=largest+10;if(largest>120)largest=120;var tds=sg_find_all('td.field_label',this.container.dom);for(var i=0;i<tds.length;i++){var td=Ext.get(tds[i]);td.setWidth(largest);}},show_more_fields_menu:function(anchor_elem){if(!this.more_fields_menu){this.more_fields_menu=this.new_component(SG.Menu,{before_show:{fn:this.on_before_show_fields_menu,scope:this},});this.fields_menu_helper=new SG.util.FieldsMenuHelper({entity_type:'HumanUser',field_disabled_callback:{fn:function(field_schema,field_name){return field_name=='image';},scope:this},field_checked_callback:{fn:function(field_schema,field_name){var cols=this.get_fields();return cols.indexOf(field_name)>-1;},scope:this},on_field:{fn:this.toggle_field,scope:this}});}
this.more_fields_menu.position={dom_elem:anchor_elem,elem_anchor:'bl',menu_anchor:'tl'};this.more_fields_menu.show();},on_before_show_fields_menu:function(menu){menu.items=this.fields_menu_helper.get_menu_items();menu.render();},toggle_field:function(menu,item){var fields=sg_deep_copy(this.get_fields());if(item.checked){var idx=fields.indexOf(item.field);fields.splice(idx,1);}else{fields.push(item.field);}
this.set_cookie_fields(fields);this.fetch_fields();},on_click:function(e){var t=Ext.get(e.getTarget());var more_fields=t.findParent('span.more_fields',this.container.dom,true);if(more_fields){this.show_more_fields_menu(more_fields);return;}},fetch_fields:function(){var fields_div=this.container.child('div.fields');fields_div.update(this.templates.loading.apply());var spec={type:'HumanUser',id:this.record.id,columns:this.get_fields(),result:this.data_set};SG.Repo.find(spec);},});